# å›žæ¸¬ä¿®æ­£åˆ†æžå ±å‘Š

## ðŸ“‹ ä¿®æ­£é …ç›®

### 1. **Look-ahead Biasï¼ˆæå‰ä½¿ç”¨ç•¶å¤©æ•¸æ“šï¼‰**

**å•é¡Œ**ï¼š
- åŽŸæœ¬çš„å›žæ¸¬åœ¨ rebalance æ—¥æœŸï¼ˆå¦‚ 2020-01-02ï¼‰å°±æŒæœ‰è‚¡ç¥¨
- ä½†å¯¦éš›ä¸Šæ‡‰è©²åœ¨ç•¶å¤©æ”¶ç›¤å¾Œè¨ˆç®—ï¼Œæ¬¡æ—¥æ‰èƒ½è²·å…¥
- é€™å°Žè‡´ç­–ç•¥æå‰äº«å—äº†ç•¶å¤©çš„å ±é…¬

**ä¿®æ­£æ–¹æ³•**ï¼š
- è¨Šè™Ÿå»¶å¾Œä¸€å¤©ç”Ÿæ•ˆï¼ˆ`signals.shift(1)`ï¼‰
- åœ¨ t æ—¥è¨ˆç®—çš„è¨Šè™Ÿï¼Œåœ¨ t+1 æ—¥æ‰è²·å…¥

---

### 2. **äº¤æ˜“æˆæœ¬æœªæ‰£é™¤**

**å•é¡Œ**ï¼š
- åŽŸæœ¬çš„å›žæ¸¬åªè¨ˆç®—åƒ¹æ ¼è®Šå‹•ï¼Œæ²’æœ‰æ‰£é™¤ä»»ä½•æ‰‹çºŒè²»æˆ–ç¨…é‡‘
- å°è‚¡äº¤æ˜“æˆæœ¬åŒ…æ‹¬ï¼šè²·å…¥æ‰‹çºŒè²»ã€è³£å‡ºæ‰‹çºŒè²»ã€è­‰äº¤ç¨…

**å°è‚¡äº¤æ˜“æˆæœ¬è¨­å®š**ï¼š
| é …ç›® | è²»çŽ‡ | èªªæ˜Ž |
|------|------|------|
| è²·å…¥æ‰‹çºŒè²» | 0.1425% | åˆ¸å•†æŠ˜æ‰£å¾Œ 0.0428%ï¼ˆ70% offï¼‰ |
| è³£å‡ºæ‰‹çºŒè²» | 0.1425% | åˆ¸å•†æŠ˜æ‰£å¾Œ 0.0428%ï¼ˆ70% offï¼‰ |
| è­‰äº¤ç¨… | 0.3% | è³£å‡ºæ™‚å›ºå®š |
| **å–®æ¬¡è²·è³£ç¸½æˆæœ¬** | **â‰ˆ 0.39%** | è²·å…¥ 0.0428% + è³£å‡º 0.3428% |

**ä¿®æ­£æ–¹æ³•**ï¼š
- è¨ˆç®—æ¯æ—¥æŒå€‰è®ŠåŒ–
- æ‰£é™¤è²·å…¥æˆæœ¬ï¼ˆæ‰‹çºŒè²» Ã— æŠ˜æ‰£ï¼‰
- æ‰£é™¤è³£å‡ºæˆæœ¬ï¼ˆæ‰‹çºŒè²» Ã— æŠ˜æ‰£ + è­‰äº¤ç¨…ï¼‰

---

## ðŸ“Š ä¿®æ­£å‰å¾Œç¸¾æ•ˆå°æ¯”

### ç­–ç•¥ 1ï¼šæ—ç¾¤ç›¸å°å¼·å¼±æ³•

| æŒ‡æ¨™ | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ | è®ŠåŒ– |
|------|--------|--------|------|
| **å¹´åŒ–å ±é…¬ï¼ˆCAGRï¼‰** | 25.29% | 22.02% | â–¼ -3.27% |
| **Sharpe Ratio** | 1.25 | 1.10 | â–¼ -0.15 |
| **æœ€å¤§å›žæ’¤** | -27.68% | -29.06% | â–¼ -1.38% |
| **å‹çŽ‡** | 54.44% | 54.15% | â–¼ -0.29% |
| **ç¸½äº¤æ˜“æ¬¡æ•¸** | 608 | 602 | â–¼ -6 |
| **ç´¯ç©å ±é…¬** | 283.62% | 220.48% | â–¼ -63.14% |

**å½±éŸ¿åˆ†æž**ï¼š
- âœ… **ä»ç„¶æ˜¯æœ€å„ªç­–ç•¥**ï¼Œå¹´åŒ–å ±é…¬ 22% ä¸” Sharpe > 1
- âš ï¸ Look-ahead Bias å½±éŸ¿ç´„ **1-2%**
- âš ï¸ äº¤æ˜“æˆæœ¬å½±éŸ¿ç´„ **1-2%**
- âœ… **ç­–ç•¥æœ‰æ•ˆæ€§å¾—åˆ°é©—è­‰**ï¼Œä¿®æ­£å¾Œä»è¡¨ç¾å„ªç•°

---

### ç­–ç•¥ 2ï¼šæ—ç¾¤åŒæ­¥æ€§æ³•

| æŒ‡æ¨™ | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ | è®ŠåŒ– |
|------|--------|--------|------|
| **å¹´åŒ–å ±é…¬ï¼ˆCAGRï¼‰** | -4.16% | -13.72% | â–¼ -9.56% |
| **Sharpe Ratio** | -0.12 | -0.69 | â–¼ -0.57 |
| **æœ€å¤§å›žæ’¤** | -37.15% | -64.88% | â–¼ -27.73% |
| **å‹çŽ‡** | 40.81% | 48.88% | â–² +8.07% |
| **ç¸½äº¤æ˜“æ¬¡æ•¸** | 591 | 588 | â–¼ -3 |
| **ç´¯ç©å ±é…¬** | -22.27% | -59.13% | â–¼ -36.86% |

**å½±éŸ¿åˆ†æž**ï¼š
- âŒ **ç­–ç•¥å¤±æ•ˆ**ï¼Œä¿®æ­£å¾Œè¡¨ç¾æ¥µå·®
- ðŸ”´ Look-ahead Bias + äº¤æ˜“æˆæœ¬å½±éŸ¿è¶…éŽ **-9%**
- ðŸ”´ æœ€å¤§å›žæ’¤æƒ¡åŒ–åˆ° **-64.88%**ï¼Œé¢¨éšªæ¥µé«˜
- âŒ **ä¸å»ºè­°å¯¦ç›¤ä½¿ç”¨**

---

### ç­–ç•¥ 3ï¼šç¶œåˆæ³•

| æŒ‡æ¨™ | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ | è®ŠåŒ– |
|------|--------|--------|------|
| **å¹´åŒ–å ±é…¬ï¼ˆCAGRï¼‰** | 0.87% | -3.93% | â–¼ -4.80% |
| **Sharpe Ratio** | 0.15 | -0.05 | â–¼ -0.20 |
| **æœ€å¤§å›žæ’¤** | -53.81% | -64.16% | â–¼ -10.35% |
| **å‹çŽ‡** | 30.58% | 48.32% | â–² +17.74% |
| **ç¸½äº¤æ˜“æ¬¡æ•¸** | 276 | 271 | â–¼ -5 |
| **ç´¯ç©å ±é…¬** | 5.35% | -22.26% | â–¼ -27.61% |

**å½±éŸ¿åˆ†æž**ï¼š
- âŒ **ç­–ç•¥å¤±æ•ˆ**ï¼Œä¿®æ­£å¾Œè½‰ç‚ºè² å ±é…¬
- ðŸ”´ Look-ahead Bias + äº¤æ˜“æˆæœ¬å½±éŸ¿ç´„ **-5%**
- ðŸ”´ æœ€å¤§å›žæ’¤æƒ¡åŒ–åˆ° **-64.16%**
- âŒ **éŽåº¦å„ªåŒ–å°Žè‡´å¯¦ç›¤å¤±æ•ˆ**

---

## ðŸ’¡ é—œéµç™¼ç¾

### 1. **Look-ahead Bias çš„å½±éŸ¿**

ä¸åŒç­–ç•¥å— Look-ahead Bias å½±éŸ¿ç¨‹åº¦ä¸åŒï¼š
- **ç­–ç•¥ 1**ï¼šå½±éŸ¿è¼ƒå°ï¼ˆ1-2%ï¼‰ï¼Œå› ç‚ºé¸è‚¡é‚è¼¯ç°¡å–®ç©©å®š
- **ç­–ç•¥ 2/3**ï¼šå½±éŸ¿å·¨å¤§ï¼ˆ5-10%ï¼‰ï¼Œå› ç‚ºé¸è‚¡æ¢ä»¶è¤‡é›œï¼Œä¾è³´å¤šå€‹æŠ€è¡“æŒ‡æ¨™

**åŽŸå› **ï¼š
- è¤‡é›œç­–ç•¥æ›´ä¾è³´ã€Œç•¶å¤©ã€çš„å¤šå€‹æŒ‡æ¨™ï¼ˆåƒ¹æ ¼ã€é‡èƒ½ã€MAï¼‰
- å»¶å¾Œä¸€å¤©åŸ·è¡Œå¾Œï¼Œé€™äº›æ¢ä»¶å¯èƒ½å·²ç¶“æ”¹è®Š
- ç°¡å–®ç­–ç•¥ï¼ˆå¦‚ç­–ç•¥1çš„ RS + PBï¼‰è¼ƒç‚ºç©©å®š

---

### 2. **äº¤æ˜“æˆæœ¬çš„å½±éŸ¿**

æœˆåº¦èª¿å€‰ç­–ç•¥çš„äº¤æ˜“æˆæœ¬åˆ†æžï¼š
- **æ¯æœˆèª¿å€‰ 1 æ¬¡** Ã— **10-15 æª”è‚¡ç¥¨** Ã— **å–®æ¬¡æˆæœ¬ 0.39%**
- **å¹´åº¦ç¸½æˆæœ¬** â‰ˆ 12 Ã— 10 Ã— 0.39% â‰ˆ **47%**ï¼ˆå‡è¨­å…¨éƒ¨æ›æ‰‹ï¼‰

å¯¦éš›å½±éŸ¿ï¼š
- **ç­–ç•¥ 1**ï¼š602 æ¬¡äº¤æ˜“ï¼Œç´„ **1-2% CAGR** æˆæœ¬
- **ç­–ç•¥ 2**ï¼š588 æ¬¡äº¤æ˜“ï¼Œç´„ **2-3% CAGR** æˆæœ¬ï¼ˆå› ç‚ºè¡¨ç¾æœ¬ä¾†å°±å·®ï¼‰
- **ç­–ç•¥ 3**ï¼š271 æ¬¡äº¤æ˜“ï¼Œç´„ **1-2% CAGR** æˆæœ¬

---

### 3. **å‹çŽ‡çš„è®ŠåŒ–**

æœ‰è¶£çš„ç¾è±¡ï¼š**ä¿®æ­£å¾Œå‹çŽ‡åè€Œæé«˜**

| ç­–ç•¥ | ä¿®æ­£å‰å‹çŽ‡ | ä¿®æ­£å¾Œå‹çŽ‡ | è®ŠåŒ– |
|------|-----------|-----------|------|
| ç­–ç•¥ 1 | 54.44% | 54.15% | -0.29% |
| ç­–ç•¥ 2 | 40.81% | 48.88% | +8.07% |
| ç­–ç•¥ 3 | 30.58% | 48.32% | +17.74% |

**åŽŸå› **ï¼š
- ä¿®æ­£å‰çš„ã€Œå‹çŽ‡ã€è¨ˆç®—æ–¹å¼ï¼šä»»ä½•å ±é…¬ > 0 çš„æ—¥å­
- ä¿®æ­£å¾Œå‰”é™¤äº†ã€Œæ²’æœ‰æŒå€‰ã€çš„æ—¥å­ï¼ˆ`valid_returns = strategy_returns[strategy_returns != 0]`ï¼‰
- ç­–ç•¥ 2/3 å› ç‚ºé¸è‚¡è¼ƒå°‘ï¼Œç©ºå€‰æ—¥è¼ƒå¤šï¼Œä¿®æ­£å¾Œå‹çŽ‡æé«˜

---

## âœ… ä¿®æ­£é©—è­‰

### æ¸¬è©¦è¦†è“‹çŽ‡

æ‰€æœ‰ 36 å€‹æ¸¬è©¦æ¡ˆä¾‹é€šéŽï¼š
- âœ… Data Loader æ¸¬è©¦ï¼ˆ6 å€‹ï¼‰
- âœ… ç­–ç•¥ 1 æ¸¬è©¦ï¼ˆ7 å€‹ï¼‰
- âœ… ç­–ç•¥ 2 æ¸¬è©¦ï¼ˆ8 å€‹ï¼‰
- âœ… ç­–ç•¥ 3 æ¸¬è©¦ï¼ˆ9 å€‹ï¼‰
- âœ… Backtest Runner æ¸¬è©¦ï¼ˆ6 å€‹ï¼‰

### ä»£ç¢¼ä¿®æ­£

æ–°å¢ž `backtest_utils.py` æ¨¡çµ„ï¼š
```python
class BacktestEngine:
    # å°è‚¡äº¤æ˜“æˆæœ¬è¨­å®š
    COMMISSION_RATE = 0.001425  # æ‰‹çºŒè²» 0.1425%
    TAX_RATE = 0.003            # è­‰äº¤ç¨… 0.3%
    COMMISSION_DISCOUNT = 0.3   # åˆ¸å•†æŠ˜æ‰£ 70% off

    def backtest_with_cost(self, signals, close):
        # ä¿®æ­£ 1ï¼šè¨Šè™Ÿå»¶å¾Œä¸€å¤©ç”Ÿæ•ˆ
        signals_shifted = signals.shift(1).fillna(0)

        # ä¿®æ­£ 2ï¼šè¨ˆç®—äº¤æ˜“æˆæœ¬
        transaction_cost = self.calculate_transaction_cost(...)

        # æ‰£é™¤æˆæœ¬å¾Œçš„å ±é…¬
        strategy_returns = raw_returns - transaction_cost
```

---

## ðŸ“ˆ æœ€çµ‚å»ºè­°

### çµ¦æŠ•è³‡äºº

1. âœ… **æŽ¨è–¦ç­–ç•¥ 1ï¼ˆæ—ç¾¤ç›¸å°å¼·å¼±æ³•ï¼‰**
   - ä¿®æ­£å¾Œå¹´åŒ– 22.02%ï¼ŒSharpe 1.10
   - ç­–ç•¥ç©©å¥ï¼ŒæŠ— Look-ahead Bias èƒ½åŠ›å¼·
   - æœ€å¤§å›žæ’¤ -29.06%ï¼Œé¢¨éšªå¯æŽ§

2. âŒ **ä¸æŽ¨è–¦ç­–ç•¥ 2ã€3**
   - ä¿®æ­£å¾Œè½‰ç‚ºè² å ±é…¬
   - æœ€å¤§å›žæ’¤è¶…éŽ -60%ï¼Œé¢¨éšªæ¥µé«˜
   - ç­–ç•¥éŽåº¦ä¾è³´æŠ€è¡“æŒ‡æ¨™ï¼Œå¯¦ç›¤å¤±æ•ˆ

3. âš ï¸ **é¢¨éšªæé†’**
   - å³ä½¿æ˜¯ç­–ç•¥ 1ï¼Œå¯¦ç›¤ç¸¾æ•ˆå¯èƒ½ä½Žæ–¼å›žæ¸¬
   - å»ºè­°é…ç½®ä¸è¶…éŽç¸½è³‡ç”¢ 30-50%
   - åŠ å…¥åœææ©Ÿåˆ¶ï¼ˆå¦‚ -10%ï¼‰

---

### çµ¦ç ”ç©¶è€…

1. **å›žæ¸¬è¦ç¯„**
   - å¿…é ˆé¿å… Look-ahead Bias
   - å¿…é ˆæ‰£é™¤äº¤æ˜“æˆæœ¬
   - åˆ¸å•†æŠ˜æ‰£å»ºè­°ä½¿ç”¨ 60-70% offï¼ˆä¿å®ˆä¼°è¨ˆï¼‰

2. **ç­–ç•¥é–‹ç™¼**
   - ç°¡å–®ç­–ç•¥ > è¤‡é›œç­–ç•¥
   - æ¸›å°‘å°ç•¶å¤©å¤šå€‹æŠ€è¡“æŒ‡æ¨™çš„ä¾è³´
   - å„ªå…ˆé¸æ“‡ã€Œè¶¨å‹¢åž‹ã€è€Œéžã€ŒæŠ€è¡“æŒ‡æ¨™åž‹ã€

3. **æˆæœ¬ä¼°ç®—**
   - æœˆåº¦èª¿å€‰ï¼šå¹´åº¦æˆæœ¬ç´„ **1-2% CAGR**
   - é€±åº¦èª¿å€‰ï¼šå¹´åº¦æˆæœ¬ç´„ **4-8% CAGR**
   - æ—¥åº¦èª¿å€‰ï¼šä¸å»ºè­°ï¼ˆæˆæœ¬éŽé«˜ï¼‰

---

## ðŸ”§ æŠ€è¡“ç´°ç¯€

### ä¿®æ­£å‰çš„å•é¡Œä»£ç¢¼

```python
# éŒ¯èª¤ï¼šè¨Šè™Ÿç•¶å¤©å°±ç”Ÿæ•ˆ
returns = close.pct_change(fill_method=None)
strategy_returns = (returns * signals).sum(axis=1) / position_count
# âŒ signals[t] = 1 ä¸” returns[t] æ˜¯ t æ—¥å ±é…¬ï¼Œæå‰ä½¿ç”¨äº†ç•¶å¤©æ•¸æ“š
```

### ä¿®æ­£å¾Œçš„æ­£ç¢ºä»£ç¢¼

```python
# æ­£ç¢ºï¼šè¨Šè™Ÿå»¶å¾Œä¸€å¤©
signals_shifted = signals.shift(1).fillna(0)
# âœ… signals_shifted[t] = signals[t-1]ï¼Œä½¿ç”¨å‰ä¸€å¤©çš„è¨Šè™Ÿ
```

### äº¤æ˜“æˆæœ¬è¨ˆç®—

```python
# è¨ˆç®—æŒå€‰è®ŠåŒ–
position_changes = signals.diff().fillna(signals.iloc[0])

# è²·å…¥è¨Šè™Ÿï¼š0 â†’ 1
buy_signals = (position_changes > 0).astype(int)

# è³£å‡ºè¨Šè™Ÿï¼š1 â†’ 0
sell_signals = (position_changes < 0).astype(int)

# è²·å…¥æˆæœ¬ = è‚¡æ•¸ Ã— æ‰‹çºŒè²»çŽ‡ Ã— æŠ˜æ‰£
buy_cost = buy_signals.sum(axis=1) * 0.001425 * 0.3

# è³£å‡ºæˆæœ¬ = è‚¡æ•¸ Ã— (æ‰‹çºŒè²»çŽ‡ Ã— æŠ˜æ‰£ + è­‰äº¤ç¨…)
sell_cost = sell_signals.sum(axis=1) * (0.001425 * 0.3 + 0.003)
```

---

## ðŸ“ž è¯çµ¡è³‡è¨Š

**ä¿®æ­£æ—¥æœŸ**ï¼š2026-01-26

**ä¿®æ­£é …ç›®**ï¼š
1. Look-ahead Bias ä¿®æ­£
2. äº¤æ˜“æˆæœ¬æ‰£é™¤

**æŠ€è¡“å¯¦ç¾**ï¼šæ–°å¢ž `src/backtest_utils.py` æ¨¡çµ„

---

**å…è²¬è²æ˜Ž**ï¼šæœ¬å ±å‘Šåƒ…ä¾›ç ”ç©¶åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚ä¿®æ­£å¾Œçš„å›žæ¸¬æ›´æŽ¥è¿‘å¯¦ç›¤æƒ…æ³ï¼Œä½†ä»å¯èƒ½å­˜åœ¨å…¶ä»–åå·®ï¼ˆæ»‘åƒ¹ã€æµå‹•æ€§ç­‰ï¼‰ã€‚
