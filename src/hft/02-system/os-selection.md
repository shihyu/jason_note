# HFT 作業系統選擇指南

## 概述

在高頻交易（HFT）領域，作業系統的選擇至關重要，因為即使是幾微秒的延遲差異也可能決定交易的成敗。

## 主要趨勢：Linux 是首選，而非傳統 RTOS

儘管名稱中帶有「實時」，但傳統的實時作業系統 (RTOS)（例如 VxWorks 或 FreeRTOS）在專門的高頻交易系統中並不普遍，**Linux（尤其是經過優化的版本）才是業界標準**。

### 為什麼選擇 Linux？

#### 1. 靈活性和開源性
- Linux 具有高度可客製化性
- 允許交易公司進行核心級別的優化
- 可針對特定的低延遲需求進行深度調整

#### 2. 龐大的生態系統
- 金融行業廣泛使用 C++ 等高效能語言
- Linux 提供豐富的開源工具和函式庫
- 擁有強大的開發者社群支援

#### 3. 效能與可靠性
- 經過優化後可提供穩定、可預測的低延遲效能
- 滿足 HFT 所需的嚴格效能要求
- 久經考驗的企業級穩定性

## HFT 系統中的作業系統優化

高頻交易系統通常使用裁切版 (tailored/trimmed) 或經過特別調整的 Linux 發行版（例如 Ubuntu Server 的精簡版）來最大化速度和一致性。

### 主要優化技術

#### 1. 核心繞過 (Kernel Bypass)
- **目的**：繞過常規的作業系統網路堆疊
- **方法**：直接從網路卡讀取數據
- **效果**：顯著減少延遲
- **常用技術**：DPDK、Solarflare OpenOnload

#### 2. CPU 核心綁定 (CPU Pinning)
- **目的**：避免作業系統排程帶來的延遲抖動 (jitter)
- **方法**：將特定的交易流程綁定到特定的 CPU 核心
- **配置**：使用 `taskset` 或 `isolcpus` 核心參數
- **效果**：確保關鍵任務獨佔 CPU，減少上下文切換

#### 3. 中斷禁用 (Disabling IRQ Balancing)
- **目的**：減少不必要的中斷處理
- **方法**：禁用 IRQ balance 服務
- **效果**：使 CPU 專注於交易任務
- **配置**：調整 `/proc/irq/*/smp_affinity`

#### 4. 記憶體預分配
- **目的**：避免運行時的記憶體分配造成的延遲
- **方法**：在交易開始前分配所有需要的記憶體
- **技術**：
  - Huge Pages 配置
  - NUMA 感知記憶體分配
  - 避免垃圾回收機制
- **效果**：消除記憶體分配延遲，提高可預測性

#### 5. 硬體協同
- **FPGA（現場可程式化邏輯閘陣列）**
  - 處理部分關鍵任務
  - 進一步提升速度
  - 實現硬體級別的演算法加速
- **專用網路卡**
  - 支援核心繞過
  - 提供硬體時間戳
  - 低延遲訊息處理

## Linux 發行版選擇

### 推薦的發行版

#### 1. Ubuntu Server（精簡版）
- **優點**：
  - 廣泛的硬體支援
  - 豐富的套件生態系統
  - 活躍的社群支援
- **適用場景**：開發和測試環境

#### 2. Red Hat Enterprise Linux (RHEL) / CentOS
- **優點**：
  - 企業級支援
  - 長期維護週期
  - 經過大規模生產環境驗證
- **適用場景**：生產環境部署

#### 3. Real-Time Linux (RT-PREEMPT Patch)
- **優點**：
  - 提供更好的即時性保證
  - 降低延遲抖動
  - 可預測的系統行為
- **適用場景**：對延遲一致性要求極高的場景

### 客製化調整重點

1. **最小化系統服務**
   - 關閉所有非必要的系統服務
   - 移除不需要的背景程式
   - 精簡系統啟動流程

2. **核心參數調優**
   - 調整排程器參數
   - 配置網路堆疊參數
   - 優化記憶體管理

3. **電源管理**
   - 禁用 CPU 頻率調整
   - 設定為高效能模式
   - 避免節能機制影響效能

## 與傳統 RTOS 的比較

| 特性 | Linux (優化版) | 傳統 RTOS |
|------|----------------|-----------|
| **延遲** | 微秒級（經優化） | 微秒到毫秒級 |
| **可客製化性** | 極高 | 中等 |
| **生態系統** | 豐富 | 有限 |
| **開發成本** | 較低（開源） | 較高（商業授權） |
| **靈活性** | 高 | 中 |
| **HFT 應用** | 主流 | 罕見 |

## 總結

高頻交易系統追求的是**極致的低延遲和可預測性**。雖然傳統的 RTOS 在工業控制等領域有其應用，但在 HFT 中，**經過深度客製化和優化的 Linux** 憑藉其靈活性和效能優勢成為了主流選擇。

### 關鍵要點

1. Linux 是 HFT 系統的首選作業系統
2. 核心繞過技術是降低延遲的關鍵
3. CPU 和記憶體的精細控制至關重要
4. 硬體協同（FPGA）可進一步提升效能
5. 持續的系統優化和監控不可或缺

## 相關資源

- [HFT-OS-Tuning-Guide.md](./HFT-OS-Tuning-Guide.md) - 詳細的作業系統調校指南
- [kernel-bypass-guide.md](./kernel-bypass-guide.md) - 核心繞過技術詳解
- [HFT_Network_FPGA_Guide.md](./HFT_Network_FPGA_Guide.md) - 網路與 FPGA 整合指南

## 參考文獻

- Linux Real-Time Performance Tuning
- DPDK Documentation
- Financial Industry Low-Latency Best Practices
