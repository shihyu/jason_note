# é«˜é »äº¤æ˜“ç³»çµ±ï¼šä½œæ¥­ç³»çµ±æ•ˆèƒ½èª¿æ ¡å¯¦è¸

## èƒŒæ™¯ä»‹ç´¹

é«˜é »é‡åŒ–äº¤æ˜“ï¼ˆHFTï¼‰æ˜¯ä¸€å ´ç™¼ç”Ÿåœ¨å¥ˆç§’(Nanosecond, ns)å°ºåº¦ä¸Šçš„æˆ°çˆ­ã€‚ç•¶å‚³çµ±äº¤æ˜“ç³»çµ±é‚„åœ¨ä»¥æ¯«ç§’(Millisecond, ms)ç‚ºå–®ä½è¡¡é‡æ•ˆèƒ½æ™‚ï¼ŒHFTç³»çµ±å¿…é ˆåœ¨å¾®ç§’(Microsecond, Î¼s)ä¹ƒè‡³å¥ˆç§’(ns)ç´šåˆ¥é€²è¡Œç«¶çˆ­ã€‚é€™æ„å‘³è‘—ä»»ä½•å¾®å°çš„ä½œæ¥­ç³»çµ±é–‹éŠ·æˆ–ç¡¬é«”è³‡æºçˆ­ç”¨ï¼Œéƒ½å¯èƒ½å°è‡´é—œéµè¨‚å–®æµè™•ç†å»¶é²ï¼Œå¾è€ŒéŒ¯å¤±æœ€ä½³æˆäº¤åƒ¹æˆ–åœ¨è¨‚å–®ä½‡åˆ—ä¸­è½å¾Œã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šæƒ³åƒä½ åœ¨æ¶æ¼”å”±æœƒé–€ç¥¨ï¼Œåˆ¥äººæŒ‰ä¸‹è³¼è²·éµåˆ°å®Œæˆäº¤æ˜“éœ€è¦1ç§’ï¼Œè€Œä½ çš„ç³»çµ±å„ªåŒ–åˆ°åªéœ€0.001ç§’ã€‚åœ¨é«˜é »äº¤æ˜“ä¸–ç•Œï¼Œé€™ç¨®é€Ÿåº¦å·®ç•°å°±æ˜¯è³ºéŒ¢èˆ‡è³ éŒ¢çš„å·®åˆ¥ã€‚1æ¯«ç§’=1000å¾®ç§’=1,000,000å¥ˆç§’ï¼Œé«˜é »äº¤æ˜“å°±æ˜¯åœ¨çˆ­å¥ªé€™äº›æ¥µå¾®å°çš„æ™‚é–“å„ªå‹¢ã€‚

### æ ¸å¿ƒæŒ‘æˆ°

æ ¸å¿ƒæŒ‘æˆ°åœ¨æ–¼é¦´æœä½œæ¥­ç³»çµ±å’Œç¡¬é«”å¹³å°ï¼Œæ¶ˆé™¤å…¶å¼•å…¥çš„éç¢ºå®šæ€§å’Œé¡å¤–å»¶é²ï¼š

- **ä½œæ¥­ç³»çµ±æ’ç¨‹ä¸ç¢ºå®šæ€§**ï¼šé è¨­çš„å®Œå…¨å…¬å¹³æ’ç¨‹(CFS)ç­–ç•¥å¯èƒ½å°è‡´ä½å»¶é²é—œéµè¡Œç¨‹è¢«èƒŒæ™¯ä»»å‹™ï¼ˆå¦‚æ—¥èªŒã€ç›£æ§ï¼‰æˆ–æ ¸å¿ƒåŸ·è¡Œç·’ï¼ˆå¦‚ ksoftirqd, kworkerï¼‰æ¶å ï¼Œå¼•å…¥ä¸å¯é æ¸¬çš„å¾®ç§’ç´šç”šè‡³æ¯«ç§’ç´šåœé “ã€‚
  > ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå°±åƒä½ æ­£åœ¨å°ˆå¿ƒæ‰“é›»ç«¶ï¼Œçªç„¶é›»è…¦æ±ºå®šè¦æ›´æ–°é˜²æ¯’è»Ÿé«”ï¼Œå°è‡´éŠæˆ²å¡é “ã€‚CFSå°±åƒä¸€å€‹ã€Œå…¬å¹³ã€çš„è€å¸«ï¼Œè¦æ±‚æ¯å€‹ç¨‹å¼éƒ½æœ‰æ©Ÿæœƒä½¿ç”¨CPUï¼Œä½†å°æ™‚é–“æ•æ„Ÿçš„äº¤æ˜“ç¨‹å¼ä¾†èªªï¼Œé€™ç¨®ã€Œå…¬å¹³ã€åè€Œæ˜¯ç½é›£ã€‚

- **ç¡¬é«”è³‡æºçˆ­ç”¨**ï¼šè¶…åŸ·è¡Œç·’(Hyper-Threading, HT)ä½¿å¾—é‚è¼¯æ ¸å¿ƒå…±äº«å¯¦é«”åŸ·è¡Œå–®å…ƒï¼Œå…„å¼ŸåŸ·è¡Œç·’çš„è¨ˆç®—å¯†é›†å‹ä»»å‹™ï¼ˆå¦‚ä½¿ç”¨AVXæŒ‡ä»¤ï¼‰æœƒé˜»å¡äº¤æ˜“åŸ·è¡Œç·’ï¼›å¤šå€‹æ ¸å¿ƒçˆ­ç”¨å…±äº«çš„æœ«ç´šå¿«å–(L3 Cache)ï¼Œå°è‡´å¿«å–è¡Œå¤±æ•ˆå’Œæ›´é«˜çš„è¨˜æ†¶é«”å­˜å–å»¶é²ã€‚
  > ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šè¶…åŸ·è¡Œç·’å°±åƒä¸€å€‹å»šæˆ¿ï¼ˆå¯¦é«”æ ¸å¿ƒï¼‰è£¡æœ‰å…©å€‹å»šå¸«ï¼ˆé‚è¼¯æ ¸å¿ƒï¼‰å…±ç”¨åŒä¸€å¥—çˆå…·ã€‚ç•¶ä¸€å€‹å»šå¸«åœ¨ç…ç‰›æ’ï¼ˆé‡è¨ˆç®—ï¼‰ï¼Œå¦ä¸€å€‹æƒ³å¿«é€Ÿç…®å€‹è›‹ï¼ˆäº¤æ˜“ä»»å‹™ï¼‰å°±å¾—ç­‰å¾…ã€‚L3å¿«å–å‰‡åƒå…±ç”¨å†°ç®±ï¼Œå¤ªå¤šäººåŒæ™‚å­˜å–æœƒäº’ç›¸å¹²æ“¾ã€‚

- **NUMAæ¶æ§‹å½±éŸ¿**ï¼šåœ¨éçµ±ä¸€è¨˜æ†¶é«”å­˜å–(NUMA)æ¶æ§‹çš„å¤šè·¯ä¼ºæœå™¨ä¸Šï¼Œè·¨ç¯€é»(Remote Node)å­˜å–è¨˜æ†¶é«”çš„å»¶é²å¯èƒ½æ¯”æœ¬åœ°ç¯€é»(Local Node)é«˜å‡º50%ç”šè‡³æ›´å¤šã€‚
  > ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šNUMAå°±åƒä¸€æ£Ÿæœ‰å¤šå€‹å»šæˆ¿çš„å¤§æ¨“ï¼Œæ¯å€‹å»šæˆ¿éƒ½æœ‰è‡ªå·±çš„å†°ç®±ï¼ˆæœ¬åœ°è¨˜æ†¶é«”ï¼‰ã€‚å¦‚æœä½ åœ¨2æ¨“å»šæˆ¿å»è¦å»1æ¨“æ‹¿é£Ÿæï¼Œæ¯”åœ¨è‡ªå·±æ¨“å±¤æ‹¿æ…¢å¾ˆå¤šã€‚

- **å‚³çµ±I/Oç“¶é ¸**ï¼šæ ¸å¿ƒç¶²è·¯å”å®šå †ç–Šè™•ç†ç¶²è·¯å°åŒ…éœ€è¦å¤šæ¬¡ä¸Šä¸‹æ–‡åˆ‡æ›ã€è³‡æ–™æ‹·è²å’Œå”å®šè§£æï¼Œå–®æ¬¡è™•ç†è€—æ™‚è¼•é¬†è¶…é10Î¼sï¼Œæˆç‚ºå»¶é²å¤§æˆ¶ã€‚
  > ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå‚³çµ±ç¶²è·¯è™•ç†åƒéƒµå±€æ”¶ç™¼ä¿¡ï¼Œä¿¡ä»¶è¦ç¶“éæ”¶ä»¶ã€åˆ†é¡ã€è“‹ç« ã€æ´¾é€ç­‰å¤šå€‹æ­¥é©Ÿã€‚æ¯å€‹æ­¥é©Ÿéƒ½è¦æ’éšŠç­‰å¾…ï¼Œæ•´é«”è€—æ™‚å¾ˆé•·ã€‚

### æœ€ä½³åŒ–ç›®æ¨™

é€éæœ¬æ–‡é—¡è¿°çš„ä½œæ¥­ç³»çµ±æ·±åº¦èª¿æ ¡å¯¦è¸ï¼Œç›®æ¨™æ˜¯å°‡é—œéµè·¯å¾‘çš„å»¶é²æ³¢å‹•ï¼ˆJitterï¼‰å¾é è¨­ç’°å¢ƒä¸‹çš„Â±50Î¼så£“ç¸®åˆ°Â±1Î¼sä»¥å…§ï¼Œä¸¦å°‡å¹³å‡å»¶é²ç©©å®šåœ°æ§åˆ¶åœ¨20Î¼sä»¥ä¸‹ï¼Œç‚ºç­–ç•¥åŸ·è¡Œæä¾›é«˜åº¦ç¢ºå®šæ€§çš„å¾®ç§’ç´šå›æ‡‰èƒ½åŠ›ã€‚é€™æ˜¯å¯¦ç¾ç©©å®šç²åˆ©çš„åŸºç¤è¨­æ–½ä¿éšœã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå°±åƒæŠŠè³½è»Šçš„å–®åœˆæ™‚é–“å¾ã€Œ60Â±5ç§’ã€å„ªåŒ–åˆ°ã€Œ50Â±0.1ç§’ã€ï¼Œä¸åƒ…æ›´å¿«ï¼Œè€Œä¸”æ¯åœˆæ™‚é–“éƒ½éå¸¸ç©©å®šï¼Œé€™ç¨®å¯é æ¸¬æ€§å°äº¤æ˜“ç­–ç•¥è‡³é—œé‡è¦ã€‚

## æ ¸å¿ƒéš”é›¢ï¼šæ¶ˆé™¤è³‡æºç«¶çˆ­

### 1. å¯¦é«”æ ¸ç¨å ï¼ˆCPU Pinningï¼‰

#### ç‚ºä»€éº¼éœ€è¦

ç¾ä»£CPUçš„è¶…åŸ·è¡Œç·’æŠ€è¡“(HT)å°‡ä¸€å€‹å¯¦é«”æ ¸æ¨¡æ“¬ç‚ºå…©å€‹é‚è¼¯æ ¸ï¼Œå®ƒå€‘å…±äº«æ ¸å¿ƒçš„åŸ·è¡Œå–®å…ƒï¼ˆå¦‚ALUã€FPUï¼‰å’ŒL1/L2å¿«å–ã€‚åœ¨é«˜é »äº¤æ˜“å ´æ™¯ä¸‹ï¼Œé€™å¸¶ä¾†å…©å€‹è‡´å‘½å•é¡Œï¼š

1. è‹¥ç¶å®šåˆ°åŒä¸€å¯¦é«”æ ¸ä¸Šçš„å…„å¼ŸåŸ·è¡Œç·’ï¼ˆå¦‚æ—¥èªŒåŸ·è¡Œç·’ã€ç›£æ§åŸ·è¡Œç·’ï¼‰åŸ·è¡Œäº†è¨ˆç®—å¯†é›†å‹æ“ä½œï¼Œå°¤å…¶æ˜¯ä½¿ç”¨AVXç­‰å¯¬æŒ‡ä»¤é›†æ™‚ï¼Œæœƒå®Œå…¨å ç”¨å…±äº«çš„æµ®é»å–®å…ƒï¼Œå°è‡´äº¤æ˜“åŸ·è¡Œç·’è¢«é˜»å¡
2. å…„å¼ŸåŸ·è¡Œç·’å°L1/L2å¿«å–çš„å­˜å–æœƒæ±¡æŸ“æˆ–é©…é€äº¤æ˜“åŸ·è¡Œç·’çš„ç†±é»è³‡æ–™ï¼Œå¢åŠ å¿«å–æœªå‘½ä¸­(Cache Miss)ç‡

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼š
> - **å•é¡Œ1**ï¼šå°±åƒå…©å€‹äººå…±ç”¨ä¸€å°é›»è…¦ï¼Œä¸€å€‹åœ¨è·‘3Dæ¸²æŸ“ï¼ˆä½”ç”¨é¡¯å¡ï¼‰ï¼Œå¦ä¸€å€‹æƒ³ç©éŠæˆ²å°±å¡ä½äº†ã€‚
> - **å•é¡Œ2**ï¼šå¿«å–åƒä½ çš„å·¥ä½œæ¡Œé¢ï¼Œä½ ç²¾å¿ƒæ“ºæ”¾å¥½å¸¸ç”¨æ–‡ä»¶ï¼Œå®¤å‹å»æŠŠä»–çš„æ±è¥¿ä¹Ÿå †ä¸Šä¾†ï¼Œå°è‡´ä½ çš„æ–‡ä»¶è¢«æ“ åˆ°åœ°ä¸Šï¼Œè¦ç”¨æ™‚å¾—é‡æ–°æ‰¾ã€‚

**å¯¦æ¸¬è³‡æ–™è¡¨æ˜**ï¼Œåœ¨é«˜è² è¼‰ã€ä½å»¶é²æ•æ„Ÿå ´æ™¯ä¸‹ï¼Œåœç”¨è¶…åŸ·è¡Œç·’å¯ä½¿é—œéµäº¤æ˜“åŸ·è¡Œç·’çš„åŸ·è¡Œå»¶é²é™ä½é«˜é”22%ï¼ˆåŸºæ–¼Intel Xeon Scalableè™•ç†å™¨æ¸¬è©¦ï¼‰ï¼Œæ›´é‡è¦çš„æ˜¯å¤§å¹…é™ä½äº†å»¶é²æ³¢å‹•ï¼ˆJitterï¼‰ã€‚

#### æ¬Šè¡¡å–æ¨

åœç”¨è¶…åŸ·è¡Œç·’æœƒé™ä½ç³»çµ±çš„æ•´é«”ååé‡(Throughput)ã€‚å› æ­¤ï¼Œåˆç†çš„ç­–ç•¥æ˜¯**éš”é›¢é—œéµè·¯å¾‘**ï¼šå°‡äº¤æ˜“ç­–ç•¥å¼•æ“ã€ç¶²è·¯è™•ç†åŸ·è¡Œç·’ç­‰ä½å»¶é²æ•æ„Ÿä»»å‹™**ç¨å ç¶å®šåˆ°å¯¦é«”æ ¸å¿ƒ**ï¼ˆä½¿ç”¨é‚è¼¯æ ¸IDçš„å¶æ•¸æˆ–å¥‡æ•¸éƒ¨åˆ†ï¼‰ï¼Œè€Œå°‡æ—¥èªŒè¨˜éŒ„ã€ç›£æ§ä¸Šå ±ã€è³‡æ–™æŒä¹…åŒ–ç­‰éå³æ™‚æ€§ä»»å‹™éƒ¨ç½²åœ¨å•Ÿç”¨è¶…åŸ·è¡Œç·’çš„æ ¸å¿ƒä¸Šã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå°±åƒé¤å»³ç¶“ç‡Ÿï¼ŒæŠŠæœ€å¥½çš„å»šå¸«å’Œçˆå…·å°ˆé–€ç•™çµ¦åšä¸»èœï¼ˆäº¤æ˜“ä»»å‹™ï¼‰ï¼Œå…¶ä»–å»šå¸«å…±ç”¨è¨­å‚™åšé…èœå’Œç”œé»ï¼ˆæ—¥èªŒã€ç›£æ§ç­‰ï¼‰ã€‚

#### è¨­å®šæ–¹æ³•

```bash
# æª¢è¦–å¯¦é«”æ ¸æ‹“æ’²ï¼ˆå¯¦é«”æ ¸IDé€£çºŒï¼‰
lscpu -p | grep -v '#' | awk -F, '{print $1,$3}' | sort -t, -k2n

# ç¶å®šç­–ç•¥è¡Œç¨‹åˆ°å¯¦é«”æ ¸8-15ï¼ˆè·³éè¶…åŸ·è¡Œç·’æ ¸ï¼‰
taskset -c 8-15 ./strategy_engine
```

#### C++å¯¦ä½œï¼ˆsched_setaffinityï¼‰

```cpp
cpu_set_t cpuset;
CPU_ZERO(&cpuset);
for(int i=8; i<=15; i++) CPU_SET(i, &cpuset);
sched_setaffinity(0, sizeof(cpuset), &cpuset);
```

### 2. ä¸­æ–·é‡å®šå‘

#### ç‚ºä»€éº¼éœ€è¦

ç¶²è·¯ä»‹é¢å¡(NIC)ç”¢ç”Ÿçš„ä¸­æ–·(IRQ)é è¨­é€šå¸¸ç”±CPU 0è™•ç†ã€‚å¦‚æœåœ¨é—œéµäº¤æ˜“åŸ·è¡Œç·’åŸ·è¡Œçš„CPUæ ¸å¿ƒä¸Šè™•ç†ç¶²è·¯ä¸­æ–·ï¼Œæœƒç”¢ç”Ÿåš´é‡çš„è² é¢å½±éŸ¿ï¼š

1. **ä¸­æ–·è™•ç†ç¨‹å¼æ¶å ä½¿ç”¨è€…æ…‹äº¤æ˜“åŸ·è¡Œç·’**ï¼Œå¼·åˆ¶é€²è¡Œä¸Šä¸‹æ–‡åˆ‡æ›
2. **ä¸­æ–·è™•ç†ç¨‹å¼å­˜å–è¨˜æ†¶é«”æœƒæ±¡æŸ“è©²æ ¸å¿ƒçš„L1då¿«å–**ï¼Œå°è‡´äº¤æ˜“åŸ·è¡Œç·’çš„ç†±é»è³‡æ–™è¢«é©…é€

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼š
> - **ä¸­æ–·**å°±åƒé–€éˆ´ï¼Œæœ‰äººæŒ‰é–€éˆ´ï¼ˆç¶²è·¯å°åŒ…åˆ°é”ï¼‰ä½ å¿…é ˆç«‹åˆ»å»é–‹é–€ï¼Œæ‰‹ä¸Šçš„å·¥ä½œï¼ˆäº¤æ˜“é‹ç®—ï¼‰å°±å¾—æš«åœã€‚
> - æŠŠé–€éˆ´æ”¹è£åˆ°éš”å£æˆ¿é–“ï¼Œè®“å°ˆé–€çš„äººå»æ‡‰é–€ï¼Œä½ å°±èƒ½å°ˆå¿ƒå·¥ä½œä¸è¢«æ‰“æ“¾ã€‚

å–®æ¬¡ä¸­æ–·äº‹ä»¶å°±å¯èƒ½å¢åŠ ~300nsçš„é¡å¤–è¨˜æ†¶é«”å­˜å–å»¶é²ã€‚é€éå°‡ç¶²å¡ä¸­æ–·é‡å®šå‘åˆ°å°ˆç”¨çš„ééš”é›¢æ ¸å¿ƒï¼Œå¯ä»¥é¡¯è‘—é™ä½é—œéµäº¤æ˜“æ ¸å¿ƒçš„å»¶é²æ³¢å‹•ã€‚

#### è¨­å®šæ–¹æ³•

```bash
# å°‡eth0ä¸­æ–·ç¶å®šåˆ°CPU16-23
IRQ=$(awk -F: '/eth0/{print $1}' /proc/interrupts)
echo "fff000" > /proc/irq/$IRQ/smp_affinity  # é®ç½©å°æ‡‰CPU16-23
```

### 3. æ ¸å¿ƒæ’ç¨‹éš”é›¢

#### ç‚ºä»€éº¼éœ€è¦

å³ä½¿é€²è¡Œäº†CPUç¶å®šï¼Œé è¨­æƒ…æ³ä¸‹ï¼Œæ ¸å¿ƒåŸ·è¡Œç·’ï¼ˆå¦‚è² è²¬è»Ÿä¸­æ–·è™•ç†çš„ksoftirqdï¼Œè™•ç†å·¥ä½œä½‡åˆ—çš„kworkerï¼‰ä»ç„¶å¯èƒ½è¢«æ’ç¨‹åˆ°ç¶å®šçš„æ ¸å¿ƒä¸ŠåŸ·è¡Œï¼Œæ¶å ä½¿ç”¨è€…æ…‹äº¤æ˜“åŸ·è¡Œç·’ã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå°±åƒä½ ç§Ÿäº†ä¸€é–“VIPåŒ…å»‚çœ‹çƒè³½ï¼Œä½†ä¿å…¨ã€æ¸…æ½”äººå“¡é‚„æ˜¯æœƒä¸æ™‚é€²ä¾†æ‰“æ“¾ã€‚é€™äº›æ ¸å¿ƒåŸ·è¡Œç·’å°±åƒã€Œç³»çµ±å·¥ä½œäººå“¡ã€ï¼Œisolcpusç­‰åƒæ•¸å°±æ˜¯å‘Šè¨´ä»–å€‘ã€Œé€™å¹¾å€‹CPUæ ¸å¿ƒæ˜¯VIPå°ˆç”¨ï¼Œé–’é›œäººç­‰å‹¿å…¥ã€ã€‚

- `isolcpus`åƒæ•¸å°‡æŒ‡å®šçš„CPUæ ¸å¿ƒå¾æ ¸å¿ƒé€šç”¨æ’ç¨‹å™¨ä¸­éš”é›¢å‡ºä¾†ï¼Œ**é˜»æ­¢å¤§éƒ¨åˆ†æ ¸å¿ƒåŸ·è¡Œç·’å’Œæ™®é€šä½¿ç”¨è€…è¡Œç¨‹åœ¨å…¶ä¸ŠåŸ·è¡Œ**
- `nohz_full`åƒæ•¸å¯ä»¥åœ¨é€™äº›æ ¸å¿ƒä¸Šå•Ÿç”¨è‡ªé©æ‡‰ç„¡æ™‚é˜æ¨¡å¼ï¼Œ**é¡¯è‘—æ¸›å°‘æˆ–å®Œå…¨æ¶ˆé™¤æ™‚é˜ä¸­æ–·**
  > ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šæ™‚é˜ä¸­æ–·åƒé¬§é˜ï¼Œæ¯éš”ä¸€æ®µæ™‚é–“éŸ¿ä¸€æ¬¡æª¢æŸ¥æœ‰æ²’æœ‰å…¶ä»–ä»»å‹™ã€‚nohz_fullå°±æ˜¯æŠŠé¬§é˜é—œæ‰ï¼Œè®“ç¨‹å¼å®‰éœåŸ·è¡Œã€‚
- `rcu_nocbs`åƒæ•¸å°‡**RCUå›å‘¼ä»»å‹™å¸è¼‰åˆ°å…¶ä»–ééš”é›¢æ ¸å¿ƒåŸ·è¡Œ**
  > ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šRCUåƒåƒåœ¾å›æ”¶ï¼Œrcu_nocbså°±æ˜¯è®“åƒåœ¾è»Šä¸è¦é–‹é€²VIPå€åŸŸï¼Œæ”¹åœ¨å…¶ä»–åœ°æ–¹è™•ç†ã€‚

#### è¨­å®šæ–¹æ³•

```bash
# ä¿®æ”¹GRUBè¨­å®š
grub_cmdline="isolcpus=8-15 nohz_full=8-15 rcu_nocbs=8-15"

# ç”Ÿæ•ˆè¨­å®š
grub2-mkconfig -o /boot/grub2/grub.cfg
```

## NUMAè¨˜æ†¶é«”æœ€ä½³åŒ–ï¼šæ”»å…‹è·¨ç¯€é»å»¶é²

### 1. è¨˜æ†¶é«”æœ¬åœ°åŒ–ç¶å®š

#### ç‚ºä»€éº¼éœ€è¦

åœ¨å¤šè·¯ä¼ºæœå™¨(NUMAæ¶æ§‹)ä¸­ï¼Œè¨˜æ†¶é«”æ§åˆ¶å™¨åˆ†å¸ƒåœ¨ä¸åŒçš„å¯¦é«”CPUæ’æ§½(Node)ä¸Šã€‚CPUå­˜å–å…¶æœ¬åœ°ç¯€é»çš„è¨˜æ†¶é«”(**Local Access**)é€Ÿåº¦æœ€å¿«ï¼Œè€Œå­˜å–å…¶ä»–ç¯€é»(**Remote Access**)çš„è¨˜æ†¶é«”éœ€è¦é€éCPUé–“çš„äº’é€£ï¼Œå»¶é²é¡¯è‘—å¢åŠ ï¼ˆé€šå¸¸é«˜å‡º50%-100%ç”šè‡³æ›´å¤šï¼‰ã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šæƒ³åƒä¸€å€‹å¤§å…¬å¸æœ‰å°åŒ—å’Œé«˜é›„å…©å€‹è¾¦å…¬å®¤ï¼Œæ¯å€‹è¾¦å…¬å®¤éƒ½æœ‰è‡ªå·±çš„æª”æ¡ˆå®¤ã€‚å°åŒ—å“¡å·¥è¦æŸ¥å°åŒ—æª”æ¡ˆå®¤çš„è³‡æ–™å¾ˆå¿«ï¼ˆæœ¬åœ°å­˜å–ï¼‰ï¼Œä½†è¦æŸ¥é«˜é›„æª”æ¡ˆå®¤å°±å¾—æ‰“é›»è©±è«‹é‚£é‚Šå‚³çœŸéä¾†ï¼ˆé ç«¯å­˜å–ï¼‰ï¼Œæ…¢å¾ˆå¤šã€‚

é€éå°‡ç­–ç•¥è¡Œç¨‹åŠå…¶ä½¿ç”¨çš„è¨˜æ†¶é«”åš´æ ¼ç¶å®šåœ¨åŒä¸€å€‹NUMAç¯€é»ä¸Šï¼Œå¯ä»¥æ¶ˆé™¤è·¨ç¯€é»å­˜å–ï¼Œå°‡è¨˜æ†¶é«”å»¶é²é™ä½å¤šé”50%ï¼Œä¸¦å¤§å¹…é™ä½å»¶é²æ³¢å‹•ã€‚

#### è¨­å®šæ–¹æ³•

```bash
# å•Ÿå‹•æ™‚ç¶å®šè¨˜æ†¶é«”ç¯€é»
numactl --cpunodebind=0 --membind=0 ./strategy
```

#### ç¨‹å¼ç¢¼æ§åˆ¶

```cpp
#include <numa.h>
numa_set_localalloc();  // å„ªå…ˆæœ¬åœ°åˆ†é…
void* mem = numa_alloc_local(1024*1024); // 1MBæœ¬åœ°è¨˜æ†¶é«”
```

## ç¼ºé ä¸­æ–·æœ€ä½³åŒ–ï¼šé–å®šã€é å–èˆ‡å¤§é 

è¨˜æ†¶é«”å­˜å–å»¶é²çš„å¦ä¸€å€‹ä¸»è¦æ•µäººæ˜¯**ç¼ºé ä¸­æ–·(Page Fault)**å’Œ**TLBæœªå‘½ä¸­(TLB Miss)**ã€‚æœ¬éƒ¨åˆ†æœ€ä½³åŒ–æ—¨åœ¨**å°‡è¨˜æ†¶é«”å­˜å–ç›¸é—œçš„é–‹éŠ·ç§»è‡³åˆå§‹åŒ–éšæ®µ**ï¼Œä¸¦**é–å®šé—œéµè³‡æº**ã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼š
> - **ç¼ºé ä¸­æ–·**ï¼šå°±åƒä½ ç¿»æ›¸æ™‚ç™¼ç¾éœ€è¦çš„é‚£é è¢«æ’•æ‰äº†ï¼Œå¾—å»åœ–æ›¸é¤¨é‡æ–°å½±å°ï¼ˆå¾ç¡¬ç¢Ÿè¼‰å…¥åˆ°è¨˜æ†¶é«”ï¼‰ã€‚
> - **TLB**ï¼šåƒæ˜¯æ›¸çš„ç›®éŒ„ç´¢å¼•ï¼Œå¹«ä½ å¿«é€Ÿæ‰¾åˆ°æŸä¸€é åœ¨å“ªã€‚TLBå¤ªå°å°±åƒç›®éŒ„åªåˆ—äº†å‰10é ï¼Œå¾Œé¢çš„éƒ½è¦æ…¢æ…¢ç¿»ã€‚

### 1. è¨˜æ†¶é«”é–å®šï¼ˆå¼·åˆ¶å¯¦é«”è¨˜æ†¶é«”é§ç•™ï¼‰

#### ç‚ºä»€éº¼éœ€è¦

é è¨­æƒ…æ³ä¸‹ï¼Œä½œæ¥­ç³»çµ±æœƒæ ¹æ“šè¨˜æ†¶é«”å£“åŠ›å°‡è¡Œç¨‹ä¸å¸¸ç”¨çš„è¨˜æ†¶é«”é æ›å‡ºåˆ°ç£ç¢Ÿã€‚åŸ·è¡Œæ™‚è§¸ç™¼çš„æ›å…¥æœƒé€ æˆæ¯«ç§’ç´šçš„ä¸å¯é æ¸¬åœé “ã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå°±åƒåœ–æ›¸é¤¨ç‚ºäº†ç¯€çœç©ºé–“ï¼ŒæŠŠå¾ˆä¹…æ²’äººå€Ÿçš„æ›¸ç§»åˆ°åœ°ä¸‹å€‰åº«ã€‚ç•¶ä½ çªç„¶è¦ç”¨æ™‚ï¼Œå¾—ç­‰ç®¡ç†å“¡å»åœ°ä¸‹å®¤æ¬ä¸Šä¾†ï¼Œå¾ˆè€—æ™‚ã€‚è¨˜æ†¶é«”é–å®šå°±æ˜¯å‘Šè¨´åœ–æ›¸é¤¨ã€Œé€™äº›æ›¸æ°¸é æ”¾åœ¨é–±è¦½å®¤ï¼Œä¸å‡†ç§»èµ°ã€ã€‚

`mlock`ç³»çµ±å‘¼å«å°‡æŒ‡å®šçš„è™›æ“¬è¨˜æ†¶é«”ç¯„åœ**é–å®šåœ¨å¯¦é«”è¨˜æ†¶é«”(RAM)ä¸­**ï¼Œç¢ºä¿å…¶ä¸æœƒè¢«æ›å‡ºã€‚æ­¤å¤–ï¼Œå®ƒé‚„å…·æœ‰å…©å€‹é—œéµå„ªå‹¢ï¼š

1. **é˜²æ­¢é å¿«å–å›å¯«å¹²æ“¾**ï¼šé–å®šçš„åŒ¿åé ä¸æœƒè¢«æ¨™è¨˜ç‚ºé«’é 
2. **ç¢ºå®šæ€§æå‡**ï¼šçµåˆNUMAç¶å®šï¼Œç¢ºä¿æ‰€éœ€è¨˜æ†¶é«”å§‹çµ‚é§ç•™åœ¨æœ¬åœ°ç¯€é»çš„å¯¦é«”è¨˜æ†¶é«”ä¸­

#### è¨­å®šæ–¹æ³•

```bash
# å¢å¤§è¨˜æ†¶é«”é–å®šé…é¡ (é è¨­64KB)
sysctl vm.lock_limit_kb=1048576  # 1GB
echo "vm.lock_limit_kb=1048576" >> /etc/sysctl.conf

# åœç”¨äº¤æ›ç©ºé–“
swapoff -a
```

#### ç¨‹å¼ç¢¼å¯¦ä½œ

```cpp
#include <sys/mman.h>
#include <iostream>
#include <cstring>

// åˆ†é…ä¸¦é–å®šè¨˜æ†¶é«”
void* allocateLockedMemory(size_t size) {
    // åˆ†é…å°é½Šçš„è¨˜æ†¶é«”ï¼ˆPOSIXæ¨™æº–ï¼‰
    void* mem;
    if (posix_memalign(&mem, sysconf(_SC_PAGESIZE), size) != 0) {
        return nullptr;
    }

    // å˜—è©¦å¯¦é«”è¨˜æ†¶é«”é–å®š 
    if (mlock(mem, size) == -1) {
        free(mem);  // é–å®šå¤±æ•—å‰‡é‡‹æ”¾è¨˜æ†¶é«”
        return nullptr;
    }

    return mem;
}

int main() {
    const size_t memSize = 1024 * 1024; // 1MB
    void* lockedMem = allocateLockedMemory(memSize);
    
    if (!lockedMem) {
        std::cerr << "Failed to allocate locked memory! ";
        std::cerr << "(Tip: Requires root or CAP_IPC_LOCK)\n";
        return 1;
    }

    // ä½¿ç”¨è¨˜æ†¶é«”...
    int* data = static_cast<int*>(lockedMem);
    data[0] = 0x12345678;

    // ä¿æŒå¸¸é§ï¼ˆç¨‹å¼åŸ·è¡Œæ™‚è¨˜æ†¶é«”ä¸æœƒæ›å‡ºï¼‰
    while(true) {
        // å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰æœ‰é€€å‡ºé‚è¼¯
        sleep(1);
    }
    
    // ç¨‹å¼é€€å‡ºæ™‚è‡ªå‹•è§£é–
    munlock(lockedMem, memSize);
    free(lockedMem);
    return 0;
}
```

### 2. è¨˜æ†¶é«”é å–ï¼ˆPrefetchingï¼‰

#### ç‚ºä»€éº¼éœ€è¦

è¨˜æ†¶é«”é–å®šä¿è­‰äº†å¯¦é«”è¨˜æ†¶é«”é§ç•™ï¼Œä½†åœ¨è¡Œç¨‹å•Ÿå‹•æˆ–è¨˜æ†¶é«”å‰›åˆ†é…æ™‚ï¼Œè™›æ“¬ä½å€åˆ°å¯¦é«”ä½å€çš„æ˜ å°„å¯èƒ½å°šæœªå»ºç«‹ã€‚é å–çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šåœ¨ç­–ç•¥åˆå§‹åŒ–éšæ®µã€äº¤æ˜“é–‹å§‹å‰ï¼Œä¸»å‹•åœ°ã€ä¸€æ¬¡æ€§åœ°å­˜å–æ‰€æœ‰æœªä¾†éœ€è¦ä½¿ç”¨çš„é–å®šè¨˜æ†¶é«”å€åŸŸï¼Œäººç‚ºè§¸ç™¼ä¸¦è™•ç†å®Œæ‰€æœ‰æ½›åœ¨çš„ç¼ºé ä¸­æ–·ã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå°±åƒé¤å»³é–‹åº—å‰çš„æº–å‚™å·¥ä½œï¼Œå…ˆæŠŠæ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„é£Ÿæéƒ½å¾å†·å‡åº«æ‹¿å‡ºä¾†è§£å‡ã€æ“ºå¥½ä½ç½®ã€‚ç­‰å®¢äººé»é¤æ™‚å°±èƒ½ç«‹å³ä½¿ç”¨ï¼Œä¸ç”¨è‡¨æ™‚å»æ‰¾ã€‚

#### ç¨‹å¼ç¢¼å¯¦ä½œ

```cpp
#include <sys/mman.h>
#include <iostream>
#include <cstring>

int main() {
    const size_t memSize = 1024 * 1024; // 1MB
    void* lockedMem = allocateLockedMemory(memSize);
    
    if (!lockedMem) {
        std::cerr << "Failed to allocate locked memory!\n";
        return 1;
    }

    // æ‰‹å‹•è§¸ç™¼ç¼ºé ä¸­æ–·
    memset(lockedMem, 0, memSize);

    // ä¿æŒå¸¸é§
    while(true) {
        // é å–è³‡æ–™åˆ°L1
        __builtin_prefetch(lockedMem, 0, 3);
        sleep(1);
    }

    munlock(lockedMem, memSize);
    free(lockedMem);
    return 0;
}
```

### 3. å¤§é è¨˜æ†¶é«”ï¼ˆHugePageï¼‰

#### ç‚ºä»€éº¼éœ€è¦

é è¨­è¨˜æ†¶é«”é å¤§å°ç‚º4KBã€‚ç•¶è¡Œç¨‹éœ€è¦å­˜å–å¤§é‡è¨˜æ†¶é«”æ™‚ï¼Œé »ç¹çš„TLBæœªå‘½ä¸­æœƒè§¸ç™¼é è¡¨éæ­·ï¼Œå¢åŠ å­˜å–å»¶é²ã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼š
> - **æ™®é€šé (4KB)**ï¼šåƒç”¨å¾ˆå¤šå¼µå°ä¾¿æ¢ç´™è¨˜éŒ„è³‡è¨Šï¼Œè¦æ‰¾æ±è¥¿å¾—ç¿»å¾ˆå¤šå¼µã€‚
> - **å¤§é (2MB)**ï¼šåƒç”¨A3å¤§ç´™è¨˜éŒ„ï¼Œä¸€å¼µç´™èƒ½å¯«ä¸‹æ›´å¤šå…§å®¹ï¼ŒæŸ¥æ‰¾æ›´å¿«ã€‚
> - **TLB**ï¼šåƒä¾¿æ¢ç´™çš„ç´¢å¼•å¡ç‰‡ç›’ï¼Œåªèƒ½æ”¾æœ‰é™å¼µç´¢å¼•å¡ã€‚ç”¨å¤§é å¾Œï¼ŒåŒæ¨£æ•¸é‡çš„ç´¢å¼•å¡èƒ½è¦†è“‹æ›´å¤šå…§å®¹ã€‚

**å¤§é (HugePage)**ï¼ˆé€šå¸¸ç‚º2MBæˆ–1GBï¼‰é€éå¢å¤§å–®å€‹é çš„å¤§å°ï¼Œä½¿å¾—ä¸€å€‹TLBæ¢ç›®å¯ä»¥è¦†è“‹æ›´å¤§çš„å¯¦é«”ä½å€ç¯„åœï¼Œå¾è€Œ**é¡¯è‘—æ¸›å°‘TLB Missesçš„æ©Ÿç‡**ã€‚

#### ä½¿ç”¨å»ºè­°

- **èˆ‡è¨˜æ†¶é«”é–å®šå”åŒ**ï¼šé¿å…å¤§é è¢«æ›å‡º
- **åœç”¨é€æ˜å¤§é (THP)**ï¼šTHPçš„åˆä½µæ“ä½œå¯èƒ½åœ¨åŸ·è¡Œæ™‚ç™¼ç”Ÿï¼Œå¼•å…¥ä¸å¯é æ¸¬çš„æ•ˆèƒ½æŠ–å‹•
  > ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šé€æ˜å¤§é åƒè‡ªå‹•æª”æ±½è»Šï¼Œç³»çµ±è‡ªå‹•æ±ºå®šä½•æ™‚åˆ‡æ›ã€‚ä½†è‡ªå‹•åˆ‡æ›çš„æ™‚æ©Ÿå¯èƒ½å¾ˆç³Ÿç³•ï¼ˆæ¯”å¦‚æ­£åœ¨ç·Šæ€¥è¶…è»Šæ™‚ï¼‰ï¼Œæ‰€ä»¥æ”¹ç”¨æ‰‹å‹•æª”æ›´å¯æ§ã€‚

#### è¨­å®šæ–¹æ³•

```bash
# æª¢è¦–ç›®å‰å¤§é ç‹€æ…‹
grep Huge /proc/meminfo

# é ç•™ 1024 å€‹ 2MB å¤§é ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰
sudo vim /etc/sysctl.conf
vm.nr_hugepages = 1024

# é—œé–‰é€æ˜å¤§é ï¼ˆTHPï¼‰
# è‡¨æ™‚é—œé–‰
sudo sh -c 'echo never > /sys/kernel/mm/transparent_hugepage/enabled'

# æ°¸ä¹…é—œé–‰ï¼ˆç·¨è¼¯ GRUB è¨­å®šï¼‰
sudo vim /etc/default/grub
transparent_hugepage=never

# æ›´æ–°ä¸¦é‡æ–°å•Ÿå‹•
sudo update-grub
sudo reboot
```

#### ç¨‹å¼ç¢¼å¯¦ä½œ

```cpp
#include <sys/mman.h>
#include <iostream>
#include <cstring>

void* allocateHuge(size_t size) {
    int flags = MAP_PRIVATE | MAP_ANON | MAP_HUGETLB;
    int prot = PROT_READ | PROT_WRITE;
    void* ptr = mmap(nullptr, size, prot, flags, -1, 0);
    return ptr == MAP_FAILED ? nullptr : ptr;
}

int main() {
    const size_t memSize = 2 * 1024 * 1024; // 2MB
    void* lockMem = allocateHuge(memSize);
 
    // é–å®šè¨˜æ†¶é«”
    if (-1 == mlock(lockMem, memSize)) {
        munmap(lockMem, memSize);
        return 1;
    }

    // æ‰‹å‹•è§¸ç™¼ç¼ºé ä¸­æ–·
    memset(lockMem, 0, memSize);

    // ä¿æŒå¸¸é§
    while(true) {
        sleep(1);
    }

    munlock(lockMem, memSize);
    munmap(lockMem, memSize);
    return 0;
}
```

### 4. è³‡æ–™åˆ†ç‰‡è¨­è¨ˆ

#### ç‚ºä»€éº¼éœ€è¦

è¤‡é›œçš„äº¤æ˜“ç­–ç•¥å¯èƒ½åŒæ™‚è™•ç†å¤šç¨®è­‰åˆ¸æˆ–å¤§é‡æ­·å²è³‡æ–™ã€‚è³‡æ–™åˆ†ç‰‡çš„æ ¸å¿ƒæ€æƒ³æ˜¯æ ¹æ“šè³‡æ–™çš„å­˜å–é »ç‡ã€é‡è¦æ€§ä»¥åŠç­–ç•¥é‚è¼¯ï¼Œå°‡ä¸åŒé¡å‹çš„è³‡æ–™çµæ§‹åˆ†é…åˆ°æœ€åˆé©çš„å¯¦é«”è¨˜æ†¶é«”å€åŸŸã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå°±åƒæ•´ç†è¡£æ«ƒï¼ŒæŠŠå¸¸ç©¿çš„è¡£æœæ”¾åœ¨æœ€å®¹æ˜“æ‹¿åˆ°çš„åœ°æ–¹ï¼Œæ›å­£è¡£ç‰©æ”¾åœ¨é«˜è™•ï¼Œå¾ˆå°‘ç©¿çš„æ”¾åœ¨å„²è—å®¤ã€‚äº¤æ˜“ç³»çµ±ä¹Ÿè¦æŠŠæœ€å¸¸ç”¨çš„è³‡æ–™æ”¾åœ¨æœ€å¿«çš„è¨˜æ†¶é«”ä½ç½®ã€‚

#### è¨­å®šæ–¹æ³•

```bash
# æª¢è¦–NUMAç¯€é»åˆ†å¸ƒ
numactl --hardware

# ç‚ºNode0åˆ†é…1024å€‹2MBå¤§é 
echo 1024 > /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages

# ç‚ºNode1åˆ†é…512å€‹1GBå¤§é ï¼ˆè‹¥æ”¯æ´ï¼‰
echo 512 > /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages
```

#### ç¨‹å¼ç¢¼å¯¦ä½œ

```cpp
#include <numa.h>
#include <numaif.h>
#include <sys/mman.h>

void* alloc_hugepage_on_node(int node, size_t size) {
    struct bitmask *nm = numa_allocate_nodemask();
    numa_bitmask_setbit(nm, node);  // æŒ‡å®šç›®æ¨™ç¯€é»
    
    // NUMAæ„ŸçŸ¥çš„å¤§é åˆ†é…
    void* ptr = mmap(NULL, size, PROT_READ|PROT_WRITE,
                     MAP_PRIVATE|MAP_ANONYMOUS|MAP_HUGETLB,
                     -1, 0);
    mbind(ptr, size, MPOL_BIND, nm->maskp, nm->size + 1, 0);
    
    numa_free_nodemask(nm);
    return ptr;
}
```

## å¿«å–æœ€ä½³åŒ–ï¼šé‡‹æ”¾ç¡¬é«”ç®—åŠ›

### 1. å¿«å–éš”é›¢

#### ç‚ºä»€éº¼éœ€è¦

åœ¨ç¾ä»£å¤šæ ¸CPUä¸­ï¼Œæ‰€æœ‰æ ¸å¿ƒå…±äº«æœ«ç´šå¿«å–ï¼ˆé€šå¸¸æ˜¯L3 Cacheï¼‰ã€‚ç•¶å¤šå€‹æ ¸å¿ƒåŒæ™‚é »ç¹å­˜å–L3å¿«å–æ™‚ï¼Œæœƒç™¼ç”Ÿ**å¿«å–çˆ­ç”¨(Cache Contention)**ã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šL3å¿«å–å°±åƒå…¬å¸çš„å…¬å…±èŒ¶æ°´é–“å†°ç®±ï¼Œå¤§å®¶éƒ½åœ¨ç”¨ã€‚å¦‚æœéŠ·å”®éƒ¨é–€æŠŠå†°ç®±å¡æ»¿ä»–å€‘çš„æ±è¥¿ï¼Œç ”ç™¼éƒ¨é–€çš„åˆé¤å°±æ²’åœ°æ–¹æ”¾äº†ã€‚å¿«å–éš”é›¢å°±æ˜¯åŠƒåˆ†å°ˆå±¬å€åŸŸï¼Œã€Œé€™ä¸€å±¤å°ˆé–€çµ¦ç ”ç™¼éƒ¨ï¼Œé‚£ä¸€å±¤çµ¦éŠ·å”®éƒ¨ã€ã€‚

Intelçš„å¿«å–åˆ†é…æŠ€è¡“(CAT)å…è¨±å°‡L3å¿«å–åŠƒåˆ†ç‚ºå¤šå€‹å®¹é‡å¯è¨­å®šçš„å€åŸŸï¼Œä¸¦å°‡ç‰¹å®šçš„CPUæ ¸å¿ƒæˆ–è¡Œç¨‹ç¶å®šåˆ°æŸå€‹å€åŸŸã€‚é€™æ¨£å¯ä»¥ç‚ºé—œéµçš„ä½å»¶é²äº¤æ˜“åŸ·è¡Œç·’åŠƒåˆ†å‡ºä¸€å¡Šå—ä¿è­·çš„ã€Œå°ˆå±¬å¿«å–ç©ºé–“ã€ã€‚

#### è¨­å®šæ–¹æ³•

```bash
# 1. å®‰è£pqoså·¥å…·
sudo apt update
sudo apt install intel-cmt-cat  # å®‰è£ Intel RDT å·¥å…·åŒ…

# 2. é©—è­‰ç¡¬é«”æ”¯æ´
grep -E 'cat_l3' /proc/cpuinfo
pqos -d

# 3. è¨­å®šå¿«å–éš”é›¢ç­–ç•¥
pqos -s  # æª¢è¦–é è¨­è¨­å®š

# å»ºç«‹ COS (Class of Service) å®šç¾©
sudo pqos -e 'llc:1=0xff0'    # COS1ï¼šåˆ†é…ä¸­é–“8ä½å¿«å–
sudo pqos -e 'llc:2=0x00f'    # COS2ï¼šåˆ†é…æœ€ä½4ä½å¿«å–

# 4. ç¶å®šCOS
sudo pqos -a 'llc:1=1234'     # å°‡PID 1234ç¶å®šåˆ°COS1
sudo pqos -a 'llc:2=5678'     # å°‡PID 5678ç¶å®šåˆ°COS2

# 5. å³æ™‚ç›£æ§å¿«å–ä½¿ç”¨
pqos -m all:1                 # æ•´é«”ç›£æ§(æ¯ç§’é‡æ–°æ•´ç†)
pqos -m llc:1 -t 10           # ç›£æ§COS1çš„LLCå ç”¨
```

### 2. è³‡æ–™çµæ§‹å°é½Š

#### ç‚ºä»€éº¼éœ€è¦

CPUå¿«å–æ˜¯ä»¥å¿«å–è¡Œ(Cache Line, é€šå¸¸64ä½å…ƒçµ„)ç‚ºå–®ä½ç®¡ç†çš„ã€‚**å½å…±äº«(False Sharing)**ç™¼ç”Ÿåœ¨å¤šå€‹åŸ·è¡Œç·’é »ç¹è®€å¯«ä½æ–¼åŒä¸€å€‹å¿«å–è¡Œå…§çš„ä¸åŒè®Šæ•¸ã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå¿«å–è¡Œå°±åƒè¾¦å…¬æ¡Œçš„æŠ½å±œï¼Œä¸€æ¬¡åªèƒ½ä¸€å€‹äººé–‹ã€‚å¦‚æœä½ çš„ç­†å’ŒåŒäº‹çš„å°ºéƒ½æ”¾åœ¨åŒä¸€å€‹æŠ½å±œï¼ˆåŒä¸€å¿«å–è¡Œï¼‰ï¼Œä½ å€‘å€†è¦ç”¨æ±è¥¿å°±å¾—è¼ªæµé–‹æŠ½å±œï¼Œæ•ˆç‡å¾ˆä½ã€‚è³‡æ–™å°é½Šå°±æ˜¯ç¢ºä¿æ¯äººçš„æ±è¥¿æ”¾åœ¨å„è‡ªçš„æŠ½å±œè£¡ã€‚

é€éå°‡é«˜é »ä¸¦è¡Œå­˜å–çš„é—œéµè³‡æ–™çµæ§‹æŒ‰å¿«å–è¡Œå¤§å°(64ä½å…ƒçµ„)é€²è¡Œè¨˜æ†¶é«”å°é½Šï¼Œç¢ºä¿å®ƒå€‘ç¨å ä¸€å€‹æˆ–å¤šå€‹å®Œæ•´çš„å¿«å–è¡Œï¼Œå¯ä»¥å¾¹åº•æ¶ˆé™¤å½å…±äº«å¸¶ä¾†çš„æ•ˆèƒ½æè€—ã€‚

#### ç¨‹å¼ç¢¼å¯¦ä½œ

```cpp
struct __attribute__((aligned(64))) MarketData {
    std::atomic<uint64_t> timestamp;
    char payload[32];
};

// é©—è­‰å°é½Š
static_assert(offsetof(MarketData, timestamp) % 64 == 0, "æœªå°é½Š");
```

### 3. SIMDæŒ‡ä»¤åŠ é€Ÿ

#### ç‚ºä»€éº¼éœ€è¦

é«˜é »äº¤æ˜“ç­–ç•¥å¸¸å¸¸éœ€è¦å°å¤§é‡è³‡æ–™é€²è¡Œç›¸åŒçš„ç®—è¡“æˆ–é‚è¼¯é‹ç®—ã€‚å–®æŒ‡ä»¤å¤šè³‡æ–™æµ(SIMD)æŒ‡ä»¤å…è¨±ä¸€æ¢æŒ‡ä»¤åŒæ™‚è™•ç†å¤šå€‹è³‡æ–™å…ƒç´ ã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šæ™®é€šæŒ‡ä»¤å°±åƒä¸€æ¬¡åªèƒ½è“‹ä¸€å€‹ç« ï¼ŒSIMDå°±åƒä¸€æ’8å€‹ç« åŒæ™‚è“‹ä¸‹å»ã€‚è™•ç†å¤§é‡ç›¸åŒé‹ç®—æ™‚æ•ˆç‡å¤§å¹…æå‡ã€‚æ¯”å¦‚åŒæ™‚è¨ˆç®—8æ”¯è‚¡ç¥¨çš„å‡åƒ¹ï¼Œä¸€æ¢SIMDæŒ‡ä»¤æå®šã€‚

#### ç¨‹å¼ç¢¼ç¯„ä¾‹

```cpp
__m512 parse_bid_ask(const float* data) {
    __m512 bid = _mm512_load_ps(data);
    __m512 ask = _mm512_load_ps(data + 16);
    return _mm512_sub_ps(ask, bid);  // è¨ˆç®—åƒ¹å·®
}
```

## èª¿æ ¡å„ªå…ˆç´šç­–ç•¥

æœ€ä½³åŒ–æªæ–½çš„å¯¦æ–½æ‡‰éµå¾ªå„ªå…ˆç´šåŸå‰‡ï¼Œå„ªå…ˆè§£æ±ºå½±éŸ¿æœ€å¤§ã€æœ€åŸºç¤çš„éç¢ºå®šæ€§å•é¡Œï¼š

| å„ªå…ˆç´š | æŠ€è¡“æ–¹å‘ | æ ¸å¿ƒåƒ¹å€¼ | é—œéµæ‰‹æ®µç¯„ä¾‹ |
|--------|----------|----------|--------------|
| 1 | **æ ¸å¿ƒéš”é›¢** | æ¶ˆé™¤ä½œæ¥­ç³»çµ±æ’ç¨‹èˆ‡ç¡¬é«”ä¸­æ–·å¸¶ä¾†çš„ä¸ç¢ºå®šæ€§ï¼Œç‚ºå¥ˆç§’ç´šç²¾åº¦å¥ å®šåŸºç¤ | isolcpuséš”é›¢æ ¸ã€ä¸­æ–·é‡å®šå‘ã€CPU Pinning |
| 2 | **NUMAè¨˜æ†¶é«”æœ€ä½³åŒ–** | è§£æ±ºè·¨ç¯€é»è¨˜æ†¶é«”å­˜å–å»¶é²ç¿»å€å•é¡Œï¼Œå°‡è¨˜æ†¶é«”å­˜å–ç´„æŸåœ¨æœ¬åœ°NUMAç¯€é» | numactlç¶æ ¸ç¶å­˜ã€å¤§é è¨˜æ†¶é«”(HugePage)ã€è¨˜æ†¶é«”é–å®š(mlock) |
| 3 | **å¿«å–æ§åˆ¶** | é¿å…å…±äº«å¿«å–çˆ­ç”¨å°è‡´çš„å¾®ç§’ç´šæŠ–å‹•ï¼Œæå‡è¨ˆç®—ç¢ºå®šæ€§ | CATå¿«å–éš”é›¢ã€è³‡æ–™çµæ§‹å°é½Šæ¶ˆé™¤å½å…±äº«ã€SIMDæŒ‡ä»¤å‘é‡åŒ– |

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå°±åƒè“‹æˆ¿å­ï¼Œå…ˆæ‰“åœ°åŸºï¼ˆæ ¸å¿ƒéš”é›¢ï¼‰ï¼Œå†å»ºä¸»é«”çµæ§‹ï¼ˆè¨˜æ†¶é«”æœ€ä½³åŒ–ï¼‰ï¼Œæœ€å¾Œæ‰æ˜¯ç²¾è£ä¿®ï¼ˆå¿«å–æ§åˆ¶ï¼‰ã€‚é †åºå¾ˆé‡è¦ï¼

## é—œéµçµè«–

åœ¨è¿½æ±‚å¥ˆç§’ç´šç«¶çˆ­å„ªå‹¢çš„é«˜é »äº¤æ˜“é ˜åŸŸï¼Œä½œæ¥­ç³»çµ±çš„é è¨­è¡Œç‚ºå¾€å¾€æ˜¯å»¶é²ä¸ç¢ºå®šæ€§çš„ä¸»è¦ä¾†æºã€‚é€éæœ¬æ–‡è©³è¿°çš„ç³»çµ±æ€§èª¿æ ¡å¯¦è¸ï¼š

- å¾æ ¸å¿ƒéš”é›¢æ¶ˆé™¤æ’ç¨‹å¹²æ“¾
- åˆ°NUMAç¶å®šæœ€ä½³åŒ–è¨˜æ†¶é«”ä½ç½®
- å†åˆ°è¨˜æ†¶é«”é–å®š/é å–/å¤§é æ¶ˆé™¤ç¼ºé åœé “
- æœ€å¾Œé€éå¿«å–éš”é›¢å’Œè³‡æ–™çµæ§‹æœ€ä½³åŒ–æ¸›å°‘æ ¸å¿ƒé–“å¹²æ“¾

æˆ‘å€‘èƒ½å¤ å°‡é—œéµäº¤æ˜“è·¯å¾‘çš„å»¶é²**ç©©å®šåœ°å£“ç¸®åˆ°20å¾®ç§’(Î¼s)ä»¥å…§**ï¼Œä¸¦å°‡å…¶æ³¢å‹•ç¯„åœ(**Jitter**)æ§åˆ¶åœ¨**Â±1å¾®ç§’(Î¼s)**çš„ç‹¹çª„å€é–“ã€‚é€™ç¨®**é«˜åº¦ç¢ºå®šçš„å¾®ç§’ç´šå›æ‡‰èƒ½åŠ›**æ˜¯ç­–ç•¥ç©©å®šç²åˆ©çš„åŸºç¤è¨­æ–½ä¿éšœã€‚

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šç¶“éé€™äº›å„ªåŒ–å¾Œï¼Œç³»çµ±å°±åƒä¸€è¼›ç²¾å¿ƒèª¿æ ¡çš„F1è³½è»Šï¼Œä¸åƒ…è·‘å¾—å¿«ï¼Œè€Œä¸”æ¯åœˆæ™‚é–“éƒ½æ¥µå…¶ç©©å®šã€‚åœ¨é«˜é »äº¤æ˜“çš„è³½é“ä¸Šï¼Œé€™ç¨®ç©©å®šæ€§å’Œé€Ÿåº¦å°±æ˜¯è‡´å‹é—œéµã€‚

## ä¸‹ä¸€å¾ç¨‹ï¼šæ ¸å¿ƒæ—è·¯(Kernel Bypass)

å„˜ç®¡ç³»çµ±å±¤æœ€ä½³åŒ–å·²å°‡å»¶é²å£“ç¸®è‡³å¾®ç§’ç´šï¼Œ**ç¶²è·¯I/Oè™•ç†ä»ç„¶æ˜¯æœ€å¾Œçš„ã€ä¹Ÿæ˜¯æœ€å …å›ºçš„æ•ˆèƒ½å£å£˜**ã€‚å‚³çµ±æ ¸å¿ƒç¶²è·¯å”å®šå †ç–Šåœ¨è™•ç†é«˜é€Ÿç¶²è·¯å°åŒ…æ™‚å­˜åœ¨å›ºæœ‰ç“¶é ¸ï¼š

- **å”å®šå †ç–Šè™•ç†è€—æ™‚ >10Î¼s**ï¼šå°åŒ…éœ€è¦ç©¿è¶Šè¤‡é›œçš„å”å®šå±¤
- **å¤šæ¬¡è³‡æ–™æ‹·è²**ï¼šè³‡æ–™å¾ç¶²å¡DMAå€åŸŸæ‹·è²åˆ°æ ¸å¿ƒSocket Bufferï¼Œå†å¾æ ¸å¿ƒæ‹·è²åˆ°ä½¿ç”¨è€…ç©ºé–“
- **TCPé‡å‚³å¼•å…¥ä¸ç¢ºå®šæ€§**ï¼šæ ¸å¿ƒçš„æ“å¡æ§åˆ¶å’Œé‡å‚³æ©Ÿåˆ¶å¯èƒ½å¼•å…¥éé æœŸçš„å»¶é²

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼šå‚³çµ±ç¶²è·¯è™•ç†å°±åƒå¿«éå¿…é ˆç¶“ééƒµå±€ï¼šæ”¶ä»¶â†’åˆ†æ€â†’æ´¾é€ï¼Œæ¯å€‹ç’°ç¯€éƒ½è¦æ’éšŠã€‚æ ¸å¿ƒæ—è·¯æŠ€è¡“å°±åƒå¿«éå“¡ç›´æ¥æŠŠåŒ…è£¹é€åˆ°ä½ æ‰‹ä¸Šï¼Œè·³éæ‰€æœ‰ä¸­é–“ç’°ç¯€ã€‚

### DPDK ç¹éå…§æ ¸çš„ä¸»è¦å¥½è™•

DPDK (Data Plane Development Kit) é€éç¹éå…§æ ¸ç›´æ¥è™•ç†æ•¸æ“šåŒ…ï¼Œå¸¶ä¾†é©å‘½æ€§çš„æ€§èƒ½æå‡ï¼š

#### æ€§èƒ½å¤§å¹…æå‡
- **æ¶ˆé™¤å…§æ ¸é–‹éŠ·**ï¼šé¿å…äº†ç”¨æˆ¶ç©ºé–“å’Œå…§æ ¸ç©ºé–“ä¹‹é–“çš„ä¸Šä¸‹æ–‡åˆ‡æ›ï¼ˆcontext switchï¼‰ï¼Œæ¯æ¬¡åˆ‡æ›å¯èƒ½è€—è²»æ•¸åƒå€‹ CPU é€±æœŸ
- **é›¶æ‹·è²æŠ€è¡“**ï¼šæ•¸æ“šåŒ…ç›´æ¥å¾ç¶²å¡ DMA åˆ°ç”¨æˆ¶ç©ºé–“å…§å­˜ï¼Œçœå»äº†å‚³çµ±ç¶²è·¯å †ç–Šä¸­å¤šæ¬¡å…§å­˜æ‹·è²çš„é–‹éŠ·
- **ç·šé€Ÿè™•ç†**ï¼šå¯ä»¥é”åˆ°æ¥è¿‘ç¶²å¡ç¡¬é«”æ¥µé™çš„è™•ç†é€Ÿåº¦ï¼Œå¦‚ 10Gbpsã€40Gbps ç”šè‡³ 100Gbps çš„ç·šé€Ÿè½‰ç™¼

#### ç¢ºå®šæ€§å’Œä½å»¶é²
- **å¯é æ¸¬çš„å»¶é²**ï¼šç¹éå…§æ ¸èª¿åº¦å™¨ï¼Œé¿å…äº†ä¸å¯é æ¸¬çš„ä¸­æ–·å’Œèª¿åº¦å»¶é²
- **æ¥µä½å»¶é²**ï¼šç«¯åˆ°ç«¯å»¶é²å¯ä»¥é™åˆ°å¾®ç§’ç´šåˆ¥ï¼Œå°é‡‘èäº¤æ˜“ã€5G ç¶²è·¯ç­‰ä½å»¶é²å ´æ™¯è‡³é—œé‡è¦
- **CPU è¦ªå’Œæ€§**ï¼šå¯ä»¥å°‡ç‰¹å®š CPU æ ¸å¿ƒå°ˆé–€ç”¨æ–¼æ•¸æ“šåŒ…è™•ç†ï¼Œé¿å… CPU å¿«å–å¤±æ•ˆ

#### éˆæ´»æ€§å’Œå¯æ§æ€§
- **å®Œå…¨æ§åˆ¶æ•¸æ“šè·¯å¾‘**ï¼šé–‹ç™¼è€…å¯ä»¥æ ¹æ“šå…·é«”éœ€æ±‚å„ªåŒ–æ¯å€‹è™•ç†æ­¥é©Ÿ
- **æ‰¹é‡è™•ç†**ï¼šå¯ä»¥ä¸€æ¬¡è™•ç†å¤šå€‹æ•¸æ“šåŒ…ï¼Œæé«˜ CPU å¿«å–åˆ©ç”¨ç‡
- **è¼ªè©¢æ¨¡å¼**ï¼šä½¿ç”¨è¼ªè©¢ï¼ˆpollingï¼‰æ›¿ä»£ä¸­æ–·ï¼Œåœ¨é«˜è² è¼‰ä¸‹æ•ˆç‡æ›´é«˜

#### è³‡æºæ•ˆç‡
- **æ›´å°‘çš„ CPU ä½¿ç”¨**ï¼šç›¸åŒååé‡ä¸‹ï¼ŒDPDK é€šå¸¸æ¯”å‚³çµ±å…§æ ¸ç¶²è·¯å †ç–Šä½¿ç”¨æ›´å°‘çš„ CPU è³‡æº
- **æ›´å¥½çš„æ“´å±•æ€§**ï¼šå¯ä»¥è¿‘ä¹ç·šæ€§åœ°éš¨ CPU æ ¸å¿ƒæ•¸å¢åŠ è€Œæ“´å±•æ€§èƒ½

> ğŸ’¡ **ç™½è©±è§£é‡‹**ï¼š
> - **å‚³çµ±æ–¹å¼**ï¼šåƒæ’éšŠè²·ç¥¨ï¼Œè¦ç¶“éæª¢ç¥¨å“¡ï¼ˆå…§æ ¸ï¼‰æ‰èƒ½é€²å ´
> - **DPDKæ–¹å¼**ï¼šåƒVIPé€šé“ï¼Œç›´æ¥åˆ·è‡‰é€²å ´ï¼Œè·³éæ‰€æœ‰æ’éšŠç’°ç¯€
> - åœ¨é«˜é »äº¤æ˜“ä¸­ï¼Œé€™ç¨®å·®ç•°å°±æ˜¯è³ºéŒ¢èˆ‡è³ éŒ¢çš„åˆ†æ°´å¶º

é€™äº›å„ªå‹¢ä½¿ DPDK æˆç‚ºé›»ä¿¡è¨­å‚™ã€é«˜é »äº¤æ˜“ç³»çµ±ã€DDoS é˜²è­·ã€è² è¼‰å‡è¡¡å™¨ç­‰é«˜æ€§èƒ½ç¶²è·¯æ‡‰ç”¨çš„é¦–é¸æŠ€è¡“ã€‚

ç‚ºäº†å°‡ç«¯åˆ°ç«¯å»¶é²é€²ä¸€æ­¥æ¨å‘äºå¾®ç§’ç´šç”šè‡³å¥ˆç§’ç´šï¼Œå¿…é ˆç¹éæ ¸å¿ƒå”å®šå †ç–Šã€‚ä¸‹ç¯‡ã€Šæ ¸å¿ƒæ—è·¯æŠ€è¡“å¯¦è¸ã€‹å°‡æ·±å…¥æ¢è¨å¦‚ä½•åˆ©ç”¨**DPDK**ã€**Solarflare**ç­‰æŠ€è¡“ï¼Œå°‡ä½¿ç”¨è€…æ…‹æ‡‰ç”¨ç›´æ¥èˆ‡ç¶²å¡ç¡¬é«”å°æ¥ï¼Œå¯¦ç¾é›¶æ‹·è²(Zero-Copy)ã€è¼ªè©¢æ¨¡å¼é©…å‹•(Polling Mode Driver)å’Œä½¿ç”¨è€…æ…‹å”å®šå †ç–Šï¼Œå°‡ç¶²è·¯è™•ç†å»¶é²é™ä½ä¸€å€‹æ•¸é‡ç´šï¼ˆé€šå¸¸é™è‡³1Î¼sä»¥ä¸‹ï¼‰ï¼Œçªç ´æ ¸å¿ƒç“¶é ¸ï¼Œå¯¦ç¾çœŸæ­£çš„å¥ˆç§’ç´šäº¤æ˜“ç³»çµ±ã€‚

---

*åŸæ–‡é€£çµï¼šhttps://zhuanlan.zhihu.com/p/1936428978639467459*

## æ•ˆèƒ½æ¸¬è©¦å·¥å…·èˆ‡ç¯„ä¾‹

æœ¬ç¯€ä»‹ç´¹ç”¨æ–¼é©—è­‰å’Œé‡åŒ–HFTç³»çµ±å„ªåŒ–æ•ˆæœçš„æ¸¬è©¦å·¥å…·èˆ‡æ–¹æ³•ã€‚

### 1. å»¶é²æ¸¬è©¦å·¥å…·

#### cyclictest (å¯¦æ™‚å»¶é²æ¸¬è©¦)
```bash
# å®‰è£
sudo apt-get install rt-tests

# æ¸¬è©¦ç³»çµ±å»¶é²æŠ–å‹•
sudo cyclictest -p 99 -t 1 -n -i 1000 -l 100000 -h 1000 -q
# -p 99: å„ªå…ˆç´š99
# -t 1: å–®åŸ·è¡Œç·’
# -n: ä½¿ç”¨nanosleep
# -i 1000: é–“éš”1000us
# -l 100000: åŸ·è¡Œ100000æ¬¡
# -h 1000: ç›´æ–¹åœ–æœ€å¤§å€¼1000us
```

#### è‡ªè£½å»¶é²æ¸¬è©¦ç¨‹å¼
```cpp
#include <chrono>
#include <vector>
#include <algorithm>
#include <iostream>

void measure_latency() {
    const int iterations = 1000000;
    std::vector<long> latencies;
    
    for(int i = 0; i < iterations; i++) {
        auto start = std::chrono::high_resolution_clock::now();
        // ä½ çš„äº¤æ˜“é‚è¼¯
        auto end = std::chrono::high_resolution_clock::now();
        
        auto latency = std::chrono::duration_cast<std::chrono::nanoseconds>
                      (end - start).count();
        latencies.push_back(latency);
    }
    
    // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
    std::sort(latencies.begin(), latencies.end());
    long p50 = latencies[iterations * 0.50];
    long p99 = latencies[iterations * 0.99];
    long p999 = latencies[iterations * 0.999];
    
    std::cout << "P50: " << p50 << "ns\n";
    std::cout << "P99: " << p99 << "ns\n";
    std::cout << "P99.9: " << p999 << "ns\n";
}
```

### 2. CPU å’Œä¸­æ–·ç›£æ§

#### perf (ç³»çµ±æ•ˆèƒ½åˆ†æ)
```bash
# å®‰è£
sudo apt-get install linux-tools-common linux-tools-generic

# ç›£æ§CPUäº‹ä»¶
sudo perf stat -C 8-15 ./strategy_engine

# åˆ†æå¿«å–å‘½ä¸­ç‡
sudo perf stat -e cache-references,cache-misses ./strategy_engine

# ç›£æ§ä¸Šä¸‹æ–‡åˆ‡æ›
sudo perf stat -e context-switches,cpu-migrations ./strategy_engine
```

#### ç›£æ§ä¸­æ–·
```bash
# å³æ™‚ç›£æ§ä¸­æ–·åˆ†å¸ƒ
watch -n 1 'cat /proc/interrupts | grep eth0'

# æª¢æŸ¥CPUè¦ªå’Œæ€§
for i in /proc/irq/*/smp_affinity; do 
    echo "$i: $(cat $i)"
done
```

### 3. è¨˜æ†¶é«”å’ŒNUMAæ¸¬è©¦

#### numactl æ¸¬è©¦
```bash
# æ¸¬è©¦NUMAå»¶é²å·®ç•°
numactl --hardware  # æª¢è¦–NUMAæ‹“æ’²

# æ¸¬è©¦æœ¬åœ°vsé ç«¯è¨˜æ†¶é«”å»¶é²
# æœ¬åœ°ç¯€é»
numactl --cpunodebind=0 --membind=0 ./memory_test

# é ç«¯ç¯€é»
numactl --cpunodebind=0 --membind=1 ./memory_test
```

#### è¨˜æ†¶é«”å»¶é²æ¸¬è©¦ç¨‹å¼
```cpp
#include <numa.h>
#include <chrono>
#include <iostream>

void test_memory_latency() {
    const size_t size = 1024 * 1024 * 100; // 100MB
    
    // æ¸¬è©¦æœ¬åœ°è¨˜æ†¶é«”
    numa_set_localalloc();
    void* local_mem = numa_alloc_local(size);
    
    auto start = std::chrono::high_resolution_clock::now();
    for(int i = 0; i < 1000000; i++) {
        volatile int* p = (int*)local_mem;
        *p = i;  // å¯«å…¥
        int val = *p;  // è®€å–
    }
    auto end = std::chrono::high_resolution_clock::now();
    
    auto local_time = std::chrono::duration_cast<std::chrono::nanoseconds>
                     (end - start).count();
    
    std::cout << "Local memory latency: " << local_time/1000000 << "ns\n";
    
    numa_free(local_mem, size);
}
```

### 4. å¿«å–æ•ˆèƒ½æ¸¬è©¦

#### Intel PCM (å¿«å–ç›£æ§)
```bash
# ä¸‹è¼‰å®‰è£
git clone https://github.com/intel/pcm.git
cd pcm && make

# ç›£æ§å¿«å–ä½¿ç”¨
sudo ./pcm 1  # æ¯ç§’æ›´æ–°

# ç›£æ§è¨˜æ†¶é«”é »å¯¬
sudo ./pcm-memory 1
```

#### pqos (å¿«å–éš”é›¢ç›£æ§)
```bash
# ç›£æ§L3å¿«å–
sudo pqos -m llc:1  # ç›£æ§LLCä½¿ç”¨

# æ¸¬è©¦å¿«å–éš”é›¢æ•ˆæœ
# éš”é›¢å‰
sudo pqos -m all:1 -t 10

# è¨­å®šéš”é›¢
sudo pqos -e 'llc:1=0xff0'  # åˆ†é…å¿«å–
sudo pqos -a 'llc:1=1234'   # ç¶å®šPID

# éš”é›¢å¾Œ
sudo pqos -m all:1 -t 10
```

### 5. ç¶²è·¯å»¶é²æ¸¬è©¦

#### sockperf (Socketæ•ˆèƒ½æ¸¬è©¦)
```bash
# å®‰è£
git clone https://github.com/Mellanox/sockperf.git
cd sockperf && ./autogen.sh && ./configure && make

# Serverç«¯
./sockperf server -i 192.168.1.100 -p 12345

# Clientç«¯æ¸¬è©¦å»¶é²
./sockperf ping-pong -i 192.168.1.100 -p 12345 -t 60
```

#### ç¶²è·¯ä¸­æ–·æ¸¬è©¦
```bash
# æª¢æŸ¥ç¶²å¡ä¸­æ–·åˆä½µè¨­å®š
ethtool -c eth0

# é—œé–‰ä¸­æ–·åˆä½µä»¥é™ä½å»¶é²
sudo ethtool -C eth0 rx-usecs 0 tx-usecs 0

# æ¸¬è©¦å‰å¾Œå»¶é²å·®ç•°
ping -c 1000 -i 0.001 192.168.1.100 | tail -n 3
```

### 6. æ•´åˆæ¸¬è©¦è…³æœ¬

```bash
#!/bin/bash
# performance_test.sh

echo "=== HFT System Performance Test ==="

# 1. æª¢æŸ¥ç³»çµ±è¨­å®š
echo "1. System Configuration:"
echo "CPU Isolation: $(cat /proc/cmdline | grep isolcpus)"
echo "Huge Pages: $(grep HugePages_Total /proc/meminfo)"
echo "CPU Frequency: $(cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor | uniq)"

# 2. æ¸¬è©¦CPUå»¶é²
echo -e "\n2. CPU Latency Test:"
sudo cyclictest -p 99 -t 1 -n -i 1000 -l 10000 -h 100 -q | tail -n 10

# 3. æ¸¬è©¦è¨˜æ†¶é«”å»¶é²
echo -e "\n3. Memory Latency:"
sudo numactl --hardware | grep "node distances"

# 4. æ¸¬è©¦å¿«å–
echo -e "\n4. Cache Performance:"
sudo perf stat -e cache-references,cache-misses sleep 1 2>&1 | grep cache

# 5. æ¸¬è©¦ç¶²è·¯
echo -e "\n5. Network Latency:"
ping -c 100 -i 0.001 localhost | tail -n 3

echo -e "\n=== Test Complete ==="
```

### 7. æ•ˆèƒ½æ¯”è¼ƒåŸºæº–

å„ªåŒ–å‰å¾Œçš„å…¸å‹æ•¸å€¼å°æ¯”ï¼š

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ¸¬è©¦å·¥å…· |
|------|--------|--------|----------|
| CPUå»¶é²æŠ–å‹• | Â±50Î¼s | Â±1Î¼s | cyclictest |
| å¹³å‡å»¶é² | 100Î¼s | <20Î¼s | è‡ªè£½æ¸¬è©¦ç¨‹å¼ |
| å¿«å–å‘½ä¸­ç‡ | 85% | >98% | perf stat |
| NUMAé ç«¯å­˜å– | +50% | 0% | numactl |
| ç¶²è·¯RTT | 50Î¼s | <10Î¼s | sockperf |
| ä¸Šä¸‹æ–‡åˆ‡æ› | >1000/s | <100/s | perf stat |

> ğŸ’¡ **æ¸¬è©¦å»ºè­°**ï¼š
> 1. æŒ‰å„ªå…ˆç´šé€æ­¥æ¸¬è©¦ï¼šå…ˆæ¸¬åŸºæº–ç·šï¼Œå†é€é …å„ªåŒ–ä¸¦æ¸¬è©¦
> 2. æ¯æ¬¡åªæ”¹è®Šä¸€å€‹è®Šæ•¸ï¼Œä»¥ç¢ºå®šå„ªåŒ–æ•ˆæœä¾†æº
> 3. ä½¿ç”¨è‡ªå‹•åŒ–è…³æœ¬å®šæœŸæ¸¬è©¦ï¼Œç›£æ§ç³»çµ±æ•ˆèƒ½é€€åŒ–
> 4. åœ¨å¯¦éš›äº¤æ˜“æ™‚æ®µæ¸¬è©¦ï¼Œæ¨¡æ“¬çœŸå¯¦è² è¼‰æƒ…æ³

é€™äº›å·¥å…·èƒ½å¹«ä½ é‡åŒ–å„ªåŒ–æ•ˆæœï¼Œæ‰¾å‡ºç³»çµ±ç“¶é ¸ï¼Œä¸¦é©—è­‰æ¯é …å„ªåŒ–æªæ–½çš„å¯¦éš›æ”¶ç›Šã€‚

## é™„éŒ„ï¼šå¸¸ç”¨è¡“èªå¿«é€ŸæŸ¥è©¢

| è¡“èª | å…¨ç¨± | ç™½è©±è§£é‡‹ |
|------|------|----------|
| HFT | High-Frequency Trading | é«˜é »äº¤æ˜“ï¼Œä»¥æ¥µå¿«é€Ÿåº¦é€²è¡Œå¤§é‡äº¤æ˜“ |
| CFS | Completely Fair Scheduler | Linuxçš„å…¬å¹³æ’ç¨‹å™¨ï¼Œåƒè€å¸«å…¬å¹³åˆ†é…èªªè©±æ™‚é–“ |
| IRQ | Interrupt Request | ä¸­æ–·è«‹æ±‚ï¼Œåƒé–€éˆ´é€šçŸ¥CPUæœ‰ç·Šæ€¥äº‹ä»¶ |
| NUMA | Non-Uniform Memory Access | éçµ±ä¸€è¨˜æ†¶é«”å­˜å–ï¼Œåƒå¤šå€‹è¾¦å…¬å®¤å„æœ‰æª”æ¡ˆæ«ƒ |
| TLB | Translation Lookaside Buffer | åœ°å€è½‰æ›ç·©è¡ï¼Œåƒé€šè¨ŠéŒ„å¿«é€ŸæŸ¥è©¢ |
| Cache Line | - | å¿«å–è¡Œï¼ŒCPUå¿«å–çš„æœ€å°å–®ä½ï¼ŒåƒæŠ½å±œæ ¼å­ |
| False Sharing | - | å½å…±äº«ï¼Œä¸åŒè³‡æ–™æ“ åœ¨åŒä¸€å¿«å–è¡Œé€ æˆè¡çª |
| Page Fault | - | ç¼ºé ä¸­æ–·ï¼Œè¦ç”¨çš„è¨˜æ†¶é«”é ä¸åœ¨RAMä¸­ |
| Jitter | - | æŠ–å‹•ï¼Œå»¶é²çš„ä¸ç©©å®šç¨‹åº¦ |
| SIMD | Single Instruction Multiple Data | å–®æŒ‡ä»¤å¤šè³‡æ–™ï¼Œä¸€å€‹æŒ‡ä»¤è™•ç†å¤šå€‹è³‡æ–™ |
| DPDK | Data Plane Development Kit | è³‡æ–™å¹³é¢é–‹ç™¼å¥—ä»¶ï¼Œç¹éæ ¸å¿ƒç›´æ¥è™•ç†ç¶²è·¯ |

