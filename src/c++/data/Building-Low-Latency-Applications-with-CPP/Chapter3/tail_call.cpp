// âœ… å°¾éè¿´å„ªåŒ–ï¼ˆTail Call Optimizationï¼‰ï¼šç·¨è­¯å™¨å¯å°‡éè¿´è½‰æ›ç‚ºè¿´åœˆ
// âš¡ æ•ˆèƒ½é—œéµï¼šæ£§ç©ºé–“å¾ O(n) é™ç‚º O(1)ï¼Œé¿å…æ£§æº¢ä½
// åŸç†ï¼šå‡½å¼çš„æœ€å¾Œä¸€å€‹æ“ä½œæ˜¯å‘¼å«è‡ªå·±ï¼Œç„¡éœ€ä¿ç•™ç•¶å‰æ£§å¹€
// æ³¨æ„ï¼š__attribute__((noinline)) ç¦æ­¢å…§è¯ï¼Œä½†ä»å…è¨± TCO
//
// ğŸ“ å°¾éè¿´ç‰¹å¾µï¼š
//    1. éè¿´å‘¼å«æ˜¯å‡½å¼çš„æœ€å¾Œä¸€å€‹æ“ä½œï¼ˆç„¡å¾ŒçºŒè¨ˆç®—ï¼‰
//    2. ç·¨è­¯å™¨å¯å°‡ CALL æŒ‡ä»¤å„ªåŒ–ç‚º JMP æŒ‡ä»¤ï¼ˆç­‰åƒ¹æ–¼è¿´åœˆï¼‰
//    3. ç•¶å‰æ£§å¹€å¯ç«‹å³é‡‹æ”¾ï¼Œä¸éœ€ç­‰å¾…éè¿´è¿”å›
//
// ğŸ¯ é—œéµå¯¦ä½œï¼šä½¿ç”¨ç´¯åŠ å™¨åƒæ•¸ï¼ˆaccï¼‰åœ¨éè¿´éç¨‹ä¸­ç´¯ç©çµæœ
//    - éå°¾éè¿´ï¼šfactorial(5) = 5 * factorial(4) = 5 * (4 * factorial(3)) ...
//    - å°¾éè¿´ï¼šfactorial(5, 1) = factorial(4, 5) = factorial(3, 20) = ...
auto __attribute__ ((noinline)) factorial(unsigned n, unsigned acc = 1) -> unsigned
{
    // éè¿´çµ‚æ­¢æ¢ä»¶ï¼šè¿”å›ç´¯ç©çµæœ
    if (n == 0) return acc;

    // âœ… çœŸæ­£çš„å°¾éè¿´ï¼šæœ€å¾Œä¸€å€‹æ“ä½œå°±æ˜¯éè¿´å‘¼å«ï¼ˆç„¡éœ€ç­‰å¾…è¿”å›å€¼å†è¨ˆç®—ï¼‰
    // ç·¨è­¯å™¨å¯å„ªåŒ–ç‚ºï¼š
    //   loop:
    //     if (n == 0) return acc;
    //     acc = n * acc;
    //     n = n - 1;
    //     goto loop;
    return factorial(n - 1, n * acc);
}

int main()
{
    // ä½¿ç”¨ volatile é˜²æ­¢ç·¨è­¯å™¨åœ¨ç·¨è­¯æœŸè¨ˆç®—çµæœ
    [[maybe_unused]] volatile auto res = factorial(100);
}