// ============================================================================
// ä½å»¶é²ç·¨ç¨‹æ ¸å¿ƒå·¨é›† (Low-Latency Core Macros)
// ============================================================================

#pragma once

#include <cstring>
#include <iostream>

// ============================================================================
// LIKELY/UNLIKELY: åˆ†æ”¯é æ¸¬æç¤ºå·¨é›†
// ============================================================================
// åŸç†ï¼š
// - ä½¿ç”¨ GCC/Clang å…§å»ºå‡½å¼ __builtin_expect() æç¤ºç·¨è­¯å™¨åˆ†æ”¯æ©Ÿç‡
// - ç·¨è­¯å™¨æœƒå°‡ã€Œå¯èƒ½ã€åŸ·è¡Œçš„ç¨‹å¼ç¢¼æ”¾åœ¨ä¸»åŸ·è¡Œè·¯å¾‘ï¼ˆæ¸›å°‘è·³è½‰ï¼‰
// - å°‡ã€Œä¸å¯èƒ½ã€åŸ·è¡Œçš„ç¨‹å¼ç¢¼æ”¾åœ¨å†·è·¯å¾‘ï¼ˆCold Pathï¼‰
//
// ä½¿ç”¨å ´æ™¯ï¼š
// - LIKELYï¼šæ­£å¸¸æµç¨‹ï¼ˆä¾‹å¦‚ï¼šè¨‚å–®é©—è­‰é€šéã€ç¶²è·¯é€£ç·šæˆåŠŸï¼‰
// - UNLIKELYï¼šç•°å¸¸è™•ç†ï¼ˆä¾‹å¦‚ï¼šéŒ¯èª¤æª¢æŸ¥ã€é‚Šç•Œæ¢ä»¶ã€assert å¤±æ•—ï¼‰
//
// ğŸ“Š æ•ˆèƒ½å½±éŸ¿ï¼š
// - CPU åˆ†æ”¯é æ¸¬æ­£ç¢ºï¼š0 å€‹ cycleï¼ˆæµæ°´ç·šä¸ä¸­æ–·ï¼‰
// - CPU åˆ†æ”¯é æ¸¬éŒ¯èª¤ï¼š10-20 å€‹ cycleï¼ˆéœ€æ¸…ç©ºæµæ°´ç·šï¼‰
// - ä½¿ç”¨æç¤ºå¯å°‡é æ¸¬æº–ç¢ºç‡å¾ ~50% æå‡åˆ° ~95%
//
// ç¯„ä¾‹ï¼š
// if (LIKELY(order.qty > 0)) { /* ä¸»æµç¨‹ */ }
// if (UNLIKELY(order.qty <= 0)) { /* éŒ¯èª¤è™•ç† */ }
#define LIKELY(x) __builtin_expect(!!(x), 1)
#define UNLIKELY(x) __builtin_expect(!!(x), 0)

// ============================================================================
// ASSERT: åŸ·è¡ŒæœŸæ–·è¨€æª¢æŸ¥
// ============================================================================
// èˆ‡æ¨™æº– assert() çš„å·®ç•°ï¼š
// - assert()ï¼šåƒ…åœ¨ Debug æ¨¡å¼å•Ÿç”¨ï¼ˆå®šç¾© NDEBUG æœƒåœç”¨ï¼‰
// - ASSERT()ï¼šæ°¸é å•Ÿç”¨ï¼ˆå³ä½¿ Release ä¹Ÿæª¢æŸ¥ï¼‰
//
// ä½¿ç”¨æ™‚æ©Ÿï¼š
// - é—œéµä¸è®Šé‡ï¼ˆInvariantï¼‰æª¢æŸ¥ï¼ˆä¾‹å¦‚ï¼šæŒ‡æ¨™éç©ºã€ç´¢å¼•ç¯„åœï¼‰
// - çµ•å°ä¸èƒ½é•åçš„å‰ç½®æ¢ä»¶ï¼ˆPreconditionï¼‰
//
// âš ï¸ æ•ˆèƒ½è€ƒé‡ï¼š
// - ä½¿ç”¨ UNLIKELY å„ªåŒ–ï¼šå‡è¨­æ–·è¨€æª¢æŸ¥é€šå¸¸ç‚ºçœŸ
// - è‹¥æ–·è¨€å¤±æ•—ï¼Œç¨‹å¼ç«‹å³çµ‚æ­¢ï¼ˆexit(EXIT_FAILURE)ï¼‰
// - ä¸æ‡‰åœ¨ç†±è·¯å¾‘ï¼ˆHot Pathï¼‰ä¸­ä½¿ç”¨è¤‡é›œçš„æ–·è¨€æª¢æŸ¥
//
// ç¯„ä¾‹ï¼š
// ASSERT(ptr != nullptr, "Null pointer detected");
// ASSERT(index < size, "Index out of bounds");
inline auto ASSERT(bool cond, const std::string& msg) noexcept
{
    if (UNLIKELY(!cond)) {
        std::cerr << "ASSERT : " << msg << std::endl;

        exit(EXIT_FAILURE);
    }
}

// ============================================================================
// FATAL: è‡´å‘½éŒ¯èª¤è™•ç†
// ============================================================================
// ç”¨é€”ï¼š
// - é‡åˆ°ç„¡æ³•æ¢å¾©çš„éŒ¯èª¤æ™‚ç«‹å³çµ‚æ­¢ç¨‹å¼
// - è¨˜éŒ„éŒ¯èª¤è¨Šæ¯åˆ° stderr
//
// ä½¿ç”¨å ´æ™¯ï¼š
// - è¨˜æ†¶é«”åˆ†é…å¤±æ•—
// - é…ç½®æª”æ¡ˆè®€å–å¤±æ•—
// - ç¶²è·¯åˆå§‹åŒ–å¤±æ•—
//
// ç¯„ä¾‹ï¼š
// if (!config.load()) {
//     FATAL("Failed to load configuration file");
// }
inline auto FATAL(const std::string& msg) noexcept
{
    std::cerr << "FATAL : " << msg << std::endl;

    exit(EXIT_FAILURE);
}
