#include "matching_engine.h"

namespace Exchange
{
// ============================================================================
// MatchingEngine å»ºæ§‹å­
// ============================================================================
//
// ğŸ“Œ åŠŸèƒ½ï¼šåˆå§‹åŒ–æ’®åˆå¼•æ“ï¼Œå»ºç«‹å¤šå€‹è¨‚å–®ç°¿ï¼ˆæ¯å€‹äº¤æ˜“æ¨™çš„ä¸€å€‹ï¼‰
//
// åˆå§‹åŒ–æµç¨‹ï¼š
// 1. å„²å­˜ Lock-Free Queue æŒ‡æ¨™ï¼ˆèˆ‡ OrderGatewayã€MarketDataPublisher é€šè¨Šï¼‰
// 2. å»ºç«‹æ—¥èªŒè¨˜éŒ„å™¨ï¼ˆ"exchange_matching_engine.log"ï¼‰
// 3. ç‚ºæ¯å€‹äº¤æ˜“æ¨™çš„å»ºç«‹ç¨ç«‹çš„ MEOrderBook å¯¦ä¾‹
//
// âš¡ æ•ˆèƒ½è¨­è¨ˆï¼š
// - Lock-Free Queueï¼šé›¶é–å®šé€šè¨Šï¼ˆSPSC æ¨¡å¼ï¼‰
// - ç¨ç«‹è¨‚å–®ç°¿ï¼šæ¯å€‹æ¨™çš„ç¨ç«‹æ’®åˆï¼Œé¿å…ç«¶çˆ­
// - è¨˜æ†¶é«”é åˆ†é…ï¼šMEOrderBook å»ºæ§‹æ™‚åˆå§‹åŒ– Memory Pool
//
// ğŸ”— æ¶æ§‹è¨­è¨ˆï¼š
// - incoming_requests_ï¼šæ¥æ”¶å®¢æˆ¶ç«¯è¨‚å–®è«‹æ±‚ï¼ˆä¾†è‡ª OrderGatewayï¼‰
// - outgoing_ogw_responses_ï¼šç™¼é€æ’®åˆå›æ‡‰ï¼ˆå›çµ¦ OrderGatewayï¼‰
// - outgoing_md_updates_ï¼šç™¼é€å¸‚å ´è³‡æ–™æ›´æ–°ï¼ˆçµ¦ MarketDataPublisherï¼‰
//
// ğŸ“Š è³‡æ–™æµå‘ï¼š
// OrderGateway â†’ [incoming_requests_] â†’ MatchingEngine
// MatchingEngine â†’ [outgoing_ogw_responses_] â†’ OrderGateway
// MatchingEngine â†’ [outgoing_md_updates_] â†’ MarketDataPublisher
//
// âš ï¸ æ³¨æ„äº‹é …ï¼š
// - Queue æŒ‡æ¨™å¿…é ˆåœ¨ MatchingEngine ç”Ÿå‘½é€±æœŸå…§æœ‰æ•ˆ
// - ticker_order_book_ å¤§å°ç”± ME_MAX_TICKERS æ±ºå®šï¼ˆç·¨è­¯æœŸå¸¸æ•¸ï¼‰
// - MEOrderBook æœƒåå‘æŒæœ‰ MatchingEngine æŒ‡æ¨™ï¼ˆç”¨æ–¼ç™¼é€å›æ‡‰ï¼‰
//
// @param client_requests: å®¢æˆ¶ç«¯è¨‚å–®è«‹æ±‚ä½‡åˆ—ï¼ˆè¼¸å…¥ï¼‰
// @param client_responses: å®¢æˆ¶ç«¯å›æ‡‰ä½‡åˆ—ï¼ˆè¼¸å‡ºï¼‰
// @param market_updates: å¸‚å ´è³‡æ–™æ›´æ–°ä½‡åˆ—ï¼ˆè¼¸å‡ºï¼‰
MatchingEngine::MatchingEngine(ClientRequestLFQueue* client_requests,
                               ClientResponseLFQueue* client_responses,
                               MEMarketUpdateLFQueue* market_updates)
    : incoming_requests_(client_requests),
      outgoing_ogw_responses_(client_responses), outgoing_md_updates_(market_updates),
      logger_("exchange_matching_engine.log")
{
    // ç‚ºæ‰€æœ‰äº¤æ˜“æ¨™çš„åˆå§‹åŒ–è¨‚å–®ç°¿
    // âš¡ æ¯å€‹æ¨™çš„ç¨ç«‹æ’®åˆï¼šé¿å…å…¨åŸŸé–å®šï¼Œæå‡ä¸¦è¡Œæ•ˆèƒ½
    for (size_t i = 0; i < ticker_order_book_.size(); ++i) {
        ticker_order_book_[i] = new MEOrderBook(i, &logger_, this);
    }
}

// ============================================================================
// MatchingEngine è§£æ§‹å­
// ============================================================================
//
// ğŸ“Œ åŠŸèƒ½ï¼šå„ªé›…é—œé–‰æ’®åˆå¼•æ“ï¼Œé‡‹æ”¾æ‰€æœ‰è³‡æº
//
// æ¸…ç†æµç¨‹ï¼ˆé †åºå¾ˆé‡è¦ï¼‰ï¼š
// 1. å‘¼å« stop()ï¼ˆè¨­ç½® run_ = falseï¼Œåœæ­¢äº‹ä»¶è¿´åœˆï¼‰
// 2. ç­‰å¾… 1 ç§’ï¼ˆç¢ºä¿äº‹ä»¶è¿´åœˆå®Œå…¨é€€å‡ºï¼‰
// 3. æ¸…ç©º Queue æŒ‡æ¨™ï¼ˆé˜²æ­¢æ‡¸ç©ºæŒ‡æ¨™ï¼‰
// 4. åˆªé™¤æ‰€æœ‰ MEOrderBook å¯¦ä¾‹ï¼ˆé‡‹æ”¾è¨‚å–®ç°¿è³‡æºï¼‰
//
// âš¡ ç‚ºä»€éº¼è¦ç­‰å¾… 1 ç§’ï¼Ÿ
// - æ’®åˆåŸ·è¡Œç·’ï¼ˆrun() è¿´åœˆï¼‰éœ€è¦æ™‚é–“æª¢æŸ¥ run_ ä¸¦é€€å‡º
// - å¦‚æœç«‹åˆ»åˆªé™¤ MEOrderBookï¼Œå¯èƒ½é€ æˆ use-after-free
// - 1 ç§’æ˜¯ä¿å®ˆä¼°è¨ˆï¼ˆå¯¦éš›ç´„ 1-10 msï¼‰
//
// ğŸ”— é—œé–‰é †åºä¾è³´ï¼š
// 1. run_ = false â†’ äº‹ä»¶è¿´åœˆåœæ­¢è™•ç†æ–°è«‹æ±‚
// 2. sleep_for(1s) â†’ ç­‰å¾…ç•¶å‰è™•ç†ä¸­çš„è¨‚å–®å®Œæˆ
// 3. Queue æŒ‡æ¨™æ¸…ç©º â†’ é¿å…æ®˜ç•™åƒè€ƒ
// 4. delete MEOrderBook â†’ é‡‹æ”¾è¨˜æ†¶é«”ï¼ˆå« Memory Poolï¼‰
//
// âš ï¸ è³‡æºé‡‹æ”¾è€ƒé‡ï¼š
// - MEOrderBook å…§éƒ¨çš„ Memory Pool æœƒè‡ªå‹•é‡‹æ”¾æ‰€æœ‰ MEOrder
// - Queue æœ¬èº«ä¸ç”± MatchingEngine ç®¡ç†ï¼ˆåªæ˜¯æŒ‡æ¨™ï¼‰
// - Logger æœƒè‡ªå‹•åˆ·æ–°ç·©è¡å€ä¸¦é—œé–‰æª”æ¡ˆ
//
// ğŸ“Š å¯¦éš›é—œé–‰æ™‚é–“ï¼š
// - stop() è¨­å®šæ——æ¨™ï¼š< 1 ns
// - ç­‰å¾…åŸ·è¡Œç·’é€€å‡ºï¼š~1-10 msï¼ˆè¦–æœ€å¾Œä¸€ç­†è¨‚å–®è™•ç†æ™‚é–“ï¼‰
// - åˆªé™¤è¨‚å–®ç°¿ï¼š~10-100 Î¼sï¼ˆè¦–è¨˜æ†¶é«”æ± å¤§å°ï¼‰
// - ç¸½è¨ˆï¼šç´„ 1-10 msï¼ˆä¸å«å¼·åˆ¶ sleep çš„ 1 ç§’ï¼‰
MatchingEngine::~MatchingEngine()
{
    // 1. åœæ­¢äº‹ä»¶è¿´åœˆ
    stop();

    // 2. ç­‰å¾…æ’®åˆåŸ·è¡Œç·’å®Œå…¨é€€å‡ºï¼ˆé¿å… use-after-freeï¼‰
    using namespace std::literals::chrono_literals;
    std::this_thread::sleep_for(1s);

    // 3. æ¸…ç©º Queue æŒ‡æ¨™ï¼ˆé€™äº› Queue ç”±å¤–éƒ¨ç®¡ç†ï¼‰
    incoming_requests_ = nullptr;
    outgoing_ogw_responses_ = nullptr;
    outgoing_md_updates_ = nullptr;

    // 4. åˆªé™¤æ‰€æœ‰è¨‚å–®ç°¿ï¼ˆé‡‹æ”¾ Memory Pool å’Œå…§éƒ¨è³‡æºï¼‰
    for (auto& order_book : ticker_order_book_) {
        delete order_book;
        order_book = nullptr;
    }
}

// ============================================================================
// start() - å•Ÿå‹•æ’®åˆå¼•æ“
// ============================================================================
//
// ğŸ“Œ åŠŸèƒ½ï¼šå»ºç«‹å°ˆå±¬åŸ·è¡Œç·’ï¼ŒåŸ·è¡Œäº‹ä»¶è¿´åœˆï¼ˆrun() æ–¹æ³•ï¼‰
//
// åŸ·è¡Œæµç¨‹ï¼š
// 1. è¨­ç½® run_ = trueï¼ˆå•Ÿç”¨äº‹ä»¶è¿´åœˆï¼‰
// 2. å»ºç«‹å°ˆå±¬åŸ·è¡Œç·’ï¼ŒåŸ·è¡Œ run() æ–¹æ³•
// 3. è¨­ç½®åŸ·è¡Œç·’åç¨±ç‚º "Exchange/MatchingEngine"
// 4. é©—è­‰åŸ·è¡Œç·’å»ºç«‹æˆåŠŸï¼ˆASSERTï¼‰
//
// âš¡ æ•ˆèƒ½è¨­è¨ˆï¼š
// - CPU affinity = -1ï¼šä¸ç¶å®š CPUï¼ˆç”± OS èª¿åº¦ï¼‰
// - å°ˆå±¬åŸ·è¡Œç·’ï¼šé¿å…èˆ‡å…¶ä»–å…ƒä»¶ç«¶çˆ­ CPU
// - Lambda æ•ç²ï¼š[this]() æ•ç²ç•¶å‰ç‰©ä»¶æŒ‡æ¨™
//
// ğŸ”— åŸ·è¡Œç·’è¨­è¨ˆï¼š
// - createAndStartThread()ï¼šå°è£ pthread_create + CPU affinity è¨­å®š
// - run() æ–¹æ³•ï¼šç„¡é™è¿´åœˆè™•ç† incoming_requests_
// - run_ = false æ™‚è·³å‡ºè¿´åœˆ
//
// âš ï¸ æ³¨æ„äº‹é …ï¼š
// - å¿…é ˆåœ¨å»ºæ§‹å®Œæˆå¾Œæ‰èƒ½å‘¼å«ï¼ˆå»ºæ§‹ä¸­å‘¼å«å¯èƒ½é€ æˆæœªå®šç¾©è¡Œç‚ºï¼‰
// - é‡è¤‡å‘¼å« start() ä¸æœƒå»ºç«‹å¤šå€‹åŸ·è¡Œç·’ï¼ˆrun_ å·²æ˜¯ trueï¼‰
// - ASSERT å¤±æ•—æœƒçµ‚æ­¢ç¨‹å¼ï¼ˆç”Ÿç”¢ç’°å¢ƒæ‡‰è€ƒæ…®éŒ¯èª¤è™•ç†ï¼‰
//
// ğŸ“Š ä½¿ç”¨å ´æ™¯ï¼š
// - OrderServer åˆå§‹åŒ–æµç¨‹ä¸­å‘¼å«
// - å–®æ¬¡å‘¼å«ï¼Œæ’®åˆå¼•æ“ç”Ÿå‘½é€±æœŸå…§æŒçºŒåŸ·è¡Œ
auto MatchingEngine::start() -> void
{
    // 1. å•Ÿç”¨äº‹ä»¶è¿´åœˆæ——æ¨™
    run_ = true;

    // 2. å»ºç«‹å°ˆå±¬åŸ·è¡Œç·’åŸ·è¡Œ run() äº‹ä»¶è¿´åœˆ
    // -1ï¼šä¸ç¶å®šç‰¹å®š CPUï¼ˆç”± OS èª¿åº¦ï¼‰
    // "Exchange/MatchingEngine"ï¼šåŸ·è¡Œç·’åç¨±ï¼ˆä¾¿æ–¼é™¤éŒ¯ï¼‰
    ASSERT(Common::createAndStartThread(-1, "Exchange/MatchingEngine", [this]() {
        run();
    }) != nullptr, "Failed to start MatchingEngine thread.");
}

// ============================================================================
// stop() - åœæ­¢æ’®åˆå¼•æ“
// ============================================================================
//
// ğŸ“Œ åŠŸèƒ½ï¼šè¨­ç½®åœæ­¢æ——æ¨™ï¼Œé€šçŸ¥äº‹ä»¶è¿´åœˆé€€å‡º
//
// åŸ·è¡Œæµç¨‹ï¼š
// 1. è¨­ç½® run_ = false
// 2. run() è¿´åœˆåœ¨ä¸‹ä¸€æ¬¡æª¢æŸ¥æ™‚æœƒè·³å‡º
// 3. åŸ·è¡Œç·’è‡ªç„¶çµ‚æ­¢
//
// âš¡ æ•ˆèƒ½ç‰¹æ€§ï¼š
// - éåŒæ­¥åœæ­¢ï¼šä¸é˜»å¡ç•¶å‰åŸ·è¡Œç·’
// - å„ªé›…é—œé–‰ï¼šç­‰å¾…ç•¶å‰è™•ç†ä¸­çš„è¨‚å–®å®Œæˆ
// - ç„¡é–æ“ä½œï¼šrun_ æ˜¯ std::atomic<bool>
//
// âš ï¸ æ³¨æ„äº‹é …ï¼š
// - stop() åªæ˜¯è¨­ç½®æ——æ¨™ï¼Œä¸ä¿è­‰ç«‹åˆ»åœæ­¢
// - è§£æ§‹å­æœƒ sleep_for(1s) ç¢ºä¿åŸ·è¡Œç·’é€€å‡º
// - å¤šæ¬¡å‘¼å« stop() ç„¡å®³ï¼ˆå†ªç­‰æ“ä½œï¼‰
//
// ğŸ“Š å¯¦éš›åœæ­¢æ™‚é–“ï¼š
// - run_ è¨­å®šï¼š< 1 nsï¼ˆåŸå­æ“ä½œï¼‰
// - åŸ·è¡Œç·’é€€å‡ºï¼š~1-10 msï¼ˆè¦–ç•¶å‰è™•ç†çš„è¨‚å–®ï¼‰
auto MatchingEngine::stop() -> void
{
    // è¨­ç½®åœæ­¢æ——æ¨™ï¼ˆrun() è¿´åœˆæœƒæª¢æŸ¥æ­¤æ——æ¨™ä¸¦é€€å‡ºï¼‰
    run_ = false;
}
}
