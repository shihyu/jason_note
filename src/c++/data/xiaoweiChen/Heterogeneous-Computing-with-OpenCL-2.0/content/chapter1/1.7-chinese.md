#1.7 並行性的粒度

不論是在線程中使用共享內存，還在使用消息傳遞機制，我們都能調整線程的粒度。研究並行計算時，粒度是線程中計算量與通訊量(比如，需要在線程間進行同步的變量)。

並行的粒度由算法的特點所決定，選擇合適的並行粒度對於編程者來說很重要，合適的粒度能夠在當前設備上獲得最優的性能。有時對於粒度選擇就像是在分塊，然後決定哪些數據給予哪個任務，選擇了合適的塊大小可以就能在並行硬件上獲得性能收益。如何選擇並行程序的粒度，可以參考下面列出一些經驗。

使用細粒度並行時，需要考慮如下幾點：

- 計算量不要過大，這樣每個線程都有足夠的工作可做。
- 儘可能減少在數據同步上的開銷，這樣每個線程能夠獨立的完成自己的任務。
- 負載的劃分也很重要，因為有大量的獨立任務需要並行執行，設計良好的任務調度器都能靈活控制負載，並保證在多任務運行的同時，讓線程上的達到均衡。

使用粗粒度並行時，需要考慮如下幾點：

- 計算量肯定要高於細粒度並行時的計算量，因為不會像細粒度並行那樣，有很多線程同時執行。
- 編程者使用粗粒度編程時，需要了解應用的整體結構，讓粗粒度中的每個線程作為任務，服務於應用。

結合給出的建議，考慮一下自己的應用要選擇哪種粒度的實現。其實，最合理的粒度取決於所要使用的算法和運行的硬件平臺。大多數情況下，當同步和通訊的開銷大於計算，那麼將並行粒度加大，更有利於控制同步和通訊所需的過高開銷。細粒度並行能減少負載不均和訪存延遲在性能上的開銷(對於GPU來說更是如此，其為粒度之細可以切換線程時達到零開銷，同時也能隱藏訪存延遲)。

當一個算法需要對大量數據進行同一組操作時，就可將數據視為向量，執行同一操作時，多個數據作為輸入，經過向量操作後輸出多個數據。這種執行方式就是利用單指令多數據(SIMD)的方式對數據進行處理，可並行硬件可以利用這種執行方式，並行的對不同的數據進行處理。這種粒度的並行與向量的大小有關，通過SIMD執行單元的多數據處理來獲得應用性能的提升。

尋找和嘗試最好的計算粒度時，是否考慮過為什麼不將統一程序中的所有副本拷貝到其他處理單元和節點上，如果能夠這樣，是不是就不用理會執行單元的執行順序，並且能讓程序高效的運行在一個有著多處理器的共享系統上呢？SIMD模型與單程序多數據(SPMD)模型很相似，SPMD模型和SIMD模型都不會對指令邊界進行同步的限制，並且允許這些副本任務或內核能夠併發的執行。

##1.7.1 數據共享與同步

開發異構軟件還有一個很關鍵的因素——數據量。像想一下，兩個任務沒有任何數據需要共享，當運行環境或操作系統中的運算資源充足，那麼這兩個任務可以並行執行。如果在系統運行第一個任務時，第二個任務需要使用到第一個任務產出的結果。要是存在這樣的數據依賴關係，那麼就必選要介紹一下如何在並行或併發任務時，進行數據的同步。並行程序至少需要執行到一個同步點，才能夠進行數據的同步。當然，這會讓編程的難度加大，讓異構編程更具有挑戰性。

編寫併發軟件的時候，數據共享和同步扮演著很重要的角色。數據共享就有如下的用途：

- 一個任務中的輸入，依賴於另外一個任務的輸出——例如：生產者-消費者模型、流水線執行模型。
- 需要將中間結果進行綜合(比如：歸約，還有圖1.5裡的例子)。

理想狀態下，可以嘗試將應用能並行的部分剝離出來，確保並行的部分沒有數據依賴，不過這只是理想狀態而已。柵欄和鎖有時會用來做數據的同步。雖然，現在只是舉了這個例子，不過在後面的章節中我們將在OpenCL中重溫這個問題。OpenCL提供相應的機制，來完成主機端和設備端的數據同步，或者是完成任務間的數據同步。

##1.7.2 共享虛擬內存

很多異構系統，會將任務分散在不同的設備上執行，並且使用顯式同步和通訊機制，來完成不同任務在不同設備上的數據同步。共享虛擬內存設置在硬件和軟件層面，能夠讓不同的設備看到的是同一塊內存。這個機制讓編程更加簡單，並且能節省顯式的通訊開銷。OpenCL 2.0標準開始支持共享虛擬內存，減少了在程序執行中高昂的通訊開銷。同樣，這樣的機制就不需要在每個設備上都存儲一組數據副本，也就可以節省內存的開銷。當然，我們會在後面章節中，在與OpenCL上下文的相關章節中，討論更多共享虛擬內存的細節。

OpenCL2.0提供了三種共享虛擬內存：

- 粗粒度共享緩存
- 細粒度共享緩存
- 系統級細粒度共享緩存

使用共享虛擬內存需要OpenCL實現將系統中主機和設備端的地址鏈接起來。這就允許在OpenCL內核中使用數據結構的指針(比如：鏈表)，之前版本的OpenCL標準是不支持內核中使用自定義數據結構指針。粗粒度緩存支持通過API的調用，來更新整個緩存的內容。細粒度緩存和系統級細粒度的粒度為字節級，這就意味著無論是主機端，還是設備端，對數據的更新將會立即同步。細粒度共享內存是按內存一致模型中定義好的內存序，在同步點對數據進行同步。第6和第7章中，我們會對這部分內容進行更深層次的探討。




