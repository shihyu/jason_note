# Makefile for locks_guide examples
# ç·¨è­¯æ‰€æœ‰é–æ©Ÿåˆ¶ç¯„ä¾‹ç¨‹å¼

CC = gcc
CXX = g++
CFLAGS = -Wall -Wextra -pthread -std=c99
CXXFLAGS = -Wall -Wextra -pthread -std=c++17

# Linux C examples
C_SOURCES = 01_pthread_mutex.c 02_semaphore.c 03_spinlock.c 04_rwlock.c 05_condition_variable.c
C_TARGETS = $(C_SOURCES:.c=)

# C++ examples  
CXX_SOURCES = 06_std_mutex.cpp 07_recursive_mutex.cpp 08_shared_mutex.cpp 09_condition_variable.cpp 10_atomic_basic.cpp 11_lockfree_queue.cpp 12_lock_comparison.cpp
CXX_TARGETS = $(CXX_SOURCES:.cpp=)

# All targets
ALL_TARGETS = $(C_TARGETS) $(CXX_TARGETS)

.PHONY: all clean test help linux cpp

# Default target
all: $(ALL_TARGETS)
	@echo "âœ… æ‰€æœ‰ç¯„ä¾‹ç·¨è­¯å®Œæˆ!"
	@echo "å¯åŸ·è¡Œæª”æ¡ˆ: $(ALL_TARGETS)"

# Linux C examples
linux: $(C_TARGETS)
	@echo "âœ… Linux C ç¯„ä¾‹ç·¨è­¯å®Œæˆ!"

# C++ examples
cpp: $(CXX_TARGETS)
	@echo "âœ… C++ ç¯„ä¾‹ç·¨è­¯å®Œæˆ!"

# Individual C targets
$(C_TARGETS): %: %.c
	@echo "ğŸ”¨ ç·¨è­¯ $<..."
	$(CC) $(CFLAGS) -o $@ $<

# Individual C++ targets  
$(CXX_TARGETS): %: %.cpp
	@echo "ğŸ”¨ ç·¨è­¯ $<..."
	$(CXX) $(CXXFLAGS) -o $@ $<

# Test all examples
test: all
	@echo "ğŸ§ª æ¸¬è©¦æ‰€æœ‰ç¯„ä¾‹..."
	@echo "\n=== Linux C Examples ==="
	@for target in $(C_TARGETS); do \
		echo "â–¶ï¸  åŸ·è¡Œ $$target..."; \
		timeout 10s ./$$target || echo "âš ï¸  $$target è¶…æ™‚æˆ–éŒ¯èª¤"; \
		echo ""; \
	done
	@echo "\n=== C++ Examples ==="
	@for target in $(CXX_TARGETS); do \
		echo "â–¶ï¸  åŸ·è¡Œ $$target..."; \
		timeout 10s ./$$target || echo "âš ï¸  $$target è¶…æ™‚æˆ–éŒ¯èª¤"; \
		echo ""; \
	done

# Quick test (shorter timeout)
quick-test: all
	@echo "âš¡ å¿«é€Ÿæ¸¬è©¦æ‰€æœ‰ç¯„ä¾‹..."
	@for target in $(ALL_TARGETS); do \
		echo "â–¶ï¸  $$target"; \
		timeout 3s ./$$target >/dev/null 2>&1 && echo "âœ… OK" || echo "âŒ FAIL"; \
	done

# Clean build artifacts
clean:
	@echo "ğŸ§¹ æ¸…ç†ç·¨è­¯æª”æ¡ˆ..."
	rm -f $(ALL_TARGETS)
	@echo "âœ… æ¸…ç†å®Œæˆ!"

# Show build info
info:
	@echo "ğŸ“‹ ç·¨è­¯è³‡è¨Š:"
	@echo "C ç·¨è­¯å™¨: $(CC) $(CFLAGS)"
	@echo "C++ ç·¨è­¯å™¨: $(CXX) $(CXXFLAGS)"
	@echo "C åŸå§‹æª”: $(C_SOURCES)"
	@echo "C++ åŸå§‹æª”: $(CXX_SOURCES)" 
	@echo "æ‰€æœ‰ç›®æ¨™: $(ALL_TARGETS)"

# Help message
help:
	@echo "ğŸ“š locks_guide ç¯„ä¾‹ç¨‹å¼ Makefile"
	@echo ""
	@echo "ğŸ¯ å¯ç”¨ç›®æ¨™:"
	@echo "  all        - ç·¨è­¯æ‰€æœ‰ç¯„ä¾‹ (é è¨­)"
	@echo "  linux      - åªç·¨è­¯ Linux C ç¯„ä¾‹"
	@echo "  cpp        - åªç·¨è­¯ C++ ç¯„ä¾‹"
	@echo "  test       - ç·¨è­¯ä¸¦æ¸¬è©¦æ‰€æœ‰ç¯„ä¾‹"
	@echo "  quick-test - å¿«é€Ÿæ¸¬è©¦æ‰€æœ‰ç¯„ä¾‹"
	@echo "  clean      - æ¸…ç†ç·¨è­¯æª”æ¡ˆ"
	@echo "  info       - é¡¯ç¤ºç·¨è­¯è³‡è¨Š"
	@echo "  help       - é¡¯ç¤ºæ­¤èªªæ˜"
	@echo ""
	@echo "ğŸ“ ç¯„ä¾‹åˆ—è¡¨:"
	@echo "  Linux C:"
	@printf "    %s\n" $(C_SOURCES)
	@echo "  C++:"
	@printf "    %s\n" $(CXX_SOURCES)
	@echo ""
	@echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
	@echo "  make              # ç·¨è­¯æ‰€æœ‰ç¯„ä¾‹"
	@echo "  make test         # ç·¨è­¯ä¸¦æ¸¬è©¦"
	@echo "  make clean all    # æ¸…ç†å¾Œé‡æ–°ç·¨è­¯"
	@echo "  ./01_pthread_mutex # åŸ·è¡Œç‰¹å®šç¯„ä¾‹"
