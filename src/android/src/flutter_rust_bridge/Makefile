# Rust-Flutter Bridge Project Makefile
# ==================================

# Variables
RUST_TARGET_DIR = target
FLUTTER_APP_DIR = flutter_app
RUST_LIB_NAME = librust_flutter_bridge.so
RUST_LIB_PATH = $(RUST_TARGET_DIR)/release/$(RUST_LIB_NAME)
ANDROID_JNI_DIR = $(FLUTTER_APP_DIR)/android/app/src/main/jniLibs

# Colors for output
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
PURPLE = \033[0;35m
CYAN = \033[0;36m
NC = \033[0m # No Color

.PHONY: help build test clean install run dev check lint format docker

# Default target
help: ## é¡¯ç¤ºå¹«åŠ©ä¿¡æ¯
	@echo "${BLUE}Rust-Flutter Bridge Project${NC}"
	@echo "${BLUE}=============================${NC}"
	@echo ""
	@echo "${YELLOW}Available targets:${NC}"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  ${GREEN}%-15s${NC} %s\n", $$1, $$2}'
	@echo ""

build: build-rust copy-libs ## å»ºç½®å®Œæ•´å°ˆæ¡ˆ (Rust + è¤‡è£½å‡½å¼åº«)
	@echo "${GREEN}âœ… Project build completed!${NC}"

build-rust: ## å»ºç½® Rust å‡½å¼åº« (release æ¨¡å¼)
	@echo "${BLUE}ğŸ¦€ Building Rust library...${NC}"
	cargo build --release
	@echo "${GREEN}âœ… Rust library built successfully${NC}"

build-debug: ## å»ºç½® Rust å‡½å¼åº« (debug æ¨¡å¼)
	@echo "${BLUE}ğŸ¦€ Building Rust library (debug)...${NC}"
	cargo build
	@echo "${GREEN}âœ… Rust debug library built successfully${NC}"

copy-libs: build-rust ## è¤‡è£½ Rust å‡½å¼åº«åˆ° Flutter å°ˆæ¡ˆ
	@echo "${BLUE}ğŸ“¦ Copying libraries to Flutter project...${NC}"
	@mkdir -p $(ANDROID_JNI_DIR)/x86_64
	@mkdir -p $(ANDROID_JNI_DIR)/arm64-v8a
	@mkdir -p $(ANDROID_JNI_DIR)/armeabi-v7a
	cp $(RUST_LIB_PATH) $(FLUTTER_APP_DIR)/
	cp $(RUST_LIB_PATH) $(ANDROID_JNI_DIR)/x86_64/
	@echo "${GREEN}âœ… Libraries copied successfully${NC}"

test: test-rust test-flutter ## åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
	@echo "${GREEN}ğŸ‰ All tests completed!${NC}"

test-rust: ## åŸ·è¡Œ Rust æ¸¬è©¦
	@echo "${BLUE}ğŸ¦€ Running Rust tests...${NC}"
	cargo test
	@echo "${GREEN}âœ… Rust tests passed${NC}"

test-flutter: flutter-deps ## åŸ·è¡Œ Flutter æ¸¬è©¦
	@echo "${BLUE}ğŸ“± Running Flutter tests...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter test test/widget_test.dart test/rust_bridge_unit_test.dart
	@echo "${GREEN}âœ… Flutter tests passed${NC}"

test-integration: flutter-deps ## åŸ·è¡Œ Flutter æ•´åˆæ¸¬è©¦ (éœ€è¦ FFI)
	@echo "${BLUE}ğŸ”— Running Flutter integration tests...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter test test/integration_test.dart
	@echo "${GREEN}âœ… Integration tests passed${NC}"

flutter-deps: ## å®‰è£ Flutter ä¾è³´
	@echo "${BLUE}ğŸ“¦ Installing Flutter dependencies...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter pub get
	@echo "${GREEN}âœ… Flutter dependencies installed${NC}"

clean: ## æ¸…ç†å»ºç½®æ–‡ä»¶
	@echo "${YELLOW}ğŸ§¹ Cleaning project...${NC}"
	cargo clean
	cd $(FLUTTER_APP_DIR) && flutter clean
	rm -f $(FLUTTER_APP_DIR)/$(RUST_LIB_NAME)
	rm -rf $(ANDROID_JNI_DIR)
	@echo "${GREEN}âœ… Project cleaned${NC}"

install: build flutter-deps copy-libs ## å®Œæ•´å®‰è£ (å»ºç½® + è¤‡è£½å‡½å¼åº« + Flutter ä¾è³´)
	@echo "${GREEN}ğŸ‰ Installation completed!${NC}"

run: build copy-libs flutter-deps ## å»ºç½®ä¸¦åŸ·è¡Œ Flutter æ‡‰ç”¨ç¨‹å¼
	@echo "${BLUE}ğŸš€ Running Flutter app...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter run

run-release: build copy-libs flutter-deps ## å»ºç½®ä¸¦åŸ·è¡Œ Flutter æ‡‰ç”¨ç¨‹å¼ (release æ¨¡å¼)
	@echo "${BLUE}ğŸš€ Running Flutter app (release)...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter run --release

dev: build-debug copy-libs flutter-deps ## é–‹ç™¼æ¨¡å¼ (debug å»ºç½® + hot reload)
	@echo "${BLUE}ğŸ”¥ Starting development mode...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter run --hot

check: ## åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥
	@echo "${BLUE}ğŸ” Running code checks...${NC}"
	cargo check
	cargo clippy -- -D warnings
	cd $(FLUTTER_APP_DIR) && flutter analyze
	@echo "${GREEN}âœ… Code checks passed${NC}"

lint: ## åŸ·è¡Œç¨‹å¼ç¢¼ linting
	@echo "${BLUE}ğŸ” Running linters...${NC}"
	cargo clippy
	cd $(FLUTTER_APP_DIR) && flutter analyze
	@echo "${GREEN}âœ… Linting completed${NC}"

format: ## æ ¼å¼åŒ–ç¨‹å¼ç¢¼
	@echo "${BLUE}âœ¨ Formatting code...${NC}"
	cargo fmt
	cd $(FLUTTER_APP_DIR) && dart format .
	@echo "${GREEN}âœ… Code formatted${NC}"

benchmark: build copy-libs flutter-deps ## åŸ·è¡Œæ•ˆèƒ½åŸºæº–æ¸¬è©¦
	@echo "${BLUE}âš¡ Running benchmark tests...${NC}"
	cargo test --release -- --nocapture test_memory_management
	cd $(FLUTTER_APP_DIR) && flutter test test/rust_bridge_unit_test.dart --plain-name="should handle benchmark calculation logic"
	@echo "${GREEN}âœ… Benchmark tests completed${NC}"

size-check: build ## æª¢æŸ¥å»ºç½®ç”¢ç‰©å¤§å°
	@echo "${BLUE}ğŸ“ Checking build sizes...${NC}"
	@echo "${CYAN}Rust library size:${NC}"
	ls -lh $(RUST_LIB_PATH)
	@echo "${CYAN}Debug library size:${NC}"
	ls -lh $(RUST_TARGET_DIR)/debug/$(RUST_LIB_NAME) 2>/dev/null || echo "Debug library not found"
	@echo "${GREEN}âœ… Size check completed${NC}"

security-audit: ## åŸ·è¡Œå®‰å…¨æ€§å¯©è¨ˆ
	@echo "${BLUE}ğŸ”’ Running security audit...${NC}"
	cargo audit
	@echo "${GREEN}âœ… Security audit completed${NC}"

docs: ## ç”¢ç”Ÿæ–‡ä»¶
	@echo "${BLUE}ğŸ“š Generating documentation...${NC}"
	cargo doc --open
	@echo "${GREEN}âœ… Documentation generated${NC}"

# Android specific targets
android-build: build copy-libs flutter-deps ## å»ºç½® Android APK
	@echo "${BLUE}ğŸ“± Building Android APK...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter build apk
	@echo "${GREEN}âœ… Android APK built successfully${NC}"

android-release: build copy-libs flutter-deps ## å»ºç½® Android release APK
	@echo "${BLUE}ğŸ“± Building Android release APK...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter build apk --release
	@echo "${GREEN}âœ… Android release APK built successfully${NC}"

# Cross-compilation targets
build-android-arm64: ## äº¤å‰ç·¨è­¯ ARM64 Android
	@echo "${BLUE}ğŸ¤– Cross-compiling for Android ARM64...${NC}"
	cargo build --release --target aarch64-linux-android
	@mkdir -p $(ANDROID_JNI_DIR)/arm64-v8a
	cp target/aarch64-linux-android/release/$(RUST_LIB_NAME) $(ANDROID_JNI_DIR)/arm64-v8a/
	@echo "${GREEN}âœ… ARM64 Android library built${NC}"

build-android-arm: ## äº¤å‰ç·¨è­¯ ARM Android
	@echo "${BLUE}ğŸ¤– Cross-compiling for Android ARM...${NC}"
	cargo build --release --target armv7-linux-androideabi  
	@mkdir -p $(ANDROID_JNI_DIR)/armeabi-v7a
	cp target/armv7-linux-androideabi/release/$(RUST_LIB_NAME) $(ANDROID_JNI_DIR)/armeabi-v7a/
	@echo "${GREEN}âœ… ARM Android library built${NC}"

# Docker targets
docker-build: ## å»ºç½® Docker æ˜ åƒ
	@echo "${BLUE}ğŸ³ Building Docker image...${NC}"
	docker build -t rust-flutter-bridge .
	@echo "${GREEN}âœ… Docker image built${NC}"

docker-test: ## åœ¨ Docker ä¸­åŸ·è¡Œæ¸¬è©¦
	@echo "${BLUE}ğŸ³ Running tests in Docker...${NC}"
	docker run --rm rust-flutter-bridge make test-rust
	@echo "${GREEN}âœ… Docker tests completed${NC}"

# CI/CD targets
ci: check test ## CI ç®¡é“ (æª¢æŸ¥ + æ¸¬è©¦)
	@echo "${GREEN}ğŸ‰ CI pipeline completed successfully!${NC}"

cd: build android-build ## CD ç®¡é“ (å»ºç½® + Android)
	@echo "${GREEN}ğŸš€ CD pipeline completed successfully!${NC}"

# Development utilities
watch-rust: ## ç›£æ§ Rust ç¨‹å¼ç¢¼è®Šæ›´ä¸¦é‡æ–°å»ºç½®
	@echo "${BLUE}ğŸ‘€ Watching Rust code changes...${NC}"
	cargo watch -x "build --release" -x "test"

watch-flutter: flutter-deps ## ç›£æ§ Flutter ç¨‹å¼ç¢¼è®Šæ›´ä¸¦é‡æ–°æ¸¬è©¦
	@echo "${BLUE}ğŸ‘€ Watching Flutter code changes...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter test --watch

profile: ## æ•ˆèƒ½åˆ†æ
	@echo "${BLUE}ğŸ“Š Running performance profiling...${NC}"
	cargo build --release
	time cargo test --release test_memory_management -- --nocapture
	@echo "${GREEN}âœ… Profiling completed${NC}"

# Information targets
info: ## é¡¯ç¤ºå°ˆæ¡ˆè³‡è¨Š
	@echo "${BLUE}Project Information${NC}"
	@echo "${BLUE}===================${NC}"
	@echo "${CYAN}Rust version:${NC} $$(rustc --version)"
	@echo "${CYAN}Cargo version:${NC} $$(cargo --version)"
	@echo "${CYAN}Flutter version:${NC} $$(cd $(FLUTTER_APP_DIR) && flutter --version | head -n 1)"
	@echo "${CYAN}Project structure:${NC}"
	@tree -L 2 -I 'target|.git' .

status: ## é¡¯ç¤ºå»ºç½®ç‹€æ…‹
	@echo "${BLUE}Build Status${NC}"
	@echo "${BLUE}============${NC}"
	@echo "${CYAN}Rust library exists:${NC} $$([ -f $(RUST_LIB_PATH) ] && echo 'âœ… Yes' || echo 'âŒ No')"
	@echo "${CYAN}Flutter library copied:${NC} $$([ -f $(FLUTTER_APP_DIR)/$(RUST_LIB_NAME) ] && echo 'âœ… Yes' || echo 'âŒ No')"
	@echo "${CYAN}Flutter deps installed:${NC} $$([ -d $(FLUTTER_APP_DIR)/.dart_tool ] && echo 'âœ… Yes' || echo 'âŒ No')"

# Quick commands
quick-test: test-rust test-flutter ## å¿«é€Ÿæ¸¬è©¦ (è·³éæ•´åˆæ¸¬è©¦)
	@echo "${GREEN}âš¡ Quick tests completed!${NC}"

quick-build: build-rust copy-libs ## å¿«é€Ÿå»ºç½® (è·³é Flutter ä¾è³´)
	@echo "${GREEN}âš¡ Quick build completed!${NC}"

# All-in-one targets
all: clean install test ## å®Œæ•´æµç¨‹ (æ¸…ç† + å®‰è£ + æ¸¬è©¦)
	@echo "${GREEN}ğŸ‰ Complete workflow finished!${NC}"

demo: build copy-libs flutter-deps ## åŸ·è¡Œå±•ç¤º (å»ºç½® + åŸ·è¡Œ)
	@echo "${BLUE}ğŸ­ Starting demo...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter run --dart-define=DEMO_MODE=true

logcat: ## ç›£æ§ BitoPro logcat æ—¥èªŒ
	@echo "${BLUE}ğŸ” Starting BitoPro logcat monitor...${NC}"
	./logcat_bitopro.sh

test-android: build copy-libs flutter-deps ## åœ¨ Android è¨­å‚™ä¸Šæ¸¬è©¦
	@echo "${BLUE}ğŸ“± Testing on Android device...${NC}"
	cd $(FLUTTER_APP_DIR) && flutter run --debug

logcat-all: ## é¡¯ç¤ºæ‰€æœ‰ Android æ—¥èªŒ
	@echo "${BLUE}ğŸ“œ Showing all Android logs...${NC}"
	adb logcat -v time

test-local-ffi: build ## æœ¬åœ°æ¸¬è©¦ Rust FFI åŠŸèƒ½
	@echo "${BLUE}ğŸ¦€ Testing Rust FFI locally...${NC}"
	./test_rust_locally.sh

test-with-logs: build copy-libs flutter-deps ## åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼ä¸¦åŒæ™‚ç›£æ§æ—¥èªŒ
	@echo "${BLUE}ğŸš€ Testing app with log monitoring...${NC}"
	./test_with_logs.sh