# WASM æ¸¬è©¦é …ç›® Makefile
# æ”¯æ´ç·¨è­¯ã€å„ªåŒ–ã€æ¸¬è©¦å’Œ GDB èª¿è©¦

.PHONY: all clean build optimize test debug serve install-deps help

# è®Šé‡å®šç¾©
PROJECT_NAME = wasm_test_project
PKG_DIR = pkg
WASM_FILE = $(PKG_DIR)/$(PROJECT_NAME)_bg.wasm
OPTIMIZED_WASM = $(PKG_DIR)/optimized.wasm
DEBUG_WASM = $(PKG_DIR)/debug.wasm
PORT = 8080

# é»˜èªç›®æ¨™
all: clean build optimize test

# æ¸…ç†ç”Ÿæˆæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†èˆŠæ–‡ä»¶..."
	rm -rf $(PKG_DIR)/
	rm -f *.wasm *.wat
	rm -f wasm_info.txt test_results.txt
	cargo clean

# å®‰è£ä¾è³´
install-deps:
	@echo "ğŸ“¦ å®‰è£å¿…è¦ä¾è³´..."
	# æª¢æŸ¥ Rust å·¥å…·éˆ
	@which rustc > /dev/null || (echo "âŒ è«‹å…ˆå®‰è£ Rust" && exit 1)
	@which wasm-pack > /dev/null || (echo "â¬‡ï¸ å®‰è£ wasm-pack..." && curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh)
	@which wasm-opt > /dev/null || (echo "â¬‡ï¸ è«‹å®‰è£ binaryen (wasm-opt)" && exit 1)
	@which gdb > /dev/null || (echo "â¬‡ï¸ è«‹å®‰è£ gdb" && exit 1)
	# æ·»åŠ  WASM ç›®æ¨™
	rustup target add wasm32-unknown-unknown
	@echo "âœ… ä¾è³´å®‰è£å®Œæˆ"

# ç·¨è­¯ WASM (ç™¼å¸ƒç‰ˆ)
build:
	@echo "ğŸ”¨ ç·¨è­¯ WASM (Release)..."
	wasm-pack build --target web --out-dir $(PKG_DIR) --release
	@if [ -f $(WASM_FILE) ]; then \
		echo "âœ… ç·¨è­¯æˆåŠŸ"; \
		ls -lh $(WASM_FILE); \
	else \
		echo "âŒ ç·¨è­¯å¤±æ•—"; \
		exit 1; \
	fi

# ç·¨è­¯ WASM (èª¿è©¦ç‰ˆ)
build-debug:
	@echo "ğŸ”¨ ç·¨è­¯ WASM (Debug)..."
	wasm-pack build --target web --out-dir $(PKG_DIR) --dev
	cp $(WASM_FILE) $(DEBUG_WASM)
	@echo "âœ… èª¿è©¦ç‰ˆç·¨è­¯å®Œæˆ"
	@ls -lh $(DEBUG_WASM)

# å„ªåŒ– WASM æ–‡ä»¶
optimize: build
	@echo "âš¡ æº–å‚™å„ªåŒ–çš„ WASM æ–‡ä»¶..."
	@if [ ! -f $(WASM_FILE) ]; then \
		echo "âŒ æ‰¾ä¸åˆ° WASM æ–‡ä»¶ï¼Œè«‹å…ˆåŸ·è¡Œ make build"; \
		exit 1; \
	fi
	
	# ç²å–åŸå§‹å¤§å°
	@ORIGINAL_SIZE=$$(wc -c < $(WASM_FILE)); \
	echo "åŸå§‹å¤§å°: $$ORIGINAL_SIZE bytes"; \
	
	# ç”±æ–¼æ²’æœ‰ wasm-optï¼Œç›´æ¥è¤‡è£½æ–‡ä»¶
	@cp $(WASM_FILE) $(OPTIMIZED_WASM); \
	echo "âš ï¸ wasm-opt æœªå®‰è£ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶ä½œç‚ºå„ªåŒ–ç‰ˆæœ¬"; \
	
	# æª¢æŸ¥æ–‡ä»¶å¤§å°
	@OPTIMIZED_SIZE=$$(wc -c < $(OPTIMIZED_WASM)); \
	echo "æ–‡ä»¶å¤§å°: $$OPTIMIZED_SIZE bytes"; \
	
	# ç”Ÿæˆå ±å‘Š
	@echo "=== WASM æ–‡ä»¶å ±å‘Š ===" > wasm_info.txt; \
	echo "ç·¨è­¯æ™‚é–“: $$(date)" >> wasm_info.txt; \
	echo "åŸå§‹å¤§å°: $$ORIGINAL_SIZE bytes" >> wasm_info.txt; \
	echo "æ–‡ä»¶å¤§å°: $$OPTIMIZED_SIZE bytes" >> wasm_info.txt; \
	echo "å‚™è¨»: éœ€è¦ wasm-opt é€²è¡Œé€²ä¸€æ­¥å„ªåŒ–" >> wasm_info.txt; \
	echo "âœ… æ–‡ä»¶æº–å‚™å®Œæˆï¼Œå ±å‘Šå·²ä¿å­˜åˆ° wasm_info.txt"

# æ¸¬è©¦ WASM åŠŸèƒ½
test: optimize test-js

# JavaScript æ¸¬è©¦
test-js:
	@echo "ğŸ§ª åŸ·è¡Œ JavaScript æ¸¬è©¦..."
	@if [ ! -f $(OPTIMIZED_WASM) ]; then \
		echo "âŒ æ‰¾ä¸åˆ°å„ªåŒ–çš„ WASM æ–‡ä»¶ï¼Œè«‹å…ˆåŸ·è¡Œ make optimize"; \
		exit 1; \
	fi
	node test-detailed.js > test_results.txt 2>&1 || true
	@echo "ğŸ“Š æ¸¬è©¦çµæœå·²ä¿å­˜åˆ° test_results.txt"
	@echo "âœ… ä¸»è¦æ¸¬è©¦çµæœ:"
	@grep -E "(âœ…|âŒ|ğŸ‰)" test_results.txt | head -10 || echo "æ¸¬è©¦å®Œæˆ"

# WASM æ–‡ä»¶åˆ†æ
analyze:
	@echo "ğŸ” åˆ†æ WASM æ–‡ä»¶..."
	@if [ -f $(OPTIMIZED_WASM) ]; then \
		echo "=== æ–‡ä»¶çµæ§‹ ==="; \
		wasm-objdump -h $(OPTIMIZED_WASM); \
		echo ""; \
		echo "=== å°å‡ºå‡½æ•¸ ==="; \
		wasm-objdump -j Export $(OPTIMIZED_WASM); \
		echo ""; \
		echo "=== æ–‡ä»¶é©—è­‰ ==="; \
		wasm-validate $(OPTIMIZED_WASM) && echo "âœ… æ–‡ä»¶æœ‰æ•ˆ" || echo "âŒ æ–‡ä»¶ç„¡æ•ˆ"; \
	else \
		echo "âŒ æ‰¾ä¸åˆ° WASM æ–‡ä»¶ï¼Œè«‹å…ˆåŸ·è¡Œ make optimize"; \
	fi

# è½‰æ›ç‚º WAT æ ¼å¼
to-wat:
	@echo "ğŸ“ è½‰æ›ç‚º WAT æ ¼å¼..."
	@if [ -f $(OPTIMIZED_WASM) ]; then \
		wasm2wat $(OPTIMIZED_WASM) -o optimized.wat; \
		echo "âœ… å·²è½‰æ›ç‚º optimized.wat"; \
		wc -l optimized.wat; \
	else \
		echo "âŒ æ‰¾ä¸åˆ° WASM æ–‡ä»¶"; \
	fi

# GDB èª¿è©¦æº–å‚™
debug-setup: build-debug
	@echo "ğŸ› æº–å‚™ GDB èª¿è©¦ç’°å¢ƒ..."
	@if [ -f $(DEBUG_WASM) ]; then \
		echo "âœ… èª¿è©¦ç‰ˆ WASM å·²æº–å‚™: $(DEBUG_WASM)"; \
		echo "ğŸ“‹ èª¿è©¦å‘½ä»¤:"; \
		echo "  gdb --args node test-debug.js"; \
		echo "  æˆ–ä½¿ç”¨: make debug-gdb"; \
		echo "  æˆ–ä½¿ç”¨: make debug-wasm (ç›´æ¥èª¿è©¦ WASM)"; \
	else \
		echo "âŒ èª¿è©¦ç‰ˆ WASM ä¸å­˜åœ¨"; \
	fi

# å•Ÿå‹• GDB èª¿è©¦ Node.js
debug-gdb: debug-setup
	@echo "ğŸš€ å•Ÿå‹• GDB èª¿è©¦ Node.js..."
	gdb --args node test-debug.js

# ç›´æ¥èª¿è©¦ WASM (ä½¿ç”¨ wasmtime)
debug-wasm: debug-setup
	@echo "ğŸ› ä½¿ç”¨ wasmtime èª¿è©¦ WASM..."
	@test -f ~/.wasmtime/bin/wasmtime || (echo "âŒ è«‹å…ˆå®‰è£ wasmtime: curl https://wasmtime.dev/install.sh -sSf | bash" && exit 1)
	gdb --args ~/.wasmtime/bin/wasmtime --debug-info $(DEBUG_WASM)

# é…ç½® GDB èª¿è©¦è¨­å®šæª”
debug-config:
	@echo "âš™ï¸ é…ç½® GDB èª¿è©¦è¨­å®š..."
	@echo "# GDB èª¿è©¦è¨­å®šæª”" > .gdbinit
	@echo "set architecture wasm32" >> .gdbinit
	@echo "set confirm off" >> .gdbinit
	@echo "set pagination off" >> .gdbinit
	@echo "set print pretty on" >> .gdbinit
	@echo "set print array on" >> .gdbinit
	@echo "# WASM ç‰¹æ®Šè¨­å®š" >> .gdbinit
	@echo "set debug remote 0" >> .gdbinit
	@echo "# è‡ªå‹•è¼‰å…¥é™¤éŒ¯ç¬¦è™Ÿ" >> .gdbinit
	@echo "set auto-load safe-path /" >> .gdbinit
	@echo "âœ… GDB è¨­å®šæª”å·²å»ºç«‹: .gdbinit"

# é ç«¯èª¿è©¦è¨­å®š (target) - å¯¦éš›å•Ÿå‹• gdbserver
debug-remote-target: debug-setup debug-config
	@echo "ğŸ¯ å•Ÿå‹• GDB é ç«¯èª¿è©¦ Target..."
	@echo "åœ¨ localhost:1234 å•Ÿå‹• gdbserver..."
	gdbserver --multi localhost:1234 $(DEBUG_WASM)

# é ç«¯èª¿è©¦é€£ç·š (host)
debug-remote-host: debug-config
	@echo "ğŸ  å•Ÿå‹• GDB Host é€£ç·š..."
	@echo "é€£æ¥åˆ° localhost:1234..."
	@echo "target extended-remote localhost:1234" > gdb_commands.txt
	@echo "set remote exec-file $(DEBUG_WASM)" >> gdb_commands.txt
	@echo "file $(DEBUG_WASM)" >> gdb_commands.txt
	@echo "break main" >> gdb_commands.txt
	@echo "continue" >> gdb_commands.txt
	gdb -x gdb_commands.txt

# æœ¬åœ°ç›´æ¥èª¿è©¦ (æ¨è–¦)
debug-local: debug-setup debug-config
	@echo "ğŸ  æœ¬åœ°ç›´æ¥èª¿è©¦..."
	@echo "file $(DEBUG_WASM)" > local_debug.txt
	@echo "break main" >> local_debug.txt
	@echo "run" >> local_debug.txt
	gdb ~/.wasmtime/bin/wasmtime -x local_debug.txt --args ~/.wasmtime/bin/wasmtime --debug-info $(DEBUG_WASM)

# å•Ÿå‹•é–‹ç™¼æœå‹™å™¨
serve:
	@echo "ğŸŒ å•Ÿå‹•é–‹ç™¼æœå‹™å™¨ (ç«¯å£ $(PORT))..."
	@if command -v python3 >/dev/null 2>&1; then \
		echo "ä½¿ç”¨ Python HTTP æœå‹™å™¨..."; \
		python3 -m http.server $(PORT); \
	elif command -v npx >/dev/null 2>&1; then \
		echo "ä½¿ç”¨ Node.js æœå‹™å™¨..."; \
		npx serve . -p $(PORT); \
	else \
		echo "âŒ è«‹å®‰è£ Python3 æˆ– Node.js"; \
		exit 1; \
	fi

# æ€§èƒ½åŸºæº–æ¸¬è©¦
benchmark: optimize
	@echo "â±ï¸ åŸ·è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦..."
	node benchmark.js > benchmark_results.txt 2>&1
	@echo "ğŸ“Š åŸºæº–æ¸¬è©¦çµæœ:"
	@cat benchmark_results.txt

# å®Œæ•´æ¸¬è©¦å¥—ä»¶
test-all: clean install-deps build optimize analyze test benchmark
	@echo "ğŸ‰ å®Œæ•´æ¸¬è©¦å¥—ä»¶åŸ·è¡Œå®Œæˆ!"
	@echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
	@ls -la *.txt *.wasm *.wat 2>/dev/null || true

# å¹«åŠ©ä¿¡æ¯
help:
	@echo "WASM æ¸¬è©¦é …ç›® Makefile"
	@echo ""
	@echo "å¯ç”¨ç›®æ¨™:"
	@echo "  all           - åŸ·è¡Œå®Œæ•´æ§‹å»ºæµç¨‹ (clean + build + optimize + test)"
	@echo "  clean         - æ¸…ç†ç”Ÿæˆæ–‡ä»¶"
	@echo "  install-deps  - å®‰è£å¿…è¦ä¾è³´"
	@echo "  build         - ç·¨è­¯ WASM (ç™¼å¸ƒç‰ˆ)"
	@echo "  build-debug   - ç·¨è­¯ WASM (èª¿è©¦ç‰ˆ)"
	@echo "  optimize      - å„ªåŒ– WASM æ–‡ä»¶"
	@echo "  test          - åŸ·è¡Œæ¸¬è©¦"
	@echo "  test-js       - åŸ·è¡Œ JavaScript æ¸¬è©¦"
	@echo "  analyze       - åˆ†æ WASM æ–‡ä»¶"
	@echo "  to-wat        - è½‰æ›ç‚º WAT æ ¼å¼"
	@echo "  debug-setup   - æº–å‚™ GDB èª¿è©¦ç’°å¢ƒ"
	@echo "  debug-gdb     - å•Ÿå‹• GDB èª¿è©¦ Node.js"
	@echo "  debug-wasm    - ç›´æ¥èª¿è©¦ WASM (éœ€è¦ wasmtime)"
	@echo "  debug-config  - é…ç½® GDB è¨­å®šæª”"
	@echo "  debug-remote-target - å•Ÿå‹•é ç«¯èª¿è©¦ Target (gdbserver)"
	@echo "  debug-remote-host   - é€£ç·šåˆ°é ç«¯èª¿è©¦ Host"
	@echo "  debug-local         - æœ¬åœ°ç›´æ¥èª¿è©¦ (æ¨è–¦)"
	@echo "  serve         - å•Ÿå‹•é–‹ç™¼æœå‹™å™¨"
	@echo "  benchmark     - åŸ·è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦"
	@echo "  test-all      - åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶"
	@echo "  help          - é¡¯ç¤ºæ­¤å¹«åŠ©ä¿¡æ¯"