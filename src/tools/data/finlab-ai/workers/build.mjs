/**
 * Build script for Cloudflare Workers deployment.
 * Reads markdown docs and generates a TypeScript file with embedded content.
 */

import { readFileSync, writeFileSync, readdirSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const DOCS_DIR = join(__dirname, '..', 'finlab-plugin', 'skills', 'finlab');
const OUTPUT_FILE = join(__dirname, 'src', 'docs.ts');

const EXCLUDED_FILES = ['README.md'];

function loadDocuments() {
  const docs = {};
  const files = readdirSync(DOCS_DIR).filter(f => f.endsWith('.md') && !EXCLUDED_FILES.includes(f));

  for (const file of files.sort()) {
    const name = file.replace('.md', '');
    const content = readFileSync(join(DOCS_DIR, file), 'utf-8');
    docs[name] = content;
    console.log(`  Loaded: ${file} (${content.length} chars)`);
  }

  return docs;
}

function generateDocsTs(docs) {
  const entries = Object.entries(docs).map(([name, content]) => {
    const escaped = content
      .replace(/\\/g, '\\\\')
      .replace(/`/g, '\\`')
      .replace(/\$/g, '\\$');
    return `  "${name}": \`${escaped}\``;
  });

  return `// Auto-generated by build.mjs - DO NOT EDIT
// Documentation embedded from finlab-plugin/skills/finlab/*.md

export const DOCS: Record<string, string> = {
${entries.join(',\n')}
};
`;
}

console.log('Building FinLab MCP Server for Cloudflare Workers...');
console.log(`Reading docs from: ${DOCS_DIR}`);

const docs = loadDocuments();
console.log(`Loaded ${Object.keys(docs).length} documents`);

const content = generateDocsTs(docs);
writeFileSync(OUTPUT_FILE, content, 'utf-8');
console.log(`Generated: ${OUTPUT_FILE}`);

console.log('Build complete!');
