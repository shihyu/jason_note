# 教學日曆（教學大綱）（48學時）

### 大綱修定歷史：

- [v1](https://github.com/LearningOS/os-lectures/blob/c3933c913abdedbda15a25ad85e33f166fae38fc/os-course-outline.md)
- [v2](https://github.com/LearningOS/os-lectures/blob/9ffa747971086b88f8045b04ae012c82ad837414/os-course-outline.md)：2020年10月21日提交給系裡的版本；
- [v3](https://github.com/LearningOS/os-lectures/blob/e00265613daeafffa9fa4d1a53def7b5ed92016a/os-course-outline.md): 21 Oct 2020
- [v4](https://github.com/LearningOS/os-lectures/blob/1d07e4bfc55af586079499db65f926b52c0afeb1/os-course-outline.md): cooperate with 2021-spring labs
- [v5](https://github.com/LearningOS/os-lectures/blob/f001a6c5bacc7be80e27a168959c288c91ec1639/os-course-outline.md): 2021年秋季學期結束時更新教學內容部分
- [v6](https://github.com/LearningOS/os-lectures/blob/0d92ea949ff7345454cdea685643aab693255c99/os-course-outline.md): 2022 spring
- v7: 2022 autumn

### 課程組織與基本目的

操作系統是計算機系統中負責管理各種軟硬件資源的核心繫統軟件，掌握操作系統的基本原理及其設計實現技術是研究型大學計算機專業本科畢業生的基本要求。

本課程是計算機專業核心課，從計算機系統的視角進行內容組織與調整，以教學操作系統uCore/rCore和risc-v CPU為實驗環境，講授操作系統的概念、基本原理和實現技術，並介紹部分當前操作系統研究熱點和論文，幫助學生了解和掌握大型複雜系統軟件的分析方法和核心設計思路，併為學生充分利用操作系統功能進行應用軟件研究和開發打下紮實的基礎。

### 教學理念（原則/目標）
讓同學重視實踐和原理的結合，圍繞OS的視角，結合編譯/組原等，深入地理解計算機軟硬件系統。


### 建議與要求

- 邏輯性和實驗相關性有折衷
- 內容有點分散
- 多核是否要加強和貫穿？
- ppt: 風格不一致 Latex, ppt, 統一：中文，用markdown [marp](https://marp.app/)
- 增加基於Linux的用戶態編程和程序展示
- 搭環境的過程，助教提供（文檔或視頻）
- 原則：與實驗一致，儘量不存在1.5次的情況， 比如 進程 + 調度 2次課， 1或2次課對應著1章，可以通過深入講解來確保上課時間用滿。
- 要加實驗（缺頁異常的處理） ，練習：各種置換算法 (模擬算法)
- 在合適的地方講解多核的內容(第8講開始)
- 左文字，右圖
- 每次課的知識點明確
- 加頁碼
- 標明出處（代碼，文檔，圖片等）
- rt-book-v3每章的練習要改
- 學生大概率會忘掉以前的講解（課後不會複習），所以在本次課開始之前，可以把上一次課回顧一下（大約10~15分鐘）。
- 課後練習（可能包括上課內容，不僅僅是實驗的內容）
### 評分

- 選擇1： 實驗一~~五：40% 期中+期末：60%
- 選擇2： 一個月內完成實驗一~~五：40% 擴展實驗（大實驗，課程設計）：60%

### 教學內容

下面的每一講大約是三個課時左右
#### 1. 操作系統概述

##### 知識點：操作系統的定義、操作系統結構、Linux的基本使用、Linux C應用編程

##### 基本內容

1. 課程概述&教學安排
1. 什麼是操作系統 定義/分類/抽象/特徵
1. 操作系統歷史演化
1. 操作系統結構
1. 實踐：UNIX/Linux類應用

##### 核心學習成效

 1. 掌握操作系統的定義：能從軟件角度、資源管理角度定義操作系統及其所屬範圍
 1. 掌握操作系統的抽象：理解進程、文件、地址空間的抽象對象以及與硬件關係
 1. 掌握操作系統的特徵：理解併發/並行、共享、虛擬化、異步的含義
 1. 掌握操作系統的歷史：理解單用戶系統、批處理系統、多道程序系統、分時系統、個人計算機、SMP系統、VMM系統、分佈式系統中的操作系統特徵
 1. 掌握操作系統的架構：理解簡單單體/分層單體/複雜單體/微/外/VMM kernel的特點
 1. 掌握 計算機硬件與操作系統的關係：理解硬件與操作系統之間的interface和各自的主要工作
 2. 掌握 應用與操作系統的關係：理解應用與操作系統之間的interface和各自的主要工作

##### 能力檢測方法

 1. 能分析硬件的哪些功能能夠給操作系統提供哪些支持
 1. 能對一個計算機系統中的軟硬件的特徵、區別、關係、運行狀態進行清晰判斷
 1. 對操作系統有一個完整的總體分析
 1. 能編寫/運行基本的UNIX類程序  
 1. 能在Linux環境下進行操作和編程
 1. 能夠完成 rt-v3::ch0的相關練習
#### 2. 實踐與實驗介紹

##### 知識點：計算機系統加電啟動過程；編譯與OS的關係；實驗環境

##### 基本內容
1. 實踐與實驗簡要分析（站在應用/OS的角度理解rt-v3）
   1. 庫級支持
   2. 批處理支持
   3. 多道程序與分時多任務
   4. 支持地址空間
   5. 支持文件系統
   6. 支持進程間通信
   7. 併發支持
   8. 管理I/O設備
2. Compiler與OS
   1. 通用的編譯
3. 硬件啟動與軟件啟動
4. 實踐：裸機程序 -- LibOS
   1. 基本環境搭建
   2. RV基本組成
   3. QEMU模擬器
   4. QEMU啟動
   5. 程序內存佈局
   6. 編譯流程

##### 核心學習成效
1. 理解操作系統實驗設計的基本思路
1. 理解操作系統提供的實驗要達到的基本目標
1. 理解函數調用的設計與執行細節
2. 理解編譯器與操作系統的共識
3. 理解硬件與操作系統的共識
4. 理解計算機加電後硬件和軟件的啟動過程
5. 理解程序的執行過程
6. 瞭解RV的SBI
7. 瞭解當前的OS各部分的聯繫與交互
##### 能力檢測方法

1. 能夠搭建實驗環境
2. 能夠Debug OS實例 
3. 能編寫裸機程序
4. 靈活應用目前掌握的操作系統知識解決裸機編程相關問題（功能、性能、安全性、便捷性等）
5. 能夠描述/分析 rt-v3::ch1的LibOS設計思路和實現的成效
6. 能夠完成 rt-v3::ch1的相關練習
#### 3. 基於特權級的隔離與批處理

##### 知識點：計算機的特權級/系統調用/異常、RV的特權級/系統調用/異常、批處理

##### 基本內容

1. 從 OS 角度看計算機系統
1. 從 OS 角度看RISC-V
1. 實踐：批處理操作系統
   1. 應用程序設計
   1. 加載應用程序
   1. 特權級切換
##### 核心學習成效
1. 理解特權級
2. 理解軟件如何面向特權級進行編程
3. 理解系統調用的概念、設計與實現、執行過程
4. 理解批處理操作系統的設計與實現
5. 理解程序/批處理操作系統的執行過程
6. 瞭解當前的OS各部分的聯繫與交互
##### 能力檢測方法

1. 描述基於RV硬件/和軟件協調實現系統調用
2. 分析RV中的異常與系統調用之間的關係
3. 分析並編程舉例如果不遵守特權級約束會產生的後果：異常
4. 靈活應用目前掌握的操作系統知識解決批處理/特權級相關問題（功能、性能、安全性、便捷性等）
5. 能夠描述/分析 rt-v3::ch2的Batch OS設計思路和實現的成效
6. 能夠完成 rt-v3::ch2的相關練習
#### 4. 多道程序與分時多任務
##### 知識點：中斷、上下文、任務/中斷上下文、任務/中斷上下文切換、任務/中斷上下文切換的時機、任務生命週期、任務執行過程
##### 基本內容
1. 相關背景與基本概念
   1. 多道程序概念
   2. 分時多任務概念
   3. 協作式調度
   4. 搶佔式調度
   5. 中斷處理
2. 實踐：多道程序與分時多任務操作系統
   1. 上下文切換
   2. 協作式調度
   3. 中斷機制
   4. 搶佔式調度
##### 核心學習成效
1. 從開發者/應用/操作系統的角度來理解：什麼是任務（進程的初級階段）
1. 理解任務生命週期的狀態轉換關係和時機
2. 理解任務切換的概念與任務切換的設計實現之間的關係和差異
3. 理解中斷和異常的區別和關係
4. 瞭解當前的OS各部分的聯繫與交互

##### 能力檢測方法
1. 靈活應用目前掌握的操作系統知識解決多道程序/分時多任務/任務切換相關問題（功能、性能、安全性、便捷性等）
2. 能夠描述/分析 rt-v3::ch3的Multiprog OS和TimeSharing OS設計思路和實現的成效
3. 能夠完成 rt-v3::ch3的相關練習
4. 能夠完成實驗一
#### 5. 地址空間-物理內存管理
##### 知識點：內存管理、連續物理內存分配、非連續物理內存分配
##### 基本內容
1. 地址空間
1. 計算機體系結構和內存層次
2. 內存分配
   1. 靜態內存分配
   2. 動態內存分配
   3. 連續內存分配
   4. 非連續內存分配
      1. 段式存儲管理
      2. 頁式存儲管理
      3. 段頁式存儲管理
3. 實踐：建立地址空間的操作系統
   1. 管理sv39多級頁表
   2. 內核與應用的地址空間
   3. 基於地址空間的分時多任務
4. 頁表自映射（option）
##### 核心學習成效
1. 理解地址空間的概念
2. 理解靜態內存分配與動態內存分配的區別與關係
3. 理解連續內存分配與不連續內存分配的區別與關係
4. 理解段式存儲管理的基本設計管理
5. 理解頁式存儲管理的基本設計、多級頁表、反置頁表
6. 基於RV，理解軟硬件協同實現頁式存儲
7. 瞭解當前的OS各部分的聯繫與交互
##### 能力檢測方法
1. 能描述虛擬內存、地址空間在概念和設計實現上的聯繫和差異
2. 能從不同角度（應用、內核、CPU）理解地址空間
3. 掌握不同的內存分配策略，並靈活應用
4. 能靈活掌握基於某種硬件頁機制，設計頁表，並掌握虛擬地址到物理地址的轉換過程
5. 能夠描述/分析 rt-v3::ch4的Address OS設計思路和實現的成效
6. 能夠完成 rt-v3::ch4的相關練習
7. 能夠完成實驗二
#### 6. 地址空間-虛擬存儲管理
##### 知識點：局部性原理、虛擬存儲基本概念、Page Fault異常、局部頁面置換算法、全局頁面置換算法、Belady異常
##### 基本內容
1. 虛擬存儲的基本概念
   1. 局部性原理
   2. 覆蓋和交換
   3. 虛擬頁式存儲
   4. RISC-V 缺頁異常
2. 頁面置換算法的概念
3. 局部頁面置換算法
   1. 最優算法、先進先出算法和最近最久未使用算法
   2. 時鐘置換算法和最不常用算法
   3. Belady現象和局部置換算法比較
4. 全局頁面置換算法
   1. 工作集置換算法
   2. 缺頁率置換算法

##### 核心學習成效
1. 理解虛擬存儲的基本概念和目標
2. 掌握如何結合Page Fault異常來設計實現虛擬存儲
3. 掌握各種局部頁面置換算法和全局頁面置換算法
4. 理解Belady異常，以及Belady異常與頁面置換算法的關係

##### 能力檢測方法
1. 掌握局部性原理
2. 採用覆蓋技術管理應用在有限內存上的內存配置
3. 採用交互技術管理應用換入換出
4. 理解虛擬存儲在RV上如何實現，以及虛擬存儲部分涉及到的OS基本運行過程
5. 能夠使用局部頁面置換算法和全局頁面置換算法來分析缺頁次數等
6. 掌握Page Fault異常出現後的軟硬件協同處理過程
7. 瞭解Copy on Write，Demanding Paging機制
8. 靈活應用目前掌握的操作系統知識解決虛擬存儲相關問題（功能、性能、安全性、便捷性等）
9. 能夠完成 rt-v3::ch4的相關練習
#### 7. 進程管理與單處理器調度
##### 知識點：進程概念、進程運行狀態、進程的管理、基本調度策略/算法
##### 基本內容
1. 進程管理
2. 單處理機調度
   1. 處理機調度概念
   2. 調度準則
   3. 調度算法
3. 實時調度
   1. 實時任務
   2. 實時調度算法 
   3. 優先級反置問題與解決方法
4. 實驗：進程管理
   1. 應用示例
   2. 進程的數據結構
   3. 進程管理機制的實現
##### 核心學習成效
1. 理解進程管理的核心繫統調用 fork, exec, exit, waitpid
2. 理解進程管理的核心數據結構和大致處理過程
3. 理解處理器調度各種調度算法
4. 理解實時調度算法
5. 理解優先級反轉問題和相應的解決方法
6. 瞭解當前的OS各部分的聯繫與交互
##### 能力檢測方法
1. 掌握進程管理的核心繫統調用 fork, exec, waitpid, wait
2. 能運用調度算法來分配處理器時間
3. 靈活應用目前掌握的操作系統知識解決進程管理相關問題（功能、性能、安全性、便捷性等） 
4. 能夠描述/分析 rt-v3::ch5的Process OS設計思路和實現的成效
5. 能夠完成rt-v3::ch5的相關練習
6. 能夠完成實驗三
#### 8. 多處理器調度
##### 知識點：多處理器調度策略/算法
##### 基本內容
1. 對稱多處理與多核架構
1. 多處理器調度策略
1. 多處理器調度機制
1. O(1) 調度（option）
1. CFS調度（option）
1. BFS調度算法（option）

##### 核心學習成效
1. 理解對稱多處理與多核架構
2. 理解操作系統如何管理對稱多處理與多核架構
3. 掌握多處理器調度與其中的負載遷移技術

##### 能力檢測方法
1. 理解多核架構對軟件的影響（好的方面，不好的方面）
2. 能運用多核調度算法來分配處理器時間
3. 瞭解RV硬件的多核啟動過程和軟件初始化過程
#### 9. 文件系統
##### 知識點：文件系統基本概念、文件組織、文件系統設計與實現
##### 基本內容
1. 文件系統概述
1. 文件系統接口
1. 文件系統實現(涉及 VFS)
1. 實驗：文件系統
   1. easyfs簡介
   1. 塊設備接口
   1. 塊緩衝層
   1. 磁盤佈局與管理
   1. 索引節點
   1. 在內核中接入easy-fs
1. 實例：進程文件系統 procfs（option）
##### 核心學習成效
1. 從不同的角度（應用、操作系統）理解文件系統
2. 文件系統的核心繫統調用
3. 典型文件系統的設計實現
4. 瞭解文件系統與OS其它部分的聯繫與交互
##### 能力檢測方法
1. 掌握文件系統的基本概念
2. 掌握文件系統的內部機制和組成
3. 能設計簡單的文件系統
4. 能夠描述應用發出文件系統相關係統調用後OS的處理過程
5. 靈活應用目前掌握的操作系統知識解決文件系統相關問題（功能、性能、安全性、便捷性等） 
6. 能夠描述/分析 rt-v3::ch6的Filesystem OS設計思路和實現的成效
7. 能夠完成rt-v3::ch6的相關練習
8. 能夠完成實驗四
#### 10. 進程間通信
##### 知識點： 信號、管道、消息隊列、共享內存、I/O重定向
##### 基本內容
1. 進程通信概念
1. 信號
1. 管道
1. 消息隊列
1. 共享內存
1. 實驗：進程間通信與I/O重定向
   1. 標準I/O
   1. 管道
   1. 命令行參數與I/O重定向
1. D-Bus機制（option）
1. Binder機制（option）
##### 核心學習成效
1. 理解進程--進程，進程--內核的通信機制和特點
2. 理解不同IPC機制的特徵和大致實現
3. 掌握I/O重定向
4. 瞭解IPC與OS其它部分的聯繫與交互
##### 能力檢測方法
1. 能描述不同IPC機制的大致實現
2. 能設計管道機制
3. 能描述I/O重定向的設計實現思路和運行過程
4. 靈活應用目前掌握的操作系統知識解決IPC相關問題（功能、性能、安全性、便捷性等） 
5. 能夠描述/分析 rt-v3::ch7的IPC OS設計思路和實現的成效
6. 能夠完成rt-v3::ch7的相關練習
#### 11. 線程與協程
##### 知識點：線程、協程
##### 基本內容
1. 線程與協程
   1. 線程
      1. 用戶線程、內核線程  
   2. 協程
   3. 協程、線程與進程的關係
2. 實踐：線程實現


##### 核心學習成效
1. 理解進程、線程，協程的概念
2. 理解進程、線程，協程的區別與聯繫
##### 能力檢測方法
1. 能夠在用戶態和內核態設計並實現線程管理
2. 靈活應用目前掌握的操作系統知識解決線程管理相關問題（功能、性能、安全性、便捷性等） 
3. 能夠完成rt-v3::ch8的相關練習
   
#### 12. 同步互斥
##### 知識點：基於軟件的同步互斥方法、基於硬件的同步互斥方法、信號量、管程、基於信號量/管程的經典同步問題、死鎖、死鎖的解決方法、優先級反置與解決方法
##### 基本內容
1. 同步互斥基本概念
   1. 現實生活中的同步互斥問題
   1. 臨界區
   1. 禁用硬件中斷
   1. 基於軟件的解決方法
1. 更高級的抽象方法
   1. 信號量
   2. 管程、條件變量
1. 同步互斥問題 
   1. 哲學家就餐問題（信號量/管程）
   2. 讀者-寫者問題（信號量/管程）
1. 死鎖
   1. 死鎖概念
      1. 死鎖的必要條件
   2. 死鎖處理方法
   3. 銀行家算法
   4. 死鎖檢測
2. 實踐：併發與同步互斥
   1. 鎖機制實現
   2. 信號量機制
   3. 條件變量機制
3. 併發錯誤檢測（option）
4.  同步互斥-RCU(option)
##### 核心學習成效
1. 理解同步互斥的基本概念
2. 掌握各種同步互斥的操作手段
3. 解決同步互斥問題
4. 理解死鎖概念
5. 掌握各種死鎖處理方法
6. 理解各種死鎖處理方法的侷限性
7. 瞭解當前的OS各部分的聯繫與交互

##### 能力檢測方法
1. 能夠採用不同的同步互斥手段（基於軟件的方法、信號量、條件變量、禁用中斷等）靈活解決各種同步互斥問題
2. 能應用銀行家算法
3. 掌握如何進行死鎖檢測
4. 靈活應用目前掌握的操作系統知識解決同步互斥/死鎖相關問題（功能、性能、安全性、便捷性等）
5. 能夠描述/分析 rt-v3::ch8的SyncMutex OS設計思路和實現的成效
6. 能夠完成rt-v3::ch8的相關練習
7. 能夠完成實驗五
#### 13. I/O設備管理
##### 知識點：I/O抽象、I/O特徵、DMA/Interrupt/輪詢機制、同步I/O、異步I/O
##### 基本內容
1. 設備概述
1. 設備抽象
1. 設備執行模型
1. 實驗：I/O設備管理
   1. 外設平臺
   1. 串口驅動
   1. virtio設備驅動
##### 核心學習成效
1. 理解設備的分類和特點
2. 理解設備的各種抽象形式
3. 理解設備執行模型（同步，異步....）
4. 掌握設備驅動的設計與實現
5. 掌握OS與外設的交互過程
6. 瞭解當前的OS各部分的聯繫與交互
##### 能力檢測方法
1. 能描述OS與外設的交互過程
2. 能編寫應用程序來與設備進行交互
3. 能編寫簡單的設備驅動程序（如uart等）
4. 靈活應用目前掌握的操作系統知識解決設備相關問題（功能、性能、安全性、便捷性等）
5. 能夠完成rt-v3::ch9的相關練習
#### 14. 擴展主題（可選項：可靠文件系統，多核優化，高級語言支持，請外校專家講）
##### 知識點： 基於日誌的文件系統設計
##### 基本內容
OPTION1:可靠文件系統主題：

1. 系統可靠性概述
1. 基於日誌的文件系統
2. 實際文件習題
   1. FAT文件系統（option）
   2. EXT4文件系統（option）
   3. NTFS（option）
   4. Zettabyte File System (ZFS)（option）
   5. 數據庫文件系統（option）

##### 核心學習成效

##### 能力檢測方法
### 教學實驗

- 做大實驗的同學，基於2021秋季學期的基礎實驗在1個月內完成後，可選擇繼續大實驗，否則與其他同學一起，完成2022春季實驗。


#### 實驗一：操作系統的基本支持

覆蓋：1/2/3章

知識點：計算機/OS啟動、特權級切換、系統調用、應用程序/庫/內核的關係、特權級相關異常、任務切換

##### 用戶態
- 顯示目錄文件名 
    - 實現一個Linux應用程序ls，能顯示當前目錄中的文件。
- 顯示調用棧 
    - 實現一個linux應用程序，能打印出調用棧信息
- 顯示目錄信息
- 睡眠
    - 實現一個rcore應用程序，用sleep系統調用睡眠一段時間（in rcore tutorial v3 Branch 2022spring）
  
     

##### 內核態
- 顯示調用棧
    - 實現裸機程序，能打印調用棧
- 實現新系統調用get_taskinfo
    - 增加get_taskinfo系統調用，能顯示task的id和task name
- 統計系統調用
   - 實現內核擴展，能夠統計應用執行過程中系統調用編號和次數
- 統計時間
  - 實現內核擴展，能夠統計應用執行的完成時間
- 分析異常
  - 統計執行異常的程序的異常情況說明（主要是各種特權級涉及的異常）
  - 能夠打印異常程序的調用棧
#### 實驗二：地址空間

覆蓋：4章

知識點：地址空間、應用與內核之間在不同地址空間的數據交互/控制交互、內存/地址相關異常（如缺頁異常）

##### 用戶態
- linux應用訪問內存相關係統調用
  - 使用sbrk，mmap,munmap,mprotect系統調用 
##### 內核態

- 改進系統調用sys_get_time
   - 引入虛存機制後，原來內核的 sys_get_time 函數實現就無效了。請你重寫這個函數，恢復其正常功能。
- 實現新系統調用mmap, munmap
   - 請實現 mmap 和 munmap 系統調用
- 實現新系統調用sbrk
   - 請實現 sbrk系統調用

#### 實驗三：進程管理與調度

覆蓋：5章

知識點：進程管理的關聯性和必要性、調度算法

##### 用戶態
- 實現一個與進程管理相關的linux應用程序
  - 能用nice,fork,exec,spawn等系統調用
##### 內核態
- 實現新系統調用 spawn
- 實現一個調度算法-如：stride

#### 實驗四：文件系統與進程間通信

覆蓋：6，7章

知識點：文件系統的實現、進程間通信機制

##### 用戶態
- 實現一個應用程序能體現文件/進程間通信的特點
 
##### 內核態
- 擴展文件系統功能
   - 擴大單個文件的大小
      - 支持三重間接inode
   - 擴展mmap系統調用，支持對文件的映射
      - 這樣對內存讀寫，其實就是對文件讀寫
   - 支持crash一致性（hard）
     -  擴展log fs
- 實現一個文件相關係統調用相關
   - 實現硬鏈接相關係統調用
   - 實現創建目錄的系統調用
- 實現一個新的重定向能力
   - 實現共享內存
#### 實驗五：同步互斥
覆蓋：8章

知識點：線程，同步互斥的機制，解決同步互斥問題，死鎖，優先級反轉問題。
##### 用戶態
- 實現一個Linux線程應用程序能體現線程屬性和線程間同步互斥的特點
  - 使用了pthread_* 系統調用
##### 內核態

- 擴展內核功能：內核線程
  -  在內核中支持內核線程
- 在內核線程中支持同步互斥機制
  - 實現內核線程用的mutex, semaphore, cond-var
- 擴展內核功能：多核支持
  - 擴展rcore-tutorial-v3運行在多核系統中 
- 用銀行家算法解決死鎖問題
  - 設計某種資源申請導致死鎖的例子
  - 設計銀行家算法來避免死鎖問題
- 解決優先級反轉問題
  - 實現RM實時調度算法
  - 設計優先級反轉的實例
  - 實現優先級天花板和優先級繼承方法 


#### 擴展實驗 （即大實驗，課程設計）

（一個月完成實驗1~5後，可選擇完成擴展實驗來代替考試）

實現新feature的支持(遊戲等)

涉及：參加比賽、支持多核、支持設備驅動、支持樹莓派/SiFive等（與老師協商）
