# 虛擬化作業1

- 假設在Virtualizable硬件上使用Trap-and-Emulate方法實現CPU虛擬化。

  1. 請描述VM內的用戶態進程執行System Call被VM內核處理並返回的全過程。

     > 1. 第一步是Trap，捕捉所有的系統ISA並陷入
     > 2. 第二步是Emulate，由具體指令實現相應虛擬化，控制虛擬處理器、虛擬內存、虛擬設備的行為
     > 3. 第三步回到虛擬機繼續執行

  2. 進程內執行Fork Bomb是否會大量增加VMM的線程並大量消耗VMM的資源？

     > 不會，分配給VM的內存是一定的，Fork Bomb最多將分配給VM的內存用完



- 假設有一臺支持Intel VT-x和8個物理CPU的服務器，在其上運行1個VMM和10個VM，每個虛擬機有4個vCPU。若該VMM使用了VT-x硬件虛擬化，需要創建多少線程為這些VM服務（只考慮CPU虛擬化）？總共需要創建多少個VMCS？

  > 每個vCPU相當於一個線程，所以應該創建10*4=40個線程為這些VM服務
  >
  > 同時每個vCPU對應於一個VMCS，所以需要創建40個VMCS



- ARM v8.0的硬件虛擬化機制為Type-1 VMM所設計，當直接在EL2內運行Type-2 VMM（如KVM）時會存在一些問題。請具體解釋會造成哪些問題？為此，KVM/ARM提出了什麼樣的解決方案？該方案是否存在VM Exit處理路徑上的性能問題？

  > A1：由於Linux在設計時被假設運行在EL1，因此它只能使用EL1下的系統寄存器，但這些系統寄存器在EL2並不存在。
  >
  > A2：在ARM v8.0中，KVM的一部分功能被從Linux中剝離出來，以LowVisor的形式運行在EL2中
  >
  > A3：存在性能上的問題，可能會造成KVM和Lowvisor見多次特權級的切換，會對虛擬機的運行性能帶來一定的開銷



- 假設使用影子頁表機制實現內存虛擬化。現有10個虛擬機，每個虛擬機內有10個進程，VMM總共需要創建多少個影子頁表？

  > 影子頁表機制維護了GVA->HPA的映射，需要為每一個進程維護相應的影子頁表，也需要為內核維護單獨的影子頁表，因此需要創建10*(10+1)=110個影子頁表