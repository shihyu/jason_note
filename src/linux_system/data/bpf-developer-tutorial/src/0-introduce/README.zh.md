# eBPF 示例教程 0：核心概念與工具簡介

這是一個全面的 eBPF 開發教程的第一部分，旨在通過實用的 eBPF 開發指導您從初學者到高級用戶。它涵蓋了基本概念、實際代碼示例以及在現代系統中的應用。我們將不再專注於傳統工具如 BCC，而是使用現代框架如 `libbpf`、`Cilium`、`libbpf-rs` 和 eunomia-bpf，並提供 `C`、`Go` 和 `Rust` 的示例。

本教程的主要目標是提供清晰簡潔的 eBPF 工具示例（起步只需 20 行代碼！），幫助開發者快速掌握基本的 eBPF 開發技術。每個示例都是獨立的，可以在目錄結構中找到，每個目錄代表一個獨立的 eBPF 工具。您還可以訪問我們的教程代碼倉庫 <https://github.com/eunomia-bpf/bpf-developer-tutorial> 或網站 <https://eunomia.dev/tutorials/> 獲取更多示例和完整的教程源代碼。

## eBPF 簡介：安全高效的內核擴展

eBPF（擴展的 Berkeley Packet Filter）是一項突破性的技術，允許開發者在內核空間中安全高效地運行小型程序。與傳統方法需要修改內核源代碼或加載新模塊不同，eBPF 使得動態定製和優化網絡行為成為可能，且不會中斷系統操作。這種靈活性和高效性使 eBPF 成為克服傳統網絡棧限制的關鍵技術。

### eBPF 的強大之處是什麼？

- **直接內核交互**：eBPF 程序在內核中執行，與系統級事件如網絡包、系統調用或追蹤點交互。
- **安全執行**：eBPF 通過驗證器在程序運行前檢查其邏輯，防止潛在的內核崩潰或安全漏洞。
- **最低開銷**：eBPF 通過使用即時編譯器（JIT），將 eBPF 字節碼轉換為針對特定架構的優化機器碼，實現近原生執行速度。

## eBPF：過去、現在與未來

### 過去：可編程網絡的變革

eBPF 於 2014 年推出，徹底改變了開發者處理網絡的方式，允許小型可編程內核空間應用程序實時處理數據包。通過鉤住關鍵內核點，eBPF 使得在網絡包到達時應用自定義邏輯成為可能，從而提高了效率和靈活性。這使得組織能夠在不需要自定義驅動程序或修改內核的情況下定製網絡行為，為雲原生和數據中心環境創造了理想的解決方案。

### 現在：滿足現代計算需求的多功能框架

eBPF 已發展為一個多功能框架，超越了其最初的網絡用途，現在涵蓋了可觀測性、追蹤、安全性，甚至系統資源管理。eBPF 程序可以動態鉤住內核事件，賦予開發者精確控制系統行為和性能優化的能力，而無需修改內核或重啟系統。這使得 eBPF 成為系統管理員和開發者監控、優化和保護環境的必備工具。

以下是 eBPF 目前廣泛應用的一些關鍵領域：

- **網絡**：eBPF 提供內核中實時、高速的數據包過濾和處理，允許創建自定義協議解析器和網絡策略，無需新驅動程序或系統重啟。這在雲和數據中心環境中實現了高效的網絡管理。
  
- **可觀測性**：eBPF 使開發者能夠通過收集自定義指標和執行內核級數據聚合來深入瞭解系統行為。通過利用內核追蹤點和函數調用，eBPF 有助於識別性能問題和定位難以發現的錯誤。
  
- **追蹤與分析**：eBPF 提供強大的追蹤和分析能力，通過附加到內核函數、追蹤點甚至用戶空間探針，使開發者能夠深入瞭解系統和應用程序的行為，從而優化性能和解決複雜的系統問題。
  
- **安全**：eBPF 在實時安全監控中發揮重要作用。它能夠深入檢查系統調用、網絡流量和其他內核活動，幫助執行動態安全策略和檢測異常行為，為基礎設施提供高效的保護。
  
- **調度器優化**：eBPF 越來越多地用於增強 CPU 調度，能夠監控 CPU 負載並優化任務在核心之間的分配。這可以更有效地利用 CPU 資源，提高系統響應能力。
  
- **HID（人機接口設備）驅動增強**：開發者使用 eBPF 優化鍵盤、鼠標和觸摸屏等設備的 HID 驅動程序。通過為處理輸入事件添加自定義邏輯，eBPF 提高了對延遲敏感應用的響應速度。

各行業組織已大規模採用 eBPF：

- **Google**：使用 eBPF 進行安全審計、數據包處理、實時性能監控以及優化其龐大基礎設施的 CPU 調度。
- **Netflix**：利用 eBPF 進行網絡流量分析，確保流媒體服務的高可用性和性能。
- **Android**：應用 eBPF 優化網絡使用、功耗和資源分配，提升數百萬設備的性能和電池壽命。
- **S&P Global**：通過 **Cilium** 使用 eBPF 管理跨多個雲和本地系統的網絡，確保可擴展性和安全性。
- **Shopify**：與 **Falco** 一起實施 eBPF 進行入侵檢測，增強其電子商務平臺的安全性。
- **Cloudflare**：使用 eBPF 進行網絡可觀測性、安全監控和性能優化，保護全球數百萬網站。

eBPF 能夠動態調整系統行為並擴展到用戶空間，使其成為現代計算不可或缺的技術。無論是優化網絡流量、提升安全性，還是增強系統性能，eBPF 都能幫助開發者高效、安全地應對實時需求。

除了其內核模式運行時，eBPF 還可以擴展到用戶空間。例如，[bpftime](https://github.com/eunomia-bpf/bpftime) 是一個用戶空間 eBPF 運行時，允許在用戶空間應用中進行高性能追蹤、性能分析和插件支持。這種 eBPF 向用戶空間的擴展有助於在各種超越內核級任務的用例中提高靈活性和性能。

### 未來：eBPF 的擴展潛力

展望未來，預計 eBPF 將成為操作系統更為重要的一部分。重點將放在提升其靈活性、模塊化和易用性上，使其能夠應用於更廣泛的場景。內存管理、併發機制的創新以及與用戶空間應用的更好集成已在路上。已經有項目在編譯 Linux 內核的關鍵部分到 BPF 指令集，這可能徹底改變內核開發和分析的方式。

動態棧、更好的用戶空間可觀測性工具（例如快速 Uprobes 和特定語言的棧行走器）以及更安全的程序終止機制等進展將繼續增強 eBPF 的可靠性並擴展其使用場景。此外，新工具和庫將簡化 eBPF 開發，降低內核和應用開發者的入門門檻。

## 開始學習教程

本教程提供實用的 eBPF 開發實踐，涵蓋從初級到高級的主題。我們專注於在可觀測性、網絡和安全等領域的動手示例，使用 `libbpf`、`libbpf-rs` 和 `eunomia-bpf` 等框架，並提供 C、Go 和 Rust 的示例。

### 本教程適合誰？

- **開發者** 希望實現自定義內核解決方案。
- **系統管理員** 旨在提升性能和安全性。
- **技術愛好者** 探索前沿的內核技術。

### 你將學到什麼？

- **核心概念**：eBPF 基礎知識及其與 Linux 內核的集成。
- **實用技能**：編寫和部署 eBPF 程序。
- **高級主題**：探索 eBPF 在安全、追蹤和未來創新方面的應用。

---

## 目錄

1. **eBPF 簡介**  
   基本概念和入門所需的工具。
   
2. **初學者示例**  
   簡單的程序，如“Hello World”及使用 kprobe 和 uprobe 進行基礎追蹤。
   
3. **可觀測性**  
   側重於使用 eBPF 監控網絡流量、文件操作和進程行為的示例。
   
4. **網絡**  
   側重於修改和優化網絡流量的示例，如 XDP、TC 和 socket。
   
5. **安全**  
   用於隱藏進程和文件、發送信號殺死進程以及跟蹤進程事件以增強安全性的程序。
   
6. **高級用例**  
   涉及性能分析、調度器優化和用戶空間 eBPF（如 bpftime）的複雜示例。
   
7. **深入主題**  
   探索 eBPF 在 Android 上的應用、使用 eBPF 進行網絡加速以及通過系統調用修改來保護系統。

## 如何使用 eBPF 編程

從頭編寫 eBPF 程序可能較為複雜。為簡化這一過程，LLVM 於 2015 年引入了將高級語言代碼編譯為 eBPF 字節碼的能力。自那時起，eBPF 社區構建了像 `libbpf` 這樣的庫來管理這些程序。這些庫幫助將 eBPF 字節碼加載到內核中並執行基本任務。Linux 內核源代碼中 `samples/bpf/` 目錄包含了眾多 eBPF 示例。

典型的 eBPF 程序包含兩個部分：內核空間代碼（`*_kern.c`）和用戶空間代碼（`*_user.c`）。內核空間代碼定義邏輯，而用戶空間代碼負責加載和與內核交互。然而，像 `libbpf-bootstrap` 和 Go eBPF 庫這樣的工具簡化了這一過程，允許一次性編譯和更容易的開發。

### eBPF 開發工具

- **BCC**：一個基於 Python 的工具鏈，簡化了 eBPF 程序的編寫、編譯和加載。它提供了許多預構建的追蹤工具，但在依賴和兼容性方面存在一些限制。
- **eBPF Go 庫**：一個 Go 庫，解耦了獲取 eBPF 字節碼的過程與加載和管理 eBPF 程序的過程。
- **libbpf-bootstrap**：基於 `libbpf` 的現代腳手架，提供了高效的工作流用於編寫 eBPF 程序，提供簡單的一次性編譯過程以生成可重用的字節碼。
- **eunomia-bpf**：一個用於編寫僅包含內核空間代碼的 eBPF 程序的工具鏈。它通過動態加載 eBPF 程序簡化了 eBPF 程序的開發。

這些工具有助於減少開發 eBPF 程序的複雜性，使開發者更容易優化系統性能、安全性和可觀測性。

## 學習 eBPF 開發的一些技巧

本文不會提供更詳細的 eBPF 原理介紹，但以下是一個學習計劃和參考資料，可能對您有幫助：

### eBPF 簡介（5-7 小時）

- 使用 Google 或其他搜索引擎搜索：eBPF
- 詢問類似 ChatGPT 的工具：什麼是 eBPF？

推薦：

- 閱讀 eBPF 介紹：<https://ebpf.io/> （30 分鐘）
- 簡要了解 eBPF 內核相關文檔：<https://docs.ebpf.io/> （瞭解技術細節的查詢來源，30 分鐘）

回答三個問題：

1. 瞭解 eBPF 是什麼？我們為什麼需要它？難道不能使用內核模塊嗎？
2. 它有哪些功能？它在 Linux 內核中能做什麼？eBPF 程序和助手函數有哪些類型（不需要全部瞭解，但需要知道在哪裡查找）？
3. 它能用於哪些場景？例如，可以在哪些情況下使用？網絡、安全、可觀測性？

### 理解如何開發 eBPF 程序（10-15 小時）

瞭解並嘗試 eBPF 開發框架：

- bpftrace 教程：<https://eunomia.dev/tutorials/bpftrace-tutorial/> （嘗試，1 小時）
- 使用 BCC 開發各種工具的示例：<https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md> （運行，3-4 小時）
- libbpf 的一些示例：<https://github.com/libbpf/libbpf-bootstrap> （運行任何有趣的示例並閱讀源代碼，2 小時）
- 教程：<https://github.com/eunomia-bpf/bpf-developer-tutorial> （閱讀第 1-10 部分，3-4 小時）

其他開發框架：Go 或 Rust 語言，請自行搜索和嘗試（0-2 小時）

如果有問題或想了解的內容，無論是否與本項目相關，都可以在該項目的討論區開始討論。

回答一些問題並嘗試一些實驗（2-5 小時）：

1. 如何開發最簡單的 eBPF 程序？
2. 如何使用 eBPF 追蹤內核功能或函數？有很多方法，提供相應的代碼示例；
3. 用戶模式和內核模式之間的通信解決方案有哪些？如何將信息從用戶模式發送到內核模式？如何將信息從內核模式傳遞到用戶模式？提供代碼示例；
4. 編寫您自己的 eBPF 程序以實現某個功能；
5. 在 eBPF 程序的整個生命週期中，用戶模式和內核模式分別做了什麼？

## 參考資料

- eBPF 介紹：<https://ebpf.io/>
- BPF 編譯器集合（BCC）：<https://github.com/iovisor/bcc>
- eunomia-bpf：<https://github.com/eunomia-bpf/eunomia-bpf>

您還可以訪問我們的教程代碼倉庫 <https://github.com/eunomia-bpf/bpf-developer-tutorial> 或網站 <https://eunomia.dev/tutorials/> 獲取更多示例和完整的教程源代碼。所有內容均為開源。我們將繼續分享更多關於 eBPF 開發實踐的內容，幫助您更好地理解和掌握 eBPF 技術。