# 5.2 ping 的工作原理


在日常生活或工作中，我們在判斷與對方**網絡是否暢通**，使用的最多的莫過於 `ping` 命令了。

“**那你知道 `ping` 是如何工作的嗎？**” —— 來自小林的靈魂拷問

可能有的小夥伴奇怪的問：“我雖然不明白它的工作，但 ping 我也用的賊 6 啊！”

你用的是 6 ，但你在面試官面前，你就 6 不起來了，畢竟他們也愛問。

所以，我們要抱有「**知其然，知其所以然**」的態度，這樣就能避免面試過程中，出門右拐的情況了。

![來自面試官的靈魂拷問](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/2.jpg)

不知道的小夥伴也沒關係，今天我們就來搞定它，搞懂它。消除本次的問號，**讓問號少一點**。

![](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/3.jpg)

----

## IP協議的助手 —— ICMP 協議

ping 是基於 `ICMP` 協議工作的，所以要明白 ping 的工作，首先我們先來熟悉 **ICMP 協議**。

> ICMP 是什麼？

ICMP 全稱是 **Internet Control Message Protocol**，也就是**互聯網控制報文協議**。

裡面有個關鍵詞 —— **控制**，如何控制的呢？

網絡包在複雜的網絡傳輸環境裡，常常會遇到各種問題。當遇到問題的時候，總不能死的不明不白，沒頭沒腦的作風不是計算機網絡的風格。所以需要傳出消息，報告遇到了什麼問題，這樣才可以調整傳輸策略，以此來控制整個局面。

> ICMP 功能都有啥？

`ICMP` 主要的功能包括：**確認 IP 包是否成功送達目標地址、報告發送過程中 IP 包被廢棄的原因和改善網絡設置等。**

在 `IP` 通信中如果某個 `IP` 包因為某種原因未能達到目標地址，那麼這個具體的原因將**由 ICMP 負責通知**。

![ICMP 目標不可達消息](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/4.jpg)

如上圖例子，主機 `A` 向主機 `B` 發送了數據包，由於某種原因，途中的路由器 `2` 未能發現主機 `B` 的存在，這時，路由器 `2` 就會向主機 `A` 發送一個 `ICMP` 目標不可達數據包，說明發往主機 `B` 的包未能成功。

ICMP 的這種通知消息會使用 `IP` 進行發送 。

因此，從路由器 `2` 返回的 ICMP 包會按照往常的路由控制先經過路由器 `1` 再轉發給主機 `A` 。收到該 ICMP 包的主機 `A` 則分解 ICMP 的首部和數據域以後得知具體發生問題的原因。

> ICMP 包頭格式

ICMP 報文是封裝在 IP 包裡面，它工作在網絡層，是 IP 協議的助手。

![ICMP 報文](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/5.jpg)

ICMP 包頭的**類型**字段，大致可以分為兩大類：

- 一類是用於診斷的查詢消息，也就是「**查詢報文類型**」
- 另一類是通知出錯原因的錯誤消息，也就是「**差錯報文類型**」

![常見的 ICMP 類型](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/6.jpg)


## 查詢報文類型

> 回送消息 —— 類型 `0` 和 `8`

**回送消息**用於進行通信的主機或路由器之間，判斷所發送的數據包是否已經成功到達對端的一種消息，`ping` 命令就是利用這個消息實現的。

![ICMP 回送消息](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/7.jpg)

可以向對端主機發送**回送請求**的消息（`ICMP Echo Request Message`，類型 `8`），也可以接收對端主機發回來的**回送應答**消息（`ICMP Echo Reply Message`，類型 `0`）。

![ICMP 回送請求和回送應答報文](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/8.jpg)

相比原生的 ICMP，這裡多了兩個字段：

- **標識符**：用以區分是哪個應用程序發 ICMP 包，比如用進程 `PID` 作為標識符；
- **序號**：序列號從 `0` 開始，每發送一次新的回送請求就會加 `1`， 可以用來確認網絡包是否有丟失。

在**選項數據**中，`ping` 還會存放發送請求的時間值，來計算往返時間，說明路程的長短。


## 差錯報文類型

接下來，說明幾個常用的 ICMP 差錯報文的例子：

- 目標不可達消息 —— 類型 為 `3`
- 原點抑制消息 —— 類型 `4`
- 重定向消息 —— 類型 `5`
- 超時消息 —— 類型 `11`


> 目標不可達消息（Destination Unreachable Message） —— 類型為 `3`

IP 路由器無法將 IP 數據包發送給目標地址時，會給發送端主機返回一個**目標不可達**的 ICMP 消息，並在這個消息中顯示不可達的具體原因，原因記錄在 ICMP 包頭的**代碼**字段。

由此，根據 ICMP 不可達的具體消息，發送端主機也就可以瞭解此次發送**不可達的具體原因**。

舉例 6 種常見的目標不可達類型的**代碼**：

![目標不可達類型的常見代碼號](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/9.jpg)

- 網絡不可達代碼為 `0`
- 主機不可達代碼為 `1`
- 協議不可達代碼為 `2`
- 端口不可達代碼為 `3`
- 需要進行分片但設置了不分片位代碼為 `4`


為了給大家說清楚上面的目標不可達的原因，**小林犧牲自己給大家送 5 次外賣。**

為什麼要送外賣？別問，問就是為 `35` 歲的老林做準備 ...

![外賣員 —— 小林](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/10.jpg)

#### a. 網絡不可達代碼為 0

*外賣版本：*

小林第一次送外賣時，小區裡只有 A 和 B 區兩棟樓，但送餐地址寫的是 C 區樓，小林表示頭上很多問號，壓根就沒這個地方。

*正常版本：*

IP 地址是分為網絡號和主機號的，所以當路由器中的路由器表匹配不到接收方 IP 的網絡號，就通過 ICMP 協議以**網絡不可達**（`Network Unreachable`）的原因告知主機。

自從不再有網絡分類以後，網絡不可達也漸漸不再使用了。


####  b. 主機不可達代碼為 1

*外賣版本：*

小林第二次送外賣時，這次小區有 5 層樓高的 C 區樓了，找到地方了，但送餐地址寫的是 C 區樓 601 號房 ，說明找不到這個房間。

*正常版本：*

當路由表中沒有該主機的信息，或者該主機沒有連接到網絡，那麼會通過 ICMP 協議以**主機不可達**（`Host Unreachable`）的原因告知主機。

#### c. 協議不可達代碼為 2

*外賣版本：*

小林第三次送外賣時，這次小區有 C 區樓，也有 601 號房，找到地方了，也找到房間了，但是一開門人家是外國人說的是英語，我說的是中文！語言不通，外賣送達失敗~

*正常版本：*

當主機使用 TCP 協議訪問對端主機時，能找到對端的主機了，可是對端主機的防火牆已經禁止 TCP 協議訪問，那麼會通過 ICMP 協議以**協議不可達**的原因告知主機。

#### d. 端口不可達代碼為 3

*外賣版本：*

小林第四次送外賣時，這次小區有 C 區樓，也有 601 號房，找到地方了，也找到房間了，房間裡的人也是說中文的人了，但是人家說他要的不是外賣，而是快遞。。。

*正常版本：*

當主機訪問對端主機 8080 端口時，這次能找到對端主機了，防火牆也沒有限制，可是發現對端主機沒有進程監聽 8080 端口，那麼會通過 ICMP 協議以**端口不可達**的原因告知主機。

####  e. 需要進行分片但設置了不分片位代碼為 4

*外賣版本：*

小林第五次送外賣時，這次是個吃播博主點了 100 份外賣，但是吃播博主要求一次性要把全部外賣送達，小林的一臺電動車裝不下呀，這樣就沒辦法送達了。

*正常版本：*

發送端主機發送 IP 數據報時，將 IP 首部的**分片禁止標誌位**設置為`1`。根據這個標誌位，途中的路由器遇到超過 MTU 大小的數據包時，不會進行分片，而是直接拋棄。

隨後，通過一個 ICMP 的不可達消息類型，**代碼為 4** 的報文，告知發送端主機。


> 原點抑制消息（ICMP Source Quench Message） —— 類型 `4`

在使用低速廣域線路的情況下，連接 WAN 的路由器可能會遇到網絡擁堵的問題。

`ICMP` 原點抑制消息的目的就是**為了緩和這種擁堵情況**。

當路由器向低速線路發送數據時，其發送隊列的緩存變為零而無法發送出去時，可以向 IP 包的源地址發送一個 ICMP **原點抑制消息**。

收到這個消息的主機藉此瞭解在整個線路的某一處發生了擁堵的情況，從而增大 IP 包的傳輸間隔，減少網絡擁堵的情況。

然而，由於這種 ICMP 可能會引起不公平的網絡通信，一般不被使用。

> 重定向消息（ICMP Redirect Message） —— 類型 `5`

如果路由器發現發送端主機使用了「不是最優」的路徑發送數據，那麼它會返回一個 ICMP **重定向消息**給這個主機。

在這個消息中包含了**最合適的路由信息和源數據**。這主要發生在路由器持有更好的路由信息的情況下。路由器會通過這樣的 ICMP 消息告知發送端，讓它下次發給另外一個路由器。

好比，小林本可以過條馬路就能到的地方，但小林不知道，所以繞了一圈才到，後面小林知道後，下次小林就不會那麼**傻**再繞一圈了。

> 超時消息（ICMP Time Exceeded Message） —— 類型 `11`

IP 包中有一個字段叫做 `TTL` （`Time To Live`，生存週期），它的**值隨著每經過一次路由器就會減 1，直到減到 0 時該 IP 包會被丟棄。**

此時，路由器將會發送一個 ICMP **超時消息**給發送端主機，並通知該包已被丟棄。

設置 IP 包生存週期的主要目的，是為了在路由控制遇到問題發生循環狀況時，避免 IP 包無休止地在網絡上被轉發。

![ICMP 時間超過消息](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/11.jpg)

此外，有時可以用 TTL 控制包的到達範圍，例如設置一個**較小的 TTL 值**。

----


## ping —— 查詢報文類型的使用

接下來，我們重點來看 `ping` 的**發送和接收過程**。

同個子網下的主機 A 和 主機 B，主機 A 執行`ping` 主機 B 後，我們來看看其間發送了什麼？

![主機 A ping 主機 B](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/12.jpg)

ping 命令執行的時候，源主機首先會構建一個 **ICMP 回送請求消息**數據包。

ICMP 數據包內包含多個字段，最重要的是兩個：

- 第一個是**類型**，對於回送請求消息而言該字段為 `8`；
- 另外一個是**序號**，主要用於區分連續 ping 的時候發出的多個數據包。

每發出一個請求數據包，序號會自動加 `1`。為了能夠計算往返時間 `RTT`，它會在報文的數據部分插入發送時間。

![主機 A 的 ICMP 回送請求報文](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/13.jpg)

然後，由 ICMP 協議將這個數據包連同地址 192.168.1.2 一起交給 IP 層。IP 層將以 192.168.1.2 作為**目的地址**，本機 IP 地址作為**源地址**，**協議**字段設置為 `1` 表示是 `ICMP` 協議，再加上一些其他控制信息，構建一個 `IP` 數據包。

![主機 A 的 IP 層數據包](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/14.jpg)

接下來，需要加入 `MAC` 頭。如果在本地 ARP 映射表中查找出 IP 地址 192.168.1.2 所對應的 MAC 地址，則可以直接使用；如果沒有，則需要發送 `ARP` 協議查詢 MAC 地址，獲得 MAC 地址後，由數據鏈路層構建一個數據幀，目的地址是 IP 層傳過來的 MAC 地址，源地址則是本機的 MAC 地址；還要附加上一些控制信息，依據以太網的介質訪問規則，將它們傳送出去。

![主機 A 的 MAC 層數據包](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/15.jpg)

主機 `B` 收到這個數據幀後，先檢查它的目的 MAC 地址，並和本機的 MAC 地址對比，如符合，則接收，否則就丟棄。

接收後檢查該數據幀，將 IP 數據包從幀中提取出來，交給本機的 IP 層。同樣，IP 層檢查後，將有用的信息提取後交給 ICMP 協議。

主機 `B` 會構建一個 **ICMP 回送響應消息**數據包，回送響應數據包的**類型**字段為 `0`，**序號**為接收到的請求數據包中的序號，然後再發送出去給主機 A。

![主機 B 的 ICMP 回送響應報文](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/16.jpg)

在規定的時候間內，源主機如果沒有接到 ICMP 的應答包，則說明目標主機不可達；如果接收到了 ICMP 回送響應消息，則說明目標主機可達。

此時，源主機會檢查，用當前時刻減去該數據包最初從源主機上發出的時刻，就是 ICMP 數據包的時間延遲。

針對上面發送的事情，總結成了如下圖：

![主機 A ping 主機 B 期間發送的事情](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/17.png)

當然這只是最簡單的，同一個局域網裡面的情況。如果跨網段的話，還會涉及網關的轉發、路由器的轉發等等。

但是對於 ICMP 的頭來講，是沒什麼影響的。會影響的是根據目標 IP 地址，選擇路由的下一跳，還有每經過一個路由器到達一個新的局域網，需要換 MAC 頭裡面的 MAC 地址。

說了這麼多，可以看出 ping 這個程序是**使用了 ICMP 裡面的 ECHO REQUEST（類型為 8 ） 和 ECHO REPLY （類型為 0）**。


## traceroute —— 差錯報文類型的使用

有一款充分利用 ICMP **差錯報文類型**的應用叫做 `traceroute`（在UNIX、MacOS中是這個命令，而在Windows中對等的命令叫做 tracert ）。 

*1. traceroute 作用一*

traceroute 的第一個作用就是**故意設置特殊的 TTL，來追蹤去往目的地時沿途經過的路由器。**

traceroute 的參數指向某個**目的 IP 地址**：

```bash
traceroute 192.168.1.100
```

> 這個作用是如何工作的呢？

它的原理就是利用 IP 包的**生存期限** 從 `1` 開始按照順序遞增的同時發送 **UDP 包**，強制接收 **ICMP 超時消息**的一種方法。

比如，將 TTL 設置 為 `1`，則遇到第一個路由器，就犧牲了，接著返回 ICMP 差錯報文網絡包，類型是**時間超時**。

接下來將 TTL 設置為 `2`，第一個路由器過了，遇到第二個路由器也犧牲了，也同時返回了 ICMP 差錯報文數據包，如此往復，直到到達目的主機。

這樣的過程，traceroute 就可以拿到了所有的路由器 IP。

當然有的路由器根本就不會返回這個 ICMP，所以對於有的公網地址，是看不到中間經過的路由的。

> 發送方如何知道發出的 UDP 包是否到達了目的主機呢？

traceroute 在發送 `UDP` 包時，會填入一個**不可能的端口號**值作為 UDP 目標端口號（大於 `3000` ）。當目的主機，收到 UDP 包後，會返回 ICMP 差錯報文消息，但這個差錯報文消息的類型是「**端口不可達**」。

所以，**當差錯報文類型是端口不可達時，說明發送方發出的 UDP 包到達了目的主機。**

*2. traceroute 作用二*

traceroute 還有一個作用是**故意設置不分片，從而確定路徑的 MTU**。

> 這麼做是為了什麼？

這樣做的目的是為了**路徑MTU發現**。

因為有的時候我們並不知道路由器的 `MTU` 大小，以太網的數據鏈路上的 `MTU` 通常是 `1500` 字節，但是非以外網的 `MTU` 值就不一樣了，所以我們要知道 `MTU` 的大小，從而控制發送的包大小。

![MTU 路徑發現（UDP的情況下）](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ping/18.jpg)

它的工作原理如下：

首先在發送端主機發送 `IP` 數據報時，將 `IP` 包首部的**分片禁止標誌位設置為 1**。根據這個標誌位，途中的路由器不會對大數據包進行分片，而是將包丟棄。

隨後，通過一個 ICMP 的不可達消息將**數據鏈路上 MTU 的值**一起給發送主機，不可達消息的類型為「**需要進行分片但設置了不分片位**」。

發送主機端每次收到 ICMP 差錯報文時就**減少**包的大小，以此來定位一個合適的 `MTU` 值，以便能到達目標主機。

----

參考資料：

[1] 竹下隆史.圖解TCP/IP.人民郵電出版社.

[2] 劉超.趣談網絡協議.極客時間.

---

## 讀者問答

> 讀者問：“有個問題就是A的icmp到了B後，B為啥會自動給A一個回執0？這是操作系統的底層設計嗎？”

你說的“回執0”是指 ICMP 類型為 0 嗎？如果是的話，那麼 B 收到 A 的回送請求（類型為8） ICMP 報文，B 主機操作系統協議棧發現是個回送請求 ICMP 報文，那麼協議棧就會組裝一個回送應答（類型為0）的 IMCP 迴應給 A。

----

哈嘍，我是小林，就愛圖解計算機基礎，如果覺得文章對你有幫助，別忘記關注我哦！

![](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost2/%E5%85%B6%E4%BB%96/%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BB%8B%E7%BB%8D.png)

