# 3.1 Linux 內核 vs Windows 內核

Windows 和 Linux 可以說是我們比較常見的兩款操作系統的。

Windows 基本佔領了電腦時代的市場，商業上取得了很大成就，但是它並不開源，所以要想接觸源碼得加入 Windows 的開發團隊中。

對於服務器使用的操作系統基本上都是 Linux，而且內核源碼也是開源的，任何人都可以下載，並增加自己的改動或功能，Linux 最大的魅力在於，全世界有非常多的技術大佬為它貢獻代碼。

這兩個操作系統各有千秋，不分伯仲。

操作系統核心的東西就是內核，這次我們就來看看，**Linux 內核和 Windows 內核有什麼區別？**

---

## 內核

什麼是內核呢？

計算機是由各種外部硬件設備組成的，比如內存、cpu、硬盤等，如果每個應用都要和這些硬件設備對接通信協議，那這樣太累了，所以這個中間人就由內核來負責，**讓內核作為應用連接硬件設備的橋樑**，應用程序只需關心與內核交互，不用關心硬件的細節。

![內核](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost4@main/操作系統/內核/Kernel_Layout.png)


內核有哪些能力呢？

現代操作系統，內核一般會提供 4 個基本能力：

- 管理進程、線程，決定哪個進程、線程使用 CPU，也就是進程調度的能力；
- 管理內存，決定內存的分配和回收，也就是內存管理的能力；
- 管理硬件設備，為進程與硬件設備之間提供通信能力，也就是硬件通信能力；
- 提供系統調用，如果應用程序要運行更高權限運行的服務，那麼就需要有系統調用，它是用戶程序與操作系統之間的接口。


內核是怎麼工作的？

內核具有很高的權限，可以控制 cpu、內存、硬盤等硬件，而應用程序具有的權限很小，因此大多數操作系統，把內存分成了兩個區域：

- 內核空間，這個內存空間只有內核程序可以訪問；
- 用戶空間，這個內存空間專門給應用程序使用；

用戶空間的代碼只能訪問一個局部的內存空間，而內核空間的代碼可以訪問所有內存空間。因此，當程序使用用戶空間時，我們常說該程序在**用戶態**執行，而當程序使內核空間時，程序則在**內核態**執行。


應用程序如果需要進入內核空間，就需要通過系統調用，下面來看看系統調用的過程：

![](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost4@main/操作系統/內核/systemcall.png)

內核程序執行在內核態，用戶程序執行在用戶態。當應用程序使用系統調用時，會產生一箇中斷。發生中斷後， CPU 會中斷當前在執行的用戶程序，轉而跳轉到中斷處理程序，也就是開始執行內核程序。內核處理完後，主動觸發中斷，把 CPU 執行權限交回給用戶程序，回到用戶態繼續工作。


---

## Linux 的設計

Linux 的開山始祖是來自一位名叫 Linus Torvalds 的芬蘭小夥子，他在 1991 年用 C 語言寫出了第一版的 Linux 操作系統，那年他 22 歲。

完成第一版 Linux 後，Linux Torvalds 就在網絡上發佈了 Linux 內核的源代碼，每個人都可以免費下載和使用。


Linux 內核設計的理念主要有這幾個點：

- *MultiTask*，多任務
- *SMP*，對稱多處理
- *ELF*，可執行文件鏈接格式
- *Monolithic Kernel*，宏內核

####  MultiTask

MultiTask 的意思是**多任務**，代表著 Linux 是一個多任務的操作系統。

多任務意味著可以有多個任務同時執行，這裡的「同時」可以是併發或並行：

- 對於單核 CPU 時，可以讓每個任務執行一小段時間，時間到就切換另外一個任務，從宏觀角度看，一段時間內執行了多個任務，這被稱為併發。
- 對於多核 CPU 時，多個任務可以同時被不同核心的 CPU 同時執行，這被稱為並行。

### SMP


SMP 的意思是**對稱多處理**，代表著每個 CPU 的地位是相等的，對資源的使用權限也是相同的，多個 CPU 共享同一個內存，每個 CPU 都可以訪問完整的內存和硬件資源。

這個特點決定了 Linux 操作系統不會有某個 CPU 單獨服務應用程序或內核程序，而是每個程序都可以被分配到任意一個 CPU 上被執行。

### ELF

ELF 的意思是**可執行文件鏈接格式**，它是 Linux 操作系統中可執行文件的存儲格式，你可以從下圖看到它的結構：


![ELF 文件格式](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost4@main/操作系統/內核/Elf.png)


ELF 把文件分成了一個個分段，每一個段都有自己的作用，具體每個段的作用這裡我就不詳細說明瞭，感興趣的同學可以去看《程序員的自我修養——鏈接、裝載和庫》這本書。

另外，ELF 文件有兩種索引，Program header table 中記錄了「運行時」所需的段，而 Section header table 記錄了二進制文件中各個「段的首地址」。

那 ELF 文件怎麼生成的呢？

我們編寫的代碼，首先通過「編譯器」編譯成彙編代碼，接著通過「彙編器」變成目標代碼，也就是目標文件，最後通過「鏈接器」把多個目標文件以及調用的各種函數庫鏈接起來，形成一個可執行文件，也就是 ELF 文件。

那 ELF 文件是怎麼被執行的呢？

執行 ELF 文件的時候，會通過「裝載器」把 ELF 文件裝載到內存裡，CPU 讀取內存中的指令和數據，於是程序就被執行起來了。


### Monolithic Kernel

Monolithic Kernel 的意思是**宏內核**，Linux 內核架構就是宏內核，意味著 Linux 的內核是一個完整的可執行程序，且擁有最高的權限。


宏內核的特徵是系統內核的所有模塊，比如進程調度、內存管理、文件系統、設備驅動等，都運行在內核態。

不過，Linux 也實現了動態加載內核模塊的功能，例如大部分設備驅動是以可加載模塊的形式存在的，與內核其他模塊解耦，讓驅動開發和驅動加載更為方便、靈活。


![分別為宏內核、微內核、混合內核的操作系統結構](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost4@main/操作系統/內核/OS-structure2.png)

與宏內核相反的是**微內核**，微內核架構的內核只保留最基本的能力，比如進程調度、虛擬機內存、中斷等，把一些應用放到了用戶空間，比如驅動程序、文件系統等。這樣服務與服務之間是隔離的，單個服務出現故障或者完全攻擊，也不會導致整個操作系統掛掉，提高了操作系統的穩定性和可靠性。 

微內核內核功能少，可移植性高，相比宏內核有一點不好的地方在於，由於驅動程序不在內核中，而且驅動程序一般會頻繁調用底層能力的，於是驅動和硬件設備交互就需要頻繁切換到內核態，這樣會帶來性能損耗。華為的鴻蒙操作系統的內核架構就是微內核。


還有一種內核叫**混合類型內核**，它的架構有點像微內核，內核裡面會有一個最小版本的內核，然後其他模塊會在這個基礎上搭建，然後實現的時候會跟宏內核類似，也就是把整個內核做成一個完整的程序，大部分服務都在內核中，這就像是宏內核的方式包裹著一個微內核。

---

## Windows 設計


當今 Windows 7、Windows 10 使用的內核叫 Windows NT，NT 全稱叫 New Technology。

下圖是 Windows NT 的結構圖片：

![Windows NT 的結構](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost4@main/操作系統/內核/windowNT.png)

Windows 和 Linux 一樣，同樣支持 MutiTask 和 SMP，但不同的是，**Window 的內核設計是混合型內核**，在上圖你可以看到內核中有一個 *MicroKernel* 模塊，這個就是最小版本的內核，而整個內核實現是一個完整的程序，含有非常多模塊。

Windows 的可執行文件的格式與 Linux 也不同，所以這兩個系統的可執行文件是不可以在對方上運行的。

Windows 的可執行文件格式叫 PE，稱為**可移植執行文件**，擴展名通常是`.exe`、`.dll`、`.sys`等。

PE 的結構你可以從下圖中看到，它與 ELF 結構有一點相似。

![PE 文件結構](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost4@main/操作系統/內核/pe.png)

---

## 總結

對於內核的架構一般有這三種類型：

- 宏內核，包含多個模塊，整個內核像一個完整的程序；
- 微內核，有一個最小版本的內核，一些模塊和服務則由用戶態管理；
- 混合內核，是宏內核和微內核的結合體，內核中抽象出了微內核的概念，也就是內核中會有一個小型的內核，其他模塊就在這個基礎上搭建，整個內核是個完整的程序；

Linux 的內核設計是採用了宏內核，Window 的內核設計則是採用了混合內核。

這兩個操作系統的可執行文件格式也不一樣， Linux 可執行文件格式叫作 ELF，Windows 可執行文件格式叫作 PE。

---

## 關注作者

***哈嘍，我是小林，就愛圖解計算機基礎，如果覺得文章對你有幫助，歡迎微信搜索「小林coding」，關注後，回覆「網絡」再送你圖解網絡 PDF***

![](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost3@main/其他/公眾號介紹.png)
