# 2.2 磁盤比內存慢幾萬倍？

大家如果想自己組裝電腦的話，肯定需要購買一個 CPU，但是存儲器方面的設備，分類比較多，那我們肯定不能只買一種存儲器，比如你除了要買內存，還要買硬盤，而針對硬盤我們還可以選擇是固態硬盤還是機械硬盤。

相信大家都知道內存和硬盤都屬於計算機的存儲設備，斷電後內存的數據是會丟失的，而硬盤則不會，因為硬盤是持久化存儲設備，同時也是一個 I/O 設備。

但其實 CPU 內部也有存儲數據的組件，這個應該比較少人注意到，比如**寄存器、CPU L1/L2/L3 Cache** 也都是屬於存儲設備，只不過它們能存儲的數據非常小，但是它們因為靠近 CPU 核心，所以訪問速度都非常快，快過硬盤好幾個數量級別。

問題來了，**那機械硬盤、固態硬盤、內存這三個存儲器，到底和 CPU L1 Cache 相比速度差多少倍呢？**

在回答這個問題之前，我們先來看看「**存儲器的層次結構**」，好讓我們對存儲器設備有一個整體的認識。

![](https://raw.githubusercontent.com/xiaolincoder/ImageHost3/main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%AD%98%E5%82%A8%E5%99%A8/%E5%AD%98%E5%82%A8%E5%99%A8%E6%8F%90%E7%BA%B2.png)

---

## 存儲器的層次結構


我們想象中一個場景，大學期末準備考試了，你前去圖書館臨時抱佛腳。那麼，在看書的時候，我們的大腦會思考問題，也會記憶知識點，另外我們通常也會把常用的書放在自己的桌子上，當我們要找一本不常用的書，則會去圖書館的書架找。

就是這麼一個小小的場景，已經把計算機的存儲結構基本都涵蓋了。

我們可以把 CPU 比喻成我們的大腦，大腦正在思考的東西，就好比 CPU 中的**寄存器**，處理速度是最快的，但是能存儲的數據也是最少的，畢竟我們也不能一下同時思考太多的事情，除非你練過。

我們大腦中的記憶，就好比 **CPU Cache**，中文稱為 CPU 高速緩存，處理速度相比寄存器慢了一點，但是能存儲的數據也稍微多了一些。

CPU Cache 通常會分為 **L1、L2、L3 三層**，其中 L1 Cache 通常分成「數據緩存」和「指令緩存」，L1 是距離 CPU 最近的，因此它比 L2、L3 的讀寫速度都快、存儲空間都小。我們大腦中短期記憶，就好比 L1 Cache，而長期記憶就好比 L2/L3 Cache。

寄存器和 CPU Cache 都是在 CPU 內部，跟 CPU 挨著很近，因此它們的讀寫速度都相當的快，但是能存儲的數據很少，畢竟 CPU 就這麼丁點大。

知道 CPU 內部的存儲器的層次分佈，我們放眼看看 CPU 外部的存儲器。

當我們大腦記憶中沒有資料的時候，可以從書桌或書架上拿書來閱讀，那我們桌子上的書，就好比**內存**，我們雖然可以一伸手就可以拿到，但讀寫速度肯定遠慢於寄存器，那圖書館書架上的書，就好比**硬盤**，能存儲的數據非常大，但是讀寫速度相比內存差好幾個數量級，更別說跟寄存器的差距了。


![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/操作系統/存儲結構/學習與存儲層次關係.png)


我們從圖書館書架取書，把書放到桌子上，再閱讀書，我們大腦就會記憶知識點，然後再經過大腦思考，這一系列過程相當於，數據從硬盤加載到內存，再從內存加載到 CPU 的寄存器和 Cache 中，然後再通過 CPU 進行處理和計算。

**對於存儲器，它的速度越快、能耗會越高、而且材料的成本也是越貴的，以至於速度快的存儲器的容量都比較小。**

CPU 裡的寄存器和 Cache，是整個計算機存儲器中價格最貴的，雖然存儲空間很小，但是讀寫速度是極快的，而相對比較便宜的內存和硬盤，速度肯定比不上 CPU 內部的存儲器，但是能彌補存儲空間的不足。


存儲器通常可以分為這麼幾個級別：


![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/操作系統/存儲結構/存儲區分級.png)

- 寄存器；
- CPU Cache；
  1. L1-Cache；
  2. L2-Cache；
  3. L3-Cahce；
- 內存；
- SSD/HDD 硬盤

### 寄存器

最靠近 CPU 的控制單元和邏輯計算單元的存儲器，就是寄存器了，它使用的材料速度也是最快的，因此價格也是最貴的，那麼數量不能很多。

存儲器的數量通常在幾十到幾百之間，每個寄存器可以用來存儲一定的字節（byte）的數據。比如：

- 32 位 CPU 中大多數寄存器可以存儲 `4` 個字節；
- 64 位 CPU 中大多數寄存器可以存儲 `8` 個字節。

寄存器的訪問速度非常快，一般要求在半個 CPU 時鐘週期內完成讀寫，CPU 時鐘週期跟 CPU 主頻息息相關，比如 2 GHz 主頻的 CPU，那麼它的時鐘週期就是 1/2G，也就是 0.5ns（納秒）。

CPU 處理一條指令的時候，除了讀寫寄存器，還需要解碼指令、控制指令執行和計算。如果寄存器的速度太慢，則會拉長指令的處理週期，從而給用戶的感覺，就是電腦「很慢」。

### CPU Cache

CPU Cache 用的是一種叫 **SRAM（*Static Random-Access* Memory，靜態隨機存儲器）** 的芯片。

SRAM 之所以叫「靜態」存儲器，是因為只要有電，數據就可以保持存在，而一旦斷電，數據就會丟失了。

在 SRAM 裡面，一個 bit 的數據，通常需要 6 個晶體管，所以 SRAM 的存儲密度不高，同樣的物理空間下，能存儲的數據是有限的，不過也因為 SRAM 的電路簡單，所以訪問速度非常快。


CPU 的高速緩存，通常可以分為 L1、L2、L3 這樣的三層高速緩存，也稱為一級緩存、二級緩存、三級緩存。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/操作系統/存儲結構/CPU-Cache.png)


#### L1 高速緩存

L1 高速緩存的訪問速度幾乎和寄存器一樣快，通常只需要 `2~4` 個時鐘週期，而大小在幾十 KB 到幾百 KB 不等。

每個 CPU 核心都有一塊屬於自己的 L1 高速緩存，指令和數據在 L1 是分開存放的，所以 L1 高速緩存通常分成**指令緩存**和**數據緩存**。

在 Linux 系統，我們可以通過這條命令，查看 CPU 裡的 L1 Cache 「數據」緩存的容量大小：

```bash
$ cat /sys/devices/system/cpu/cpu0/cache/index0/size
32K
```

而查看 L1 Cache 「指令」緩存的容量大小，則是：

```bash
$ cat /sys/devices/system/cpu/cpu0/cache/index1/size
32K
```


#### L2 高速緩存

L2 高速緩存同樣每個 CPU 核心都有，但是 L2 高速緩存位置比 L1 高速緩存距離 CPU 核心 更遠，它大小比 L1 高速緩存更大，CPU 型號不同大小也就不同，通常大小在幾百 KB 到幾 MB 不等，訪問速度則更慢，速度在 `10~20` 個時鐘週期。


在 Linux 系統，我們可以通過這條命令，查看 CPU 裡的 L2 Cache 的容量大小：

```bash
$ cat /sys/devices/system/cpu/cpu0/cache/index2/size
256K
```


#### L3 高速緩存

L3 高速緩存通常是多個 CPU 核心共用的，位置比 L2 高速緩存距離 CPU 核心 更遠，大小也會更大些，通常大小在幾 MB 到幾十 MB 不等，具體值根據 CPU 型號而定。

訪問速度相對也比較慢一些，訪問速度在 `20~60`個時鐘週期。

在 Linux 系統，我們可以通過這條命令，查看 CPU 裡的 L3 Cache 的容量大小：


```bash
$ cat /sys/devices/system/cpu/cpu0/cache/index3/size 
3072K
```


### 內存

內存用的芯片和 CPU Cache 有所不同，它使用的是一種叫作 **DRAM （*Dynamic Random Access Memory*，動態隨機存取存儲器）** 的芯片。

相比 SRAM，DRAM 的密度更高，功耗更低，有更大的容量，而且造價比 SRAM 芯片便宜很多。


DRAM 存儲一個 bit 數據，只需要一個晶體管和一個電容就能存儲，但是因為數據會被存儲在電容裡，電容會不斷漏電，所以需要「定時刷新」電容，才能保證數據不會被丟失，這就是 DRAM 之所以被稱為「動態」存儲器的原因，只有不斷刷新，數據才能被存儲起來。


DRAM 的數據訪問電路和刷新電路都比 SRAM 更復雜，所以訪問的速度會更慢，內存速度大概在 `200~300` 個 時鐘週期之間。


### SSD/HDD 硬盤

SSD（*Solid-state disk*） 就是我們常說的固體硬盤，結構和內存類似，但是它相比內存的優點是斷電後數據還是存在的，而內存、寄存器、高速緩存斷電後數據都會丟失。內存的讀寫速度比 SSD 大概快 `10~1000` 倍。

當然，還有一款傳統的硬盤，也就是機械硬盤（*Hard Disk Drive, HDD*），它是通過物理讀寫的方式來訪問數據的，因此它訪問速度是非常慢的，它的速度比內存慢 `10W` 倍左右。

由於 SSD 的價格快接近機械硬盤了，因此機械硬盤已經逐漸被 SSD 替代了。

---


## 存儲器的層次關係

現代的一臺計算機，都用上了 CPU Cahce、內存、到 SSD 或 HDD 硬盤這些存儲器設備了。

其中，存儲空間越大的存儲器設備，其訪問速度越慢，所需成本也相對越少。

CPU 並不會直接和每一種存儲器設備直接打交道，而是每一種存儲器設備只和它相鄰的存儲器設備打交道。

比如，CPU Cache 的數據是從內存加載過來的，寫回數據的時候也只寫回到內存，CPU Cache 不會直接把數據寫到硬盤，也不會直接從硬盤加載數據，而是先加載到內存，再從內存加載到 CPU Cache 中。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/操作系統/存儲結構/存儲器的層次關係圖.png)

所以，**每個存儲器只和相鄰的一層存儲器設備打交道，並且存儲設備為了追求更快的速度，所需的材料成本必然也是更高，也正因為成本太高，所以 CPU 內部的寄存器、L1\L2\L3 Cache 只好用較小的容量，相反內存、硬盤則可用更大的容量，這就我們今天所說的存儲器層次結構**。

另外，當 CPU 需要訪問內存中某個數據的時候，如果寄存器有這個數據，CPU 就直接從寄存器取數據即可，如果寄存器沒有這個數據，CPU 就會查詢 L1 高速緩存，如果 L1 沒有，則查詢 L2 高速緩存，L2 還是沒有的話就查詢 L3 高速緩存，L3 依然沒有的話，才去內存中取數據。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/操作系統/存儲結構/緩存體系1.png)

所以，存儲層次結構也形成了**緩存**的體系。


----

## 存儲器之間的實際價格和性能差距

前面我們知道了，速度越快的存儲器，造價成本往往也越高，那我們就以實際的數據來看看，不同層級的存儲器之間的性能和價格差異。

下面這張表格是不同層級的存儲器之間的成本對比圖：

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/操作系統/存儲結構/存儲器成本的對比.png)

你可以看到 L1 Cache 的訪問延時是 1 納秒，而內存已經是 100 納秒了，相比 L1 Cache 速度慢了 `100` 倍。另外，機械硬盤的訪問延時更是高達 10 毫秒，相比 L1 Cache 速度慢了 `10000000` 倍，差了好幾個數量級別。

在價格上，每生成 MB 大小的 L1 Cache 相比內存貴了 `466` 倍，相比機械硬盤那更是貴了 `175000` 倍。

我在某東逛了下各個存儲器設備的零售價，8G 內存 + 1T 機械硬盤 + 256G 固態硬盤的總價格，都不及一塊 Intle i5-10400 的 CPU 的價格，這款 CPU 的高速緩存的總大小也就十多 MB。


---

## 總結

各種存儲器之間的關係，可以用我們在圖書館學習這個場景來理解。

CPU 可以比喻成我們的大腦，我們當前正在思考和處理的知識的過程，就好比 CPU 中的**寄存器**處理數據的過程，速度極快，但是容量很小。而 CPU 中的 **L1-L3 Cache** 好比我們大腦中的短期記憶和長期記憶，需要小小花費點時間來調取數據並處理。

我們面前的桌子就相當於**內存**，能放下更多的書（數據），但是找起來和看起來就要花費一些時間，相比 CPU Cache 慢不少。而圖書館的書架相當於**硬盤**，能放下比內存更多的數據，但找起來就更費時間了，可以說是最慢的存儲器設備了。

從 寄存器、CPU Cache，到內存、硬盤，這樣一層層下來的存儲器，訪問速度越來越慢，存儲容量越來越大，價格也越來越便宜，而且每個存儲器只和相鄰的一層存儲器設備打交道，於是這樣就形成了存儲器的層次結構。


再來回答，開頭的問題：那機械硬盤、固態硬盤、內存這三個存儲器，到底和 `CPU L1 Cache` 相比速度差多少倍呢？

CPU L1 Cache 隨機訪問延時是 1 納秒，內存則是 100 納秒，所以 **CPU L1 Cache 比內存快 `100` 倍左右**。

SSD 隨機訪問延時是 150 微秒，所以 **CPU L1 Cache 比 SSD 快 `150000` 倍左右**。

最慢的機械硬盤隨機訪問延時已經高達 10 毫秒，我們來看看機械硬盤到底有多「龜速」：

- **SSD 比機械硬盤快 70 倍左右；**
- **內存比機械硬盤快 100000 倍左右；**
- **CPU L1 Cache 比機械硬盤快 10000000 倍左右；**


我們把上述的時間比例差異放大後，就能非常直觀感受到它們的性能差異了。如果 CPU 訪問 L1 Cache 的緩存時間是 1 秒，那訪問內存則需要大約 2 分鐘，隨機訪問 SSD 裡的數據則需要 1.7 天，訪問機械硬盤那更久，長達近 4 個月。

可以發現，不同的存儲器之間性能差距很大，構造存儲器分級很有意義，分級的目的是要構造**緩存**體系。


---


## 關注作者


新的**技術交流群**已經慢慢人多起來了，群裡的大牛真的多，大家交流都很踴躍，也有很多熱心分享和回答問題的小夥伴，是你交朋友好地方，更是你上班划水的好入口。

準備入冬了，一起來抱團取暖吧，加群方式很簡單，只需要加我的微信二維碼，備註「**加群**」即可。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E5%85%B6%E4%BB%96/%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BB%8B%E7%BB%8D.png)

**哈嘍，我是小林，就愛圖解計算機基礎，如果覺得文章對你有幫助，歡迎微信搜索「小林coding」，關注後，回覆「網絡」再送你圖解網絡 PDF**