<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ğŸ¯ å®Œæ•´çš„ Solana Token å‡ºå…¥é‡‘ç³»çµ±æŒ‡å— - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-solana-ä»£å¹£ç³»çµ±ç™½è©±æ–‡å®Œæ•´æŒ‡å—"><a class="header" href="#-solana-ä»£å¹£ç³»çµ±ç™½è©±æ–‡å®Œæ•´æŒ‡å—">ğŸª™ Solana ä»£å¹£ç³»çµ±ç™½è©±æ–‡å®Œæ•´æŒ‡å—</a></h1>
<h2 id="-é¦–å…ˆææ‡‚ä»€éº¼æ™‚å€™éœ€è¦-rust"><a class="header" href="#-é¦–å…ˆææ‡‚ä»€éº¼æ™‚å€™éœ€è¦-rust">ğŸ¤” é¦–å…ˆææ‡‚ï¼šä»€éº¼æ™‚å€™éœ€è¦ Rustï¼Ÿ</a></h2>
<h3 id="ä¸éœ€è¦-rust-çš„æƒ…æ³å¤§å¤šæ•¸æƒ…æ³"><a class="header" href="#ä¸éœ€è¦-rust-çš„æƒ…æ³å¤§å¤šæ•¸æƒ…æ³">ä¸éœ€è¦ Rust çš„æƒ…æ³ï¼ˆå¤§å¤šæ•¸æƒ…æ³ï¼‰</a></h3>
<pre><code>âœ… å‰µå»ºæ™®é€šä»£å¹£ â†’ ç”¨ Solana CLI å°±å¤ äº†
âœ… å»ºç«‹å‡ºå…¥é‡‘ç³»çµ± â†’ ç”¨ Python/JavaScript å°±è¡Œ
âœ… éŒ¢åŒ…æ•´åˆ â†’ å‰ç«¯æ¡†æ¶å³å¯
âœ… ä¸€èˆ¬ DeFi åŠŸèƒ½ â†’ çµ„åˆç¾æœ‰ç¨‹å¼å°±å¥½
</code></pre>
<h3 id="éœ€è¦-rust-çš„æƒ…æ³ç‰¹æ®Šéœ€æ±‚"><a class="header" href="#éœ€è¦-rust-çš„æƒ…æ³ç‰¹æ®Šéœ€æ±‚">éœ€è¦ Rust çš„æƒ…æ³ï¼ˆç‰¹æ®Šéœ€æ±‚ï¼‰</a></h3>
<pre><code>âŒ è‡ªå®šç¾©ä»£å¹£é‚è¼¯ â†’ ä¾‹å¦‚ï¼šæ¯æ¬¡è½‰å¸³æ”¶ 1% æ‰‹çºŒè²»
âŒ è¤‡é›œæ™ºèƒ½åˆç´„ â†’ ä¾‹å¦‚ï¼šå¤šé‡ç°½åã€æŠ•ç¥¨ç³»çµ±
âŒ é«˜æ€§èƒ½æ‡‰ç”¨ â†’ ä¾‹å¦‚ï¼šé«˜é »äº¤æ˜“ã€éŠæˆ²å¼•æ“
âŒ å‰µæ–°é‡‘èç”¢å“ â†’ ä¾‹å¦‚ï¼šæ–°å‹ AMMã€å€Ÿè²¸å”è­°
</code></pre>
<p><strong>ç¸½çµï¼š90% çš„å°ˆæ¡ˆç”¨ä¸åˆ° Rustï¼</strong></p>
<hr />
<h2 id="-å‡ºå…¥é‡‘ç³»çµ±è©³ç´°è§£æ"><a class="header" href="#-å‡ºå…¥é‡‘ç³»çµ±è©³ç´°è§£æ">ğŸ’° å‡ºå…¥é‡‘ç³»çµ±è©³ç´°è§£æ</a></h2>
<h3 id="ä»€éº¼æ˜¯å‡ºå…¥é‡‘"><a class="header" href="#ä»€éº¼æ˜¯å‡ºå…¥é‡‘">ä»€éº¼æ˜¯å‡ºå…¥é‡‘ï¼Ÿ</a></h3>
<ul>
<li><strong>å…¥é‡‘ï¼ˆå……å€¼ï¼‰</strong>ï¼šç”¨æˆ¶å¾è‡ªå·±éŒ¢åŒ… â†’ è½‰åˆ°å¹³è‡º</li>
<li><strong>å‡ºé‡‘ï¼ˆæç¾ï¼‰</strong>ï¼šç”¨æˆ¶å¾å¹³è‡º â†’ è½‰åˆ°è‡ªå·±éŒ¢åŒ…</li>
</ul>
<h3 id="ç‚ºä»€éº¼éœ€è¦å‡ºå…¥é‡‘ç³»çµ±"><a class="header" href="#ç‚ºä»€éº¼éœ€è¦å‡ºå…¥é‡‘ç³»çµ±">ç‚ºä»€éº¼éœ€è¦å‡ºå…¥é‡‘ç³»çµ±ï¼Ÿ</a></h3>
<pre><code>ğŸ¦ å‚³çµ±äº¤æ˜“æ‰€æ¨¡å¼ï¼š
ç”¨æˆ¶éŒ¢åŒ… â†” äº¤æ˜“æ‰€ç¹«çµ± â†” å€å¡Šéˆ

å„ªé»ï¼š
âœ… äº¤æ˜“å¿«é€Ÿï¼ˆä¸ç”¨ç­‰å€å¡Šéˆç¢ºèªï¼‰
âœ… æ‰‹çºŒè²»ä¾¿å®œï¼ˆå…§éƒ¨è½‰å¸³å…è²»ï¼‰
âœ… ç”¨æˆ¶é«”é©—å¥½ï¼ˆåƒéŠ€è¡Œ APPï¼‰

ç¼ºé»ï¼š
âŒ éœ€è¦ä¿¡ä»»å¹³è‡º
âŒ å¹³è‡ºå¯èƒ½è·‘è·¯
</code></pre>
<hr />
<h2 id="-å‡ºå…¥é‡‘å®Œæ•´æµç¨‹åœ–"><a class="header" href="#-å‡ºå…¥é‡‘å®Œæ•´æµç¨‹åœ–">ğŸ”„ å‡ºå…¥é‡‘å®Œæ•´æµç¨‹åœ–</a></h2>
<pre><code>ğŸ“± ç”¨æˆ¶æ“ä½œæµç¨‹ï¼š

1ï¸âƒ£ è¨»å†Šéšæ®µï¼š
ç”¨æˆ¶é€£æ¥éŒ¢åŒ… â†’ ç³»çµ±ç”¢ç”Ÿå°ˆç”¨å……å€¼åœ°å€ â†’ ç”¨æˆ¶ç²å¾—å¸³è™Ÿ

2ï¸âƒ£ å……å€¼æµç¨‹ï¼š
ç”¨æˆ¶éŒ¢åŒ… â†’ è½‰å¸³åˆ°å……å€¼åœ°å€ â†’ ç³»çµ±ç›£æ§åˆ°å¸³ â†’ æ›´æ–°ç”¨æˆ¶é¤˜é¡

3ï¸âƒ£ å…§éƒ¨äº¤æ˜“ï¼š
ç”¨æˆ¶Aé¤˜é¡ â†’ æ‰£é™¤é‡‘é¡ â†’ ç”¨æˆ¶Bé¤˜é¡å¢åŠ ï¼ˆç§’åˆ°ï¼‰

4ï¸âƒ£ æç¾æµç¨‹ï¼š
æª¢æŸ¥ç”¨æˆ¶é¤˜é¡ â†’ å¾ç†±éŒ¢åŒ…è½‰å‡º â†’ åˆ°é”ç”¨æˆ¶éŒ¢åŒ… â†’ æ‰£é™¤ç”¨æˆ¶é¤˜é¡
</code></pre>
<hr />
<h2 id="-å®Œæ•´ç³»çµ±æ¶æ§‹"><a class="header" href="#-å®Œæ•´ç³»çµ±æ¶æ§‹">ğŸ’» å®Œæ•´ç³»çµ±æ¶æ§‹</a></h2>
<h3 id="æ•´é«”æ¶æ§‹åœ–"><a class="header" href="#æ•´é«”æ¶æ§‹åœ–">æ•´é«”æ¶æ§‹åœ–</a></h3>
<pre><code>ğŸŒ å‰ç«¯ (React + éŒ¢åŒ…é€£æ¥)
     â†• API å‘¼å«
ğŸ–¥ï¸ å¾Œç«¯ (Python FastAPI)
     â†• è®€å¯«
ğŸ—„ï¸ è³‡æ–™åº« (PostgreSQL)
     â†• ç›£æ§
â›“ï¸ Solana å€å¡Šéˆ
</code></pre>
<h3 id="è©³ç´°çš„å‡ºå…¥é‡‘å¯¦ä½œ"><a class="header" href="#è©³ç´°çš„å‡ºå…¥é‡‘å¯¦ä½œ">è©³ç´°çš„å‡ºå…¥é‡‘å¯¦ä½œ</a></h3>
<h4 id="1-å……å€¼ç›£æ§ç³»çµ±æœ€é‡è¦"><a class="header" href="#1-å……å€¼ç›£æ§ç³»çµ±æœ€é‡è¦">1. å……å€¼ç›£æ§ç³»çµ±ï¼ˆæœ€é‡è¦ï¼ï¼‰</a></h4>
<pre><code class="language-python"># app/services/deposit_monitor.py - ç™½è©±ç‰ˆè§£é‡‹
import asyncio
from decimal import Decimal
from solana.rpc.async_api import AsyncClient
from solders.pubkey import Pubkey

class DepositMonitor:
    """
    å……å€¼ç›£æ§å™¨ - é€™æ˜¯æ•´å€‹ç³»çµ±çš„æ ¸å¿ƒï¼
    
    ä½œç”¨ï¼šä¸åœåœ°æª¢æŸ¥ç”¨æˆ¶çš„å……å€¼åœ°å€ï¼Œçœ‹æœ‰æ²’æœ‰æ–°çš„è½‰å¸³é€²ä¾†
    å°±åƒéŠ€è¡Œç³»çµ±ç›£æ§ä½ çš„å¸³æˆ¶ä¸€æ¨£
    """
    
    def __init__(self, solana_service):
        self.service = solana_service
        self.processed_transactions = set()  # è¨˜ä½å·²ç¶“è™•ç†éçš„äº¤æ˜“
        self.is_running = False
    
    async def start_monitoring(self):
        """é–‹å§‹ç„¡é™å¾ªç’°ç›£æ§"""
        self.is_running = True
        print("ğŸ” é–‹å§‹ç›£æ§æ‰€æœ‰ç”¨æˆ¶çš„å……å€¼...")
        
        while self.is_running:
            try:
                # æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡æ‰€æœ‰ç”¨æˆ¶
                await self.check_all_user_deposits()
                await asyncio.sleep(5)
            except Exception as e:
                print(f"âŒ ç›£æ§å‡ºéŒ¯: {e}")
                await asyncio.sleep(10)  # å‡ºéŒ¯å°±ç­‰ä¹…ä¸€é»å†è©¦
    
    async def check_all_user_deposits(self):
        """æª¢æŸ¥æ‰€æœ‰ç”¨æˆ¶çš„å……å€¼åœ°å€"""
        
        # å¾è³‡æ–™åº«å–å‡ºæ‰€æœ‰ç”¨æˆ¶çš„å……å€¼åœ°å€
        async with self.service.db_pool.acquire() as conn:
            users = await conn.fetch(
                "SELECT user_id, deposit_address FROM user_balances WHERE deposit_address IS NOT NULL"
            )
        
        # ä¸€å€‹ä¸€å€‹æª¢æŸ¥
        for user in users:
            await self.check_single_user_deposit(user['user_id'], user['deposit_address'])
    
    async def check_single_user_deposit(self, user_id: str, deposit_address: str):
        """æª¢æŸ¥å–®ä¸€ç”¨æˆ¶çš„å……å€¼"""
        try:
            # è½‰æ›åœ°å€æ ¼å¼
            pubkey = Pubkey.from_string(deposit_address)
            
            # å‘ Solana å€å¡ŠéˆæŸ¥è©¢é€™å€‹åœ°å€çš„æœ€è¿‘äº¤æ˜“
            signatures = await self.service.client.get_signatures_for_address(
                pubkey, 
                limit=20  # åªçœ‹æœ€è¿‘20ç­†äº¤æ˜“å°±å¤ äº†
            )
            
            # æª¢æŸ¥æ¯ä¸€ç­†äº¤æ˜“
            for sig_info in signatures.value:
                signature = sig_info.signature
                
                # å¦‚æœé€™ç­†äº¤æ˜“å·²ç¶“è™•ç†éï¼Œå°±è·³é
                if signature in self.processed_transactions:
                    continue
                
                # è™•ç†æ–°äº¤æ˜“
                await self.process_new_deposit(user_id, signature)
                
                # è¨˜ä½é€™ç­†äº¤æ˜“å·²ç¶“è™•ç†éäº†
                self.processed_transactions.add(signature)
                
        except Exception as e:
            print(f"âŒ æª¢æŸ¥ç”¨æˆ¶ {user_id} å……å€¼å¤±æ•—: {e}")
    
    async def process_new_deposit(self, user_id: str, transaction_signature: str):
        """è™•ç†æ–°çš„å……å€¼äº¤æ˜“"""
        try:
            # ç²å–äº¤æ˜“çš„è©³ç´°è³‡æ–™
            tx_detail = await self.service.client.get_transaction(transaction_signature)
            
            if not tx_detail.value:
                return  # äº¤æ˜“ä¸å­˜åœ¨å°±è·³é
            
            # è§£æäº¤æ˜“ï¼Œæ‰¾å‡ºè½‰äº†å¤šå°‘ä»£å¹£
            token_amount = await self.parse_token_amount_from_transaction(tx_detail.value)
            
            if token_amount &gt; 0:
                # å¢åŠ ç”¨æˆ¶é¤˜é¡
                await self.credit_user_balance(user_id, token_amount, transaction_signature)
                
                # é€šçŸ¥ç”¨æˆ¶ï¼ˆå¯é¸ï¼‰
                await self.notify_user_deposit_success(user_id, token_amount)
                
                print(f"âœ… ç”¨æˆ¶ {user_id} å……å€¼æˆåŠŸ: {token_amount} ä»£å¹£")
                
        except Exception as e:
            print(f"âŒ è™•ç†å……å€¼äº¤æ˜“å¤±æ•—: {e}")
    
    async def parse_token_amount_from_transaction(self, transaction) -&gt; Decimal:
        """
        å¾äº¤æ˜“ä¸­è§£æå‡ºä»£å¹£æ•¸é‡
        é€™è£¡ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›éœ€è¦è§£æ Solana äº¤æ˜“çµæ§‹
        """
        # å¯¦éš›å¯¦ä½œéœ€è¦ï¼š
        # 1. è§£æ transaction.transaction.message.instructions
        # 2. æ‰¾åˆ° SPL Token è½‰å¸³æŒ‡ä»¤
        # 3. æå–è½‰å¸³é‡‘é¡
        # 4. è½‰æ›å°æ•¸ä½æ•¸
        
        # é€™è£¡ç”¨å›ºå®šå€¼ç¤ºç¯„
        return Decimal('100.5')  # å‡è¨­è½‰äº† 100.5 å€‹ä»£å¹£
    
    async def credit_user_balance(self, user_id: str, amount: Decimal, tx_signature: str):
        """å¢åŠ ç”¨æˆ¶é¤˜é¡ä¸¦è¨˜éŒ„äº¤æ˜“"""
        async with self.service.db_pool.acquire() as conn:
            async with conn.transaction():  # ä½¿ç”¨è³‡æ–™åº«äº¤æ˜“ç¢ºä¿ä¸€è‡´æ€§
                
                # å¢åŠ ç”¨æˆ¶é¤˜é¡
                await conn.execute(
                    """
                    UPDATE user_balances 
                    SET token_balance = token_balance + $1,
                        updated_at = NOW()
                    WHERE user_id = $2
                    """,
                    amount, user_id
                )
                
                # è¨˜éŒ„å……å€¼äº¤æ˜“
                await conn.execute(
                    """
                    INSERT INTO transactions 
                    (user_id, tx_signature, type, amount, status, confirmed_at)
                    VALUES ($1, $2, 'deposit', $3, 'confirmed', NOW())
                    """,
                    user_id, tx_signature, amount
                )
    
    async def notify_user_deposit_success(self, user_id: str, amount: Decimal):
        """é€šçŸ¥ç”¨æˆ¶å……å€¼æˆåŠŸï¼ˆå¯é¸åŠŸèƒ½ï¼‰"""
        # å¯ä»¥æ•´åˆï¼š
        # 1. WebSocket å³æ™‚é€šçŸ¥
        # 2. æ¨æ’­é€šçŸ¥
        # 3. Email é€šçŸ¥
        # 4. Telegram Bot é€šçŸ¥
        pass
</code></pre>
<h4 id="2-æç¾è™•ç†ç³»çµ±"><a class="header" href="#2-æç¾è™•ç†ç³»çµ±">2. æç¾è™•ç†ç³»çµ±</a></h4>
<pre><code class="language-python"># app/services/withdrawal_service.py - ç™½è©±ç‰ˆ
from decimal import Decimal
from typing import Dict
from solana.rpc.async_api import AsyncClient
from solders.pubkey import Pubkey
from spl.token.async_client import AsyncToken
from spl.token.constants import TOKEN_PROGRAM_ID

class WithdrawalService:
    """
    æç¾æœå‹™ - è™•ç†ç”¨æˆ¶æç¾åˆ°è‡ªå·±éŒ¢åŒ…
    
    é‡è¦æ¦‚å¿µï¼š
    - ç†±éŒ¢åŒ…ï¼šå¹³è‡ºæ§åˆ¶çš„éŒ¢åŒ…ï¼Œç”¨ä¾†ç™¼é€ä»£å¹£çµ¦ç”¨æˆ¶
    - å†·éŒ¢åŒ…ï¼šé›¢ç·šå­˜å„²å¤§éƒ¨åˆ†ä»£å¹£ï¼Œå®‰å…¨æ€§é«˜
    """
    
    def __init__(self, solana_service):
        self.service = solana_service
        self.withdrawal_fee = Decimal('0.1')    # æç¾æ‰‹çºŒè²»
        self.min_withdrawal = Decimal('10')     # æœ€å°æç¾é‡‘é¡
        self.max_daily_withdrawal = Decimal('10000')  # æ¯æ—¥æç¾é™é¡
    
    async def process_user_withdrawal(self, user_id: str, amount: Decimal, target_wallet: str) -&gt; Dict:
        """
        è™•ç†ç”¨æˆ¶æç¾è«‹æ±‚
        
        æµç¨‹ï¼š
        1. æª¢æŸ¥ç”¨æˆ¶é¤˜é¡å¤ ä¸å¤ 
        2. æª¢æŸ¥æç¾é™åˆ¶ï¼ˆæœ€å°é‡‘é¡ã€æ¯æ—¥é™é¡ç­‰ï¼‰
        3. å¾ç†±éŒ¢åŒ…è½‰å¸³åˆ°ç”¨æˆ¶éŒ¢åŒ…
        4. æ‰£é™¤ç”¨æˆ¶å¹³è‡ºé¤˜é¡
        5. è¨˜éŒ„äº¤æ˜“
        """
        try:
            # ç¬¬ä¸€æ­¥ï¼šå„ç¨®æª¢æŸ¥
            validation_result = await self.validate_withdrawal_request(user_id, amount, target_wallet)
            if not validation_result['valid']:
                return {'success': False, 'error': validation_result['error']}
            
            # ç¬¬äºŒæ­¥ï¼šè¨ˆç®—ç¸½è²»ç”¨ï¼ˆæç¾é‡‘é¡ + æ‰‹çºŒè²»ï¼‰
            total_cost = amount + self.withdrawal_fee
            
            # ç¬¬ä¸‰æ­¥ï¼šæª¢æŸ¥ç”¨æˆ¶é¤˜é¡
            user_balance = await self.service.get_user_balance(user_id)
            if user_balance &lt; total_cost:
                return {
                    'success': False, 
                    'error': f'é¤˜é¡ä¸è¶³ï¼Œéœ€è¦ {total_cost}ï¼ˆåŒ…å«æ‰‹çºŒè²» {self.withdrawal_fee}ï¼‰'
                }
            
            # ç¬¬å››æ­¥ï¼šåŸ·è¡Œå€å¡Šéˆè½‰å¸³
            blockchain_result = await self.send_tokens_on_blockchain(amount, target_wallet)
            if not blockchain_result['success']:
                return {'success': False, 'error': f'å€å¡Šéˆè½‰å¸³å¤±æ•—: {blockchain_result["error"]}'}
            
            # ç¬¬äº”æ­¥ï¼šæ›´æ–°è³‡æ–™åº«ï¼ˆæ‰£é™¤ç”¨æˆ¶é¤˜é¡ã€è¨˜éŒ„äº¤æ˜“ï¼‰
            await self.update_database_after_withdrawal(
                user_id, amount, target_wallet, blockchain_result['signature']
            )
            
            return {
                'success': True,
                'transaction_signature': blockchain_result['signature'],
                'amount_sent': str(amount),
                'fee_charged': str(self.withdrawal_fee),
                'target_wallet': target_wallet,
                'explorer_url': f'https://solscan.io/tx/{blockchain_result["signature"]}'
            }
            
        except Exception as e:
            # è¨˜éŒ„éŒ¯èª¤æ—¥èªŒ
            await self.log_withdrawal_error(user_id, amount, target_wallet, str(e))
            return {'success': False, 'error': f'ç³»çµ±éŒ¯èª¤: {str(e)}'}
    
    async def validate_withdrawal_request(self, user_id: str, amount: Decimal, target_wallet: str) -&gt; Dict:
        """é©—è­‰æç¾è«‹æ±‚æ˜¯å¦åˆæ³•"""
        
        # æª¢æŸ¥é‡‘é¡æ˜¯å¦ç¬¦åˆé™åˆ¶
        if amount &lt; self.min_withdrawal:
            return {'valid': False, 'error': f'æç¾é‡‘é¡ä¸èƒ½å°‘æ–¼ {self.min_withdrawal}'}
        
        # æª¢æŸ¥éŒ¢åŒ…åœ°å€æ ¼å¼
        try:
            Pubkey.from_string(target_wallet)
        except:
            return {'valid': False, 'error': 'éŒ¢åŒ…åœ°å€æ ¼å¼éŒ¯èª¤'}
        
        # æª¢æŸ¥æ¯æ—¥æç¾é™é¡
        daily_withdrawn = await self.get_user_daily_withdrawal_amount(user_id)
        if daily_withdrawn + amount &gt; self.max_daily_withdrawal:
            return {
                'valid': False, 
                'error': f'è¶…éæ¯æ—¥æç¾é™é¡ {self.max_daily_withdrawal}ï¼Œä»Šæ—¥å·²æç¾ {daily_withdrawn}'
            }
        
        # æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
        user_status = await self.get_user_account_status(user_id)
        if user_status != 'active':
            return {'valid': False, 'error': 'å¸³æˆ¶å·²è¢«å‡çµ'}
        
        return {'valid': True}
    
    async def send_tokens_on_blockchain(self, amount: Decimal, target_wallet: str) -&gt; Dict:
        """åœ¨å€å¡Šéˆä¸ŠåŸ·è¡Œå¯¦éš›çš„ä»£å¹£è½‰å¸³"""
        try:
            # å»ºç«‹ SPL Token å®¢æˆ¶ç«¯
            token_client = AsyncToken(
                self.service.client,           # Solana RPC é€£æ¥
                self.service.token_mint,       # æˆ‘å€‘çš„ä»£å¹£åˆç´„åœ°å€
                TOKEN_PROGRAM_ID,              # SPL Token ç¨‹å¼ ID
                self.service.hot_wallet        # å¹³è‡ºç†±éŒ¢åŒ…ï¼ˆç”¨ä¾†ç™¼é€ä»£å¹£ï¼‰
            )
            
            # ç²å–ç›®æ¨™éŒ¢åŒ…çš„ä»£å¹£å¸³æˆ¶ï¼ˆå¦‚æœæ²’æœ‰å°±å‰µå»ºä¸€å€‹ï¼‰
            target_pubkey = Pubkey.from_string(target_wallet)
            target_token_account = await token_client.get_or_create_associated_account_info(target_pubkey)
            
            # ç²å–å¹³è‡ºç†±éŒ¢åŒ…çš„ä»£å¹£å¸³æˆ¶
            source_token_account = await token_client.get_or_create_associated_account_info(
                self.service.hot_wallet.pubkey()
            )
            
            # è½‰æ›é‡‘é¡æ ¼å¼ï¼ˆè€ƒæ…®ä»£å¹£çš„å°æ•¸ä½æ•¸ï¼‰
            # å‡è¨­æˆ‘å€‘çš„ä»£å¹£æœ‰ 9 ä½å°æ•¸
            token_amount_raw = int(amount * (10 ** 9))
            
            # åŸ·è¡Œè½‰å¸³
            transfer_response = await token_client.transfer(
                source=source_token_account,    # å¾ç†±éŒ¢åŒ…
                dest=target_token_account,      # åˆ°ç”¨æˆ¶éŒ¢åŒ…
                owner=self.service.hot_wallet,  # ç°½åè€…ï¼ˆç†±éŒ¢åŒ…ï¼‰
                amount=token_amount_raw         # è½‰å¸³é‡‘é¡
            )
            
            # ç­‰å¾…äº¤æ˜“ç¢ºèª
            confirmation = await self.service.client.confirm_transaction(transfer_response.value)
            
            return {
                'success': True,
                'signature': str(transfer_response.value)
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            }
    
    async def update_database_after_withdrawal(self, user_id: str, amount: Decimal, target_wallet: str, tx_signature: str):
        """æç¾æˆåŠŸå¾Œæ›´æ–°è³‡æ–™åº«"""
        total_deducted = amount + self.withdrawal_fee
        
        async with self.service.db_pool.acquire() as conn:
            async with conn.transaction():
                
                # æ‰£é™¤ç”¨æˆ¶é¤˜é¡
                await conn.execute(
                    """
                    UPDATE user_balances 
                    SET token_balance = token_balance - $1,
                        updated_at = NOW()
                    WHERE user_id = $2
                    """,
                    total_deducted, user_id
                )
                
                # è¨˜éŒ„æç¾äº¤æ˜“
                await conn.execute(
                    """
                    INSERT INTO transactions 
                    (user_id, tx_signature, type, amount, to_address, fee, status, confirmed_at)
                    VALUES ($1, $2, 'withdraw', $3, $4, $5, 'confirmed', NOW())
                    """,
                    user_id, tx_signature, amount, target_wallet, self.withdrawal_fee
                )
                
                print(f"âœ… ç”¨æˆ¶ {user_id} æç¾ {amount} ä»£å¹£åˆ° {target_wallet}")
    
    async def get_user_daily_withdrawal_amount(self, user_id: str) -&gt; Decimal:
        """æŸ¥è©¢ç”¨æˆ¶ä»Šæ—¥å·²æç¾é‡‘é¡"""
        async with self.service.db_pool.acquire() as conn:
            result = await conn.fetchval(
                """
                SELECT COALESCE(SUM(amount), 0)
                FROM transactions 
                WHERE user_id = $1 
                  AND type = 'withdraw' 
                  AND status = 'confirmed'
                  AND DATE(confirmed_at) = CURRENT_DATE
                """,
                user_id
            )
            return Decimal(result)
    
    async def get_user_account_status(self, user_id: str) -&gt; str:
        """æŸ¥è©¢ç”¨æˆ¶å¸³æˆ¶ç‹€æ…‹"""
        async with self.service.db_pool.acquire() as conn:
            result = await conn.fetchval(
                "SELECT status FROM user_balances WHERE user_id = $1",
                user_id
            )
            return result or 'inactive'
</code></pre>
<h4 id="3-å…§éƒ¨è½‰å¸³ç³»çµ±ç”¨æˆ¶ä¹‹é–“äº’è½‰"><a class="header" href="#3-å…§éƒ¨è½‰å¸³ç³»çµ±ç”¨æˆ¶ä¹‹é–“äº’è½‰">3. å…§éƒ¨è½‰å¸³ç³»çµ±ï¼ˆç”¨æˆ¶ä¹‹é–“äº’è½‰ï¼‰</a></h4>
<pre><code class="language-python"># app/services/internal_transfer.py - ç™½è©±ç‰ˆ
class InternalTransferService:
    """
    å…§éƒ¨è½‰å¸³æœå‹™ - ç”¨æˆ¶åœ¨å¹³è‡ºå…§äº’ç›¸è½‰å¸³
    
    å„ªé»ï¼š
    - ä¸ç”¨ä¸Šå€å¡Šéˆï¼Œç§’åˆ°å¸³
    - ä¸ç”¨ä»˜ Gas è²»
    - å°±åƒéŠ€è¡Œå…§éƒ¨è½‰å¸³ä¸€æ¨£å¿«
    """
    
    def __init__(self, solana_service):
        self.service = solana_service
        self.transfer_fee = Decimal('0')  # å…§éƒ¨è½‰å¸³å…æ‰‹çºŒè²»
    
    async def transfer_between_users(self, from_user: str, to_user: str, amount: Decimal, memo: str = "") -&gt; Dict:
        """ç”¨æˆ¶ä¹‹é–“è½‰å¸³"""
        try:
            # æª¢æŸ¥è½‰å¸³é‡‘é¡
            if amount &lt;= 0:
                return {'success': False, 'error': 'è½‰å¸³é‡‘é¡å¿…é ˆå¤§æ–¼ 0'}
            
            # æª¢æŸ¥ç™¼é€æ–¹é¤˜é¡
            sender_balance = await self.service.get_user_balance(from_user)
            if sender_balance &lt; amount:
                return {'success': False, 'error': 'é¤˜é¡ä¸è¶³'}
            
            # æª¢æŸ¥æ¥æ”¶æ–¹æ˜¯å¦å­˜åœ¨
            receiver_exists = await self.check_user_exists(to_user)
            if not receiver_exists:
                return {'success': False, 'error': 'æ¥æ”¶æ–¹ç”¨æˆ¶ä¸å­˜åœ¨'}
            
            # åŸ·è¡Œè½‰å¸³ï¼ˆåŸå­æ“ä½œï¼‰
            async with self.service.db_pool.acquire() as conn:
                async with conn.transaction():
                    
                    # æ‰£é™¤ç™¼é€æ–¹é¤˜é¡
                    await conn.execute(
                        "UPDATE user_balances SET token_balance = token_balance - $1 WHERE user_id = $2",
                        amount, from_user
                    )
                    
                    # å¢åŠ æ¥æ”¶æ–¹é¤˜é¡
                    await conn.execute(
                        "UPDATE user_balances SET token_balance = token_balance + $1 WHERE user_id = $2",
                        amount, to_user
                    )
                    
                    # è¨˜éŒ„è½‰å¸³
                    transfer_id = await conn.fetchval(
                        """
                        INSERT INTO internal_transfers 
                        (from_user, to_user, amount, memo, status, created_at)
                        VALUES ($1, $2, $3, $4, 'completed', NOW())
                        RETURNING id
                        """,
                        from_user, to_user, amount, memo
                    )
            
            return {
                'success': True,
                'transfer_id': transfer_id,
                'from_user': from_user,
                'to_user': to_user,
                'amount': str(amount),
                'memo': memo
            }
            
        except Exception as e:
            return {'success': False, 'error': str(e)}
</code></pre>
<hr />
<h2 id="-å®Œæ•´è³‡æ–™åº«è¨­è¨ˆ"><a class="header" href="#-å®Œæ•´è³‡æ–™åº«è¨­è¨ˆ">ğŸ—„ï¸ å®Œæ•´è³‡æ–™åº«è¨­è¨ˆ</a></h2>
<pre><code class="language-sql">-- ç”¨æˆ¶é¤˜é¡è¡¨
CREATE TABLE user_balances (
    user_id VARCHAR(64) PRIMARY KEY,           -- ç”¨æˆ¶IDï¼ˆé€šå¸¸æ˜¯éŒ¢åŒ…åœ°å€ï¼‰
    wallet_address VARCHAR(64) UNIQUE NOT NULL,-- ç”¨æˆ¶çš„ä¸»éŒ¢åŒ…åœ°å€
    deposit_address VARCHAR(64) UNIQUE,        -- å¹³è‡ºåˆ†é…çš„å……å€¼åœ°å€
    token_balance DECIMAL(20,8) DEFAULT 0,     -- ç”¨æˆ¶åœ¨å¹³è‡ºçš„ä»£å¹£é¤˜é¡
    status VARCHAR(20) DEFAULT 'active',       -- å¸³æˆ¶ç‹€æ…‹
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- äº¤æ˜“è¨˜éŒ„è¡¨ï¼ˆå€å¡Šéˆäº¤æ˜“ï¼‰
CREATE TABLE transactions (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    tx_signature VARCHAR(128) UNIQUE,          -- å€å¡Šéˆäº¤æ˜“ç°½å
    type VARCHAR(20) CHECK (type IN ('deposit', 'withdraw')),
    amount DECIMAL(20,8) NOT NULL,
    from_address VARCHAR(64),
    to_address VARCHAR(64),
    fee DECIMAL(20,8) DEFAULT 0,              -- æ‰‹çºŒè²»
    status VARCHAR(20) DEFAULT 'pending',      -- pending, confirmed, failed
    created_at TIMESTAMP DEFAULT NOW(),
    confirmed_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user_balances(user_id)
);

-- å…§éƒ¨è½‰å¸³è¡¨ï¼ˆä¸ä¸Šéˆï¼‰
CREATE TABLE internal_transfers (
    id SERIAL PRIMARY KEY,
    from_user VARCHAR(64) NOT NULL,
    to_user VARCHAR(64) NOT NULL,
    amount DECIMAL(20,8) NOT NULL,
    memo TEXT,                                -- è½‰å¸³å‚™è¨»
    status VARCHAR(20) DEFAULT 'completed',
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (from_user) REFERENCES user_balances(user_id),
    FOREIGN KEY (to_user) REFERENCES user_balances(user_id)
);

-- ç³»çµ±è¨­ç½®è¡¨
CREATE TABLE system_settings (
    key VARCHAR(50) PRIMARY KEY,
    value TEXT NOT NULL,
    description TEXT,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- æ’å…¥åŸºæœ¬è¨­ç½®
INSERT INTO system_settings (key, value, description) VALUES
('withdrawal_fee', '0.1', 'æç¾æ‰‹çºŒè²»'),
('min_withdrawal', '10', 'æœ€å°æç¾é‡‘é¡'),
('max_daily_withdrawal', '10000', 'æ¯æ—¥æç¾é™é¡'),
('deposit_confirmations', '12', 'å……å€¼éœ€è¦çš„ç¢ºèªæ•¸');
</code></pre>
<hr />
<h2 id="-ç”¨æˆ¶ä½¿ç”¨æµç¨‹ç™½è©±ç‰ˆ"><a class="header" href="#-ç”¨æˆ¶ä½¿ç”¨æµç¨‹ç™½è©±ç‰ˆ">ğŸ¯ ç”¨æˆ¶ä½¿ç”¨æµç¨‹ï¼ˆç™½è©±ç‰ˆï¼‰</a></h2>
<h3 id="1-ç”¨æˆ¶è¨»å†Š"><a class="header" href="#1-ç”¨æˆ¶è¨»å†Š">1. ç”¨æˆ¶è¨»å†Š</a></h3>
<pre><code>ç”¨æˆ¶ï¼šæˆ‘è¦è¨»å†Š
1. ç”¨æˆ¶é€£æ¥ Phantom éŒ¢åŒ…
2. ç³»çµ±ï¼šçœ‹åˆ°ä½ çš„éŒ¢åŒ…åœ°å€äº†ï¼Œå¹«ä½ å‰µå»ºå¸³è™Ÿ
3. ç³»çµ±ï¼šé€™æ˜¯ä½ çš„å°ˆç”¨å……å€¼åœ°å€ï¼šABC123...
4. ç”¨æˆ¶ï¼šå¥½ï¼Œæˆ‘è¨˜ä½äº†
</code></pre>
<h3 id="2-å……å€¼å…¥é‡‘"><a class="header" href="#2-å……å€¼å…¥é‡‘">2. å……å€¼ï¼ˆå…¥é‡‘ï¼‰</a></h3>
<pre><code>ç”¨æˆ¶ï¼šæˆ‘è¦å……å€¼ 100 å€‹ä»£å¹£
1. ç”¨æˆ¶å¾è‡ªå·±éŒ¢åŒ…è½‰ 100 ä»£å¹£åˆ°å……å€¼åœ°å€
2. ç³»çµ±ç›£æ§ç¨‹å¼ï¼šå’¦ï¼ŒABC123 åœ°å€æ”¶åˆ° 100 ä»£å¹£äº†
3. ç³»çµ±ï¼šç¢ºèªæ˜¯é€™å€‹ç”¨æˆ¶çš„ï¼Œå¹«ä»–åŠ é¤˜é¡
4. ç”¨æˆ¶ï¼šçœ‹åˆ°å¹³è‡ºé¤˜é¡è®Šæˆ 100 äº†ï¼Œé–‹å¿ƒï¼
</code></pre>
<h3 id="3-å…§éƒ¨äº¤æ˜“"><a class="header" href="#3-å…§éƒ¨äº¤æ˜“">3. å…§éƒ¨äº¤æ˜“</a></h3>
<pre><code>ç”¨æˆ¶Aï¼šæˆ‘è¦è½‰ 50 ä»£å¹£çµ¦ç”¨æˆ¶B
1. ç³»çµ±ï¼šæª¢æŸ¥ç”¨æˆ¶Aé¤˜é¡å¤ ä¸å¤ 
2. ç³»çµ±ï¼šå¤ ï¼Œæ‰£é™¤ç”¨æˆ¶Açš„ 50ï¼Œå¢åŠ ç”¨æˆ¶Bçš„ 50
3. ç”¨æˆ¶Aï¼šé¤˜é¡è®Šæˆ 50
4. ç”¨æˆ¶Bï¼šé¤˜é¡å¢åŠ  50ï¼Œç§’åˆ°å¸³ï¼
</code></pre>
<h3 id="4-æç¾å‡ºé‡‘"><a class="header" href="#4-æç¾å‡ºé‡‘">4. æç¾ï¼ˆå‡ºé‡‘ï¼‰</a></h3>
<pre><code>ç”¨æˆ¶ï¼šæˆ‘è¦æç¾ 30 ä»£å¹£åˆ°æˆ‘éŒ¢åŒ…
1. ç³»çµ±ï¼šæª¢æŸ¥é¤˜é¡ã€æ‰‹çºŒè²»ã€é™é¡
2. ç³»çµ±ï¼šOKï¼Œå¾ç†±éŒ¢åŒ…è½‰ 30 ä»£å¹£åˆ°ä½ éŒ¢åŒ…
3. å€å¡Šéˆï¼šäº¤æ˜“ç¢ºèª
4. ç³»çµ±ï¼šæ‰£é™¤ç”¨æˆ¶é¤˜é¡ 30 + æ‰‹çºŒè²»
5. ç”¨æˆ¶ï¼šéŒ¢åŒ…æ”¶åˆ° 30 ä»£å¹£ï¼
</code></pre>
<hr />
<h2 id="-é—œéµæ¦‚å¿µè§£é‡‹"><a class="header" href="#-é—œéµæ¦‚å¿µè§£é‡‹">ğŸ’¡ é—œéµæ¦‚å¿µè§£é‡‹</a></h2>
<h3 id="ç†±éŒ¢åŒ…-vs-å†·éŒ¢åŒ…"><a class="header" href="#ç†±éŒ¢åŒ…-vs-å†·éŒ¢åŒ…">ç†±éŒ¢åŒ… vs å†·éŒ¢åŒ…</a></h3>
<pre><code>ğŸ”¥ ç†±éŒ¢åŒ…ï¼ˆHot Walletï¼‰ï¼š
- é€£ç¶²çš„éŒ¢åŒ…ï¼Œå¹³è‡ºæ§åˆ¶
- ç”¨ä¾†è™•ç†æ—¥å¸¸å‡ºå…¥é‡‘
- é¢¨éšªï¼šè¢«é§­å®¢æ”»æ“Š
- å»ºè­°ï¼šåªæ”¾å°‘é‡è³‡é‡‘

ğŸ§Š å†·éŒ¢åŒ…ï¼ˆCold Walletï¼‰ï¼š
- é›¢ç·šéŒ¢åŒ…ï¼Œè¶…ç´šå®‰å…¨
- å­˜æ”¾å¤§éƒ¨åˆ†è³‡é‡‘
- é¢¨éšªï¼šæ“ä½œéº»ç…©
- å»ºè­°ï¼šå®šæœŸå¾ç†±éŒ¢åŒ…è½‰å…¥
</code></pre>
<h3 id="è¨—ç®¡-vs-éè¨—ç®¡"><a class="header" href="#è¨—ç®¡-vs-éè¨—ç®¡">è¨—ç®¡ vs éè¨—ç®¡</a></h3>
<pre><code>ğŸ¦ è¨—ç®¡æ¨¡å¼ï¼ˆæˆ‘å€‘çš„ç³»çµ±ï¼‰ï¼š
- å¹³è‡ºå¹«ä½ ä¿ç®¡ä»£å¹£
- äº¤æ˜“å¿«é€Ÿã€é«”é©—å¥½
- éœ€è¦ä¿¡ä»»å¹³è‡º

ğŸ”‘ éè¨—ç®¡æ¨¡å¼ï¼ˆDeFiï¼‰ï¼š
- ç”¨æˆ¶è‡ªå·±æ§åˆ¶ç§é‘°
- å»ä¸­å¿ƒåŒ–ã€ä¸ç”¨ä¿¡ä»»
- äº¤æ˜“æ…¢ã€Gasè²»é«˜
</code></pre>
<hr />
<h2 id="-è©³ç´°å¿«é€Ÿå•Ÿå‹•æŒ‡å—"><a class="header" href="#-è©³ç´°å¿«é€Ÿå•Ÿå‹•æŒ‡å—">ğŸš€ è©³ç´°å¿«é€Ÿå•Ÿå‹•æŒ‡å—</a></h2>
<h3 id="æº–å‚™å·¥ä½œ5åˆ†é˜"><a class="header" href="#æº–å‚™å·¥ä½œ5åˆ†é˜">æº–å‚™å·¥ä½œï¼ˆ5åˆ†é˜ï¼‰</a></h3>
<pre><code class="language-bash"># æª¢æŸ¥ç³»çµ±éœ€æ±‚
echo "æª¢æŸ¥ Python ç‰ˆæœ¬..."
python3 --version  # éœ€è¦ 3.8+

echo "æª¢æŸ¥ Node.js ç‰ˆæœ¬..."
node --version  # éœ€è¦ 16+

echo "æª¢æŸ¥ Docker..."
docker --version  # éœ€è¦æœ€æ–°ç‰ˆ

echo "æª¢æŸ¥ Git..."
git --version
</code></pre>
<hr />
<h2 id="ç¬¬ä¸€æ­¥å‰µå»ºä»£å¹£è©³ç´°ç‰ˆ---15åˆ†é˜"><a class="header" href="#ç¬¬ä¸€æ­¥å‰µå»ºä»£å¹£è©³ç´°ç‰ˆ---15åˆ†é˜">ç¬¬ä¸€æ­¥ï¼šå‰µå»ºä»£å¹£ï¼ˆè©³ç´°ç‰ˆ - 15åˆ†é˜ï¼‰</a></h2>
<h3 id="11-å®‰è£-solana-å·¥å…·éˆ"><a class="header" href="#11-å®‰è£-solana-å·¥å…·éˆ">1.1 å®‰è£ Solana å·¥å…·éˆ</a></h3>
<pre><code class="language-bash"># macOS/Linux
echo "ğŸ”§ å®‰è£ Solana CLI..."
sh -c "$(curl -sSfL https://release.solana.com/v1.18.4/install)"

# é‡æ–°è¼‰å…¥ç’°å¢ƒè®Šæ•¸
export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"

# é©—è­‰å®‰è£
solana --version
echo "âœ… Solana CLI å®‰è£å®Œæˆ"

# å®‰è£ SPL Token CLI
echo "ğŸ”§ å®‰è£ SPL Token CLI..."
cargo install spl-token-cli --version 3.4.0

# é©—è­‰å®‰è£
spl-token --version
echo "âœ… SPL Token CLI å®‰è£å®Œæˆ"
</code></pre>
<h3 id="12-è¨­å®šéŒ¢åŒ…å’Œç¶²è·¯"><a class="header" href="#12-è¨­å®šéŒ¢åŒ…å’Œç¶²è·¯">1.2 è¨­å®šéŒ¢åŒ…å’Œç¶²è·¯</a></h3>
<pre><code class="language-bash"># è¨­å®šç‚ºæ¸¬è©¦ç¶²
echo "ğŸŒ è¨­å®š Solana æ¸¬è©¦ç¶²..."
solana config set --url https://api.devnet.solana.com

# å‰µå»ºæ–°éŒ¢åŒ…
echo "ğŸ’° å‰µå»ºä¸»éŒ¢åŒ…..."
solana-keygen new --outfile ~/solana-mainnet-wallet.json --force

# è¨­å®šç‚ºé è¨­éŒ¢åŒ…
solana config set --keypair ~/solana-mainnet-wallet.json

# æŸ¥çœ‹éŒ¢åŒ…åœ°å€
WALLET_ADDRESS=$(solana-keygen pubkey ~/solana-mainnet-wallet.json)
echo "éŒ¢åŒ…åœ°å€: $WALLET_ADDRESS"

# æŸ¥çœ‹ç•¶å‰é…ç½®
solana config get
</code></pre>
<h3 id="13-ç²å–æ¸¬è©¦å¹£ä¸¦å‰µå»ºä»£å¹£"><a class="header" href="#13-ç²å–æ¸¬è©¦å¹£ä¸¦å‰µå»ºä»£å¹£">1.3 ç²å–æ¸¬è©¦å¹£ä¸¦å‰µå»ºä»£å¹£</a></h3>
<pre><code class="language-bash">echo "ğŸ’¸ ç²å–æ¸¬è©¦ SOL..."
solana airdrop 2
solana balance

echo "ğŸª™ å‰µå»ºæ–°ä»£å¹£..."
# å‰µå»ºä»£å¹£ï¼ˆ9ä½å°æ•¸ï¼‰
TOKEN_MINT=$(spl-token create-token --decimals 9 2&gt;&amp;1 | grep "Creating token" | awk '{print $3}')
echo "ä»£å¹£åˆç´„åœ°å€: $TOKEN_MINT"

# å‰µå»ºä»£å¹£å¸³æˆ¶
echo "ğŸ“ å‰µå»ºä»£å¹£å¸³æˆ¶..."
TOKEN_ACCOUNT=$(spl-token create-account $TOKEN_MINT 2&gt;&amp;1 | grep "Creating account" | awk '{print $3}')
echo "ä»£å¹£å¸³æˆ¶åœ°å€: $TOKEN_ACCOUNT"

# é‘„é€ ä»£å¹£ï¼ˆ100è¬é¡†ï¼‰
echo "âš¡ é‘„é€  1,000,000 ä»£å¹£..."
spl-token mint $TOKEN_MINT 1000000

# æŸ¥çœ‹é¤˜é¡
spl-token balance $TOKEN_MINT
echo "âœ… ä»£å¹£å‰µå»ºå®Œæˆï¼"

# ä¿å­˜é‡è¦è³‡è¨Š
echo "=== é‡è¦è³‡è¨Š ===" &gt; token_info.txt
echo "éŒ¢åŒ…åœ°å€: $WALLET_ADDRESS" &gt;&gt; token_info.txt
echo "ä»£å¹£åˆç´„: $TOKEN_MINT" &gt;&gt; token_info.txt
echo "ä»£å¹£å¸³æˆ¶: $TOKEN_ACCOUNT" &gt;&gt; token_info.txt
echo "å»ºç«‹æ™‚é–“: $(date)" &gt;&gt; token_info.txt
echo "âœ… ä»£å¹£è³‡è¨Šå·²ä¿å­˜åˆ° token_info.txt"
</code></pre>
<hr />
<h2 id="ç¬¬äºŒæ­¥å»ºç«‹å®Œæ•´ç³»çµ±è©³ç´°ç‰ˆ---45åˆ†é˜"><a class="header" href="#ç¬¬äºŒæ­¥å»ºç«‹å®Œæ•´ç³»çµ±è©³ç´°ç‰ˆ---45åˆ†é˜">ç¬¬äºŒæ­¥ï¼šå»ºç«‹å®Œæ•´ç³»çµ±ï¼ˆè©³ç´°ç‰ˆ - 45åˆ†é˜ï¼‰</a></h2>
<h3 id="21-å‰µå»ºå°ˆæ¡ˆçµæ§‹5åˆ†é˜"><a class="header" href="#21-å‰µå»ºå°ˆæ¡ˆçµæ§‹5åˆ†é˜">2.1 å‰µå»ºå°ˆæ¡ˆçµæ§‹ï¼ˆ5åˆ†é˜ï¼‰</a></h3>
<pre><code class="language-bash">echo "ğŸ“ å‰µå»ºå°ˆæ¡ˆçµæ§‹..."
mkdir -p solana-token-system
cd solana-token-system

# å‰µå»ºç›®éŒ„çµæ§‹
mkdir -p {app/{api,services,utils,models},frontend,docker,scripts,tests,logs,secure}

# å‰µå»º Python æ¨¡çµ„æª”æ¡ˆ
touch app/__init__.py
touch app/api/__init__.py
touch app/services/__init__.py
touch app/utils/__init__.py
touch app/models/__init__.py

echo "âœ… å°ˆæ¡ˆçµæ§‹å‰µå»ºå®Œæˆ"
tree . -I '__pycache__'
</code></pre>
<h3 id="22-è¨­å®š-python-ç’°å¢ƒ5åˆ†é˜"><a class="header" href="#22-è¨­å®š-python-ç’°å¢ƒ5åˆ†é˜">2.2 è¨­å®š Python ç’°å¢ƒï¼ˆ5åˆ†é˜ï¼‰</a></h3>
<pre><code class="language-bash">echo "ğŸ è¨­å®š Python ç’°å¢ƒ..."

# å‰µå»ºè™›æ“¬ç’°å¢ƒ
python3 -m venv venv

# å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
source venv/bin/activate  # macOS/Linux
# Windows: venv\Scripts\activate

# å‡ç´š pip
pip install --upgrade pip

# å‰µå»ºéœ€æ±‚æ–‡ä»¶
cat &gt; requirements.txt &lt;&lt; 'EOF'
# Web æ¡†æ¶
fastapi==0.104.1
uvicorn[standard]==0.24.0

# Solana ç›¸é—œ
solana==0.34.2
solders==0.21.0
spl-token==0.2.0

# è³‡æ–™åº«
asyncpg==0.29.0
psycopg2-binary==2.9.9

# å·¥å…·åº«
pydantic==2.5.0
python-dotenv==1.0.0
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6

# æ¸¬è©¦
pytest==7.4.3
pytest-asyncio==0.21.1
httpx==0.25.2

# å…¶ä»–
aiofiles==23.2.1
websockets==12.0
redis==5.0.1
EOF

# å®‰è£ä¾è³´
echo "ğŸ“¦ å®‰è£ Python ä¾è³´..."
pip install -r requirements.txt

echo "âœ… Python ç’°å¢ƒè¨­å®šå®Œæˆ"
</code></pre>
<h3 id="23-è¨­å®šè³‡æ–™åº«10åˆ†é˜"><a class="header" href="#23-è¨­å®šè³‡æ–™åº«10åˆ†é˜">2.3 è¨­å®šè³‡æ–™åº«ï¼ˆ10åˆ†é˜ï¼‰</a></h3>
<pre><code class="language-bash">echo "ğŸ—„ï¸ è¨­å®šè³‡æ–™åº«..."

# å‰µå»º Docker Compose æ–‡ä»¶
cat &gt; docker-compose.yml &lt;&lt; 'EOF'
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: solana_postgres
    environment:
      POSTGRES_DB: solana_token_db
      POSTGRES_USER: solana_user
      POSTGRES_PASSWORD: solana_password_123
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
    restart: unless-stopped
    
  redis:
    image: redis:7-alpine
    container_name: solana_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    
  adminer:
    image: adminer
    container_name: solana_adminer
    ports:
      - "8080:8080"
    depends_on:
      - postgres

volumes:
  postgres_data:
  redis_data:
EOF

# å‰µå»ºè³‡æ–™åº«åˆå§‹åŒ–è…³æœ¬
cat &gt; scripts/init_db.sql &lt;&lt; 'EOF'
-- ç”¨æˆ¶é¤˜é¡è¡¨
CREATE TABLE IF NOT EXISTS user_balances (
    user_id VARCHAR(64) PRIMARY KEY,
    wallet_address VARCHAR(64) UNIQUE NOT NULL,
    deposit_address VARCHAR(64) UNIQUE,
    token_balance DECIMAL(20,8) DEFAULT 0,
    sol_balance DECIMAL(20,8) DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- äº¤æ˜“è¨˜éŒ„è¡¨
CREATE TABLE IF NOT EXISTS transactions (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    tx_signature VARCHAR(128) UNIQUE,
    type VARCHAR(20) CHECK (type IN ('deposit', 'withdraw', 'internal')),
    amount DECIMAL(20,8) NOT NULL,
    from_address VARCHAR(64),
    to_address VARCHAR(64),
    fee DECIMAL(20,8) DEFAULT 0,
    status VARCHAR(20) DEFAULT 'pending',
    memo TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    confirmed_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user_balances(user_id)
);

-- å…§éƒ¨è½‰å¸³è¡¨
CREATE TABLE IF NOT EXISTS internal_transfers (
    id SERIAL PRIMARY KEY,
    from_user VARCHAR(64) NOT NULL,
    to_user VARCHAR(64) NOT NULL,
    amount DECIMAL(20,8) NOT NULL,
    memo TEXT,
    status VARCHAR(20) DEFAULT 'completed',
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (from_user) REFERENCES user_balances(user_id),
    FOREIGN KEY (to_user) REFERENCES user_balances(user_id)
);

-- ç³»çµ±è¨­ç½®è¡¨
CREATE TABLE IF NOT EXISTS system_settings (
    key VARCHAR(50) PRIMARY KEY,
    value TEXT NOT NULL,
    description TEXT,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- å‰µå»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_user_balances_wallet ON user_balances(wallet_address);
CREATE INDEX IF NOT EXISTS idx_user_balances_deposit ON user_balances(deposit_address);
CREATE INDEX IF NOT EXISTS idx_transactions_user ON transactions(user_id);
CREATE INDEX IF NOT EXISTS idx_transactions_signature ON transactions(tx_signature);
CREATE INDEX IF NOT EXISTS idx_transactions_type ON transactions(type);
CREATE INDEX IF NOT EXISTS idx_transactions_status ON transactions(status);
CREATE INDEX IF NOT EXISTS idx_transactions_created ON transactions(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_internal_transfers_from ON internal_transfers(from_user);
CREATE INDEX IF NOT EXISTS idx_internal_transfers_to ON internal_transfers(to_user);

-- æ’å…¥åŸºæœ¬è¨­ç½®
INSERT INTO system_settings (key, value, description) VALUES
('withdrawal_fee', '0.1', 'æç¾æ‰‹çºŒè²»'),
('min_withdrawal', '10', 'æœ€å°æç¾é‡‘é¡'),
('max_daily_withdrawal', '10000', 'æ¯æ—¥æç¾é™é¡'),
('deposit_confirmations', '12', 'å……å€¼ç¢ºèªå€å¡Šæ•¸'),
('internal_transfer_fee', '0', 'å…§éƒ¨è½‰å¸³æ‰‹çºŒè²»'),
('system_maintenance', 'false', 'ç³»çµ±ç¶­è­·ç‹€æ…‹')
ON CONFLICT (key) DO NOTHING;

-- å‰µå»ºæ¸¬è©¦ç”¨æˆ¶
INSERT INTO user_balances (user_id, wallet_address, token_balance) VALUES
('test_user_1', 'DemoWallet111111111111111111111111111111111', 1000.00),
('test_user_2', 'DemoWallet222222222222222222222222222222222', 500.00)
ON CONFLICT (user_id) DO NOTHING;
EOF

# å•Ÿå‹•è³‡æ–™åº«
echo "ğŸš€ å•Ÿå‹•è³‡æ–™åº«æœå‹™..."
docker-compose up -d postgres redis

# ç­‰å¾…è³‡æ–™åº«å•Ÿå‹•
echo "â³ ç­‰å¾…è³‡æ–™åº«å•Ÿå‹•..."
sleep 10

# æ¸¬è©¦è³‡æ–™åº«é€£æ¥
echo "ğŸ” æ¸¬è©¦è³‡æ–™åº«é€£æ¥..."
docker-compose exec postgres psql -U solana_user -d solana_token_db -c "SELECT 'Database is ready!' as status;"

echo "âœ… è³‡æ–™åº«è¨­å®šå®Œæˆ"
echo "ğŸ“Š è³‡æ–™åº«ç®¡ç†ä»‹é¢: http://localhost:8080"
echo "   ä½¿ç”¨è€…åç¨±: solana_user"
echo "   å¯†ç¢¼: solana_password_123"
echo "   è³‡æ–™åº«: solana_token_db"
</code></pre>
<h3 id="24-å‰µå»ºç’°å¢ƒé…ç½®5åˆ†é˜"><a class="header" href="#24-å‰µå»ºç’°å¢ƒé…ç½®5åˆ†é˜">2.4 å‰µå»ºç’°å¢ƒé…ç½®ï¼ˆ5åˆ†é˜ï¼‰</a></h3>
<pre><code class="language-bash">echo "âš™ï¸ å‰µå»ºç’°å¢ƒé…ç½®..."

# å¾ä¹‹å‰ä¿å­˜çš„ä»£å¹£è³‡è¨Šè®€å–
if [ -f "../token_info.txt" ]; then
    TOKEN_MINT=$(grep "ä»£å¹£åˆç´„:" ../token_info.txt | cut -d' ' -f2)
    WALLET_ADDRESS=$(grep "éŒ¢åŒ…åœ°å€:" ../token_info.txt | cut -d' ' -f2)
else
    echo "âš ï¸ æ‰¾ä¸åˆ°ä»£å¹£è³‡è¨Šï¼Œè«‹æ‰‹å‹•è¨­å®š"
    TOKEN_MINT="YOUR_TOKEN_MINT_ADDRESS"
    WALLET_ADDRESS="YOUR_WALLET_ADDRESS"
fi

# å‰µå»ºç’°å¢ƒè®Šæ•¸æ–‡ä»¶
cat &gt; .env &lt;&lt; EOF
# è³‡æ–™åº«é…ç½®
DATABASE_URL=postgresql://solana_user:solana_password_123@localhost:5432/solana_token_db
REDIS_URL=redis://localhost:6379/0

# Solana é…ç½®
SOLANA_RPC_URL=https://api.devnet.solana.com
SOLANA_NETWORK=devnet
TOKEN_MINT_ADDRESS=$TOKEN_MINT
MAIN_WALLET_ADDRESS=$WALLET_ADDRESS

# éŒ¢åŒ…è·¯å¾‘
HOT_WALLET_PATH=./secure/hot_wallet.json
COLD_WALLET_PATH=./secure/cold_wallet.json

# API é…ç½®
API_V1_STR=/api/v1
PROJECT_NAME=Solana Token System
VERSION=1.0.0
DEBUG=true

# JWT é…ç½®
JWT_SECRET_KEY=your-super-secret-jwt-key-change-this-in-production-min-32-chars
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# å®‰å…¨é…ç½®
ALLOWED_ORIGINS=["http://localhost:3000", "http://localhost:8000"]

# æ¥­å‹™é…ç½®
MIN_WITHDRAWAL_AMOUNT=10.0
MAX_WITHDRAWAL_AMOUNT=100000.0
WITHDRAWAL_FEE_RATE=0.1
DEPOSIT_CONFIRMATION_BLOCKS=12

# æ—¥èªŒé…ç½®
LOG_LEVEL=INFO
LOG_FILE_PATH=./logs/app.log
EOF

# è¤‡è£½ä¸»éŒ¢åŒ…åˆ°å®‰å…¨ç›®éŒ„
echo "ğŸ” è¤‡è£½éŒ¢åŒ…æ–‡ä»¶..."
cp ~/solana-mainnet-wallet.json ./secure/hot_wallet.json
cp ~/solana-mainnet-wallet.json ./secure/cold_wallet.json

# è¨­å®šæ–‡ä»¶æ¬Šé™
chmod 600 ./secure/*.json
chmod 600 .env

echo "âœ… ç’°å¢ƒé…ç½®å®Œæˆ"
</code></pre>
<h3 id="25-å‰µå»ºæ ¸å¿ƒæœå‹™ä»£ç¢¼15åˆ†é˜"><a class="header" href="#25-å‰µå»ºæ ¸å¿ƒæœå‹™ä»£ç¢¼15åˆ†é˜">2.5 å‰µå»ºæ ¸å¿ƒæœå‹™ä»£ç¢¼ï¼ˆ15åˆ†é˜ï¼‰</a></h3>
<pre><code class="language-bash">echo "ğŸ’» å‰µå»ºæ ¸å¿ƒæœå‹™ä»£ç¢¼..."

# å‰µå»ºä¸»è¦çš„ Solana æœå‹™
cat &gt; app/services/solana_service.py &lt;&lt; 'EOF'
import asyncio
import json
import asyncpg
from decimal import Decimal
from typing import Dict, Optional, List
from solana.rpc.async_api import AsyncClient
from solana.rpc.commitment import Confirmed
from solders.pubkey import Pubkey
from solders.keypair import Keypair
from spl.token.async_client import AsyncToken
from spl.token.constants import TOKEN_PROGRAM_ID
import logging

logger = logging.getLogger(__name__)

class SolanaTokenService:
    def __init__(self, rpc_url: str, token_mint: str, hot_wallet_path: str):
        self.client = AsyncClient(rpc_url)
        self.token_mint = Pubkey.from_string(token_mint)
        self.hot_wallet = self._load_wallet(hot_wallet_path)
        self.db_pool = None
        
        logger.info(f"Solana service initialized with RPC: {rpc_url}")
        logger.info(f"Token mint: {token_mint}")
        logger.info(f"Hot wallet: {self.hot_wallet.pubkey()}")
    
    def _load_wallet(self, path: str) -&gt; Keypair:
        """è¼‰å…¥éŒ¢åŒ…ç§é‘°"""
        try:
            with open(path, 'r') as f:
                secret_key = json.load(f)
            return Keypair.from_bytes(bytes(secret_key))
        except Exception as e:
            logger.error(f"Failed to load wallet from {path}: {e}")
            raise
    
    async def init_db_pool(self, database_url: str):
        """åˆå§‹åŒ–è³‡æ–™åº«é€£æ¥æ± """
        try:
            self.db_pool = await asyncpg.create_pool(
                database_url,
                min_size=5,
                max_size=20,
                command_timeout=60
            )
            logger.info("Database connection pool initialized")
        except Exception as e:
            logger.error(f"Failed to initialize database pool: {e}")
            raise
    
    async def create_user_deposit_address(self, user_wallet: str) -&gt; str:
        """ç‚ºç”¨æˆ¶å‰µå»ºå°ˆç”¨å……å€¼åœ°å€"""
        try:
            # ç”Ÿæˆæ–°çš„å……å€¼åœ°å€
            new_keypair = Keypair()
            deposit_address = str(new_keypair.pubkey())
            
            # ä¿å­˜åˆ°è³‡æ–™åº«
            async with self.db_pool.acquire() as conn:
                await conn.execute(
                    """
                    INSERT INTO user_balances (user_id, wallet_address, deposit_address, token_balance)
                    VALUES ($1, $2, $3, 0)
                    ON CONFLICT (user_id) DO UPDATE SET 
                        deposit_address = $3,
                        updated_at = NOW()
                    """,
                    user_wallet, user_wallet, deposit_address
                )
            
            # å®‰å…¨ä¿å­˜å……å€¼åœ°å€ç§é‘°
            deposit_wallet_path = f"./secure/deposit_{user_wallet[:8]}.json"
            with open(deposit_wallet_path, 'w') as f:
                json.dump(list(new_keypair.secret()), f)
            
            logger.info(f"Created deposit address for user {user_wallet}: {deposit_address}")
            return deposit_address
            
        except Exception as e:
            logger.error(f"Failed to create deposit address for {user_wallet}: {e}")
            raise
    
    async def get_user_balance(self, user_id: str) -&gt; Dict[str, Decimal]:
        """æŸ¥è©¢ç”¨æˆ¶é¤˜é¡"""
        try:
            async with self.db_pool.acquire() as conn:
                row = await conn.fetchrow(
                    "SELECT token_balance, sol_balance FROM user_balances WHERE user_id = $1",
                    user_id
                )
                if row:
                    return {
                        'token': Decimal(str(row['token_balance'])),
                        'sol': Decimal(str(row['sol_balance'])) if row['sol_balance'] else Decimal('0')
                    }
                return {'token': Decimal('0'), 'sol': Decimal('0')}
        except Exception as e:
            logger.error(f"Failed to get balance for user {user_id}: {e}")
            raise
    
    async def update_user_balance(self, user_id: str, amount: Decimal, operation: str):
        """æ›´æ–°ç”¨æˆ¶é¤˜é¡"""
        try:
            async with self.db_pool.acquire() as conn:
                if operation == 'add':
                    await conn.execute(
                        "UPDATE user_balances SET token_balance = token_balance + $1, updated_at = NOW() WHERE user_id = $2",
                        amount, user_id
                    )
                elif operation == 'subtract':
                    await conn.execute(
                        "UPDATE user_balances SET token_balance = token_balance - $1, updated_at = NOW() WHERE user_id = $2",
                        amount, user_id
                    )
                    
            logger.info(f"Updated balance for user {user_id}: {operation} {amount}")
        except Exception as e:
            logger.error(f"Failed to update balance for user {user_id}: {e}")
            raise
    
    async def get_all_deposit_addresses(self) -&gt; List[tuple]:
        """ç²å–æ‰€æœ‰ç”¨æˆ¶çš„å……å€¼åœ°å€"""
        try:
            async with self.db_pool.acquire() as conn:
                rows = await conn.fetch(
                    "SELECT user_id, deposit_address FROM user_balances WHERE deposit_address IS NOT NULL"
                )
                return [(row['user_id'], row['deposit_address']) for row in rows]
        except Exception as e:
            logger.error(f"Failed to get deposit addresses: {e}")
            raise
    
    async def record_transaction(self, user_id: str, tx_signature: str, tx_type: str, 
                               amount: Decimal, from_addr: str = None, to_addr: str = None,
                               fee: Decimal = Decimal('0'), status: str = 'confirmed'):
        """è¨˜éŒ„äº¤æ˜“"""
        try:
            async with self.db_pool.acquire() as conn:
                await conn.execute(
                    """
                    INSERT INTO transactions 
                    (user_id, tx_signature, type, amount, from_address, to_address, fee, status, confirmed_at)
                    VALUES ($1, $2, $3, $4, $5, $6, $7, $8, NOW())
                    ON CONFLICT (tx_signature) DO NOTHING
                    """,
                    user_id, tx_signature, tx_type, amount, from_addr, to_addr, fee, status
                )
            logger.info(f"Recorded transaction for user {user_id}: {tx_type} {amount}")
        except Exception as e:
            logger.error(f"Failed to record transaction: {e}")
            raise
EOF

# å‰µå»ºå……å€¼ç›£æ§æœå‹™
cat &gt; app/services/deposit_monitor.py &lt;&lt; 'EOF'
import asyncio
import logging
from typing import Set
from decimal import Decimal
from solana.rpc.async_api import AsyncClient
from solana.rpc.commitment import Confirmed
from solders.pubkey import Pubkey

logger = logging.getLogger(__name__)

class DepositMonitor:
    def __init__(self, solana_service):
        self.service = solana_service
        self.processed_signatures: Set[str] = set()
        self.is_running = False
        self.check_interval = 10  # æ¯10ç§’æª¢æŸ¥ä¸€æ¬¡
    
    async def start_monitoring(self):
        """é–‹å§‹ç›£æ§å……å€¼"""
        self.is_running = True
        logger.info("ğŸ” Deposit monitoring started")
        
        while self.is_running:
            try:
                await self.check_all_deposits()
                await asyncio.sleep(self.check_interval)
            except Exception as e:
                logger.error(f"Monitoring error: {e}")
                await asyncio.sleep(30)  # å‡ºéŒ¯ç­‰30ç§’å†è©¦
    
    async def stop_monitoring(self):
        """åœæ­¢ç›£æ§"""
        self.is_running = False
        logger.info("ğŸ›‘ Deposit monitoring stopped")
    
    async def check_all_deposits(self):
        """æª¢æŸ¥æ‰€æœ‰ç”¨æˆ¶çš„å……å€¼"""
        try:
            deposit_addresses = await self.service.get_all_deposit_addresses()
            
            for user_id, deposit_address in deposit_addresses:
                if deposit_address:
                    await self.check_user_deposits(user_id, deposit_address)
                    
        except Exception as e:
            logger.error(f"Failed to check deposits: {e}")
    
    async def check_user_deposits(self, user_id: str, deposit_address: str):
        """æª¢æŸ¥å–®ä¸€ç”¨æˆ¶çš„å……å€¼"""
        try:
            pubkey = Pubkey.from_string(deposit_address)
            
            # ç²å–æœ€è¿‘çš„äº¤æ˜“ç°½å
            signatures = await self.service.client.get_signatures_for_address(
                pubkey,
                limit=20,
                commitment=Confirmed
            )
            
            for sig_info in signatures.value:
                signature = sig_info.signature
                
                # è·³éå·²è™•ç†çš„äº¤æ˜“
                if signature in self.processed_signatures:
                    continue
                
                # è™•ç†æ–°äº¤æ˜“
                await self.process_deposit_transaction(user_id, signature, deposit_address)
                self.processed_signatures.add(signature)
                
        except Exception as e:
            logger.error(f"Failed to check deposits for user {user_id}: {e}")
    
    async def process_deposit_transaction(self, user_id: str, signature: str, deposit_address: str):
        """è™•ç†å……å€¼äº¤æ˜“"""
        try:
            # ç²å–äº¤æ˜“è©³æƒ…
            tx_response = await self.service.client.get_transaction(
                signature,
                commitment=Confirmed
            )
            
            if not tx_response.value:
                return
            
            # ç°¡åŒ–ç‰ˆæœ¬ï¼šå‡è¨­æ¯ç­†åˆ°é€™å€‹åœ°å€çš„äº¤æ˜“éƒ½æ˜¯æœ‰æ•ˆå……å€¼
            # å¯¦éš›éœ€è¦è§£æäº¤æ˜“è©³æƒ…ä¾†ç¢ºå®šæº–ç¢ºé‡‘é¡
            amount = Decimal('100')  # ç¤ºä¾‹é‡‘é¡
            
            # æ›´æ–°ç”¨æˆ¶é¤˜é¡
            await self.service.update_user_balance(user_id, amount, 'add')
            
            # è¨˜éŒ„äº¤æ˜“
            await self.service.record_transaction(
                user_id, signature, 'deposit', amount, 
                from_addr='external', to_addr=deposit_address
            )
            
            logger.info(f"âœ… Processed deposit for user {user_id}: {amount} tokens")
            
        except Exception as e:
            logger.error(f"Failed to process deposit transaction {signature}: {e}")
EOF

# å‰µå»º FastAPI ä¸»æ‡‰ç”¨
cat &gt; app/main.py &lt;&lt; 'EOF'
import os
import asyncio
import logging
from contextlib import asynccontextmanager
from fastapi import FastAPI, HTTPException, Depends
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from decimal import Decimal
from typing import Optional
from dotenv import load_dotenv

from .services.solana_service import SolanaTokenService
from .services.deposit_monitor import DepositMonitor

# è¼‰å…¥ç’°å¢ƒè®Šæ•¸
load_dotenv()

# è¨­å®šæ—¥èªŒ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# å…¨åŸŸæœå‹™å¯¦ä¾‹
solana_service = None
deposit_monitor = None

@asynccontextmanager
async def lifespan(app: FastAPI):
    # å•Ÿå‹•æ™‚
    global solana_service, deposit_monitor
    
    logger.info("ğŸš€ Starting Solana Token System...")
    
    # åˆå§‹åŒ– Solana æœå‹™
    solana_service = SolanaTokenService(
        rpc_url=os.getenv("SOLANA_RPC_URL"),
        token_mint=os.getenv("TOKEN_MINT_ADDRESS"),
        hot_wallet_path=os.getenv("HOT_WALLET_PATH")
    )
    
    await solana_service.init_db_pool(os.getenv("DATABASE_URL"))
    
    # åˆå§‹åŒ–å……å€¼ç›£æ§
    deposit_monitor = DepositMonitor(solana_service)
    
    # åœ¨èƒŒæ™¯å•Ÿå‹•ç›£æ§
    monitor_task = asyncio.create_task(deposit_monitor.start_monitoring())
    
    logger.info("âœ… System started successfully")
    
    yield
    
    # é—œé–‰æ™‚
    logger.info("ğŸ›‘ Shutting down system...")
    if deposit_monitor:
        await deposit_monitor.stop_monitoring()
    
    monitor_task.cancel()
    logger.info("âœ… System shutdown complete")

# å‰µå»º FastAPI æ‡‰ç”¨
app = FastAPI(
    title="Solana Token System API",
    description="å®Œæ•´çš„ Solana ä»£å¹£å‡ºå…¥é‡‘ç³»çµ±",
    version="1.0.0",
    lifespan=lifespan
)

# CORS è¨­ç½®
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # é–‹ç™¼ç’°å¢ƒï¼Œç”Ÿç”¢ç’°å¢ƒæ‡‰é™åˆ¶
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# è«‹æ±‚æ¨¡å‹
class RegisterRequest(BaseModel):
    wallet_address: str

class WithdrawRequest(BaseModel):
    user_id: str
    amount: Decimal
    to_address: str

class TransferRequest(BaseModel):
    from_user: str
    to_user: str
    amount: Decimal
    memo: Optional[str] = ""

# éŸ¿æ‡‰æ¨¡å‹
class BalanceResponse(BaseModel):
    user_id: str
    token_balance: str
    sol_balance: str
    deposit_address: Optional[str] = None

# API ç«¯é»
@app.get("/")
async def root():
    return {
        "message": "Solana Token System API",
        "version": "1.0.0",
        "status": "running"
    }

@app.get("/health")
async def health_check():
    """å¥åº·æª¢æŸ¥ç«¯é»"""
    try:
        # æª¢æŸ¥ Solana é€£æ¥
        health = await solana_service.client.get_health()
        
        # æª¢æŸ¥è³‡æ–™åº«
        async with solana_service.db_pool.acquire() as conn:
            await conn.fetchval("SELECT 1")
        
        return {
            "status": "healthy",
            "solana_rpc": "connected",
            "database": "connected",
            "deposit_monitor": "running" if deposit_monitor.is_running else "stopped"
        }
    except Exception as e:
        return {
            "status": "unhealthy",
            "error": str(e)
        }

@app.post("/api/register")
async def register_user(request: RegisterRequest):
    """ç”¨æˆ¶è¨»å†Š"""
    try:
        # é©—è­‰éŒ¢åŒ…åœ°å€æ ¼å¼
        from solders.pubkey import Pubkey
        Pubkey.from_string(request.wallet_address)
        
        # å‰µå»ºå……å€¼åœ°å€
        deposit_address = await solana_service.create_user_deposit_address(request.wallet_address)
        
        return {
            "success": True,
            "user_id": request.wallet_address,
            "deposit_address": deposit_address,
            "message": "è¨»å†ŠæˆåŠŸ"
        }
    except Exception as e:
        logger.error(f"Registration failed for {request.wallet_address}: {e}")
        raise HTTPException(status_code=400, detail=f"è¨»å†Šå¤±æ•—: {str(e)}")

@app.get("/api/balance/{user_id}", response_model=BalanceResponse)
async def get_balance(user_id: str):
    """æŸ¥è©¢ç”¨æˆ¶é¤˜é¡"""
    try:
        balance = await solana_service.get_user_balance(user_id)
        
        # ç²å–å……å€¼åœ°å€
        async with solana_service.db_pool.acquire() as conn:
            deposit_addr = await conn.fetchval(
                "SELECT deposit_address FROM user_balances WHERE user_id = $1",
                user_id
            )
        
        return BalanceResponse(
            user_id=user_id,
            token_balance=str(balance['token']),
            sol_balance=str(balance['sol']),
            deposit_address=deposit_addr
        )
    except Exception as e:
        logger.error(f"Get balance failed for {user_id}: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/withdraw")
async def withdraw(request: WithdrawRequest):
    """æç¾åˆ°ç”¨æˆ¶éŒ¢åŒ…ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰"""
    try:
        # æª¢æŸ¥é¤˜é¡
        balance = await solana_service.get_user_balance(request.user_id)
        if balance['token'] &lt; request.amount:
            raise HTTPException(status_code=400, detail="é¤˜é¡ä¸è¶³")
        
        # ç°¡åŒ–ï¼šç›´æ¥æ‰£é™¤é¤˜é¡ï¼ˆå¯¦éš›éœ€è¦å€å¡Šéˆè½‰å¸³ï¼‰
        await solana_service.update_user_balance(request.user_id, request.amount, 'subtract')
        
        # è¨˜éŒ„äº¤æ˜“
        await solana_service.record_transaction(
            request.user_id, f"withdraw_{request.user_id}_{request.amount}", 
            'withdraw', request.amount, to_addr=request.to_address
        )
        
        return {
            "success": True,
            "message": f"æç¾ {request.amount} ä»£å¹£æˆåŠŸ",
            "amount": str(request.amount),
            "to_address": request.to_address
        }
    except Exception as e:
        logger.error(f"Withdrawal failed: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/transfer")
async def internal_transfer(request: TransferRequest):
    """å…§éƒ¨è½‰å¸³"""
    try:
        # æª¢æŸ¥ç™¼é€æ–¹é¤˜é¡
        sender_balance = await solana_service.get_user_balance(request.from_user)
        if sender_balance['token'] &lt; request.amount:
            raise HTTPException(status_code=400, detail="é¤˜é¡ä¸è¶³")
        
        # æª¢æŸ¥æ¥æ”¶æ–¹æ˜¯å¦å­˜åœ¨
        receiver_balance = await solana_service.get_user_balance(request.to_user)
        if receiver_balance['token'] == Decimal('0') and receiver_balance['sol'] == Decimal('0'):
            # å¯èƒ½æ˜¯æ–°ç”¨æˆ¶ï¼Œæª¢æŸ¥æ˜¯å¦åœ¨è³‡æ–™åº«ä¸­
            async with solana_service.db_pool.acquire() as conn:
                exists = await conn.fetchval(
                    "SELECT EXISTS(SELECT 1 FROM user_balances WHERE user_id = $1)",
                    request.to_user
                )
                if not exists:
                    raise HTTPException(status_code=400, detail="æ¥æ”¶æ–¹ç”¨æˆ¶ä¸å­˜åœ¨")
        
        # åŸ·è¡Œè½‰å¸³
        async with solana_service.db_pool.acquire() as conn:
            async with conn.transaction():
                # æ‰£é™¤ç™¼é€æ–¹é¤˜é¡
                await conn.execute(
                    "UPDATE user_balances SET token_balance = token_balance - $1 WHERE user_id = $2",
                    request.amount, request.from_user
                )
                
                # å¢åŠ æ¥æ”¶æ–¹é¤˜é¡
                await conn.execute(
                    "UPDATE user_balances SET token_balance = token_balance + $1 WHERE user_id = $2",
                    request.amount, request.to_user
                )
                
                # è¨˜éŒ„å…§éƒ¨è½‰å¸³
                await conn.execute(
                    """
                    INSERT INTO internal_transfers (from_user, to_user, amount, memo, status, created_at)
                    VALUES ($1, $2, $3, $4, 'completed', NOW())
                    """,
                    request.from_user, request.to_user, request.amount, request.memo
                )
        
        logger.info(f"Internal transfer: {request.from_user} -&gt; {request.to_user}, amount: {request.amount}")
        
        return {
            "success": True,
            "message": "è½‰å¸³æˆåŠŸ",
            "from_user": request.from_user,
            "to_user": request.to_user,
            "amount": str(request.amount),
            "memo": request.memo
        }
    except Exception as e:
        logger.error(f"Internal transfer failed: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/transactions/{user_id}")
async def get_transactions(user_id: str, limit: int = 50):
    """æŸ¥è©¢ç”¨æˆ¶äº¤æ˜“æ­·å²"""
    try:
        async with solana_service.db_pool.acquire() as conn:
            # å€å¡Šéˆäº¤æ˜“
            blockchain_txs = await conn.fetch(
                """
                SELECT tx_signature, type, amount, from_address, to_address, fee, status, created_at
                FROM transactions 
                WHERE user_id = $1 
                ORDER BY created_at DESC 
                LIMIT $2
                """,
                user_id, limit
            )
            
            # å…§éƒ¨è½‰å¸³
            internal_txs = await conn.fetch(
                """
                SELECT id, from_user, to_user, amount, memo, status, created_at
                FROM internal_transfers 
                WHERE from_user = $1 OR to_user = $1
                ORDER BY created_at DESC 
                LIMIT $2
                """,
                user_id, limit
            )
        
        transactions = []
        
        # è™•ç†å€å¡Šéˆäº¤æ˜“
        for tx in blockchain_txs:
            transactions.append({
                "type": "blockchain",
                "tx_type": tx['type'],
                "signature": tx['tx_signature'],
                "amount": str(tx['amount']),
                "from_address": tx['from_address'],
                "to_address": tx['to_address'],
                "fee": str(tx['fee']) if tx['fee'] else "0",
                "status": tx['status'],
                "created_at": tx['created_at'].isoformat()
            })
        
        # è™•ç†å…§éƒ¨è½‰å¸³
        for tx in internal_txs:
            transactions.append({
                "type": "internal",
                "tx_type": "transfer_out" if tx['from_user'] == user_id else "transfer_in",
                "id": tx['id'],
                "amount": str(tx['amount']),
                "from_user": tx['from_user'],
                "to_user": tx['to_user'],
                "memo": tx['memo'],
                "status": tx['status'],
                "created_at": tx['created_at'].isoformat()
            })
        
        # æŒ‰æ™‚é–“æ’åº
        transactions.sort(key=lambda x: x['created_at'], reverse=True)
        
        return {"transactions": transactions[:limit]}
        
    except Exception as e:
        logger.error(f"Get transactions failed for {user_id}: {e}")
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
EOF

echo "âœ… æ ¸å¿ƒæœå‹™ä»£ç¢¼å‰µå»ºå®Œæˆ"
</code></pre>
<h3 id="26-å‰µå»ºå•Ÿå‹•è…³æœ¬5åˆ†é˜"><a class="header" href="#26-å‰µå»ºå•Ÿå‹•è…³æœ¬5åˆ†é˜">2.6 å‰µå»ºå•Ÿå‹•è…³æœ¬ï¼ˆ5åˆ†é˜ï¼‰</a></h3>
<pre><code class="language-bash">echo "ğŸš€ å‰µå»ºå•Ÿå‹•è…³æœ¬..."

# å‰µå»ºé–‹ç™¼ç’°å¢ƒå•Ÿå‹•è…³æœ¬
cat &gt; start_dev.sh &lt;&lt; 'EOF'
#!/bin/bash

echo "ğŸš€ å•Ÿå‹• Solana Token System é–‹ç™¼ç’°å¢ƒ..."

# æª¢æŸ¥è™›æ“¬ç’°å¢ƒ
if [ ! -d "venv" ]; then
    echo "âŒ è™›æ“¬ç’°å¢ƒä¸å­˜åœ¨ï¼Œè«‹å…ˆé‹è¡Œè¨­å®šè…³æœ¬"
    exit 1
fi

# å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
source venv/bin/activate

# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
if [ ! -f ".env" ]; then
    echo "âŒ .env æ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

# æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦é‹è¡Œ
echo "ğŸ” æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹..."
if ! docker-compose ps postgres | grep -q "Up"; then
    echo "ğŸš€ å•Ÿå‹•è³‡æ–™åº«..."
    docker-compose up -d postgres redis
    echo "â³ ç­‰å¾…è³‡æ–™åº«å•Ÿå‹•..."
    sleep 10
fi

# æª¢æŸ¥éŒ¢åŒ…æ–‡ä»¶
if [ ! -f "./secure/hot_wallet.json" ]; then
    echo "âŒ éŒ¢åŒ…æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥ ./secure/hot_wallet.json"
    exit 1
fi

# å•Ÿå‹• API ä¼ºæœå™¨
echo "ğŸŒ å•Ÿå‹• API ä¼ºæœå™¨..."
echo "ğŸ“± API åœ°å€: http://localhost:8000"
echo "ğŸ“š API æ–‡æª”: http://localhost:8000/docs"
echo "ğŸ¥ å¥åº·æª¢æŸ¥: http://localhost:8000/health"
echo ""
echo "æŒ‰ Ctrl+C åœæ­¢æœå‹™"

uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
EOF

# è¨­å®šåŸ·è¡Œæ¬Šé™
chmod +x start_dev.sh

# å‰µå»ºæ¸¬è©¦è…³æœ¬
cat &gt; test_api.sh &lt;&lt; 'EOF'
#!/bin/bash

echo "ğŸ§ª æ¸¬è©¦ API åŠŸèƒ½..."

BASE_URL="http://localhost:8000"

echo "1. æ¸¬è©¦å¥åº·æª¢æŸ¥..."
curl -s "$BASE_URL/health" | python3 -m json.tool

echo -e "\n2. æ¸¬è©¦ç”¨æˆ¶è¨»å†Š..."
curl -s -X POST "$BASE_URL/api/register" \
  -H "Content-Type: application/json" \
  -d '{"wallet_address": "DemoWallet111111111111111111111111111111111"}' | python3 -m json.tool

echo -e "\n3. æ¸¬è©¦æŸ¥è©¢é¤˜é¡..."
curl -s "$BASE_URL/api/balance/DemoWallet111111111111111111111111111111111" | python3 -m json.tool

echo -e "\n4. æ¸¬è©¦å…§éƒ¨è½‰å¸³..."
curl -s -X POST "$BASE_URL/api/transfer" \
  -H "Content-Type: application/json" \
  -d '{"from_user": "test_user_1", "to_user": "test_user_2", "amount": 50, "memo": "æ¸¬è©¦è½‰å¸³"}' | python3 -m json.tool

echo -e "\n5. æ¸¬è©¦äº¤æ˜“æ­·å²..."
curl -s "$BASE_URL/api/transactions/test_user_1" | python3 -m json.tool

echo -e "\nâœ… API æ¸¬è©¦å®Œæˆ"
EOF

chmod +x test_api.sh

echo "âœ… å•Ÿå‹•è…³æœ¬å‰µå»ºå®Œæˆ"
</code></pre>
<h3 id="27-å‰µå»ºå‰ç«¯ä»‹é¢10åˆ†é˜"><a class="header" href="#27-å‰µå»ºå‰ç«¯ä»‹é¢10åˆ†é˜">2.7 å‰µå»ºå‰ç«¯ä»‹é¢ï¼ˆ10åˆ†é˜ï¼‰</a></h3>
<pre><code class="language-bash">echo "ğŸ¨ å‰µå»ºç°¡å–®çš„å‰ç«¯ä»‹é¢..."

# å‰µå»ºç°¡å–®çš„ HTML æ¸¬è©¦é é¢
mkdir -p frontend/static

cat &gt; frontend/static/index.html &lt;&lt; 'EOF'
&lt;!DOCTYPE html&gt;
&lt;html lang="zh-TW"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;Solana Token System&lt;/title&gt;
    &lt;style&gt;
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .success {
            color: green;
            background-color: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .error {
            color: red;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .balance {
            font-size: 24px;
            color: #28a745;
            font-weight: bold;
        }
        .address {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            word-break: break-all;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;ğŸª™ Solana Token System æ¸¬è©¦ä»‹é¢&lt;/h1&gt;
    
    &lt;!-- ç”¨æˆ¶è¨»å†Š --&gt;
    &lt;div class="container"&gt;
        &lt;h2&gt;1. ç”¨æˆ¶è¨»å†Š&lt;/h2&gt;
        &lt;div class="form-group"&gt;
            &lt;label for="wallet_address"&gt;éŒ¢åŒ…åœ°å€:&lt;/label&gt;
            &lt;input type="text" id="wallet_address" placeholder="ä¾‹å¦‚: DemoWallet111111111111111111111111111111111"&gt;
        &lt;/div&gt;
        &lt;button onclick="registerUser()"&gt;è¨»å†Šç”¨æˆ¶&lt;/button&gt;
        &lt;div id="register_result"&gt;&lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- æŸ¥è©¢é¤˜é¡ --&gt;
    &lt;div class="container"&gt;
        &lt;h2&gt;2. æŸ¥è©¢é¤˜é¡&lt;/h2&gt;
        &lt;div class="form-group"&gt;
            &lt;label for="user_id"&gt;ç”¨æˆ¶ID:&lt;/label&gt;
            &lt;input type="text" id="user_id" placeholder="éŒ¢åŒ…åœ°å€æˆ–ç”¨æˆ¶ID"&gt;
        &lt;/div&gt;
        &lt;button onclick="getBalance()"&gt;æŸ¥è©¢é¤˜é¡&lt;/button&gt;
        &lt;div id="balance_result"&gt;&lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- å…§éƒ¨è½‰å¸³ --&gt;
    &lt;div class="container"&gt;
        &lt;h2&gt;3. å…§éƒ¨è½‰å¸³&lt;/h2&gt;
        &lt;div class="form-group"&gt;
            &lt;label for="from_user"&gt;ç™¼é€æ–¹:&lt;/label&gt;
            &lt;input type="text" id="from_user" value="test_user_1"&gt;
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
            &lt;label for="to_user"&gt;æ¥æ”¶æ–¹:&lt;/label&gt;
            &lt;input type="text" id="to_user" value="test_user_2"&gt;
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
            &lt;label for="amount"&gt;é‡‘é¡:&lt;/label&gt;
            &lt;input type="number" id="amount" placeholder="ä¾‹å¦‚: 100" step="0.01"&gt;
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
            &lt;label for="memo"&gt;å‚™è¨»:&lt;/label&gt;
            &lt;input type="text" id="memo" placeholder="å¯é¸"&gt;
        &lt;/div&gt;
        &lt;button onclick="transferTokens()"&gt;è½‰å¸³&lt;/button&gt;
        &lt;div id="transfer_result"&gt;&lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- äº¤æ˜“æ­·å² --&gt;
    &lt;div class="container"&gt;
        &lt;h2&gt;4. äº¤æ˜“æ­·å²&lt;/h2&gt;
        &lt;div class="form-group"&gt;
            &lt;label for="history_user_id"&gt;ç”¨æˆ¶ID:&lt;/label&gt;
            &lt;input type="text" id="history_user_id" value="test_user_1"&gt;
        &lt;/div&gt;
        &lt;button onclick="getTransactions()"&gt;æŸ¥è©¢äº¤æ˜“&lt;/button&gt;
        &lt;div id="transactions_result"&gt;&lt;/div&gt;
    &lt;/div&gt;
    
    &lt;script&gt;
        const API_BASE = 'http://localhost:8000';
        
        async function registerUser() {
            const walletAddress = document.getElementById('wallet_address').value;
            if (!walletAddress) {
                showResult('register_result', 'è«‹è¼¸å…¥éŒ¢åŒ…åœ°å€', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({wallet_address: walletAddress})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('register_result', `
                        &lt;strong&gt;è¨»å†ŠæˆåŠŸï¼&lt;/strong&gt;&lt;br&gt;
                        ç”¨æˆ¶ID: ${result.user_id}&lt;br&gt;
                        å……å€¼åœ°å€: &lt;div class="address"&gt;${result.deposit_address}&lt;/div&gt;
                    `, 'success');
                    
                    // è‡ªå‹•å¡«å…¥æŸ¥è©¢é¤˜é¡çš„æ¬„ä½
                    document.getElementById('user_id').value = result.user_id;
                } else {
                    showResult('register_result', result.detail || 'è¨»å†Šå¤±æ•—', 'error');
                }
            } catch (error) {
                showResult('register_result', `éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        async function getBalance() {
            const userId = document.getElementById('user_id').value;
            if (!userId) {
                showResult('balance_result', 'è«‹è¼¸å…¥ç”¨æˆ¶ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/balance/${encodeURIComponent(userId)}`);
                const result = await response.json();
                
                if (response.ok) {
                    showResult('balance_result', `
                        &lt;div class="balance"&gt;ä»£å¹£é¤˜é¡: ${result.token_balance}&lt;/div&gt;
                        SOL é¤˜é¡: ${result.sol_balance}&lt;br&gt;
                        ${result.deposit_address ? `å……å€¼åœ°å€: &lt;div class="address"&gt;${result.deposit_address}&lt;/div&gt;` : ''}
                    `, 'success');
                } else {
                    showResult('balance_result', result.detail || 'æŸ¥è©¢å¤±æ•—', 'error');
                }
            } catch (error) {
                showResult('balance_result', `éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        async function transferTokens() {
            const fromUser = document.getElementById('from_user').value;
            const toUser = document.getElementById('to_user').value;
            const amount = document.getElementById('amount').value;
            const memo = document.getElementById('memo').value;
            
            if (!fromUser || !toUser || !amount) {
                showResult('transfer_result', 'è«‹å¡«å…¥å¿…è¦æ¬„ä½', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/transfer`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        from_user: fromUser,
                        to_user: toUser,
                        amount: parseFloat(amount),
                        memo: memo
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('transfer_result', `
                        &lt;strong&gt;è½‰å¸³æˆåŠŸï¼&lt;/strong&gt;&lt;br&gt;
                        å¾: ${result.from_user}&lt;br&gt;
                        åˆ°: ${result.to_user}&lt;br&gt;
                        é‡‘é¡: ${result.amount}&lt;br&gt;
                        å‚™è¨»: ${result.memo || 'ç„¡'}
                    `, 'success');
                } else {
                    showResult('transfer_result', result.detail || 'è½‰å¸³å¤±æ•—', 'error');
                }
            } catch (error) {
                showResult('transfer_result', `éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        async function getTransactions() {
            const userId = document.getElementById('history_user_id').value;
            if (!userId) {
                showResult('transactions_result', 'è«‹è¼¸å…¥ç”¨æˆ¶ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/transactions/${encodeURIComponent(userId)}`);
                const result = await response.json();
                
                if (response.ok &amp;&amp; result.transactions) {
                    let html = '&lt;h3&gt;äº¤æ˜“æ­·å²:&lt;/h3&gt;';
                    
                    if (result.transactions.length === 0) {
                        html += '&lt;p&gt;æš«ç„¡äº¤æ˜“è¨˜éŒ„&lt;/p&gt;';
                    } else {
                        result.transactions.forEach(tx =&gt; {
                            html += `
                                &lt;div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;"&gt;
                                    &lt;strong&gt;${tx.tx_type}&lt;/strong&gt; (${tx.type})&lt;br&gt;
                                    é‡‘é¡: ${tx.amount}&lt;br&gt;
                                    ç‹€æ…‹: ${tx.status}&lt;br&gt;
                                    æ™‚é–“: ${new Date(tx.created_at).toLocaleString()}&lt;br&gt;
                                    ${tx.memo ? `å‚™è¨»: ${tx.memo}&lt;br&gt;` : ''}
                                    ${tx.signature ? `ç°½å: ${tx.signature}` : ''}
                                    ${tx.from_user ? `ç™¼é€æ–¹: ${tx.from_user}&lt;br&gt;æ¥æ”¶æ–¹: ${tx.to_user}` : ''}
                                &lt;/div&gt;
                            `;
                        });
                    }
                    
                    showResult('transactions_result', html, 'success');
                } else {
                    showResult('transactions_result', result.detail || 'æŸ¥è©¢å¤±æ•—', 'error');
                }
            } catch (error) {
                showResult('transactions_result', `éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `&lt;div class="${type}"&gt;${message}&lt;/div&gt;`;
        }
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
EOF

echo "âœ… å‰ç«¯ä»‹é¢å‰µå»ºå®Œæˆ"
echo "ğŸ“± æ¸¬è©¦é é¢: ./frontend/static/index.html"
</code></pre>
<hr />
<h2 id="ç¬¬ä¸‰æ­¥ä¸€éµå•Ÿå‹•ç³»çµ±5åˆ†é˜"><a class="header" href="#ç¬¬ä¸‰æ­¥ä¸€éµå•Ÿå‹•ç³»çµ±5åˆ†é˜">ç¬¬ä¸‰æ­¥ï¼šä¸€éµå•Ÿå‹•ç³»çµ±ï¼ˆ5åˆ†é˜ï¼‰</a></h2>
<h3 id="31-å‰µå»ºç¸½æ§åˆ¶è…³æœ¬"><a class="header" href="#31-å‰µå»ºç¸½æ§åˆ¶è…³æœ¬">3.1 å‰µå»ºç¸½æ§åˆ¶è…³æœ¬</a></h3>
<pre><code class="language-bash">echo "ğŸ¯ å‰µå»ºä¸€éµå•Ÿå‹•è…³æœ¬..."

cat &gt; launch_system.sh &lt;&lt; 'EOF'
#!/bin/bash

echo "ğŸš€ Solana Token System ä¸€éµå•Ÿå‹•"
echo "=================================="

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æª¢æŸ¥å‡½æ•¸
check_requirement() {
    if command -v $1 &amp;&gt; /dev/null; then
        echo -e "${GREEN}âœ… $1 å·²å®‰è£${NC}"
        return 0
    else
        echo -e "${RED}âŒ $1 æœªå®‰è£${NC}"
        return 1
    fi
}

# æª¢æŸ¥ç³»çµ±éœ€æ±‚
echo -e "${BLUE}ğŸ“‹ æª¢æŸ¥ç³»çµ±éœ€æ±‚...${NC}"
requirements_met=true

if ! check_requirement "python3"; then requirements_met=false; fi
if ! check_requirement "docker"; then requirements_met=false; fi
if ! check_requirement "docker-compose"; then requirements_met=false; fi

if [ "$requirements_met" = false ]; then
    echo -e "${RED}âŒ è«‹å…ˆå®‰è£ç¼ºå°‘çš„ä¾è³´${NC}"
    exit 1
fi

# æª¢æŸ¥å°ˆæ¡ˆæ–‡ä»¶
echo -e "${BLUE}ğŸ“ æª¢æŸ¥å°ˆæ¡ˆæ–‡ä»¶...${NC}"
if [ ! -f ".env" ]; then
    echo -e "${RED}âŒ .env æ–‡ä»¶ä¸å­˜åœ¨${NC}"
    exit 1
fi

if [ ! -f "requirements.txt" ]; then
    echo -e "${RED}âŒ requirements.txt æ–‡ä»¶ä¸å­˜åœ¨${NC}"
    exit 1
fi

if [ ! -f "./secure/hot_wallet.json" ]; then
    echo -e "${RED}âŒ éŒ¢åŒ…æ–‡ä»¶ä¸å­˜åœ¨: ./secure/hot_wallet.json${NC}"
    exit 1
fi

# å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
echo -e "${BLUE}ğŸ å•Ÿå‹• Python è™›æ“¬ç’°å¢ƒ...${NC}"
if [ ! -d "venv" ]; then
    echo -e "${YELLOW}âš ï¸ è™›æ“¬ç’°å¢ƒä¸å­˜åœ¨ï¼Œæ­£åœ¨å‰µå»º...${NC}"
    python3 -m venv venv
    source venv/bin/activate
    pip install --upgrade pip
    pip install -r requirements.txt
else
    source venv/bin/activate
fi

# å•Ÿå‹•è³‡æ–™åº«
echo -e "${BLUE}ğŸ—„ï¸ å•Ÿå‹•è³‡æ–™åº«æœå‹™...${NC}"
docker-compose up -d postgres redis

# ç­‰å¾…è³‡æ–™åº«å•Ÿå‹•
echo -e "${YELLOW}â³ ç­‰å¾…è³‡æ–™åº«å•Ÿå‹•ï¼ˆ10ç§’ï¼‰...${NC}"
sleep 10

# æ¸¬è©¦è³‡æ–™åº«é€£æ¥
echo -e "${BLUE}ğŸ” æ¸¬è©¦è³‡æ–™åº«é€£æ¥...${NC}"
if docker-compose exec -T postgres psql -U solana_user -d solana_token_db -c "SELECT 'OK' as status;" &gt; /dev/null 2&gt;&amp;1; then
    echo -e "${GREEN}âœ… è³‡æ–™åº«é€£æ¥æ­£å¸¸${NC}"
else
    echo -e "${RED}âŒ è³‡æ–™åº«é€£æ¥å¤±æ•—${NC}"
    exit 1
fi

# å•Ÿå‹• API æœå‹™
echo -e "${BLUE}ğŸŒ å•Ÿå‹• API æœå‹™...${NC}"
echo ""
echo "=================================="
echo -e "${GREEN}ğŸ‰ ç³»çµ±å•Ÿå‹•æˆåŠŸï¼${NC}"
echo ""
echo -e "${YELLOW}ğŸ“± API æœå‹™: http://localhost:8000${NC}"
echo -e "${YELLOW}ğŸ“š API æ–‡æª”: http://localhost:8000/docs${NC}"
echo -e "${YELLOW}ğŸ¥ å¥åº·æª¢æŸ¥: http://localhost:8000/health${NC}"
echo -e "${YELLOW}ğŸ¨ æ¸¬è©¦ä»‹é¢: ç”¨ç€è¦½å™¨æ‰“é–‹ frontend/static/index.html${NC}"
echo -e "${YELLOW}ğŸ“Š è³‡æ–™åº«ç®¡ç†: http://localhost:8080${NC}"
echo ""
echo -e "${BLUE}æŒ‰ Ctrl+C åœæ­¢æœå‹™${NC}"
echo "=================================="

# å•Ÿå‹• API
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
EOF

chmod +x launch_system.sh

echo "âœ… ç¸½æ§åˆ¶è…³æœ¬å‰µå»ºå®Œæˆ"
</code></pre>
<h3 id="32-å‰µå»ºå¿«é€Ÿæ¸¬è©¦è…³æœ¬"><a class="header" href="#32-å‰µå»ºå¿«é€Ÿæ¸¬è©¦è…³æœ¬">3.2 å‰µå»ºå¿«é€Ÿæ¸¬è©¦è…³æœ¬</a></h3>
<pre><code class="language-bash">echo "ğŸ§ª å‰µå»ºå¿«é€Ÿæ¸¬è©¦è…³æœ¬..."

cat &gt; quick_test.sh &lt;&lt; 'EOF'
#!/bin/bash

echo "ğŸ§ª å¿«é€ŸåŠŸèƒ½æ¸¬è©¦"
echo "=================="

BASE_URL="http://localhost:8000"

# é¡è‰²å®šç¾©
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# æ¸¬è©¦å‡½æ•¸
test_endpoint() {
    local name=$1
    local method=$2
    local url=$3
    local data=$4
    
    echo -e "${YELLOW}æ¸¬è©¦: $name${NC}"
    
    if [ -z "$data" ]; then
        response=$(curl -s -w "\n%{http_code}" "$url")
    else
        response=$(curl -s -w "\n%{http_code}" -X "$method" "$url" \
            -H "Content-Type: application/json" \
            -d "$data")
    fi
    
    status_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | head -n -1)
    
    if [ "$status_code" -eq 200 ] || [ "$status_code" -eq 201 ]; then
        echo -e "${GREEN}âœ… æˆåŠŸ ($status_code)${NC}"

---

## ğŸ“Š æˆæœ¬èˆ‡æ™‚ç¨‹

### é–‹ç™¼æ™‚ç¨‹
- **ç¬¬1é€±**ï¼šä»£å¹£å‰µå»º + åŸºæœ¬API
- **ç¬¬2é€±**ï¼šå……å€¼ç›£æ§ + æç¾åŠŸèƒ½  
- **ç¬¬3é€±**ï¼šå‰ç«¯æ•´åˆ + æ¸¬è©¦
- **ç¬¬4é€±**ï¼šå®‰å…¨åŠ å›º + éƒ¨ç½²

### é‹ç‡Ÿæˆæœ¬
- **ä¼ºæœå™¨**ï¼š$50-200/æœˆ
- **è³‡æ–™åº«**ï¼š$20-100/æœˆ
- **ç›£æ§å‘Šè­¦**ï¼š$10-50/æœˆ
- **ç¸½è¨ˆ**ï¼š$80-350/æœˆ

### äº¤æ˜“æˆæœ¬
- **Solana æ‰‹çºŒè²»**ï¼š~$0.0001/ç­†
- **æ¯”ä»¥å¤ªåŠä¾¿å®œ**ï¼š1000å€ä»¥ä¸Šï¼

ç¾åœ¨ææ‡‚äº†å—ï¼Ÿæœ‰ä»€éº¼ç‰¹åˆ¥æƒ³æ·±å…¥ç­è§£çš„éƒ¨åˆ†å—ï¼Ÿ
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../tools/finmind.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../tools/github-resources-collection.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../tools/finmind.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../tools/github-resources-collection.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
