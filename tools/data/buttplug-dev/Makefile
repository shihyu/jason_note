# Buttplug Server WASM Makefile
# æä¾›ç·¨è­¯ã€é‹è¡Œã€æ¸…ç†åŠŸèƒ½

.PHONY: all build run serve clean clean-all test help

# é è¨­ç›®æ¨™
all: build

# è®Šæ•¸å®šç¾©
WASM_CRATE := crates/buttplug_server
PKG_DIR := $(WASM_CRATE)/pkg
WEB_EXAMPLE_DIR := web_example
FEATURES := wasm
PORT := 8000
WEB_PORT := 8080

# æª¢æŸ¥å¿…è¦å·¥å…·
check-tools:
	@echo "ğŸ” æª¢æŸ¥å¿…è¦å·¥å…·..."
	@command -v wasm-pack >/dev/null 2>&1 || { echo "âŒ wasm-pack æœªå®‰è£. è«‹åŸ·è¡Œ: cargo install wasm-pack"; exit 1; }
	@command -v python3 >/dev/null 2>&1 || { echo "âŒ python3 æœªå®‰è£"; exit 1; }
	@echo "âœ… æ‰€æœ‰å·¥å…·å·²å°±ç·’"

# ç·¨è­¯ WASM æ¨¡çµ„
build: check-tools
	@echo "ğŸš€ é–‹å§‹ç·¨è­¯ WASM æ¨¡çµ„..."
	wasm-pack build --target web $(WASM_CRATE) --no-default-features --features $(FEATURES)
	@echo "âœ… WASM ç·¨è­¯å®Œæˆï¼"
	@echo "ğŸ“ è¼¸å‡ºä½ç½®: $(PKG_DIR)"

# è¤‡è£½ WASM æª”æ¡ˆåˆ° web ç¯„ä¾‹ç›®éŒ„
copy-wasm: build
	@echo "ğŸ“‚ è¤‡è£½ WASM æª”æ¡ˆåˆ° web ç¯„ä¾‹ç›®éŒ„..."
	cp -r $(PKG_DIR) $(WEB_EXAMPLE_DIR)/
	@echo "âœ… æª”æ¡ˆè¤‡è£½å®Œæˆ"

# å•Ÿå‹•ç°¡å–®æ¸¬è©¦ä¼ºæœå™¨ï¼ˆæ ¹ç›®éŒ„ï¼‰
run: copy-wasm
	@echo "ğŸŒ å•Ÿå‹•æ¸¬è©¦ä¼ºæœå™¨ (ç«¯å£ $(PORT))..."
	@echo "ğŸ”— è¨ªå•: http://localhost:$(PORT)/web_example/"
	@echo "ğŸ’¡ æŒ‰ Ctrl+C åœæ­¢ä¼ºæœå™¨"
	python3 -m http.server $(PORT)

# å•Ÿå‹• web ç¯„ä¾‹ä¼ºæœå™¨
serve: copy-wasm
	@echo "ğŸŒ å•Ÿå‹• Web ç¯„ä¾‹ä¼ºæœå™¨ (ç«¯å£ $(WEB_PORT))..."
	@echo "ğŸ”— è¨ªå•: http://localhost:$(WEB_PORT)/"
	@echo "ğŸ’¡ æŒ‰ Ctrl+C åœæ­¢ä¼ºæœå™¨"
	cd $(WEB_EXAMPLE_DIR) && python3 -m http.server $(WEB_PORT)

# å¿«é€Ÿæ¸¬è©¦ï¼ˆå¾Œå°å•Ÿå‹•ä¼ºæœå™¨ä¸¦é–‹å•Ÿç€è¦½å™¨ï¼‰
test: copy-wasm
	@echo "ğŸ§ª å•Ÿå‹•å¿«é€Ÿæ¸¬è©¦..."
	@python3 -m http.server $(PORT) > /dev/null 2>&1 & \
	echo $$! > .server.pid && \
	sleep 2 && \
	echo "ğŸ”— å®Œæ•´ç¤ºç¯„: http://localhost:$(PORT)/web_example/" && \
	echo "â¹ï¸  åœæ­¢ä¼ºæœå™¨: make stop"

# åœæ­¢æ¸¬è©¦ä¼ºæœå™¨
stop:
	@if [ -f .server.pid ]; then \
		echo "â¹ï¸  åœæ­¢æ¸¬è©¦ä¼ºæœå™¨..."; \
		kill $$(cat .server.pid) 2>/dev/null || true; \
		rm -f .server.pid; \
		echo "âœ… ä¼ºæœå™¨å·²åœæ­¢"; \
	else \
		echo "â“ æ²’æœ‰é‹è¡Œä¸­çš„æ¸¬è©¦ä¼ºæœå™¨"; \
	fi

# æ¸…ç† WASM ç·¨è­¯è¼¸å‡º
clean:
	@echo "ğŸ§¹ æ¸…ç† WASM ç·¨è­¯è¼¸å‡º..."
	rm -rf $(PKG_DIR)
	rm -rf $(WEB_EXAMPLE_DIR)/pkg
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®Œå…¨æ¸…ç†ï¼ˆåŒ…å« Cargo å¿«å–ï¼‰
clean-all: clean stop
	@echo "ğŸ§¹ åŸ·è¡Œå®Œå…¨æ¸…ç†..."
	cargo clean
	rm -f .server.pid
	@echo "âœ… å®Œå…¨æ¸…ç†å®Œæˆ"

# é‡æ–°ç·¨è­¯
rebuild: clean build

# æª¢æŸ¥ç·¨è­¯çµæœ
check: build
	@echo "ğŸ” æª¢æŸ¥ç·¨è­¯çµæœ..."
	@if [ -f "$(PKG_DIR)/buttplug_server.js" ]; then \
		echo "âœ… buttplug_server.js å­˜åœ¨"; \
	else \
		echo "âŒ buttplug_server.js ä¸å­˜åœ¨"; \
	fi
	@if [ -f "$(PKG_DIR)/buttplug_server_bg.wasm" ]; then \
		echo "âœ… buttplug_server_bg.wasm å­˜åœ¨"; \
		echo "ğŸ“Š WASM æª”æ¡ˆå¤§å°: $$(du -h $(PKG_DIR)/buttplug_server_bg.wasm | cut -f1)"; \
	else \
		echo "âŒ buttplug_server_bg.wasm ä¸å­˜åœ¨"; \
	fi
	@if [ -f "$(PKG_DIR)/package.json" ]; then \
		echo "âœ… package.json å­˜åœ¨"; \
		echo "ğŸ“¦ ç‰ˆæœ¬: $$(grep '"version"' $(PKG_DIR)/package.json | cut -d'"' -f4)"; \
	else \
		echo "âŒ package.json ä¸å­˜åœ¨"; \
	fi

# é¡¯ç¤ºèªªæ˜
help:
	@echo ""
	@echo "ğŸ”Œ Buttplug Server WASM ç·¨è­¯å·¥å…·"
	@echo ""
	@echo "ğŸ“‹ å¯ç”¨ç›®æ¨™:"
	@echo "  build        - ç·¨è­¯ WASM æ¨¡çµ„"
	@echo "  run          - ç·¨è­¯ä¸¦å•Ÿå‹•æ¸¬è©¦ä¼ºæœå™¨ (ç«¯å£ $(PORT))"
	@echo "  serve        - å•Ÿå‹• Web ç¯„ä¾‹ä¼ºæœå™¨ (ç«¯å£ $(WEB_PORT))"
	@echo "  test         - å¿«é€Ÿæ¸¬è©¦ (å¾Œå°å•Ÿå‹•)"
	@echo "  stop         - åœæ­¢æ¸¬è©¦ä¼ºæœå™¨"
	@echo "  check        - æª¢æŸ¥ç·¨è­¯çµæœ"
	@echo "  rebuild      - æ¸…ç†ä¸¦é‡æ–°ç·¨è­¯"
	@echo "  clean        - æ¸…ç†ç·¨è­¯è¼¸å‡º"
	@echo "  clean-all    - å®Œå…¨æ¸…ç† (åŒ…å« Cargo å¿«å–)"
	@echo "  help         - é¡¯ç¤ºæ­¤èªªæ˜"
	@echo ""
	@echo "ğŸš€ å¿«é€Ÿé–‹å§‹:"
	@echo "  make build   # ç·¨è­¯"
	@echo "  make run     # ç·¨è­¯ä¸¦é‹è¡Œ"
	@echo "  make serve   # é‹è¡Œ Web ç¯„ä¾‹"
	@echo ""
	@echo "ğŸŒ æ¸¬è©¦ç¶²å€:"
	@echo "  http://localhost:$(PORT)/web_example/        # å®Œæ•´ç¤ºç¯„"
	@echo "  http://localhost:$(WEB_PORT)/                       # Web ç¯„ä¾‹å°ˆç”¨"
	@echo ""