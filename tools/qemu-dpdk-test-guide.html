<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>QEMU DPDK 測試完整指南 - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="qemu-環境-dpdk-雙埠測試完整指南"><a class="header" href="#qemu-環境-dpdk-雙埠測試完整指南">QEMU 環境 DPDK 雙埠測試完整指南</a></h1>
<h2 id="目錄"><a class="header" href="#目錄">目錄</a></h2>
<ol>
<li><a href="#%E6%B8%AC%E8%A9%A6%E6%9E%B6%E6%A7%8B%E6%A6%82%E8%BF%B0">測試架構概述</a></li>
<li><a href="#host-%E4%B8%BB%E6%A9%9F%E6%BA%96%E5%82%99">Host 主機準備</a></li>
<li><a href="#qemu-%E8%99%9B%E6%93%AC%E6%A9%9F%E9%85%8D%E7%BD%AE">QEMU 虛擬機配置</a></li>
<li><a href="#guest-%E8%99%9B%E6%93%AC%E6%A9%9F%E5%85%A7-dpdk-%E8%A8%AD%E7%BD%AE">Guest 虛擬機內 DPDK 設置</a></li>
<li><a href="#%E6%B8%AC%E8%A9%A6%E5%A0%B4%E6%99%AF">測試場景</a></li>
<li><a href="#%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96">效能優化</a></li>
<li><a href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">故障排除</a></li>
</ol>
<hr />
<h2 id="測試架構概述"><a class="header" href="#測試架構概述">測試架構概述</a></h2>
<h3 id="可用的測試拓撲"><a class="header" href="#可用的測試拓撲">可用的測試拓撲</a></h3>
<h4 id="1-單一-vm-內部環回測試"><a class="header" href="#1-單一-vm-內部環回測試">1. 單一 VM 內部環回測試</a></h4>
<pre><code>┌─────────────────────────┐
│      QEMU VM            │
│  ┌──────┐    ┌──────┐  │
│  │ Port0│───►│ Port1│  │
│  └──────┘    └──────┘  │
│       DPDK App          │
└─────────────────────────┘
</code></pre>
<h4 id="2-vm-到-vm-測試"><a class="header" href="#2-vm-到-vm-測試">2. VM 到 VM 測試</a></h4>
<pre><code>┌──────────┐         ┌──────────┐
│  VM1     │         │  VM2     │
│  Port0───┼────────►│  Port0   │
│  Port1◄──┼─────────┤  Port1   │
└──────────┘         └──────────┘
</code></pre>
<h4 id="3-vm-到-host-測試使用-vhost-user"><a class="header" href="#3-vm-到-host-測試使用-vhost-user">3. VM 到 Host 測試（使用 vhost-user）</a></h4>
<pre><code>     Host                    VM
┌──────────┐         ┌──────────┐
│ OVS-DPDK │◄────────┤  DPDK    │
│  或      │ vhost-  │   App    │
│ Testpmd  │  user   │          │
└──────────┘         └──────────┘
</code></pre>
<hr />
<h2 id="host-主機準備"><a class="header" href="#host-主機準備">Host 主機準備</a></h2>
<h3 id="1-安裝必要套件"><a class="header" href="#1-安裝必要套件">1. 安裝必要套件</a></h3>
<pre><code class="language-bash"># Ubuntu 20.04/22.04
sudo apt update
sudo apt install -y qemu-kvm qemu-system-x86 \
    libvirt-daemon-system libvirt-clients bridge-utils \
    cpu-checker hugepages dpdk dpdk-dev openvswitch-switch-dpdk

# 檢查虛擬化支援
kvm-ok
</code></pre>
<h3 id="2-設定大頁記憶體host"><a class="header" href="#2-設定大頁記憶體host">2. 設定大頁記憶體（Host）</a></h3>
<pre><code class="language-bash"># 配置 2MB 大頁
echo 4096 | sudo tee /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages

# 或配置 1GB 大頁（更好的效能）
echo 8 | sudo tee /sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages

# 掛載 hugetlbfs
sudo mkdir -p /dev/hugepages
sudo mount -t hugetlbfs hugetlbfs /dev/hugepages

# 永久配置
echo "vm.nr_hugepages=4096" | sudo tee -a /etc/sysctl.conf
echo "hugetlbfs /dev/hugepages hugetlbfs defaults 0 0" | sudo tee -a /etc/fstab
</code></pre>
<h3 id="3-準備網路橋接選項一linux-bridge"><a class="header" href="#3-準備網路橋接選項一linux-bridge">3. 準備網路橋接（選項一：Linux Bridge）</a></h3>
<pre><code class="language-bash"># 建立兩個 Linux bridge
sudo ip link add br0 type bridge
sudo ip link add br1 type bridge
sudo ip link set br0 up
sudo ip link set br1 up

# 建立 TAP 介面
sudo ip tuntap add dev tap0 mode tap
sudo ip tuntap add dev tap1 mode tap
sudo ip link set tap0 up
sudo ip link set tap1 up

# 加入 bridge
sudo ip link set tap0 master br0
sudo ip link set tap1 master br1
</code></pre>
<h3 id="4-準備-vhost-user選項二高效能"><a class="header" href="#4-準備-vhost-user選項二高效能">4. 準備 vhost-user（選項二：高效能）</a></h3>
<pre><code class="language-bash"># 建立 vhost-user socket 目錄
sudo mkdir -p /tmp/vhost-sockets
sudo chmod 777 /tmp/vhost-sockets

# 使用 OVS-DPDK（可選）
sudo systemctl start openvswitch-switch
sudo ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=true
sudo ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-socket-mem="1024,1024"

# 建立 OVS bridge
sudo ovs-vsctl add-br br0 -- set bridge br0 datapath_type=netdev
sudo ovs-vsctl add-port br0 vhost-user0 -- set Interface vhost-user0 type=dpdkvhostuser
sudo ovs-vsctl add-port br0 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser
</code></pre>
<hr />
<h2 id="qemu-虛擬機配置"><a class="header" href="#qemu-虛擬機配置">QEMU 虛擬機配置</a></h2>
<h3 id="方案-1使用-virtio-net簡單"><a class="header" href="#方案-1使用-virtio-net簡單">方案 1：使用 virtio-net（簡單）</a></h3>
<pre><code class="language-bash">#!/bin/bash
# start_vm_virtio.sh

QEMU=/usr/bin/qemu-system-x86_64
VM_NAME="dpdk-test-vm"
MEM=4096
CORES=4
DISK="ubuntu-20.04.qcow2"

$QEMU \
  -name $VM_NAME \
  -cpu host \
  -enable-kvm \
  -m $MEM \
  -smp $CORES \
  -object memory-backend-file,id=mem,size=${MEM}M,mem-path=/dev/hugepages,share=on \
  -numa node,memdev=mem \
  -drive file=$DISK,if=virtio \
  -netdev tap,id=net0,ifname=tap0,script=no,downscript=no \
  -device virtio-net-pci,netdev=net0,mac=52:54:00:00:00:01 \
  -netdev tap,id=net1,ifname=tap1,script=no,downscript=no \
  -device virtio-net-pci,netdev=net1,mac=52:54:00:00:00:02 \
  -vnc :1 \
  -monitor telnet::4444,server,nowait
</code></pre>
<h3 id="方案-2使用-vhost-user高效能"><a class="header" href="#方案-2使用-vhost-user高效能">方案 2：使用 vhost-user（高效能）</a></h3>
<pre><code class="language-bash">#!/bin/bash
# start_vm_vhost.sh

QEMU=/usr/bin/qemu-system-x86_64
VM_NAME="dpdk-test-vm"
MEM=4096
CORES=4
DISK="ubuntu-20.04.qcow2"

$QEMU \
  -name $VM_NAME \
  -cpu host \
  -enable-kvm \
  -m $MEM \
  -smp $CORES \
  -object memory-backend-file,id=mem,size=${MEM}M,mem-path=/dev/hugepages,share=on \
  -numa node,memdev=mem \
  -drive file=$DISK,if=virtio \
  -chardev socket,id=char0,path=/tmp/vhost-sockets/vhost-user0,server \
  -netdev type=vhost-user,id=net0,chardev=char0,vhostforce \
  -device virtio-net-pci,netdev=net0,mac=52:54:00:00:00:01,csum=off,gso=off,guest_tso4=off,guest_tso6=off,guest_ecn=off \
  -chardev socket,id=char1,path=/tmp/vhost-sockets/vhost-user1,server \
  -netdev type=vhost-user,id=net1,chardev=char1,vhostforce \
  -device virtio-net-pci,netdev=net1,mac=52:54:00:00:00:02,csum=off,gso=off,guest_tso4=off,guest_tso6=off,guest_ecn=off \
  -vnc :1 \
  -monitor telnet::4444,server,nowait
</code></pre>
<h3 id="方案-3使用-e1000vmxnet3相容性好"><a class="header" href="#方案-3使用-e1000vmxnet3相容性好">方案 3：使用 e1000/vmxnet3（相容性好）</a></h3>
<pre><code class="language-bash">#!/bin/bash
# start_vm_e1000.sh

QEMU=/usr/bin/qemu-system-x86_64
VM_NAME="dpdk-test-vm"

$QEMU \
  -name $VM_NAME \
  -cpu host \
  -enable-kvm \
  -m 4096 \
  -smp 4 \
  -drive file=ubuntu-20.04.qcow2,if=virtio \
  -netdev tap,id=net0,ifname=tap0,script=no,downscript=no \
  -device e1000,netdev=net0,mac=52:54:00:00:00:01 \
  -netdev tap,id=net1,ifname=tap1,script=no,downscript=no \
  -device e1000,netdev=net1,mac=52:54:00:00:00:02 \
  -vnc :1
</code></pre>
<h3 id="方案-4pci-passthrough最佳效能"><a class="header" href="#方案-4pci-passthrough最佳效能">方案 4：PCI Passthrough（最佳效能）</a></h3>
<pre><code class="language-bash">#!/bin/bash
# start_vm_passthrough.sh

# 首先在 Host 上解綁網卡
echo "0000:02:00.0" | sudo tee /sys/bus/pci/drivers/ixgbe/unbind
echo "0000:02:00.1" | sudo tee /sys/bus/pci/drivers/ixgbe/unbind

# 綁定到 VFIO
sudo modprobe vfio-pci
echo "8086 10fb" | sudo tee /sys/bus/pci/drivers/vfio-pci/new_id

QEMU=/usr/bin/qemu-system-x86_64

$QEMU \
  -name dpdk-test-vm \
  -cpu host \
  -enable-kvm \
  -m 4096 \
  -smp 4 \
  -mem-prealloc \
  -object memory-backend-file,id=mem,size=4096M,mem-path=/dev/hugepages,share=on \
  -numa node,memdev=mem \
  -drive file=ubuntu-20.04.qcow2,if=virtio \
  -device vfio-pci,host=0000:02:00.0 \
  -device vfio-pci,host=0000:02:00.1 \
  -vnc :1
</code></pre>
<hr />
<h2 id="guest-虛擬機內-dpdk-設置"><a class="header" href="#guest-虛擬機內-dpdk-設置">Guest 虛擬機內 DPDK 設置</a></h2>
<h3 id="1-登入虛擬機"><a class="header" href="#1-登入虛擬機">1. 登入虛擬機</a></h3>
<pre><code class="language-bash"># 透過 VNC 連接
vncviewer localhost:5901

# 或 SSH（如果已配置網路）
ssh user@vm-ip
</code></pre>
<h3 id="2-在-guest-內安裝-dpdk"><a class="header" href="#2-在-guest-內安裝-dpdk">2. 在 Guest 內安裝 DPDK</a></h3>
<pre><code class="language-bash"># 安裝 DPDK
sudo apt update
sudo apt install -y dpdk dpdk-dev build-essential

# 或從源碼編譯
wget https://fast.dpdk.org/rel/dpdk-20.11.9.tar.xz
tar xf dpdk-20.11.9.tar.xz
cd dpdk-stable-20.11.9
meson build
cd build
ninja
sudo ninja install
</code></pre>
<h3 id="3-guest-內配置"><a class="header" href="#3-guest-內配置">3. Guest 內配置</a></h3>
<pre><code class="language-bash"># 設定大頁記憶體
echo 1024 | sudo tee /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
sudo mkdir -p /mnt/huge
sudo mount -t hugetlbfs nodev /mnt/huge

# 載入驅動
sudo modprobe uio_pci_generic

# 檢查網卡
lspci | grep -i net
# 應該看到：
# 00:03.0 Ethernet controller: Red Hat, Inc. Virtio network device
# 00:04.0 Ethernet controller: Red Hat, Inc. Virtio network device

# 綁定到 DPDK
sudo dpdk-devbind.py --status
sudo dpdk-devbind.py -b uio_pci_generic 00:03.0 00:04.0
</code></pre>
<hr />
<h2 id="測試場景"><a class="header" href="#測試場景">測試場景</a></h2>
<h3 id="場景-1vm-內部環回測試"><a class="header" href="#場景-1vm-內部環回測試">場景 1：VM 內部環回測試</a></h3>
<pre><code class="language-bash"># 在 Guest 內執行
sudo dpdk-testpmd -l 0-3 -n 4 -- -i --portmask=0x3 --nb-cores=2

# testpmd 命令
testpmd&gt; set fwd mac
testpmd&gt; start

# 檢查統計
testpmd&gt; show port stats all
</code></pre>
<h3 id="場景-2vm-到-vm-測試"><a class="header" href="#場景-2vm-到-vm-測試">場景 2：VM 到 VM 測試</a></h3>
<h4 id="vm1-設置發送端"><a class="header" href="#vm1-設置發送端">VM1 設置（發送端）</a></h4>
<pre><code class="language-bash"># 建立封包產生器
sudo dpdk-testpmd -l 0-3 -n 4 -- -i --portmask=0x3 --nb-cores=2
testpmd&gt; set fwd txonly
testpmd&gt; set txpkts 64
testpmd&gt; start
</code></pre>
<h4 id="vm2-設置接收端"><a class="header" href="#vm2-設置接收端">VM2 設置（接收端）</a></h4>
<pre><code class="language-bash"># 接收封包
sudo dpdk-testpmd -l 0-3 -n 4 -- -i --portmask=0x3 --nb-cores=2
testpmd&gt; set fwd rxonly
testpmd&gt; start
testpmd&gt; show port stats all
</code></pre>
<h3 id="場景-3使用自定義測試程式"><a class="header" href="#場景-3使用自定義測試程式">場景 3：使用自定義測試程式</a></h3>
<pre><code class="language-c">// simple_forward.c - 簡單的雙埠轉發程式
#include &lt;rte_eal.h&gt;
#include &lt;rte_ethdev.h&gt;
#include &lt;rte_cycles.h&gt;
#include &lt;rte_lcore.h&gt;
#include &lt;rte_mbuf.h&gt;

#define RX_RING_SIZE 1024
#define TX_RING_SIZE 1024
#define NUM_MBUFS 8191
#define MBUF_CACHE_SIZE 250
#define BURST_SIZE 32

static const struct rte_eth_conf port_conf_default = {
    .rxmode = {
        .max_rx_pkt_len = RTE_ETHER_MAX_LEN,
    },
};

int main(int argc, char *argv[])
{
    struct rte_mempool *mbuf_pool;
    unsigned nb_ports;
    uint16_t portid;

    /* 初始化 EAL */
    int ret = rte_eal_init(argc, argv);
    if (ret &lt; 0)
        rte_exit(EXIT_FAILURE, "EAL initialization failed\n");

    nb_ports = rte_eth_dev_count_avail();
    printf("Number of ports available: %u\n", nb_ports);

    if (nb_ports &lt; 2)
        rte_exit(EXIT_FAILURE, "Need at least 2 ports\n");

    /* 建立 mbuf pool */
    mbuf_pool = rte_pktmbuf_pool_create("MBUF_POOL", NUM_MBUFS,
        MBUF_CACHE_SIZE, 0, RTE_MBUF_DEFAULT_BUF_SIZE, rte_socket_id());

    if (mbuf_pool == NULL)
        rte_exit(EXIT_FAILURE, "Cannot create mbuf pool\n");

    /* 初始化所有埠 */
    for (portid = 0; portid &lt; nb_ports &amp;&amp; portid &lt; 2; portid++) {
        /* 配置埠 */
        ret = rte_eth_dev_configure(portid, 1, 1, &amp;port_conf_default);
        if (ret != 0)
            rte_exit(EXIT_FAILURE, "Port %u configuration failed\n", portid);

        /* 設置 RX 佇列 */
        ret = rte_eth_rx_queue_setup(portid, 0, RX_RING_SIZE,
                rte_eth_dev_socket_id(portid), NULL, mbuf_pool);
        if (ret &lt; 0)
            rte_exit(EXIT_FAILURE, "RX queue setup failed\n");

        /* 設置 TX 佇列 */
        ret = rte_eth_tx_queue_setup(portid, 0, TX_RING_SIZE,
                rte_eth_dev_socket_id(portid), NULL);
        if (ret &lt; 0)
            rte_exit(EXIT_FAILURE, "TX queue setup failed\n");

        /* 啟動埠 */
        ret = rte_eth_dev_start(portid);
        if (ret &lt; 0)
            rte_exit(EXIT_FAILURE, "Port %u start failed\n", portid);

        printf("Port %u started successfully\n", portid);
    }

    printf("\nStarting packet forwarding...\n");

    /* 主迴圈 */
    for (;;) {
        struct rte_mbuf *bufs[BURST_SIZE];
        uint16_t nb_rx, nb_tx;

        /* Port 0 -&gt; Port 1 */
        nb_rx = rte_eth_rx_burst(0, 0, bufs, BURST_SIZE);
        if (nb_rx &gt; 0) {
            nb_tx = rte_eth_tx_burst(1, 0, bufs, nb_rx);
            /* 釋放未發送的封包 */
            if (unlikely(nb_tx &lt; nb_rx)) {
                for (uint16_t i = nb_tx; i &lt; nb_rx; i++)
                    rte_pktmbuf_free(bufs[i]);
            }
        }

        /* Port 1 -&gt; Port 0 */
        nb_rx = rte_eth_rx_burst(1, 0, bufs, BURST_SIZE);
        if (nb_rx &gt; 0) {
            nb_tx = rte_eth_tx_burst(0, 0, bufs, nb_rx);
            /* 釋放未發送的封包 */
            if (unlikely(nb_tx &lt; nb_rx)) {
                for (uint16_t i = nb_tx; i &lt; nb_rx; i++)
                    rte_pktmbuf_free(bufs[i]);
            }
        }
    }

    return 0;
}
</code></pre>
<p>編譯和執行：</p>
<pre><code class="language-bash"># 編譯
gcc -o simple_forward simple_forward.c \
    $(pkg-config --cflags --libs libdpdk)

# 執行
sudo ./simple_forward -l 0-3 -n 4
</code></pre>
<hr />
<h2 id="效能優化"><a class="header" href="#效能優化">效能優化</a></h2>
<h3 id="1-qemu-cpu-優化"><a class="header" href="#1-qemu-cpu-優化">1. QEMU CPU 優化</a></h3>
<pre><code class="language-bash"># 使用 CPU pinning
taskset -c 0-3 qemu-system-x86_64 ...

# QEMU 命令行加入
-cpu host,+x2apic,+tsc-deadline \
-realtime mlock=on \
-rtc base=localtime,driftfix=slew
</code></pre>
<h3 id="2-guest-內核優化"><a class="header" href="#2-guest-內核優化">2. Guest 內核優化</a></h3>
<pre><code class="language-bash"># 關閉不必要的服務
sudo systemctl stop NetworkManager
sudo systemctl stop firewalld

# CPU 頻率設定
sudo cpupower frequency-set -g performance

# 中斷親和性
echo 2 &gt; /proc/irq/24/smp_affinity_list
</code></pre>
<h3 id="3-virtio-優化參數"><a class="header" href="#3-virtio-優化參數">3. virtio 優化參數</a></h3>
<pre><code class="language-bash"># QEMU 啟動參數
-device virtio-net-pci,netdev=net0,mac=52:54:00:00:00:01,\
  csum=off,gso=off,guest_tso4=off,guest_tso6=off,guest_ecn=off,\
  mq=on,vectors=9,packed=on
</code></pre>
<h3 id="4-vhost-user-多佇列"><a class="header" href="#4-vhost-user-多佇列">4. vhost-user 多佇列</a></h3>
<pre><code class="language-bash"># Host 端 testpmd
sudo dpdk-testpmd -l 0-3 -n 4 \
  --vdev 'net_vhost0,iface=/tmp/vhost-user0,queues=2' \
  --vdev 'net_vhost1,iface=/tmp/vhost-user1,queues=2' \
  -- -i --nb-cores=2 --rxq=2 --txq=2

# QEMU 參數
-chardev socket,id=char0,path=/tmp/vhost-user0,server \
-netdev type=vhost-user,id=net0,chardev=char0,vhostforce,queues=2 \
-device virtio-net-pci,netdev=net0,mac=52:54:00:00:00:01,mq=on,vectors=6
</code></pre>
<hr />
<h2 id="效能測試結果參考"><a class="header" href="#效能測試結果參考">效能測試結果參考</a></h2>
<h3 id="測試環境"><a class="header" href="#測試環境">測試環境</a></h3>
<ul>
<li>Host: Intel Xeon E5-2680 v4, 64GB RAM</li>
<li>Guest: 4 vCPUs, 4GB RAM</li>
<li>DPDK: 20.11 LTS</li>
</ul>
<h3 id="效能數據"><a class="header" href="#效能數據">效能數據</a></h3>
<div class="table-wrapper"><table><thead><tr><th>配置</th><th>封包大小</th><th>吞吐量 (Mpps)</th><th>延遲 (μs)</th></tr></thead><tbody>
<tr><td>virtio-net</td><td>64B</td><td>2.5</td><td>40-60</td></tr>
<tr><td>virtio-net</td><td>1518B</td><td>0.8</td><td>30-50</td></tr>
<tr><td>vhost-user</td><td>64B</td><td>8.5</td><td>15-25</td></tr>
<tr><td>vhost-user</td><td>1518B</td><td>3.2</td><td>10-20</td></tr>
<tr><td>SR-IOV VF</td><td>64B</td><td>12.0</td><td>8-12</td></tr>
<tr><td>SR-IOV VF</td><td>1518B</td><td>4.5</td><td>6-10</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="故障排除"><a class="header" href="#故障排除">故障排除</a></h2>
<h3 id="問題-1虛擬機內看不到網卡"><a class="header" href="#問題-1虛擬機內看不到網卡">問題 1：虛擬機內看不到網卡</a></h3>
<pre><code class="language-bash"># 檢查 QEMU 進程
ps aux | grep qemu

# 檢查網卡是否被識別
lspci -v | grep -i ethernet

# 確認驅動載入
lsmod | grep virtio
</code></pre>
<h3 id="問題-2dpdk-初始化失敗"><a class="header" href="#問題-2dpdk-初始化失敗">問題 2：DPDK 初始化失敗</a></h3>
<pre><code class="language-bash"># 檢查大頁配置
cat /proc/meminfo | grep Huge

# 檢查 IOMMU
dmesg | grep -i iommu

# 權限問題
sudo chmod 666 /dev/vfio/*
</code></pre>
<h3 id="問題-3效能不佳"><a class="header" href="#問題-3效能不佳">問題 3：效能不佳</a></h3>
<pre><code class="language-bash"># Host 端檢查
# CPU 是否超載
htop

# 檢查 KVM 模組
lsmod | grep kvm

# Guest 端檢查
# 確認使用 virtio-net-pci
ethtool -i eth0
</code></pre>
<h3 id="問題-4vhost-user-連接失敗"><a class="header" href="#問題-4vhost-user-連接失敗">問題 4：vhost-user 連接失敗</a></h3>
<pre><code class="language-bash"># 檢查 socket 文件
ls -la /tmp/vhost-sockets/

# 檢查 OVS 狀態（如果使用）
sudo ovs-vsctl show

# 權限設定
sudo chmod 777 /tmp/vhost-sockets
</code></pre>
<hr />
<h2 id="進階測試腳本"><a class="header" href="#進階測試腳本">進階測試腳本</a></h2>
<h3 id="自動化測試腳本"><a class="header" href="#自動化測試腳本">自動化測試腳本</a></h3>
<pre><code class="language-bash">#!/bin/bash
# auto_test.sh

# 啟動 VM
./start_vm_vhost.sh &amp;
VM_PID=$!
sleep 30

# SSH 到 VM 執行測試
ssh user@192.168.122.100 &lt;&lt; 'EOF'
  # 設定 DPDK
  echo 1024 | sudo tee /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
  sudo modprobe uio_pci_generic
  sudo dpdk-devbind.py -b uio_pci_generic 00:03.0 00:04.0
  
  # 執行測試
  sudo timeout 60 dpdk-testpmd -l 0-3 -n 4 -- \
    -i --portmask=0x3 --nb-cores=2 --forward-mode=mac
EOF

# 收集結果
echo "Test completed"

# 停止 VM
kill $VM_PID
</code></pre>
<h3 id="效能監控腳本"><a class="header" href="#效能監控腳本">效能監控腳本</a></h3>
<pre><code class="language-bash">#!/bin/bash
# monitor.sh

while true; do
    clear
    echo "=== VM Network Performance ==="
    
    # Host 端監控
    echo "Host CPU:"
    mpstat 1 1 | tail -2
    
    # VM 內監控（透過 SSH）
    echo -e "\nVM Statistics:"
    ssh user@vm-ip "cat /proc/net/dev | grep -E 'eth|virtio'"
    
    sleep 2
done
</code></pre>
<hr />
<h2 id="總結"><a class="header" href="#總結">總結</a></h2>
<p>QEMU 提供了多種方式來測試 DPDK 雙埠收發：</p>
<h3 id="優缺點比較"><a class="header" href="#優缺點比較">優缺點比較</a></h3>
<div class="table-wrapper"><table><thead><tr><th>方式</th><th>優點</th><th>缺點</th><th>適用場景</th></tr></thead><tbody>
<tr><td><strong>virtio-net</strong></td><td>簡單易用、穩定</td><td>效能一般</td><td>功能測試、開發</td></tr>
<tr><td><strong>vhost-user</strong></td><td>效能好、延遲低</td><td>配置複雜</td><td>效能測試</td></tr>
<tr><td><strong>SR-IOV/直通</strong></td><td>接近原生效能</td><td>需要硬體支援</td><td>生產環境測試</td></tr>
<tr><td><strong>e1000</strong></td><td>相容性最好</td><td>效能最差</td><td>相容性測試</td></tr>
</tbody></table>
</div>
<h3 id="建議"><a class="header" href="#建議">建議</a></h3>
<ol>
<li><strong>開發測試</strong>：使用 virtio-net，簡單快速</li>
<li><strong>效能測試</strong>：使用 vhost-user 或 SR-IOV</li>
<li><strong>自動化測試</strong>：結合 libvirt 管理 VM</li>
<li><strong>大規模測試</strong>：使用容器化 DPDK（Docker）</li>
</ol>
<p>QEMU 是測試 DPDK 的優秀平台，特別適合開發和驗證階段！</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../hft/dpdk-port-test-guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../hft/dpdk-introduction.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../hft/dpdk-port-test-guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../hft/dpdk-introduction.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
