<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>xv6 操作系統分析與實踐 - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="讀書心得-操作系統原型---xv6-分析與實踐"><a class="header" href="#讀書心得-操作系統原型---xv6-分析與實踐">讀書心得: 操作系統原型 - xv6 分析與實踐</a></h1>
<h2 id="概述"><a class="header" href="#概述">概述</a></h2>
<p>本文基於《操作系統原型 - xv6 分析與實踐》一書的學習筆記。</p>
<p>xv6 是 MIT 開發的一個教學操作系統，是 Unix Version 6 的重新實現，設計用於在 x86 多處理器系統上運行，使用 ANSI C 語言編寫。</p>
<hr />
<h2 id="第-0-章本文閱讀指南"><a class="header" href="#第-0-章本文閱讀指南">第 0 章：本文閱讀指南</a></h2>
<p>推薦兩種閱讀路徑：</p>
<h3 id="實踐派"><a class="header" href="#實踐派">實踐派</a></h3>
<ol>
<li>從第 1 章開始安裝並進行實際操作</li>
<li>通過動手實驗理解操作系統的工作原理</li>
<li>在實踐中逐漸深化理論理解</li>
</ol>
<h3 id="理論先行派"><a class="header" href="#理論先行派">理論先行派</a></h3>
<ol>
<li>先從附錄 A &amp; B 開始，理解核心原理</li>
<li>了解 x86 硬體基礎和 xv6 啟動流程</li>
<li>再進行實驗和驗證</li>
</ol>
<hr />
<h2 id="第-1-章xv6-安裝與配置"><a class="header" href="#第-1-章xv6-安裝與配置">第 1 章：xv6 安裝與配置</a></h2>
<h3 id="什麼是-xv6"><a class="header" href="#什麼是-xv6">什麼是 xv6？</a></h3>
<ul>
<li><strong>重新實現</strong>：Unix Version 6（v6）的現代化實現</li>
<li><strong>教學目的</strong>：設計用於操作系統課程教學</li>
<li><strong>硬體平台</strong>：x86 單處理器或多處理器系統</li>
<li><strong>開發語言</strong>：ANSI C 和 x86 彙編語言</li>
<li><strong>許可證</strong>：MIT License</li>
</ul>
<h3 id="安裝步驟"><a class="header" href="#安裝步驟">安裝步驟</a></h3>
<pre><code class="language-bash"># 1. 下載 xv6 源代碼
wget https://github.com/mit-pdos/xv6-public/archive/refs/tags/xv6-rev9.tar.gz

# 2. 解壓文件
tar -xvf xv6-rev9.tar.gz

# 3. 進入目錄
cd xv6-public-xv6-rev9

# 4. 編譯內核
make

# 5. 在 QEMU 中運行（非圖形界面）
make qemu-nox
</code></pre>
<h3 id="退出命令"><a class="header" href="#退出命令">退出命令</a></h3>
<ul>
<li><strong>QEMU (nox mode)</strong>：按 <code>Ctrl+A</code> 再按 <code>X</code> 退出</li>
<li><strong>GDB 調試器</strong>：按 <code>Ctrl+D</code> 退出</li>
</ul>
<h3 id="依賴環境"><a class="header" href="#依賴環境">依賴環境</a></h3>
<p>確保已安裝：</p>
<ul>
<li>GCC 編譯工具</li>
<li>Make 構建工具</li>
<li>QEMU 虛擬機</li>
<li>GDB 調試器（可選）</li>
</ul>
<hr />
<h2 id="第-2-章xv6-實驗"><a class="header" href="#第-2-章xv6-實驗">第 2 章：xv6 實驗</a></h2>
<h3 id="21-實驗-1-0修改啟動信息"><a class="header" href="#21-實驗-1-0修改啟動信息">2.1 實驗 1-0：修改啟動信息</a></h3>
<p><strong>目標</strong>：自定義 xv6 的啟動消息</p>
<p><strong>步驟</strong>：</p>
<ol>
<li>定位 <code>main.c</code> 文件中的 <code>mpmain()</code> 函數</li>
<li>修改啟動時輸出的問候信息</li>
<li>重新編譯並在 QEMU 中運行驗證</li>
</ol>
<p><strong>代碼位置</strong>：<code>main.c</code> - <code>mpmain()</code> 函數</p>
<h3 id="22-實驗-1-1添加用戶應用程序"><a class="header" href="#22-實驗-1-1添加用戶應用程序">2.2 實驗 1-1：添加用戶應用程序</a></h3>
<p><strong>目標</strong>：創建並編譯一個用戶態應用程序</p>
<p><strong>步驟</strong>：</p>
<ol>
<li>在 xv6 根目錄創建 <code>my-app.c</code></li>
<li>在 <code>Makefile</code> 中添加 <code>_my-app</code> 到 <code>UPROGS</code> 列表</li>
<li>運行 <code>make</code> 編譯</li>
<li>在 xv6 shell 中運行應用程序</li>
</ol>
<p><strong>示例代碼</strong>：</p>
<pre><code class="language-c">#include "types.h"
#include "stat.h"
#include "user.h"
#include "fcntl.h"

int
main(int argc, char *argv[])
{
    printf(1, "Hello from my-app!\n");
    exit();
}
</code></pre>
<h3 id="23-實驗-1-2添加系統調用"><a class="header" href="#23-實驗-1-2添加系統調用">2.3 實驗 1-2：添加系統調用</a></h3>
<p><strong>目標</strong>：實現一個新的系統調用（如 <code>getcpuid()</code>）</p>
<p><strong>涉及文件修改</strong>：</p>
<h4 id="1-syscallh---定義系統調用號"><a class="header" href="#1-syscallh---定義系統調用號">1. <code>syscall.h</code> - 定義系統調用號</a></h4>
<pre><code class="language-c">#define SYS_getcpuid  24
</code></pre>
<h4 id="2-userh---聲明用戶函數"><a class="header" href="#2-userh---聲明用戶函數">2. <code>user.h</code> - 聲明用戶函數</a></h4>
<pre><code class="language-c">int getcpuid(void);
</code></pre>
<h4 id="3-usyss---用戶態系統調用入口"><a class="header" href="#3-usyss---用戶態系統調用入口">3. <code>usys.S</code> - 用戶態系統調用入口</a></h4>
<p>使用 <code>SYSCALL</code> 宏生成系統調用代碼：</p>
<pre><code class="language-asm">SYSCALL(getcpuid)
</code></pre>
<h4 id="4-syscallc---註冊系統調用"><a class="header" href="#4-syscallc---註冊系統調用">4. <code>syscall.c</code> - 註冊系統調用</a></h4>
<pre><code class="language-c">extern int sys_getcpuid(void);

// 在 syscalls[] 數組中添加
[SYS_getcpuid] sys_getcpuid,
</code></pre>
<h4 id="5-sysprocc---實現系統調用"><a class="header" href="#5-sysprocc---實現系統調用">5. <code>sysproc.c</code> - 實現系統調用</a></h4>
<pre><code class="language-c">int
sys_getcpuid(void)
{
    return cpuid();
}
</code></pre>
<h4 id="6-defsh---導出函數聲明"><a class="header" href="#6-defsh---導出函數聲明">6. <code>defs.h</code> - 導出函數聲明</a></h4>
<pre><code class="language-c">int     cpuid(void);
</code></pre>
<h4 id="7-procc---實現核心功能"><a class="header" href="#7-procc---實現核心功能">7. <code>proc.c</code> - 實現核心功能</a></h4>
<pre><code class="language-c">int
cpuid(void)
{
    return 0;  // 簡單實現
}
</code></pre>
<p><strong>驗證步驟</strong>：</p>
<ol>
<li>創建用戶應用調用 <code>getcpuid()</code></li>
<li>編譯並運行</li>
<li>使用 GDB 追蹤系統調用流程</li>
</ol>
<hr />
<h2 id="第-3-章核心概念"><a class="header" href="#第-3-章核心概念">第 3 章：核心概念</a></h2>
<h3 id="31-文件描述符"><a class="header" href="#31-文件描述符">3.1 文件描述符</a></h3>
<p>xv6 中的標準文件描述符：</p>
<div class="table-wrapper"><table><thead><tr><th>文件描述符</th><th>名稱</th><th>用途</th></tr></thead><tbody>
<tr><td>0</td><td>stdin</td><td>標準輸入</td></tr>
<tr><td>1</td><td>stdout</td><td>標準輸出</td></tr>
<tr><td>2</td><td>stderr</td><td>標準錯誤輸出</td></tr>
</tbody></table>
</div>
<h3 id="32-引導過程bootstrap-sequence"><a class="header" href="#32-引導過程bootstrap-sequence">3.2 引導過程（Bootstrap Sequence）</a></h3>
<p>系統啟動時的執行順序：</p>
<pre><code>1. BIOS 加載啟動塊 (bootblock)
   ↓
2. bootblock (512 bytes) 被加載到內存地址 0x7c00
   ↓
3. bootasm.S 切換 CPU 模式
   - 從實模式 → 32 位保護模式
   ↓
4. bootmain.c 從磁盤讀取內核 ELF 映像
   - 從磁盤扇區 1 開始讀取
   - 加載到內存
   ↓
5. entry.S 啟用分頁機制
   - 設置頁表
   - 開啟虛擬內存
   ↓
6. main.c 初始化內核子系統
   - 初始化 CPU、內存、中斷等
</code></pre>
<h3 id="33-啟動加載器詳解"><a class="header" href="#33-啟動加載器詳解">3.3 啟動加載器詳解</a></h3>
<h4 id="啟動塊特性"><a class="header" href="#啟動塊特性">啟動塊特性</a></h4>
<ul>
<li><strong>大小</strong>：精確 512 字節（一個磁盤扇區）</li>
<li><strong>位置</strong>：磁盤第一個扇區（LBA 0）</li>
<li><strong>加載地址</strong>：0x7c00（BIOS 約定）</li>
<li><strong>類型</strong>：機器碼（二進制可執行）</li>
</ul>
<h4 id="內核加載"><a class="header" href="#內核加載">內核加載</a></h4>
<ul>
<li><strong>起始扇區</strong>：扇區 1</li>
<li><strong>加載方式</strong>：使用 BIOS INT 0x13 中斷</li>
<li><strong>映像格式</strong>：ELF 格式</li>
</ul>
<h4 id="內存佈局演變"><a class="header" href="#內存佈局演變">內存佈局演變</a></h4>
<p><strong>實模式（Real Mode）</strong></p>
<pre><code>0x00000000 +--------+
           | BIOS   |
0x000F0000 +--------+
           | ...    |
0x00007C00 +--------+ ← 啟動塊加載位置
           | ...    |
0x00000000 +--------+
</code></pre>
<p><strong>保護模式初期（Protected Mode Init）</strong></p>
<pre><code>0x00100000 +--------+ ← 內核開始位置（1MB）
           | Kernel |
           |        |
0x00080000 +--------+ ← 啟動代碼區
           |        |
0x00000000 +--------+
</code></pre>
<h3 id="34-全局描述符表gdt"><a class="header" href="#34-全局描述符表gdt">3.4 全局描述符表（GDT）</a></h3>
<p>GDT 為保護模式設置段描述符，配置包括：</p>
<h4 id="段結構"><a class="header" href="#段結構">段結構</a></h4>
<pre><code>+--------+--------+--------+--------+
| 段基址 | 段限制 | 訪問權限 | 其他 |
+--------+--------+--------+--------+
</code></pre>
<h4 id="預定義段"><a class="header" href="#預定義段">預定義段</a></h4>
<ol>
<li>
<p><strong>NULL 段</strong>（段選擇子 0x00）</p>
<ul>
<li>防止錯誤使用</li>
</ul>
</li>
<li>
<p><strong>代碼段</strong>（段選擇子 0x08）</p>
<ul>
<li><strong>類型</strong>：可執行、可讀</li>
<li><strong>特權級</strong>：Ring 0（內核）</li>
<li><strong>粒度</strong>：4KB 頁面</li>
</ul>
</li>
<li>
<p><strong>數據段</strong>（段選擇子 0x10）</p>
<ul>
<li><strong>類型</strong>：可寫</li>
<li><strong>特權級</strong>：Ring 0（內核）</li>
<li><strong>粒度</strong>：4KB 頁面</li>
</ul>
</li>
</ol>
<h4 id="gdt-初始化代碼位置"><a class="header" href="#gdt-初始化代碼位置">GDT 初始化代碼位置</a></h4>
<ul>
<li><strong>文件</strong>：<code>bootasm.S</code></li>
<li><strong>作用</strong>：切換到保護模式前設置</li>
</ul>
<h3 id="35-x86-處理器工作模式"><a class="header" href="#35-x86-處理器工作模式">3.5 x86 處理器工作模式</a></h3>
<p><img src="images/x86-operating-modes.jpg" alt="x86 Operating Modes Comparison" /></p>
<div class="table-wrapper"><table><thead><tr><th>模式</th><th>位寬</th><th>尋址範圍</th><th>保護機制</th><th>用途</th></tr></thead><tbody>
<tr><td>實模式</td><td>16 位</td><td>1MB</td><td>無</td><td>BIOS、DOS</td></tr>
<tr><td>保護模式</td><td>32 位</td><td>4GB</td><td>段、分頁</td><td>xv6 內核</td></tr>
<tr><td>長模式（64位）</td><td>64 位</td><td>16EB</td><td>分頁</td><td>現代 OS</td></tr>
</tbody></table>
</div>
<h3 id="36-段描述符格式"><a class="header" href="#36-段描述符格式">3.6 段描述符格式</a></h3>
<p><img src="images/segment-descriptor-format.gif" alt="Segment Descriptor Format Diagram" /></p>
<p><strong>段描述符包含</strong>：</p>
<ul>
<li><strong>基地址 (Base Address)</strong>：段在線性地址空間中的起始地址</li>
<li><strong>段限制 (Limit)</strong>：段的大小
<ul>
<li>以字節為單位（粒度 = 1）</li>
<li>或以 4KB 頁為單位（粒度 = 4KB）</li>
</ul>
</li>
<li><strong>訪問權限 (Type/S/DPL/P)</strong>：
<ul>
<li>Type：段類型（代碼或數據）</li>
<li>S：描述符類型（系統或非系統）</li>
<li>DPL：特權級別（0-3）</li>
<li>P：段存在位</li>
</ul>
</li>
</ul>
<hr />
<h2 id="第-4-章引導程序詳解"><a class="header" href="#第-4-章引導程序詳解">第 4 章：引導程序詳解</a></h2>
<h3 id="41-bootasms---彙編啟動代碼"><a class="header" href="#41-bootasms---彙編啟動代碼">4.1 bootasm.S - 彙編啟動代碼</a></h3>
<p><strong>主要責任</strong>：</p>
<ol>
<li>禁用中斷和清除寄存器</li>
<li>初始化 GDT（全局描述符表）</li>
<li>從實模式切換到 32 位保護模式</li>
<li>跳轉到 bootmain.c 的 C 代碼</li>
</ol>
<p><strong>關鍵步驟</strong>：</p>
<pre><code class="language-asm"># 1. 禁用中斷
cli

# 2. 清除全局描述符表
lgdt gdtdesc

# 3. 啟用保護模式位
mov %cr0, %eax
orl $CR0_PE, %eax
mov %eax, %cr0

# 4. 長跳轉到 32 位代碼段
ljmp $SEG_KCODE, $start32
</code></pre>
<h3 id="42-bootmainc---c-語言啟動代碼"><a class="header" href="#42-bootmainc---c-語言啟動代碼">4.2 bootmain.c - C 語言啟動代碼</a></h3>
<p><strong>功能</strong>：</p>
<ol>
<li>從磁盤讀取內核 ELF 映像</li>
<li>將每個程序段加載到指定的物理內存地址</li>
<li>跳轉到內核入口點</li>
</ol>
<p><strong>ELF 加載流程</strong>：</p>
<pre><code class="language-c">void
bootmain(void)
{
    struct elfhdr *elf;
    struct proghdr *ph, *eph;
    void (*entry)(void);
    uchar* pa;

    // 從磁盤扇區 1 讀取第一個頁面（4KB）
    readseg((uchar*)0x10000, 4096, 0);
    
    // 查找 ELF 頭
    elf = (struct elfhdr*)0x10000;
    
    // 檢查 ELF 魔數
    if(elf-&gt;magic != ELF_MAGIC)
        return;  // 無效 ELF
    
    // 加載每個程序段
    ph = (struct proghdr*)((uchar*)elf + elf-&gt;phoff);
    eph = ph + elf-&gt;phnum;
    
    for(; ph &lt; eph; ph++){
        pa = (uchar*)ph-&gt;paddr;
        readseg(pa, ph-&gt;filesz, ph-&gt;offset);
        
        // 初始化 BSS 段（未初始化數據）
        if(ph-&gt;memsz &gt; ph-&gt;filesz)
            stosb(pa + ph-&gt;filesz, 0, ph-&gt;memsz - ph-&gt;filesz);
    }
    
    // 跳轉到內核入口點
    entry = (void(*)(void))(elf-&gt;entry);
    entry();
}
</code></pre>
<h3 id="43-entrys---內核入口"><a class="header" href="#43-entrys---內核入口">4.3 entry.S - 內核入口</a></h3>
<p><strong>主要功能</strong>：</p>
<ol>
<li>設置頁表</li>
<li>啟用分頁</li>
<li>跳轉到 main()</li>
</ol>
<hr />
<h2 id="第-5-章內存管理"><a class="header" href="#第-5-章內存管理">第 5 章：內存管理</a></h2>
<h3 id="51-虛擬內存架構"><a class="header" href="#51-虛擬內存架構">5.1 虛擬內存架構</a></h3>
<p>xv6 使用分頁實現虛擬內存：</p>
<pre><code>應用程序虛擬地址空間
0xFFFFFFFF +----------+ ← 內核空間
           |          |
           | Kernel   |
           |          |
0x80000000 +----------+ ← 0.5GB - 用戶/內核邊界
           |          |
           | User     | ← 堆和棧
           |          |
0x00000000 +----------+
</code></pre>
<h3 id="52-頁表結構"><a class="header" href="#52-頁表結構">5.2 頁表結構</a></h3>
<p>xv6 使用兩級頁表：</p>
<ul>
<li><strong>頁目錄（PD）</strong>：第一級，10 位索引</li>
<li><strong>頁表（PT）</strong>：第二級，10 位索引</li>
<li><strong>頁內偏移</strong>：12 位</li>
</ul>
<pre><code>虛擬地址：[PD Index(10)|PT Index(10)|Offset(12)]
                ↓            ↓            ↓
          頁目錄表   →    頁表    →   物理頁
</code></pre>
<h3 id="53-關鍵數據結構"><a class="header" href="#53-關鍵數據結構">5.3 關鍵數據結構</a></h3>
<h4 id="頁表項-pte"><a class="header" href="#頁表項-pte">頁表項 (PTE)</a></h4>
<pre><code class="language-c">typedef uint pte_t;  // 32-bit 或 64-bit
</code></pre>
<p><strong>PTE 格式</strong>：</p>
<pre><code>[物理頁號(20)|保留(3)|標誌位(9)]
   ↓                   ↓
 頁幀號             PTE_P(存在)
                   PTE_W(可寫)
                   PTE_U(用戶)
</code></pre>
<h4 id="核心函數"><a class="header" href="#核心函數">核心函數</a></h4>
<pre><code class="language-c">pte_t *walkpgdir(pde_t *pgdir, const void *va);
int mappages(pde_t *pgdir, void *va, uint size, uint pa, int perm);
void switchuvm(struct proc *p);
</code></pre>
<hr />
<h2 id="第-6-章進程管理"><a class="header" href="#第-6-章進程管理">第 6 章：進程管理</a></h2>
<h3 id="61-進程數據結構"><a class="header" href="#61-進程數據結構">6.1 進程數據結構</a></h3>
<h4 id="proc-結構體"><a class="header" href="#proc-結構體">proc 結構體</a></h4>
<pre><code class="language-c">struct proc {
    uint sz;                    // 進程內存大小
    pde_t* pgdir;              // 頁目錄
    char *kstack;              // 內核棧底（用於上下文保存）
    enum procstate state;      // 進程狀態
    int pid;                   // 進程 ID
    struct proc *parent;       // 父進程
    struct trapframe *tf;      // 中斷幀（保存用戶寄存器）
    struct context *context;   // 上下文（保存內核寄存器）
    void *chan;                // 睡眠通道（條件變量）
    int killed;                // 進程是否被殺死
    struct file *ofile[NOFILE]; // 打開文件表
    struct inode *cwd;         // 當前工作目錄
    char name[16];             // 進程名稱
};
</code></pre>
<h3 id="62-進程狀態"><a class="header" href="#62-進程狀態">6.2 進程狀態</a></h3>
<pre><code>UNUSED ──→ EMBRYO ──→ RUNNABLE ──→ RUNNING
             ↑                        ↓
             └──────────────────── SLEEPING
                                     ↓
                                  ZOMBIE
</code></pre>
<ul>
<li><strong>UNUSED</strong>：未使用槽位</li>
<li><strong>EMBRYO</strong>：新建，初始化中</li>
<li><strong>RUNNABLE</strong>：就緒，等待調度</li>
<li><strong>RUNNING</strong>：正在運行</li>
<li><strong>SLEEPING</strong>：等待事件</li>
<li><strong>ZOMBIE</strong>：已終止，等待父進程回收</li>
</ul>
<h3 id="63-上下文切換"><a class="header" href="#63-上下文切換">6.3 上下文切換</a></h3>
<h4 id="context-結構體"><a class="header" href="#context-結構體">context 結構體</a></h4>
<pre><code class="language-c">struct context {
    uint edi;
    uint esi;
    uint ebx;
    uint ebp;
    uint eip;
};
</code></pre>
<p><strong>切換流程</strong>：</p>
<pre><code>用戶態代碼
    ↓
[中斷/系統調用]
    ↓
中斷處理程序
    ↓
schedule() 選擇新進程
    ↓
swtch() 保存舊上下文，恢復新上下文
    ↓
新進程代碼繼續
</code></pre>
<hr />
<h2 id="第-7-章中斷和異常"><a class="header" href="#第-7-章中斷和異常">第 7 章：中斷和異常</a></h2>
<h3 id="71-中斷描述符表idt"><a class="header" href="#71-中斷描述符表idt">7.1 中斷描述符表（IDT）</a></h3>
<p>類似 GDT，定義中斷和異常處理器：</p>
<pre><code class="language-c">struct gatedesc {
    uint off_15_0;      // 低 16 位偏移
    ushort sel;         // 段選擇子
    uchar args;         // 參數個數
    uchar type;         // 門類型
    ushort off_31_16;   // 高 16 位偏移
};
</code></pre>
<h3 id="72-系統調用實現"><a class="header" href="#72-系統調用實現">7.2 系統調用實現</a></h3>
<p><strong>流程</strong>：</p>
<pre><code>用戶程序
    ↓
[int $T_SYSCALL] (INT 0x80)
    ↓
alltraps() → trapasm.S 匯編入口
    ↓
trap() 中斷處理函數
    ↓
syscall() 分發系統調用
    ↓
sys_xxx() 具體系統調用實現
    ↓
返回用戶程序
</code></pre>
<p><strong>系統調用編號存儲位置</strong>：</p>
<ul>
<li><strong>寄存器 eax</strong>：系統調用號</li>
<li><strong>其他寄存器</strong>：系統調用參數（edi, esi, edx, ecx, ebx）</li>
</ul>
<h3 id="73-常見系統調用"><a class="header" href="#73-常見系統調用">7.3 常見系統調用</a></h3>
<div class="table-wrapper"><table><thead><tr><th>系統調用</th><th>功能</th></tr></thead><tbody>
<tr><td>fork()</td><td>創建新進程</td></tr>
<tr><td>exec()</td><td>執行程序</td></tr>
<tr><td>exit()</td><td>進程退出</td></tr>
<tr><td>wait()</td><td>等待子進程</td></tr>
<tr><td>getpid()</td><td>獲取進程 ID</td></tr>
<tr><td>read()</td><td>讀取文件</td></tr>
<tr><td>write()</td><td>寫入文件</td></tr>
<tr><td>open()</td><td>打開文件</td></tr>
<tr><td>close()</td><td>關閉文件</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="第-8-章文件系統"><a class="header" href="#第-8-章文件系統">第 8 章：文件系統</a></h2>
<h3 id="81-文件系統結構"><a class="header" href="#81-文件系統結構">8.1 文件系統結構</a></h3>
<p>xv6 使用簡化的 Unix 文件系統：</p>
<pre><code>+--------+--------+--------+---------+
| Boot   | Super  | Inode  | Data    |
| Block  | Block  | Block  | Blocks  |
+--------+--------+--------+---------+
</code></pre>
<h3 id="82-i-node-結構"><a class="header" href="#82-i-node-結構">8.2 I-node 結構</a></h3>
<pre><code class="language-c">struct dinode {
    short type;           // 文件類型（文件/目錄）
    short major, minor;   // 設備號
    uint size;           // 文件大小
    uint addrs[NDIRECT+1]; // 直接和間接塊指針
};
</code></pre>
<h3 id="83-目錄結構"><a class="header" href="#83-目錄結構">8.3 目錄結構</a></h3>
<p>目錄是特殊的文件，包含目錄項：</p>
<pre><code class="language-c">struct dirent {
    ushort inum;        // I-node 編號
    char name[DIRSIZ];  // 文件名
};
</code></pre>
<hr />
<h2 id="第-9-章系統調用詳解"><a class="header" href="#第-9-章系統調用詳解">第 9 章：系統調用詳解</a></h2>
<h3 id="91-fork---進程創建"><a class="header" href="#91-fork---進程創建">9.1 fork() - 進程創建</a></h3>
<p><strong>作用</strong>：創建當前進程的副本</p>
<p><strong>返回值</strong>：</p>
<ul>
<li>父進程：子進程 ID</li>
<li>子進程：0</li>
<li>錯誤：-1</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="language-c">int pid = fork();
if(pid == 0) {
    // 子進程代碼
} else {
    // 父進程代碼
}
</code></pre>
<h3 id="92-exec---程序執行"><a class="header" href="#92-exec---程序執行">9.2 exec() - 程序執行</a></h3>
<p><strong>作用</strong>：用新程序替換當前進程</p>
<p><strong>語法</strong>：</p>
<pre><code class="language-c">exec(char *path, char *argv[]);
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="language-c">char *args[] = {"cat", "file.txt", 0};
exec("/bin/cat", args);
</code></pre>
<h3 id="93-exit---進程退出"><a class="header" href="#93-exit---進程退出">9.3 exit() - 進程退出</a></h3>
<p><strong>作用</strong>：終止當前進程</p>
<p><strong>語法</strong>：</p>
<pre><code class="language-c">exit(int status);
</code></pre>
<h3 id="94-wait---等待子進程"><a class="header" href="#94-wait---等待子進程">9.4 wait() - 等待子進程</a></h3>
<p><strong>作用</strong>：等待子進程終止</p>
<p><strong>語法</strong>：</p>
<pre><code class="language-c">wait(int *status);
</code></pre>
<h3 id="95-read--write---文件-io"><a class="header" href="#95-read--write---文件-io">9.5 read() / write() - 文件 I/O</a></h3>
<p><strong>讀取文件</strong>：</p>
<pre><code class="language-c">ssize_t read(int fd, void *buf, size_t count);
</code></pre>
<p><strong>寫入文件</strong>：</p>
<pre><code class="language-c">ssize_t write(int fd, const void *buf, size_t count);
</code></pre>
<hr />
<h2 id="附錄-a源代碼位置參考"><a class="header" href="#附錄-a源代碼位置參考">附錄 A：源代碼位置參考</a></h2>
<h3 id="核心文件"><a class="header" href="#核心文件">核心文件</a></h3>
<div class="table-wrapper"><table><thead><tr><th>文件</th><th>功能</th></tr></thead><tbody>
<tr><td><code>bootasm.S</code></td><td>啟動彙編代碼（實→保護模式）</td></tr>
<tr><td><code>bootmain.c</code></td><td>啟動 C 代碼（加載內核）</td></tr>
<tr><td><code>entry.S</code></td><td>內核入口（分頁設置）</td></tr>
<tr><td><code>main.c</code></td><td>內核主函數</td></tr>
<tr><td><code>proc.c</code></td><td>進程管理</td></tr>
<tr><td><code>vm.c</code></td><td>虛擬內存管理</td></tr>
<tr><td><code>trap.c</code></td><td>中斷和異常處理</td></tr>
<tr><td><code>syscall.c</code></td><td>系統調用分發</td></tr>
<tr><td><code>sysproc.c</code></td><td>進程相關系統調用</td></tr>
<tr><td><code>sysfile.c</code></td><td>文件相關系統調用</td></tr>
<tr><td><code>fs.c</code></td><td>文件系統實現</td></tr>
<tr><td><code>ide.c</code></td><td>磁盤驅動</td></tr>
</tbody></table>
</div>
<h3 id="用戶程序位置"><a class="header" href="#用戶程序位置">用戶程序位置</a></h3>
<p>用戶程序源碼位於 <code>user/</code> 目錄：</p>
<pre><code>user/
├── shell.c      # xv6 shell
├── cat.c        # cat 命令
├── ls.c         # ls 命令
├── mkdir.c      # mkdir 命令
└── ...
</code></pre>
<hr />
<h2 id="附錄-bxv6-啟動詳解"><a class="header" href="#附錄-bxv6-啟動詳解">附錄 B：xv6 啟動詳解</a></h2>
<h3 id="完整啟動序列"><a class="header" href="#完整啟動序列">完整啟動序列</a></h3>
<pre><code>1. 計算機上電
   ↓
2. BIOS 執行 POST（自檢）
   ↓
3. BIOS 尋找可引導設備
   ↓
4. 加載 MBR（主引導記錄） → bootblock
   物理地址：0x7c00
   ↓
5. bootasm.S 執行
   - CPU 模式：實模式
   - 任務：
     * 禁用中斷（CLI）
     * 加載 GDT
     * 啟用保護模式（設置 CR0 的 PE 位）
     * 長跳轉到 32 位代碼段
   ↓
6. bootmain.c 執行
   - CPU 模式：保護模式（32 位）
   - 任務：
     * 初始化磁盤驅動
     * 加載 ELF 格式的內核映像
     * 解析 ELF 頭和程序段
     * 將每個段複製到指定物理地址
     * 跳轉到內核入口點
   ↓
7. entry.S 執行
   - 任務：
     * 設置臨時頁表
     * 啟用分頁（設置 CR0 的 PG 位）
     * 虛擬地址映射已生效
     * 跳轉到 main()
   ↓
8. main.c 執行（內核初始化）
   - CPU 模式：保護模式 + 分頁
   - 任務：
     * 初始化 CPU
     * 初始化內存管理
     * 初始化中斷和異常處理（IDT）
     * 初始化進程系統
     * 啟動首個用戶進程（init）
   ↓
9. init 進程啟動
   - 創建 shell 進程
   - 等待用戶命令
</code></pre>
<h3 id="啟動時的內存映射"><a class="header" href="#啟動時的內存映射">啟動時的內存映射</a></h3>
<p><strong>bootblock 加載時</strong>（實模式）：</p>
<pre><code>0x00000000 +----------+ 
           | IVT      | (中斷向量表)
0x00007C00 +----------+ ← bootblock 加載位置
           |bootblock |
0x00007E00 +----------+
           | 空閒     |
0x00100000 +----------+ ← 內核加載位置
</code></pre>
<p><strong>內核運行時</strong>（保護模式 + 分頁）：</p>
<pre><code>虛擬地址           物理地址
0xFFFFFFFF    
          +----------+
          | 內核棧   |
0xFE000000 +----------+
          | 內核代碼 |
          | 和數據   |
0x80000000 +----------+
          | 頁表     |
0x00000000 +----------+
</code></pre>
<hr />
<h2 id="關鍵知識點"><a class="header" href="#關鍵知識點">關鍵知識點</a></h2>
<h3 id="1-模式轉換"><a class="header" href="#1-模式轉換">1. 模式轉換</a></h3>
<ul>
<li><strong>實模式 → 保護模式</strong>：bootasm.S</li>
<li><strong>分頁啟用</strong>：entry.S</li>
</ul>
<h3 id="2-地址轉換"><a class="header" href="#2-地址轉換">2. 地址轉換</a></h3>
<ul>
<li><strong>物理地址</strong>：硬體實際使用的地址</li>
<li><strong>線性地址</strong>：保護模式下的地址（GDT 轉換）</li>
<li><strong>虛擬地址</strong>：分頁後的地址（頁表轉換）</li>
</ul>
<h3 id="3-特權級別"><a class="header" href="#3-特權級別">3. 特權級別</a></h3>
<ul>
<li><strong>Ring 0</strong>：內核態（無限制）</li>
<li><strong>Ring 3</strong>：用戶態（受限）</li>
<li>系統調用通過中斷實現特權提升</li>
</ul>
<h3 id="4-進程隔離"><a class="header" href="#4-進程隔離">4. 進程隔離</a></h3>
<ul>
<li>每個進程有獨立的虛擬地址空間</li>
<li>通過頁表實現</li>
<li>防止進程間互相干擾</li>
</ul>
<hr />
<h2 id="實驗建議"><a class="header" href="#實驗建議">實驗建議</a></h2>
<h3 id="初級實驗"><a class="header" href="#初級實驗">初級實驗</a></h3>
<ol>
<li>✅ 修改啟動消息</li>
<li>✅ 添加簡單用戶程序</li>
<li>✅ 實現簡單系統調用</li>
</ol>
<h3 id="中級實驗"><a class="header" href="#中級實驗">中級實驗</a></h3>
<ol>
<li>修改進程調度算法</li>
<li>實現新的系統調用（如 <code>getcpuid()</code>）</li>
<li>追蹤進程創建流程</li>
</ol>
<h3 id="高級實驗"><a class="header" href="#高級實驗">高級實驗</a></h3>
<ol>
<li>實現分層分頁</li>
<li>添加信號機制</li>
<li>優化內存管理</li>
<li>實現管道機制</li>
</ol>
<hr />
<h2 id="常見問題解答"><a class="header" href="#常見問題解答">常見問題解答</a></h2>
<h3 id="q1-xv6-為什麼使用分段"><a class="header" href="#q1-xv6-為什麼使用分段">Q1: xv6 為什麼使用分段？</a></h3>
<p><strong>A</strong>：雖然 xv6 主要依賴分頁，但仍使用分段：</p>
<ul>
<li>滿足 x86 硬體要求（必須有 GDT）</li>
<li>實現用戶態/內核態分離</li>
<li>提供額外的訪問控制層</li>
</ul>
<h3 id="q2-為什麼要有-bootblock"><a class="header" href="#q2-為什麼要有-bootblock">Q2: 為什麼要有 bootblock？</a></h3>
<p><strong>A</strong>：</p>
<ul>
<li>BIOS 期望在 0x7c00 找到可引導代碼</li>
<li>大小限制為 512 字節（一個扇區）</li>
<li>用於完成初始化工作並加載主內核</li>
</ul>
<h3 id="q3-xv6-如何限制進程訪問"><a class="header" href="#q3-xv6-如何限制進程訪問">Q3: xv6 如何限制進程訪問？</a></h3>
<p><strong>A</strong>：</p>
<ul>
<li><strong>分段</strong>：用戶態進程只能訪問用戶段</li>
<li><strong>分頁</strong>：頁表中的 PTE_U 位控制用戶訪問</li>
<li><strong>系統調用</strong>：用戶操作必須通過內核</li>
</ul>
<h3 id="q4-如何調試-xv6"><a class="header" href="#q4-如何調試-xv6">Q4: 如何調試 xv6？</a></h3>
<p><strong>A</strong>：</p>
<pre><code class="language-bash"># 終端 1：運行 QEMU
make qemu-gdb

# 終端 2：運行 GDB
gdb kernel
(gdb) target remote localhost:26000
(gdb) break main
(gdb) continue
</code></pre>
<hr />
<h2 id="參考資源"><a class="header" href="#參考資源">參考資源</a></h2>
<h3 id="官方資源"><a class="header" href="#官方資源">官方資源</a></h3>
<ul>
<li><a href="https://github.com/mit-pdos/xv6-public">xv6 公開倉庫</a></li>
<li><a href="https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf">xv6 論文</a></li>
<li><a href="https://pdos.csail.mit.edu/6.828/">MIT 6.828 課程</a></li>
</ul>
<h3 id="推薦閱讀"><a class="header" href="#推薦閱讀">推薦閱讀</a></h3>
<ul>
<li><strong>Lions' Commentary on UNIX 6th Edition</strong></li>
<li><strong>The Design and Implementation of the 9th Edition Unix Operating System</strong> (Pike, Ritchie)</li>
<li><strong>Operating System Concepts</strong> (Silberschatz, Galvin, Gagne)</li>
</ul>
<h3 id="相關圖表"><a class="header" href="#相關圖表">相關圖表</a></h3>
<ul>
<li>x86 架構手冊（Intel Software Developer's Manual）</li>
<li>分頁機制詳解</li>
<li>GDT 和 IDT 格式規範</li>
</ul>
<hr />
<h2 id="更新歷史"><a class="header" href="#更新歷史">更新歷史</a></h2>
<ul>
<li><strong>2023-02-27</strong>：初版完成</li>
<li><strong>2024-11-19</strong>：更新補充並添加圖表</li>
</ul>
<hr />
<p><strong>筆記作者</strong>：基於《操作系統原型 - xv6 分析與實踐》一書
<strong>最後更新</strong>：2024 年 11 月 19 日</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../os/os.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../os/full_xv6_analysis.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../os/os.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../os/full_xv6_analysis.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
