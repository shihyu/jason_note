<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Performance - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="如何提高backtrader回測性能1倍以上且最佳化記憶體"><a class="header" href="#如何提高backtrader回測性能1倍以上且最佳化記憶體">如何提高BACKTRADER回測性能1倍以上且最佳化記憶體</a></h2>
<p>出處：https://www.itbook5.com/12372/</p>
<h3 id="使用200萬條k線的資料測試backtrader的回測性能如何"><a class="header" href="#使用200萬條k線的資料測試backtrader的回測性能如何">使用200萬條K線的資料，測試backtrader的回測性能如何？</a></h3>
<p>為了做到這一點，第一件事就是產生的足夠的K線。所以，我們會做以下動作：</p>
<ul>
<li>產生100支股票</li>
<li>每支股票 20000條K線資料</li>
</ul>
<p>100個股票資料檔案總計200萬 根K線資料.</p>
<p>程式碼：</p>
<pre><code class="language-python">import numpy as np
import pandas as pd

COLUMNS = ['open', 'high', 'low', 'close', 'volume', 'openinterest']
CANDLES = 20000
STOCKS

dateindex = pd.date_range(start='2010-01-01', periods=CANDLES, freq='15min')

for i in range(STOCKS):

    data = np.random.randint(10, 20, size=(CANDLES, len(COLUMNS)))
    df = pd.DataFrame(data * 1.01, dateindex, columns=COLUMNS)
    df = df.rename_axis('datetime')
    df.to_csv('candles{:02d}.csv'.format(i))
</code></pre>
<p>這會生成 100 個檔案，從<code>candles00.csv到``candles99.csv</code>. 其中實際值並不重要。擁有標準 <code>datetime</code>、<code>OHLCV</code>（和<code>OpenInterest</code>）才是最重要的。</p>
<h2 id="測試系統"><a class="header" href="#測試系統">測試系統</a></h2>
<ul>
<li><em>硬體/作業系統</em>：將使用配備 Intel i7 和 32 GB 記憶體的<em>Windows 10的 15.6″筆記型電腦。</em></li>
<li><em>Python</em> : CPython<code>3.6.1</code>和<code>pypy3 6.0.0</code></li>
<li><em>其他</em>：持續運行並佔用大約 20% 的 CPU 的應用程式。正在運行著Chrome（102 個處理程序）、Edge、Word、Powerpoint、Excel 和一些小型應用程式等通常的程序。</li>
</ul>
<h2 id="默認組態"><a class="header" href="#默認組態">默認組態</a></h2>
<p>讓我們回顧一下<em>backtrader</em>的默認執行階段組態是什麼：</p>
<ul>
<li>如果可能，預載入所有資料饋送</li>
<li>如果可以預載入所有資料饋送，則以批處理模式運行（命名為<code>runonce</code>）</li>
<li>首先預先計算所有指標</li>
<li>逐步瞭解策略邏輯和經紀人</li>
</ul>
<h2 id="runonce在默認批處理模式下執行"><a class="header" href="#runonce在默認批處理模式下執行"><code>runonce</code>在默認批處理模式下執行</a></h2>
<p>我們的測試指令碼（完整原始碼見底部）將打開這 100 個檔案並使用backtrader默認的組態運行。</p>
<pre><code class="language-sh">$ ./two-million-candles.py
Cerebro Start Time:          2019-10-26 08:33:15.563088
Strat Init Time:             2019-10-26 08:34:31.845349
Time Loading Data Feeds:     76.28
Number of data feeds:        100
Strat Start Time:            2019-10-26 08:34:31.864349
Pre-Next Start Time:         2019-10-26 08:34:32.670352
Time Calculating Indicators: 0.81
Next Start Time:             2019-10-26 08:34:32.671351
Strat warm-up period Time:   0.00
Time to Strat Next Logic:    77.11
End Time:                    2019-10-26 08:35:31.493349
Time in Strategy Next Logic: 58.82
Total Time in Strategy:      58.82
Total Time:                  135.93
Length of data feeds:        20000
</code></pre>
<p><strong>記憶體使用</strong>：觀察到 348 MB 的峰值</p>
<p>大部分時間實際上都花在預載入資料（<code>98.63</code>秒）上，其餘時間花在策略上，包括在每次迭代中通過代理（<code>73.63</code>秒）。總時間為<code>173.26</code>秒。</p>
<p>根據您想要計算它的方式，性能是：</p>
<ul>
<li>考慮到整個執行階段間:<code>14,713</code>根K線/秒</li>
</ul>
<p>說明以這樣的資料量backtrader處理起來，基本沒有壓力，記憶體的處理上，還可以通過參數的設定進行最佳化。將在後面做更多的探索。</p>
<h3 id="比較使用pypy的方案"><a class="header" href="#比較使用pypy的方案"><code>比較使用pypy的方案</code></a></h3>
<p>使用pypy的情況下，運行結果如下：</p>
<pre><code class="language-sh">$ ./two-million-candles.py
Cerebro Start Time:          2019-10-26 08:39:42.958689
Strat Init Time:             2019-10-26 08:40:31.260691
Time Loading Data Feeds:     48.30
Number of data feeds:        100
Strat Start Time:            2019-10-26 08:40:31.338692
Pre-Next Start Time:         2019-10-26 08:40:31.612688
Time Calculating Indicators: 0.27
Next Start Time:             2019-10-26 08:40:31.612688
Strat warm-up period Time:   0.00
Time to Strat Next Logic:    48.65
End Time:                    2019-10-26 08:40:40.150689
Time in Strategy Next Logic: 8.54
Total Time in Strategy:      8.54
Total Time:                  57.19
Length of data feeds:        20000
</code></pre>
<p>總時間已經從 <code>135.93</code>秒減少到<code>57.19</code>秒。性能提高了<strong>一倍多</strong>。</p>
<p>性能：<code>34,971</code>根K線/秒</p>
<p><strong>記憶體使用</strong>：觀察到 269 MB 的峰值。</p>
<p>這也是對標準 CPython 直譯器的重要改進。</p>
<h2 id="handling-2m的蠟燭出核心memory"><a class="header" href="#handling-2m的蠟燭出核心memory">Handling 2M的蠟燭出核心<a href="https://www.itbook5.com/tag/memory/">memory</a></a></h2>
<p>如果考慮到<em>backtrader</em>有多個用於執行回測會話的組態選項，所有這些都可以得到改進，包括最佳化緩衝區和僅使用所需的最少資料集（理想情況下僅使用 size 的緩衝區，這只會發生在理想場景）</p>
<pre><code class="language-python">class backtrader.Cerebro()
參數：

preload（默認True：）
是否預加載data feeds傳遞給 cerebro

runonce（默認：True）
以矢量化模式運行Indicators以加速整個系統。策略和觀察者將始終基於事件運行

live（默認：False）
默認是回測數據。

當使用實時數據時設置成True（或通過數據的islive 方法）

這將同時停用preload和runonce。它對內存節省方案沒有影響。

以矢量化模式運行Indicators以加速整個系統。策略和觀察者將始終基於事件運行

maxcpus（默認值：None -&gt; 所有可用內核）
同時使用多少個內核進行優化

stdstats（默認：True）
默認將添加真正的默認觀察員：經紀人（現金和價值）、交易和買入賣出

oldbuysell（默認：False）（與畫圖相關）
如果stdstatsis：True 時觀察者自動添加，則此開關使用BuySell

False：其中買入/賣出信號分別繪製在低/高價下方/上方，以避免混亂

True：在該行為中繪製買入/賣出信號在給定時間的訂單執行的平均價格。這當然會在 OHLC 條的頂部或在 Close 的 Line 上，從而難以識別。

oldtrades（默認：False）（與畫圖相關）
如果stdstatsis：True時觀察者自動添加，則此開關控制Trades 

False：其中所有數據的交易都用不同的標記繪製

True：同一方向的交易用相同的標記繪製交易，僅區分它們是正數還是負數

exactbars（默認：False）
使用默認值，存儲在一行中的每個值都保存在內存中

`True` 或 `1`：所有“行”對象將內存使用量減少到自動計算的最小週期。

  如果簡單移動平均線的週期為 30，則基礎數據將始終具有 30 個柱的運行緩衝區，以允許計算簡單移動平均線

  * 此設置將停用 `preload` 和 `runonce` 

  * 使用此設置也會停用**繪圖** 

objcache (default: False)
如果為True實現line對象的緩存。

writer（默認: False）
如果設置為True時 它將標準信息的輸出生成一個默認文件

tradehistory（默認: False）
如果設置為True，它將在所有策略的每筆交易中激活更新事件記錄log。這也可以在每個策略的上使用set_tradehistory來實現

optdatas（默認：True）
如果True優化（並且preload和runonce也是True），數據預加載將在主進程中只進行一次，以節省時間和資源。

optreturn（默認：True）
如果True優化結果只有params屬性和analyzers指標，而不是完整Strategy 對象（以及所有數據、指標、觀察者……），這樣可以優化速度，測試顯示改善13% - 15%的執行時間

oldsync（默認False：）
從版本 1.9.0.99 開始，多個數據（相同或不同時間範圍）的同步已更改為允許不同長度的數據。

如果希望使用 data0 作為系統主控的舊行為，請將此參數設置為 true

tz（默認：None）
為策略添加全球時區。論據tz可以是

* `None`：在這種情況下，策略顯示的日期時間將採用UTC，這是標準行為

* `pytz` 實例。它將用於將 UTC 時間轉換為所選時區

* `string`。將嘗試實例化 `pytz` 實例。

* `整數`。
  對於策略，使用與 `self.datas` 迭代中相應的 `data`相同的時區（`0` 將使用來自 `data0` 的時區）

cheat_on_open（默認：False）
當為True時next_open調用發生在next方法調用之前。此時指標尚未重新計算。這允許發佈一個考慮前一天指標但使用open價格計算的訂單

對於 cheat_on_open 訂單執行，還需要調用cerebro.broker.set_coo(True)或實例化一個經紀人 BackBroker(coo=True)（其中coo代表 cheat-on-open）或將broker_coo參數設置為True. 除非在下面禁用，否則 Cerebro 會自動執行此操作。

broker_coo（默認：True）
這將自動調用set_coo代理的方法True來激活cheat_on_open執行。cheat_on_open要同時為True

quicknotify（默認：False）
經紀人通知在下一個價格交付之前交付 。對於回溯測試，這沒有任何影響，但是對於實時經紀人，可以在柱線交付之前很久就發出通知。設置為True通知將盡快發送（請參閱qcheck實時提要）

設置False為兼容性。可以改為True
</code></pre>
<p>要使用的選項是<code>exactbars=True</code>. 從文件中 <code>exactbars</code>（這是<code>Cerebro</code>在實例化或呼叫時給出的參數<code>run</code>）</p>
<p>為了最大程度的最佳化並且停用繪圖，也將使用<code>stdstats=False</code>，停用現金、價值和交易的標準觀察者</p>
<pre><code class="language-sh">$ ./two-million-candles.py --cerebro exactbars=False,stdstats=False
Cerebro Start Time:          2019-10-26 08:37:08.014348
Strat Init Time:             2019-10-26 08:38:21.850392
Time Loading Data Feeds:     73.84
Number of data feeds:        100
Strat Start Time:            2019-10-26 08:38:21.851394
Pre-Next Start Time:         2019-10-26 08:38:21.857393
Time Calculating Indicators: 0.01
Next Start Time:             2019-10-26 08:38:21.857393
Strat warm-up period Time:   0.00
Time to Strat Next Logic:    73.84
End Time:                    2019-10-26 08:39:02.334936
Time in Strategy Next Logic: 40.48
Total Time in Strategy:      40.48
Total Time:                  114.32
Length of data feeds:        20000
</code></pre>
<p>性能：<code>17,494</code>根K線/秒</p>
<p><strong>記憶體使用</strong>：75M位元組（從開始回測開始到結束，穩定在這個數值）</p>
<p>讓我們與之前的非最佳化運行進行比較</p>
<ul>
<li>無需花費<code>76</code>秒鐘預載入資料，而是立即開始回測。</li>
<li>總時間是<code>114.32</code>秒 比 <code>135.93秒</code>改進<code>15.90%</code>。</li>
<li>使用記憶體改進了<code>68.5%</code>。</li>
</ul>
<h3 id="再次pypy"><a class="header" href="#再次pypy">再次<code>pypy</code></a></h3>
<p>既然我們知道如何最佳化，讓我們照著做一次<code>pypy</code>。</p>
<pre><code class="language-sh">$ ./two-million-candles.py --cerebro exactbars=True,stdstats=False 
Cerebro Start Time: 2019-10-26 08:44:32.309689 
Strat Init Time: 2019-10-26 08:44:32.406689
時間加載數據饋送：0.10
數據饋送數量：100 
Strat 開始時間：2019-10-26 08:44:32.409689 
Pre-Next Start Time：2019-10-26 08:44:32.451689
時間計算指標：0.04 
Next Start Time：2019 -10-26 08:44:32.451689 戰略
預熱期時間：0.00戰略下一個邏輯時間
：0.14
結束時間：2019-10-26 08:45:38.918693
戰略下一個邏輯時間：66.47
戰略總時間：66.47
總時間：66.61
數據饋送長度：20000
</code></pre>
<p>性能：<code>30,025</code>根K線/秒</p>
<p><strong>記憶體使用</strong>：恆定在<code>49 M位元組</code></p>
<p>將其與之前運行進行比較：</p>
<ul>
<li><code>66.61</code>秒 比<code>114.32t秒，在執行階段間上有``41.73%</code>的改進。</li>
<li><code>49 M位元組比``75 M位元組</code>，在記憶體上有<code>34.6%</code>的改進。</li>
</ul>
<p>在這種情況下，與批處理模式<code>pypy</code>相比，它無法擊敗自己的時間。這是意料之中的，因為在預載入時，計算器指示是在<strong>向量化</strong>模式下完成的。</p>
<p>無論如何，它仍然做得非常好，並且記憶體消耗有了重要的<strong>改善</strong></p>
<h2 id="完整的交易運行"><a class="header" href="#完整的交易運行">完整的交易運行</a></h2>
<p>該指令碼可以建立指標（移動平均線）並使用移動平均線的交叉<em>短期/長期策略</em>對 100 個股票執行回測*。*讓我們用<code>pypy</code>來做，並且知道使用批處理模式會更好，就這樣吧。</p>
<pre><code class="language-sh">$ ./two-million-candles.py --strat indicators=True,trade=True
Cerebro Start Time:          2019-10-26 08:57:36.114415
Strat Init Time:             2019-10-26 08:58:25.569448
Time Loading Data Feeds:     49.46
Number of data feeds:        100
Total indicators:            300
Moving Average to be used:   SMA
Indicators period 1:         10
Indicators period 2:         50
Strat Start Time:            2019-10-26 08:58:26.230445
Pre-Next Start Time:         2019-10-26 08:58:40.850447
Time Calculating Indicators: 14.62
Next Start Time:             2019-10-26 08:58:41.005446
Strat warm-up period Time:   0.15
Time to Strat Next Logic:    64.89
End Time:                    2019-10-26 09:00:13.057955
Time in Strategy Next Logic: 92.05
Total Time in Strategy:      92.21
Total Time:                  156.94
Length of data feeds:        20000
</code></pre>
<p>性能：<code>12,743</code>根K線/秒</p>
<p><strong>記憶體使用</strong>：<code>1300 M位元組</code>觀察到一個峰值。</p>
<p>由於增加了指標和交易，執行時間明顯增加了，但是為什麼記憶體使用也增加了？</p>
<p>在得出任何結論之前，讓我們嘗試建立指標但不進行交易</p>
<pre><code class="language-sh">$ ./two-million-candles.py --strat indicators=True
Cerebro Start Time:          2019-10-26 09:05:55.967969
Strat Init Time:             2019-10-26 09:06:44.072969
Time Loading Data Feeds:     48.10
Number of data feeds:        100
Total indicators:            300
Moving Average to be used:   SMA
Indicators period 1:         10
Indicators period 2:         50
Strat Start Time:            2019-10-26 09:06:44.779971
Pre-Next Start Time:         2019-10-26 09:06:59.208969
Time Calculating Indicators: 14.43
Next Start Time:             2019-10-26 09:06:59.360969
Strat warm-up period Time:   0.15
Time to Strat Next Logic:    63.39
End Time:                    2019-10-26 09:07:09.151838
Time in Strategy Next Logic: 9.79
Total Time in Strategy:      9.94
Total Time:                  73.18
Length of data feeds:        20000
</code></pre>
<p>性能：<code>27,329</code> 根K線/秒</p>
<p><strong>記憶體使用</strong>：（<code>600 M位元組</code>在最佳化<code>exactbars</code>模式下做同樣的事情只會消耗<code>60 M位元組</code>，但會增加執行時間，因為 <code>pypy</code>它本身不能最佳化這麼多）</p>
<p>有了<strong>交易，記憶體使用量確實增加</strong>了。原因是對像是由代理建立、傳遞和保存的<code>Order和``Trade。</code></p>
<p>還有該資料集包含隨機值，其產生數量龐大交叉的，因此有大量的訂單和交易。對於常規資料集，不會有類似的行為。</p>
<h2 id="結論"><a class="header" href="#結論">結論</a></h2>
<ol>
<li>
<ol>
<li><em>backtrader</em>可以使用默認組態輕鬆處理<code>2M</code>蠟燭圖（預載入記憶體資料）</li>
<li><em>backtrader</em>可以在非預載入最佳化模式下運行，將緩衝區減少到最小，以進行減少記憶體使用進行回測</li>
<li>在<em>最佳化</em>的非預載入模式下進行回測時，記憶體消耗的增加來自於代理產生的管理開銷。</li>
<li>即使交易、使用指標和經紀人不斷阻礙，表現也是<code>12,473</code>根K線/秒</li>
<li>儘可能使用<code>pypy</code>（如果您不需要繪圖的時候）</li>
</ol>
</li>
</ol>
<h2 id="測試指令碼"><a class="header" href="#測試指令碼">測試指令碼</a></h2>
<p>這裡是原始碼</p>
<pre><code class="language-python">#!/usr/bin/env python
# -*- coding: utf-8; py-indent-offset:4 -*-
###############################################################################
import argparse
import datetime

import backtrader as bt


class St(bt.Strategy):
    params = dict(
        indicators=False,
        indperiod1=10,
        indperiod2=50,
        indicator=bt.ind.SMA,
        trade=False,
    )

    def __init__(self):
        self.dtinit = datetime.datetime.now()
        print('Strat Init Time:             {}'.format(self.dtinit))
        loaddata = (self.dtinit - self.env.dtcerebro).total_seconds()
        print('Time Loading Data Feeds:     {:.2f}'.format(loaddata))

        print('Number of data feeds:        {}'.format(len(self.datas)))
        if self.p.indicators:
            total_ind = self.p.indicators * 3 * len(self.datas)
            print('Total indicators:            {}'.format(total_ind))
            indname = self.p.indicator.__name__
            print('Moving Average to be used:   {}'.format(indname))
            print('Indicators period 1:         {}'.format(self.p.indperiod1))
            print('Indicators period 2:         {}'.format(self.p.indperiod2))

            self.macross = {}
            for d in self.datas:
                ma1 = self.p.indicator(d, period=self.p.indperiod1)
                ma2 = self.p.indicator(d, period=self.p.indperiod2)
                self.macross[d] = bt.ind.CrossOver(ma1, ma2)

    def start(self):
        self.dtstart = datetime.datetime.now()
        print('Strat Start Time:            {}'.format(self.dtstart))

    def prenext(self):
        if len(self.data0) == 1:  # only 1st time
            self.dtprenext = datetime.datetime.now()
            print('Pre-Next Start Time:         {}'.format(self.dtprenext))
            indcalc = (self.dtprenext - self.dtstart).total_seconds()
            print('Time Calculating Indicators: {:.2f}'.format(indcalc))

    def nextstart(self):
        if len(self.data0) == 1:  # there was no prenext
            self.dtprenext = datetime.datetime.now()
            print('Pre-Next Start Time:         {}'.format(self.dtprenext))
            indcalc = (self.dtprenext - self.dtstart).total_seconds()
            print('Time Calculating Indicators: {:.2f}'.format(indcalc))

        self.dtnextstart = datetime.datetime.now()
        print('Next Start Time:             {}'.format(self.dtnextstart))
        warmup = (self.dtnextstart - self.dtprenext).total_seconds()
        print('Strat warm-up period Time:   {:.2f}'.format(warmup))
        nextstart = (self.dtnextstart - self.env.dtcerebro).total_seconds()
        print('Time to Strat Next Logic:    {:.2f}'.format(nextstart))
        self.next()

    def next(self):
        if not self.p.trade:
            return

        for d, macross in self.macross.items():
            if macross &gt; 0:
                self.order_target_size(data=d, target=1)
            elif macross &lt; 0:
                self.order_target_size(data=d, target=-1)

    def stop(self):
        dtstop = datetime.datetime.now()
        print('End Time:                    {}'.format(dtstop))
        nexttime = (dtstop - self.dtnextstart).total_seconds()
        print('Time in Strategy Next Logic: {:.2f}'.format(nexttime))
        strattime = (dtstop - self.dtprenext).total_seconds()
        print('Total Time in Strategy:      {:.2f}'.format(strattime))
        totaltime = (dtstop - self.env.dtcerebro).total_seconds()
        print('Total Time:                  {:.2f}'.format(totaltime))
        print('Length of data feeds:        {}'.format(len(self.data)))


def run(args=None):
    args = parse_args(args)

    cerebro = bt.Cerebro()

    datakwargs = dict(timeframe=bt.TimeFrame.Minutes, compression=15)
    for i in range(args.numfiles):
        dataname = 'candles{:02d}.csv'.format(i)
        data = bt.feeds.GenericCSVData(dataname=dataname, **datakwargs)
        cerebro.adddata(data)

    cerebro.addstrategy(St, **eval('dict(' + args.strat + ')'))
    cerebro.dtcerebro = dt0 = datetime.datetime.now()
    print('Cerebro Start Time:          {}'.format(dt0))
    cerebro.run(**eval('dict(' + args.cerebro + ')'))


def parse_args(pargs=None):
    parser = argparse.ArgumentParser(
        formatter_class=argparse.ArgumentDefaultsHelpFormatter,
        description=(
            'Backtrader Basic Script'
        )
    )

    parser.add_argument('--numfiles', required=False, default=100, type=int,
                        help='Number of files to rea')

    parser.add_argument('--cerebro', required=False, default='',
                        metavar='kwargs', help='kwargs in key=value format')

    parser.add_argument('--strat', '--strategy', required=False, default='',
                        metavar='kwargs', help='kwargs in key=value format')


    return parser.parse_args(pargs)


if __name__ == '__main__':
    run()
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../strategy/backtrader/Sample.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../cryptotrade/cryptotrade.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../strategy/backtrader/Sample.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../cryptotrade/cryptotrade.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>



    </div>
    </body>
</html>
