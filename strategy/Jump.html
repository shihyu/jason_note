<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>JUMP - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="jump"><a class="header" href="#jump">JUMP</a></h1>
<pre><code class="language-python">import pandas as pd
import warnings
import numpy as np
import vectorbt as vbt
import talib
from vectorbt.portfolio.enums import NoOrder
from vectorbt.portfolio import nb
from numba import njit
from loguru import logger

# Suppress warnings
warnings.filterwarnings("ignore")


def initialize_data(data):
    """
    Convert DataFrame columns to NumPy arrays for performance.

    Parameters:
        data (pd.DataFrame): The trading data.

    Returns:
        tuple: Contains various NumPy arrays extracted from the DataFrame.
    """
    is_thursday = data["Is_Thursday"].to_numpy()
    is_open_time = data["Is_Open_Time"].to_numpy()
    is_close_time = data["Is_Close_Time"].to_numpy()
    dates = data.index.strftime("%Y-%m-%d %H:%M:%S").tolist()
    timestamps = (pd.to_datetime(data.index).astype(int) // 10**9).tolist()
    open_prices = data["open"].to_numpy()
    close_prices = data["close"].to_numpy()
    high_prices = data["high"].to_numpy()
    low_prices = data["low"].to_numpy()
    long_conditions = data["long_condition"].to_numpy()
    short_conditions = data["short_condition"].to_numpy()
    long_atr_exit = data["long_atr_exit_value"].to_numpy()
    short_atr_exit = data["short_atr_exit_value"].to_numpy()
    atr_values = data["ATR"].to_numpy()

    return (
        is_thursday,
        is_open_time,
        is_close_time,
        dates,
        timestamps,
        open_prices,
        close_prices,
        high_prices,
        low_prices,
        long_conditions,
        short_conditions,
        long_atr_exit,
        short_atr_exit,
        atr_values,
    )


@njit
def execute_order(
    context,
    long_entry,
    short_entry,
    open_prices,
    high_prices,
    low_prices,
    entry_timestamps,
    trading_dates,
    trading_timestamps,
    is_thursday_flags,
    market_open_flags,
    market_close_flags,
    long_atr_sl,
    short_atr_sl,
    atr_vals,
    highest_since_entry,
    lowest_since_entry,
    max_high_M,
    min_low_M,
    check_interval_M,
    trading_mode,
):
    """
    Numba-compiled function to execute trading orders based on conditions.

    Parameters:
        context: Context object containing current state.
        ... (other parameters as in original function)

    Returns:
        Order action or NoOrder.
    """
    # Extract current data
    is_long = long_entry[context.i]
    is_short = short_entry[context.i]
    current_close = context.close[context.i, context.col]
    current_open = open_prices[context.i]
    current_high = high_prices[context.i]
    current_low = low_prices[context.i]
    current_date = trading_dates[context.i]
    current_timestamp = trading_timestamps[context.i]
    is_thursday = is_thursday_flags[context.i]
    is_market_open = market_open_flags[context.i]
    is_market_close = market_close_flags[context.i]
    current_position = context.position_now
    long_sl = long_atr_sl[context.i]
    short_sl = short_atr_sl[context.i]
    atr = atr_vals[context.i]

    if check_interval_M &gt; 0:
        recent_max_high = max_high_M[context.i]
        recent_min_low = min_low_M[context.i]

    time_held = 0
    if entry_timestamps[0] &gt; 0:
        time_held = int(current_timestamp - entry_timestamps[0])

    # Entry Logic
    if trading_mode in (0, 2):  # Long or Both
        if current_position == 0 and is_long and is_market_open:
            entry_timestamps[0] = current_timestamp
            highest_since_entry[0] = current_high
            return nb.order_nb(price=current_open, size=1)  # Enter Long

    if trading_mode in (1, 2):  # Short or Both
        if current_position == 0 and is_short and is_market_open:
            entry_timestamps[0] = current_timestamp
            lowest_since_entry[0] = current_low
            return nb.order_nb(price=current_open, size=-1)  # Enter Short

    # Long Position Management
    if trading_mode in (0, 2) and current_position &gt; 0:
        highest_since_entry[0] = max(highest_since_entry[0], current_high)

        # ATR Stop Loss
        if current_close &lt; long_sl:
            entry_timestamps[0] = 0
            highest_since_entry[0] = 0
            return nb.order_nb(price=current_close, size=-current_position)

        # Interval Check for Exiting
        if time_held &gt;= (check_interval_M * 60) and check_interval_M &gt; 0:
            if highest_since_entry[0] &lt; recent_max_high:
                entry_timestamps[0] = 0
                highest_since_entry[0] = 0
                return nb.order_nb(price=current_close, size=-current_position)

    # Short Position Management
    if trading_mode in (1, 2) and current_position &lt; 0:
        lowest_since_entry[0] = min(lowest_since_entry[0], current_low)

        # ATR Stop Loss
        if current_close &gt; short_sl:
            entry_timestamps[0] = 0
            lowest_since_entry[0] = 0
            return nb.order_nb(price=current_close, size=-current_position)

        # Interval Check for Exiting
        if time_held &gt;= (check_interval_M * 60) and check_interval_M &gt; 0:
            if lowest_since_entry[0] &gt; recent_min_low:
                entry_timestamps[0] = 0
                lowest_since_entry[0] = 0
                return nb.order_nb(price=current_close, size=-current_position)

    return NoOrder


def compute_open_price_change(df, open_time, close_time):
    """
    Calculate the percentage change in open prices compared to the previous close.

    Parameters:
        df (pd.DataFrame): The trading data.
        open_time (str): The opening time in "HH:MM:SS" format.
        close_time (str): The closing time in "HH:MM:SS" format.

    Returns:
        pd.DataFrame: DataFrame with an additional 'open_price_delta' column.
    """
    df_copy = df.copy()
    df_copy["open_price_delta"] = 0.0
    dates = df.index.strftime("%Y-%m-%d").tolist()
    unique_dates = sorted(set(dates))
    previous_date = unique_dates[0]

    for current_date in unique_dates[1:]:
        open_datetime = f"{current_date} {open_time}"
        close_datetime = f"{previous_date} {close_time}"
        if open_datetime not in df.index or close_datetime not in df.index:
            previous_date = current_date
            continue
        open_price = df.loc[open_datetime, "open"]
        close_price = df.loc[close_datetime, "close"]
        df_copy.loc[open_datetime, "open_price_delta"] = (open_price / close_price) - 1
        previous_date = current_date

    return df_copy


def calculate_atr(data, atr_period=14):
    """
    Calculate True Range (TR) and Average True Range (ATR).

    Parameters:
        data (pd.DataFrame): The trading data.
        atr_period (int): The period for ATR calculation.

    Returns:
        pd.DataFrame: DataFrame with additional 'TR' and 'ATR' columns.
    """
    data["TR"] = talib.TRANGE(data["high"], data["low"], data["close"])
    data["ATR"] = talib.EMA(data["TR"], timeperiod=atr_period)
    return data


def prepare_exit_levels(data, atr_multiplier):
    """
    Calculate ATR-based exit levels for long and short positions.

    Parameters:
        data (pd.DataFrame): The trading data with ATR calculated.
        atr_multiplier (float): The multiplier for ATR to set exit levels.

    Returns:
        pd.DataFrame: DataFrame with 'long_atr_exit_value' and 'short_atr_exit_value' columns.
    """
    data["long_atr_exit_value"] = data["high"].rolling(window=2).max() - (
        data["ATR"] * atr_multiplier
    )
    data["short_atr_exit_value"] = data["low"].rolling(window=2).min() + (
        data["ATR"] * atr_multiplier
    )
    return data


def load_and_process_data(filepath, start_date="2017-05-16"):
    """
    Load trading data from a CSV file and preprocess it.

    Parameters:
        filepath (str): Path to the CSV file.
        start_date (str): The starting date for the data.

    Returns:
        pd.DataFrame: Preprocessed trading data.
    """
    df = pd.read_csv(filepath)
    df["DateTime"] = pd.to_datetime(
        df["Date"] + " " + df["Time"], format="%Y/%m/%d %H:%M:%S"
    )
    df = df.drop(columns=["Date", "Time"])
    df.set_index("DateTime", inplace=True)
    df = df.rename(
        columns={
            "Close": "close",
            "Open": "open",
            "High": "high",
            "Low": "low",
            "TotalVolume": "volume",
        }
    )
    df = df[df.index &gt;= pd.Timestamp(start_date)]
    return df


def main():
    # === Parameter Configuration ===
    # Toggle this to switch between different parameter sets
    use_first_set = True

    if use_first_set:
        # Parameter Set 1
        close_time = "13:24:00"
        open_time = "00:00:00"
        long_threshold = 0.001
        short_threshold = -0.01
        atr_length = 86
        atr_multiplier = 6.3
        M_values = [1260]  # Example: [1260]
        # M_values = range(100, 1501, 20)  # M 參數範圍
        trading_mode = 2  # 0: Long only, 1: Short only, 2: Both
    else:
        # Parameter Set 2
        close_time = "13:30:00"
        open_time = "00:46:00"
        long_threshold = 0.003
        short_threshold = -0.01
        atr_length = 82
        atr_multiplier = 9.5
        M_values = [-1]  # Example: [3700] or [-1]
        trading_mode = 1  # 0: Long only, 1: Short only, 2: Both

    # === Data Loading and Preprocessing ===
    data_filepath = "./TWF.TXF-HOT-Minute-Trade.txt"
    raw_data = load_and_process_data(data_filepath)
    data_with_change = compute_open_price_change(raw_data, open_time, close_time)
    data_with_change["long_condition"] = (
        data_with_change["open_price_delta"] &gt; long_threshold
    )
    data_with_change["short_condition"] = (
        data_with_change["open_price_delta"] &lt; short_threshold
    )
    data_with_change["Is_Thursday"] = data_with_change.index.weekday == 3
    data_with_change["Is_Open_Time"] = (
        data_with_change.index.time == pd.Timestamp(open_time).time()
    )
    data_with_change["Is_Close_Time"] = (
        data_with_change.index.time == pd.Timestamp(close_time).time()
    )
    data_with_atr = calculate_atr(data_with_change, atr_period=atr_length)
    data_with_exits = prepare_exit_levels(data_with_atr, atr_multiplier)

    # === Initialize Data for Numba ===
    (
        is_thursday,
        is_open_time,
        is_close_time,
        dates,
        timestamps,
        open_prices,
        close_prices,
        high_prices,
        low_prices,
        long_conditions,
        short_conditions,
        long_atr_exit,
        short_atr_exit,
        atr_values,
    ) = initialize_data(data_with_exits)

    # Initialize variables for tracking entries
    entry_timestamps = np.zeros(1, dtype=np.int64)
    highest_price_since_entry = np.zeros(1)
    lowest_price_since_entry = np.zeros(1)

    # === Optimization Loop ===
    best_M = 0
    best_return = -np.inf

    for check_interval_M in M_values:
        try:
            if check_interval_M &gt; 0:
                max_high_M = (
                    data_with_exits["high"]
                    .rolling(window=check_interval_M)
                    .max()
                    .to_numpy()
                )
                min_low_M = (
                    data_with_exits["low"]
                    .rolling(window=check_interval_M)
                    .min()
                    .to_numpy()
                )
            else:
                max_high_M = np.empty(len(data_with_exits))
                min_low_M = np.empty(len(data_with_exits))

            # Create Portfolio using VectorBT
            portfolio = vbt.Portfolio.from_order_func(
                data_with_exits["close"],
                execute_order,
                long_conditions,
                short_conditions,
                open_prices,
                high_prices,
                low_prices,
                entry_timestamps,
                dates,
                timestamps,
                is_thursday,
                is_open_time,
                is_close_time,
                long_atr_exit,
                short_atr_exit,
                atr_values,
                highest_price_since_entry,
                lowest_price_since_entry,
                max_high_M,
                min_low_M,
                check_interval_M,
                trading_mode,
                init_cash=1_000_000,
            )

            # Display Orders
            print(
                portfolio.orders.records_readable.to_markdown(
                    floatfmt=".5f", tablefmt="heavy_grid"
                )
            )

            # Display Portfolio Statistics
            print(portfolio.stats())

            # Calculate Total Return
            total_return = portfolio.total_return()
            if total_return &gt; best_return:
                best_M = check_interval_M
                best_return = total_return

            print(f"check_interval_M={check_interval_M} total return: {total_return}")
        except Exception as e:
            logger.exception(f"Error with M={check_interval_M}: {e}")

    # === Display Best Results ===
    print(f"Best check_interval_M: {best_M}")
    print(f"Best return: {best_return}")


if __name__ == "__main__":
    main()
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../strategy/三心法順勢操作陳族元10年資產翻10倍.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../strategy/張松允投資心法.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../strategy/三心法順勢操作陳族元10年資產翻10倍.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../strategy/張松允投資心法.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
