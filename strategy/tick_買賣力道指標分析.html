<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tick 數據買賣力道指標與橫切面 Quantile 分析 - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="tick-數據買賣力道指標與橫切面-quantile-分析"><a class="header" href="#tick-數據買賣力道指標與橫切面-quantile-分析">Tick 數據買賣力道指標與橫切面 Quantile 分析</a></h1>
<h2 id="一概念說明"><a class="header" href="#一概念說明">一、概念說明</a></h2>
<h3 id="主動買賣的判定"><a class="header" href="#主動買賣的判定">主動買賣的判定</a></h3>
<ul>
<li><strong>主動買（外盤）</strong>：成交價 = 賣一價，代表買方主動掃單</li>
<li><strong>主動賣（內盤）</strong>：成交價 = 買一價，代表賣方主動掃單</li>
</ul>
<hr />
<h2 id="二實際範例"><a class="header" href="#二實際範例">二、實際範例</a></h2>
<p>假設 2025-01-27 這天有 1000 檔股票</p>
<h3 id="步驟-1計算個股買賣力道"><a class="header" href="#步驟-1計算個股買賣力道">步驟 1：計算個股買賣力道</a></h3>
<h4 id="股票-a-2330-台積電"><a class="header" href="#股票-a-2330-台積電">股票 A (2330 台積電)</a></h4>
<pre><code>主動買量：5,000,000 股
主動賣量：3,000,000 股
總成交量：8,000,000 股

買賣力道 = (主動買量 - 主動賣量) / 總成交量
        = (5,000,000 - 3,000,000) / 8,000,000
        = 0.25
</code></pre>
<h4 id="股票-b-2317-鴻海"><a class="header" href="#股票-b-2317-鴻海">股票 B (2317 鴻海)</a></h4>
<pre><code>主動買量：2,000,000 股
主動賣量：4,000,000 股
總成交量：6,000,000 股

買賣力道 = (2,000,000 - 4,000,000) / 6,000,000
        = -0.33
</code></pre>
<hr />
<h3 id="步驟-2橫切面標準化"><a class="header" href="#步驟-2橫切面標準化">步驟 2：橫切面標準化</a></h3>
<p>當天 1000 檔股票的買賣力道分布：</p>
<pre><code>平均值 (μ) = 0.05
標準差 (σ) = 0.15

台積電標準化分數 = (0.25 - 0.05) / 0.15 = 1.33
鴻海標準化分數 = (-0.33 - 0.05) / 0.15 = -2.53
</code></pre>
<p><strong>標準化公式</strong>：</p>
<pre><code>Z-Score = (個股買賣力道 - 當天平均值) / 當天標準差
</code></pre>
<hr />
<h3 id="步驟-3quantile-分組"><a class="header" href="#步驟-3quantile-分組">步驟 3：Quantile 分組</a></h3>
<p>將 1000 檔股票按標準化分數排序後分成 5 組（quintile）：</p>
<div class="table-wrapper"><table><thead><tr><th>分組</th><th>條件</th><th>範圍</th><th>範例</th></tr></thead><tbody>
<tr><td><strong>Q5</strong></td><td>最強 20%</td><td>標準化分數 &gt; 0.84</td><td>台積電 (1.33)</td></tr>
<tr><td><strong>Q4</strong></td><td>次強 20%</td><td>0.25 ~ 0.84</td><td>-</td></tr>
<tr><td><strong>Q3</strong></td><td>中間 20%</td><td>-0.25 ~ 0.25</td><td>-</td></tr>
<tr><td><strong>Q2</strong></td><td>次弱 20%</td><td>-0.84 ~ -0.25</td><td>-</td></tr>
<tr><td><strong>Q1</strong></td><td>最弱 20%</td><td>&lt; -0.84</td><td>鴻海 (-2.53)</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="三python-實作範例"><a class="header" href="#三python-實作範例">三、Python 實作範例</a></h2>
<pre><code class="language-python">import pandas as pd
import numpy as np

# 模擬當天 tick 數據
data = {
    'stock_id': ['2330', '2317', '2454', '2412', '2308'],
    'active_buy': [5000000, 2000000, 1500000, 3000000, 800000],
    'active_sell': [3000000, 4000000, 1200000, 2500000, 1200000],
    'total_volume': [8000000, 6000000, 2700000, 5500000, 2000000]
}

df = pd.DataFrame(data)

# 1. 計算買賣力道
df['buy_sell_pressure'] = (df['active_buy'] - df['active_sell']) / df['total_volume']

# 2. 橫切面標準化
df['pressure_zscore'] = (
    (df['buy_sell_pressure'] - df['buy_sell_pressure'].mean()) 
    / df['buy_sell_pressure'].std()
)

# 3. 分成 5 個 quantile
df['quantile'] = pd.qcut(
    df['pressure_zscore'], 
    q=5, 
    labels=['Q1', 'Q2', 'Q3', 'Q4', 'Q5']
)

print(df)
</code></pre>
<h3 id="輸出結果示例"><a class="header" href="#輸出結果示例">輸出結果示例</a></h3>
<pre><code>  stock_id  active_buy  active_sell  total_volume  buy_sell_pressure  pressure_zscore quantile
0     2330     5000000      3000000       8000000              0.250            1.33       Q5
1     2317     2000000      4000000       6000000             -0.333           -2.53       Q1
2     2454     1500000      1200000       2700000              0.111            0.45       Q4
3     2412     3000000      2500000       5500000              0.091            0.28       Q3
4     2308      800000      1200000       2000000             -0.200           -1.15       Q2
</code></pre>
<hr />
<h2 id="四應用策略"><a class="header" href="#四應用策略">四、應用策略</a></h2>
<h3 id="1-做多策略"><a class="header" href="#1-做多策略">1. 做多策略</a></h3>
<p>每天買入 <strong>Q5 組別</strong>的股票（買盤力道最強）</p>
<h3 id="2-做空策略"><a class="header" href="#2-做空策略">2. 做空策略</a></h3>
<p>每天放空 <strong>Q1 組別</strong>的股票（賣盤力道最強）</p>
<h3 id="3-多空策略"><a class="header" href="#3-多空策略">3. 多空策略</a></h3>
<ul>
<li><strong>做多</strong>：Q5 組別</li>
<li><strong>做空</strong>：Q1 組別</li>
<li>建立市場中性部位</li>
</ul>
<hr />
<h2 id="五策略優勢"><a class="header" href="#五策略優勢">五、策略優勢</a></h2>
<ol>
<li><strong>相對強弱</strong>：每天重新計算橫切面排名，避免絕對值偏誤</li>
<li><strong>捕捉資金流向</strong>：tick 級別數據能反映即時買賣意願</li>
<li><strong>標準化處理</strong>：消除不同股票成交量差異的影響</li>
<li><strong>動態調整</strong>：每日重新分組，適應市場變化</li>
</ol>
<hr />
<h2 id="六注意事項"><a class="header" href="#六注意事項">六、注意事項</a></h2>
<p>⚠️ <strong>重要提醒</strong>：</p>
<ul>
<li>tick 數據需要精確的時間戳和價格匹配</li>
<li>開盤、收盤時段可能有異常波動</li>
<li>需考慮交易成本和滑價</li>
<li>建議搭配其他指標（如成交量、波動率）進行過濾</li>
<li>回測時注意避免前視偏差（look-ahead bias）</li>
</ul>
<hr />
<h2 id="七進階應用"><a class="header" href="#七進階應用">七、進階應用</a></h2>
<h3 id="時間加權買賣力道"><a class="header" href="#時間加權買賣力道">時間加權買賣力道</a></h3>
<pre><code class="language-python"># 給予不同時段不同權重
# 例如：尾盤 30 分鐘權重加倍
df['weighted_pressure'] = df['buy_sell_pressure'] * df['time_weight']
</code></pre>
<h3 id="多日累積指標"><a class="header" href="#多日累積指標">多日累積指標</a></h3>
<pre><code class="language-python"># 計算過去 5 日的買賣力道移動平均
df['pressure_ma5'] = df.groupby('stock_id')['buy_sell_pressure'].rolling(5).mean()
</code></pre>
<h3 id="量價配合過濾"><a class="header" href="#量價配合過濾">量價配合過濾</a></h3>
<pre><code class="language-python"># 只選擇成交量放大且買盤力道強的股票
high_volume = df['total_volume'] &gt; df['total_volume'].quantile(0.7)
strong_buy = df['quantile'] == 'Q5'
final_selection = df[high_volume &amp; strong_buy]
</code></pre>
<hr />
<h2 id="八完整實作範例"><a class="header" href="#八完整實作範例">八、完整實作範例</a></h2>
<pre><code class="language-python">import pandas as pd
import numpy as np
from datetime import datetime, timedelta

class TickPressureAnalyzer:
    """Tick 數據買賣力道分析器"""
    
    def __init__(self, n_quantiles=5):
        self.n_quantiles = n_quantiles
        
    def calculate_pressure(self, df):
        """計算買賣力道"""
        df['buy_sell_pressure'] = (
            (df['active_buy'] - df['active_sell']) / df['total_volume']
        )
        return df
    
    def standardize(self, df, date_col='date'):
        """橫切面標準化"""
        df['pressure_zscore'] = df.groupby(date_col)['buy_sell_pressure'].transform(
            lambda x: (x - x.mean()) / x.std()
        )
        return df
    
    def assign_quantiles(self, df, date_col='date'):
        """分配 quantile 組別"""
        df['quantile'] = df.groupby(date_col)['pressure_zscore'].transform(
            lambda x: pd.qcut(x, q=self.n_quantiles, labels=False, duplicates='drop') + 1
        )
        return df
    
    def analyze(self, df, date_col='date'):
        """完整分析流程"""
        df = self.calculate_pressure(df)
        df = self.standardize(df, date_col)
        df = self.assign_quantiles(df, date_col)
        return df

# 使用範例
if __name__ == "__main__":
    # 模擬多日數據
    dates = pd.date_range('2025-01-20', '2025-01-27', freq='D')
    stocks = ['2330', '2317', '2454', '2412', '2308']
    
    data_list = []
    for date in dates:
        for stock in stocks:
            data_list.append({
                'date': date,
                'stock_id': stock,
                'active_buy': np.random.randint(1000000, 10000000),
                'active_sell': np.random.randint(1000000, 10000000),
                'total_volume': np.random.randint(5000000, 15000000)
            })
    
    df = pd.DataFrame(data_list)
    
    # 執行分析
    analyzer = TickPressureAnalyzer(n_quantiles=5)
    result = analyzer.analyze(df)
    
    # 查看最新一天的結果
    latest_date = result['date'].max()
    latest_result = result[result['date'] == latest_date].sort_values('quantile', ascending=False)
    
    print(f"\n{latest_date.date()} 買賣力道排名：")
    print(latest_result[['stock_id', 'buy_sell_pressure', 'pressure_zscore', 'quantile']])
    
    # 查看 Q5 組別（最強）
    q5_stocks = latest_result[latest_result['quantile'] == 5]['stock_id'].tolist()
    print(f"\nQ5 組別股票（建議做多）：{q5_stocks}")
    
    # 查看 Q1 組別（最弱）
    q1_stocks = latest_result[latest_result['quantile'] == 1]['stock_id'].tolist()
    print(f"Q1 組別股票（建議做空）：{q1_stocks}")
</code></pre>
<hr />
<h2 id="九回測框架"><a class="header" href="#九回測框架">九、回測框架</a></h2>
<pre><code class="language-python">class BacktestEngine:
    """簡單回測引擎"""
    
    def __init__(self, initial_capital=1000000):
        self.initial_capital = initial_capital
        self.positions = {}
        self.equity_curve = []
        
    def run_backtest(self, signals_df, returns_df):
        """
        執行回測
        
        Parameters:
        -----------
        signals_df: DataFrame with columns ['date', 'stock_id', 'quantile']
        returns_df: DataFrame with columns ['date', 'stock_id', 'return']
        """
        dates = sorted(signals_df['date'].unique())
        
        for date in dates:
            # 取得當日訊號
            daily_signals = signals_df[signals_df['date'] == date]
            
            # 做多 Q5、做空 Q1
            long_stocks = daily_signals[daily_signals['quantile'] == 5]['stock_id'].tolist()
            short_stocks = daily_signals[daily_signals['quantile'] == 1]['stock_id'].tolist()
            
            # 計算當日報酬（簡化版本）
            if date in returns_df['date'].values:
                daily_returns = returns_df[returns_df['date'] == date]
                
                long_return = daily_returns[
                    daily_returns['stock_id'].isin(long_stocks)
                ]['return'].mean() if long_stocks else 0
                
                short_return = -daily_returns[
                    daily_returns['stock_id'].isin(short_stocks)
                ]['return'].mean() if short_stocks else 0
                
                total_return = (long_return + short_return) / 2
                
                # 更新權益曲線
                if not self.equity_curve:
                    self.equity_curve.append({
                        'date': date,
                        'equity': self.initial_capital * (1 + total_return)
                    })
                else:
                    last_equity = self.equity_curve[-1]['equity']
                    self.equity_curve.append({
                        'date': date,
                        'equity': last_equity * (1 + total_return)
                    })
        
        return pd.DataFrame(self.equity_curve)
    
    def calculate_metrics(self, equity_df):
        """計算績效指標"""
        equity_df['returns'] = equity_df['equity'].pct_change()
        
        total_return = (equity_df['equity'].iloc[-1] / self.initial_capital - 1) * 100
        sharpe_ratio = equity_df['returns'].mean() / equity_df['returns'].std() * np.sqrt(252)
        max_drawdown = ((equity_df['equity'] / equity_df['equity'].cummax()) - 1).min() * 100
        
        return {
            'Total Return (%)': round(total_return, 2),
            'Sharpe Ratio': round(sharpe_ratio, 2),
            'Max Drawdown (%)': round(max_drawdown, 2),
            'Final Equity': round(equity_df['equity'].iloc[-1], 2)
        }
</code></pre>
<hr />
<h2 id="十參考資源"><a class="header" href="#十參考資源">十、參考資源</a></h2>
<h3 id="相關論文"><a class="header" href="#相關論文">相關論文</a></h3>
<ul>
<li>"Order Flow and Expected Option Returns" - Jesper Rangvid et al.</li>
<li>"High Frequency Trading and Price Discovery" - Albert J. Menkveld</li>
</ul>
<h3 id="數據來源"><a class="header" href="#數據來源">數據來源</a></h3>
<ul>
<li>台灣證券交易所（TWSE）</li>
<li>證券櫃檯買賣中心（TPEx）</li>
<li>各券商提供的 tick 數據 API</li>
</ul>
<h3 id="相關指標"><a class="header" href="#相關指標">相關指標</a></h3>
<ul>
<li>VWAP (Volume Weighted Average Price)</li>
<li>OBV (On Balance Volume)</li>
<li>MFI (Money Flow Index)</li>
<li>Accumulation/Distribution Line</li>
</ul>
<hr />
<p><strong>文件建立時間</strong>：2025-01-27<br />
<strong>版本</strong>：v1.0<br />
<strong>作者</strong>：Claude AI</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../strategy/台股族群輪動篩選整理.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../strategy/10_vectorbt量化回測實戰.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../strategy/台股族群輪動篩選整理.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../strategy/10_vectorbt量化回測實戰.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
