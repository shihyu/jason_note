<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rust OOP ä»‹ç´¹ - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="çµ¦-c-ä½¿ç”¨è€…çš„-rust-ç°¡ä»‹ç‰©ä»¶å°å‘ç¯‡"><a class="header" href="#çµ¦-c-ä½¿ç”¨è€…çš„-rust-ç°¡ä»‹ç‰©ä»¶å°å‘ç¯‡">çµ¦ C++ ä½¿ç”¨è€…çš„ Rust ç°¡ä»‹ï¼šç‰©ä»¶å°å‘ç¯‡</a></h1>
<p>ç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆ (Object-Oriented Programming) ç›®å‰ä»ç„¶æ˜¯æœ€ä¸»æµçš„ç·¨ç¨‹ç¯„å¼ (Programming Paradigm)ï¼Œå› æ­¤ Rust ä¹Ÿæä¾›äº†ç‰©ä»¶å°å‘ç¨‹å¼èªè¨€æœ€æ ¸å¿ƒçš„å¹¾é …åŠŸèƒ½ï¼šå°è£ã€ç¹¼æ‰¿ã€å¤šå‹ã€‚ç„¶è€Œï¼Œåœ¨ Rust ä¸­å®šç¾©æˆå“¡å‡½å¼çš„èªæ³•èˆ‡ C++ æœ‰æ®µå·®è·ï¼Œå®ƒçš„ç‰©ä»¶æ¨¡å‹èˆ‡å¯¦ç¾ç¹¼æ‰¿çš„æ–¹æ³•ä¹Ÿæ˜é¡¯ç•°æ–¼ C++ æˆ–å¤§å¤šæ•¸ä¸»æµçš„ç‰©ä»¶å°å‘ç¨‹å¼èªè¨€ã€‚åœ¨é€™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°‡æœƒè©³ç´°èªªæ˜åœ¨ Rust ä¸­å¯¦ç¾ç‰©ä»¶å°å‘çš„æ–¹æ³•ã€‚</p>
<h2 id="å°è£"><a class="header" href="#å°è£">å°è£</a></h2>
<p>åœ¨ä¹‹å‰æ–‡ç« çš„ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘ç¶“å¸¸ä½¿ç”¨ structï¼Œè®€è€…å¯èƒ½æœƒä»¥ç‚º Rust å°±å¦‚åŒ C++ é‚£èˆ¬ï¼Œæ‰€æœ‰ struct æˆå“¡éƒ½æ˜¯å…¬é–‹çš„ (public)ã€‚ä½†å¯¦éš›ä¸Šï¼ŒRust çš„ struct æˆå“¡åƒ…å°åŒä¸€å€‹æ¨¡çµ„ (module) å…§çš„ç¨‹å¼ç¢¼å…¬é–‹ã€‚è€Œæ‰€è¬‚çš„æ¨¡çµ„ï¼Œå…¶å¯¦å°±æ˜¯ C++ çš„å‘½åç©ºé–“ (namespace)ï¼š</p>
<pre><pre class="playground"><code class="language-rust">mod mylib {
    struct Rational { // æœ‰ç†æ•¸
        num: i32, // åˆ†å­
        den: i32, // åˆ†æ¯
    }

    fn new_rational() -&gt; Rational {
        return Rational { num: 3, den: 5 }; // OK
    }
}

fn main() {
    let r = mylib::Rational { num: 3, den: 5 }; // error: struct `Rational` is private
}</code></pre></pre>
<p><code>mod</code> é—œéµå­—éå¸¸æ¥è¿‘ C++ çš„ <code>namespace</code>ï¼Œå®ƒé™¤äº†ç”¨ä¾†å€åˆ†å‘½åç©ºé–“ä»¥é¿å…æ’åï¼Œé‚„å…·å‚™äº†å°è£çš„åŠŸèƒ½ã€‚åœ¨ <code>mylib</code> ä¸­çš„ç¬¦è™Ÿæ˜¯ä¸å°å¤–é–‹æ”¾çš„ï¼Œåªæœ‰åœ¨åŒä¸€å€‹æ¨¡çµ„ä¸­çš„å‡½å¼æ‰èƒ½ä½¿ç”¨ã€‚</p>
<p>æˆ‘å€‘å¯ä»¥ç”¨ <code>pub</code> é—œéµå­—ä¾†å…¬é–‹ç¬¦è™Ÿï¼š</p>
<pre><pre class="playground"><code class="language-rust">mod mylib {
    pub struct Rational {
        num: i32,
        den: i32,
    }

    pub fn new_rational(num: i32, den: i32) -&gt; Rational {
        return Rational { num: num, den: den };
    }
}

fn main() {
    let r = mylib::new_rational(3, 5); // OK
    println!("fraction number is {}/{}", r.num, r.den);  // éŒ¯èª¤ï¼šnum èˆ‡ den çš†æœªå…¬é–‹
}</code></pre></pre>
<h2 id="æˆå“¡å‡½å¼èˆ‡å»ºæ§‹å¼"><a class="header" href="#æˆå“¡å‡½å¼èˆ‡å»ºæ§‹å¼">æˆå“¡å‡½å¼èˆ‡å»ºæ§‹å¼</a></h2>
<p>ç‰©ä»¶å°å‘ä¸­çš„å°è£åŸå‰‡å‘Šè¨´æˆ‘å€‘ï¼šä½¿ç”¨è€…ä¸éœ€è¦ä¹Ÿä¸æ‡‰è©²å»äº†è§£ç‰©ä»¶å…§éƒ¨çš„å¯¦ä½œç´°ç¯€ï¼Œå› æ­¤å‹åˆ¥çš„è¨­è¨ˆè€…æ‡‰è©²ç¦æ­¢ä½¿ç”¨è€…ç›´æ¥å­˜å–å…§éƒ¨æˆå“¡ï¼Œè€Œæ˜¯è®“ä»–å€‘é€éå…¬é–‹çš„æˆå“¡å‡½å¼é€²è¡Œæ“ä½œã€‚</p>
<p>æˆ‘å€‘å¯ä»¥ç”¨ <code>impl</code> é—œéµå­—ç‚ºæŸå€‹å‹åˆ¥å®šç¾©æˆå“¡å‡½å¼ï¼š</p>
<pre><pre class="playground"><code class="language-rust">mod mylib {
    pub struct Rational {
        num: i32,
        den: i32,
    }

    fn gcd(mut x: i32, mut y: i32) -&gt; i32 {
        // æ±‚å– x èˆ‡ y çš„æœ€å¤§å…¬å› æ•¸ï¼Œé€™è£¡çœç•¥å¯¦ä½œ
        // ...
    }

    impl Rational {
        pub fn new(n: i32, d: i32) -&gt; Self {
            Rational { num: n, den: d }
        }

        pub fn is_integer(&amp;self) -&gt; bool {
            self.den == 1
        }

        pub fn reduce(&amp;mut self) {
            let d = gcd(self.num, self.den);

            self.num /= d;
            self.den /= d;
        }
    }
}

fn main() {
    let r = mylib::Rational::new(3, 5);
}</code></pre></pre>
<p>åªè¦å°ä»»ä½•å‹åˆ¥ä½¿ç”¨ <code>impl</code> å€å¡Šå®šç¾©å‡½å¼ï¼Œé€™äº›å‡½å¼å°±æœƒæˆç‚ºè©²å‹åˆ¥çš„æˆå“¡å‡½å¼[<a href="https://electronic.blue/blog/2017/04/30-rust-an-introduction-in-oop/#fn1">1]</a>ã€‚ä»¥é€™å€‹ä¾‹å­ä¾†èªªï¼Œ<code>Rational</code> å‹åˆ¥å°±æœ‰ä¸‰å€‹æˆå“¡å‡½å¼ï¼š<code>new</code>ã€<code>is_integer</code> èˆ‡ <code>reduce</code>ã€‚è€Œæˆå“¡å‡½å¼çš„ç¬¬ä¸€å€‹åƒæ•¸ï¼Œå‰‡ä»£è¡¨çš„é€™å€‹æˆå“¡å‡½å¼å¦‚ä½•å½±éŸ¿ç‰©ä»¶ï¼š</p>
<ul>
<li>å¦‚æœç¬¬ä¸€å€‹åƒæ•¸æ˜¯ <code>&amp;self</code>ï¼Œè¡¨ç¤ºé€™å€‹æˆå“¡å‡½å¼ä¸æœƒæ”¹è®Šç‰©ä»¶å…§çš„ç‹€æ…‹ï¼Œç›¸ç•¶æ–¼ C++ ä¸­ä»¥ <code>const</code> ä¿®é£¾çš„æˆå“¡å‡½å¼ (const member function)ã€‚<code>self</code> åœ¨ Rust ä¸­ä¹Ÿæ˜¯å€‹é—œéµå­—ï¼Œç›¸ç•¶æ–¼ C++ ä¸­çš„ <code>this</code>ã€‚éœ€æ³¨æ„çš„æ˜¯ï¼Œåœ¨æˆå“¡å‡½å¼ä¸­ä¹Ÿå¿…éœ€é€éç”¨ <code>self</code> æ‰èƒ½å­˜å–ç‰©ä»¶çš„å…¶å®ƒæˆå“¡ã€‚</li>
<li>å¦‚æœç¬¬ä¸€å€‹åƒæ•¸æ˜¯ <code>&amp;mut self</code>ï¼Œè¡¨ç¤ºé€™æ˜¯ä¸€å€‹æœƒä¿®æ”¹ç‰©ä»¶å…§éƒ¨ç‹€æ…‹çš„æˆå“¡å‡½å¼ï¼Œç›¸ç•¶æ–¼ C++ ä¸­æœªä»¥ <code>const</code> ä¿®é£¾çš„ä¸€èˆ¬æˆå“¡å‡½å¼ã€‚</li>
<li>å¦‚æœç¬¬ä¸€å€‹åƒæ•¸ä¸æ˜¯ <code>self</code>ï¼Œè¡¨ç¤ºé€™æ˜¯ä¸€å€‹éœæ…‹æˆå“¡å‡½å¼ (static member function)ã€‚</li>
<li>é™¤äº†ç”¨ <code>self</code> ä»£è¡¨ <code>this</code> ä»¥å¤–ï¼Œä½ é‚„å¯ä»¥ç”¨å¤§å¯«çš„ <code>Self</code> ä¾†ä»£è¡¨é€™äº›æˆå“¡å‡½å¼æ‰€å±¬çš„é¡åˆ¥ï¼Œä»¥é€™å€‹ç¯„ä¾‹ä¾†èªª <code>Self</code> å°±ç­‰æ–¼ <code>Rational</code>ã€‚</li>
</ul>
<p>å¦å¤–ï¼Œåœ¨ Rust ä¸­ç‰©ä»¶çš„å»ºæ§‹å¼[<a href="https://electronic.blue/blog/2017/04/30-rust-an-introduction-in-oop/#fn2">2]</a> (constructor) å…¶å¯¦å°±æ˜¯å›å‚³è©²ç‰©ä»¶çš„éœæ…‹æˆå“¡å‡½å¼ï¼ŒRust ä¸¦æœªè¦å®šå»ºæ§‹å¼è¦å«ä»€éº¼åå­—ï¼Œä¸éå¤§éƒ¨ä»½äººæœƒä¾ç…§æ…£ä¾‹ï¼Œä½¿ç”¨ <code>new</code> é€™å€‹åå­—ç•¶ä½œå»ºæ§‹å¼ã€‚ä¸Šè¿°çš„æˆå“¡å‡½å¼å®šç¾©ï¼Œå¦‚æœç¿»è­¯æˆ C++ æœƒé•·é€™å€‹æ¨£å­ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>namespace mylib {
    class Rational {
    private:
        int32_t num;
        int32_t den;

    public:
        Rational(int32_t n, int32_t d)
            : num(n), den(d)
        { }

        bool is_integer() const {
            return this.den == 1;
        }

        void reduce() {
            auto d = gcd(this.num, this.den);

            this.num /= d;
            this.den /= d;
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<h2 id="ç¹¼æ‰¿èˆ‡å¤šå‹"><a class="header" href="#ç¹¼æ‰¿èˆ‡å¤šå‹">ç¹¼æ‰¿èˆ‡å¤šå‹</a></h2>
<p>èˆ‡å¤§å¤šæ•¸ OOP èªè¨€ä¸åŒçš„æ˜¯ï¼ŒRust ä¸¦æ²’æœ‰ç¹¼æ‰¿çµæ§‹æˆå“¡çš„åŠŸèƒ½ï¼Œä½ æ²’è¾¦æ³•å¦‚åŒ C++ é‚£æ¨£ç›´æ¥è®“æŸå€‹æ–°é¡åˆ¥æ“æœ‰å¦ä¸€å€‹çˆ¶é¡åˆ¥çš„æ‰€æœ‰æˆå“¡[<a href="https://electronic.blue/blog/2017/04/30-rust-an-introduction-in-oop/#fn3">3]</a>ã€‚ç„¶è€Œ Rust å¯ä»¥å®£å‘ŠæŠ½è±¡ä»‹é¢ï¼Œä¸¦ä¸”æŒ‡å®šæŸå€‹å‹åˆ¥å¿…éœ€å¯¦ä½œä»‹é¢ä¸­çš„å‡½å¼ï¼Œé€™é»éå¸¸æ¥è¿‘ Java æˆ– C# è£¡é¢çš„ <code>interface</code>ã€‚</p>
<p>å®£å‘ŠæŠ½è±¡ä»‹é¢çš„æ–¹æ³•ï¼Œæ˜¯ä½¿ç”¨ <code>trait</code> é—œéµå­—ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>trait JsonObject {
    fn to_json(&amp;self) -&gt; String;
}
<span class="boring">}</span></code></pre></pre>
<p>é€™ç›¸ç•¶æ–¼ç”¨ C++ å®£å‘Šä¸€å€‹æŠ½è±¡é¡åˆ¥ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>class JsonObject {
public:
    virtual std::string to_json() const = 0;
};
<span class="boring">}</span></code></pre></pre>
<p>ä½ ä¸èƒ½åœ¨ trait ä¸­å®£å‘Šæˆå“¡è®Šæ•¸ï¼Œæˆ–æ˜¯ç‚ºå‡½å¼æä¾›å¯¦ä½œã€‚Trait çš„ç›®çš„ï¼Œæ˜¯ç‚ºç·¨è­¯å™¨æä¾›é€™å€‹å‹åˆ¥çš„ä»‹é¢è³‡è¨Šï¼Œä¸åŒçš„ struct å¯ä»¥æä¾›ä»‹é¢ç›¸åŒï¼Œä½†å…§å®¹ä¸åŒçš„å¯¦ä½œï¼Œé€™æ¨£åªéœ€è¦æŠ½æ›å¯¦ä½œï¼Œå°±å¯ä»¥é”åˆ°ç¨‹å¼ç¢¼å†åˆ©ç”¨çš„ç›®çš„ã€‚</p>
<p>ä½ å¯ä»¥ç”¨ <code>impl</code> èˆ‡ <code>for</code> é—œéµå­—ï¼Œè®“æŸå€‹å‹åˆ¥å¯¦ä½œ traitï¼š</p>
<pre><pre class="playground"><code class="language-rust">struct Rational {
    num: i32,
    den: i32,
}

impl Rational {
    fn new(n: i32, d: i32) -&gt; Rational {
        Rational { 
            num: n,
            den: d,
        }
    }
}

impl JsonObject for Rational {
    fn to_json(&amp;self) -&gt; String {
        // å› ç‚º JSON æ ¼å¼ä¸­æœ‰è¨±å¤šé›™å¼•è™Ÿï¼Œæˆ‘å€‘å¯ä»¥ç”¨ r#"..."# ä½œç‚ºæ ¼å¼å­—ä¸²çš„å‰å¾Œå¼•è™Ÿ
        // r#"abc"def"ghi"# ç›¸ç•¶æ–¼ "abc\"def\"ghi"
        // å¦å¤–å¤§æ‹¬è™Ÿåœ¨æ ¼å¼å­—ä¸²ä¸­æœ‰ç‰¹æ®Šæ„ç¾©ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ {{ æˆ– }} è¡¨é”å–®ä¸€çš„å¤§æ‹¬è™Ÿ
        format!(r#"{{ "num":{},"den":{} }}"#, self.num, self.den)
    }
}

fn main() {
    let r = Rational::new(3, 5);
    println!("serialized result: {}", r.to_json()); // { "num":3,"den":5 }
}</code></pre></pre>
<p>ç•¶ç„¶ï¼Œä½ å¯ä»¥ç”¨å…¶å®ƒå‹åˆ¥ä¾†å¯¦ä½œ <code>JsonObject</code>ï¼Œå®ƒä»£è¡¨äº†ä»»ä½•å¯ä»¥è¼¸å‡ºæˆ JSON æ ¼å¼çš„å‹åˆ¥ã€‚</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// è¡¨ç¤ºè¤‡æ•¸å‹åˆ¥
struct Complex {
    real: f64,
    imaginary: f64,
}

impl Complex {
    fn new(r: f64, i: f64) -&gt; Complex {
        Complex {
            real: r,
            imaginary: i,
        }
    }
}

impl JsonObject for Complex {
    fn to_json(&amp;self) -&gt; String {
        format!(r#"{{ "real":{},"imaginary":{} }}"#, self.real, self.imaginary)
    }
}
<span class="boring">}</span></code></pre></pre>
<p>ä½ å¯ä»¥ä½¿ç”¨ <code>&amp;JsonObject</code> ä¾†ä»£è¡¨ä¸€å€‹å¯¦ä½œå‡º <code>json()</code> ä»‹é¢çš„ç‰©ä»¶ï¼Œä¸¦ä¸”ä»¥å¤šå‹çš„æ–¹å¼å‘¼å«å®ƒï¼š</p>
<pre><pre class="playground"><code class="language-rust">fn dump_json(obj: &amp;JsonObject) {
    println!("{}", obj.to_json());
}

fn main() {
    let r = Rational::new(5, 7);
    let c = Complex::new(3.0, 4.0);
    dump_json(&amp;r); // { "num":5,"den":7 }
    dump_json(&amp;c); // { "real":3,"imaginary":4 }
}</code></pre></pre>
<p>å› ç‚ºæˆ‘å€‘ä¸çŸ¥é“å…·é«”å‹åˆ¥æ˜¯ä»€éº¼ï¼Œå› æ­¤è™›æ“¬å‡½å¼å‘¼å« (virtual method invocation) åªèƒ½åœ¨æŒ‡å‘æŸç‰©ä»¶çš„æŒ‡æ¨™ä¸Šå¯¦ç¾ï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ <code>dump_json</code> çš„å…©å€‹åƒæ•¸å‹åˆ¥éƒ½æ˜¯ <code>&amp;JsonObject</code>ï¼Œè€Œä¸”åœ¨å‘¼å«æ™‚ï¼Œæˆ‘å€‘å¿…éœ€ç”¨ <code>&amp;</code> ç¬¦è™Ÿå–å¾— <code>r</code> èˆ‡ <code>c</code> çš„ä½å€ã€‚</p>
<p>ä½¿ç”¨åƒè€ƒå°±æœƒå—åˆ°ç”Ÿå‘½é€±æœŸçš„é™åˆ¶ï¼Œè€Œæ”¹ç”¨æ™ºæ…§æŒ‡æ¨™å¯ä»¥çœå»è¨±å¤šéº»ç…©ã€‚Rust çš„æ™ºæ…§æŒ‡æ¨™èˆ‡å¤šå‹æ“ä½œæ­é…è‰¯å¥½ï¼Œå› æ­¤ä½ å¯ä»¥ç”¨ <code>Box&lt;JsonObject&gt;</code> ä¾†æŒ‡å‘ä»»ä½•å¯¦ä½œ <code>JsonObject</code> ä»‹é¢çš„ç‰©ä»¶ã€‚</p>
<pre><pre class="playground"><code class="language-rust">fn dump_json_array(array: &amp;[Box&lt;JsonObject&gt;]) {
    print!("[");
    // ç‚ºäº†æ­£ç¢ºè¼¸å‡º JSON é™£åˆ—ä¸­çš„é€—è™Ÿï¼Œæˆ‘å€‘ä½¿ç”¨ split_first()
    // è‹¥é™£åˆ—åŒ…å«ä¸€å€‹ä»¥ä¸Šçš„å…ƒç´ ï¼Œæœƒå›å‚³ç¬¬ä¸€å€‹å…ƒç´ åŠå‰©ä¸‹çš„ç‰‡æ®µï¼Œå¦å‰‡å‚³å› None
    match array.split_first() {
        Some((first, remain)) =&gt; {
            print!("{}", first.to_json());   // ç¬¬ä¸€å€‹å…ƒç´ å‰ä¸éœ€åŠ é€—è™Ÿ
            for obj in remain.iter() {
                print!(",{}", obj.to_json());// å‰©ä¸‹çš„å…ƒç´ éœ€è¦ä»¥é€—è™Ÿå€éš”
            }
        }
        None =&gt; (), // array ç‚ºç©º
    }
    println!("]");
}

fn main() {
    let mut v: Vec&lt;Box&lt;JsonObject&gt;&gt; = Vec::new();
    v.push(Box::new(Rational::new(5, 7)));
    v.push(Box::new(Complex::new(3.0, 4.0)));
    dump_json_array(&amp;v);
}</code></pre></pre>
<p>æ³¨æ„åœ¨å…©å€‹ <code>push</code> æ“ä½œä¸­ï¼Œæˆ‘å€‘å¯¦éš›ä¸Šæ¨äº†å…©å€‹ä¸åŒå‹åˆ¥çš„å…ƒç´ é€²å»ï¼Œä½†å› ç‚º <code>Rational</code> èˆ‡ <code>Complex</code> éƒ½æ˜¯ <code>JsonObject</code> çš„å­å‹åˆ¥ï¼Œå› æ­¤ <code>Box&lt;Rational&gt;</code> èˆ‡ <code>Box&lt;Complex&gt;</code> å¯ä»¥å®‰å…¨åœ°è½‰å‹æˆ <code>Box&lt;JsonObject&gt;</code>ï¼Œä¸¦ä¸”æ”¾é€²åŒä¸€å€‹å®¹å™¨ä¸­ã€‚ç•¶ç„¶ï¼Œå› ç‚ºæˆ‘å€‘æ¨äº†å…©å€‹ä¸åŒå‹åˆ¥çš„å…ƒç´ ï¼Œå°è‡´ Rust ç„¡æ³•æ­£ç¢ºæ¨å°å‡º <code>Vec</code> å®¹å™¨çš„å‹åˆ¥ï¼Œå› æ­¤æˆ‘å€‘åœ¨å®£å‘Šæ™‚å¿…éœ€æ˜ç¢ºæŒ‡å‡º <code>v</code> çš„å‹åˆ¥æ˜¯ <code>Vec&lt;Box&lt;JsonObject&gt;&gt;</code>ã€‚</p>
<h2 id="æ“´å……åŸºæœ¬å‹åˆ¥"><a class="header" href="#æ“´å……åŸºæœ¬å‹åˆ¥">æ“´å……åŸºæœ¬å‹åˆ¥</a></h2>
<p>Rust çš„åŸºæœ¬å‹åˆ¥èˆ‡è‡ªè¨‚å‹åˆ¥åœ°ä½ç›¸åŒï¼Œä½ ä¹Ÿå¯ä»¥æ›¿åŸºæœ¬å‹åˆ¥å®šç¾©æˆå“¡å‡½å¼ï¼Œç”šè‡³è®“ä»–å¯¦ä½œæŸå€‹ traitã€‚æ¯”å¦‚èªªï¼Œæˆ‘å€‘å¯ä»¥è®“æœ€å¸¸è¦‹çš„ <code>i32</code> å¯¦ä½œ <code>JsonObject</code>ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl JsonObject for i32 {
    fn to_json(&amp;self) -&gt; String {
        self.to_string()
    }
}
<span class="boring">}</span></code></pre></pre>
<p>æˆ–æ˜¯è®“å…§å»ºçš„ <code>String</code> å‹åˆ¥ä¹Ÿå¯¦ä½œ <code>JsonObject</code>ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl JsonObject for String {
    fn to_json(&amp;self) -&gt; String {
        // ç‚ºå­—ä¸²å‰å¾ŒåŠ ä¸Šé›™å¼•è™Ÿï¼Œä¸¦åŠ ä¸Šè·³è„«å­—å…ƒ
        format!("\"{}\"", self.replace("\\", "\\\\").replace("\"", "\\\""))
    }
}
<span class="boring">}</span></code></pre></pre>
<p>é€™æ„å‘³ <code>Box&lt;i32&gt;</code> èˆ‡ <code>Box&lt;String&gt;</code> å¯ä»¥å®‰å…¨åœ°è½‰å‹ç‚º <code>Box&lt;JsonObject&gt;</code>ï¼š</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let mut v: Vec&lt;Box&lt;JsonObject&gt;&gt; = Vec::new();
    v.push(Box::new(1));
    v.push(Box::new(2));
    v.push(Box::new("hello".to_string()));
    v.push(Box::new("world".to_string()));
    dump_json_array(&amp;v); // [1,2,"hello","world"]
}</code></pre></pre>
<p>ç‚ºæŸå€‹å…·é«”å‹åˆ¥å¯¦ä½œ trait æœ‰ä¸€å€‹é™åˆ¶ï¼šç‚ºäº†é¿å…å¤šå€‹å¯¦ä½œäº’ç›¸è¡çªï¼Œå¯¦ä½œ trait çš„ <code>impl</code> å€å¡Šå¿…éœ€èˆ‡ trait æˆ–æ˜¯å…·é«”å‹åˆ¥æ“ºåœ¨åŒä¸€å€‹å‡½å¼åº« (Rust ç¨±ä¹‹ç‚º <em>crate</em>) ç•¶ä¸­ã€‚ç°¡è€Œè¨€ä¹‹ï¼š</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left"></th><th style="text-align: left">ä½ å¯«çš„ trait</th><th style="text-align: left">åˆ¥äººå¯«çš„ trait</th></tr></thead><tbody>
<tr><td style="text-align: left">ä½ å¯«çš„å‹åˆ¥</td><td style="text-align: left">ğŸ‘Œ</td><td style="text-align: left">ğŸ‘Œ</td></tr>
<tr><td style="text-align: left">åˆ¥äººå¯«çš„å‹åˆ¥</td><td style="text-align: left">ğŸ‘Œ</td><td style="text-align: left">â›”</td></tr>
</tbody></table>
</div>
<h2 id="trait-çš„å¯¦ä½œ"><a class="header" href="#trait-çš„å¯¦ä½œ">Trait çš„å¯¦ä½œ</a></h2>
<p>Rust å…è¨±æˆ‘å€‘æ“´å……æ‰€æœ‰å·²å­˜åœ¨çš„å‹åˆ¥ï¼Œè®“å®ƒå€‘å¯ä»¥å¯¦ä½œå‡ºæ–°çš„ç•Œé¢ï¼Œé€™é»å°ç†Ÿæ‚‰ C++ çš„è®€è€…ä¾†èªªé —ç‚ºç¥ç§˜ï¼šç‚ºäº†é”æˆå¤šå‹ï¼Œç‰©ä»¶ä¸­å¿…éœ€æœ‰é¡å¤–æ¬„ä½æŒ‡å‘è™›æ“¬å‡½å¼è¡¨ (vtable)ï¼Œæ‰èƒ½åœ¨åŸ·è¡Œæ™‚æœŸå°‡åŒåçš„å‡½å¼å‘¼å«åˆ†æ´¾åˆ°ä¸åŒé¡åˆ¥çš„å¯¦ä½œç•¶ä¸­ï¼Œå¦‚ä¸‹åœ–ï¼š</p>
<p><img src="images/cppobj.svg" alt="" />
C++ ç‰©ä»¶æœ‰é¡å¤–æ¬„ä½æŒ‡å‘è™›æ“¬å‡½å¼è¡¨</p>
<p>åœ¨ C++ ä¸­ï¼Œç”±æ–¼è™›æ“¬å‡½å¼è¡¨çš„ä½å€å›ºå®šå„²å­˜åœ¨ç‰©ä»¶å¯¦é«”ä¸Šï¼Œå› æ­¤æ²’æœ‰é ç•™é€™å€‹ç©ºé–“çš„å…§å»ºå‹åˆ¥ï¼Œè‡ªç„¶å°±æ²’è¾¦æ³•æ·»åŠ ä»»ä½•è™›æ“¬æˆå“¡å‡½å¼ã€‚è€Œå…¶å®ƒçš„é¡åˆ¥é›–ç„¶å¯ä»¥é€éå¤šé‡ç¹¼æ‰¿çš„æ–¹å¼ç‚ºå…¶æ·»åŠ ç•Œé¢ï¼Œä½†å¿…ç„¶è¦ä¿®æ”¹æ—¢æœ‰çš„ç¨‹å¼ç¢¼ã€‚</p>
<p>Rust é›–ç„¶ä¹Ÿæœ‰è™›æ“¬å‡½å¼è¡¨ï¼Œä½†ä¸¦ä¸æŠŠå®ƒçš„ä½å€å„²å­˜åœ¨ç‰©ä»¶ä¸­ï¼Œè€Œæ˜¯æŠŠå®ƒèˆ‡ trait åƒè€ƒæ”¾åœ¨ä¸€èµ·ï¼Œå¦‚ä¸‹åœ–ï¼š</p>
<p><img src="images/rustobj.svg" alt="" />
Rust çš„ trait åƒè€ƒçµæ§‹</p>
<p>å¾é€™å¼µåœ–å¯ä»¥çœ‹å‡ºï¼Œä»»ä½•æŒ‡å‘ trait çš„åƒè€ƒï¼Œå…¶å¯¦æœƒä½”ç”¨å…©å€‹æŒ‡æ¨™ï¼Œå…¶ä¸­ä¸€å€‹æŒ‡å‘ç‰©ä»¶å¯¦é«”ï¼Œå¦ä¸€å€‹æŒ‡å‘è™›æ“¬å‡½å¼è¡¨ã€‚é€™æ¨£çš„ä½œæ³•é›–ç„¶æœƒå¢åŠ è¨˜æ†¶é«”ä½¿ç”¨é‡ï¼Œä½†æ›ä¾†äº†æ¥µä½³çš„å½ˆæ€§ã€‚å³ä½¿æ˜¯å…¶ä»–äººè£½ä½œçš„å‹åˆ¥ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªç”±æ“´å……å®ƒã€‚</p>
<p>Trait åœ¨æ³›å‹ç¨‹å¼è¨­è¨ˆ (generic programming) ä¸­ä¹Ÿæ‰®æ¼”é‡è¦è§’è‰²ï¼Œæˆ‘æœƒåœ¨å¾ŒçºŒçš„æ–‡ç« ä¸­è©³ç´°ä»‹ç´¹ã€‚</p>
<h2 id="è§£æ§‹å¼"><a class="header" href="#è§£æ§‹å¼">è§£æ§‹å¼</a></h2>
<p>ä½ å¯ä»¥å¯¦ä½œ <code>Drop</code> traitï¼Œé€™éº¼ä¸€ä¾†å‹åˆ¥å°±æœ‰äº†è§£æ§‹å¼ï¼Œå…è¨±ä½ ä½¿ç”¨ C++ ä¸­å¸¸è¦‹çš„ RAII æ‰‹æ®µç®¡ç†è³‡æºã€‚</p>
<pre><pre class="playground"><code class="language-rust">struct DatabaseSession {
    connection: i32, // connection ä»£è¡¨åº•å±¤çš„è³‡æº
}

impl DatabaseSession {
    fn new() -&gt; Self {
        DatabaseSession {
            connection: connect(/* ... */), // é€£æ¥ server
        }
    }

    fn do_something(&amp;self) {
        // ...
    }
}

impl Drop for DatabaseSession {
    fn drop(&amp;mut self) {
        disconnect(self.connection); // é—œé–‰é€£ç·š
    }
}

fn main() {
    let session = DatabaseSession::new();
    session.do_something();
    // ...
    // session é›¢é–‹ scope æ™‚æœƒè‡ªå‹•å‘¼å« drop() é‡‹æ”¾è³‡æº
}</code></pre></pre>
<p>æ‰€æœ‰å¯¦ä½œ <code>Drop</code> trait çš„ç‰©ä»¶åœ¨ç”Ÿå‘½é€±æœŸçµæŸæ™‚ï¼Œç·¨è­¯å™¨æœƒè‡ªå‹•ç‚ºå®ƒå‘¼å« <code>drop()</code> ä»¥é‡‹æ”¾è³‡æºã€‚ç•¶ç„¶ï¼Œå³ä½¿ä½ æ²’æœ‰å¯¦ä½œ <code>Drop</code>ï¼Œä½†ç‰©ä»¶ä¸­åŒ…å«äº†å¯¦ä½œ <code>Drop</code> çš„æˆå“¡ï¼Œé‚£éº¼ç•¶ç‰©ä»¶çš„ç”Ÿå‘½é€±æœŸçµæŸæ™‚ï¼Œç·¨è­¯å™¨ä¹Ÿæœƒè‡ªå‹•åœ°å‘¼å«é€™äº›æˆå“¡çš„è§£æ§‹å¼ã€‚</p>
<p>åœ¨ C++ ä¸­ï¼Œåªè¦ä½ å¿ƒè‡Ÿå¤ å¤§é¡†ï¼Œå¯ä»¥ç›´æ¥å‘¼å«ç‰©ä»¶çš„è§£æ§‹å¼ï¼Œåªæ˜¯ä½ å¾—è‡ªè¡Œé¿å…ç‰©ä»¶åœ¨è§£æ§‹å¾Œåˆè¢«æ‹¿ä¾†ç”¨ï¼Œæˆ–æ˜¯å‡ºç¾é‡è¦†è§£æ§‹çš„æƒ…æ³ã€‚åœ¨ Rust ä¸­ä½ ä¹Ÿå¯ä»¥æ‰‹å‹•å‘¼å« <code>drop</code> ä¾†è§£æ§‹ç‰©ä»¶ï¼Œä½†ç·¨è­¯å™¨çŸ¥é“ä½ è§£æ§‹äº†ç‰©ä»¶ï¼Œå› æ­¤æœƒé˜»æ­¢ä½ åšå‡ºå±éšªè¡Œç‚ºã€‚</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let session = DatabaseSession::new();
    // ...
    drop(session);          // è§£æ§‹ session ç‰©ä»¶ï¼Œé‡‹æ”¾å…¶è³‡æº

    session.do_something(); // éŒ¯èª¤ï¼šsession å·²è§£æ§‹
    drop(session);          // éŒ¯èª¤ï¼šsession å·²è§£æ§‹
                            // å‡½å¼çµæŸæ™‚ä¸æœƒå†å‘¼å« session çš„è§£æ§‹å¼
}</code></pre></pre>
<h2 id="move-semantics"><a class="header" href="#move-semantics">Move Semantics</a></h2>
<p>åœ¨ C++ ä¸­æœ‰æ‰€è¬‚çš„ã€Œä¸‰ä½ä¸€é«”åŸå‰‡ã€(rule of three) æˆ–ã€Œäº”ä½ä¸€é«”åŸå‰‡ã€(rule of five)ï¼Œæ„æ€æ˜¯å¦‚æœæŸå€‹é¡åˆ¥å®šç¾©ç­è§£æ§‹å¼ï¼Œé‚£éº¼ä¸€å®šä¹Ÿè¦å®šç¾©å‡ºè¤‡è£½å»ºæ§‹å¼ (copy constructor) ä¸¦è¦†è¼‰ç­‰è™Ÿè³¦å€¼ (copy assignment)ï¼Œå¦å‰‡é€™å€‹ç‰©ä»¶å¾ˆå®¹æ˜“å› ç‚ºè¤‡è£½å‡ºæš«æ™‚ç‰©ä»¶ï¼Œè€Œå°è‡´è§£æ§‹å¼é‡è¦†é‡‹æ”¾äº†å…§éƒ¨è³‡æºã€‚</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>class DatabaseSession {
private:
    int connection;

public:
    DatabaseSession()
        : connection( connect(/* ... */) ) // é€£æ¥ server
    {}

    ~DatabaseSession() {
        disconnect(connection); // ä¸­æ–·é€£ç·š
    }
}

int main() {
    auto session = DatabaseSession();
    auto another = session; // å…§éƒ¨çš„ connection è¢«è¤‡è£½äº†

    return 0;
    // main çµæŸæ™‚ï¼Œsession èˆ‡ another è¢«è§£æ§‹ï¼Œå°è‡´åŒä¸€å€‹ connection è¢«é‡è¦†é—œé–‰
}
<span class="boring">}</span></code></pre></pre>
<p>Rust æ²’æœ‰é€™æ¨£çš„è¦å‰‡ã€‚åœ¨é è¨­æƒ…æ³ä¸‹ï¼ŒåŒ…æ‹¬ struct åœ¨å…§çš„æ‰€æœ‰è‡ªè¨‚å‹åˆ¥éƒ½å…·å‚™ move semanticsï¼Œå› æ­¤ä½¿ç”¨ç­‰è™Ÿè³¦å€¼ï¼Œæˆ–æ˜¯ç”¨ by-value æ–¹å¼å‚³éåˆ°å‡½å¼å…§ï¼Œéƒ½æœƒå°è‡´æ‰€æœ‰æ¬Šè½‰ç§»ã€‚åªè¦è®Šæ•¸å¤±å»äº†æ‰€æœ‰æ¬Šï¼Œåœ¨å®ƒç”Ÿå‘½é€±æœŸçµæŸæ™‚å°±ä¸æœƒå‘¼å«è§£æ§‹å¼ï¼Œå¾è€Œé¿å…é‡è¦†é‡‹æ”¾è³‡æºçš„å•é¡Œã€‚</p>
<pre><pre class="playground"><code class="language-rust">fn main() {
    let s1 = DatabaseSession::new();
    // ...
    let s2 = s1;        // æ‰€æœ‰æ¬Šè½‰ç§»è‡³ s2 èº«ä¸Š
    s1.do_something();  // éŒ¯èª¤ï¼šs1 å·²å¤±å»æ‰€æœ‰æ¬Š

    foo(s2);            // s2 æ‰€æœ‰æ¬Šè½‰ç§»åˆ°å‡½å¼ä¸­
                        // å‡½å¼çµæŸæ™‚ï¼Œs2 æ‰€æ“æœ‰çš„è³‡æºå·²è¢«é‡‹æ”¾

                        // main çµæŸæ™‚ï¼Œä¸æœƒå‘¼å« s1 èˆ‡ s2 çš„è§£æ§‹å¼
}

// çœ‹èµ·ä¾† session æ˜¯ call-by-valueï¼Œä½†å…¶å¯¦æ‡‰è©²å« call-by-move
// å› ç‚ºå‘¼å«ç«¯çš„æ‰€æœ‰æ¬Šå‚³é€²äº†é€™å€‹å‡½å¼
fn foo(session: DatabaseSession) {
    session.do_something();
    // é›¢é–‹å‡½å¼æ™‚æœƒè§£æ§‹ session
}</code></pre></pre>
<p>å¦‚æœä½ è‡ªå·±è¨­è¨ˆäº†æŸäº›æ–¹æ³•ä¾†è¤‡è£½è³‡æºï¼Œæ¯”å¦‚èªªé¡å¤–å†å¢åŠ ä¸€å€‹é€£å¾€ç›¸åŒ server çš„é€£ç·šï¼ŒRust çš„æ…£ä¾‹æ˜¯å¯¦ä½œ <code>Clone</code> traitï¼š</p>
<pre><pre class="playground"><code class="language-rust">impl Clone for DatabaseSession {
    fn clone(&amp;self) -&gt; Self {
        let addr = get_server_info(self.connection);
        return DatabaseSession {
            connection: connect(addr), // å¢åŠ ä¸€å€‹é€£å¾€ç›¸åŒç›®æ¨™çš„é€£ç·š
        };
    }
}

fn main() {
    let s1 = DatabaseSession::new();
    // ...
    let s2 = s1.clone();    // s2 æ˜¯æ–°é€£ç·š
    s1.do_something();      // s1 ä»ç„¶å¯ç”¨

    // s1 èˆ‡ s2 æ˜¯ä¸åŒé€£ç·šï¼Œéƒ½æœƒè¢«è§£æ§‹å¼é‡‹æ”¾
}</code></pre></pre>
<p>æœ‰äº›å‹åˆ¥çš„æˆå“¡éƒ½æ˜¯å–®ç´”è³‡æ–™ (POD, plain old data)ï¼Œå¯¦ä½œ <code>Clone</code> æ™‚ä¹Ÿéƒ½åªæœ‰å–®ç´”çš„æ¬„ä½è¤‡è£½ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ <code>#[derive(Clone)]</code> è®“ç·¨è­¯å™¨è‡ªå‹•å¹«æˆ‘å€‘å¯¦ä½œå‡ºé€æ¬„ä½è¤‡è£½çš„ <code>clone()</code>ï¼š</p>
<pre><code class="language-v">#[derive(Clone)]
struct Rational {
    num: i32,
    den: i32,
}

fn main()
{
    let r1 = Rational::new(5, 3);
    let r2 = r1.clone();    // r2 ç›´æ¥è¤‡è£½ r1 çš„æ‰€æœ‰æˆå“¡
    let r3 = r1;            // è½‰ç§» r1 æ‰€æœ‰æ¬Šåˆ° r3 èº«ä¸Š
}
</code></pre>
<p><code>Clone</code> trait ä»ç„¶æœƒä¿ç•™ move semanticsï¼Œå› æ­¤ä½¿ç”¨ç­‰è™Ÿç›´æ¥è³¦å€¼æ™‚ä»ç„¶æœƒå°è‡´æ‰€æœ‰æ¬Šè½‰ç§»ã€‚å¦‚æœæˆ‘å€‘æƒ³è¡¨é”å‹åˆ¥å®Œå…¨å°±æ˜¯ PODï¼Œå¯ä»¥ç›´æ¥ç”¨ç­‰è™Ÿç›´æ¥è¤‡è£½å…¶å…§å®¹ï¼Œè€Œä¸éœ€è¦è½‰ç§»æ‰€æœ‰æ¬Šï¼Œåªè¦å†åŠ ä¸Š <code>Copy</code> trait å³å¯ï¼š</p>
<pre><code class="language-v">#[derive(Copy,Clone)]
struct Rational {
    num: i32,
    den: i32,
}

fn main() {
    let mut r1 = Rational::new(/* ... */);
    let r2 = r1;    // r2 è¤‡è£½ r1 çš„å…§å®¹
    r1.reduce();    // é‚„æ˜¯å¯ä»¥ç¹¼çºŒä½¿ç”¨ r1
    foo(r1);        // ä»¥ call-by-value çš„æ–¹å¼å‘¼å«
}

fn foo(r: Rational) {
    // ...
}
</code></pre>
<p><code>Copy</code> çš„æ„æ€æ˜¯è©²å‹åˆ¥é‡åˆ°ç­‰è™Ÿè³¦å€¼æˆ– call-by-value çš„å‡½å¼å‚³éæ™‚ï¼Œæœƒç›´æ¥å‘¼å« <code>clone()</code> å‰µé€ å‡ºè¤‡æœ¬ï¼Œå› æ­¤ <code>Copy</code> æ˜¯ <code>Clone</code> çš„å­é›†åˆï¼Œå¯¦ä½œ <code>Copy</code> çš„å‹åˆ¥ä¸€å®šè¦å¯¦ä½œ <code>Clone</code>ã€‚</p>
<h2 id="é‹ç®—å­è¤‡è¼‰-operator-overloading"><a class="header" href="#é‹ç®—å­è¤‡è¼‰-operator-overloading">é‹ç®—å­è¤‡è¼‰ (Operator Overloading)</a></h2>
<p><code>Copy</code> èˆ‡ <code>Clone</code> å…¶å¯¦å°±ç›¸ç•¶æ–¼ C++ ä¸­è¦†è¼‰ (overload) ç­‰è™Ÿè³¦å€¼çš„è¡Œç‚ºã€‚é‚£éº¼ Rust å¯ä»¥è¦†è¼‰å…¶å®ƒçš„é‹ç®—å­å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè€Œä¸”ä¹Ÿæ˜¯é€é traitã€‚</p>
<p>æ¯”å¦‚èªªï¼Œå¯¦ä½œ <code>Add</code> traitï¼Œæˆ‘å€‘çš„å‹åˆ¥å°±å¯ä»¥é€éåŠ è™Ÿé€²è¡Œé‹ç®—ï¼š</p>
<pre><pre class="playground"><code class="language-rust">use std::ops::Add;

impl Add for Rational {
    type Output = Self; // ç›¸ç•¶æ–¼ typedef Rational Output
    fn add(self, rhs: Self) -&gt; Self {
        Self { // é€šåˆ†ç›¸åŠ 
            num: self.num * rhs.den + self.den * rhs.num,
            den: self.den * rhs.den,
        }
    }
}

fn main() {
    let r1 = Rational::new(1, 2);
    let r2 = Rational::new(1, 3);
    let r3 = r1 + r2; // r3 = { num: 5, den: 6 }
}</code></pre></pre>
<p>åœ¨ <code>impl</code> å€å¡Šä¸­ï¼Œæˆ‘å€‘é™¤äº†å®šç¾© <code>Rational</code> çš„åŠ æ³•å¤–ï¼Œé‚„å®šç¾©äº† <code>Output</code> é€™å€‹å‹åˆ¥ï¼Œä»£è¡¨åŠ æ³•çš„è¼¸å‡ºå‹åˆ¥ã€‚å„˜ç®¡é€™å€‹ trait çš„æˆå“¡å‡½å¼ <code>add()</code> çš„å›å‚³å‹åˆ¥å·²ç¶“èªªæ˜ç­ <code>Rational</code> ç›¸åŠ çš„çµæœä»ç„¶æ˜¯ç›¸åŒçš„ <code>Rational</code>ï¼Œå› æ­¤é€™é‚Šå®šç¾© <code>Output</code> ä¼¼ä¹æœ‰é»å¤šæ­¤ä¸€èˆ‰ï¼Œä½†æˆ‘å€‘ç­‰ä¸€ä¸‹å°±æœƒçœ‹åˆ°å®ƒçš„ç”¨è™•ã€‚</p>
<p>ç•¶ç„¶ï¼Œæˆ‘å€‘å¯ä»¥è®“ <code>Rational</code> èˆ‡å…¶å®ƒå‹åˆ¥ç›¸åŠ ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Add&lt;Complex&gt; for Rational {
    type Output = Complex;
    fn add(self, rhs: Complex) -&gt; Complex {
        // è½‰æˆæµ®é»æ•¸å¾Œç›¸åŠ 
        let f = (self.num as f64) / (self.den as f64);
        return Complex {
            real: f + rhs.real,
            imaginary: rhs.imaginary,
        };
    }
}
<span class="boring">}</span></code></pre></pre>
<p>ç•¶ä¸åŒçš„å‹åˆ¥å¯ä»¥é€éé‹ç®—å­è¦†è¼‰é€²è¡Œæ“ä½œæ™‚ï¼Œå¾€å¾€æœƒè®“æˆ‘å€‘æä¸æ¸…æ¥šè¼¸å‡ºå‹åˆ¥ï¼Œè€Œé›£ä»¥åœ¨å¿…è¦çš„åœ°æ–¹æ¨™ç¤ºå‹åˆ¥ã€‚æ¯”å¦‚èªªæˆ‘å€‘å¯«äº†ä¸€å€‹å‡½å¼æŠŠè¨±å¤š <code>Rational</code> èˆ‡ <code>Complex</code> åŠ èµ·ä¾†ï¼š</p>
<pre><code class="language-v">fn sum_all(ra: &amp;[Rational], ca: &amp;[Complex]) -&gt; ? {
    // ...
}
</code></pre>
<p>æˆ‘å€‘çŸ¥é“é€™å…©å€‹å‹åˆ¥å¯ä»¥ç›¸åŠ ï¼Œä½†ç›¸åŠ å¾Œçš„å‹åˆ¥åˆæ˜¯ä»€éº¼ï¼Ÿç•¶ç„¶æˆ‘å€‘å¯ä»¥ç¿»é–±æ–‡ä»¶å¾Œå¡«ä¸€å€‹æ­£ç¢ºçš„å‹åˆ¥ä¸Šå»ï¼Œä½†å¦‚æœæœªä¾†è¼¸å‡ºå‹åˆ¥æœ‰æ›´æ”¹ï¼Œé‚£éº¼é€™æ®µå‡½å¼å®šç¾©ä¹Ÿå¾—è·Ÿè‘—æ”¹æ‰è¡Œã€‚æ‰€å¹¸ï¼Œ<code>Add</code> trait ä¸­çš„ <code>Output</code> å¯ä»¥å¹«æˆ‘å€‘è§£æ±ºé€™å€‹å•é¡Œï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn sum_all(ra: &amp;[Rational], ca: &amp;[Complex]) -&gt; &lt;Rational as Add&lt;Complex&gt;&gt;::Output {
    // ...
}
<span class="boring">}</span></code></pre></pre>
<p>å›å‚³å‹åˆ¥çœ‹èµ·ä¾†å¾ˆè¤‡é›œï¼Œå®ƒæƒ³è¡¨é”çš„æ˜¯ã€Œåœ¨ <code>Rational</code> å° <code>Add&lt;Complex&gt;</code> çš„å¯¦ä½œä¸­ï¼Œæ‰€å®šç¾©çš„ <code>Output</code> å‹åˆ¥ã€ã€‚å› æ­¤ï¼Œç·¨è­¯å™¨æœƒæŠ“å‡ºå°æ‡‰çš„ <code>impl</code> å€å¡Šï¼Œæ‰¾åˆ°è£¡é¢çš„ <code>Output</code> ä½œç‚ºé€™å€‹å‡½å¼çš„å›å‚³å‹åˆ¥ã€‚</p>
<p>å„˜ç®¡é‹ç®—å­è¦†è¼‰æ˜¯å€‹å¤§å®¶çˆ­è«–ä¸ä¼‘çš„èªè¨€åŠŸèƒ½ï¼Œä½†å®ƒåœ¨æ³›å‹ç¨‹å¼è¨­è¨ˆä¸­ç¢ºå¯¦ä½”äº†é‡è¦åœ°ä½ï¼Œæœ‰èˆˆè¶£çš„è®€è€…å¯ä»¥åƒè€ƒ <a href="https://doc.rust-lang.org/std/ops/index.html"><code>std::ops</code></a> çš„æ–‡ä»¶ï¼Œä¸Šé¢åˆ—å‡ºä½ å¯ä»¥è¦†è¼‰çš„é‹ç®—å­ã€‚å¹¸é‹çš„æ˜¯ï¼ŒC++ ä¸­é‚ªæƒ¡çš„é€—è™Ÿ (<code>,</code>) èˆ‡é‚è¼¯é‹ç®— (<code>&amp;&amp;</code> èˆ‡ <code>||</code>) ä¸¦ä¸åœ¨å…¶ä¸­ã€‚[<a href="https://electronic.blue/blog/2017/04/30-rust-an-introduction-in-oop/#fn4">4]</a></p>
<h2 id="çµèª"><a class="header" href="#çµèª">çµèª</a></h2>
<p>æœ¬æ–‡ä»‹ç´¹äº†åœ¨ Rust ä¸­å¯¦ç¾ç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆçš„æ–¹æ³•ã€‚Rust å¼•å…¥äº† traitã€ç¦æ­¢é¡åˆ¥ç¹¼æ‰¿ã€åˆè®“è‡ªè¨‚å‹åˆ¥æ“æœ‰ move semanticsï¼Œæ˜¯èˆ‡ C++ ç›¸ç•¶ä¸åŒçš„è¨­è¨ˆã€‚ç„¶è€Œåœ¨ RAII èˆ‡é‹ç®—å­è¦†è¼‰ä¸Šï¼Œåˆå¯ä»¥è™•è™•çœ‹è¦‹ C++ çš„å½±å­ã€‚</p>
<p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æœƒä»‹ç´¹å¦ä¸€ç¨®é‡è¦çš„è‡ªè¨‚å‹åˆ¥ï¼šåˆ—èˆ‰ (enum)ï¼Œä»¥åŠæ­é…å®ƒçš„æ¨£å¼æ¯”å° (pattern matching)ã€‚</p>
<hr />
<ol>
<li>Rust ä½¿ç”¨ method é€™å€‹ OOP ä¸­çš„ä¸»æµç”¨èªä¾†è¡¨é”æˆå“¡å‡½å¼ (member function)ï¼Œä¸éé€™ç¯‡æ–‡ç« çš„ä¸»è¦å°è±¡æ˜¯ C++ ä½¿ç”¨è€…ï¼Œå› æ­¤æˆ‘æœƒç¹¼çºŒä½¿ç”¨ã€Œæˆå“¡å‡½å¼ã€ã€‚ <a href="https://electronic.blue/blog/2017/04/30-rust-an-introduction-in-oop/#fnref1">â†©</a></li>
<li>Constructor é€™å€‹å­—çœ¼åœ¨ functional programming ä¸­å…·æœ‰ä¸åŒçš„å«ç¾©ï¼Œæœ¬ç¯‡æ–‡ç« ä¸­çš„ constructor æ„æŒ‡åœ¨ OOP èªè¨€ä¸­ï¼Œç”¨ä¾†åˆå§‹åŒ–ç‰©ä»¶çš„å‡½å¼ã€‚ <a href="https://electronic.blue/blog/2017/04/30-rust-an-introduction-in-oop/#fnref2">â†©</a></li>
<li>Rust é¼“å‹µä½ ç”¨çµ„åˆ (composition) ä»£æ›¿ç¹¼æ‰¿ï¼Œä½†ä½ ç¡¬è¦åšçš„è©±é‚„æ˜¯è¾¦å¾—åˆ°ï¼Œæ–¹æ³•æ˜¯ç›´æ¥æŠŠä¸€å€‹çˆ¶é¡åˆ¥ç‰©ä»¶æ”¾é€²æˆå“¡ä¸­ï¼Œä¸¦ä¸”ç”¨å®ƒå¯¦ä½œ <code>Deref</code> èˆ‡ <code>DerefMut</code> traitã€‚ <a href="https://electronic.blue/blog/2017/04/30-rust-an-introduction-in-oop/#fnref3">â†©</a></li>
<li>è¦†è¼‰é€™äº›é‹ç®—å­æœƒæ”¹è®Šé‹ç®—å¼çš„æ±‚å€¼é †åºï¼Œå°è‡´é›£ä»¥åç‹€çš„ bugï¼Œè©³æƒ…å¯åƒè€ƒ C++ çŸ¥åæ•™ç§‘æ›¸ <em>Effective C++</em>ã€‚</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../rust/07_é¢å‘å°è±¡ç·¨ç¨‹.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../go/go.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../rust/07_é¢å‘å°è±¡ç·¨ç¨‹.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../go/go.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
