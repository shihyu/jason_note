<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rust Derive Traits 比較：自動生成 vs 手動實作 - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rust-derive-traits-比較自動生成-vs-手動實作"><a class="header" href="#rust-derive-traits-比較自動生成-vs-手動實作">Rust Derive Traits 比較：自動生成 vs 手動實作</a></h1>
<h2 id="概述"><a class="header" href="#概述">概述</a></h2>
<p>在 Rust 中，<code>#[derive(...)]</code> 屬性可以自動為結構體生成常用的 trait 實作，大幅減少重複程式碼。本文比較使用 derive 和手動實作的差異。</p>
<h2 id="專案設定"><a class="header" href="#專案設定">專案設定</a></h2>
<p>在開始之前，需要建立專案並設定 <code>Cargo.toml</code>：</p>
<pre><code class="language-bash">cargo new derive_comparison
cd derive_comparison
</code></pre>
<h3 id="cargotoml"><a class="header" href="#cargotoml">Cargo.toml</a></h3>
<pre><code class="language-toml">[package]
name = "derive_comparison"
version = "0.1.0"
edition = "2021"

[dependencies]
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
uuid = { version = "1.0", features = ["v4", "serde"] }
chrono = { version = "0.4", features = ["serde"] }
</code></pre>
<h2 id="方法一使用-derivedebug-clone-serialize-deserialize"><a class="header" href="#方法一使用-derivedebug-clone-serialize-deserialize">方法一：使用 <code>#[derive(Debug, Clone, Serialize, Deserialize)]</code></a></h2>
<h3 id="完整程式碼"><a class="header" href="#完整程式碼">完整程式碼</a></h3>
<pre><pre class="playground"><code class="language-rust">use serde::{Serialize, Deserialize};
use uuid::Uuid;
use chrono::{DateTime, Utc};

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct User {
    pub id: Uuid,
    pub name: String,
    pub email: String,
    pub age: u32,
    pub created_at: DateTime&lt;Utc&gt;,
    pub updated_at: DateTime&lt;Utc&gt;,
}

fn main() {
    // 建立一個 User 實例
    let user = User {
        id: Uuid::new_v4(),
        name: "John Doe".to_string(),
        email: "john@example.com".to_string(),
        age: 30,
        created_at: Utc::now(),
        updated_at: Utc::now(),
    };
    
    println!("=== 使用 derive 的範例 ===\n");
    
    // Debug - 直接可用
    println!("Debug 輸出:");
    println!("{:?}", user);
    println!();
    
    // Clone - 直接可用
    let user2 = user.clone();
    println!("Clone 成功:");
    println!("原始 user: {:?}", user);
    println!("複製 user2: {:?}", user2);
    println!();
    
    // Serialize - 直接可用
    let json = serde_json::to_string(&amp;user).unwrap();
    println!("Serialize 到 JSON:");
    println!("{}", json);
    println!();
    
    // Deserialize - 直接可用
    let user3: User = serde_json::from_str(&amp;json).unwrap();
    println!("Deserialize 從 JSON:");
    println!("{:?}", user3);
    println!();
    
    // 驗證序列化/反序列化是否正確
    println!("驗證序列化/反序列化:");
    println!("原始 user ID: {}", user.id);
    println!("反序列化 user3 ID: {}", user3.id);
    println!("ID 是否相同: {}", user.id == user3.id);
}</code></pre></pre>
<h3 id="特點"><a class="header" href="#特點">特點</a></h3>
<ul>
<li><strong>程式碼量</strong>：僅需 1 行 derive 屬性</li>
<li><strong>維護性</strong>：自動生成，不需要手動維護</li>
<li><strong>一致性</strong>：標準實作，不易出錯</li>
<li><strong>開發效率</strong>：立即可用，無需額外實作</li>
</ul>
<h2 id="不使用-derive---手動實作"><a class="header" href="#不使用-derive---手動實作">不使用 <code>#[derive(...)]</code> - 手動實作</a></h2>
<h3 id="程式碼"><a class="header" href="#程式碼">程式碼</a></h3>
<pre><pre class="playground"><code class="language-rust">use serde::{Serialize, Deserialize, Serializer, Deserializer};
use uuid::Uuid;
use chrono::{DateTime, Utc};

// 只有基本結構體
pub struct User {
    pub id: Uuid,
    pub name: String,
    pub email: String,
    pub age: u32,
    pub created_at: DateTime&lt;Utc&gt;,
    pub updated_at: DateTime&lt;Utc&gt;,
}

// 需要手動實作 Debug
impl std::fmt::Debug for User {
    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;'_&gt;) -&gt; std::fmt::Result {
        f.debug_struct("User")
            .field("id", &amp;self.id)
            .field("name", &amp;self.name)
            .field("email", &amp;self.email)
            .field("age", &amp;self.age)
            .field("created_at", &amp;self.created_at)
            .field("updated_at", &amp;self.updated_at)
            .finish()
    }
}

// 需要手動實作 Clone
impl Clone for User {
    fn clone(&amp;self) -&gt; Self {
        User {
            id: self.id.clone(),
            name: self.name.clone(),
            email: self.email.clone(),
            age: self.age,
            created_at: self.created_at,
            updated_at: self.updated_at,
        }
    }
}

// 需要手動實作 Serialize
impl Serialize for User {
    fn serialize&lt;S&gt;(&amp;self, serializer: S) -&gt; Result&lt;S::Ok, S::Error&gt;
    where
        S: Serializer,
    {
        use serde::ser::SerializeStruct;
        let mut state = serializer.serialize_struct("User", 6)?;
        state.serialize_field("id", &amp;self.id)?;
        state.serialize_field("name", &amp;self.name)?;
        state.serialize_field("email", &amp;self.email)?;
        state.serialize_field("age", &amp;self.age)?;
        state.serialize_field("created_at", &amp;self.created_at)?;
        state.serialize_field("updated_at", &amp;self.updated_at)?;
        state.end()
    }
}

// 需要手動實作 Deserialize
impl&lt;'de&gt; Deserialize&lt;'de&gt; for User {
    fn deserialize&lt;D&gt;(deserializer: D) -&gt; Result&lt;Self, D::Error&gt;
    where
        D: Deserializer&lt;'de&gt;,
    {
        use serde::de::{self, Visitor, MapAccess};
        use std::fmt;

        #[derive(Deserialize)]
        #[serde(field_identifier, rename_all = "lowercase")]
        enum Field { Id, Name, Email, Age, CreatedAt, UpdatedAt }

        struct UserVisitor;

        impl&lt;'de&gt; Visitor&lt;'de&gt; for UserVisitor {
            type Value = User;

            fn expecting(&amp;self, formatter: &amp;mut fmt::Formatter) -&gt; fmt::Result {
                formatter.write_str("struct User")
            }

            fn visit_map&lt;V&gt;(self, mut map: V) -&gt; Result&lt;User, V::Error&gt;
            where
                V: MapAccess&lt;'de&gt;,
            {
                let mut id = None;
                let mut name = None;
                let mut email = None;
                let mut age = None;
                let mut created_at = None;
                let mut updated_at = None;

                while let Some(key) = map.next_key()? {
                    match key {
                        Field::Id =&gt; {
                            if id.is_some() {
                                return Err(de::Error::duplicate_field("id"));
                            }
                            id = Some(map.next_value()?);
                        }
                        Field::Name =&gt; {
                            if name.is_some() {
                                return Err(de::Error::duplicate_field("name"));
                            }
                            name = Some(map.next_value()?);
                        }
                        Field::Email =&gt; {
                            if email.is_some() {
                                return Err(de::Error::duplicate_field("email"));
                            }
                            email = Some(map.next_value()?);
                        }
                        Field::Age =&gt; {
                            if age.is_some() {
                                return Err(de::Error::duplicate_field("age"));
                            }
                            age = Some(map.next_value()?);
                        }
                        Field::CreatedAt =&gt; {
                            if created_at.is_some() {
                                return Err(de::Error::duplicate_field("created_at"));
                            }
                            created_at = Some(map.next_value()?);
                        }
                        Field::UpdatedAt =&gt; {
                            if updated_at.is_some() {
                                return Err(de::Error::duplicate_field("updated_at"));
                            }
                            updated_at = Some(map.next_value()?);
                        }
                    }
                }

                let id = id.ok_or_else(|| de::Error::missing_field("id"))?;
                let name = name.ok_or_else(|| de::Error::missing_field("name"))?;
                let email = email.ok_or_else(|| de::Error::missing_field("email"))?;
                let age = age.ok_or_else(|| de::Error::missing_field("age"))?;
                let created_at = created_at.ok_or_else(|| de::Error::missing_field("created_at"))?;
                let updated_at = updated_at.ok_or_else(|| de::Error::missing_field("updated_at"))?;

                Ok(User {
                    id,
                    name,
                    email,
                    age,
                    created_at,
                    updated_at,
                })
            }
        }

        const FIELDS: &amp;'static [&amp;'static str] = &amp;["id", "name", "email", "age", "created_at", "updated_at"];
        deserializer.deserialize_struct("User", FIELDS, UserVisitor)
    }
}

// 使用範例
fn main() {
    let user = User {
        id: Uuid::new_v4(),
        name: "John Doe".to_string(),
        email: "john@example.com".to_string(),
        age: 30,
        created_at: Utc::now(),
        updated_at: Utc::now(),
    };
    
    // 現在這些功能都可以使用了
    println!("{:?}", user);
    let user2 = user.clone();
    let json = serde_json::to_string(&amp;user).unwrap();
    let user3: User = serde_json::from_str(&amp;json).unwrap();
}</code></pre></pre>
<h3 id="特點-1"><a class="header" href="#特點-1">特點</a></h3>
<ul>
<li><strong>程式碼量</strong>：需要數十行手動實作</li>
<li><strong>複雜性</strong>：需要深入了解 trait 的實作細節</li>
<li><strong>維護成本</strong>：每次修改結構體都需要更新所有實作</li>
<li><strong>錯誤風險</strong>：容易在手動實作中出現錯誤</li>
</ul>
<h2 id="執行結果比較"><a class="header" href="#執行結果比較">執行結果比較</a></h2>
<h3 id="方法一derive執行結果"><a class="header" href="#方法一derive執行結果">方法一（derive）執行結果</a></h3>
<pre><code>=== 使用 derive 的範例 ===

Debug 輸出:
User { id: a1b2c3d4-e5f6-7890-abcd-ef1234567890, name: "John Doe", email: "john@example.com", age: 30, created_at: 2025-01-20T10:30:00.123456789Z, updated_at: 2025-01-20T10:30:00.123456789Z }

Clone 成功:
原始 user: User { id: a1b2c3d4-e5f6-7890-abcd-ef1234567890, name: "John Doe", email: "john@example.com", age: 30, created_at: 2025-01-20T10:30:00.123456789Z, updated_at: 2025-01-20T10:30:00.123456789Z }
複製 user2: User { id: a1b2c3d4-e5f6-7890-abcd-ef1234567890, name: "John Doe", email: "john@example.com", age: 30, created_at: 2025-01-20T10:30:00.123456789Z, updated_at: 2025-01-20T10:30:00.123456789Z }

Serialize 到 JSON:
{"id":"a1b2c3d4-e5f6-7890-abcd-ef1234567890","name":"John Doe","email":"john@example.com","age":30,"created_at":"2025-01-20T10:30:00.123456789Z","updated_at":"2025-01-20T10:30:00.123456789Z"}

Deserialize 從 JSON:
User { id: a1b2c3d4-e5f6-7890-abcd-ef1234567890, name: "John Doe", email: "john@example.com", age: 30, created_at: 2025-01-20T10:30:00.123456789Z, updated_at: 2025-01-20T10:30:00.123456789Z }

驗證序列化/反序列化:
原始 user ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
反序列化 user3 ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
ID 是否相同: true
</code></pre>
<h3 id="方法二手動實作執行結果"><a class="header" href="#方法二手動實作執行結果">方法二（手動實作）執行結果</a></h3>
<pre><code>=== 手動實作的 traits 測試 ===

1. Debug 輸出:
User { id: a1b2c3d4-e5f6-7890-abcd-ef1234567890, name: "John Doe", email: "john@example.com", age: 30, created_at: 2025-01-20T10:30:00.123456789Z, updated_at: 2025-01-20T10:30:00.123456789Z }

2. Clone 測試:
原始 user name: John Doe
複製 user2 name: John Doe
記憶體位址是否不同: true

3. Serialize 測試:
序列化成功:
{
  "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "name": "John Doe",
  "email": "john@example.com",
  "age": 30,
  "created_at": "2025-01-20T10:30:00.123456789Z",
  "updated_at": "2025-01-20T10:30:00.123456789Z"
}

4. Deserialize 測試:
反序列化成功:
原始 user ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
反序列化 user3 ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
ID 是否相同: true
姓名是否相同: true

=== 所有測試完成 ===
手動實作的程式碼行數: 約 150+ 行
使用 #[derive(...)] 只需要: 1 行
</code></pre>
<h2 id="詳細實作解析"><a class="header" href="#詳細實作解析">詳細實作解析</a></h2>
<h3 id="debug-trait-實作"><a class="header" href="#debug-trait-實作">Debug Trait 實作</a></h3>
<ul>
<li><strong>derive 版本</strong>：自動生成標準格式的 Debug 輸出</li>
<li><strong>手動版本</strong>：使用 <code>debug_struct</code> 手動建構格式化字串</li>
</ul>
<h3 id="clone-trait-實作"><a class="header" href="#clone-trait-實作">Clone Trait 實作</a></h3>
<ul>
<li><strong>derive 版本</strong>：自動為每個欄位呼叫 <code>clone()</code> 方法</li>
<li><strong>手動版本</strong>：手動處理每個欄位的複製邏輯</li>
</ul>
<h3 id="serialize-trait-實作"><a class="header" href="#serialize-trait-實作">Serialize Trait 實作</a></h3>
<ul>
<li><strong>derive 版本</strong>：自動序列化所有欄位</li>
<li><strong>手動版本</strong>：使用 <code>SerializeStruct</code> 逐一序列化每個欄位</li>
</ul>
<h3 id="deserialize-trait-實作最複雜"><a class="header" href="#deserialize-trait-實作最複雜">Deserialize Trait 實作（最複雜）</a></h3>
<ul>
<li><strong>derive 版本</strong>：自動處理所有反序列化邏輯</li>
<li><strong>手動版本</strong>：需要實作：
<ul>
<li><code>Field</code> enum 用於欄位識別</li>
<li><code>Visitor</code> struct 用於處理反序列化邏輯</li>
<li>重複欄位檢查</li>
<li>缺失欄位檢查</li>
<li>型別轉換和錯誤處理</li>
</ul>
</li>
</ul>
<h2 id="比較總結"><a class="header" href="#比較總結">比較總結</a></h2>
<div class="table-wrapper"><table><thead><tr><th>項目</th><th>使用 derive</th><th>手動實作</th></tr></thead><tbody>
<tr><td><strong>程式碼量</strong></td><td>1 行</td><td>150+ 行</td></tr>
<tr><td><strong>開發時間</strong></td><td>幾秒鐘</td><td>數小時</td></tr>
<tr><td><strong>維護成本</strong></td><td>極低</td><td>高</td></tr>
<tr><td><strong>錯誤風險</strong></td><td>極低</td><td>高</td></tr>
<tr><td><strong>客製化程度</strong></td><td>有限</td><td>完全客製化</td></tr>
<tr><td><strong>學習曲線</strong></td><td>簡單</td><td>困難</td></tr>
<tr><td><strong>編譯時間</strong></td><td>快</td><td>相對慢</td></tr>
<tr><td><strong>功能一致性</strong></td><td>標準實作</td><td>可能不一致</td></tr>
</tbody></table>
</div>
<h2 id="使用建議"><a class="header" href="#使用建議">使用建議</a></h2>
<h3 id="建議使用-derive-的情況"><a class="header" href="#建議使用-derive-的情況">建議使用 derive 的情況</a></h3>
<ul>
<li><strong>一般開發</strong>：大多數情況下都適用</li>
<li><strong>快速原型</strong>：需要快速實作基本功能</li>
<li><strong>標準需求</strong>：不需要特殊的客製化邏輯</li>
<li><strong>團隊協作</strong>：保持程式碼一致性</li>
</ul>
<h3 id="考慮手動實作的情況"><a class="header" href="#考慮手動實作的情況">考慮手動實作的情況</a></h3>
<ul>
<li><strong>特殊需求</strong>：需要客製化的序列化格式</li>
<li><strong>效能最佳化</strong>：需要特定的效能優化</li>
<li><strong>學習目的</strong>：深入理解 Rust trait 系統</li>
<li><strong>複雜邏輯</strong>：需要特殊的驗證或轉換邏輯</li>
</ul>
<h2 id="進階技巧"><a class="header" href="#進階技巧">進階技巧</a></h2>
<h3 id="條件式-derive"><a class="header" href="#條件式-derive">條件式 derive</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug, Clone)]
#[cfg_attr(feature = "serde", derive(Serialize, Deserialize))]
pub struct User {
    // ...
}
<span class="boring">}</span></code></pre></pre>
<h3 id="自訂-derive-行為"><a class="header" href="#自訂-derive-行為">自訂 derive 行為</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct User {
    pub id: Uuid,
    
    #[serde(rename = "full_name")]
    pub name: String,
    
    #[serde(skip_serializing_if = "Option::is_none")]
    pub middle_name: Option&lt;String&gt;,
    
    #[serde(skip)]
    pub password_hash: String,
    
    pub email: String,
    pub age: u32,
    
    #[serde(with = "chrono::serde::ts_seconds")]
    pub created_at: DateTime&lt;Utc&gt;,
    
    pub updated_at: DateTime&lt;Utc&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="常見的-derive-組合"><a class="header" href="#常見的-derive-組合">常見的 derive 組合</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 基本資料結構
#[derive(Debug, Clone, PartialEq, Eq)]

// 可序列化的資料
#[derive(Debug, Clone, Serialize, Deserialize)]

// 可雜湊的資料
#[derive(Debug, Clone, PartialEq, Eq, Hash)]

// 可排序的資料
#[derive(Debug, Clone, PartialEq, Eq, PartialOrd, Ord)]

// 具有預設值的資料
#[derive(Debug, Clone, Default)]
<span class="boring">}</span></code></pre></pre>
<h2 id="效能考量"><a class="header" href="#效能考量">效能考量</a></h2>
<h3 id="編譯時間"><a class="header" href="#編譯時間">編譯時間</a></h3>
<ul>
<li><strong>derive</strong>：編譯時生成程式碼，對編譯時間影響較小</li>
<li><strong>手動實作</strong>：需要編譯更多程式碼，編譯時間較長</li>
</ul>
<h3 id="執行時間"><a class="header" href="#執行時間">執行時間</a></h3>
<ul>
<li><strong>derive</strong>：生成的程式碼通常是最佳化的</li>
<li><strong>手動實作</strong>：可以針對特定需求進行最佳化，但需要專業知識</li>
</ul>
<h3 id="記憶體使用"><a class="header" href="#記憶體使用">記憶體使用</a></h3>
<ul>
<li><strong>derive</strong>：標準實作，記憶體使用合理</li>
<li><strong>手動實作</strong>：可以針對記憶體使用進行最佳化</li>
</ul>
<h2 id="常見錯誤和解決方案"><a class="header" href="#常見錯誤和解決方案">常見錯誤和解決方案</a></h2>
<h3 id="錯誤-1遺漏必要的-feature"><a class="header" href="#錯誤-1遺漏必要的-feature">錯誤 1：遺漏必要的 feature</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 錯誤：沒有啟用 derive feature
// Cargo.toml 中應該是：
// serde = { version = "1.0", features = ["derive"] }
<span class="boring">}</span></code></pre></pre>
<h3 id="錯誤-2循環依賴"><a class="header" href="#錯誤-2循環依賴">錯誤 2：循環依賴</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 錯誤：結構體之間的循環引用
#[derive(Debug, Clone)]
struct A {
    b: B,
}

#[derive(Debug, Clone)]
struct B {
    a: A,  // 這會導致編譯錯誤
}

// 解決方案：使用 Box 或 Rc
#[derive(Debug, Clone)]
struct A {
    b: Box&lt;B&gt;,
}

#[derive(Debug, Clone)]
struct B {
    a: Box&lt;A&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="錯誤-3泛型參數問題"><a class="header" href="#錯誤-3泛型參數問題">錯誤 3：泛型參數問題</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 錯誤：泛型參數沒有適當的約束
#[derive(Debug, Clone)]
struct Container&lt;T&gt; {
    value: T,
}

// 解決方案：添加適當的約束
#[derive(Debug, Clone)]
struct Container&lt;T: Debug + Clone&gt; {
    value: T,
}
<span class="boring">}</span></code></pre></pre>
<h2 id="實用工具和庫"><a class="header" href="#實用工具和庫">實用工具和庫</a></h2>
<h3 id="常用的-derive-相關-crate"><a class="header" href="#常用的-derive-相關-crate">常用的 derive 相關 crate</a></h3>
<ul>
<li><strong>serde</strong>：序列化/反序列化</li>
<li><strong>clap</strong>：命令列參數解析的 derive</li>
<li><strong>thiserror</strong>：錯誤處理的 derive</li>
<li><strong>strum</strong>：枚舉相關的 derive</li>
</ul>
<h3 id="開發工具"><a class="header" href="#開發工具">開發工具</a></h3>
<ul>
<li><strong>cargo expand</strong>：查看 derive 生成的程式碼</li>
<li><strong>rust-analyzer</strong>：IDE 支援，可以顯示 derive 的效果</li>
</ul>
<h2 id="測試和除錯"><a class="header" href="#測試和除錯">測試和除錯</a></h2>
<h3 id="測試-derive-功能"><a class="header" href="#測試-derive-功能">測試 derive 功能</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_user_debug() {
        let user = User { /* ... */ };
        let debug_str = format!("{:?}", user);
        assert!(debug_str.contains("John Doe"));
    }

    #[test]
    fn test_user_clone() {
        let user = User { /* ... */ };
        let cloned = user.clone();
        assert_eq!(user.id, cloned.id);
    }

    #[test]
    fn test_user_serialization() {
        let user = User { /* ... */ };
        let json = serde_json::to_string(&amp;user).unwrap();
        let deserialized: User = serde_json::from_str(&amp;json).unwrap();
        assert_eq!(user.id, deserialized.id);
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="除錯技巧"><a class="header" href="#除錯技巧">除錯技巧</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 使用 cargo expand 查看生成的程式碼
// cargo install cargo-expand
// cargo expand --lib

// 使用 dbg! 宏來除錯
let user = dbg!(User { /* ... */ });
<span class="boring">}</span></code></pre></pre>
<h2 id="結論"><a class="header" href="#結論">結論</a></h2>
<p><code>#[derive(...)]</code> 是 Rust 語言的強大特性，能夠用極少的程式碼實現複雜的功能。在大多數情況下，使用 derive 是最佳選擇，除非有特殊的客製化需求。這個特性不僅提升了開發效率，也減少了錯誤發生的機會，是 Rust 開發者必須掌握的重要工具。</p>
<h3 id="學習建議"><a class="header" href="#學習建議">學習建議</a></h3>
<ol>
<li><strong>初學者</strong>：優先學習和使用 derive 屬性</li>
<li><strong>進階開發者</strong>：了解手動實作的細節，以便在需要時進行客製化</li>
<li><strong>專案開發</strong>：在實際專案中優先使用 derive，只在特殊需求時才手動實作</li>
<li><strong>效能敏感</strong>：在效能關鍵的地方考慮手動實作和最佳化</li>
</ol>
<p>掌握 <code>#[derive(...)]</code> 的使用，能夠讓你在 Rust 開發中事半功倍，同時保持程式碼的簡潔和可維護性。
|------|-----------|-------------|
| 程式碼量 | 1 行 | 需要 100+ 行手動實作 |
| 除錯輸出 | <code>println!("{:?}", user)</code> 直接可用 | 編譯錯誤，需要手動實作 Debug |
| 複製物件 | <code>user.clone()</code> 直接可用 | 編譯錯誤，需要手動實作 Clone |
| JSON 序列化 | <code>serde_json::to_string(&amp;user)</code> 直接可用 | 編譯錯誤，需要手動實作 Serialize |
| JSON 反序列化 | <code>serde_json::from_str(&amp;json)</code> 直接可用 | 編譯錯誤，需要手動實作 Deserialize |
| 維護成本 | 低 | 高 |
| 出錯風險 | 低 | 高 |</p>
<h2 id="結論-1"><a class="header" href="#結論-1">結論</a></h2>
<p><code>#[derive(...)]</code> 讓你用 1 行程式碼就能獲得原本需要數十行手動實作的功能，大幅提升開發效率並減少出錯機會。除非有特殊需求需要客製化實作，否則建議優先使用 derive 屬性。</p>
<h2 id="適用情境"><a class="header" href="#適用情境">適用情境</a></h2>
<h3 id="建議使用-derive"><a class="header" href="#建議使用-derive">建議使用 derive</a></h3>
<ul>
<li>一般的資料結構</li>
<li>標準的序列化/反序列化需求</li>
<li>快速開發原型</li>
</ul>
<h3 id="考慮手動實作"><a class="header" href="#考慮手動實作">考慮手動實作</a></h3>
<ul>
<li>需要客製化的序列化格式</li>
<li>特殊的 Debug 輸出需求</li>
<li>效能敏感的場景需要優化</li>
<li>複雜的欄位驗證邏輯</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../rust/Rust-self-Self-與-C++-this-對比指南.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../rust/rust_traits_explained.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../rust/Rust-self-Self-與-C++-this-對比指南.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../rust/rust_traits_explained.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
