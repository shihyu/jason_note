<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERICA Bluetooth Controller</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
        height: calc(100vh - 40px);
      }
      
      .panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      }
      
      h1 {
        color: #333;
        margin-bottom: 20px;
        font-size: 28px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      h2 {
        color: #555;
        margin: 20px 0 15px;
        font-size: 18px;
        font-weight: 600;
      }
      
      .control-section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }
      
      button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin: 5px;
        transition: all 0.3s ease;
        font-weight: 500;
      }
      
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      }
      
      button:active {
        transform: translateY(0);
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
      }
      
      .btn-danger {
        background: linear-gradient(135deg, #f53844 0%, #df1f2f 100%);
        color: white;
      }
      
      .btn-warning {
        background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        color: white;
      }
      
      input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
        margin: 20px 0;
      }
      
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        cursor: pointer;
      }
      
      input[type="range"]::-moz-range-thumb {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        cursor: pointer;
      }
      
      .intensity-display {
        font-size: 48px;
        font-weight: bold;
        text-align: center;
        color: #667eea;
        margin: 10px 0;
      }
      
      #deviceList {
        min-height: 100px;
        padding: 15px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
      }
      
      .device-item {
        padding: 15px;
        margin: 10px 0;
        background: #f5f5f5;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }
      
      .device-item strong {
        color: #333;
        font-size: 16px;
      }
      
      .status {
        padding: 10px 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: 500;
      }
      
      .status-connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .status-scanning {
        background: #cce5ff;
        color: #004085;
        border: 1px solid #b8daff;
      }
      
      .status-disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      .debug-logs {
        height: calc(100vh - 160px);
        overflow-y: auto;
        background: #f9f9f9;
        border-radius: 10px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      
      .debug-logs p {
        margin: 3px 0;
        padding: 3px 0;
        border-bottom: 1px solid #eee;
        word-wrap: break-word;
      }
      
      .pattern-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
      }
      
      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
        }
        
        .debug-logs {
          height: 300px;
        }
      }
    </style>
</head>
<body>
    <div class="container">
      <div class="panel">
        <h1>ğŸ® ERICA Bluetooth Controller</h1>
        
        <div class="control-section">
          <h2>ğŸ“¡ é€£æ¥æ§åˆ¶</h2>
          <div id="status" class="status status-disconnected">æœªé€£æ¥</div>
          <div style="margin-top: 15px;">
            <button id="scanBtn" class="btn-primary">é–‹å§‹æƒæ</button>
            <button id="disconnectBtn" class="btn-danger">æ–·é–‹é€£æ¥</button>
          </div>
        </div>
        
        <div class="control-section">
          <h2>ğŸ›ï¸ æŒ¯å‹•æ§åˆ¶</h2>
          <div class="intensity-display" id="intensityDisplay">0%</div>
          <input type="range" id="vibrateSlider" min="0" max="100" value="0">
          <div style="text-align: center;">
            <button id="vibrateBtn" class="btn-success">é–‹å§‹æŒ¯å‹•</button>
            <button id="stopBtn" class="btn-danger">åœæ­¢</button>
          </div>
          <div class="pattern-buttons">
            <button id="pulseBtn" class="btn-warning">è„ˆè¡æ¨¡å¼</button>
            <button id="waveBtn" class="btn-warning">æ³¢æµªæ¨¡å¼</button>
            <button id="randomBtn" class="btn-warning">éš¨æ©Ÿæ¨¡å¼</button>
          </div>
        </div>
        
        <div class="control-section">
          <h2>ğŸ“± å·²é€£æ¥è¨­å‚™</h2>
          <div id="deviceList">
            å°šç„¡é€£æ¥è¨­å‚™
          </div>
        </div>
      </div>
      
      <div class="panel">
        <h2>ğŸ” èª¿è©¦æ—¥èªŒ</h2>
        <button id="clearLogsBtn" style="margin-bottom: 10px;">æ¸…é™¤æ—¥èªŒ</button>
        <div id="logs" class="debug-logs"></div>
      </div>
    </div>

    <script type="module">
      // Import modules
      let ButtplugWasmClientConnector, ButtplugClient;
      
      function addLog(message) {
        const logDiv = document.getElementById('logs');
        const p = document.createElement('p');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(p);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }
      
      // ç•°æ­¥è¼‰å…¥æ¨¡çµ„çš„å‡½æ•¸
      async function loadModules() {
        try {
          // åªåœ¨æ”¯æ´ WebBluetooth çš„ç€è¦½å™¨è¼‰å…¥ WASM
          if ('bluetooth' in navigator) {
            const wasmModule = await import("@wasm");
            ButtplugWasmClientConnector = wasmModule.ButtplugWasmClientConnector;
            addLog("âœ… WASM æ¨¡çµ„è¼‰å…¥æˆåŠŸ");
          } else {
            addLog("âš ï¸ WebBluetooth ä¸æ”¯æ´ï¼Œè·³é WASM è¼‰å…¥");
          }
          
          const buttplugModule = await import("@buttplug");
          // Try different possible export names
          ButtplugClient = buttplugModule.ButtplugClient || buttplugModule.kn || buttplugModule.default?.ButtplugClient;
          if (!ButtplugClient) {
            throw new Error("ButtplugClient not found in module exports");
          }
          addLog("âœ… Buttplug å®¢æˆ¶ç«¯è¼‰å…¥æˆåŠŸ");
          return true;
        } catch (error) {
          addLog(`âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—: ${error.message}`);
          console.error(error);
          return false;
        }
      }

      // Global state
      let client = null;
      let isScanning = false;
      let connectedDevices = [];
      let currentPattern = null;
      let patternInterval = null;
      let isLoggingActivated = false;

      function updateStatus(message, className) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = `status ${className}`;
      }

      function updateDeviceList() {
        const deviceListDiv = document.getElementById('deviceList');
        if (connectedDevices.length === 0) {
          deviceListDiv.innerHTML = 'å°šç„¡é€£æ¥è¨­å‚™';
        } else {
          deviceListDiv.innerHTML = connectedDevices.map(device => {
            const vibratorCount = device.vibrateAttributes?.length || 
                                 device.messageAttributes?.ScalarCmd?.length || 0;
            return `<div class="device-item">
              <strong>${device.name}</strong> (ç´¢å¼•: ${device.index})
              <br>æŒ¯å‹•å™¨æ•¸é‡: ${vibratorCount}
              <br>APIé¡å‹: ${device.vibrateAttributes ? 'vibrate()' : 'scalar()'}
            </div>`;
          }).join('');
        }
      }

      async function startScanning() {
        try {
          // ç¢ºä¿æ¨¡çµ„å·²è¼‰å…¥
          if (!ButtplugWasmClientConnector || !ButtplugClient) {
            addLog("âŒ å¿…è¦æ¨¡çµ„æœªè¼‰å…¥ï¼Œç„¡æ³•é–‹å§‹æƒæ");
            return;
          }
          
          // æª¢æ¸¬ WebBluetooth æ”¯æ´æƒ…æ³
          addLog("=== é–‹å§‹æª¢æ¸¬ WebBluetooth æ”¯æ´ ===");
          addLog(`ç€è¦½å™¨: ${navigator.userAgent}`);
          
          if (typeof navigator === 'undefined') {
            addLog("âŒ navigator ç‰©ä»¶ä¸å­˜åœ¨");
          } else {
            addLog("âœ… navigator ç‰©ä»¶å­˜åœ¨");
            
            // æª¢æ¸¬ bluetooth API
            if ('bluetooth' in navigator) {
              addLog("âœ… navigator.bluetooth å­˜åœ¨");
              addLog(`navigator.bluetooth é¡å‹: ${typeof navigator.bluetooth}`);
              addLog(`navigator.bluetooth ç‰©ä»¶: ${navigator.bluetooth}`);
              
              // å˜—è©¦åˆ—å‡ºå¯ç”¨çš„æ–¹æ³•
              try {
                const bluetoothMethods = Object.getOwnPropertyNames(Object.getPrototypeOf(navigator.bluetooth));
                addLog(`å¯ç”¨çš„ Bluetooth æ–¹æ³•: ${bluetoothMethods.join(', ')}`);
              } catch (e) {
                addLog(`ç„¡æ³•åˆ—å‡º Bluetooth æ–¹æ³•: ${e.message}`);
              }
              
              // æª¢æ¸¬ getAvailability
              if (navigator.bluetooth.getAvailability) {
                try {
                  const isAvailable = await navigator.bluetooth.getAvailability();
                  addLog(`Bluetooth å¯ç”¨æ€§: ${isAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}`);
                } catch (e) {
                  addLog(`ç„¡æ³•æª¢æ¸¬ Bluetooth å¯ç”¨æ€§: ${e.message}`);
                }
              } else {
                addLog("âš ï¸ getAvailability æ–¹æ³•ä¸å­˜åœ¨");
              }
              
              // æª¢æ¸¬ requestDevice
              if (navigator.bluetooth.requestDevice) {
                addLog("âœ… requestDevice æ–¹æ³•å­˜åœ¨");
              } else {
                addLog("âŒ requestDevice æ–¹æ³•ä¸å­˜åœ¨");
              }
            } else {
              addLog("âŒ navigator.bluetooth ä¸å­˜åœ¨");
              addLog("æç¤º: Firefox ä¸æ”¯æ´ WebBluetooth API");
              addLog("è«‹ä½¿ç”¨ Chromeã€Edge æˆ– Opera ç€è¦½å™¨");
              
              // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç›¸é—œ API
              if ('usb' in navigator) {
                addLog("â„¹ï¸ ç™¼ç¾ WebUSB API");
              }
              if ('serial' in navigator) {
                addLog("â„¹ï¸ ç™¼ç¾ WebSerial API");
              }
            }
          }
          addLog("=== WebBluetooth æª¢æ¸¬å®Œæˆ ===");
          
          if (isScanning || client) {
            // Stop and restart
            if (client) {
              try {
                if (isScanning) await client.stopScanning();
                await client.disconnect();
              } catch (e) {
                addLog(`åœæ­¢è­¦å‘Š: ${e.message}`);
              }
              client = null;
              isScanning = false;
              connectedDevices = [];
              updateDeviceList();
            }
          }
          
          addLog("å‰µå»ºå®¢æˆ¶ç«¯...");
          client = new ButtplugClient("ERICA Controller");
          
          // Setup event listeners
          client.addListener('deviceadded', (device) => {
            addLog(`âœ… ç™¼ç¾è¨­å‚™: ${device.name}`);
            connectedDevices.push(device);
            updateDeviceList();
            updateStatus(`å·²é€£æ¥: ${device.name}`, 'status-connected');
          });
          
          client.addListener('deviceremoved', (device) => {
            addLog(`âŒ è¨­å‚™ç§»é™¤: ${device.name}`);
            connectedDevices = connectedDevices.filter(d => d.index !== device.index);
            updateDeviceList();
            if (connectedDevices.length === 0) {
              updateStatus('æœªé€£æ¥', 'status-disconnected');
            }
          });
          
          client.addListener('scanningfinished', () => {
            addLog("æƒæçµæŸ");
            isScanning = false;
            if (connectedDevices.length > 0) {
              updateStatus(`å·²é€£æ¥ ${connectedDevices.length} å€‹è¨­å‚™`, 'status-connected');
            } else {
              updateStatus('æœªæ‰¾åˆ°è¨­å‚™', 'status-disconnected');
            }
          });
          
          // Activate logging once
          if (!isLoggingActivated) {
            try {
              await ButtplugWasmClientConnector.activateLogging();
              isLoggingActivated = true;
            } catch (e) {
              addLog(`æ—¥èªŒæ¿€æ´»è­¦å‘Š: ${e.message}`);
            }
          }
          
          // Connect
          const connector = new ButtplugWasmClientConnector();
          await client.connect(connector);
          addLog("å·²é€£æ¥åˆ°ä¼ºæœå™¨");
          
          // Start scanning
          updateStatus('æ­£åœ¨æƒæè¨­å‚™...', 'status-scanning');
          isScanning = true;
          await client.startScanning();
          addLog("é–‹å§‹æƒæè—ç‰™è¨­å‚™...");
          
          // Auto-stop after 10 seconds
          setTimeout(async () => {
            if (isScanning && client) {
              try {
                await client.stopScanning();
                isScanning = false;
              } catch (e) {
                addLog(`è‡ªå‹•åœæ­¢è­¦å‘Š: ${e.message}`);
              }
            }
          }, 10000);
          
        } catch (error) {
          addLog(`âŒ éŒ¯èª¤: ${error.message}`);
          console.error(error);
          isScanning = false;
          client = null;
          updateStatus('é€£æ¥å¤±æ•—', 'status-disconnected');
        }
      }

      async function disconnect() {
        stopPattern();
        
        if (client) {
          try {
            if (isScanning) await client.stopScanning();
            await client.disconnect();
          } catch (error) {
            addLog(`æ–·é–‹è­¦å‘Š: ${error.message}`);
          } finally {
            client = null;
            connectedDevices = [];
            updateDeviceList();
            isScanning = false;
            updateStatus('æœªé€£æ¥', 'status-disconnected');
            addLog("å·²æ–·é–‹é€£æ¥");
          }
        }
      }

      async function setVibration(intensity) {
        if (connectedDevices.length === 0) return;
        
        try {
          for (const device of connectedDevices) {
            // Try vibrate() API first (older devices)
            if (device.vibrateAttributes && device.vibrateAttributes.length > 0) {
              const vibrateArray = new Array(device.vibrateAttributes.length).fill(intensity);
              await device.vibrate(vibrateArray);
            }
            // Try scalar() API (newer devices)
            else if (device.messageAttributes?.ScalarCmd) {
              await device.scalar(intensity);
            }
          }
        } catch (error) {
          addLog(`æŒ¯å‹•éŒ¯èª¤: ${error.message}`);
        }
      }

      async function startVibration() {
        const slider = document.getElementById('vibrateSlider');
        const intensity = slider.value / 100;
        
        if (connectedDevices.length === 0) {
          addLog("ç„¡é€£æ¥è¨­å‚™");
          return;
        }
        
        stopPattern();
        await setVibration(intensity);
        addLog(`æŒ¯å‹•å¼·åº¦è¨­ç½®ç‚º ${slider.value}%`);
      }

      async function stopVibration() {
        stopPattern();
        
        if (connectedDevices.length === 0) return;
        
        try {
          for (const device of connectedDevices) {
            await device.stop();
          }
          document.getElementById('vibrateSlider').value = 0;
          document.getElementById('intensityDisplay').textContent = '0%';
          addLog("æŒ¯å‹•å·²åœæ­¢");
        } catch (error) {
          addLog(`åœæ­¢éŒ¯èª¤: ${error.message}`);
        }
      }

      function stopPattern() {
        if (patternInterval) {
          clearInterval(patternInterval);
          patternInterval = null;
          currentPattern = null;
        }
      }

      function startPulsePattern() {
        if (connectedDevices.length === 0) {
          addLog("ç„¡é€£æ¥è¨­å‚™");
          return;
        }
        
        stopPattern();
        currentPattern = 'pulse';
        addLog("å•Ÿå‹•è„ˆè¡æ¨¡å¼");
        
        let intensity = 0;
        let direction = 1;
        
        patternInterval = setInterval(async () => {
          intensity += direction * 0.05;
          if (intensity >= 1) {
            intensity = 1;
            direction = -1;
          } else if (intensity <= 0) {
            intensity = 0;
            direction = 1;
          }
          
          document.getElementById('vibrateSlider').value = intensity * 100;
          document.getElementById('intensityDisplay').textContent = Math.round(intensity * 100) + '%';
          
          try {
            await setVibration(intensity);
          } catch (error) {
            addLog(`æ¨¡å¼éŒ¯èª¤: ${error.message}`);
            stopPattern();
          }
        }, 100);
      }

      function startWavePattern() {
        if (connectedDevices.length === 0) {
          addLog("ç„¡é€£æ¥è¨­å‚™");
          return;
        }
        
        stopPattern();
        currentPattern = 'wave';
        addLog("å•Ÿå‹•æ³¢æµªæ¨¡å¼");
        
        let phase = 0;
        
        patternInterval = setInterval(async () => {
          const intensity = (Math.sin(phase) + 1) / 2;
          phase += 0.1;
          
          document.getElementById('vibrateSlider').value = intensity * 100;
          document.getElementById('intensityDisplay').textContent = Math.round(intensity * 100) + '%';
          
          try {
            await setVibration(intensity);
          } catch (error) {
            addLog(`æ¨¡å¼éŒ¯èª¤: ${error.message}`);
            stopPattern();
          }
        }, 50);
      }

      function startRandomPattern() {
        if (connectedDevices.length === 0) {
          addLog("ç„¡é€£æ¥è¨­å‚™");
          return;
        }
        
        stopPattern();
        currentPattern = 'random';
        addLog("å•Ÿå‹•éš¨æ©Ÿæ¨¡å¼");
        
        patternInterval = setInterval(async () => {
          const intensity = Math.random();
          
          document.getElementById('vibrateSlider').value = intensity * 100;
          document.getElementById('intensityDisplay').textContent = Math.round(intensity * 100) + '%';
          
          try {
            await setVibration(intensity);
          } catch (error) {
            addLog(`æ¨¡å¼éŒ¯èª¤: ${error.message}`);
            stopPattern();
          }
        }, 300);
      }

      // Initialize UI
      window.onload = async () => {
        addLog("ğŸš€ ERICAæ§åˆ¶å™¨åˆå§‹åŒ–ä¸­...");
        
        // è¼‰å…¥æ¨¡çµ„
        const modulesLoaded = await loadModules();
        if (!modulesLoaded) {
          addLog("âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨");
        }
        
        addLog("ğŸš€ ERICAæ§åˆ¶å™¨å·²å°±ç·’");
        
        // Buttons
        document.getElementById('scanBtn').onclick = startScanning;
        document.getElementById('disconnectBtn').onclick = disconnect;
        document.getElementById('vibrateBtn').onclick = startVibration;
        document.getElementById('stopBtn').onclick = stopVibration;
        document.getElementById('pulseBtn').onclick = startPulsePattern;
        document.getElementById('waveBtn').onclick = startWavePattern;
        document.getElementById('randomBtn').onclick = startRandomPattern;
        
        // Slider
        const slider = document.getElementById('vibrateSlider');
        slider.oninput = async () => {
          const intensity = slider.value / 100;
          document.getElementById('intensityDisplay').textContent = slider.value + '%';
          
          if (connectedDevices.length > 0 && !currentPattern) {
            await setVibration(intensity);
          }
        };
        
        // Clear logs
        document.getElementById('clearLogsBtn').onclick = () => {
          document.getElementById('logs').innerHTML = '';
          addLog("æ—¥èªŒå·²æ¸…é™¤");
        };
        
        // Instructions
        addLog("ä½¿ç”¨èªªæ˜:");
        addLog("1. ç¢ºä¿ERICAè¨­å‚™å·²é–‹å•Ÿé…å°æ¨¡å¼");
        addLog("2. é»æ“Šã€Œé–‹å§‹æƒæã€æŒ‰éˆ•");
        addLog("3. å¾è—ç‰™åˆ—è¡¨ä¸­é¸æ“‡ERICAè¨­å‚™");
        addLog("4. é€£æ¥å¾Œå³å¯æ§åˆ¶æŒ¯å‹•");
      };
    </script>
</body>
</html>