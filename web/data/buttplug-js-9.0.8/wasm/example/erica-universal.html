<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERICA Universal Bluetooth Controller</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
        height: calc(100vh - 40px);
      }
      
      .panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      }
      
      h1 {
        color: #333;
        margin-bottom: 20px;
        font-size: 28px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      h2 {
        color: #555;
        margin: 20px 0 15px;
        font-size: 18px;
        font-weight: 600;
      }
      
      .connection-mode {
        background: #f0f4f8;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
      }
      
      .mode-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      
      .mode-button {
        flex: 1;
        padding: 10px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .mode-button.active {
        border-color: #667eea;
        background: #667eea;
        color: white;
      }
      
      .mode-button.unavailable {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .browser-info {
        padding: 10px;
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 5px;
        margin-bottom: 15px;
        font-size: 14px;
      }
      
      .browser-info.success {
        background: #d4edda;
        border-color: #28a745;
      }
      
      .browser-info.error {
        background: #f8d7da;
        border-color: #dc3545;
      }
      
      .control-section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }
      
      button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin: 5px;
        transition: all 0.3s ease;
        font-weight: 500;
      }
      
      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      }
      
      button:active {
        transform: translateY(0);
      }
      
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
      }
      
      .btn-danger {
        background: linear-gradient(135deg, #f53844 0%, #df1f2f 100%);
        color: white;
      }
      
      .btn-warning {
        background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        color: white;
      }
      
      .btn-secondary {
        background: linear-gradient(135deg, #868e96 0%, #6c757d 100%);
        color: white;
      }
      
      .websocket-config {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid #ddd;
      }
      
      .websocket-config.show {
        display: block;
      }
      
      .websocket-config input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 10px;
      }
      
      input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
        margin: 20px 0;
      }
      
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        cursor: pointer;
      }
      
      input[type="range"]::-moz-range-thumb {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        cursor: pointer;
      }
      
      .intensity-display {
        font-size: 48px;
        font-weight: bold;
        text-align: center;
        color: #667eea;
        margin: 10px 0;
      }
      
      #deviceList {
        min-height: 100px;
        padding: 15px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
      }
      
      .device-item {
        padding: 15px;
        margin: 10px 0;
        background: #f5f5f5;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }
      
      .device-item strong {
        color: #333;
        font-size: 16px;
      }
      
      .status {
        padding: 10px 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: 500;
      }
      
      .status-connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .status-scanning {
        background: #cce5ff;
        color: #004085;
        border: 1px solid #b8daff;
      }
      
      .status-disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      .debug-logs {
        height: calc(100vh - 160px);
        overflow-y: auto;
        background: #f9f9f9;
        border-radius: 10px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      
      .debug-logs p {
        margin: 3px 0;
        padding: 3px 0;
        border-bottom: 1px solid #eee;
        word-wrap: break-word;
      }
      
      .pattern-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
      }
      
      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
        }
        
        .debug-logs {
          height: 300px;
        }
      }
    </style>
</head>
<body>
    <div class="container">
      <div class="panel">
        <h1>ğŸ® ERICA Universal Controller</h1>
        
        <div class="connection-mode">
          <h2>é€£æ¥æ¨¡å¼</h2>
          <div id="browserInfo" class="browser-info"></div>
          <div class="mode-selector">
            <button id="modeWebBluetooth" class="mode-button">
              ğŸ”µ WebBluetooth<br>
              <small>(ç›´æ¥é€£æ¥)</small>
            </button>
            <button id="modeWebSocket" class="mode-button">
              ğŸŒ WebSocket<br>
              <small>(é€éä¼ºæœå™¨)</small>
            </button>
          </div>
          <div id="websocketConfig" class="websocket-config">
            <label>WebSocket ä¼ºæœå™¨åœ°å€:</label>
            <input type="text" id="websocketUrl" value="ws://localhost:12345" placeholder="ws://localhost:12345">
            <button id="testWebSocketBtn" class="btn-secondary">æ¸¬è©¦é€£æ¥</button>
          </div>
        </div>
        
        <div class="control-section">
          <h2>ğŸ“¡ é€£æ¥æ§åˆ¶</h2>
          <div id="status" class="status status-disconnected">æœªé€£æ¥</div>
          <div style="margin-top: 15px;">
            <button id="scanBtn" class="btn-primary">é–‹å§‹æƒæ</button>
            <button id="disconnectBtn" class="btn-danger">æ–·é–‹é€£æ¥</button>
          </div>
        </div>
        
        <div class="control-section">
          <h2>ğŸ›ï¸ æŒ¯å‹•æ§åˆ¶</h2>
          <div class="intensity-display" id="intensityDisplay">0%</div>
          <input type="range" id="vibrateSlider" min="0" max="100" value="0">
          <div style="text-align: center;">
            <button id="vibrateBtn" class="btn-success">é–‹å§‹æŒ¯å‹•</button>
            <button id="stopBtn" class="btn-danger">åœæ­¢</button>
          </div>
          <div class="pattern-buttons">
            <button id="pulseBtn" class="btn-warning">è„ˆè¡æ¨¡å¼</button>
            <button id="waveBtn" class="btn-warning">æ³¢æµªæ¨¡å¼</button>
            <button id="randomBtn" class="btn-warning">éš¨æ©Ÿæ¨¡å¼</button>
          </div>
        </div>
        
        <div class="control-section">
          <h2>ğŸ“± å·²é€£æ¥è¨­å‚™</h2>
          <div id="deviceList">
            å°šç„¡é€£æ¥è¨­å‚™
          </div>
        </div>
      </div>
      
      <div class="panel">
        <h2>ğŸ” èª¿è©¦æ—¥èªŒ</h2>
        <button id="clearLogsBtn" style="margin-bottom: 10px;">æ¸…é™¤æ—¥èªŒ</button>
        <div id="logs" class="debug-logs"></div>
      </div>
    </div>

    <script type="module">
      // Import modules
      let ButtplugWasmClientConnector, ButtplugClient, ButtplugBrowserWebsocketClientConnector;
      
      // Global state
      let client = null;
      let isScanning = false;
      let connectedDevices = [];
      let currentPattern = null;
      let patternInterval = null;
      let isLoggingActivated = false;
      let connectionMode = 'webbluetooth'; // 'webbluetooth' or 'websocket'
      
      function addLog(message) {
        const logDiv = document.getElementById('logs');
        const p = document.createElement('p');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(p);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }
      
      // æª¢æ¸¬ç€è¦½å™¨æ”¯æ´
      function detectBrowserSupport() {
        const browserInfo = document.getElementById('browserInfo');
        const webBluetoothBtn = document.getElementById('modeWebBluetooth');
        const webSocketBtn = document.getElementById('modeWebSocket');
        
        const userAgent = navigator.userAgent;
        let browserName = 'Unknown';
        let isWebBluetoothSupported = false;
        
        if (userAgent.includes('Firefox')) {
          browserName = 'Firefox';
        } else if (userAgent.includes('Chrome')) {
          browserName = 'Chrome';
        } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
          browserName = 'Safari';
        } else if (userAgent.includes('Edge')) {
          browserName = 'Edge';
        }
        
        // æª¢æ¸¬ WebBluetooth æ”¯æ´
        if ('bluetooth' in navigator) {
          isWebBluetoothSupported = true;
          browserInfo.className = 'browser-info success';
          browserInfo.innerHTML = `âœ… ${browserName} æ”¯æ´ WebBluetooth`;
          webBluetoothBtn.classList.remove('unavailable');
        } else {
          browserInfo.className = 'browser-info error';
          browserInfo.innerHTML = `âš ï¸ ${browserName} ä¸æ”¯æ´ WebBluetooth<br>å»ºè­°ä½¿ç”¨ WebSocket æ¨¡å¼æˆ–åˆ‡æ›åˆ° Chrome/Edge`;
          webBluetoothBtn.classList.add('unavailable');
          
          // è‡ªå‹•åˆ‡æ›åˆ° WebSocket æ¨¡å¼
          connectionMode = 'websocket';
          webSocketBtn.classList.add('active');
          webBluetoothBtn.classList.remove('active');
          document.getElementById('websocketConfig').classList.add('show');
        }
        
        return isWebBluetoothSupported;
      }
      
      // åˆå§‹åŒ–æ¨¡çµ„
      async function initializeModules() {
        try {
          // è¼‰å…¥ WASM æ¨¡çµ„ï¼ˆç”¨æ–¼ WebBluetoothï¼‰
          if ('bluetooth' in navigator) {
            const wasmModule = await import("@wasm");
            ButtplugWasmClientConnector = wasmModule.ButtplugWasmClientConnector;
          }
          
          // è¼‰å…¥ Buttplug å®¢æˆ¶ç«¯
          const buttplugModule = await import("@buttplug");
          ButtplugClient = buttplugModule.ButtplugClient || buttplugModule.kn || buttplugModule.default?.ButtplugClient;
          ButtplugBrowserWebsocketClientConnector = buttplugModule.ButtplugBrowserWebsocketClientConnector || 
                                                   buttplugModule.default?.ButtplugBrowserWebsocketClientConnector;
          
          if (!ButtplugClient) {
            throw new Error("ButtplugClient not found in module exports");
          }
          
          addLog("âœ… æ¨¡çµ„è¼‰å…¥æˆåŠŸ");
        } catch (error) {
          addLog(`âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—: ${error.message}`);
          console.error(error);
        }
      }
      
      function updateStatus(message, className) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = `status ${className}`;
      }
      
      function updateDeviceList() {
        const deviceListDiv = document.getElementById('deviceList');
        if (connectedDevices.length === 0) {
          deviceListDiv.innerHTML = 'å°šç„¡é€£æ¥è¨­å‚™';
        } else {
          deviceListDiv.innerHTML = connectedDevices.map(device => {
            const vibratorCount = device.vibrateAttributes?.length || 
                                 device.messageAttributes?.ScalarCmd?.length || 0;
            return `<div class="device-item">
              <strong>${device.name}</strong> (ç´¢å¼•: ${device.index})
              <br>æŒ¯å‹•å™¨æ•¸é‡: ${vibratorCount}
              <br>é€£æ¥æ–¹å¼: ${connectionMode === 'webbluetooth' ? 'WebBluetooth' : 'WebSocket'}
            </div>`;
          }).join('');
        }
      }
      
      // WebBluetooth æƒæ
      async function startWebBluetoothScanning() {
        try {
          addLog("ä½¿ç”¨ WebBluetooth æ¨¡å¼æƒæ...");
          
          if (!ButtplugWasmClientConnector) {
            throw new Error("WebBluetooth æ¨¡çµ„æœªè¼‰å…¥");
          }
          
          client = new ButtplugClient("ERICA Controller");
          
          // Setup event listeners
          client.addListener('deviceadded', (device) => {
            addLog(`âœ… ç™¼ç¾è¨­å‚™: ${device.name}`);
            connectedDevices.push(device);
            updateDeviceList();
            updateStatus(`å·²é€£æ¥: ${device.name}`, 'status-connected');
          });
          
          client.addListener('deviceremoved', (device) => {
            addLog(`âŒ è¨­å‚™ç§»é™¤: ${device.name}`);
            connectedDevices = connectedDevices.filter(d => d.index !== device.index);
            updateDeviceList();
            if (connectedDevices.length === 0) {
              updateStatus('æœªé€£æ¥', 'status-disconnected');
            }
          });
          
          client.addListener('scanningfinished', () => {
            addLog("æƒæçµæŸ");
            isScanning = false;
            if (connectedDevices.length > 0) {
              updateStatus(`å·²é€£æ¥ ${connectedDevices.length} å€‹è¨­å‚™`, 'status-connected');
            } else {
              updateStatus('æœªæ‰¾åˆ°è¨­å‚™', 'status-disconnected');
            }
          });
          
          // Activate logging once
          if (!isLoggingActivated) {
            try {
              await ButtplugWasmClientConnector.activateLogging();
              isLoggingActivated = true;
            } catch (e) {
              addLog(`æ—¥èªŒæ¿€æ´»è­¦å‘Š: ${e.message}`);
            }
          }
          
          // Connect
          const connector = new ButtplugWasmClientConnector();
          await client.connect(connector);
          addLog("å·²é€£æ¥åˆ° WASM ä¼ºæœå™¨");
          
          // Start scanning
          updateStatus('æ­£åœ¨æƒæè¨­å‚™...', 'status-scanning');
          isScanning = true;
          await client.startScanning();
          addLog("é–‹å§‹æƒæè—ç‰™è¨­å‚™...");
          
          // Auto-stop after 10 seconds
          setTimeout(async () => {
            if (isScanning && client) {
              try {
                await client.stopScanning();
                isScanning = false;
              } catch (e) {
                addLog(`è‡ªå‹•åœæ­¢è­¦å‘Š: ${e.message}`);
              }
            }
          }, 10000);
          
        } catch (error) {
          addLog(`âŒ WebBluetooth éŒ¯èª¤: ${error.message}`);
          console.error(error);
          isScanning = false;
          client = null;
          updateStatus('é€£æ¥å¤±æ•—', 'status-disconnected');
        }
      }
      
      // WebSocket æƒæ
      async function startWebSocketScanning() {
        try {
          const websocketUrl = document.getElementById('websocketUrl').value;
          addLog(`ä½¿ç”¨ WebSocket æ¨¡å¼é€£æ¥åˆ°: ${websocketUrl}`);
          
          if (!ButtplugBrowserWebsocketClientConnector) {
            throw new Error("WebSocket æ¨¡çµ„æœªè¼‰å…¥");
          }
          
          client = new ButtplugClient("ERICA Controller");
          
          // Setup event listeners
          client.addListener('deviceadded', (device) => {
            addLog(`âœ… ç™¼ç¾è¨­å‚™: ${device.name}`);
            connectedDevices.push(device);
            updateDeviceList();
            updateStatus(`å·²é€£æ¥: ${device.name}`, 'status-connected');
          });
          
          client.addListener('deviceremoved', (device) => {
            addLog(`âŒ è¨­å‚™ç§»é™¤: ${device.name}`);
            connectedDevices = connectedDevices.filter(d => d.index !== device.index);
            updateDeviceList();
            if (connectedDevices.length === 0) {
              updateStatus('æœªé€£æ¥', 'status-disconnected');
            }
          });
          
          client.addListener('scanningfinished', () => {
            addLog("æƒæçµæŸ");
            isScanning = false;
            if (connectedDevices.length > 0) {
              updateStatus(`å·²é€£æ¥ ${connectedDevices.length} å€‹è¨­å‚™`, 'status-connected');
            } else {
              updateStatus('æœªæ‰¾åˆ°è¨­å‚™', 'status-disconnected');
            }
          });
          
          // Connect via WebSocket
          const connector = new ButtplugBrowserWebsocketClientConnector(websocketUrl);
          await client.connect(connector);
          addLog("å·²é€£æ¥åˆ° WebSocket ä¼ºæœå™¨");
          
          // Request device list
          await client.requestDeviceList();
          
          // Start scanning
          updateStatus('æ­£åœ¨æƒæè¨­å‚™...', 'status-scanning');
          isScanning = true;
          await client.startScanning();
          addLog("é–‹å§‹æƒæè¨­å‚™...");
          
          // Auto-stop after 10 seconds
          setTimeout(async () => {
            if (isScanning && client) {
              try {
                await client.stopScanning();
                isScanning = false;
              } catch (e) {
                addLog(`è‡ªå‹•åœæ­¢è­¦å‘Š: ${e.message}`);
              }
            }
          }, 10000);
          
        } catch (error) {
          addLog(`âŒ WebSocket éŒ¯èª¤: ${error.message}`);
          addLog("æç¤º: è«‹ç¢ºä¿ Intiface Central æˆ– Buttplug ä¼ºæœå™¨æ­£åœ¨é‹è¡Œ");
          console.error(error);
          isScanning = false;
          client = null;
          updateStatus('é€£æ¥å¤±æ•—', 'status-disconnected');
        }
      }
      
      // çµ±ä¸€çš„æƒæå…¥å£
      async function startScanning() {
        try {
          if (isScanning || client) {
            // Stop and restart
            if (client) {
              try {
                if (isScanning) await client.stopScanning();
                await client.disconnect();
              } catch (e) {
                addLog(`åœæ­¢è­¦å‘Š: ${e.message}`);
              }
              client = null;
              isScanning = false;
              connectedDevices = [];
              updateDeviceList();
            }
          }
          
          // æ ¹æ“šé¸æ“‡çš„æ¨¡å¼é–‹å§‹æƒæ
          if (connectionMode === 'webbluetooth') {
            await startWebBluetoothScanning();
          } else {
            await startWebSocketScanning();
          }
          
        } catch (error) {
          addLog(`âŒ éŒ¯èª¤: ${error.message}`);
          console.error(error);
        }
      }
      
      async function disconnect() {
        stopPattern();
        
        if (client) {
          try {
            if (isScanning) await client.stopScanning();
            await client.disconnect();
          } catch (error) {
            addLog(`æ–·é–‹è­¦å‘Š: ${error.message}`);
          } finally {
            client = null;
            connectedDevices = [];
            updateDeviceList();
            isScanning = false;
            updateStatus('æœªé€£æ¥', 'status-disconnected');
            addLog("å·²æ–·é–‹é€£æ¥");
          }
        }
      }
      
      async function setVibration(intensity) {
        if (connectedDevices.length === 0) return;
        
        try {
          for (const device of connectedDevices) {
            // Try vibrate() API first (older devices)
            if (device.vibrateAttributes && device.vibrateAttributes.length > 0) {
              const vibrateArray = new Array(device.vibrateAttributes.length).fill(intensity);
              await device.vibrate(vibrateArray);
            }
            // Try scalar() API (newer devices)
            else if (device.messageAttributes?.ScalarCmd) {
              await device.scalar(intensity);
            }
          }
        } catch (error) {
          addLog(`æŒ¯å‹•éŒ¯èª¤: ${error.message}`);
        }
      }
      
      async function startVibration() {
        const slider = document.getElementById('vibrateSlider');
        const intensity = slider.value / 100;
        
        if (connectedDevices.length === 0) {
          addLog("ç„¡é€£æ¥è¨­å‚™");
          return;
        }
        
        stopPattern();
        await setVibration(intensity);
        addLog(`æŒ¯å‹•å¼·åº¦è¨­ç½®ç‚º ${slider.value}%`);
      }
      
      async function stopVibration() {
        stopPattern();
        
        if (connectedDevices.length === 0) return;
        
        try {
          for (const device of connectedDevices) {
            await device.stop();
          }
          document.getElementById('vibrateSlider').value = 0;
          document.getElementById('intensityDisplay').textContent = '0%';
          addLog("æŒ¯å‹•å·²åœæ­¢");
        } catch (error) {
          addLog(`åœæ­¢éŒ¯èª¤: ${error.message}`);
        }
      }
      
      function stopPattern() {
        if (patternInterval) {
          clearInterval(patternInterval);
          patternInterval = null;
          currentPattern = null;
        }
      }
      
      function startPulsePattern() {
        if (connectedDevices.length === 0) {
          addLog("ç„¡é€£æ¥è¨­å‚™");
          return;
        }
        
        stopPattern();
        currentPattern = 'pulse';
        addLog("å•Ÿå‹•è„ˆè¡æ¨¡å¼");
        
        let intensity = 0;
        let direction = 1;
        
        patternInterval = setInterval(async () => {
          intensity += direction * 0.05;
          if (intensity >= 1) {
            intensity = 1;
            direction = -1;
          } else if (intensity <= 0) {
            intensity = 0;
            direction = 1;
          }
          
          document.getElementById('vibrateSlider').value = intensity * 100;
          document.getElementById('intensityDisplay').textContent = Math.round(intensity * 100) + '%';
          
          try {
            await setVibration(intensity);
          } catch (error) {
            addLog(`æ¨¡å¼éŒ¯èª¤: ${error.message}`);
            stopPattern();
          }
        }, 100);
      }
      
      function startWavePattern() {
        if (connectedDevices.length === 0) {
          addLog("ç„¡é€£æ¥è¨­å‚™");
          return;
        }
        
        stopPattern();
        currentPattern = 'wave';
        addLog("å•Ÿå‹•æ³¢æµªæ¨¡å¼");
        
        let phase = 0;
        
        patternInterval = setInterval(async () => {
          const intensity = (Math.sin(phase) + 1) / 2;
          phase += 0.1;
          
          document.getElementById('vibrateSlider').value = intensity * 100;
          document.getElementById('intensityDisplay').textContent = Math.round(intensity * 100) + '%';
          
          try {
            await setVibration(intensity);
          } catch (error) {
            addLog(`æ¨¡å¼éŒ¯èª¤: ${error.message}`);
            stopPattern();
          }
        }, 50);
      }
      
      function startRandomPattern() {
        if (connectedDevices.length === 0) {
          addLog("ç„¡é€£æ¥è¨­å‚™");
          return;
        }
        
        stopPattern();
        currentPattern = 'random';
        addLog("å•Ÿå‹•éš¨æ©Ÿæ¨¡å¼");
        
        patternInterval = setInterval(async () => {
          const intensity = Math.random();
          
          document.getElementById('vibrateSlider').value = intensity * 100;
          document.getElementById('intensityDisplay').textContent = Math.round(intensity * 100) + '%';
          
          try {
            await setVibration(intensity);
          } catch (error) {
            addLog(`æ¨¡å¼éŒ¯èª¤: ${error.message}`);
            stopPattern();
          }
        }, 300);
      }
      
      // æ¸¬è©¦ WebSocket é€£æ¥
      async function testWebSocketConnection() {
        const websocketUrl = document.getElementById('websocketUrl').value;
        addLog(`æ¸¬è©¦ WebSocket é€£æ¥: ${websocketUrl}`);
        
        try {
          const testSocket = new WebSocket(websocketUrl);
          
          testSocket.onopen = () => {
            addLog("âœ… WebSocket é€£æ¥æˆåŠŸ");
            testSocket.close();
          };
          
          testSocket.onerror = (error) => {
            addLog("âŒ WebSocket é€£æ¥å¤±æ•—");
            addLog("è«‹ç¢ºä¿ Intiface Central æ­£åœ¨é‹è¡Œ");
          };
          
          setTimeout(() => {
            if (testSocket.readyState === WebSocket.CONNECTING) {
              testSocket.close();
              addLog("âŒ WebSocket é€£æ¥è¶…æ™‚");
            }
          }, 5000);
          
        } catch (error) {
          addLog(`âŒ WebSocket æ¸¬è©¦éŒ¯èª¤: ${error.message}`);
        }
      }
      
      // Initialize UI
      window.onload = async () => {
        addLog("ğŸš€ ERICA Universal Controller åˆå§‹åŒ–ä¸­...");
        
        // æª¢æ¸¬ç€è¦½å™¨æ”¯æ´
        const isWebBluetoothSupported = detectBrowserSupport();
        
        // åˆå§‹åŒ–æ¨¡çµ„
        await initializeModules();
        
        // æ¨¡å¼åˆ‡æ›æŒ‰éˆ•
        document.getElementById('modeWebBluetooth').onclick = () => {
          if (!isWebBluetoothSupported) {
            addLog("âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ WebBluetooth");
            return;
          }
          connectionMode = 'webbluetooth';
          document.getElementById('modeWebBluetooth').classList.add('active');
          document.getElementById('modeWebSocket').classList.remove('active');
          document.getElementById('websocketConfig').classList.remove('show');
          addLog("åˆ‡æ›åˆ° WebBluetooth æ¨¡å¼");
        };
        
        document.getElementById('modeWebSocket').onclick = () => {
          connectionMode = 'websocket';
          document.getElementById('modeWebSocket').classList.add('active');
          document.getElementById('modeWebBluetooth').classList.remove('active');
          document.getElementById('websocketConfig').classList.add('show');
          addLog("åˆ‡æ›åˆ° WebSocket æ¨¡å¼");
        };
        
        // è¨­ç½®åˆå§‹æ¨¡å¼
        if (isWebBluetoothSupported) {
          document.getElementById('modeWebBluetooth').classList.add('active');
        } else {
          document.getElementById('modeWebSocket').classList.add('active');
          document.getElementById('websocketConfig').classList.add('show');
        }
        
        // Buttons
        document.getElementById('scanBtn').onclick = startScanning;
        document.getElementById('disconnectBtn').onclick = disconnect;
        document.getElementById('vibrateBtn').onclick = startVibration;
        document.getElementById('stopBtn').onclick = stopVibration;
        document.getElementById('pulseBtn').onclick = startPulsePattern;
        document.getElementById('waveBtn').onclick = startWavePattern;
        document.getElementById('randomBtn').onclick = startRandomPattern;
        document.getElementById('testWebSocketBtn').onclick = testWebSocketConnection;
        
        // Slider
        const slider = document.getElementById('vibrateSlider');
        slider.oninput = async () => {
          const intensity = slider.value / 100;
          document.getElementById('intensityDisplay').textContent = slider.value + '%';
          
          if (connectedDevices.length > 0 && !currentPattern) {
            await setVibration(intensity);
          }
        };
        
        // Clear logs
        document.getElementById('clearLogsBtn').onclick = () => {
          document.getElementById('logs').innerHTML = '';
          addLog("æ—¥èªŒå·²æ¸…é™¤");
        };
        
        // Instructions
        addLog("=== ä½¿ç”¨èªªæ˜ ===");
        if (isWebBluetoothSupported) {
          addLog("âœ… æ‚¨çš„ç€è¦½å™¨æ”¯æ´ WebBluetooth");
          addLog("å¯ä»¥é¸æ“‡ç›´æ¥é€£æ¥æˆ–é€éä¼ºæœå™¨é€£æ¥");
        } else {
          addLog("âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ WebBluetooth");
          addLog("è«‹ä½¿ç”¨ WebSocket æ¨¡å¼é€£æ¥");
          addLog("éœ€è¦å…ˆå•Ÿå‹• Intiface Central ä¼ºæœå™¨");
        }
        addLog("1. é¸æ“‡é€£æ¥æ¨¡å¼");
        addLog("2. é»æ“Šã€Œé–‹å§‹æƒæã€æŒ‰éˆ•");
        addLog("3. é¸æ“‡è¨­å‚™ä¸¦é€£æ¥");
        addLog("4. ä½¿ç”¨æ§åˆ¶ä»‹é¢æ“ä½œè¨­å‚™");
      };
    </script>
</body>
</html>