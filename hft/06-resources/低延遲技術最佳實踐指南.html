<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ä½å»¶é²æŠ€è¡“æœ€ä½³å¯¦è¸æŒ‡å— - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ä½å»¶é²æŠ€è¡“æœ€ä½³å¯¦è¸æŒ‡å—"><a class="header" href="#ä½å»¶é²æŠ€è¡“æœ€ä½³å¯¦è¸æŒ‡å—">ä½å»¶é²æŠ€è¡“æœ€ä½³å¯¦è¸æŒ‡å—</a></h1>
<blockquote>
<p>Building Low Latency Applications with C++ - é«˜é »äº¤æ˜“ç³»çµ±æ ¸å¿ƒæŠ€è¡“æ‰‹å†Š</p>
</blockquote>
<hr />
<h2 id="-ç›®éŒ„"><a class="header" href="#-ç›®éŒ„">ğŸ“‹ ç›®éŒ„</a></h2>
<ol>
<li><a href="#%E7%B0%A1%E4%BB%8B">ç°¡ä»‹</a></li>
<li><a href="#%E5%BB%B6%E9%81%B2%E7%9B%AE%E6%A8%99%E8%88%87%E6%B8%AC%E9%87%8F">å»¶é²ç›®æ¨™èˆ‡æ¸¬é‡</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B">æ ¸å¿ƒè³‡æ–™çµæ§‹</a></li>
<li><a href="#%E8%A8%98%E6%86%B6%E9%AB%94%E7%AE%A1%E7%90%86">è¨˜æ†¶é«”ç®¡ç†</a></li>
<li><a href="#%E5%9F%B7%E8%A1%8C%E7%B7%92%E7%AE%A1%E7%90%86">åŸ·è¡Œç·’ç®¡ç†</a></li>
<li><a href="#%E7%B6%B2%E8%B7%AF%E5%84%AA%E5%8C%96">ç¶²è·¯å„ªåŒ–</a></li>
<li><a href="#%E6%97%A5%E8%AA%8C%E7%B3%BB%E7%B5%B1">æ—¥èªŒç³»çµ±</a></li>
<li><a href="#%E7%B7%A8%E8%AD%AF%E5%99%A8%E5%84%AA%E5%8C%96">ç·¨è­¯å™¨å„ªåŒ–</a></li>
<li><a href="#%E7%A1%AC%E9%AB%94%E8%AA%BF%E5%84%AA">ç¡¬é«”èª¿å„ª</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E6%B8%AC%E8%A9%A6%E8%88%87%E7%9B%A3%E6%8E%A7">æ€§èƒ½æ¸¬è©¦èˆ‡ç›£æ§</a></li>
</ol>
<hr />
<h2 id="ç°¡ä»‹"><a class="header" href="#ç°¡ä»‹">ç°¡ä»‹</a></h2>
<p>æœ¬æŒ‡å—æ•´åˆäº†é«˜é »äº¤æ˜“ç³»çµ±é–‹ç™¼ä¸­çš„æ‰€æœ‰é—œéµä½å»¶é²æŠ€è¡“ï¼Œæ¶µè“‹å¾æ‡‰ç”¨å±¤åˆ°ç¡¬é«”å±¤çš„å®Œæ•´å„ªåŒ–ç­–ç•¥ã€‚</p>
<h3 id="ç›®æ¨™è®€è€…"><a class="header" href="#ç›®æ¨™è®€è€…">ç›®æ¨™è®€è€…</a></h3>
<ul>
<li>é«˜é »äº¤æ˜“ç³»çµ±é–‹ç™¼è€…</li>
<li>å³æ™‚ç³»çµ±å·¥ç¨‹å¸«</li>
<li>C++ æ•ˆèƒ½å„ªåŒ–å·¥ç¨‹å¸«</li>
<li>é‡åŒ–äº¤æ˜“åŸºç¤è¨­æ–½åœ˜éšŠ</li>
</ul>
<h3 id="å»¶é²ç­‰ç´šå®šç¾©"><a class="header" href="#å»¶é²ç­‰ç´šå®šç¾©">å»¶é²ç­‰ç´šå®šç¾©</a></h3>
<div class="table-wrapper"><table><thead><tr><th>å»¶é²ç¯„åœ</th><th>ç­‰ç´š</th><th>å…¸å‹æ‡‰ç”¨å ´æ™¯</th></tr></thead><tbody>
<tr><td><strong>&lt; 1Î¼s</strong></td><td>æ¥µä½å»¶é²</td><td>äº¤æ˜“æ‰€æ’®åˆå¼•æ“æ ¸å¿ƒé‚è¼¯</td></tr>
<tr><td><strong>1-10Î¼s</strong></td><td>è¶…ä½å»¶é²</td><td>è¨‚å–®ç°¿æ›´æ–°ã€å¸‚å ´æ•¸æ“šè™•ç†</td></tr>
<tr><td><strong>10-100Î¼s</strong></td><td>ä½å»¶é²</td><td>ç«¯åˆ°ç«¯è¨‚å–®å¾€è¿”ï¼ˆåŒæ©Ÿæˆ¿ï¼‰</td></tr>
<tr><td><strong>100-1000Î¼s</strong></td><td>ä¸€èˆ¬å»¶é²</td><td>è·¨åŸå¸‚è¨‚å–®å¾€è¿”</td></tr>
<tr><td><strong>&gt; 1ms</strong></td><td>ä¸å¯æ¥å—</td><td>éœ€è¦å„ªåŒ–</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="å»¶é²ç›®æ¨™èˆ‡æ¸¬é‡"><a class="header" href="#å»¶é²ç›®æ¨™èˆ‡æ¸¬é‡">å»¶é²ç›®æ¨™èˆ‡æ¸¬é‡</a></h2>
<h3 id="1-æ¸¬é‡åŸºç¤è¨­æ–½"><a class="header" href="#1-æ¸¬é‡åŸºç¤è¨­æ–½">1. æ¸¬é‡åŸºç¤è¨­æ–½</a></h3>
<pre><code class="language-cpp">// ä½¿ç”¨ RDTSCï¼ˆè®€å–æ™‚é–“æˆ³è¨˜è¨ˆæ•¸å™¨ï¼‰æ¸¬é‡ CPU é€±æœŸ
inline uint64_t rdtsc() {
    unsigned int lo, hi;
    __asm__ __volatile__ ("rdtsc" : "=a" (lo), "=d" (hi));
    return ((uint64_t)hi &lt;&lt; 32) | lo;
}

// ä½¿ç”¨ç¯„ä¾‹ï¼šæ¸¬é‡å‡½å¼å»¶é²
uint64_t start = rdtsc();
process_order();  // å¾…æ¸¬é‡çš„æ“ä½œ
uint64_t end = rdtsc();
uint64_t cycles = end - start;  // CPU é€±æœŸæ•¸

// æ›ç®—ç‚ºå¥ˆç§’ï¼ˆå‡è¨­ CPU é »ç‡ 3.0 GHzï¼‰
double ns = (cycles / 3.0);
</code></pre>
<h3 id="2-å»¶é²æ¸¬é‡æœ€ä½³å¯¦è¸"><a class="header" href="#2-å»¶é²æ¸¬é‡æœ€ä½³å¯¦è¸">2. å»¶é²æ¸¬é‡æœ€ä½³å¯¦è¸</a></h3>
<h4 id="-æ­£ç¢ºåšæ³•"><a class="header" href="#-æ­£ç¢ºåšæ³•">âœ… æ­£ç¢ºåšæ³•</a></h4>
<pre><code class="language-cpp">// ä½¿ç”¨é«˜ç²¾åº¦æ™‚é˜
#include "common/time_utils.h"

Nanos start = getCurrentNanos();
process_order();
Nanos latency = getCurrentNanos() - start;

// è¨˜éŒ„åˆ°å»¶é²ç›´æ–¹åœ–ï¼ˆP50/P99/P99.9ï¼‰
latency_histogram.record(latency);
</code></pre>
<h4 id="-å¸¸è¦‹éŒ¯èª¤"><a class="header" href="#-å¸¸è¦‹éŒ¯èª¤">âŒ å¸¸è¦‹éŒ¯èª¤</a></h4>
<pre><code class="language-cpp">// éŒ¯èª¤ 1ï¼šä½¿ç”¨ä½ç²¾åº¦æ™‚é˜
auto start = std::chrono::system_clock::now();  // ç²¾åº¦ä¸è¶³

// éŒ¯èª¤ 2ï¼šåœ¨é—œéµè·¯å¾‘ä¸­è¨˜éŒ„æ—¥èªŒ
logger.log("Order processed in %d ns\n", latency);  // å¢åŠ å»¶é²

// éŒ¯èª¤ 3ï¼šåªæ¸¬é‡å¹³å‡å€¼
double avg_latency = total_latency / count;  // å¿½ç•¥å°¾éƒ¨å»¶é²
</code></pre>
<h3 id="3-é—œéµæŒ‡æ¨™"><a class="header" href="#3-é—œéµæŒ‡æ¨™">3. é—œéµæŒ‡æ¨™</a></h3>
<div class="table-wrapper"><table><thead><tr><th>æŒ‡æ¨™</th><th>èªªæ˜</th><th>ç›®æ¨™å€¼</th></tr></thead><tbody>
<tr><td><strong>P50ï¼ˆä¸­ä½æ•¸ï¼‰</strong></td><td>50% çš„è«‹æ±‚å»¶é²ä½æ–¼æ­¤å€¼</td><td>&lt; 10Î¼s</td></tr>
<tr><td><strong>P99</strong></td><td>99% çš„è«‹æ±‚å»¶é²ä½æ–¼æ­¤å€¼</td><td>&lt; 50Î¼s</td></tr>
<tr><td><strong>P99.9</strong></td><td>99.9% çš„è«‹æ±‚å»¶é²ä½æ–¼æ­¤å€¼</td><td>&lt; 100Î¼s</td></tr>
<tr><td><strong>æœ€å¤§å»¶é²</strong></td><td>æœ€å·®æƒ…æ³å»¶é²</td><td>&lt; 500Î¼s</td></tr>
<tr><td><strong>æŠ–å‹•ï¼ˆJitterï¼‰</strong></td><td>P99 - P50</td><td>&lt; 40Î¼s</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="æ ¸å¿ƒè³‡æ–™çµæ§‹"><a class="header" href="#æ ¸å¿ƒè³‡æ–™çµæ§‹">æ ¸å¿ƒè³‡æ–™çµæ§‹</a></h2>
<h3 id="1-lock-free-queueç„¡é–ä½‡åˆ—"><a class="header" href="#1-lock-free-queueç„¡é–ä½‡åˆ—">1. Lock-Free Queueï¼ˆç„¡é–ä½‡åˆ—ï¼‰</a></h3>
<h4 id="è¨­è¨ˆåŸå‰‡"><a class="header" href="#è¨­è¨ˆåŸå‰‡">è¨­è¨ˆåŸå‰‡</a></h4>
<ul>
<li><strong>SPSCï¼ˆSingle Producer Single Consumerï¼‰</strong>ï¼šé¿å…è¤‡é›œçš„åŒæ­¥æ©Ÿåˆ¶</li>
<li><strong>Ring Buffer</strong>ï¼šå›ºå®šå¤§å°ï¼Œé¿å…å‹•æ…‹è¨˜æ†¶é«”åˆ†é…</li>
<li><strong>åŸå­æ“ä½œ</strong>ï¼šä½¿ç”¨ <code>std::atomic</code> ä¿è­‰å¯è¦‹æ€§</li>
</ul>
<h4 id="å¯¦ä½œè¦é»"><a class="header" href="#å¯¦ä½œè¦é»">å¯¦ä½œè¦é»</a></h4>
<pre><code class="language-cpp">template&lt;typename T&gt;
class LFQueue {
public:
    LFQueue(size_t size) : store_(size, T()) {}

    // Producer: å–å¾—ä¸‹ä¸€å€‹å¯å¯«å…¥ä½ç½®
    T* getNextToWriteTo() noexcept {
        return &amp;store_[next_write_index_];
    }

    // Producer: æ›´æ–°å¯«å…¥ç´¢å¼•
    void updateWriteIndex() noexcept {
        next_write_index_ = (next_write_index_ + 1) % store_.size();
        num_elements_++;  // åŸå­éå¢
    }

    // Consumer: å–å¾—ä¸‹ä¸€å€‹å¯è®€å–çš„å…ƒç´ 
    const T* getNextToRead() const noexcept {
        return (size() ? &amp;store_[next_read_index_] : nullptr);
    }

    // Consumer: æ›´æ–°è®€å–ç´¢å¼•
    void updateReadIndex() noexcept {
        next_read_index_ = (next_read_index_ + 1) % store_.size();
        num_elements_--;  // åŸå­éæ¸›
    }

private:
    std::vector&lt;T&gt; store_;  // Ring Buffer
    std::atomic&lt;size_t&gt; next_write_index_ = {0};
    std::atomic&lt;size_t&gt; next_read_index_ = {0};
    std::atomic&lt;size_t&gt; num_elements_ = {0};
};
</code></pre>
<h4 id="æ•ˆèƒ½ç‰¹æ€§"><a class="header" href="#æ•ˆèƒ½ç‰¹æ€§">æ•ˆèƒ½ç‰¹æ€§</a></h4>
<ul>
<li><strong>å…¥åˆ—/å‡ºåˆ—å»¶é²</strong>ï¼š&lt; 50ns</li>
<li><strong>ç„¡é–è¨­è¨ˆ</strong>ï¼šé¿å… Mutex é–‹éŠ·ï¼ˆ~25ns per lockï¼‰</li>
<li><strong>Cache å‹å–„</strong>ï¼šé€£çºŒè¨˜æ†¶é«”å­˜å–</li>
</ul>
<h4 id="-cache-false-sharing-é¢¨éšª"><a class="header" href="#-cache-false-sharing-é¢¨éšª">âš ï¸ Cache False Sharing é¢¨éšª</a></h4>
<pre><code class="language-cpp">// å•é¡Œï¼šnext_write_index_ å’Œ next_read_index_ å¯èƒ½åœ¨åŒä¸€ Cache Line
std::atomic&lt;size_t&gt; next_write_index_ = {0};  // Producer é »ç¹ä¿®æ”¹
std::atomic&lt;size_t&gt; next_read_index_ = {0};   // Consumer é »ç¹ä¿®æ”¹

// è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ alignas å¼·åˆ¶å°é½Šåˆ°ä¸åŒ Cache Line
alignas(64) std::atomic&lt;size_t&gt; next_write_index_ = {0};
alignas(64) std::atomic&lt;size_t&gt; next_read_index_ = {0};
</code></pre>
<hr />
<h3 id="2-memory-poolè¨˜æ†¶é«”æ± "><a class="header" href="#2-memory-poolè¨˜æ†¶é«”æ± ">2. Memory Poolï¼ˆè¨˜æ†¶é«”æ± ï¼‰</a></h3>
<h4 id="è¨­è¨ˆåŸå‰‡-1"><a class="header" href="#è¨­è¨ˆåŸå‰‡-1">è¨­è¨ˆåŸå‰‡</a></h4>
<ul>
<li><strong>é å…ˆé…ç½®</strong>ï¼šå•Ÿå‹•æ™‚ä¸€æ¬¡æ€§é…ç½®æ‰€æœ‰è¨˜æ†¶é«”</li>
<li><strong>Placement New</strong>ï¼šåªå‘¼å«å»ºæ§‹å­ï¼Œä¸åˆ†é…è¨˜æ†¶é«”</li>
<li><strong>O(1) åˆ†é…</strong>ï¼šä½¿ç”¨ç©ºé–’ä¸²åˆ—æˆ–ç·šæ€§æ¢æ¸¬</li>
</ul>
<h4 id="å¯¦ä½œè¦é»-1"><a class="header" href="#å¯¦ä½œè¦é»-1">å¯¦ä½œè¦é»</a></h4>
<pre><code class="language-cpp">template&lt;typename T&gt;
class MemPool {
public:
    explicit MemPool(size_t num_elems)
        : store_(num_elems, {T(), true}) {}

    // ä½¿ç”¨ Placement New åˆ†é…ç‰©ä»¶
    template&lt;typename... Args&gt;
    T* allocate(Args... args) noexcept {
        auto obj_block = &amp;(store_[next_free_index_]);
        T* ret = &amp;(obj_block-&gt;object_);
        ret = new (ret) T(args...);  // Placement New
        obj_block-&gt;is_free_ = false;
        updateNextFreeIndex();
        return ret;
    }

    // é‡‹æ”¾ç‰©ä»¶ï¼ˆæ¨™è¨˜ç‚ºç©ºé–’ï¼‰
    void deallocate(const T* elem) noexcept {
        const auto elem_index = (reinterpret_cast&lt;const ObjectBlock*&gt;(elem) - &amp;store_[0]);
        store_[elem_index].is_free_ = true;
    }

private:
    struct ObjectBlock {
        T object_;
        bool is_free_ = true;
    };

    std::vector&lt;ObjectBlock&gt; store_;
    size_t next_free_index_ = 0;
};
</code></pre>
<h4 id="æ•ˆèƒ½ç‰¹æ€§-1"><a class="header" href="#æ•ˆèƒ½ç‰¹æ€§-1">æ•ˆèƒ½ç‰¹æ€§</a></h4>
<ul>
<li><strong>åˆ†é…å»¶é²</strong>ï¼š&lt; 20nsï¼ˆvs malloc çš„ 50-10000nsï¼‰</li>
<li><strong>é›¶ç¢ç‰‡åŒ–</strong>ï¼šæ‰€æœ‰ç‰©ä»¶å¤§å°ç›¸åŒ</li>
<li><strong>å¯é æ¸¬å»¶é²</strong>ï¼šç„¡å‹•æ…‹åˆ†é…çš„è®Šç•°æ€§</li>
</ul>
<h4 id="å„ªåŒ–å»ºè­°"><a class="header" href="#å„ªåŒ–å»ºè­°">å„ªåŒ–å»ºè­°</a></h4>
<pre><code class="language-cpp">// æ–¹æ¡ˆ Aï¼šç·šæ€§æ¢æ¸¬ï¼ˆç•¶å‰å¯¦ä½œï¼‰
// - å„ªé»ï¼šå¯¦ä½œç°¡å–®ï¼ŒCache å‹å–„
// - ç¼ºé»ï¼šé«˜ä½¿ç”¨ç‡æ™‚é™ç´šåˆ° O(N)

// æ–¹æ¡ˆ Bï¼šFree Listï¼ˆéˆçµä¸²åˆ—ï¼‰
// - å„ªé»ï¼šO(1) åˆ†é…/é‡‹æ”¾
// - ç¼ºé»ï¼šéœ€é¡å¤–è¨˜æ†¶é«”ï¼ˆæŒ‡æ¨™ï¼‰ï¼ŒCache Miss é¢¨éšª

// å»ºè­°ï¼šä½¿ç”¨ç‡ &lt; 80% æ™‚ä½¿ç”¨ç·šæ€§æ¢æ¸¬ï¼Œ&gt; 80% æ™‚åˆ‡æ›åˆ° Free List
</code></pre>
<hr />
<h2 id="è¨˜æ†¶é«”ç®¡ç†"><a class="header" href="#è¨˜æ†¶é«”ç®¡ç†">è¨˜æ†¶é«”ç®¡ç†</a></h2>
<h3 id="1-è¨˜æ†¶é«”åˆ†é…ç­–ç•¥"><a class="header" href="#1-è¨˜æ†¶é«”åˆ†é…ç­–ç•¥">1. è¨˜æ†¶é«”åˆ†é…ç­–ç•¥</a></h3>
<h4 id="-æœ€ä½³å¯¦è¸"><a class="header" href="#-æœ€ä½³å¯¦è¸">âœ… æœ€ä½³å¯¦è¸</a></h4>
<pre><code class="language-cpp">// 1. å•Ÿå‹•æ™‚é å…ˆé…ç½®æ‰€æœ‰è¨˜æ†¶é«”
MemPool&lt;Order&gt; order_pool(10000);  // é é…ç½® 10000 å€‹è¨‚å–®

// 2. ä½¿ç”¨ Memory Pool è€Œé new/malloc
Order* order = order_pool.allocate(order_id, price, qty);

// 3. ä½¿ç”¨ std::vector::reserve é ç•™å®¹é‡
std::vector&lt;Order*&gt; orders;
orders.reserve(10000);  // é¿å…å‹•æ…‹æ“´å®¹
</code></pre>
<h4 id="-é¿å…çš„åšæ³•"><a class="header" href="#-é¿å…çš„åšæ³•">âŒ é¿å…çš„åšæ³•</a></h4>
<pre><code class="language-cpp">// éŒ¯èª¤ 1ï¼šåœ¨é—œéµè·¯å¾‘ä¸­ä½¿ç”¨ new/delete
Order* order = new Order(order_id, price, qty);  // malloc å»¶é²è®Šç•°å¤§

// éŒ¯èª¤ 2ï¼šå‹•æ…‹æ“´å®¹
std::vector&lt;Order*&gt; orders;  // é è¨­å®¹é‡ 0ï¼Œæœƒå¤šæ¬¡é‡æ–°é…ç½®

// éŒ¯èª¤ 3ï¼šé »ç¹çš„å°ç‰©ä»¶åˆ†é…
for (int i = 0; i &lt; 1000; i++) {
    std::string msg = "Order " + std::to_string(i);  // æ¯æ¬¡è¿´åœˆéƒ½åˆ†é…è¨˜æ†¶é«”
}
</code></pre>
<h3 id="2-memory-alignmentè¨˜æ†¶é«”å°é½Š"><a class="header" href="#2-memory-alignmentè¨˜æ†¶é«”å°é½Š">2. Memory Alignmentï¼ˆè¨˜æ†¶é«”å°é½Šï¼‰</a></h3>
<h4 id="cache-line-alignment"><a class="header" href="#cache-line-alignment">Cache Line Alignment</a></h4>
<pre><code class="language-cpp">// ç¢ºä¿é—œéµè³‡æ–™çµæ§‹å°é½Šåˆ° Cache Lineï¼ˆ64 bytesï¼‰
struct alignas(64) OrderBook {
    Price best_bid_;
    Price best_ask_;
    // ...
};

// é¿å… False Sharingï¼šä¸åŒåŸ·è¡Œç·’å­˜å–çš„è®Šæ•¸åˆ†é–‹å°é½Š
struct ThreadData {
    alignas(64) int thread1_counter_;  // Cache Line 1
    alignas(64) int thread2_counter_;  // Cache Line 2
};
</code></pre>
<h4 id="huge-pageså¤§é é¢"><a class="header" href="#huge-pageså¤§é é¢">Huge Pagesï¼ˆå¤§é é¢ï¼‰</a></h4>
<pre><code class="language-cpp">// ä½¿ç”¨ 2MB Huge Pages æ¸›å°‘ TLB Miss
// é…ç½®æ–¹æ³•ï¼ˆéœ€ root æ¬Šé™ï¼‰ï¼š
// echo 1024 &gt; /proc/sys/vm/nr_hugepages

// C++ ç¨‹å¼ä¸­ä½¿ç”¨ï¼š
void* ptr = mmap(nullptr, size,
                 PROT_READ | PROT_WRITE,
                 MAP_PRIVATE | MAP_ANONYMOUS | MAP_HUGETLB,
                 -1, 0);
</code></pre>
<hr />
<h2 id="åŸ·è¡Œç·’ç®¡ç†"><a class="header" href="#åŸ·è¡Œç·’ç®¡ç†">åŸ·è¡Œç·’ç®¡ç†</a></h2>
<h3 id="1-thread-affinitycpu-è¦ªå’ŒåŠ›"><a class="header" href="#1-thread-affinitycpu-è¦ªå’ŒåŠ›">1. Thread Affinityï¼ˆCPU è¦ªå’ŒåŠ›ï¼‰</a></h3>
<h4 id="è¨­å®š-cpu-ç¶å®š"><a class="header" href="#è¨­å®š-cpu-ç¶å®š">è¨­å®š CPU ç¶å®š</a></h4>
<pre><code class="language-cpp">// å°‡åŸ·è¡Œç·’ç¶å®šåˆ°æŒ‡å®š CPU æ ¸å¿ƒ
bool setThreadCore(int core_id) {
    cpu_set_t cpuset;
    CPU_ZERO(&amp;cpuset);
    CPU_SET(core_id, &amp;cpuset);
    return (pthread_setaffinity_np(pthread_self(), sizeof(cpu_set_t), &amp;cpuset) == 0);
}

// ä½¿ç”¨ç¯„ä¾‹ï¼š
// - æ ¸å¿ƒ 2ï¼šäº¤æ˜“å¼•æ“ä¸»åŸ·è¡Œç·’
// - æ ¸å¿ƒ 3ï¼šå¸‚å ´æ•¸æ“šæ¥æ”¶åŸ·è¡Œç·’
// - æ ¸å¿ƒ 4ï¼šè¨‚å–®é–˜é“åŸ·è¡Œç·’
setThreadCore(2);
</code></pre>
<h4 id="æ•ˆèƒ½å½±éŸ¿"><a class="header" href="#æ•ˆèƒ½å½±éŸ¿">æ•ˆèƒ½å½±éŸ¿</a></h4>
<ul>
<li><strong>æ¸›å°‘ä¸Šä¸‹æ–‡åˆ‡æ›</strong>ï¼šé¿å…åŸ·è¡Œç·’åœ¨ä¸åŒæ ¸å¿ƒé–“é·ç§»</li>
<li><strong>æ¸›å°‘ Cache Miss</strong>ï¼šL1/L2 Cache å‘½ä¸­ç‡æé«˜ â†’ å»¶é²æ¸›å°‘ 10-50ns</li>
<li><strong>é æ¸¬æ€§å»¶é²</strong>ï¼šå›ºå®šæ ¸å¿ƒ â†’ å»¶é²è®Šç•°é™ä½ 30-50%</li>
</ul>
<h4 id="cpu-isolationæ ¸å¿ƒéš”é›¢"><a class="header" href="#cpu-isolationæ ¸å¿ƒéš”é›¢">CPU Isolationï¼ˆæ ¸å¿ƒéš”é›¢ï¼‰</a></h4>
<pre><code class="language-bash"># GRUB é…ç½®ï¼ˆ/etc/default/grubï¼‰
GRUB_CMDLINE_LINUX="isolcpus=2,3,4"

# é‡æ–°ç”Ÿæˆ GRUB é…ç½®
sudo update-grub
sudo reboot

# é©—è­‰éš”é›¢æ•ˆæœ
cat /sys/devices/system/cpu/isolated
</code></pre>
<hr />
<h3 id="2-åŸ·è¡Œç·’å„ªå…ˆç´š"><a class="header" href="#2-åŸ·è¡Œç·’å„ªå…ˆç´š">2. åŸ·è¡Œç·’å„ªå…ˆç´š</a></h3>
<pre><code class="language-cpp">// è¨­å®šå³æ™‚å„ªå…ˆç´šï¼ˆSCHED_FIFOï¼‰
void setRealtimePriority(int priority) {
    struct sched_param param;
    param.sched_priority = priority;  // 1-99ï¼Œ99 ç‚ºæœ€é«˜

    if (sched_setscheduler(0, SCHED_FIFO, &amp;param) != 0) {
        perror("sched_setscheduler failed");
    }
}

// ä½¿ç”¨ç¯„ä¾‹ï¼ˆéœ€ root æ¬Šé™æˆ– CAP_SYS_NICEï¼‰
setRealtimePriority(99);  // äº¤æ˜“å¼•æ“ä½¿ç”¨æœ€é«˜å„ªå…ˆç´š
</code></pre>
<hr />
<h2 id="ç¶²è·¯å„ªåŒ–"><a class="header" href="#ç¶²è·¯å„ªåŒ–">ç¶²è·¯å„ªåŒ–</a></h2>
<h3 id="1-tcp-socket-å„ªåŒ–"><a class="header" href="#1-tcp-socket-å„ªåŒ–">1. TCP Socket å„ªåŒ–</a></h3>
<h4 id="é—œéµåƒæ•¸è¨­å®š"><a class="header" href="#é—œéµåƒæ•¸è¨­å®š">é—œéµåƒæ•¸è¨­å®š</a></h4>
<pre><code class="language-cpp">int fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);

// 1. TCP_NODELAYï¼šé—œé–‰ Nagle æ¼”ç®—æ³•
int one = 1;
setsockopt(fd, IPPROTO_TCP, TCP_NODELAY, &amp;one, sizeof(one));

// 2. è¨­å®šå¤§ç·©è¡å€ï¼ˆ64 MBï¼‰
int buf_size = 64 * 1024 * 1024;
setsockopt(fd, SOL_SOCKET, SO_RCVBUF, &amp;buf_size, sizeof(buf_size));
setsockopt(fd, SOL_SOCKET, SO_SNDBUF, &amp;buf_size, sizeof(buf_size));

// 3. éé˜»å¡æ¨¡å¼
int flags = fcntl(fd, F_GETFL, 0);
fcntl(fd, F_SETFL, flags | O_NONBLOCK);

// 4. SO_REUSEADDRï¼šå¿«é€Ÿé‡å•Ÿ
setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, &amp;one, sizeof(one));
</code></pre>
<h4 id="æ•ˆèƒ½å½±éŸ¿-1"><a class="header" href="#æ•ˆèƒ½å½±éŸ¿-1">æ•ˆèƒ½å½±éŸ¿</a></h4>
<div class="table-wrapper"><table><thead><tr><th>å„ªåŒ–é …ç›®</th><th>å»¶é²é™ä½</th><th>èªªæ˜</th></tr></thead><tbody>
<tr><td><strong>TCP_NODELAY</strong></td><td>~40Î¼s</td><td>ç«‹å³ç™¼é€å°å°åŒ…ï¼Œä¸ç­‰å¾… ACK</td></tr>
<tr><td><strong>å¤§ç·©è¡å€</strong></td><td>~20Î¼s</td><td>æ¸›å°‘ç³»çµ±å‘¼å«æ¬¡æ•¸</td></tr>
<tr><td><strong>éé˜»å¡ I/O</strong></td><td>N/A</td><td>é¿å…é˜»å¡ä¸»åŸ·è¡Œç·’</td></tr>
</tbody></table>
</div>
<hr />
<h3 id="2-udp-multicast-å„ªåŒ–"><a class="header" href="#2-udp-multicast-å„ªåŒ–">2. UDP Multicast å„ªåŒ–</a></h3>
<pre><code class="language-cpp">// UDP Multicast æ¥æ”¶é…ç½®
SocketCfg mcast_cfg{
    .ip_ = "239.255.0.1",         // Multicast ç¾¤çµ„
    .iface_ = "eth0",
    .port_ = 9090,
    .is_udp_ = true,
    .is_listening_ = true,
    .needs_so_timestamp_ = true   // å•Ÿç”¨æ ¸å¿ƒæ™‚é–“æˆ³è¨˜
};

int fd = createSocket(logger, mcast_cfg);

// åŠ å…¥ Multicast ç¾¤çµ„
ip_mreq mreq;
mreq.imr_multiaddr.s_addr = inet_addr("239.255.0.1");
mreq.imr_interface.s_addr = htonl(INADDR_ANY);
setsockopt(fd, IPPROTO_IP, IP_ADD_MEMBERSHIP, &amp;mreq, sizeof(mreq));
</code></pre>
<h4 id="multicast-æœ€ä½³å¯¦è¸"><a class="header" href="#multicast-æœ€ä½³å¯¦è¸">Multicast æœ€ä½³å¯¦è¸</a></h4>
<ul>
<li><strong>ä½¿ç”¨å°ˆç”¨ç¶²è·¯ä»‹é¢</strong>ï¼šé¿å…èˆ‡å…¶ä»–æµé‡ç«¶çˆ­</li>
<li><strong>å•Ÿç”¨ SO_TIMESTAMP</strong>ï¼šæ¸¬é‡å°åŒ…åˆ°é”æ™‚é–“</li>
<li><strong>èª¿æ•´æ¥æ”¶ç·©è¡å€</strong>ï¼šè™•ç†çªç™¼æµé‡</li>
</ul>
<hr />
<h3 id="3-kernel-bypassæ ¸å¿ƒç¹é"><a class="header" href="#3-kernel-bypassæ ¸å¿ƒç¹é">3. Kernel Bypassï¼ˆæ ¸å¿ƒç¹éï¼‰</a></h3>
<h4 id="dpdkdata-plane-development-kit"><a class="header" href="#dpdkdata-plane-development-kit">DPDKï¼ˆData Plane Development Kitï¼‰</a></h4>
<pre><code class="language-cpp">// DPDK åˆå§‹åŒ–ï¼ˆç°¡åŒ–ç¯„ä¾‹ï¼‰
int ret = rte_eal_init(argc, argv);
struct rte_mempool* mbuf_pool = rte_pktmbuf_pool_create(...);

// æ¥æ”¶å°åŒ…ï¼ˆé›¶æ‹·è²ï¼‰
struct rte_mbuf* pkts[BURST_SIZE];
uint16_t nb_rx = rte_eth_rx_burst(port_id, 0, pkts, BURST_SIZE);

for (int i = 0; i &lt; nb_rx; i++) {
    process_packet(pkts[i]);  // ç›´æ¥å­˜å–ç¶²å¡ç·©è¡å€
}
</code></pre>
<h4 id="æ•ˆèƒ½æå‡"><a class="header" href="#æ•ˆèƒ½æå‡">æ•ˆèƒ½æå‡</a></h4>
<ul>
<li><strong>å»¶é²é™ä½</strong>ï¼šå¾ ~10Î¼s é™è‡³ ~1Î¼s</li>
<li><strong>ååé‡æå‡</strong>ï¼š10å€ä»¥ä¸Šï¼ˆ1Gbps â†’ 10Gbpsï¼‰</li>
<li><strong>CPU ä½¿ç”¨ç‡</strong>ï¼šé™ä½ 30-50%ï¼ˆé¿å…æ ¸å¿ƒé–‹éŠ·ï¼‰</li>
</ul>
<hr />
<h2 id="æ—¥èªŒç³»çµ±"><a class="header" href="#æ—¥èªŒç³»çµ±">æ—¥èªŒç³»çµ±</a></h2>
<h3 id="1-ç„¡é–-logger-è¨­è¨ˆ"><a class="header" href="#1-ç„¡é–-logger-è¨­è¨ˆ">1. ç„¡é– Logger è¨­è¨ˆ</a></h3>
<h4 id="æ¶æ§‹"><a class="header" href="#æ¶æ§‹">æ¶æ§‹</a></h4>
<pre><code class="language-cpp">// Producerï¼ˆäº¤æ˜“åŸ·è¡Œç·’ï¼‰ï¼šéé˜»å¡å¯«å…¥
logger.log("Order ID: % Price: % Qty: %\n", order_id, price, qty);
// å»¶é²ï¼š&lt; 100nsï¼ˆåƒ…å¯«å…¥ LFQueueï¼‰

// Consumerï¼ˆæ—¥èªŒåŸ·è¡Œç·’ï¼‰ï¼šæ‰¹æ¬¡åˆ·æ–°
void flushQueue() {
    while (running_) {
        // æ‰¹æ¬¡è®€å–æ‰€æœ‰æ—¥èªŒ
        for (auto next = queue_.getNextToRead(); queue_.size(); next = queue_.getNextToRead()) {
            file_ &lt;&lt; format(next);  // æ ¼å¼åŒ–è¼¸å‡º
            queue_.updateReadIndex();
        }
        file_.flush();  // æ‰¹æ¬¡ flush
        std::this_thread::sleep_for(10ms);  // 10ms é–“éš”
    }
}
</code></pre>
<h4 id="é—œéµå„ªåŒ–"><a class="header" href="#é—œéµå„ªåŒ–">é—œéµå„ªåŒ–</a></h4>
<ul>
<li><strong>Tagged Union</strong>ï¼šé¿å…è™›æ“¬å‡½å¼é–‹éŠ·</li>
<li><strong>Lock-Free Queue</strong>ï¼šé›¶é–ç«¶çˆ­</li>
<li><strong>æ‰¹æ¬¡ Flush</strong>ï¼šæ¸›å°‘ I/O ç³»çµ±å‘¼å«</li>
</ul>
<hr />
<h3 id="2-æ—¥èªŒç­‰ç´šæ§åˆ¶"><a class="header" href="#2-æ—¥èªŒç­‰ç´šæ§åˆ¶">2. æ—¥èªŒç­‰ç´šæ§åˆ¶</a></h3>
<pre><code class="language-cpp">enum class LogLevel { DEBUG, INFO, WARN, ERROR };

// ç·¨è­¯æœŸæ—¥èªŒéæ¿¾
#ifdef NDEBUG
#define LOG_DEBUG(...)  // ç©ºæ“ä½œ
#else
#define LOG_DEBUG(...) logger.log(__VA_ARGS__)
#endif

// åŸ·è¡ŒæœŸæ—¥èªŒéæ¿¾
if (log_level &gt;= LogLevel::INFO) {
    logger.log("Order filled: %\n", order_id);
}
</code></pre>
<hr />
<h2 id="ç·¨è­¯å™¨å„ªåŒ–"><a class="header" href="#ç·¨è­¯å™¨å„ªåŒ–">ç·¨è­¯å™¨å„ªåŒ–</a></h2>
<h3 id="1-åˆ†æ”¯é æ¸¬æç¤º"><a class="header" href="#1-åˆ†æ”¯é æ¸¬æç¤º">1. åˆ†æ”¯é æ¸¬æç¤º</a></h3>
<pre><code class="language-cpp">// LIKELY/UNLIKELY å·¨é›†
#define LIKELY(x)   __builtin_expect(!!(x), 1)
#define UNLIKELY(x) __builtin_expect(!!(x), 0)

// ä½¿ç”¨ç¯„ä¾‹
if (LIKELY(order != nullptr)) {
    process_order(order);  // ç†±è·¯å¾‘
}

if (UNLIKELY(error)) {
    handle_error();  // å†·è·¯å¾‘
}
</code></pre>
<h4 id="æ•ˆèƒ½å½±éŸ¿-2"><a class="header" href="#æ•ˆèƒ½å½±éŸ¿-2">æ•ˆèƒ½å½±éŸ¿</a></h4>
<ul>
<li><strong>åˆ†æ”¯é æ¸¬æˆåŠŸ</strong>ï¼šç¯€çœ 5-20 å€‹ CPU é€±æœŸ</li>
<li><strong>åˆ†æ”¯é æ¸¬å¤±æ•—</strong>ï¼šæ‡²ç½° 10-40 å€‹ CPU é€±æœŸ</li>
<li><strong>å»ºè­°</strong>ï¼šåƒ…ç”¨æ–¼ &gt;90% æ©Ÿç‡çš„åˆ†æ”¯</li>
</ul>
<hr />
<h3 id="2-inline-èˆ‡-constexpr"><a class="header" href="#2-inline-èˆ‡-constexpr">2. Inline èˆ‡ Constexpr</a></h3>
<pre><code class="language-cpp">// å¼·åˆ¶å…§è¯
inline __attribute__((always_inline))
bool is_valid(Price price) {
    return price &gt; 0 &amp;&amp; price &lt; MAX_PRICE;
}

// ç·¨è­¯æœŸå¸¸æ•¸
constexpr size_t MAX_ORDERS = 10000;
constexpr Nanos NANOS_TO_MICROS = 1000;

// ç·¨è­¯æœŸè¨ˆç®—
constexpr Nanos convert_to_micros(Nanos ns) {
    return ns / NANOS_TO_MICROS;
}
</code></pre>
<hr />
<h3 id="3-ç·¨è­¯é¸é …"><a class="header" href="#3-ç·¨è­¯é¸é …">3. ç·¨è­¯é¸é …</a></h3>
<pre><code class="language-bash"># GCC/Clang å„ªåŒ–é¸é …
CXXFLAGS="-O3 -march=native -mtune=native -flto -ffast-math"

# èªªæ˜ï¼š
# -O3: æœ€é«˜å„ªåŒ–ç­‰ç´š
# -march=native: é‡å°ç•¶å‰ CPU å¾®æ¶æ§‹å„ªåŒ–
# -mtune=native: èª¿æ•´æŒ‡ä»¤æ’ç¨‹
# -flto: Link-Time Optimization
# -ffast-math: å¿«é€Ÿæµ®é»é‹ç®—ï¼ˆçŠ§ç‰²ç²¾åº¦ï¼‰
</code></pre>
<hr />
<h2 id="ç¡¬é«”èª¿å„ª"><a class="header" href="#ç¡¬é«”èª¿å„ª">ç¡¬é«”èª¿å„ª</a></h2>
<h3 id="1-cpu-è¨­å®š"><a class="header" href="#1-cpu-è¨­å®š">1. CPU è¨­å®š</a></h3>
<h4 id="turbo-boost-èˆ‡-c-states"><a class="header" href="#turbo-boost-èˆ‡-c-states">Turbo Boost èˆ‡ C-States</a></h4>
<pre><code class="language-bash"># é—œé–‰ Turbo Boostï¼ˆä¿æŒå›ºå®šé »ç‡ï¼‰
echo 1 &gt; /sys/devices/system/cpu/intel_pstate/no_turbo

# é—œé–‰ C-Statesï¼ˆç¦ç”¨ä½åŠŸè€—æ¨¡å¼ï¼‰
for i in /sys/devices/system/cpu/cpu*/cpuidle/state*/disable; do
    echo 1 &gt; $i
done

# è¨­å®š CPU Governor ç‚º performance
cpupower frequency-set -g performance
</code></pre>
<h4 id="æ•ˆèƒ½å½±éŸ¿-3"><a class="header" href="#æ•ˆèƒ½å½±éŸ¿-3">æ•ˆèƒ½å½±éŸ¿</a></h4>
<ul>
<li><strong>å»¶é²é™ä½</strong>ï¼š20-50Î¼sï¼ˆé¿å…é »ç‡åˆ‡æ›ï¼‰</li>
<li><strong>å»¶é²è®Šç•°é™ä½</strong>ï¼š30-60%ï¼ˆå›ºå®šé »ç‡ï¼‰</li>
</ul>
<hr />
<h3 id="2-numa-æ‹“æ¨¸å„ªåŒ–"><a class="header" href="#2-numa-æ‹“æ¨¸å„ªåŒ–">2. NUMA æ‹“æ¨¸å„ªåŒ–</a></h3>
<pre><code class="language-bash"># æŸ¥çœ‹ NUMA ç¯€é»
numactl --hardware

# ç¶å®šç¨‹å¼åˆ°ç‰¹å®š NUMA ç¯€é»
numactl --cpunodebind=0 --membind=0 ./trading_engine

# æª¢æŸ¥ NUMA çµ±è¨ˆ
numastat -p $(pidof trading_engine)
</code></pre>
<hr />
<h3 id="3-ç¶²å¡èª¿å„ª"><a class="header" href="#3-ç¶²å¡èª¿å„ª">3. ç¶²å¡èª¿å„ª</a></h3>
<pre><code class="language-bash"># å¢åŠ æ¥æ”¶ç·©è¡å€
ethtool -G eth0 rx 4096 tx 4096

# å•Ÿç”¨ RSSï¼ˆReceive Side Scalingï¼‰
ethtool -X eth0 equal 4

# é—œé–‰ä¸­æ–·èšåˆï¼ˆé™ä½å»¶é²ï¼‰
ethtool -C eth0 rx-usecs 0 tx-usecs 0

# ç¶å®šç¶²å¡ä¸­æ–·åˆ°æŒ‡å®š CPU
echo 1 &gt; /proc/irq/123/smp_affinity
</code></pre>
<hr />
<h2 id="æ€§èƒ½æ¸¬è©¦èˆ‡ç›£æ§"><a class="header" href="#æ€§èƒ½æ¸¬è©¦èˆ‡ç›£æ§">æ€§èƒ½æ¸¬è©¦èˆ‡ç›£æ§</a></h2>
<h3 id="1-å»¶é²ç›´æ–¹åœ–"><a class="header" href="#1-å»¶é²ç›´æ–¹åœ–">1. å»¶é²ç›´æ–¹åœ–</a></h3>
<pre><code class="language-cpp">class LatencyHistogram {
public:
    void record(Nanos latency) {
        latencies_.push_back(latency);
    }

    void print_percentiles() {
        std::sort(latencies_.begin(), latencies_.end());
        size_t n = latencies_.size();

        std::cout &lt;&lt; "P50:    " &lt;&lt; latencies_[n * 0.50] &lt;&lt; " ns\n";
        std::cout &lt;&lt; "P90:    " &lt;&lt; latencies_[n * 0.90] &lt;&lt; " ns\n";
        std::cout &lt;&lt; "P99:    " &lt;&lt; latencies_[n * 0.99] &lt;&lt; " ns\n";
        std::cout &lt;&lt; "P99.9:  " &lt;&lt; latencies_[n * 0.999] &lt;&lt; " ns\n";
        std::cout &lt;&lt; "P99.99: " &lt;&lt; latencies_[n * 0.9999] &lt;&lt; " ns\n";
        std::cout &lt;&lt; "Max:    " &lt;&lt; latencies_[n - 1] &lt;&lt; " ns\n";
    }

private:
    std::vector&lt;Nanos&gt; latencies_;
};
</code></pre>
<hr />
<h3 id="2-perf-å·¥å…·ä½¿ç”¨"><a class="header" href="#2-perf-å·¥å…·ä½¿ç”¨">2. perf å·¥å…·ä½¿ç”¨</a></h3>
<pre><code class="language-bash"># è¨˜éŒ„ CPU æ•ˆèƒ½è¨ˆæ•¸å™¨
perf stat -e cycles,instructions,cache-misses,branch-misses ./trading_engine

# æ¡æ¨£åˆ†æç†±é»å‡½å¼
perf record -g ./trading_engine
perf report

# åˆ†æ Cache Miss
perf stat -e L1-dcache-load-misses,LLC-load-misses ./trading_engine
</code></pre>
<hr />
<h2 id="æª¢æŸ¥æ¸…å–®"><a class="header" href="#æª¢æŸ¥æ¸…å–®">æª¢æŸ¥æ¸…å–®</a></h2>
<h3 id="å•Ÿå‹•å‰æª¢æŸ¥"><a class="header" href="#å•Ÿå‹•å‰æª¢æŸ¥">å•Ÿå‹•å‰æª¢æŸ¥</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
æ‰€æœ‰åŸ·è¡Œç·’å·²ç¶å®šåˆ°å°ˆç”¨ CPU æ ¸å¿ƒ</li>
<li><input disabled="" type="checkbox"/>
CPU Governor è¨­å®šç‚º performance</li>
<li><input disabled="" type="checkbox"/>
Turbo Boost èˆ‡ C-States å·²é—œé–‰</li>
<li><input disabled="" type="checkbox"/>
ç¶²å¡ä¸­æ–·å·²ç¶å®šåˆ°å°ˆç”¨ CPU</li>
<li><input disabled="" type="checkbox"/>
Memory Pool å·²é å…ˆé…ç½®</li>
<li><input disabled="" type="checkbox"/>
Lock-Free Queue å¤§å°å·²èª¿æ•´</li>
<li><input disabled="" type="checkbox"/>
æ—¥èªŒç­‰ç´šè¨­å®šç‚º INFO æˆ– WARN</li>
</ul>
<h3 id="åŸ·è¡Œæ™‚ç›£æ§"><a class="header" href="#åŸ·è¡Œæ™‚ç›£æ§">åŸ·è¡Œæ™‚ç›£æ§</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
P99 å»¶é² &lt; ç›®æ¨™å€¼</li>
<li><input disabled="" type="checkbox"/>
CPU ä½¿ç”¨ç‡ &lt; 80%</li>
<li><input disabled="" type="checkbox"/>
Cache Miss ç‡ &lt; 5%</li>
<li><input disabled="" type="checkbox"/>
ç„¡è¨˜æ†¶é«”åˆ†é…ï¼ˆmalloc/free å‘¼å«æ¬¡æ•¸ç‚º 0ï¼‰</li>
<li><input disabled="" type="checkbox"/>
ç„¡ä¸Šä¸‹æ–‡åˆ‡æ›ï¼ˆvoluntary context switches &lt; 10/sï¼‰</li>
</ul>
<hr />
<h2 id="åƒè€ƒè³‡æº"><a class="header" href="#åƒè€ƒè³‡æº">åƒè€ƒè³‡æº</a></h2>
<h3 id="æ›¸ç±"><a class="header" href="#æ›¸ç±">æ›¸ç±</a></h3>
<ul>
<li>ã€ŠSystems Performance: Enterprise and the Cloudã€‹ - Brendan Gregg</li>
<li>ã€ŠThe Art of Multiprocessor Programmingã€‹ - Maurice Herlihy</li>
</ul>
<h3 id="å·¥å…·"><a class="header" href="#å·¥å…·">å·¥å…·</a></h3>
<ul>
<li><strong>perf</strong>ï¼šLinux æ•ˆèƒ½åˆ†æå·¥å…·</li>
<li><strong>valgrind/cachegrind</strong>ï¼šCache åˆ†æ</li>
<li><strong>FlameGraph</strong>ï¼šç«ç„°åœ–ç”Ÿæˆå™¨</li>
<li><strong>Intel VTune</strong>ï¼šIntel CPU æ•ˆèƒ½åˆ†æ</li>
</ul>
<h3 id="é–‹æºå°ˆæ¡ˆ"><a class="header" href="#é–‹æºå°ˆæ¡ˆ">é–‹æºå°ˆæ¡ˆ</a></h3>
<ul>
<li><strong>DPDK</strong>ï¼šhttps://www.dpdk.org/</li>
<li><strong>Folly</strong>ï¼šFacebook çš„é«˜æ•ˆèƒ½ C++ å‡½å¼åº«</li>
<li><strong>Seastar</strong>ï¼šéåŒæ­¥ç¨‹å¼è¨­è¨ˆæ¡†æ¶</li>
</ul>
<hr />
<p><strong>æ–‡ä»¶ç‰ˆæœ¬</strong>ï¼š1.0
<strong>æœ€å¾Œæ›´æ–°</strong>ï¼š2026-01-11
<strong>ç¶­è­·è€…</strong>ï¼šBuilding Low Latency Applications Team</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../hft/06-resources/hft-dev-complete-guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../hft/06-resources/github-projects.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../hft/06-resources/hft-dev-complete-guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../hft/06-resources/github-projects.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>



    </div>
    </body>
</html>
