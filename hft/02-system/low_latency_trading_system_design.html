<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>低延遲交易系統設計 - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="高頻交易系統1低延遲交易系統設計"><a class="header" href="#高頻交易系統1低延遲交易系統設計">高頻交易系統（1）：低延遲交易系統設計</a></h1>
<p>這是 "<a href="https://meetingcpp.com/">Meeting C++ 2022</a>" 中 Optiver 技術負責人 David Gross 關於 latency 的主題演講：<strong>Trading at light speed: designing low latency systems in C++</strong>。</p>
<h2 id="核心要點"><a class="header" href="#核心要點">核心要點</a></h2>
<p>Making a trading system “fast” cannot be an afterthought. While low latency programming is sometimes seen under the umbrella of “code optimization”, the truth is that most of the work needed to achieve such latency is done upfront, at the design phase. How to translate our knowledge about the CPU and hardware into C++? How to use multiple CPU cores, handle concurrency issues and cost, and stay fast?</p>
<p>一個「光速（極速）交易系統」的構建應該是事先設計出來，而不是「亡羊補牢」的結果。</p>
<p>雖然說在實際編碼中，對量化開發人員的「編程素養」要求比較高，在代碼上需要按照類似「編程規範」一樣來編寫代碼，以便提高系統性能，但對低延遲交易系統來說，很多極致的性能點還是需要在設計階段完成。</p>
<p>比如如何把對 CPU 和硬體的理解應用到代碼中？如何有效地利用多核心 CPU？如何處理並發及減少系統開銷、且保證系統的低延遲要求？</p>
<h2 id="系統級優化建議"><a class="header" href="#系統級優化建議">系統級優化建議</a></h2>
<p>從 CPU 流水線利用率（通過 <code>perf stat</code> 分析 IPC 指標）、快取命中率（<code>perf record -e cache-misses</code>）、到執行緒調度延遲（<code>cyclictest</code> 測量）。這種系統級優化需要將硬體特性深度融入軟體設計 DNA，而非簡單的後期性能調優。</p>
<h3 id="1-記憶體層級意識-memory-hierarchy"><a class="header" href="#1-記憶體層級意識-memory-hierarchy">1. 記憶體層級意識 (Memory Hierarchy)</a></h3>
<ul>
<li>通過 <code>alignas</code> 強制資料結構快取行對齊，避免偽共享 (False Sharing)。</li>
<li>使用 <code>std::hardware_destructive_interference_size</code> 指導資料結構佈局。</li>
<li>優先選擇連續記憶體容器（如 <code>std::vector</code>），利用快取局部性。</li>
</ul>
<h3 id="2-並發架構設計-concurrency-architecture"><a class="header" href="#2-並發架構設計-concurrency-architecture">2. 並發架構設計 (Concurrency Architecture)</a></h3>
<ul>
<li>採用執行緒綁定（<code>pthread_setaffinity_np</code>）減少核心遷移開銷。</li>
<li>使用無鎖 (Lock-free) 資料結構避免互斥鎖的上下文切換代價。</li>
</ul>
<h3 id="3-指令級優化-instruction-level-optimization"><a class="header" href="#3-指令級優化-instruction-level-optimization">3. 指令級優化 (Instruction Level Optimization)</a></h3>
<ul>
<li>通過 <code>__builtin_expect</code> 指導分支預測。</li>
<li>使用 SIMD 指令集（如 AVX2）進行資料並行處理。</li>
</ul>
<h3 id="4-零拷貝架構-zero-copy"><a class="header" href="#4-零拷貝架構-zero-copy">4. 零拷貝架構 (Zero Copy)</a></h3>
<ul>
<li>使用 DMA 技術實現網路封包直接寫入使用者空間（如 DPDK）。</li>
<li>通過 <code>mmap</code> 實現磁碟記憶體映射，避免資料二次拷貝。</li>
</ul>
<h3 id="5-即時性保障-real-time-assurance"><a class="header" href="#5-即時性保障-real-time-assurance">5. 即時性保障 (Real-time Assurance)</a></h3>
<ul>
<li>採用 <code>SCHED_FIFO</code> 即時調度策略。</li>
<li>使用使用者態中斷處理（如 Linux 的 <code>io_uring</code>）。</li>
</ul>
<hr />
<h2 id="演講核心觀點"><a class="header" href="#演講核心觀點">演講核心觀點</a></h2>
<h3 id="1-importance-of-low-latency-in-trading-systems"><a class="header" href="#1-importance-of-low-latency-in-trading-systems">1. Importance of Low Latency in Trading Systems</a></h3>
<p><strong>Low latency is crucial in automated trading due to the high volume of trades and the need to respond quickly to market changes.</strong>
高頻交易場景下，系統需在百萬級訂單洪流中瞬時響應市場異動。例如當黑天鵝事件觸發時，延遲 1 微秒的撤單操作可能意味著數百萬美元的風險敞口。</p>
<h3 id="2-designing-for-performance"><a class="header" href="#2-designing-for-performance">2. Designing for Performance</a></h3>
<p><strong>Performance should be a primary consideration from the beginning of the system design process.</strong>
不同於傳統軟體「先功能後優化」的模式，極速交易系統需將「性能基因」寫入「架構 DNA」。如同建造 F1 賽車，空氣動力學設計必須在藍圖階段就深度融入，而非後期加裝尾翼。</p>
<h3 id="3-strategy-vs-tactics-in-system-design"><a class="header" href="#3-strategy-vs-tactics-in-system-design">3. Strategy vs Tactics in System Design</a></h3>
<ul>
<li><strong>Strategy (戰略層規劃)</strong>: 確立系統能力基線，例如構建支撐 10 萬 QPS 的行情解析引擎，要求 99.9% 的訂單處理延遲低於 50 微秒。</li>
<li><strong>Tactics (戰術層執行)</strong>: 在實現過程中選擇性採用無鎖隊列、SIMD 指令優化等具體技術手段，避免陷入「為優化而優化」的陷阱。</li>
</ul>
<h3 id="4-building-blocks-of-low-latency-systems"><a class="header" href="#4-building-blocks-of-low-latency-systems">4. Building Blocks of Low Latency Systems</a></h3>
<p>低延遲系統設計的 4 個核心要點：</p>
<ul>
<li><strong>資料模型的典範</strong>: 通過記憶體對齊、快取親和的資料結構設計，將 L1/L2 快取命中率提升至 98%+。</li>
<li><strong>系統調優</strong>: 採用 CPU 綁核、NUMA 感知的記憶體分配策略，將執行緒切換開銷壓縮至納秒級。</li>
<li><strong>事件處理機制</strong>: 實現基於環形緩衝區的零拷貝傳輸，將網路報文到業務處理的延遲降低到 5 微秒以內。</li>
<li><strong>性能監控</strong>: 通過 eBPF 即時採集 LLC（最後一級快取）未命中率，結合 PMU（性能監控單元）資料進行熱點分析。</li>
</ul>
<h3 id="5-evolution-of-exchange-speeds"><a class="header" href="#5-evolution-of-exchange-speeds">5. Evolution of Exchange Speeds</a></h3>
<p><strong>Exchange speeds in financial markets have evolved, with the current focus on achieving microsecond-level latencies.</strong>
金融市場的交易速度持續進化，如今的重點在於實現微秒級的低延遲。</p>
<h3 id="6-trigger-to-target-latency"><a class="header" href="#6-trigger-to-target-latency">6. Trigger to Target Latency</a></h3>
<p><strong>"Trigger to target latency" is a key performance indicator.</strong>
從交易所行情觸達 (Trigger) 到策略引擎發出目標訂單 (Target) 的全鏈路時延，包含：</p>
<ul>
<li>網路傳輸延遲（光速物理限制）</li>
<li>協議解析耗時（優化空間最大）</li>
<li>策略計算耗時（演算法效率核心）</li>
<li>風控校驗耗時（合規性剛需）</li>
</ul>
<h2 id="低延遲的四個細分概念"><a class="header" href="#低延遲的四個細分概念">低延遲的四個細分概念</a></h2>
<ol>
<li>
<p><strong>tick-to-trade latency</strong>: 這是一個大家比較通用的延遲指標。
<img src="assets/tick-to-trade-latency.jpg" alt="" /></p>
</li>
<li>
<p><strong>socket-to-socket latency</strong>:
<img src="assets/socket-to-socket-latency.jpg" alt="" /></p>
</li>
<li>
<p><strong>port-to-port latency</strong>:
<img src="assets/port-to-port-latency.jpg" alt="" /></p>
</li>
<li>
<p><strong>wire to wire latency</strong>:
<img src="assets/wire-to-wire-latency.jpg" alt="" /></p>
</li>
</ol>
<h2 id="系統的延遲多少合適"><a class="header" href="#系統的延遲多少合適">系統的延遲多少合適？</a></h2>
<p>關於高頻交易中，系統的延遲到底多少合適？這個問題如果不談前提條件就沒有標準答案。</p>
<h3 id="低延遲的演進路徑"><a class="header" href="#低延遲的演進路徑">低延遲的演進路徑</a></h3>
<ul>
<li><strong>2000年代</strong>: 百毫秒級延遲 → 採用普通 TCP 協議堆疊</li>
<li><strong>2010年代</strong>: 微秒級突破 → FPGA 加速 + 核心旁路技術</li>
<li><strong>2020年代</strong>: 向納秒級逼近 → 光子傳輸 + ASIC 晶片客製化</li>
</ul>
<p>目前國外造市商系統可實現 1.2 微秒的端到端延遲。但在國內量化高頻實操中，談延遲必須談場景（股票數量、因子數量、模型複雜度、風控等）。</p>
<h3 id="基礎設施的影響"><a class="header" href="#基礎設施的影響">基礎設施的影響</a></h3>
<p>國內股票市場的基礎設施（如行情延遲、券商櫃台現狀）是談低延遲的前提。證券行業目前的信創任務（計算層、網路層、存儲層）也是重要考量因素。</p>
<h3 id="交易所的速度演進"><a class="header" href="#交易所的速度演進">交易所的速度演進</a></h3>
<p>國外交易所（如 NYSE Pillar）已將往返延遲大幅降低（FIX 約 32μs，Binary 約 26μs）。
國內上期所 NGES3.0 系統也採用了主從備三節點架構，報單容量提升 3 倍，業務處理性能提升 40%。</p>
<h2 id="總結"><a class="header" href="#總結">總結</a></h2>
<p>在國內股票市場從事高頻交易，我們不但要構建自身低延遲的高頻交易全流程系統，同時也要關注市場基礎設施的建設情況，確保我們在高頻交易上的投入是有切切實實的回報。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../hft/02-system/高頻低延遲Linux完整配置指南.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../hft/02-system/TSE_Receiver_Optimization_Guide.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../hft/02-system/高頻低延遲Linux完整配置指南.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../hft/02-system/TSE_Receiver_Optimization_Guide.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>



    </div>
    </body>
</html>
