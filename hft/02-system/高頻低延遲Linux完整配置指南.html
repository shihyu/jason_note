<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>é«˜é »ä½å»¶é² Linux å®Œæ•´é…ç½®æŒ‡å— - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="é«˜é »ä½å»¶é²-linux-cc-å®Œæ•´é…ç½®æŒ‡å—"><a class="header" href="#é«˜é »ä½å»¶é²-linux-cc-å®Œæ•´é…ç½®æŒ‡å—">é«˜é »/ä½å»¶é² Linux C/C++ å®Œæ•´é…ç½®æŒ‡å—</a></h1>
<blockquote>
<p><strong>ç›®æ¨™</strong>ï¼šç¡¬é«” + ç³»çµ± + ç¨‹å¼ç¢¼ = æ¥µè‡´ä½å»¶é²<br />
<strong>é©ç”¨</strong>ï¼šHFTã€DPDKã€è¶…ä½å»¶é²äº¤æ˜“ç³»çµ±</p>
</blockquote>
<hr />
<h2 id="-ä¸‰å±¤æ¶æ§‹ç¸½è¦½"><a class="header" href="#-ä¸‰å±¤æ¶æ§‹ç¸½è¦½">ğŸ¯ ä¸‰å±¤æ¶æ§‹ç¸½è¦½</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç¡¬é«”å±¤ï¼ˆHardwareï¼‰               â”‚
â”‚  - é«˜éšç¶²å¡ + BIOS è¨­å®š              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ç³»çµ±å±¤ï¼ˆOS/Kernelï¼‰              â”‚
â”‚  - GRUB åƒæ•¸ + Runtime è¨­å®š          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ‡‰ç”¨å±¤ï¼ˆC/C++ Codeï¼‰             â”‚
â”‚  - DPDK + Lock-free + è¨˜æ†¶é«”ç®¡ç†     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr />
<h2 id="1-ç¡¬é«”å±¤é…ç½®"><a class="header" href="#1-ç¡¬é«”å±¤é…ç½®">1ï¸âƒ£ ç¡¬é«”å±¤é…ç½®</a></h2>
<h3 id="bios-è¨­å®šé–‹æ©Ÿå‰"><a class="header" href="#bios-è¨­å®šé–‹æ©Ÿå‰">BIOS è¨­å®šï¼ˆé–‹æ©Ÿå‰ï¼‰</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¿…é ˆé—œé–‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Hyper-Threading (SMT)     â”‚
â”‚ âœ“ C-States (çœé›»æ¨¡å¼)        â”‚
â”‚ âœ“ P-States (å‹•æ…‹é »ç‡)        â”‚
â”‚ âœ“ Turbo Boost               â”‚
â”‚ âœ“ NUMA Node Interleaving    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¿…é ˆé–‹å•Ÿ                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ VT-d / IOMMU              â”‚
â”‚ âœ“ Performance Mode          â”‚
â”‚ âœ“ ACS (Access Control)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="ç¶²å¡è¦æ±‚"><a class="header" href="#ç¶²å¡è¦æ±‚">ç¶²å¡è¦æ±‚</a></h3>
<pre><code>æ¨è–¦å‹è™Ÿï¼š
- Intel X710 / XL710
- Mellanox ConnectX-5/6

å¿…å‚™åŠŸèƒ½ï¼š
âœ“ SR-IOV
âœ“ Flow Director / Flow Steering
âœ“ RSS (Receive Side Scaling)
âœ“ 32+ RX/TX queues
âœ“ DPDK PMD æ”¯æ´
</code></pre>
<hr />
<h2 id="2-ç³»çµ±å±¤é…ç½®"><a class="header" href="#2-ç³»çµ±å±¤é…ç½®">2ï¸âƒ£ ç³»çµ±å±¤é…ç½®</a></h2>
<h3 id="a-grub-å•Ÿå‹•åƒæ•¸"><a class="header" href="#a-grub-å•Ÿå‹•åƒæ•¸">A. GRUB å•Ÿå‹•åƒæ•¸</a></h3>
<p>ç·¨è¼¯ <code>/etc/default/grub</code>ï¼š</p>
<pre><code class="language-bash">GRUB_CMDLINE_LINUX="
  isolcpus=1-7
  nohz_full=1-7
  rcu_nocbs=1-7
  rcu_nocb_poll
  intel_pstate=disable
  intel_idle.max_cstate=0
  processor.max_cstate=0
  idle=poll
  nosoftlockup
  nmi_watchdog=0
  mce=off
  intel_iommu=on
  iommu=pt
  default_hugepagesz=1G
  hugepagesz=1G
  hugepages=8
  transparent_hugepage=never
"
</code></pre>
<p>æ›´æ–°ä¸¦é‡å•Ÿï¼š</p>
<pre><code class="language-bash">sudo update-grub
sudo reboot
</code></pre>
<h3 id="b-ç³»çµ±æœå‹™ç®¡ç†"><a class="header" href="#b-ç³»çµ±æœå‹™ç®¡ç†">B. ç³»çµ±æœå‹™ç®¡ç†</a></h3>
<pre><code class="language-bash"># é—œé–‰ä¸å¿…è¦æœå‹™
systemctl stop irqbalance
systemctl disable irqbalance
systemctl stop cpupower
systemctl mask systemd-journald.service

# é–å®š CPU é »ç‡
cpupower frequency-set -g performance
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
    echo performance &gt; $cpu
done
</code></pre>
<h3 id="c-irq-è¦ªå’Œæ€§è¨­å®šç¾ä»£æ›´æ–°"><a class="header" href="#c-irq-è¦ªå’Œæ€§è¨­å®šç¾ä»£æ›´æ–°">C. IRQ è¦ªå’Œæ€§è¨­å®šï¼ˆç¾ä»£æ›´æ–°ï¼‰</a></h3>
<p><strong>é‡è¦è§€å¿µè½‰è®Š</strong>ï¼šåœ¨ Kernel Bypass æ¨¡å¼ä¸‹ï¼Œä¸å†å¼·èª¿ã€ŒæŠŠ IRQ ç¶åˆ°å“ªå€‹ CPUã€ï¼Œè€Œæ˜¯å¼·èª¿ã€Œé¿é–‹ Polling CPUã€ã€‚</p>
<h4 id="ç‚ºä»€éº¼-irq-ç¶å®šè§€å¿µæ”¹è®Šäº†"><a class="header" href="#ç‚ºä»€éº¼-irq-ç¶å®šè§€å¿µæ”¹è®Šäº†">ç‚ºä»€éº¼ IRQ ç¶å®šè§€å¿µæ”¹è®Šäº†ï¼Ÿ</a></h4>
<ol>
<li><strong>è‡ªå‹•åŒ–</strong>ï¼šé«˜éšç¶²å¡ï¼ˆå¦‚ Mellanox ConnectX-7+ï¼‰åœ¨ Bypass æ¨¡å¼ä¸‹æœƒè‡ªå‹•é—œé–‰ç¡¬é«”ä¸­æ–·</li>
<li><strong>é¿é–‹ç­–ç•¥</strong>ï¼šé‡é»æ˜¯ã€Œç¢ºä¿ä¸­æ–·ä¸è¦å‡ºç¾åœ¨ Polling æ ¸å¿ƒä¸Šã€</li>
<li><strong>ç³»çµ±ä¸­æ–·è™•ç†</strong>ï¼šå°‡æ‰€æœ‰ç³»çµ±ä¸­æ–·ï¼ˆç£ç¢Ÿã€è¨ˆæ™‚å™¨ï¼‰ç¶å®šåˆ°éäº¤æ˜“æ ¸å¿ƒï¼ˆé€šå¸¸æ˜¯ CPU 0ï¼‰</li>
</ol>
<pre><code class="language-bash">#!/bin/bash
# irq_binding.sh - å°‡æ‰€æœ‰ç³»çµ±ä¸­æ–·ç¶å®šåˆ° CPU 0

# ç­–ç•¥ï¼šè®“æ‰€æœ‰ä¸­æ–·éƒ½åœ¨ CPU 0 è™•ç†ï¼Œä¿è­· 1-7 è™Ÿæ ¸å¿ƒ
for irq in /proc/irq/*/smp_affinity; do
    # è·³é default_smp_affinity
    if [[ $irq == *"default"* ]]; then
        continue
    fi

    # 0x01 = äºŒé€²ä½ 0001 = CPU 0
    echo 1 &gt; $irq 2&gt;/dev/null
done

# é©—è­‰ï¼šæ‰€æœ‰ä¸­æ–·æ‡‰è©²åªåœ¨ CPU 0 ä¸Šå¢é•·
watch -n 1 'cat /proc/interrupts | head -20'
</code></pre>
<h4 id="numa-æ‹“æ’²å°é½Šé—œéµ"><a class="header" href="#numa-æ‹“æ’²å°é½Šé—œéµ">NUMA æ‹“æ’²å°é½Šï¼ˆé—œéµï¼ï¼‰</a></h4>
<pre><code class="language-bash"># 1. æª¢æŸ¥ç¶²å¡åœ¨å“ªå€‹ NUMA Node
lspci -vvv -s 0000:03:00.0 | grep "NUMA node"
# è¼¸å‡ºç¯„ä¾‹ï¼šNUMA node: 0

# 2. æª¢æŸ¥ CPU æ‹“æ’²
lstopo-no-graphics --of txt
# æˆ–
numactl --hardware

# 3. ç¢ºä¿ä½ çš„ Polling ç¨‹å¼é‹è¡Œåœ¨åŒä¸€å€‹ NUMA Node
# ä¾‹å¦‚ç¶²å¡åœ¨ NUMA 0ï¼Œå‰‡ä½¿ç”¨ CPU 0-11 (å‡è¨­ 12 æ ¸/socket)
</code></pre>
<p><strong>é—œéµ</strong>ï¼šè·¨ NUMA å­˜å–çš„å»¶é²æœƒæ¯€æ‰æ‰€æœ‰å„ªåŒ–æ•ˆæœï¼</p>
<h3 id="e-kernel-bypass-é—œéµæ¦‚å¿µ"><a class="header" href="#e-kernel-bypass-é—œéµæ¦‚å¿µ">E. Kernel Bypass é—œéµæ¦‚å¿µ</a></h3>
<h4 id="ç‚ºä»€éº¼-irq-ç¶å®šè®Šå°‘äº†"><a class="header" href="#ç‚ºä»€éº¼-irq-ç¶å®šè®Šå°‘äº†">ç‚ºä»€éº¼ IRQ ç¶å®šè®Šå°‘äº†ï¼Ÿ</a></h4>
<pre><code>å‚³çµ±è§€å¿µ (èˆŠ)           ç¾ä»£ Bypass æ¨¡å¼ (æ–°)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æŠŠ IRQ ç¶åˆ°ç‰¹å®š CPU    â†’ é¿é–‹ Polling CPUï¼Œé—œé–‰ä¸å¿…è¦çš„ä¸­æ–·
éœ€è¦æ‰‹å‹•èª¿æ•´ affinity  â†’ é«˜éšç¶²å¡è‡ªå‹•é—œé–‰ç¡¬é«”ä¸­æ–·
</code></pre>
<p><strong>æ ¸å¿ƒåŸå‰‡</strong>ï¼šåœ¨ Kernel Bypass æ¨¡å¼ä¸‹ï¼Œé‡é»ä¸æ˜¯ã€ŒæŠŠä¸­æ–·ç¶åˆ°å“ªã€ï¼Œè€Œæ˜¯ã€Œç¢ºä¿ä¸­æ–·ä¸è¦å‡ºç¾åœ¨ Polling æ ¸å¿ƒä¸Šã€ã€‚</p>
<p><strong>ã€Œéœé»˜/é—œé–‰ä¸­æ–·ã€çš„æ„æ€</strong>ï¼šç¶²å¡åœ¨ Bypass æ¨¡å¼ä¸‹ä¸æœƒç”¢ç”Ÿç¡¬é«”ä¸­æ–·é€šçŸ¥ CPUï¼Œå› ç‚ºæˆ‘å€‘ä½¿ç”¨ Busy Pollingï¼ˆä¸æ–·ä¸»å‹•è¼ªè©¢ï¼‰å–ä»£è¢«å‹•ç­‰å¾…ä¸­æ–·ã€‚</p>
<h4 id="ç³»çµ±é…ç½®å››è¦ç´ "><a class="header" href="#ç³»çµ±é…ç½®å››è¦ç´ ">ç³»çµ±é…ç½®å››è¦ç´ </a></h4>
<p><strong>1. è»Ÿé«”å±¤ç´šï¼šæ¨æ£„ poll()</strong></p>
<pre><code class="language-cpp">// âŒ ä¸è¦ä½¿ç”¨
struct pollfd fds[1];
poll(fds, 1, timeout);

// âœ… æ”¹ç”¨ DPDK
rte_eth_rx_burst(port, queue_id, bufs, BURST_SIZE);
</code></pre>
<p><strong>2. ä½œæ¥­ç³»çµ±å±¤ç´šï¼šæ ¸å¿ƒéš”é›¢</strong></p>
<pre><code class="language-bash"># å¿…è¦æ“ä½œï¼šåœ¨ GRUB è¨­å®šä¸­åŠ å…¥
isolcpus=X,Y        # é˜²æ­¢æ’ç¨‹å™¨ä½¿ç”¨é€™äº›æ ¸å¿ƒ
nohz_full=X,Y       # é—œé–‰è©²æ ¸å¿ƒçš„ tick
</code></pre>
<p><strong>3. IRQ ç®¡ç†ï¼šç¶å®šåˆ°éäº¤æ˜“æ ¸å¿ƒ</strong></p>
<pre><code class="language-bash"># å°‡æ‰€æœ‰ç³»çµ±ä¸­æ–·ç¶å®šåˆ° CPU 0ï¼ˆé Polling æ ¸å¿ƒï¼‰
for irq in /proc/irq/*/smp_affinity; do
    echo 1 &gt; $irq 2&gt;/dev/null
done
</code></pre>
<p><strong>4. ç¡¬é«”å°é½Šï¼šNUMA æ‹“æ’²</strong></p>
<pre><code class="language-bash"># æª¢æŸ¥ç¶²å¡åœ¨å“ªå€‹ NUMA Node
lstopo-no-graphics --of txt

# æˆ–ä½¿ç”¨
lspci -vvv -s &lt;PCI_ADDR&gt; | grep "NUMA node"

# é—œéµï¼šPolling ç¨‹å¼å¿…é ˆé‹è¡Œåœ¨åŒä¸€å€‹ NUMA Node çš„ CPU ä¸Š
</code></pre>
<h3 id="d-dpdk-ç’°å¢ƒæº–å‚™"><a class="header" href="#d-dpdk-ç’°å¢ƒæº–å‚™">D. DPDK ç’°å¢ƒæº–å‚™</a></h3>
<pre><code class="language-bash">#!/bin/bash
# dpdk_setup.sh

# 1. è¼‰å…¥ VFIO æ¨¡çµ„
modprobe vfio-pci
echo 1 &gt; /sys/module/vfio/parameters/enable_unsafe_noiommu_mode

# 2. æŸ¥çœ‹ç¶²å¡ PCI ä½å€
lspci | grep Ethernet
# å‡è¨­è¼¸å‡ºï¼š0000:03:00.0 Ethernet controller: Intel Corporation

# 3. è§£ç¶åŸé©…å‹•
echo "0000:03:00.0" &gt; /sys/bus/pci/drivers/i40e/unbind

# 4. ç¶å®šåˆ° vfio-pciï¼ˆIntel X710 çš„ vendor:device IDï¼‰
echo "8086 1572" &gt; /sys/bus/pci/drivers/vfio-pci/new_id
echo "0000:03:00.0" &gt; /sys/bus/pci/drivers/vfio-pci/bind

# 5. æ›è¼‰ Hugepages
mkdir -p /mnt/huge
mount -t hugetlbfs nodev /mnt/huge
echo 8 &gt; /sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages

# 6. é©—è­‰
cat /proc/meminfo | grep Huge
</code></pre>
<hr />
<h2 id="25-dpdk-vs-å‚³çµ±ç¶²è·¯ç·¨ç¨‹"><a class="header" href="#25-dpdk-vs-å‚³çµ±ç¶²è·¯ç·¨ç¨‹">2.5 DPDK vs å‚³çµ±ç¶²è·¯ç·¨ç¨‹</a></h2>
<h3 id="poll-vs-recvfrom---å‚³çµ±-socket-çš„å…©éšæ®µæµç¨‹"><a class="header" href="#poll-vs-recvfrom---å‚³çµ±-socket-çš„å…©éšæ®µæµç¨‹">poll() vs recvfrom() - å‚³çµ± Socket çš„å…©éšæ®µæµç¨‹</a></h3>
<p>åœ¨å‚³çµ± Linux ç¶²è·¯ç·¨ç¨‹ä¸­ï¼Œ<code>poll()</code> å’Œ <code>recvfrom()</code> æ˜¯<strong>å…©å€‹ä¸åŒçš„ç³»çµ±å‘¼å«</strong>ï¼Œå„å¸å…¶è·ï¼š</p>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚³çµ± Socket å…©éšæ®µæµç¨‹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  1. poll() / select() / epoll()            â”‚
â”‚     â””â”€ ç›£æ§ socket ç‹€æ…‹                     â”‚
â”‚     â””â”€ ç­‰å¾…ã€Œæœ‰è³‡æ–™å¯è®€ã€äº‹ä»¶                â”‚
â”‚     â””â”€ å¯åŒæ™‚ç›£æ§å¤šå€‹ socket                â”‚
â”‚     â””â”€ é˜»å¡æˆ–éé˜»å¡æ¨¡å¼                     â”‚
â”‚                                             â”‚
â”‚  2. recvfrom() / recv() / read()           â”‚
â”‚     â””â”€ å¯¦éš›æ¥æ”¶è³‡æ–™                         â”‚
â”‚     â””â”€ å¾ kernel buffer æ‹·è²åˆ° user buffer  â”‚
â”‚     â””â”€ ä¸€æ¬¡è™•ç†ä¸€å€‹ socket                  â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h4 id="å‚³çµ±æ–¹å¼çš„å…¸å‹ç¨‹å¼ç¢¼"><a class="header" href="#å‚³çµ±æ–¹å¼çš„å…¸å‹ç¨‹å¼ç¢¼">å‚³çµ±æ–¹å¼çš„å…¸å‹ç¨‹å¼ç¢¼</a></h4>
<pre><code class="language-c">#include &lt;sys/socket.h&gt;
#include &lt;poll.h&gt;

int sockfd = socket(AF_INET, SOCK_DGRAM, 0);
bind(sockfd, ...);

struct pollfd fds[1];
fds[0].fd = sockfd;
fds[0].events = POLLIN;  // ç›£æ§ã€Œå¯è®€ã€äº‹ä»¶

while (1) {
    // éšæ®µ 1ï¼šç­‰å¾… socket æœ‰è³‡æ–™ï¼ˆå¯èƒ½é˜»å¡ï¼‰
    int ret = poll(fds, 1, 1000);  // timeout 1000ms

    if (ret &gt; 0 &amp;&amp; (fds[0].revents &amp; POLLIN)) {
        // éšæ®µ 2ï¼šå¯¦éš›æ¥æ”¶è³‡æ–™
        char buffer[1500];
        struct sockaddr_in src_addr;
        socklen_t addrlen = sizeof(src_addr);

        ssize_t n = recvfrom(sockfd, buffer, sizeof(buffer), 0,
                             (struct sockaddr*)&amp;src_addr, &amp;addrlen);

        if (n &gt; 0) {
            process_data(buffer, n);
        }
    }
}
</code></pre>
<h4 id="recvfrom-å¯ä»¥ä¸éœ€è¦-poll-å—"><a class="header" href="#recvfrom-å¯ä»¥ä¸éœ€è¦-poll-å—">recvfrom() å¯ä»¥ä¸éœ€è¦ poll() å—ï¼Ÿ</a></h4>
<p><strong>ç­”æ¡ˆï¼šå¯ä»¥ï¼</strong> <code>poll()</code> ä¸æ˜¯å¿…é ˆçš„ï¼Œæœ‰å¤šç¨®ä½¿ç”¨æ–¹å¼ï¼š</p>
<p><strong>æ–¹å¼ 1ï¼šç´”é˜»å¡æ¨¡å¼ï¼ˆæœ€ç°¡å–®ï¼‰</strong></p>
<pre><code class="language-c">int sockfd = socket(AF_INET, SOCK_DGRAM, 0);
bind(sockfd, ...);

while (1) {
    char buffer[1500];
    // ç›´æ¥å‘¼å« recvfromï¼Œæœƒä¸€ç›´ç­‰å¾…ç›´åˆ°æœ‰è³‡æ–™
    ssize_t n = recvfrom(sockfd, buffer, sizeof(buffer), 0, NULL, NULL);

    if (n &gt; 0) {
        process_data(buffer, n);
    }
}
</code></pre>
<ul>
<li>âœ… æœ€ç°¡å–®ï¼Œä¸éœ€è¦ poll</li>
<li>âŒ æœƒä¸€ç›´é˜»å¡ï¼Œç„¡æ³•è¨­å®š timeout</li>
<li>âŒ ç„¡æ³•è™•ç†å¤šå€‹ socket</li>
</ul>
<p><strong>æ–¹å¼ 2ï¼šéé˜»å¡ + Busy Pollingï¼ˆæ¨¡ä»¿ DPDKï¼Œä½†æ•ˆç‡å·®ï¼‰</strong></p>
<pre><code class="language-c">int sockfd = socket(AF_INET, SOCK_DGRAM, 0);
bind(sockfd, ...);

// è¨­å®šç‚ºéé˜»å¡æ¨¡å¼
int flags = fcntl(sockfd, F_GETFL, 0);
fcntl(sockfd, F_SETFL, flags | O_NONBLOCK);

while (1) {
    char buffer[1500];
    // âš ï¸ æ¯æ¬¡éƒ½æ˜¯ç³»çµ±å‘¼å«ï¼Œç«‹å³å›å‚³
    ssize_t n = recvfrom(sockfd, buffer, sizeof(buffer), 0, NULL, NULL);

    if (n &gt; 0) {
        // æœ‰å°åŒ…ï¼Œè™•ç†è³‡æ–™
        process_data(buffer, n);
    } else if (n &lt; 0 &amp;&amp; errno == EAGAIN) {
        // æ²’å°åŒ…ï¼Œä½†é¦¬ä¸Šåˆé€²å…¥ä¸‹ä¸€æ¬¡è¿´åœˆ
        // âš ï¸ æ¯æ¬¡è¿´åœˆéƒ½è¦é€² kernel æª¢æŸ¥æ˜¯å¦æœ‰å°åŒ…
        continue;
    }
}
</code></pre>
<p><strong>é‡é»ï¼šrecvfrom åœ¨éé˜»å¡æ¨¡å¼ä¸‹çš„è¡Œç‚º</strong></p>
<pre><code>æ¯æ¬¡å‘¼å« recvfrom() éƒ½æœƒï¼š
  1. é€²å…¥ kernel space            (ç³»çµ±å‘¼å«é–‹éŠ·)
  2. æª¢æŸ¥ socket buffer æ˜¯å¦æœ‰è³‡æ–™
  3. å¦‚æœæœ‰è³‡æ–™ â†’ æ‹·è²åˆ° user bufferï¼Œè¿”å›è³‡æ–™é•·åº¦
  4. å¦‚æœæ²’è³‡æ–™ â†’ è¿”å› -1ï¼Œè¨­å®š errno = EAGAIN
  5. å›åˆ° user space              (ç³»çµ±å‘¼å«é–‹éŠ·)

å•é¡Œï¼šæ¯æ¬¡è¿´åœˆéƒ½è¦é€™æ¨£åšï¼Œå³ä½¿ 99% çš„æ™‚é–“æ²’è³‡æ–™ï¼
</code></pre>
<ul>
<li>âœ… ä¸æœƒé˜»å¡ï¼Œæœ‰è³‡æ–™ç«‹å³è™•ç†</li>
<li>âŒ <strong>ç˜‹ç‹‚ç³»çµ±å‘¼å«</strong>ï¼Œæ¯æ¬¡è¿´åœˆéƒ½è¦é€² kernel æª¢æŸ¥</li>
<li>âŒ CPU 100%ï¼Œä½†å¤§éƒ¨åˆ†æ™‚é–“æµªè²»åœ¨é€²å‡º kernel</li>
</ul>
<p><strong>æ–¹å¼ 3ï¼špoll() + recvfrom()ï¼ˆæ¨è–¦ï¼‰</strong></p>
<pre><code class="language-c">struct pollfd fds[1];
fds[0].fd = sockfd;
fds[0].events = POLLIN;

while (1) {
    // åªå‘¼å«ä¸€æ¬¡ poll ç­‰å¾…
    int ret = poll(fds, 1, 1000);

    if (ret &gt; 0) {
        // ç¢ºå®šæœ‰è³‡æ–™æ‰å‘¼å« recvfrom
        ssize_t n = recvfrom(sockfd, buffer, sizeof(buffer), 0, NULL, NULL);
        process_data(buffer, n);
    }
}
</code></pre>
<ul>
<li>âœ… æœ‰è³‡æ–™æ™‚æ‰è®€å–ï¼Œæ¸›å°‘ç„¡æ•ˆç³»çµ±å‘¼å«</li>
<li>âœ… å¯è¨­å®š timeout</li>
<li>âœ… å¯åŒæ™‚ç›£æ§å¤šå€‹ socket</li>
</ul>
<h4 id="ç‚ºä»€éº¼éœ€è¦-poll"><a class="header" href="#ç‚ºä»€éº¼éœ€è¦-poll">ç‚ºä»€éº¼éœ€è¦ poll()ï¼Ÿ</a></h4>
<div class="table-wrapper"><table><thead><tr><th>å ´æ™¯</th><th>ä¸ç”¨ poll çš„å•é¡Œ</th><th>ç”¨ poll çš„å¥½è™•</th></tr></thead><tbody>
<tr><td>å–®ä¸€ socket</td><td><code>recvfrom()</code> æœƒä¸€ç›´é˜»å¡</td><td>å¯è¨­å®š timeout</td></tr>
<tr><td>å¤šå€‹ socket</td><td>ä¸çŸ¥é“è©²è®€å“ªå€‹ï¼Œéœ€è¦é€ä¸€è¼ªè©¢</td><td>ä¸€æ¬¡ç›£æ§å¤šå€‹ï¼ŒçŸ¥é“å“ªå€‹æœ‰è³‡æ–™</td></tr>
<tr><td>éé˜»å¡æ¨¡å¼</td><td>ç˜‹ç‹‚ç³»çµ±å‘¼å«æµªè²» CPU</td><td>åªåœ¨æœ‰è³‡æ–™æ™‚æ‰å‘¼å« recvfrom</td></tr>
</tbody></table>
</div>
<h4 id="recvfrom-ç³»çµ±å‘¼å«è¡Œç‚ºè©³è§£"><a class="header" href="#recvfrom-ç³»çµ±å‘¼å«è¡Œç‚ºè©³è§£">recvfrom() ç³»çµ±å‘¼å«è¡Œç‚ºè©³è§£</a></h4>
<p><strong>é—œéµå•é¡Œï¼šrecvfrom è¦æ¯æ¬¡ç³»çµ±å‘¼å«çœ‹æ˜¯å¦æœ‰å°åŒ…å—ï¼Ÿ</strong></p>
<p><strong>ç­”æ¡ˆï¼šå–æ±ºæ–¼æ¨¡å¼ï¼</strong></p>
<div class="table-wrapper"><table><thead><tr><th>æ¨¡å¼</th><th>è¡Œç‚º</th><th>ç³»çµ±å‘¼å«é »ç‡</th><th>é©ç”¨å ´æ™¯</th></tr></thead><tbody>
<tr><td><strong>é˜»å¡æ¨¡å¼</strong></td><td>å‘¼å«ä¸€æ¬¡ï¼Œç­‰åˆ°æœ‰è³‡æ–™æ‰è¿”å›</td><td>æœ‰è³‡æ–™æ™‚æ‰è¿”å›</td><td>ç°¡å–®æ‡‰ç”¨</td></tr>
<tr><td><strong>éé˜»å¡æ¨¡å¼</strong></td><td>æ¯æ¬¡å‘¼å«ç«‹å³è¿”å›</td><td><strong>æ¯æ¬¡è¿´åœˆéƒ½è¦ç³»çµ±å‘¼å«</strong></td><td>Busy polling (æ•ˆç‡å·®)</td></tr>
<tr><td><strong>poll + recvfrom</strong></td><td>poll ç­‰å¾…ï¼Œç¢ºå®šæœ‰è³‡æ–™æ‰ recvfrom</td><td>æœ‰è³‡æ–™æ™‚æ‰ recvfrom</td><td>æ¨è–¦</td></tr>
</tbody></table>
</div>
<p><strong>è©³ç´°è¡Œç‚ºå°æ¯”ï¼š</strong></p>
<pre><code>é˜»å¡æ¨¡å¼ï¼š
  recvfrom(sockfd, ...);  â† å‘¼å«ä¸€æ¬¡
  â†“
  â¸ï¸ åœ¨ kernel å…§ç­‰å¾…ï¼ˆç¨‹å¼æš«åœï¼‰
  â†“
  ğŸ“¦ æœ‰å°åŒ…åˆ°é”
  â†“
  âœ… æ‹·è²è³‡æ–™ï¼Œè¿”å›
  â†“
  è™•ç†è³‡æ–™
  â†“
  recvfrom(sockfd, ...);  â† å†æ¬¡å‘¼å«ï¼Œåˆæœƒç­‰å¾…

  ç³»çµ±å‘¼å«æ¬¡æ•¸ï¼šç­‰æ–¼å°åŒ…æ•¸é‡ï¼ˆæœ€å°‘ï¼‰

éé˜»å¡æ¨¡å¼ï¼ˆBusy Pollingï¼‰ï¼š
  while (1) {
    recvfrom(sockfd, ...);  â† æ¯æ¬¡è¿´åœˆéƒ½ç³»çµ±å‘¼å«
    â†“
    ç«‹å³æª¢æŸ¥ socket buffer
    â†“
    æ²’è³‡æ–™ï¼Ÿè¿”å› EAGAIN
    â†“
    recvfrom(sockfd, ...);  â† åˆæ˜¯ç³»çµ±å‘¼å«
    â†“
    æ²’è³‡æ–™ï¼Ÿè¿”å› EAGAIN
    â†“
    recvfrom(sockfd, ...);  â† åˆæ˜¯ç³»çµ±å‘¼å«
    ...ï¼ˆå¯èƒ½é‡è¤‡æ•¸ç™¾è¬æ¬¡ï¼‰
    â†“
    ğŸ“¦ æœ‰å°åŒ…åˆ°é”
    â†“
    æ‹·è²è³‡æ–™ï¼Œè¿”å›
  }

  ç³»çµ±å‘¼å«æ¬¡æ•¸ï¼šå¯èƒ½æ•¸ç™¾è¬æ¬¡/ç§’ï¼ˆæ¥µå¤šï¼ï¼‰

poll + recvfromï¼š
  while (1) {
    poll(fds, ...);         â† ç³»çµ±å‘¼å«ï¼Œç­‰å¾…äº‹ä»¶
    â†“
    â¸ï¸ åœ¨ kernel å…§ç­‰å¾…
    â†“
    ğŸ“¦ æœ‰å°åŒ…åˆ°é”
    â†“
    âœ… è¿”å›ã€Œæœ‰è³‡æ–™å¯è®€ã€
    â†“
    recvfrom(sockfd, ...);  â† ç¢ºå®šæœ‰è³‡æ–™æ‰ç³»çµ±å‘¼å«
    â†“
    æ‹·è²è³‡æ–™ï¼Œè¿”å›
  }

  ç³»çµ±å‘¼å«æ¬¡æ•¸ï¼šç´„ 2 Ã— å°åŒ…æ•¸é‡ï¼ˆé©ä¸­ï¼‰
</code></pre>
<p><strong>é—œéµå·®ç•°ç¸½çµï¼š</strong></p>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éé˜»å¡ recvfrom busy polling ç‚ºä»€éº¼é€™éº¼å·®ï¼Ÿ         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  while (1) {                                        â”‚
â”‚    recvfrom(...)  â† ç³»çµ±å‘¼å« 1                      â”‚
â”‚    recvfrom(...)  â† ç³»çµ±å‘¼å« 2                      â”‚
â”‚    recvfrom(...)  â† ç³»çµ±å‘¼å« 3                      â”‚
â”‚    ...                                              â”‚
â”‚    recvfrom(...)  â† ç³»çµ±å‘¼å« 1000000                â”‚
â”‚  }                                                  â”‚
â”‚                                                     â”‚
â”‚  æ¯æ¬¡éƒ½è¦ï¼š                                         â”‚
â”‚  1. user â†’ kernel åˆ‡æ›     (50-100 cycles)          â”‚
â”‚  2. æª¢æŸ¥ socket buffer     (20-50 cycles)           â”‚
â”‚  3. kernel â†’ user åˆ‡æ›     (50-100 cycles)          â”‚
â”‚                                                     â”‚
â”‚  å³ä½¿æ²’å°åŒ…ï¼Œä¹Ÿè¦é€™æ¨£åšï¼                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr />
<h4 id="å°æ¯”ä¸‰ç¨®æ–¹å¼-vs-dpdk"><a class="header" href="#å°æ¯”ä¸‰ç¨®æ–¹å¼-vs-dpdk">å°æ¯”ï¼šä¸‰ç¨®æ–¹å¼ vs DPDK</a></h4>
<pre><code>æ–¹å¼ 1ï¼ˆé˜»å¡ recvfromï¼‰:
  while (1) {
    recvfrom(...);  // é˜»å¡ç­‰å¾…ï¼Œç°¡å–®ä½†ä¸éˆæ´»
  }

æ–¹å¼ 2ï¼ˆéé˜»å¡ recvfrom busy pollingï¼‰:
  while (1) {
    recvfrom(...);  // ç˜‹ç‹‚ç³»çµ±å‘¼å«ï¼ŒCPU 100%
  }
  âŒ æƒ³æ¨¡ä»¿ DPDK ä½†æ•ˆç‡æ¥µå·®

æ–¹å¼ 3ï¼ˆpoll + recvfromï¼‰:
  while (1) {
    poll(...);      // ç­‰å¾…äº‹ä»¶
    recvfrom(...);  // æœ‰è³‡æ–™æ‰è®€
  }
  âœ… æ¨è–¦çš„å‚³çµ±æ–¹å¼

DPDKï¼ˆçœŸæ­£çš„ busy pollingï¼‰:
  while (1) {
    rte_eth_rx_burst(...);  // ç›´æ¥è®€è¨˜æ†¶é«”ï¼Œé›¶ç³»çµ±å‘¼å«
  }
  âœ… CPU 100% ä½†å…¨åœ¨ user space
</code></pre>
<hr />
<h4 id="-æ·±å…¥åˆ†æç‚ºä»€éº¼æ–¹å¼-2-æ•ˆç‡é€™éº¼å·®"><a class="header" href="#-æ·±å…¥åˆ†æç‚ºä»€éº¼æ–¹å¼-2-æ•ˆç‡é€™éº¼å·®">ğŸ’¡ æ·±å…¥åˆ†æï¼šç‚ºä»€éº¼æ–¹å¼ 2 æ•ˆç‡é€™éº¼å·®ï¼Ÿ</a></h4>
<p>é›–ç„¶æ–¹å¼ 2ï¼ˆéé˜»å¡ recvfrom busy pollingï¼‰å’Œ DPDK éƒ½æ˜¯ busy pollingï¼Œä½†<strong>æ•ˆç‡å·®ç•°é«˜é” 1000 å€ï¼</strong></p>
<p><strong>éé˜»å¡ recvfrom busy polling çš„é–‹éŠ·ï¼š</strong></p>
<pre><code>æ¯æ¬¡è¿´åœˆéƒ½è¦ï¼š
  1. åˆ‡æ›åˆ° kernel mode      (50-100 cycles)
  2. æª¢æŸ¥ socket buffer       (20-50 cycles)
  3. æ‹·è²è³‡æ–™ï¼ˆå¦‚æœæœ‰ï¼‰       (ä¾è³‡æ–™å¤§å°ï¼Œ1500 bytes â‰ˆ 300 cycles)
  4. åˆ‡æ›å› user mode         (50-100 cycles)

æ²’è³‡æ–™æ™‚ï¼šæµªè²» 100-200 cycles
æœ‰è³‡æ–™æ™‚ï¼šé‚„è¦åŠ ä¸Šæ‹·è²é–‹éŠ· 300+ cycles
ç³»çµ±å‘¼å«æ¬¡æ•¸ï¼šæ¯æ¬¡è¿´åœˆéƒ½å‘¼å«ï¼ˆå¯èƒ½æ•¸ç™¾è¬æ¬¡/ç§’ï¼‰
</code></pre>
<p><strong>DPDK busy polling çš„é–‹éŠ·ï¼š</strong></p>
<pre><code>æ¯æ¬¡è¿´åœˆï¼š
  1. ç›´æ¥è®€è¨˜æ†¶é«”              (10-20 cycles)
  2. è³‡æ–™å·²ç¶“åœ¨é‚£è£¡ï¼ˆé›¶æ‹·è²ï¼‰  (0 cycles)

æ²’è³‡æ–™æ™‚ï¼šåªæµªè²» 10-20 cycles
æœ‰è³‡æ–™æ™‚ï¼šè³‡æ–™å·²ç¶“åœ¨ user spaceï¼Œä¸éœ€æ‹·è²
ç³»çµ±å‘¼å«æ¬¡æ•¸ï¼š0
</code></pre>
<p><strong>æ•ˆç‡å°æ¯”ç¸½çµï¼š</strong></p>
<div class="table-wrapper"><table><thead><tr><th>é …ç›®</th><th>æ–¹å¼ 2 (éé˜»å¡ recvfrom)</th><th>DPDK (rx_burst)</th><th>å·®ç•°</th></tr></thead><tbody>
<tr><td><strong>æ¯æ¬¡è¿´åœˆé–‹éŠ·</strong></td><td>100-200 cycles</td><td>10-20 cycles</td><td><strong>10-20å€</strong></td></tr>
<tr><td><strong>ç³»çµ±å‘¼å«</strong></td><td>æ¯æ¬¡éƒ½è¦</td><td>é›¶æ¬¡</td><td><strong>âˆ</strong></td></tr>
<tr><td><strong>è³‡æ–™æ‹·è²</strong></td><td>éœ€è¦ï¼ˆ300+ cyclesï¼‰</td><td>ä¸éœ€è¦ï¼ˆ0 cyclesï¼‰</td><td><strong>âˆ</strong></td></tr>
<tr><td><strong>Context Switch</strong></td><td>æ¯æ¬¡ 2 æ¬¡</td><td>é›¶æ¬¡</td><td><strong>âˆ</strong></td></tr>
<tr><td><strong>ç¸½é«”æ•ˆç‡</strong></td><td>æ¥µå·®</td><td>æ¥µä½³</td><td><strong>1000-3000å€</strong></td></tr>
</tbody></table>
</div>
<p><strong>é—œéµçµè«–ï¼š</strong></p>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŒæ¨£æ˜¯ CPU 100% çš„ Busy Polling                      â”‚
â”‚                                                      â”‚
â”‚  æ–¹å¼ 2ï¼šCPU æ™‚é–“æµªè²»åœ¨é€²å‡º kernel                    â”‚
â”‚          âŒ æ¯æ¬¡è¿´åœˆï¼škernel â†” user åˆ‡æ›é–‹éŠ·          â”‚
â”‚          âŒ å¤§é‡ç„¡æ•ˆç³»çµ±å‘¼å«                          â”‚
â”‚                                                      â”‚
â”‚  DPDKï¼š  CPU æ™‚é–“ç”¨åœ¨è™•ç†å°åŒ…                         â”‚
â”‚          âœ… å®Œå…¨åœ¨ user space                        â”‚
â”‚          âœ… é›¶ç³»çµ±å‘¼å«ï¼Œé›¶æ‹·è²                        â”‚
â”‚                                                      â”‚
â”‚  çµè«–ï¼šå³ä½¿éƒ½æ˜¯ busy pollingï¼ŒDPDK å¿« 1000 å€ï¼       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<p><strong>å¯¦æ¸¬æ•¸æ“šç¤ºä¾‹ï¼š</strong></p>
<pre><code>æ¸¬è©¦ç’°å¢ƒï¼šIntel Xeon E5-2680 v4 @ 2.4GHz
å°åŒ…å¤§å°ï¼š64 bytes (æœ€å° UDP å°åŒ…)
æ¸¬è©¦æ™‚é–“ï¼š10 ç§’

æ–¹å¼ 2 (éé˜»å¡ recvfrom busy polling):
  - å°åŒ…è™•ç†é€Ÿåº¦ï¼š~100,000 pps
  - CPU ä½¿ç”¨ç‡ï¼š100%
  - ç³»çµ±å‘¼å«æ¬¡æ•¸ï¼š~10,000,000 æ¬¡/ç§’
  - å¹³å‡å»¶é²ï¼š~10 Î¼s

DPDK (rx_burst):
  - å°åŒ…è™•ç†é€Ÿåº¦ï¼š~14,000,000 pps (ç·šé€Ÿ)
  - CPU ä½¿ç”¨ç‡ï¼š100%
  - ç³»çµ±å‘¼å«æ¬¡æ•¸ï¼š0
  - å¹³å‡å»¶é²ï¼š~0.5 Î¼s

æ•ˆç‡æå‡ï¼š140x (å°åŒ…è™•ç†é€Ÿåº¦)
å»¶é²é™ä½ï¼š20x
</code></pre>
<blockquote>
<p><strong>é‡é»</strong>ï¼šé€™å°±æ˜¯ç‚ºä»€éº¼<strong>å³ä½¿éƒ½æ˜¯ busy pollingï¼ŒDPDK é‚„æ˜¯å¿«å¾—å¤š</strong>ï¼ä¸æ˜¯æ¦‚å¿µçš„å·®ç•°ï¼Œè€Œæ˜¯å¯¦ä½œå±¤ç´šçš„æ ¹æœ¬å·®ç•°ã€‚</p>
</blockquote>
<hr />
<h4 id="æ ¸å¿ƒå·®ç•°ä¸€è¦½"><a class="header" href="#æ ¸å¿ƒå·®ç•°ä¸€è¦½">æ ¸å¿ƒå·®ç•°ä¸€è¦½</a></h4>
<p><strong>æ˜¯çš„ï¼Œpoll() å’Œ recvfrom() å®Œå…¨ä¸ä¸€æ¨£ï¼</strong></p>
<pre><code>poll()              recvfrom()
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç›£æ§éšæ®µ             å¯¦éš›è®€å–éšæ®µ
ç­‰å¾…äº‹ä»¶é€šçŸ¥         æ‹·è²è³‡æ–™
å¯ç›£æ§å¤šå€‹ socket    ä¸€æ¬¡è™•ç†ä¸€å€‹
è¿”å›ã€Œå°±ç·’ç‹€æ…‹ã€     è¿”å›ã€Œå¯¦éš›è³‡æ–™ã€
</code></pre>
<p><strong>å‚³çµ±æµç¨‹ï¼ˆå…©éšæ®µï¼‰</strong></p>
<pre><code class="language-c">// ç¬¬ 1 æ­¥ï¼šå• kernelã€Œæœ‰è³‡æ–™å—?ã€
poll(fds, 1, timeout);

// ç¬¬ 2 æ­¥ï¼šã€Œæœ‰ï¼é‚£æˆ‘ä¾†æ‹¿ã€
recvfrom(sockfd, buffer, ...);
</code></pre>
<p><strong>DPDK æµç¨‹ï¼ˆå–®ä¸€æ­¥é©Ÿï¼‰</strong></p>
<pre><code class="language-cpp">// ä¸€æ­¥åˆ°ä½ï¼šç›´æ¥å¾ç¶²å¡è¨˜æ†¶é«”æ‹¿è³‡æ–™
rte_eth_rx_burst(port_id, 0, bufs, BURST_SIZE);
</code></pre>
<p><strong>ç‚ºä»€éº¼ DPDK åªéœ€è¦ä¸€æ­¥ï¼Ÿ</strong></p>
<ol>
<li><strong>ä¸éœ€è¦ poll()</strong> - å› ç‚ºæˆ‘å€‘ä¸ä¾è³´ kernel é€šçŸ¥ï¼Œç›´æ¥è‡ªå·±å»ç¶²å¡è¨˜æ†¶é«”çœ‹æœ‰æ²’æœ‰è³‡æ–™</li>
<li><strong>ä¸éœ€è¦ recvfrom()</strong> - å› ç‚ºè³‡æ–™å·²ç¶“åœ¨æˆ‘å€‘çš„è¨˜æ†¶é«”è£¡ï¼ˆDMA ç›´æ¥å¯«å…¥ï¼‰ï¼Œä¸éœ€è¦å¾ kernel buffer æ‹·è²</li>
</ol>
<p><strong>æ•ˆèƒ½å·®ç•°</strong></p>
<pre><code>å‚³çµ±æ–¹å¼ï¼ˆæ¯å€‹å°åŒ…ï¼‰:
poll() ç³»çµ±å‘¼å« (1ms)
  â†’ kernel æª¢æŸ¥ socket
  â†’ ç­‰å¾…ä¸­æ–·
  â†’ å›å‚³ã€Œæœ‰è³‡æ–™ã€
recvfrom() ç³»çµ±å‘¼å« (0.5ms)
  â†’ kernel æ‹·è²è³‡æ–™
  â†’ å›å‚³è³‡æ–™
ç¸½è¨ˆï¼š~1.5ms

DPDK æ–¹å¼ï¼ˆæ‰¹æ¬¡ 32 å€‹å°åŒ…ï¼‰:
rte_eth_rx_burst() (0.5Î¼s)
  â†’ ç›´æ¥è®€è¨˜æ†¶é«”
  â†’ æ‹¿åˆ° 32 å€‹å°åŒ…
ç¸½è¨ˆï¼š~0.5Î¼s (å¿« 3000 å€!)
</code></pre>
<blockquote>
<p><strong>é‡é»</strong>ï¼šé€™å°±æ˜¯ç‚ºä»€éº¼åœ¨ã€ŒE. Kernel Bypass é—œéµæ¦‚å¿µã€ç« ç¯€ä¸­ï¼Œç¬¬ä¸€æ¢å°±æ˜¯ã€Œ<strong>æ¨æ£„ poll()</strong>ã€- å› ç‚ºåœ¨ Bypass æ¨¡å¼ä¸‹ï¼Œæˆ‘å€‘å®Œå…¨è·³éäº† kernel çš„äº‹ä»¶é€šçŸ¥æ©Ÿåˆ¶ï¼</p>
</blockquote>
<hr />
<h4 id="dpdk-çš„å·®ç•°å–®ä¸€æ­¥é©Ÿ"><a class="header" href="#dpdk-çš„å·®ç•°å–®ä¸€æ­¥é©Ÿ">DPDK çš„å·®ç•°ï¼šå–®ä¸€æ­¥é©Ÿ</a></h4>
<pre><code class="language-cpp">// DPDK æ–¹å¼ï¼šæ²’æœ‰å…©éšæ®µï¼Œç›´æ¥å–è³‡æ–™
while (1) {
    struct rte_mbuf *bufs[BURST_SIZE];

    // ä¸€æ­¥åˆ°ä½ï¼šæª¢æŸ¥ + å–è³‡æ–™
    uint16_t nb_rx = rte_eth_rx_burst(port_id, 0, bufs, BURST_SIZE);

    // nb_rx å¯èƒ½æ˜¯ 0ï¼ˆæ²’è³‡æ–™ï¼‰æˆ– 1-32ï¼ˆæœ‰è³‡æ–™ï¼‰
    for (uint16_t i = 0; i &lt; nb_rx; i++) {
        process_packet(bufs[i]);
        rte_pktmbuf_free(bufs[i]);
    }

    // æ²’è³‡æ–™ä¹Ÿä¸ç¡çœ ï¼ˆbusy pollingï¼‰
    if (nb_rx == 0) {
        rte_pause();  // åªæ˜¯ CPU pause æŒ‡ä»¤
    }
}
</code></pre>
<h4 id="é—œéµå·®ç•°ç¸½çµ"><a class="header" href="#é—œéµå·®ç•°ç¸½çµ">é—œéµå·®ç•°ç¸½çµ</a></h4>
<div class="table-wrapper"><table><thead><tr><th>å±¤é¢</th><th>å‚³çµ± Socket</th><th>DPDK</th></tr></thead><tbody>
<tr><td><strong>æ­¥é©Ÿ</strong></td><td>å…©éšæ®µï¼ˆpoll â†’ recvfromï¼‰</td><td>å–®ä¸€æ­¥é©Ÿï¼ˆrx_burstï¼‰</td></tr>
<tr><td><strong>ç³»çµ±å‘¼å«</strong></td><td>æ¯è¼ªè‡³å°‘ 1 æ¬¡ï¼ˆpollï¼‰+ æœ‰è³‡æ–™æ™‚å¤š 1 æ¬¡ï¼ˆrecvfromï¼‰</td><td>0 æ¬¡ï¼ˆå®Œå…¨åœ¨ user spaceï¼‰</td></tr>
<tr><td><strong>ç­‰å¾…æ©Ÿåˆ¶</strong></td><td>poll é˜»å¡ç­‰å¾… kernel é€šçŸ¥</td><td>busy polling ä¸»å‹•è¼ªè©¢</td></tr>
<tr><td><strong>è³‡æ–™æ‹·è²</strong></td><td>kernel buffer â†’ user buffer</td><td>é›¶æ‹·è²ï¼ˆDMA ç›´é”ï¼‰</td></tr>
<tr><td><strong>æ‰¹æ¬¡è™•ç†</strong></td><td>æ¯æ¬¡ 1 å€‹å°åŒ…</td><td>æ¯æ¬¡æœ€å¤š 32 å€‹å°åŒ…</td></tr>
</tbody></table>
</div>
<hr />
<h3 id="æ ¸å¿ƒå·®ç•°å°ç…§è¡¨"><a class="header" href="#æ ¸å¿ƒå·®ç•°å°ç…§è¡¨">æ ¸å¿ƒå·®ç•°å°ç…§è¡¨</a></h3>
<div class="table-wrapper"><table><thead><tr><th>ç‰¹æ€§</th><th>å‚³çµ± recvfrom</th><th>DPDK rte_eth_rx_burst</th></tr></thead><tbody>
<tr><td><strong>è³‡æ–™è·¯å¾‘</strong></td><td>ç¶²å¡ â†’ æ ¸å¿ƒç·©è¡å€ â†’ æ‹·è² â†’ ç”¨æˆ¶ç©ºé–“</td><td>ç¶²å¡ â†’ ç›´æ¥å¯«å…¥ç”¨æˆ¶ç©ºé–“è¨˜æ†¶é«” (Zero-copy)</td></tr>
<tr><td><strong>è™•ç†å–®ä½</strong></td><td>å–®å€‹å°åŒ… (Single Packet)</td><td>ä¸€æ‰¹å°åŒ… (Batch/Burst)</td></tr>
<tr><td><strong>é˜»å¡ç‰¹æ€§</strong></td><td>å¯é˜»å¡ (Blocking) æˆ–éé˜»å¡</td><td>æ°¸é ä¸é˜»å¡ï¼ˆç«‹å³å›å‚³ç›®å‰æŠ“åˆ°çš„å°åŒ…æ•¸ï¼‰</td></tr>
<tr><td><strong>å”è­°æ£§</strong></td><td>è‡ªå‹•è™•ç† TCP/IPï¼ˆç”± Linux Kernel è™•ç†ï¼‰</td><td>è£¸å°åŒ… (Raw Packet)ï¼Œéœ€è‡ªå·±è§£æ Ethernet/IP/UDP æ¨™é ­</td></tr>
<tr><td><strong>ç³»çµ±å‘¼å«</strong></td><td>æ¯æ¬¡éƒ½é€²å…¥ kernel space</td><td>å®Œå…¨åœ¨ user spaceï¼ˆé›¶ç³»çµ±å‘¼å«ï¼‰</td></tr>
<tr><td><strong>ä¸­æ–·è™•ç†</strong></td><td>ä¾è³´ç¡¬é«”ä¸­æ–·å–šé†’ç¨‹å¼</td><td>Busy Pollingï¼Œä¸ä¾è³´ä¸­æ–·</td></tr>
</tbody></table>
</div>
<h3 id="ç¨‹å¼ç¢¼å°æ¯”"><a class="header" href="#ç¨‹å¼ç¢¼å°æ¯”">ç¨‹å¼ç¢¼å°æ¯”</a></h3>
<h4 id="å‚³çµ±-socket-æ–¹å¼"><a class="header" href="#å‚³çµ±-socket-æ–¹å¼">å‚³çµ± Socket æ–¹å¼</a></h4>
<pre><code class="language-cpp">// å‚³çµ±æ–¹å¼ï¼šæ¯æ¬¡è™•ç†ä¸€å€‹å°åŒ…ï¼Œæœ‰ç³»çµ±å‘¼å«é–‹éŠ·
int sockfd = socket(AF_INET, SOCK_DGRAM, 0);
bind(sockfd, ...);

while (1) {
    char buffer[1500];
    struct sockaddr_in src_addr;
    socklen_t addrlen = sizeof(src_addr);

    // é˜»å¡ç­‰å¾…æˆ–è¼ªè©¢ï¼ˆæœ‰ kernel overheadï¼‰
    ssize_t n = recvfrom(sockfd, buffer, sizeof(buffer), 0,
                         (struct sockaddr*)&amp;src_addr, &amp;addrlen);

    if (n &gt; 0) {
        // è³‡æ–™å·²ç¶“è¢« kernel è§£æéï¼ˆTCP/IP stackï¼‰
        process_data(buffer, n);
    }
}
</code></pre>
<h4 id="dpdk-æ–¹å¼"><a class="header" href="#dpdk-æ–¹å¼">DPDK æ–¹å¼</a></h4>
<pre><code class="language-cpp">// DPDK æ–¹å¼ï¼šæ‰¹æ¬¡è™•ç†ï¼Œé›¶ç³»çµ±å‘¼å«ï¼Œé›¶æ‹·è²
uint16_t port_id = 0;
uint16_t queue_id = 0;

while (1) {
    struct rte_mbuf *bufs[BURST_SIZE];

    // éé˜»å¡ï¼šç«‹å³å›å‚³ï¼ˆç›®å‰æŠ“åˆ°å¹¾å€‹å°±å›å‚³å¹¾å€‹ï¼‰
    uint16_t nb_rx = rte_eth_rx_burst(port_id, queue_id,
                                       bufs, BURST_SIZE);

    // æ‰¹æ¬¡è™•ç†
    for (uint16_t i = 0; i &lt; nb_rx; i++) {
        // è£¸å°åŒ…ï¼šéœ€è¦è‡ªå·±è§£æ Ethernet/IP/UDP header
        uint8_t *pkt = rte_pktmbuf_mtod(bufs[i], uint8_t*);

        struct rte_ether_hdr *eth = (struct rte_ether_hdr *)pkt;
        struct rte_ipv4_hdr *ip = (struct rte_ipv4_hdr *)(eth + 1);
        struct rte_udp_hdr *udp = (struct rte_udp_hdr *)(ip + 1);

        uint8_t *payload = (uint8_t *)(udp + 1);

        // è™•ç†æ¥­å‹™é‚è¼¯
        process_packet(payload);

        // é‡‹æ”¾æˆ–è½‰ç™¼
        rte_pktmbuf_free(bufs[i]);
    }

    // å³ä½¿ nb_rx == 0 ä¹Ÿä¸ç¡çœ ï¼ˆbusy pollingï¼‰
    if (unlikely(nb_rx == 0)) {
        rte_pause();  // CPU pause æŒ‡ä»¤
    }
}
</code></pre>
<h3 id="é‡è¦è§€å¿µ"><a class="header" href="#é‡è¦è§€å¿µ">é‡è¦è§€å¿µ</a></h3>
<h4 id="1-batch-è™•ç†å„ªå‹¢"><a class="header" href="#1-batch-è™•ç†å„ªå‹¢">1. Batch è™•ç†å„ªå‹¢</a></h4>
<pre><code>å‚³çµ± Socket (N æ¬¡ç³»çµ±å‘¼å«)
recvfrom() â†’ è™•ç† â†’ recvfrom() â†’ è™•ç† â†’ ...
æ¯æ¬¡éƒ½é€² kernel

DPDK Burst (1 æ¬¡ DMA æ“ä½œå–å¾—å¤šå€‹å°åŒ…)
rte_eth_rx_burst() â†’ å–å¾— 32 å€‹å°åŒ… â†’ å…¨éƒ¨è™•ç†
å®Œå…¨åœ¨ user space
</code></pre>
<h4 id="2-é›¶æ‹·è²åŸç†"><a class="header" href="#2-é›¶æ‹·è²åŸç†">2. é›¶æ‹·è²åŸç†</a></h4>
<pre><code>å‚³çµ±ï¼š
ç¶²å¡ DMA â†’ Kernel Buffer â†’ memcpy â†’ User Buffer
          â†‘ æ‹·è²é–‹éŠ·

DPDKï¼š
ç¶²å¡ DMA â†’ User Space Mbuf Pool (é€é IOMMU)
          â†‘ ç›´æ¥å¯«å…¥
</code></pre>
<h4 id="3-ç‚ºä»€éº¼éœ€è¦è‡ªå·±è§£æå”è­°"><a class="header" href="#3-ç‚ºä»€éº¼éœ€è¦è‡ªå·±è§£æå”è­°">3. ç‚ºä»€éº¼éœ€è¦è‡ªå·±è§£æå”è­°ï¼Ÿ</a></h4>
<pre><code class="language-cpp">// Kernel å¹«ä½ åšçš„äº‹ï¼ˆå‚³çµ± Socketï¼‰
- Ethernet è§£å°è£
- IP checksum é©—è­‰
- UDP/TCP è§£æ
- Socket buffer ç®¡ç†

// DPDK ä½ è¦è‡ªå·±åš
uint8_t *pkt = rte_pktmbuf_mtod(mbuf, uint8_t*);

// æ‰‹å‹•è§£ææ¯ä¸€å±¤
struct rte_ether_hdr *eth = (struct rte_ether_hdr *)pkt;
struct rte_ipv4_hdr *ip = (struct rte_ipv4_hdr *)(eth + 1);
struct rte_udp_hdr *udp = (struct rte_udp_hdr *)(ip + 1);
void *payload = (void *)(udp + 1);
</code></pre>
<p><strong>ä»£åƒ¹</strong>ï¼šè¤‡é›œåº¦ â†‘
<strong>å¥½è™•</strong>ï¼šå»¶é² â†“ (é€šå¸¸é™ä½ 10-100x)</p>
<hr />
<h2 id="251-æ²’æœ‰-dpdk-çš„é«˜é »ä½å»¶é²æœ€ä½³æ–¹æ¡ˆ"><a class="header" href="#251-æ²’æœ‰-dpdk-çš„é«˜é »ä½å»¶é²æœ€ä½³æ–¹æ¡ˆ">2.5.1 æ²’æœ‰ DPDK çš„é«˜é »ä½å»¶é²æœ€ä½³æ–¹æ¡ˆ</a></h2>
<h3 id="å¯¦éš›å ´æ™¯ç„¡æ³•ä½¿ç”¨-kernel-bypass-æ™‚æ€éº¼è¾¦"><a class="header" href="#å¯¦éš›å ´æ™¯ç„¡æ³•ä½¿ç”¨-kernel-bypass-æ™‚æ€éº¼è¾¦">å¯¦éš›å ´æ™¯ï¼šç„¡æ³•ä½¿ç”¨ Kernel Bypass æ™‚æ€éº¼è¾¦ï¼Ÿ</a></h3>
<p>åœ¨å¾ˆå¤šæƒ…æ³ä¸‹ç„¡æ³•ä½¿ç”¨ DPDKï¼š</p>
<ul>
<li>å…±äº«ä¼ºæœå™¨ç’°å¢ƒï¼ˆä¸èƒ½ç¨ä½”ç¶²å¡ï¼‰</li>
<li>éœ€è¦ä½¿ç”¨æ¨™æº– TCP/IP å”è­°æ£§</li>
<li>å®‰å…¨æ€§è€ƒé‡ï¼ˆä¸æƒ³ bypass kernelï¼‰</li>
<li>é ç®—é™åˆ¶ï¼ˆç„¡æ³•è³¼è²·é«˜éšç¶²å¡ï¼‰</li>
</ul>
<p><strong>é€™æ™‚å€™ï¼Œå‚³çµ± Socket ç·¨ç¨‹çš„æœ€ä½³æ–¹æ¡ˆæ˜¯ä»€éº¼ï¼Ÿ</strong></p>
<h3 id="-æ¨è–¦æ–¹æ¡ˆepoll-edge-triggered--å„ªåŒ–æŠ€å·§"><a class="header" href="#-æ¨è–¦æ–¹æ¡ˆepoll-edge-triggered--å„ªåŒ–æŠ€å·§">â­ æ¨è–¦æ–¹æ¡ˆï¼šepoll (Edge-Triggered) + å„ªåŒ–æŠ€å·§</a></h3>
<h4 id="æ–¹æ¡ˆæ¶æ§‹"><a class="header" href="#æ–¹æ¡ˆæ¶æ§‹">æ–¹æ¡ˆæ¶æ§‹</a></h4>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€ä½³å‚³çµ±æ–¹æ¡ˆï¼ˆç„¡ DPDKï¼‰                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  1. epoll (edge-triggered mode)            â”‚
â”‚     âœ“ æ¯” poll/select å¿«å¾ˆå¤š                 â”‚
â”‚     âœ“ O(1) è¤‡é›œåº¦                           â”‚
â”‚     âœ“ åªé€šçŸ¥æœ‰è®ŠåŒ–çš„ socket                 â”‚
â”‚                                             â”‚
â”‚  2. SO_BUSY_POLL socket é¸é …                â”‚
â”‚     âœ“ Kernel å…§çš„ busy poll                 â”‚
â”‚     âœ“ æ¸›å°‘ä¸­æ–·å»¶é²                          â”‚
â”‚                                             â”‚
â”‚  3. CPU Affinity + IRQ ç¶å®š                 â”‚
â”‚     âœ“ æ¸›å°‘ cache miss                       â”‚
â”‚     âœ“ é™ä½ context switch                   â”‚
â”‚                                             â”‚
â”‚  4. Batch è™•ç†                              â”‚
â”‚     âœ“ epoll_wait ä¸€æ¬¡å–å¤šå€‹äº‹ä»¶             â”‚
â”‚     âœ“ recvmmsg ä¸€æ¬¡è®€å¤šå€‹å°åŒ…               â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="å¯¦ä½œç¯„ä¾‹æœ€ä½³åŒ–çš„å‚³çµ±æ–¹æ¡ˆ"><a class="header" href="#å¯¦ä½œç¯„ä¾‹æœ€ä½³åŒ–çš„å‚³çµ±æ–¹æ¡ˆ">å¯¦ä½œç¯„ä¾‹ï¼šæœ€ä½³åŒ–çš„å‚³çµ±æ–¹æ¡ˆ</a></h3>
<pre><code class="language-c">#define _GNU_SOURCE
#include &lt;sys/epoll.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sched.h&gt;
#include &lt;pthread.h&gt;

#define MAX_EVENTS 32
#define BATCH_SIZE 32

// 1. è¨­å®š socket é¸é …
int setup_optimized_socket(int sockfd) {
    // è¨­å®šç‚ºéé˜»å¡
    int flags = fcntl(sockfd, F_GETFL, 0);
    fcntl(sockfd, F_SETFL, flags | O_NONBLOCK);

    // å•Ÿç”¨ SO_BUSY_POLLï¼ˆkernel å…§çš„ busy pollï¼‰
    int busy_poll_us = 50;  // 50 å¾®ç§’
    setsockopt(sockfd, SOL_SOCKET, SO_BUSY_POLL,
               &amp;busy_poll_us, sizeof(busy_poll_us));

    // è¨­å®šæ¥æ”¶ç·©è¡å€å¤§å°
    int rcvbuf = 4 * 1024 * 1024;  // 4MB
    setsockopt(sockfd, SOL_SOCKET, SO_RCVBUF,
               &amp;rcvbuf, sizeof(rcvbuf));

    // å•Ÿç”¨ SO_REUSEPORTï¼ˆå¤šåŸ·è¡Œç·’è² è¼‰å‡è¡¡ï¼‰
    int reuse = 1;
    setsockopt(sockfd, SOL_SOCKET, SO_REUSEPORT,
               &amp;reuse, sizeof(reuse));

    return 0;
}

// 2. ç¶å®šåˆ°ç‰¹å®š CPU
void bind_to_cpu(int cpu_id) {
    cpu_set_t cpuset;
    CPU_ZERO(&amp;cpuset);
    CPU_SET(cpu_id, &amp;cpuset);
    pthread_setaffinity_np(pthread_self(), sizeof(cpu_set_t), &amp;cpuset);
}

// 3. ä½¿ç”¨ epoll edge-triggered æ¨¡å¼
int main() {
    // ç¶å®šåˆ°ç‰¹å®š CPU
    bind_to_cpu(2);

    // å»ºç«‹ socket
    int sockfd = socket(AF_INET, SOCK_DGRAM, 0);
    bind(sockfd, ...);
    setup_optimized_socket(sockfd);

    // å»ºç«‹ epoll
    int epfd = epoll_create1(0);

    // åŠ å…¥ socketï¼ˆEdge-Triggered æ¨¡å¼ï¼‰
    struct epoll_event ev;
    ev.events = EPOLLIN | EPOLLET;  // â† Edge-Triggered
    ev.data.fd = sockfd;
    epoll_ctl(epfd, EPOLL_CTL_ADD, sockfd, &amp;ev);

    // æº–å‚™æ¥æ”¶ç·©è¡å€
    struct mmsghdr msgs[BATCH_SIZE];
    struct iovec iovecs[BATCH_SIZE];
    char buffers[BATCH_SIZE][2048];

    for (int i = 0; i &lt; BATCH_SIZE; i++) {
        iovecs[i].iov_base = buffers[i];
        iovecs[i].iov_len = sizeof(buffers[i]);
        msgs[i].msg_hdr.msg_iov = &amp;iovecs[i];
        msgs[i].msg_hdr.msg_iovlen = 1;
        msgs[i].msg_hdr.msg_name = NULL;
        msgs[i].msg_hdr.msg_namelen = 0;
    }

    // ä¸»è¿´åœˆ
    struct epoll_event events[MAX_EVENTS];

    while (1) {
        // ç­‰å¾…äº‹ä»¶ï¼ˆå¯è¨­ timeout = 0 åš busy pollï¼‰
        int nfds = epoll_wait(epfd, events, MAX_EVENTS, 0);  // 0 = éé˜»å¡

        for (int i = 0; i &lt; nfds; i++) {
            if (events[i].events &amp; EPOLLIN) {
                // Edge-triggeredï¼šéœ€è¦è®€å–æ‰€æœ‰å¯ç”¨è³‡æ–™
                while (1) {
                    // ä½¿ç”¨ recvmmsg æ‰¹æ¬¡æ¥æ”¶
                    int nr = recvmmsg(sockfd, msgs, BATCH_SIZE,
                                     MSG_DONTWAIT, NULL);

                    if (nr &lt;= 0) {
                        if (errno == EAGAIN || errno == EWOULDBLOCK) {
                            break;  // æ²’è³‡æ–™äº†
                        }
                        // è™•ç†éŒ¯èª¤
                        break;
                    }

                    // æ‰¹æ¬¡è™•ç†å°åŒ…
                    for (int j = 0; j &lt; nr; j++) {
                        process_packet(buffers[j], msgs[j].msg_len);
                    }
                }
            }
        }

        // å³ä½¿æ²’äº‹ä»¶ä¹Ÿæœƒç«‹å³å›åˆ°è¿´åœˆï¼ˆbusy pollï¼‰
    }

    return 0;
}
</code></pre>
<h3 id="é—œéµå„ªåŒ–æŠ€å·§"><a class="header" href="#é—œéµå„ªåŒ–æŠ€å·§">é—œéµå„ªåŒ–æŠ€å·§</a></h3>
<h4 id="1-ä½¿ç”¨-epoll-è€Œé-pollselect"><a class="header" href="#1-ä½¿ç”¨-epoll-è€Œé-pollselect">1. ä½¿ç”¨ epoll è€Œé poll/select</a></h4>
<div class="table-wrapper"><table><thead><tr><th>æ–¹æ¡ˆ</th><th>æ™‚é–“è¤‡é›œåº¦</th><th>æœ€å¤§ fd æ•¸</th><th>æ¨è–¦åº¦</th></tr></thead><tbody>
<tr><td>select()</td><td>O(n)</td><td>1024</td><td>âŒ ä¸æ¨è–¦</td></tr>
<tr><td>poll()</td><td>O(n)</td><td>ç„¡é™åˆ¶</td><td>â–³ æ™®é€š</td></tr>
<tr><td>epoll()</td><td>O(1)</td><td>ç„¡é™åˆ¶</td><td>âœ… æ¨è–¦</td></tr>
</tbody></table>
</div>
<p><strong>epoll å„ªå‹¢ï¼š</strong></p>
<ul>
<li>ä¸éœ€è¦æ¯æ¬¡å‚³éæ•´å€‹ fd åˆ—è¡¨</li>
<li>åªè¿”å›æœ‰äº‹ä»¶çš„ fd</li>
<li>Edge-triggered æ¨¡å¼æ›´é«˜æ•ˆ</li>
</ul>
<h4 id="2-so_busy_poll---kernel-å…§çš„-busy-poll"><a class="header" href="#2-so_busy_poll---kernel-å…§çš„-busy-poll">2. SO_BUSY_POLL - Kernel å…§çš„ Busy Poll</a></h4>
<pre><code class="language-c">// Kernel æœƒåœ¨æŒ‡å®šæ™‚é–“å…§ busy pollï¼Œæ¸›å°‘ä¸­æ–·å»¶é²
int busy_poll_us = 50;  // å¾®ç§’
setsockopt(sockfd, SOL_SOCKET, SO_BUSY_POLL,
           &amp;busy_poll_us, sizeof(busy_poll_us));
</code></pre>
<p><strong>æ•ˆæœï¼š</strong></p>
<ul>
<li>å»¶é²å¾ ~50Î¼s é™åˆ° ~10Î¼s</li>
<li>ä»£åƒ¹ï¼šå¢åŠ  CPU ä½¿ç”¨ç‡</li>
</ul>
<h4 id="3-ä½¿ç”¨-recvmmsg-æ‰¹æ¬¡æ¥æ”¶"><a class="header" href="#3-ä½¿ç”¨-recvmmsg-æ‰¹æ¬¡æ¥æ”¶">3. ä½¿ç”¨ recvmmsg æ‰¹æ¬¡æ¥æ”¶</a></h4>
<pre><code class="language-c">// ä¸€æ¬¡æ¥æ”¶å¤šå€‹å°åŒ…ï¼Œæ¸›å°‘ç³»çµ±å‘¼å«
struct mmsghdr msgs[32];
int nr = recvmmsg(sockfd, msgs, 32, MSG_DONTWAIT, NULL);

// æ¯”èµ· 32 æ¬¡ recvfromï¼Œåªéœ€è¦ 1 æ¬¡ç³»çµ±å‘¼å«ï¼
</code></pre>
<h4 id="4-so_reuseport-å¤šåŸ·è¡Œç·’è² è¼‰å‡è¡¡"><a class="header" href="#4-so_reuseport-å¤šåŸ·è¡Œç·’è² è¼‰å‡è¡¡">4. SO_REUSEPORT å¤šåŸ·è¡Œç·’è² è¼‰å‡è¡¡</a></h4>
<pre><code class="language-c">int reuse = 1;
setsockopt(sockfd, SOL_SOCKET, SO_REUSEPORT, &amp;reuse, sizeof(reuse));

// å¤šå€‹åŸ·è¡Œç·’å¯ä»¥ bind åŒä¸€å€‹ port
// Kernel æœƒè‡ªå‹•åšè² è¼‰å‡è¡¡
</code></pre>
<h4 id="5-cpu-affinity-å’Œ-irq-ç¶å®š"><a class="header" href="#5-cpu-affinity-å’Œ-irq-ç¶å®š">5. CPU Affinity å’Œ IRQ ç¶å®š</a></h4>
<pre><code class="language-bash"># å°‡æ¥æ”¶åŸ·è¡Œç·’ç¶åˆ° CPU 2
taskset -c 2 ./my_app

# å°‡ç¶²å¡ IRQ ç¶åˆ°åŒä¸€å€‹ CPU
echo 4 &gt; /proc/irq/&lt;IRQ_NUM&gt;/smp_affinity  # 0x4 = CPU 2
</code></pre>
<h3 id="æ•ˆèƒ½å°æ¯”"><a class="header" href="#æ•ˆèƒ½å°æ¯”">æ•ˆèƒ½å°æ¯”</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚³çµ±æ–¹æ¡ˆæ•ˆèƒ½å°æ¯”ï¼ˆç„¡ DPDKï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  æ–¹æ¡ˆ                      å»¶é²        ååé‡           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  é˜»å¡ recvfrom            100-500Î¼s   ~50,000 pps       â”‚
â”‚  poll + recvfrom          50-200Î¼s    ~100,000 pps      â”‚
â”‚  epoll + recvfrom         20-100Î¼s    ~500,000 pps      â”‚
â”‚  epoll + recvmmsg         10-50Î¼s     ~1,000,000 pps    â”‚
â”‚  epoll + recvmmsg +       5-30Î¼s      ~2,000,000 pps    â”‚
â”‚    SO_BUSY_POLL                                         â”‚
â”‚                                                         â”‚
â”‚  DPDK (åƒè€ƒ)              0.5-2Î¼s     ~14,000,000 pps   â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="æœ€ä½³å¯¦è¸-checklist"><a class="header" href="#æœ€ä½³å¯¦è¸-checklist">æœ€ä½³å¯¦è¸ Checklist</a></h3>
<pre><code>ç³»çµ±å±¤ç´šï¼š
[âœ“] IRQ ç¶å®šåˆ°ç‰¹å®š CPU
[âœ“] é—œé–‰ irqbalance
[âœ“] CPU governor = performance
[âœ“] ç¶²å¡ RSS/RPS è¨­å®š

Socket é¸é …ï¼š
[âœ“] SO_BUSY_POLLï¼ˆ50Î¼sï¼‰
[âœ“] SO_REUSEPORTï¼ˆå¤šåŸ·è¡Œç·’ï¼‰
[âœ“] SO_RCVBUFï¼ˆå¢å¤§ç·©è¡å€ï¼‰
[âœ“] O_NONBLOCKï¼ˆéé˜»å¡ï¼‰

ç¨‹å¼è¨­è¨ˆï¼š
[âœ“] ä½¿ç”¨ epoll edge-triggered
[âœ“] ä½¿ç”¨ recvmmsg æ‰¹æ¬¡æ¥æ”¶
[âœ“] CPU affinity ç¶å®š
[âœ“] é¿å…è¨˜æ†¶é«”åˆ†é…
[âœ“] Batch è™•ç†
</code></pre>
<h3 id="ä½•æ™‚å‡ç´šåˆ°-dpdk"><a class="header" href="#ä½•æ™‚å‡ç´šåˆ°-dpdk">ä½•æ™‚å‡ç´šåˆ° DPDKï¼Ÿ</a></h3>
<pre><code>å‚³çµ±æ–¹æ¡ˆèƒ½æ»¿è¶³ï¼š
  âœ“ å»¶é²è¦æ±‚ &gt; 10Î¼s
  âœ“ ååé‡ &lt; 2M pps
  âœ“ éœ€è¦æ¨™æº– TCP/IP å”è­°æ£§
  âœ“ å…±äº«ä¼ºæœå™¨ç’°å¢ƒ

è€ƒæ…® DPDKï¼š
  âœ— å»¶é²è¦æ±‚ &lt; 5Î¼s
  âœ— ååé‡ &gt; 5M pps
  âœ— éœ€è¦æ¥µè‡´æ•ˆèƒ½
  âœ— å¯ä»¥ç¨ä½”ç¶²å¡
</code></pre>
<blockquote>
<p><strong>çµè«–</strong>ï¼šåœ¨æ²’æœ‰ DPDK çš„æƒ…æ³ä¸‹ï¼Œ<strong>epoll (edge-triggered) + recvmmsg + SO_BUSY_POLL</strong> æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œå¯ä»¥é”åˆ° ~10Î¼s å»¶é²å’Œ 1-2M pps ååé‡ã€‚</p>
</blockquote>
<hr />
<h2 id="252-å–®ä¸€é«˜é »é€£ç·šçš„-io-æ¨¡å‹é¸æ“‡"><a class="header" href="#252-å–®ä¸€é«˜é »é€£ç·šçš„-io-æ¨¡å‹é¸æ“‡">2.5.2 å–®ä¸€é«˜é »é€£ç·šçš„ I/O æ¨¡å‹é¸æ“‡</a></h2>
<h3 id="é‡è¦å•é¡Œå–®ä¸€-udp-é€£ç·šéœ€è¦ç”¨-epoll-å—"><a class="header" href="#é‡è¦å•é¡Œå–®ä¸€-udp-é€£ç·šéœ€è¦ç”¨-epoll-å—">é‡è¦å•é¡Œï¼šå–®ä¸€ UDP é€£ç·šéœ€è¦ç”¨ epoll å—ï¼Ÿ</a></h3>
<p><strong>å ´æ™¯</strong>ï¼šæ¥æ”¶å°ç£è­‰åˆ¸äº¤æ˜“æ‰€ UDP Multicast å ±åƒ¹ï¼ˆTSE Receiverï¼‰</p>
<ul>
<li>âœ… åªæœ‰ä¸€å€‹ UDP socket</li>
<li>âœ… é«˜é »å ±åƒ¹ï¼ˆæ¯ç§’æ•¸åƒåˆ°æ•¸è¬ç­†ï¼‰</li>
<li>âœ… è¦æ±‚æ¥µä½å»¶é²ï¼ˆå¾®ç§’ç´šï¼‰</li>
</ul>
<p><strong>ç­”æ¡ˆï¼šâŒ ä¸æ‡‰è©²ç”¨ epollï¼æ‡‰è©²ç”¨éé˜»å¡ + Busy Polling</strong></p>
<h3 id="epoll-vs-busy-polling-å»¶é²å°æ¯”"><a class="header" href="#epoll-vs-busy-polling-å»¶é²å°æ¯”">epoll vs Busy Polling å»¶é²å°æ¯”</a></h3>
<h4 id="ç‚ºä»€éº¼-epoll-åœ¨å–®ä¸€é€£ç·šä¸‹æ›´æ…¢"><a class="header" href="#ç‚ºä»€éº¼-epoll-åœ¨å–®ä¸€é€£ç·šä¸‹æ›´æ…¢">ç‚ºä»€éº¼ epoll åœ¨å–®ä¸€é€£ç·šä¸‹æ›´æ…¢ï¼Ÿ</a></h4>
<pre><code>Busy Polling æµç¨‹ï¼ˆç›®å‰æœ€ä½³æ–¹æ¡ˆï¼‰ï¼š
ç”¨æˆ¶æ…‹ â†’ recvfrom (syscall) â†’ å…§æ ¸æª¢æŸ¥ â†’ è¿”å›ç”¨æˆ¶æ…‹
ç¸½å»¶é²ï¼š~1-3 Î¼s

epoll æµç¨‹ï¼ˆä¸æ¨è–¦ï¼‰ï¼š
ç”¨æˆ¶æ…‹ â†’ epoll_wait (syscall) â†’ å…§æ ¸ä¼‘çœ  â†’ å°åŒ…åˆ°é”
  â†’ å–šé†’é€²ç¨‹ â†’ è¿”å›ç”¨æˆ¶æ…‹ â†’ recvfrom (syscall)
ç¸½å»¶é²ï¼š~10-50 Î¼sï¼ˆå¤šäº† context switch å’Œå–šé†’é–‹éŠ·ï¼‰
</code></pre>
<h4 id="å»¶é²åˆ†æè¡¨"><a class="header" href="#å»¶é²åˆ†æè¡¨">å»¶é²åˆ†æè¡¨</a></h4>
<div class="table-wrapper"><table><thead><tr><th>æ–¹æ³•</th><th>å¹³å‡å»¶é²</th><th>P99 å»¶é²</th><th>CPU ä½¿ç”¨ç‡</th><th>è¤‡é›œåº¦</th><th>é©ç”¨å ´æ™¯</th></tr></thead><tbody>
<tr><td><strong>Busy Pollingï¼ˆéé˜»å¡ recvfromï¼‰</strong></td><td><strong>2-5 Î¼s</strong></td><td><strong>10 Î¼s</strong></td><td>100%</td><td>ä½ âœ…</td><td><strong>å–®ä¸€é«˜é »é€£ç·š</strong></td></tr>
<tr><td>+ SO_BUSY_POLL</td><td>1-3 Î¼s</td><td>8 Î¼s</td><td>100%</td><td>ä½</td><td>é€²éšå„ªåŒ–</td></tr>
<tr><td>+ AF_XDP</td><td>0.5-2 Î¼s</td><td>5 Î¼s</td><td>100%</td><td>é«˜</td><td>æ¥µè‡´ä½å»¶é²</td></tr>
<tr><td>epoll (ä¸å»ºè­°) âŒ</td><td>20-50 Î¼s</td><td>100 Î¼s</td><td>5%</td><td>ä¸­</td><td>å¤šé€£ç·šå ´æ™¯</td></tr>
<tr><td>é˜»å¡ recvfrom</td><td>50-100 Î¼s</td><td>200 Î¼s</td><td>&lt;1%</td><td>ä½</td><td>ä½é »æ‡‰ç”¨</td></tr>
</tbody></table>
</div>
<h3 id="æ ¸å¿ƒå·®ç•°åˆ†æ"><a class="header" href="#æ ¸å¿ƒå·®ç•°åˆ†æ">æ ¸å¿ƒå·®ç•°åˆ†æ</a></h3>
<h4 id="1-epoll_wait-çš„é¡å¤–é–‹éŠ·"><a class="header" href="#1-epoll_wait-çš„é¡å¤–é–‹éŠ·">1. epoll_wait çš„é¡å¤–é–‹éŠ·</a></h4>
<pre><code class="language-c">// âŒ ä½¿ç”¨ epollï¼ˆåè€Œæ›´æ…¢ï¼‰
int epfd = epoll_create1(0);
struct epoll_event ev, events[1];
ev.events = EPOLLIN;
ev.data.fd = sockfd;
epoll_ctl(epfd, EPOLL_CTL_ADD, sockfd, &amp;ev);

while (1) {
    // æ­¥é©Ÿ 1ï¼šepoll_waitï¼ˆéœ€è¦ context switchï¼‰
    int nfds = epoll_wait(epfd, events, 1, -1);  // ~10-50 Î¼s

    if (nfds &gt; 0) {
        // æ­¥é©Ÿ 2ï¼šrecvfrom
        nbytes = recvfrom(sockfd, buf, size, 0, ...);  // ~1-3 Î¼s
    }
}

// ç¸½å»¶é²ï¼šepoll_wait + recvfrom â‰ˆ 11-53 Î¼s
</code></pre>
<pre><code class="language-c">// âœ… ä½¿ç”¨ Busy Pollingï¼ˆæ›´å¿«ï¼‰
int flags = fcntl(sockfd, F_GETFL, 0);
fcntl(sockfd, F_SETFL, flags | O_NONBLOCK);

while (1) {
    // åªæœ‰ä¸€å€‹æ­¥é©Ÿï¼šrecvfrom
    nbytes = recvfrom(sockfd, buf, size, 0, ...);  // ~1-3 Î¼s

    if (nbytes &lt; 0 &amp;&amp; errno == EAGAIN) {
        continue;  // ç«‹å³é‡è©¦ï¼ŒCPU 100%
    }

    // è™•ç†è³‡æ–™...
}

// ç¸½å»¶é²ï¼šrecvfrom â‰ˆ 1-3 Î¼s
</code></pre>
<h4 id="2-ç‚ºä»€éº¼-epoll-é¡å¤–å¢åŠ -10-50-Î¼s"><a class="header" href="#2-ç‚ºä»€éº¼-epoll-é¡å¤–å¢åŠ -10-50-Î¼s">2. ç‚ºä»€éº¼ epoll é¡å¤–å¢åŠ  10-50 Î¼sï¼Ÿ</a></h4>
<pre><code>epoll_wait çš„å…§éƒ¨æµç¨‹ï¼š
1. ç³»çµ±å‘¼å«é€²å…¥ kernel space     (~100-200 cycles)
2. æª¢æŸ¥ socket ç‹€æ…‹
3. å¦‚æœæ²’è³‡æ–™ â†’ é€²ç¨‹ä¼‘çœ            (context switch é–‹éŠ·)
4. å°åŒ…åˆ°é” â†’ ç¡¬é«”ä¸­æ–·
5. å…§æ ¸å–šé†’é€²ç¨‹                    (context switch é–‹éŠ·)
6. è¿”å›ç”¨æˆ¶æ…‹                      (~100-200 cycles)

é¡å¤–é–‹éŠ·ä¸»è¦ä¾†è‡ªï¼š
- Context switchï¼ˆé€²ç¨‹ä¼‘çœ /å–šé†’ï¼‰ï¼š5-20 Î¼s
- ä¸­æ–·è™•ç†ï¼š5-10 Î¼s
- æ’ç¨‹å™¨é–‹éŠ·ï¼š1-5 Î¼s
</code></pre>
<h3 id="å¯¦æˆ°ç¯„ä¾‹tse-receiver-æœ€ä½³å¯¦ä½œ"><a class="header" href="#å¯¦æˆ°ç¯„ä¾‹tse-receiver-æœ€ä½³å¯¦ä½œ">å¯¦æˆ°ç¯„ä¾‹ï¼šTSE Receiver æœ€ä½³å¯¦ä½œ</a></h3>
<h4 id="åŸºç¤ç‰ˆæœ¬å·²ç¶“å¾ˆå¥½"><a class="header" href="#åŸºç¤ç‰ˆæœ¬å·²ç¶“å¾ˆå¥½">åŸºç¤ç‰ˆæœ¬ï¼ˆå·²ç¶“å¾ˆå¥½ï¼‰</a></h4>
<pre><code class="language-c">#include &lt;fcntl.h&gt;
#include &lt;errno.h&gt;
#include &lt;sys/socket.h&gt;

int sockfd = socket(AF_INET, SOCK_DGRAM, 0);
bind(sockfd, ...);

// è¨­å®šéé˜»å¡æ¨¡å¼
int flags = fcntl(sockfd, F_GETFL, 0);
fcntl(sockfd, F_SETFL, flags | O_NONBLOCK);

// è¨­å®šå¤§çš„æ¥æ”¶ç·©è¡å€
int rcvbuf = 8 * 1024 * 1024;  // 8 MB
setsockopt(sockfd, SOL_SOCKET, SO_RCVBUF, &amp;rcvbuf, sizeof(rcvbuf));

// Busy Polling ä¸»è¿´åœˆ
char buffer[5120];
while (1) {
    struct sockaddr_in src_addr;
    socklen_t addrlen = sizeof(src_addr);

    int nbytes = recvfrom(sockfd, buffer, sizeof(buffer), 0,
                          (struct sockaddr*)&amp;src_addr, &amp;addrlen);

    // ç«‹å³è¨˜éŒ„æ™‚é–“æˆ³ï¼ˆé—œéµï¼ï¼‰
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &amp;ts);
    long long timestamp = ts.tv_sec * 1000000LL + ts.tv_nsec / 1000;

    if (nbytes &lt; 0) {
        if (errno == EAGAIN || errno == EWOULDBLOCK) {
            continue;  // æ²’è³‡æ–™ï¼Œç«‹å³é‡è©¦
        }
        perror("recvfrom");
        break;
    }

    // è™•ç†å°åŒ…
    process_packet(buffer, nbytes, timestamp);
}
</code></pre>
<h4 id="é€²éšå„ªåŒ–-1å•Ÿç”¨-so_busy_poll"><a class="header" href="#é€²éšå„ªåŒ–-1å•Ÿç”¨-so_busy_poll">é€²éšå„ªåŒ– 1ï¼šå•Ÿç”¨ SO_BUSY_POLL</a></h4>
<pre><code class="language-c">// åœ¨ socket è¨­å®šä¸­åŠ å…¥
int busy_poll = 50;  // å¾®ç§’
if (setsockopt(sockfd, SOL_SOCKET, SO_BUSY_POLL,
               &amp;busy_poll, sizeof(busy_poll)) &lt; 0) {
    fprintf(stderr, "[WARN] SO_BUSY_POLL è¨­å®šå¤±æ•—\n");
}
</code></pre>
<p><strong>æ•ˆæœ</strong>ï¼š</p>
<ul>
<li>æ¸›å°‘å…§æ ¸çš„ interrupt è™•ç†å»¶é²</li>
<li>å¹³å‡å»¶é²å¾ 2-5 Î¼s é™åˆ° 1-3 Î¼s</li>
<li>P99 å»¶é²å¾ 10 Î¼s é™åˆ° 8 Î¼s</li>
</ul>
<p><strong>åŸç†</strong>ï¼š</p>
<pre><code>å‚³çµ±æ¨¡å¼ï¼š
  å°åŒ…åˆ°é” â†’ ç¡¬é«”ä¸­æ–· â†’ å…§æ ¸è™•ç† â†’ è³‡æ–™é€² socket buffer
  å»¶é²ï¼š5-10 Î¼sï¼ˆä¸­æ–·è™•ç†é–‹éŠ·ï¼‰

SO_BUSY_POLL æ¨¡å¼ï¼š
  å…§æ ¸åœ¨ recvfrom æ™‚æœƒä¸»å‹•è¼ªè©¢ç¶²å¡ï¼ˆ50 Î¼s å…§ï¼‰
  å»¶é²ï¼š1-3 Î¼sï¼ˆæ¸›å°‘ä¸­æ–·å»¶é²ï¼‰
</code></pre>
<h4 id="é€²éšå„ªåŒ–-2ä½¿ç”¨-msg_dontwait-ä»£æ›¿-o_nonblock"><a class="header" href="#é€²éšå„ªåŒ–-2ä½¿ç”¨-msg_dontwait-ä»£æ›¿-o_nonblock">é€²éšå„ªåŒ– 2ï¼šä½¿ç”¨ MSG_DONTWAIT ä»£æ›¿ O_NONBLOCK</a></h4>
<pre><code class="language-c">// ç§»é™¤å…¨åŸŸè¨­å®š
// fcntl(sockfd, F_SETFL, flags | O_NONBLOCK);  â† ç§»é™¤

// æ”¹ç‚ºæ¯æ¬¡ recvfrom æ™‚æŒ‡å®š
nbytes = recvfrom(sockfd, buffer, sizeof(buffer),
                  MSG_DONTWAIT,  // â† åŠ ä¸Šé€™å€‹ flag
                  (struct sockaddr*)&amp;src_addr, &amp;addrlen);
</code></pre>
<p><strong>æ•ˆæœ</strong>ï¼š</p>
<ul>
<li>ç†è«–ä¸Šç•¥å¿«ï¼ˆ&lt;1 Î¼sï¼‰ï¼Œå› ç‚ºé¿å… fcntl çš„æª¢æŸ¥</li>
<li>å¯¦éš›å·®ç•°å¾ˆå°ï¼Œä½†é€™æ˜¯æœ€ä½³å¯¦è¸</li>
</ul>
<h3 id="é€²éšå„ªåŒ–-3kernel-bypassaf_xdp"><a class="header" href="#é€²éšå„ªåŒ–-3kernel-bypassaf_xdp">é€²éšå„ªåŒ– 3ï¼šKernel Bypassï¼ˆAF_XDPï¼‰</a></h3>
<p>å¦‚æœéœ€è¦ <strong>æ¥µè‡´ä½å»¶é² (&lt;1 Î¼s)</strong>ï¼Œè€ƒæ…®ä½¿ç”¨ AF_XDPï¼ˆLinux 4.18+ï¼‰ï¼š</p>
<pre><code class="language-c">#include &lt;linux/if_xdp.h&gt;
#include &lt;bpf/xsk.h&gt;

// 1. å»ºç«‹ XDP socket
struct xsk_socket_config cfg;
struct xsk_umem_config umem_cfg;
struct xsk_socket *xsk;

// 2. è¨­å®š UMEM (User Space Memory)
xsk_umem__create(&amp;umem, buffer, size, &amp;umem_cfg);

// 3. å»ºç«‹ XDP socket
xsk_socket__create(&amp;xsk, interface, queue_id, umem, &amp;rx_ring, &amp;tx_ring, &amp;cfg);

// 4. Busy Pollingï¼ˆé›¶æ‹·è²ï¼‰
while (1) {
    __u32 idx_rx = 0;
    __u32 nb_rx = xsk_ring_cons__peek(&amp;rx_ring, BATCH_SIZE, &amp;idx_rx);

    for (__u32 i = 0; i &lt; nb_rx; i++) {
        const struct xdp_desc *desc =
            xsk_ring_cons__rx_desc(&amp;rx_ring, idx_rx++);

        void *pkt = xsk_umem__get_data(umem_area, desc-&gt;addr);
        process_packet(pkt, desc-&gt;len);
    }

    xsk_ring_cons__release(&amp;rx_ring, nb_rx);
}
</code></pre>
<p><strong>AF_XDP å„ªå‹¢ï¼š</strong></p>
<ul>
<li>å»¶é²ï¼š0.5-2 Î¼sï¼ˆæ¥è¿‘ DPDKï¼‰</li>
<li>é›¶æ‹·è²ï¼ˆDMA ç›´æ¥å¯«å…¥ç”¨æˆ¶ç©ºé–“ï¼‰</li>
<li>ä¸éœ€è¦å°ˆç”¨é©…å‹•ï¼ˆç›¸å®¹æ¨™æº– Linuxï¼‰</li>
</ul>
<p><strong>ä»£åƒ¹ï¼š</strong></p>
<ul>
<li>è¨­å®šè¤‡é›œåº¦é«˜</li>
<li>éœ€è¦ Linux 4.18+</li>
<li>éœ€è¦æ‰‹å‹•è§£æ Ethernet/IP/UDP header</li>
</ul>
<h3 id="ç³»çµ±é…ç½®è¦é»"><a class="header" href="#ç³»çµ±é…ç½®è¦é»">ç³»çµ±é…ç½®è¦é»</a></h3>
<h4 id="1-cpu-affinityå¿…é ˆ"><a class="header" href="#1-cpu-affinityå¿…é ˆ">1. CPU Affinityï¼ˆå¿…é ˆï¼ï¼‰</a></h4>
<pre><code class="language-bash"># å°‡ç¨‹å¼ç¶å®šåˆ°ç‰¹å®š CPU
sudo taskset -c 1 ./tse_receiver_production
</code></pre>
<p>æˆ–åœ¨ç¨‹å¼ä¸­è¨­å®šï¼š</p>
<pre><code class="language-c">#include &lt;sched.h&gt;

cpu_set_t cpuset;
CPU_ZERO(&amp;cpuset);
CPU_SET(1, &amp;cpuset);  // ç¶å®šåˆ° CPU 1
pthread_setaffinity_np(pthread_self(), sizeof(cpu_set_t), &amp;cpuset);
</code></pre>
<h4 id="2-irq-ç¶å®šé‡è¦"><a class="header" href="#2-irq-ç¶å®šé‡è¦">2. IRQ ç¶å®šï¼ˆé‡è¦ï¼ï¼‰</a></h4>
<pre><code class="language-bash"># æŸ¥çœ‹ç¶²å¡ IRQ
grep eth0 /proc/interrupts

# å°‡ç¶²å¡ IRQ ç¶å®šåˆ°åŒä¸€å€‹ CPUï¼ˆæˆ–ç›¸é„° CPUï¼‰
echo 2 &gt; /proc/irq/&lt;IRQ_NUM&gt;/smp_affinity  # 0x2 = CPU 1
</code></pre>
<h4 id="3-ç³»çµ±åƒæ•¸å„ªåŒ–"><a class="header" href="#3-ç³»çµ±åƒæ•¸å„ªåŒ–">3. ç³»çµ±åƒæ•¸å„ªåŒ–</a></h4>
<pre><code class="language-bash"># é—œé–‰ irqbalance
sudo systemctl stop irqbalance
sudo systemctl disable irqbalance

# CPU governor = performance
sudo cpupower frequency-set -g performance

# å¢å¤§ç¶²è·¯ç·©è¡å€
sudo sysctl -w net.core.rmem_max=134217728  # 128 MB
sudo sysctl -w net.core.rmem_default=8388608  # 8 MB
</code></pre>
<h3 id="ä½•æ™‚æ‡‰è©²ç”¨-epoll"><a class="header" href="#ä½•æ™‚æ‡‰è©²ç”¨-epoll">ä½•æ™‚æ‡‰è©²ç”¨ epollï¼Ÿ</a></h3>
<pre><code>âœ… æ‡‰è©²ç”¨ epoll çš„å ´æ™¯ï¼š
  - å¤šå€‹é€£ç·šï¼ˆ&gt; 10 å€‹ socketï¼‰
  - ä¸éœ€è¦æ¥µä½å»¶é²ï¼ˆå¯æ¥å— &gt;10 Î¼sï¼‰
  - éœ€è¦ç¯€çœ CPUï¼ˆä¸èƒ½ 100% ä½¿ç”¨ï¼‰
  - éœ€è¦è™•ç† TCP é€£ç·š

âŒ ä¸æ‡‰è©²ç”¨ epoll çš„å ´æ™¯ï¼š
  - å–®ä¸€é€£ç·šï¼ˆ1-2 å€‹ socketï¼‰âœ… æœ¬ä¾‹
  - éœ€è¦æ¥µä½å»¶é²ï¼ˆ&lt;10 Î¼sï¼‰âœ… æœ¬ä¾‹
  - å¯ä»¥çŠ§ç‰² CPUï¼ˆ100% å¯æ¥å—ï¼‰âœ… æœ¬ä¾‹
  - é«˜é » UDP å°åŒ…ï¼ˆ&gt;1000 ppsï¼‰âœ… æœ¬ä¾‹
</code></pre>
<h3 id="ç¸½çµèˆ‡å»ºè­°"><a class="header" href="#ç¸½çµèˆ‡å»ºè­°">ç¸½çµèˆ‡å»ºè­°</a></h3>
<h4 id="-ä¸è¦ç”¨-epollå› ç‚º"><a class="header" href="#-ä¸è¦ç”¨-epollå› ç‚º">âŒ ä¸è¦ç”¨ epollï¼Œå› ç‚ºï¼š</a></h4>
<ol>
<li><strong>åªæœ‰ä¸€å€‹é€£ç·š</strong>ï¼Œepoll æ²’æœ‰å„ªå‹¢</li>
<li><strong>epoll_wait éœ€è¦ context switch</strong>ï¼Œå¢åŠ  10-50 Î¼s å»¶é²</li>
<li><strong>é«˜é »äº¤æ˜“éœ€è¦çŠ§ç‰² CPU æ›å–å»¶é²</strong></li>
</ol>
<h4 id="-tse-receiver-å·²ç¶“æ¡ç”¨æœ€ä½³ç­–ç•¥"><a class="header" href="#-tse-receiver-å·²ç¶“æ¡ç”¨æœ€ä½³ç­–ç•¥">âœ… TSE Receiver å·²ç¶“æ¡ç”¨æœ€ä½³ç­–ç•¥ï¼š</a></h4>
<ul>
<li>éé˜»å¡ + Busy Polling</li>
<li>CPU affinityï¼ˆ<code>taskset -c 1</code>ï¼‰</li>
<li>å¤§çš„æ¥æ”¶ç·©è¡å€ï¼ˆ8 MBï¼‰</li>
<li>ç«‹å³è¨˜éŒ„æ™‚é–“æˆ³</li>
</ul>
<h4 id="-å¯é¸çš„é€²éšå„ªåŒ–"><a class="header" href="#-å¯é¸çš„é€²éšå„ªåŒ–">ğŸš€ å¯é¸çš„é€²éšå„ªåŒ–ï¼š</a></h4>
<div class="table-wrapper"><table><thead><tr><th>å„ªåŒ–æ–¹æ¡ˆ</th><th>å»¶é²æ”¹å–„</th><th>è¤‡é›œåº¦</th><th>å»ºè­°</th></tr></thead><tbody>
<tr><td>åŠ å…¥ <code>SO_BUSY_POLL</code></td><td>5-10 Î¼s</td><td>ä½</td><td><strong>æ¨è–¦</strong></td></tr>
<tr><td>ä½¿ç”¨ <code>MSG_DONTWAIT</code></td><td>&lt;1 Î¼s</td><td>ä½</td><td>æ¨è–¦</td></tr>
<tr><td>CPU Affinity + IRQ ç¶å®š</td><td>2-5 Î¼s</td><td>ä¸­</td><td><strong>æ¨è–¦</strong></td></tr>
<tr><td>AF_XDP (Kernel Bypass)</td><td>1-3 Î¼s</td><td>é«˜</td><td>éœ€è¦æ™‚è€ƒæ…®</td></tr>
<tr><td>DPDK</td><td>1-2 Î¼s</td><td>éå¸¸é«˜</td><td>é€šå¸¸ä¸éœ€è¦</td></tr>
</tbody></table>
</div>
<h4 id="å¯¦æ¸¬æ•¸æ“šå°æ¯”tse-udp-multicast"><a class="header" href="#å¯¦æ¸¬æ•¸æ“šå°æ¯”tse-udp-multicast">å¯¦æ¸¬æ•¸æ“šå°æ¯”ï¼ˆTSE UDP Multicastï¼‰</a></h4>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ–¹æ³•              â”‚ å¹³å‡å»¶é² â”‚ P99 å»¶é² â”‚ CPU  â”‚ è¤‡é›œåº¦ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç›®å‰æ–¹æ¡ˆï¼ˆBusy Pollingï¼‰  â”‚  2-5 Î¼s  â”‚  10 Î¼s   â”‚ 100% â”‚ ä½ âœ…  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + SO_BUSY_POLL           â”‚  1-3 Î¼s  â”‚   8 Î¼s   â”‚ 100% â”‚   ä½   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + AF_XDP                 â”‚ 0.5-2 Î¼s â”‚   5 Î¼s   â”‚ 100% â”‚   é«˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä½¿ç”¨ epollï¼ˆä¸å»ºè­°ï¼‰âŒ    â”‚ 20-50 Î¼s â”‚ 100 Î¼s   â”‚  5%  â”‚   ä¸­   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<blockquote>
<p><strong>çµè«–</strong>ï¼šå°æ–¼å–®ä¸€é«˜é » UDP é€£ç·šï¼Œ<strong>éé˜»å¡ recvfrom + Busy Polling</strong> æ˜¯æœ€ä½³é¸æ“‡ï¼Œå»¶é²æ¯” epoll ä½ 10-20 å€ï¼ä¿æŒç›®å‰çš„å¯¦ä½œæ–¹å¼ï¼Œé€™å°±æ˜¯é«˜é »äº¤æ˜“çš„æ¨™æº–åšæ³•ã€‚</p>
</blockquote>
<hr />
<h2 id="26-ä¸»æµ-kernel-bypass-æŠ€è¡“å°æ¯”"><a class="header" href="#26-ä¸»æµ-kernel-bypass-æŠ€è¡“å°æ¯”">2.6 ä¸»æµ Kernel Bypass æŠ€è¡“å°æ¯”</a></h2>
<h3 id="ç‚ºä»€éº¼ä¸èƒ½ç”¨-recvfrom"><a class="header" href="#ç‚ºä»€éº¼ä¸èƒ½ç”¨-recvfrom">ç‚ºä»€éº¼ä¸èƒ½ç”¨ recvfromï¼Ÿ</a></h3>
<p>ç•¶ä½ å•Ÿå‹• DPDK æˆ–ç›¸é—œæŠ€è¡“æ™‚ï¼ŒæœƒåŸ·è¡Œã€Œç¶å®šé©…å‹•ã€(Binding Driver) å‹•ä½œï¼š</p>
<pre><code>å‚³çµ± Linux ç¶²è·¯æ£§                Kernel Bypass æ¨¡å¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ifconfig å¯çœ‹åˆ°ç¶²å¡ eth0        ifconfig çœ‹ä¸åˆ°ç¶²å¡ï¼ˆè¢«æ¥ç®¡ï¼‰
æ ¸å¿ƒè™•ç†æ‰€æœ‰å°åŒ…                  æ ¸å¿ƒå¤±å»æ§åˆ¶æ¬Š
recvfrom() å¯ç”¨                  recvfrom() æ‹¿ä¸åˆ°è³‡æ–™
å°åŒ…ç¶“éå®Œæ•´å”è­°æ£§                å°åŒ…ç›´æ¥åˆ° User Space
</code></pre>
<p><strong>é—œéµå·®ç•°</strong>ï¼šå°åŒ…è·¯å¾‘è®Šæˆ <code>ç¶²å¡ç¡¬é«” â†’ DMA â†’ User-space Memory</code></p>
<h3 id="ä¸»æµæŠ€è¡“å°æ¯”è¡¨"><a class="header" href="#ä¸»æµæŠ€è¡“å°æ¯”è¡¨">ä¸»æµæŠ€è¡“å°æ¯”è¡¨</a></h3>
<div class="table-wrapper"><table><thead><tr><th>æŠ€è¡“</th><th>å–åŒ…å‡½æ•¸</th><th>é©ç”¨å ´æ™¯</th><th>å»¶é²ç‰¹æ€§</th><th>å­¸ç¿’æ›²ç·š</th></tr></thead><tbody>
<tr><td><strong>DPDK</strong></td><td><code>rte_eth_rx_burst()</code></td><td>é€šç”¨é«˜æ•ˆèƒ½ç¶²è·¯æ‡‰ç”¨</td><td>500ns - 1Î¼s</td><td>ä¸­ç­‰</td></tr>
<tr><td><strong>RDMA/RoCE</strong></td><td><code>ibv_poll_cq()</code></td><td>é‡‘èäº¤æ˜“ã€è¶…ç®—</td><td>&lt; 500ns</td><td>è¼ƒé«˜</td></tr>
<tr><td><strong>Solarflare EF_VI</strong></td><td><code>ef_eventq_poll()</code></td><td>é‡‘èæ¥­æ¨™æº–</td><td>&lt; 300ns</td><td>é«˜</td></tr>
<tr><td><strong>XDP (AF_XDP)</strong></td><td><code>xsk_ring_cons__peek()</code></td><td>å…¼é¡§å®‰å…¨èˆ‡æ•ˆèƒ½</td><td>1-2Î¼s</td><td>ä½</td></tr>
</tbody></table>
</div>
<h3 id="1-dpdk-æœ€ä¸»æµé–‹ç™¼æ¡†æ¶"><a class="header" href="#1-dpdk-æœ€ä¸»æµé–‹ç™¼æ¡†æ¶">1. DPDK (æœ€ä¸»æµé–‹ç™¼æ¡†æ¶)</a></h3>
<p><strong>ç‰¹é»</strong>ï¼šé€éç’°å¢ƒæŠ½è±¡å±¤ (EAL) æ¥ç®¡ç¶²å¡ï¼Œå®Œå…¨ä¸ç¶“éæ ¸å¿ƒ</p>
<h4 id="å–åŒ…å‡½æ•¸"><a class="header" href="#å–åŒ…å‡½æ•¸">å–åŒ…å‡½æ•¸</a></h4>
<pre><code class="language-cpp">uint16_t rte_eth_rx_burst(
    uint16_t port_id,      // ç¶²å¡ port
    uint16_t queue_id,     // æ¥æ”¶ä½‡åˆ—ç·¨è™Ÿ
    struct rte_mbuf **rx_pkts,  // å°åŒ…ç·©è¡å€é™£åˆ—
    const uint16_t nb_pkts      // æœ€å¤šå–å¹¾å€‹å°åŒ…
);
</code></pre>
<h4 id="ç‰¹æ€§"><a class="header" href="#ç‰¹æ€§">ç‰¹æ€§</a></h4>
<ul>
<li><strong>æ‰¹é‡è™•ç†</strong>ï¼šä¸€æ¬¡å¯å–å› 1-32 å€‹ï¼ˆæˆ–æ›´å¤šï¼‰å°åŒ…</li>
<li><strong>é›¶æ‹·è²</strong>ï¼šå°åŒ…ç›´æ¥ç”±ç¶²å¡é€é DMA å¯«å…¥é å…ˆåˆ†é…çš„ Hugepages è¨˜æ†¶é«”</li>
<li><strong>ç¤¾ç¾¤æ”¯æ´</strong>ï¼šæœ€æ´»èºçš„é–‹æºå°ˆæ¡ˆï¼Œæ–‡ä»¶å®Œæ•´</li>
</ul>
<h4 id="ç¨‹å¼æµç¨‹"><a class="header" href="#ç¨‹å¼æµç¨‹">ç¨‹å¼æµç¨‹</a></h4>
<pre><code class="language-cpp">// 1. åˆå§‹åŒ–
rte_eal_init(argc, argv);
mbuf_pool = rte_pktmbuf_pool_create(...);
rte_eth_dev_configure(port_id, ...);

// 2. è¼ªè©¢ (Busy Polling)
while (1) {
    struct rte_mbuf *bufs[BURST_SIZE];
    uint16_t nb_rx = rte_eth_rx_burst(port_id, 0, bufs, BURST_SIZE);

    for (uint16_t i = 0; i &lt; nb_rx; i++) {
        // 3. æ‰‹å‹•è§£ææ¨™é ­
        uint8_t *pkt = rte_pktmbuf_mtod(bufs[i], uint8_t*);
        parse_packet(pkt);
        rte_pktmbuf_free(bufs[i]);
    }
}
</code></pre>
<h3 id="2-rdma--roce-æ¥µä½å»¶é²ç¡¬é«”å¸è¼‰"><a class="header" href="#2-rdma--roce-æ¥µä½å»¶é²ç¡¬é«”å¸è¼‰">2. RDMA / RoCE (æ¥µä½å»¶é²ã€ç¡¬é«”å¸è¼‰)</a></h3>
<p><strong>ç‰¹é»</strong>ï¼šè®“å…©å°ä¸»æ©Ÿçš„è¨˜æ†¶é«”ç›´æ¥é€šè¨Šï¼Œå¸¸ç”¨æ–¼é‡‘èé«˜é »äº¤æ˜“æˆ–è¶…ç®—ä¸­å¿ƒ</p>
<h4 id="å–åŒ…å‡½æ•¸-1"><a class="header" href="#å–åŒ…å‡½æ•¸-1">å–åŒ…å‡½æ•¸</a></h4>
<pre><code class="language-c">int ibv_poll_cq(
    struct ibv_cq *cq,        // Completion Queue
    int num_entries,          // æœ€å¤šè¼ªè©¢å¹¾ç­†
    struct ibv_wc *wc         // Work Completion çµæœ
);
</code></pre>
<h4 id="ç‰¹æ€§-1"><a class="header" href="#ç‰¹æ€§-1">ç‰¹æ€§</a></h4>
<ul>
<li><strong>ä¸æ˜¯ã€Œæ¥æ”¶å°åŒ…ã€</strong>ï¼šè€Œæ˜¯æª¢æŸ¥ã€Œå®Œæˆä½‡åˆ—ã€(Completion Queue)</li>
<li><strong>ç¡¬é«”å¸è¼‰</strong>ï¼šç¶²å¡ç›´æ¥å°‡è³‡æ–™æ”¾é€²ä½ çš„è¨˜æ†¶é«”ï¼Œç•™ä¸‹å®Œæˆç´€éŒ„</li>
<li><strong>RDMA Read/Write</strong>ï¼šå¯ç›´æ¥è®€å¯«é ç«¯ä¸»æ©Ÿè¨˜æ†¶é«”</li>
</ul>
<h4 id="ç¨‹å¼æµç¨‹-1"><a class="header" href="#ç¨‹å¼æµç¨‹-1">ç¨‹å¼æµç¨‹</a></h4>
<pre><code class="language-c">// 1. åˆå§‹åŒ– RDMA è³‡æº
struct ibv_context *ctx = ibv_open_device(...);
struct ibv_cq *cq = ibv_create_cq(ctx, ...);
struct ibv_qp *qp = ibv_create_qp(pd, ...);

// 2. è¼ªè©¢å®Œæˆä½‡åˆ—
while (1) {
    struct ibv_wc wc;
    int n = ibv_poll_cq(cq, 1, &amp;wc);

    if (n &gt; 0 &amp;&amp; wc.status == IBV_WC_SUCCESS) {
        // è³‡æ–™å·²ç¶“åœ¨ä½ çš„è¨˜æ†¶é«”ä¸­
        void *data = (void *)wc.wr_id;
        process_data(data);
    }
}
</code></pre>
<h3 id="3-solarflare-ef_vi-é‡‘èæ¥­æ¨™æº–"><a class="header" href="#3-solarflare-ef_vi-é‡‘èæ¥­æ¨™æº–">3. Solarflare EF_VI (é‡‘èæ¥­æ¨™æº–)</a></h3>
<p><strong>ç‰¹é»</strong>ï¼šSolarflare ç¶²å¡å°ˆæœ‰çš„åº•å±¤ APIï¼Œä»¥æ¥µè‡´ä½å»¶é²è‘—ç¨±</p>
<h4 id="å–åŒ…å‡½æ•¸-2"><a class="header" href="#å–åŒ…å‡½æ•¸-2">å–åŒ…å‡½æ•¸</a></h4>
<pre><code class="language-c">int ef_eventq_poll(
    struct ef_vi* vi,         // Virtual Interface
    ef_event* evs,            // Event é™£åˆ—
    int evs_len               // æœ€å¤šå–å¹¾å€‹ event
);

int ef_vi_receive_post(
    struct ef_vi* vi,         // Virtual Interface
    ef_addr buf_addr,         // ç·©è¡å€ä½å€
    ef_request_id id          // Request ID
);
</code></pre>
<h4 id="ç‰¹æ€§-2"><a class="header" href="#ç‰¹æ€§-2">ç‰¹æ€§</a></h4>
<ul>
<li><strong>æ¯” DPDK æ›´è¼•é‡</strong>ï¼šç›´æ¥æ“ä½œç¶²å¡çš„ Event Queue</li>
<li><strong>è¶…ä½å»¶é²</strong>ï¼šå°ˆç‚ºé‡‘èå¸‚å ´è¨­è¨ˆ</li>
<li><strong>å» å•†é–å®š</strong>ï¼šåƒ…æ”¯æ´ Solarflare (ç¾ AMD) ç¶²å¡</li>
</ul>
<h3 id="4-xdp-express-data-path"><a class="header" href="#4-xdp-express-data-path">4. XDP (eXpress Data Path)</a></h3>
<p><strong>ç‰¹é»</strong>ï¼šLinux ç¤¾ç¾¤æ¨å´‡çš„æŠ€è¡“ï¼Œåœ¨å°åŒ…é€²å…¥å”è­°æ£§å‰æ””æˆªï¼Œçµåˆå®‰å…¨æ€§èˆ‡æ•ˆèƒ½</p>
<h4 id="å–åŒ…å‡½æ•¸-3"><a class="header" href="#å–åŒ…å‡½æ•¸-3">å–åŒ…å‡½æ•¸</a></h4>
<pre><code class="language-c">// AF_XDP User Space ä»‹é¢
__u32 xsk_ring_cons__peek(
    struct xsk_ring_cons *ring,  // æ¥æ”¶ ring
    __u32 nb,                    // æœ€å¤šå–å¹¾å€‹
    __u32 *idx                   // èµ·å§‹ç´¢å¼•
);
</code></pre>
<h4 id="ç‰¹æ€§-3"><a class="header" href="#ç‰¹æ€§-3">ç‰¹æ€§</a></h4>
<ul>
<li><strong>eBPF æ•´åˆ</strong>ï¼šå¯åœ¨ kernel å…§é€²è¡Œåˆæ­¥éæ¿¾</li>
<li><strong>å…¼é¡§å®‰å…¨</strong>ï¼šä¸éœ€è¦å®Œå…¨æ¥ç®¡ç¶²å¡</li>
<li><strong>æ•ˆèƒ½æ¥è¿‘ DPDK</strong>ï¼šä½†ä¿ç•™ Linux ç”Ÿæ…‹ç³»çµ±</li>
</ul>
<h4 id="ç¨‹å¼æµç¨‹-2"><a class="header" href="#ç¨‹å¼æµç¨‹-2">ç¨‹å¼æµç¨‹</a></h4>
<pre><code class="language-c">// 1. å»ºç«‹ AF_XDP socket
int xsk_fd = socket(AF_XDP, SOCK_RAW, 0);
struct xsk_socket *xsk;
xsk_socket__create(&amp;xsk, ifname, queue_id, ...);

// 2. è¼ªè©¢
while (1) {
    __u32 idx_rx = 0;
    __u32 nb_rx = xsk_ring_cons__peek(&amp;xsk-&gt;rx, BATCH_SIZE, &amp;idx_rx);

    for (__u32 i = 0; i &lt; nb_rx; i++) {
        const struct xdp_desc *desc = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx++);
        void *pkt = xsk_umem__get_data(xsk-&gt;umem_area, desc-&gt;addr);
        process_packet(pkt, desc-&gt;len);
    }

    xsk_ring_cons__release(&amp;xsk-&gt;rx, nb_rx);
}
</code></pre>
<h3 id="æŠ€è¡“é¸æ“‡å»ºè­°"><a class="header" href="#æŠ€è¡“é¸æ“‡å»ºè­°">æŠ€è¡“é¸æ“‡å»ºè­°</a></h3>
<pre><code>é€šç”¨å ´æ™¯          â†’ DPDK
  âœ“ ç¤¾ç¾¤æ”¯æ´ä½³
  âœ“ æ–‡ä»¶å®Œæ•´
  âœ“ è·¨å¹³å°

æ¥µè‡´å»¶é²          â†’ RDMA / Solarflare EF_VI
  âœ“ ç¡¬é«”å¸è¼‰
  âœ“ &lt; 500ns å»¶é²
  âœ— ç¡¬é«”æˆæœ¬é«˜

å…¼é¡§å®‰å…¨èˆ‡æ•ˆèƒ½     â†’ XDP
  âœ“ ä¸ç ´å£ Linux ç¶²è·¯æ£§
  âœ“ eBPF æ•´åˆ
  âœ“ å­¸ç¿’æ›²ç·šä½
</code></pre>
<h3 id="å…±é€šé–‹ç™¼æµç¨‹"><a class="header" href="#å…±é€šé–‹ç™¼æµç¨‹">å…±é€šé–‹ç™¼æµç¨‹</a></h3>
<p>ç„¡è«–é¸æ“‡å“ªç¨®æŠ€è¡“ï¼Œæ ¸å¿ƒæµç¨‹éƒ½é¡ä¼¼ï¼š</p>
<pre><code>1. åˆå§‹åŒ–
   â””â”€ æ¥ç®¡ç¶²å¡ / å»ºç«‹è³‡æº

2. è¨˜æ†¶é«”ç®¡ç†
   â””â”€ é å…ˆåˆ†é… Hugepages / UMEM

3. Busy Polling
   â””â”€ while(1) ä¸æ–·è¼ªè©¢

4. æ‰‹å‹•è§£æ
   â””â”€ è§£æ Ethernet/IP/UDP Header

5. è™•ç†æ¥­å‹™é‚è¼¯
   â””â”€ é¿å…ç³»çµ±å‘¼å«ã€é¿å…é–
</code></pre>
<hr />
<h2 id="3-æ‡‰ç”¨å±¤-cc-ç¨‹å¼è¨­è¨ˆ"><a class="header" href="#3-æ‡‰ç”¨å±¤-cc-ç¨‹å¼è¨­è¨ˆ">3ï¸âƒ£ æ‡‰ç”¨å±¤ C/C++ ç¨‹å¼è¨­è¨ˆ</a></h2>
<h3 id="å°ˆæ¡ˆæ¶æ§‹"><a class="header" href="#å°ˆæ¡ˆæ¶æ§‹">å°ˆæ¡ˆæ¶æ§‹</a></h3>
<pre><code>hft_project/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.cpp
â”‚   â”œâ”€â”€ dpdk_init.cpp
â”‚   â””â”€â”€ packet_handler.cpp
â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ config.h
â”‚   â””â”€â”€ lockfree_queue.hpp
â””â”€â”€ scripts/
    â”œâ”€â”€ setup.sh
    â””â”€â”€ run.sh
</code></pre>
<h3 id="ä¸»ç¨‹å¼-srcmaincpp"><a class="header" href="#ä¸»ç¨‹å¼-srcmaincpp">ä¸»ç¨‹å¼ (src/main.cpp)</a></h3>
<pre><code class="language-cpp">#include &lt;rte_eal.h&gt;
#include &lt;rte_ethdev.h&gt;
#include &lt;rte_mbuf.h&gt;
#include &lt;rte_cycles.h&gt;
#include &lt;pthread.h&gt;
#include &lt;sched.h&gt;

#define RX_RING_SIZE 1024
#define TX_RING_SIZE 1024
#define NUM_MBUFS 8191
#define MBUF_CACHE_SIZE 250
#define BURST_SIZE 32

// NUMA-aware memory pool
static struct rte_mempool *mbuf_pool = NULL;

// æ ¸å¿ƒé…ç½®
#define POLLING_CORE 2    // éš”é›¢çš„ core
#define NUMA_NODE 0       // NIC æ‰€åœ¨çš„ NUMA node

// å°‡åŸ·è¡Œç·’ç¶å®šåˆ°ç‰¹å®š CPU
static inline void bind_to_cpu(int cpu) {
    cpu_set_t cpuset;
    CPU_ZERO(&amp;cpuset);
    CPU_SET(cpu, &amp;cpuset);
    pthread_setaffinity_np(pthread_self(), sizeof(cpu_set_t), &amp;cpuset);
    
    // è¨­å®šæœ€é«˜å„ªå…ˆæ¬Š
    struct sched_param param;
    param.sched_priority = 99;
    pthread_setschedparam(pthread_self(), SCHED_FIFO, &amp;param);
}

// Port åˆå§‹åŒ–
static int port_init(uint16_t port) {
    struct rte_eth_conf port_conf = {};
    const uint16_t rx_rings = 1, tx_rings = 1;
    uint16_t nb_rxd = RX_RING_SIZE;
    uint16_t nb_txd = TX_RING_SIZE;
    int retval;
    
    // RSS é…ç½®ï¼ˆå¤š queue æ™‚ä½¿ç”¨ï¼‰
    port_conf.rxmode.mq_mode = RTE_ETH_MQ_RX_RSS;
    port_conf.rx_adv_conf.rss_conf.rss_key = NULL;
    port_conf.rx_adv_conf.rss_conf.rss_hf = 
        RTE_ETH_RSS_TCP | RTE_ETH_RSS_UDP;
    
    // é…ç½® port
    retval = rte_eth_dev_configure(port, rx_rings, tx_rings, &amp;port_conf);
    if (retval != 0) return retval;
    
    // èª¿æ•´ ring size
    retval = rte_eth_dev_adjust_nb_rx_tx_desc(port, &amp;nb_rxd, &amp;nb_txd);
    if (retval != 0) return retval;
    
    // é…ç½® RX queueï¼ˆç¶å®šåˆ° NUMA nodeï¼‰
    retval = rte_eth_rx_queue_setup(port, 0, nb_rxd,
        rte_eth_dev_socket_id(port), NULL, mbuf_pool);
    if (retval &lt; 0) return retval;
    
    // é…ç½® TX queue
    retval = rte_eth_tx_queue_setup(port, 0, nb_txd,
        rte_eth_dev_socket_id(port), NULL);
    if (retval &lt; 0) return retval;
    
    // å•Ÿå‹• port
    retval = rte_eth_dev_start(port);
    if (retval &lt; 0) return retval;
    
    // é–‹å•Ÿ promiscuous modeï¼ˆä¾éœ€æ±‚ï¼‰
    rte_eth_promiscuous_enable(port);
    
    return 0;
}

// å¿«é€Ÿå°åŒ…è™•ç†ï¼ˆinline æ¸›å°‘å‡½æ•¸å‘¼å«é–‹éŠ·ï¼‰
static inline void process_packet(struct rte_mbuf *mbuf) {
    // é›¶æ‹·è²ï¼šç›´æ¥æ“ä½œ mbuf çš„è³‡æ–™æŒ‡æ¨™
    uint8_t *pkt_data = rte_pktmbuf_mtod(mbuf, uint8_t*);
    
    // å‡è¨­è™•ç† Ethernet header
    // struct rte_ether_hdr *eth_hdr = (struct rte_ether_hdr *)pkt_data;
    
    // *** ä½ çš„æ¥­å‹™é‚è¼¯ ***
    // ä¾‹å¦‚ï¼šè§£æã€è¨ˆç®—ã€æ±ºç­–
    
    // é‡é»ï¼šé¿å…è¨˜æ†¶é«”è¤‡è£½ã€é¿å…ç³»çµ±å‘¼å«ã€é¿å…é–
}

// ä¸»è¿´åœˆï¼šBusy Polling
static int lcore_main(__rte_unused void *arg) {
    uint16_t port = 0;
    
    // ç¶å®šåˆ°éš”é›¢çš„ CPU
    bind_to_cpu(POLLING_CORE);
    
    printf("Core %u doing packet processing.\n", rte_lcore_id());
    
    // é ç†± cache
    struct rte_mbuf *bufs[BURST_SIZE];
    for (int i = 0; i &lt; 1000; i++) {
        uint16_t nb_rx = rte_eth_rx_burst(port, 0, bufs, BURST_SIZE);
        for (uint16_t i = 0; i &lt; nb_rx; i++) {
            rte_pktmbuf_free(bufs[i]);
        }
    }
    
    // ä¸»è¿´åœˆï¼šæ°¸é ä¸ç¡çœ 
    while (1) {
        // Burst æ¥æ”¶ï¼ˆæ¸›å°‘ overheadï¼‰
        uint16_t nb_rx = rte_eth_rx_burst(port, 0, bufs, BURST_SIZE);
        
        if (unlikely(nb_rx == 0)) {
            // å³ä½¿æ²’å°åŒ…ä¹Ÿä¸ç¡çœ 
            rte_pause(); // CPU pause æŒ‡ä»¤ï¼Œæ¸›å°‘åŠŸè€—
            continue;
        }
        
        // è™•ç†å°åŒ…
        for (uint16_t i = 0; i &lt; nb_rx; i++) {
            process_packet(bufs[i]);
            
            // é‡‹æ”¾ mbufï¼ˆæˆ–ç™¼é€å‡ºå»ï¼‰
            rte_pktmbuf_free(bufs[i]);
        }
    }
    
    return 0;
}

int main(int argc, char *argv[]) {
    // 1. åˆå§‹åŒ– DPDK EAL
    int ret = rte_eal_init(argc, argv);
    if (ret &lt; 0) {
        rte_exit(EXIT_FAILURE, "Error with EAL initialization\n");
    }
    argc -= ret;
    argv += ret;
    
    // 2. å»ºç«‹ Memory Poolï¼ˆNUMA-awareï¼‰
    mbuf_pool = rte_pktmbuf_pool_create("MBUF_POOL", NUM_MBUFS,
        MBUF_CACHE_SIZE, 0, RTE_MBUF_DEFAULT_BUF_SIZE, NUMA_NODE);
    if (mbuf_pool == NULL) {
        rte_exit(EXIT_FAILURE, "Cannot create mbuf pool\n");
    }
    
    // 3. åˆå§‹åŒ– port 0
    if (port_init(0) != 0) {
        rte_exit(EXIT_FAILURE, "Cannot init port 0\n");
    }
    
    // 4. å•Ÿå‹•è™•ç†è¿´åœˆ
    lcore_main(NULL);
    
    // æ¸…ç†ï¼ˆé€šå¸¸ä¸æœƒåŸ·è¡Œåˆ°ï¼‰
    rte_eal_cleanup();
    return 0;
}
</code></pre>
<h3 id="lock-free-queue-includelockfree_queuehpp"><a class="header" href="#lock-free-queue-includelockfree_queuehpp">Lock-free Queue (include/lockfree_queue.hpp)</a></h3>
<pre><code class="language-cpp">#pragma once
#include &lt;atomic&gt;
#include &lt;array&gt;

// Single Producer Single Consumer Lock-free Queue
template&lt;typename T, size_t SIZE&gt;
class SPSCQueue {
private:
    struct alignas(64) Node {  // Cache line alignment
        T data;
        std::atomic&lt;bool&gt; ready{false};
    };
    
    std::array&lt;Node, SIZE&gt; buffer_;
    alignas(64) std::atomic&lt;size_t&gt; write_idx_{0};
    alignas(64) std::atomic&lt;size_t&gt; read_idx_{0};
    
public:
    // ç”Ÿç”¢è€…ï¼šå¯«å…¥
    bool try_push(const T&amp; item) {
        size_t current_write = write_idx_.load(std::memory_order_relaxed);
        size_t next_write = (current_write + 1) % SIZE;
        
        // æª¢æŸ¥æ˜¯å¦å·²æ»¿
        if (next_write == read_idx_.load(std::memory_order_acquire)) {
            return false;
        }
        
        buffer_[current_write].data = item;
        buffer_[current_write].ready.store(true, std::memory_order_release);
        write_idx_.store(next_write, std::memory_order_release);
        return true;
    }
    
    // æ¶ˆè²»è€…ï¼šè®€å–
    bool try_pop(T&amp; item) {
        size_t current_read = read_idx_.load(std::memory_order_relaxed);
        
        if (!buffer_[current_read].ready.load(std::memory_order_acquire)) {
            return false;
        }
        
        item = buffer_[current_read].data;
        buffer_[current_read].ready.store(false, std::memory_order_release);
        read_idx_.store((current_read + 1) % SIZE, std::memory_order_release);
        return true;
    }
};
</code></pre>
<h3 id="cmakeliststxt"><a class="header" href="#cmakeliststxt">CMakeLists.txt</a></h3>
<pre><code class="language-cmake">cmake_minimum_required(VERSION 3.10)
project(hft_app)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O3 -march=native -mtune=native")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra")

# DPDK
find_package(PkgConfig REQUIRED)
pkg_check_modules(DPDK REQUIRED libdpdk)

include_directories(
    ${DPDK_INCLUDE_DIRS}
    ${CMAKE_SOURCE_DIR}/include
)

add_executable(hft_app
    src/main.cpp
)

target_link_libraries(hft_app
    ${DPDK_LIBRARIES}
    pthread
    numa
)
</code></pre>
<h3 id="å•Ÿå‹•è…³æœ¬-scriptsrunsh"><a class="header" href="#å•Ÿå‹•è…³æœ¬-scriptsrunsh">å•Ÿå‹•è…³æœ¬ (scripts/run.sh)</a></h3>
<pre><code class="language-bash">#!/bin/bash

# æª¢æŸ¥ root
if [ "$EUID" -ne 0 ]; then 
    echo "Please run as root"
    exit 1
fi

# è¨­å®š CPU affinity maskï¼ˆä½¿ç”¨éš”é›¢çš„ core 2ï¼‰
# -l 2: ä½¿ç”¨ lcore 2
# -n 4: 4 å€‹ memory channels
# --socket-mem: æ¯å€‹ NUMA node çš„è¨˜æ†¶é«” (MB)
./hft_app -l 2 -n 4 --socket-mem=1024 \
    --file-prefix=hft \
    -- \
    --portmask=0x1
</code></pre>
<hr />
<h2 id="4-é€²éšå„ªåŒ–æŠ€å·§"><a class="header" href="#4-é€²éšå„ªåŒ–æŠ€å·§">4ï¸âƒ£ é€²éšå„ªåŒ–æŠ€å·§</a></h2>
<h3 id="a-è¨˜æ†¶é«”å°é½Šèˆ‡-prefetch"><a class="header" href="#a-è¨˜æ†¶é«”å°é½Šèˆ‡-prefetch">A. è¨˜æ†¶é«”å°é½Šèˆ‡ Prefetch</a></h3>
<pre><code class="language-cpp">// 1. Cache line å°é½Šï¼ˆé¿å… false sharingï¼‰
struct alignas(64) Order {
    uint64_t timestamp;
    uint32_t price;
    uint32_t quantity;
    // ... å…¶ä»–æ¬„ä½
};

// 2. Prefetchï¼ˆæå‰è¼‰å…¥åˆ° cacheï¼‰
static inline void process_batch(Order* orders, int count) {
    for (int i = 0; i &lt; count; i++) {
        // æå‰è¼‰å…¥ä¸‹ä¸€ç­†
        if (i + 1 &lt; count) {
            __builtin_prefetch(&amp;orders[i + 1], 0, 3);
        }
        
        // è™•ç†ç•¶å‰é€™ç­†
        process_order(&amp;orders[i]);
    }
}
</code></pre>
<h3 id="b-branch-prediction-å„ªåŒ–"><a class="header" href="#b-branch-prediction-å„ªåŒ–">B. Branch Prediction å„ªåŒ–</a></h3>
<pre><code class="language-cpp">// ä½¿ç”¨ likely/unlikely æç¤ºç·¨è­¯å™¨
#define likely(x)   __builtin_expect(!!(x), 1)
#define unlikely(x) __builtin_expect(!!(x), 0)

if (unlikely(error_occurred)) {
    handle_error();
}

if (likely(packet_valid)) {
    process_packet();
}
</code></pre>
<h3 id="c-é¿å…-false-sharing"><a class="header" href="#c-é¿å…-false-sharing">C. é¿å… False Sharing</a></h3>
<pre><code class="language-cpp">// éŒ¯èª¤ï¼šå…©å€‹è®Šæ•¸åœ¨åŒä¸€ cache lineï¼Œå¤šæ ¸å¿ƒå¯«å…¥æœƒäº’ç›¸å½±éŸ¿
struct Bad {
    std::atomic&lt;uint64_t&gt; counter1;  // 8 bytes
    std::atomic&lt;uint64_t&gt; counter2;  // 8 bytes (same cache line!)
};

// æ­£ç¢ºï¼špadding åˆ†é›¢åˆ°ä¸åŒ cache line
struct Good {
    alignas(64) std::atomic&lt;uint64_t&gt; counter1;
    alignas(64) std::atomic&lt;uint64_t&gt; counter2;
};
</code></pre>
<h3 id="d-æ™‚é–“æˆ³è¨˜å–å¾—"><a class="header" href="#d-æ™‚é–“æˆ³è¨˜å–å¾—">D. æ™‚é–“æˆ³è¨˜å–å¾—</a></h3>
<pre><code class="language-cpp">// ä½¿ç”¨ RDTSCï¼ˆæœ€å¿«çš„æ™‚é–“æˆ³ï¼‰
static inline uint64_t rdtsc() {
    uint32_t lo, hi;
    __asm__ __volatile__ ("rdtsc" : "=a"(lo), "=d"(hi));
    return ((uint64_t)hi &lt;&lt; 32) | lo;
}

// æˆ–ä½¿ç”¨ DPDK çš„å°è£
uint64_t now = rte_rdtsc();

// è½‰æ› cycles åˆ° nanoseconds
uint64_t hz = rte_get_tsc_hz();
uint64_t ns = (cycles * 1000000000ULL) / hz;
</code></pre>
<hr />
<h2 id="5-æ¸¬è©¦èˆ‡é©—è­‰"><a class="header" href="#5-æ¸¬è©¦èˆ‡é©—è­‰">5ï¸âƒ£ æ¸¬è©¦èˆ‡é©—è­‰</a></h2>
<h3 id="latency-æ¸¬è©¦ç¨‹å¼"><a class="header" href="#latency-æ¸¬è©¦ç¨‹å¼">Latency æ¸¬è©¦ç¨‹å¼</a></h3>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;vector&gt;
#include &lt;algorithm&gt;

void measure_latency() {
    const int SAMPLES = 100000;
    std::vector&lt;uint64_t&gt; latencies;
    latencies.reserve(SAMPLES);
    
    for (int i = 0; i &lt; SAMPLES; i++) {
        uint64_t start = rte_rdtsc();
        
        // *** ä½ çš„è™•ç†é‚è¼¯ ***
        process_packet();
        
        uint64_t end = rte_rdtsc();
        latencies.push_back(end - start);
    }
    
    // æ’åºè¨ˆç®—ç™¾åˆ†ä½
    std::sort(latencies.begin(), latencies.end());
    
    uint64_t hz = rte_get_tsc_hz();
    auto cycles_to_ns = [hz](uint64_t cycles) {
        return (cycles * 1000000000ULL) / hz;
    };
    
    std::cout &lt;&lt; "P50:    " &lt;&lt; cycles_to_ns(latencies[SAMPLES * 50 / 100]) &lt;&lt; " ns\n";
    std::cout &lt;&lt; "P99:    " &lt;&lt; cycles_to_ns(latencies[SAMPLES * 99 / 100]) &lt;&lt; " ns\n";
    std::cout &lt;&lt; "P99.9:  " &lt;&lt; cycles_to_ns(latencies[SAMPLES * 999 / 1000]) &lt;&lt; " ns\n";
    std::cout &lt;&lt; "Max:    " &lt;&lt; cycles_to_ns(latencies.back()) &lt;&lt; " ns\n";
}
</code></pre>
<h3 id="ç³»çµ±é…ç½®æª¢æŸ¥è…³æœ¬-scriptschecksh"><a class="header" href="#ç³»çµ±é…ç½®æª¢æŸ¥è…³æœ¬-scriptschecksh">ç³»çµ±é…ç½®æª¢æŸ¥è…³æœ¬ (scripts/check.sh)</a></h3>
<pre><code class="language-bash">#!/bin/bash

echo "=== CPU Isolation Check ==="
cat /sys/devices/system/cpu/isolated

echo -e "\n=== CPU Governor ==="
cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor | sort -u

echo -e "\n=== C-States ==="
cat /sys/module/intel_idle/parameters/max_cstate

echo -e "\n=== IRQ Affinity ==="
grep eth0 /proc/interrupts

echo -e "\n=== Hugepages ==="
cat /proc/meminfo | grep Huge

echo -e "\n=== NUMA Topology ==="
numactl --hardware

echo -e "\n=== NIC Driver ==="
ethtool -i eth0

echo -e "\n=== NIC Queues ==="
ethtool -l eth0

echo -e "\n=== DPDK Binding ==="
dpdk-devbind.py --status
</code></pre>
<hr />
<h2 id="6-å®Œæ•´éƒ¨ç½²-checklist"><a class="header" href="#6-å®Œæ•´éƒ¨ç½²-checklist">6ï¸âƒ£ å®Œæ•´éƒ¨ç½² Checklist</a></h2>
<h3 id="ç¡¬é«”å±¤"><a class="header" href="#ç¡¬é«”å±¤">ç¡¬é«”å±¤</a></h3>
<pre><code>[âœ“] BIOSï¼šé—œé–‰ Hyper-Threading
[âœ“] BIOSï¼šé—œé–‰ C-States (C1E, C3, C6)
[âœ“] BIOSï¼šé—œé–‰ P-States / Turbo Boost
[âœ“] BIOSï¼šé–‹å•Ÿ VT-d / IOMMU
[âœ“] BIOSï¼šPerformance Mode
[âœ“] ç¶²å¡ï¼šIntel X710 æˆ– Mellanox ConnectX
[âœ“] ç¢ºèª NUMA æ‹“æ’²ï¼ˆNIC åœ¨å“ªå€‹ nodeï¼‰
</code></pre>
<h3 id="ç³»çµ±å±¤"><a class="header" href="#ç³»çµ±å±¤">ç³»çµ±å±¤</a></h3>
<pre><code>[âœ“] GRUBï¼šisolcpus=1-7
[âœ“] GRUBï¼šnohz_full=1-7
[âœ“] GRUBï¼šrcu_nocbs=1-7
[âœ“] GRUBï¼šintel_pstate=disable
[âœ“] GRUBï¼šintel_idle.max_cstate=0
[âœ“] GRUBï¼šHugepages 1GB
[âœ“] é—œé–‰ irqbalance
[âœ“] IRQ ç¶å®šåˆ° CPU 0
[âœ“] CPU governor = performance
[âœ“] DPDK ç¶²å¡ç¶å®š (vfio-pci)
[âœ“] æ›è¼‰ Hugepages
</code></pre>
<h3 id="æ‡‰ç”¨å±¤"><a class="header" href="#æ‡‰ç”¨å±¤">æ‡‰ç”¨å±¤</a></h3>
<pre><code>[âœ“] ä½¿ç”¨ DPDK PMD
[âœ“] Busy polling (while(1) loop)
[âœ“] ç¶å®šåˆ°éš”é›¢çš„ core (pthread_setaffinity_np)
[âœ“] SCHED_FIFO priority 99
[âœ“] Lock-free è³‡æ–™çµæ§‹
[âœ“] Cache line å°é½Š (alignas(64))
[âœ“] é¿å…å‹•æ…‹è¨˜æ†¶é«”åˆ†é… (malloc/free)
[âœ“] é›¶æ‹·è²è¨­è¨ˆ (ç›´æ¥æ“ä½œ mbuf)
[âœ“] Prefetch + Branch hints
[âœ“] NUMA-aware memory allocation
</code></pre>
<hr />
<h2 id="7-ç·¨è­¯èˆ‡åŸ·è¡Œ"><a class="header" href="#7-ç·¨è­¯èˆ‡åŸ·è¡Œ">7ï¸âƒ£ ç·¨è­¯èˆ‡åŸ·è¡Œ</a></h2>
<h3 id="å®‰è£ä¾è³´"><a class="header" href="#å®‰è£ä¾è³´">å®‰è£ä¾è³´</a></h3>
<pre><code class="language-bash"># Ubuntu/Debian
sudo apt update
sudo apt install -y dpdk dpdk-dev libnuma-dev \
    build-essential cmake pkg-config

# é©—è­‰ DPDK ç‰ˆæœ¬
dpdk-devbind.py --version
</code></pre>
<h3 id="ç·¨è­¯å°ˆæ¡ˆ"><a class="header" href="#ç·¨è­¯å°ˆæ¡ˆ">ç·¨è­¯å°ˆæ¡ˆ</a></h3>
<pre><code class="language-bash">mkdir build &amp;&amp; cd build
cmake ..
make -j$(nproc)
</code></pre>
<h3 id="é…ç½®ç³»çµ±éœ€-root"><a class="header" href="#é…ç½®ç³»çµ±éœ€-root">é…ç½®ç³»çµ±ï¼ˆéœ€ rootï¼‰</a></h3>
<pre><code class="language-bash"># åŸ·è¡Œ DPDK è¨­å®šè…³æœ¬
sudo ../scripts/setup.sh

# æª¢æŸ¥é…ç½®
sudo ../scripts/check.sh
</code></pre>
<h3 id="åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼"><a class="header" href="#åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼">åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼</a></h3>
<pre><code class="language-bash"># æ–¹å¼ 1ï¼šç›´æ¥åŸ·è¡Œ
sudo ./hft_app -l 2 -n 4 --socket-mem=1024

# æ–¹å¼ 2ï¼šä½¿ç”¨è…³æœ¬
sudo ../scripts/run.sh
</code></pre>
<hr />
<h2 id="8-é æœŸæ•ˆæœ"><a class="header" href="#8-é æœŸæ•ˆæœ">8ï¸âƒ£ é æœŸæ•ˆæœ</a></h2>
<h3 id="æ•ˆèƒ½æŒ‡æ¨™"><a class="header" href="#æ•ˆèƒ½æŒ‡æ¨™">æ•ˆèƒ½æŒ‡æ¨™</a></h3>
<pre><code>æ­£ç¢ºé…ç½®å¾Œçš„é æœŸæ•ˆæœï¼š

P50 Latency:  &lt; 500 ns
P99 Latency:  &lt; 1 Î¼s (å¾®ç§’)
P99.9:        &lt; 5 Î¼s
Jitter:       &lt; 10 Î¼s

ååé‡:       æ•¸ç™¾è¬ pps (packets per second)
CPU ä½¿ç”¨ç‡:    100% (busy polling)
</code></pre>
<h3 id="é©—è­‰æ–¹æ³•"><a class="header" href="#é©—è­‰æ–¹æ³•">é©—è­‰æ–¹æ³•</a></h3>
<pre><code class="language-bash"># 1. æª¢æŸ¥ CPU æ˜¯å¦çœŸçš„éš”é›¢
taskset -cp $(pgrep hft_app)
# æ‡‰è©²é¡¯ç¤ºï¼špid XXX's current affinity list: 2

# 2. æª¢æŸ¥æ˜¯å¦çœŸçš„åœ¨ busy polling
top -H -p $(pgrep hft_app)
# CPU æ‡‰è©²æ¥è¿‘ 100%

# 3. æª¢æŸ¥ IRQ æ˜¯å¦æ­£ç¢ºåˆ†é…
watch -n 1 'cat /proc/interrupts | grep eth0'
# IRQ æ‡‰è©²åªåœ¨ CPU 0 ä¸Šå¢é•·

# 4. æª¢æŸ¥è¨˜æ†¶é«”æ˜¯å¦åœ¨æ­£ç¢ºçš„ NUMA node
numastat -p $(pgrep hft_app)
</code></pre>
<hr />
<h2 id="9-å¸¸è¦‹å•é¡Œæ’é™¤"><a class="header" href="#9-å¸¸è¦‹å•é¡Œæ’é™¤">9ï¸âƒ£ å¸¸è¦‹å•é¡Œæ’é™¤</a></h2>
<h3 id="q1-dpdk-åˆå§‹åŒ–å¤±æ•—"><a class="header" href="#q1-dpdk-åˆå§‹åŒ–å¤±æ•—">Q1: DPDK åˆå§‹åŒ–å¤±æ•—</a></h3>
<pre><code class="language-bash"># æª¢æŸ¥ hugepages
cat /proc/meminfo | grep Huge

# é‡æ–°é…ç½®
echo 8 &gt; /sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages
</code></pre>
<h3 id="q2-ç¶²å¡ç¶å®šå¤±æ•—"><a class="header" href="#q2-ç¶²å¡ç¶å®šå¤±æ•—">Q2: ç¶²å¡ç¶å®šå¤±æ•—</a></h3>
<pre><code class="language-bash"># ç¢ºèªç¶²å¡æ”¯æ´ DPDK
dpdk-devbind.py --status

# ç¢ºèª VFIO æ¨¡çµ„å·²è¼‰å…¥
lsmod | grep vfio

# æ‰‹å‹•è¼‰å…¥
modprobe vfio-pci
</code></pre>
<h3 id="q3-latency-ä»ç„¶å¾ˆé«˜"><a class="header" href="#q3-latency-ä»ç„¶å¾ˆé«˜">Q3: Latency ä»ç„¶å¾ˆé«˜</a></h3>
<pre><code class="language-bash"># æª¢æŸ¥ CPU isolation
cat /sys/devices/system/cpu/isolated

# æª¢æŸ¥ C-States
cat /sys/module/intel_idle/parameters/max_cstate
# æ‡‰è©²æ˜¯ 0

# æª¢æŸ¥ CPU governor
cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
# æ‡‰è©²å…¨éƒ¨æ˜¯ performance
</code></pre>
<h3 id="q4-irq-ä»æ‰“åˆ°-polling-core"><a class="header" href="#q4-irq-ä»æ‰“åˆ°-polling-core">Q4: IRQ ä»æ‰“åˆ° polling core</a></h3>
<pre><code class="language-bash"># æª¢æŸ¥ irqbalance æ˜¯å¦çœŸçš„é—œé–‰
systemctl status irqbalance
# æ‡‰è©²æ˜¯ inactive (dead)

# æ‰‹å‹•è¨­å®š IRQ affinity
echo 1 &gt; /proc/irq/XXX/smp_affinity
</code></pre>
<hr />
<h2 id="-æ ¸å¿ƒåŸå‰‡ç¸½çµ"><a class="header" href="#-æ ¸å¿ƒåŸå‰‡ç¸½çµ">ğŸ”Ÿ æ ¸å¿ƒåŸå‰‡ç¸½çµ</a></h2>
<h3 id="äº”å¤§æ”¯æŸ±"><a class="header" href="#äº”å¤§æ”¯æŸ±">äº”å¤§æ”¯æŸ±</a></h3>
<pre><code>1. CPU éš”é›¢
   isolcpus + nohz_full + rcu_nocbs
   â†’ è®“ CPU è®Šæˆå°ˆå±¬è£¸æ©Ÿ

2. Busy Polling
   while(1) + æ°¸é ä¸ç¡çœ 
   â†’ æ› CPU è³‡æºå–å¾—ç©©å®š latency

3. é›¶æ‹·è²
   ç›´æ¥æ“ä½œ DPDK mbuf
   â†’ é¿å…è¨˜æ†¶é«”è¤‡è£½

4. Lock-free
   atomic + memory_order
   â†’ é¿å…é–ç«¶çˆ­

5. NUMA å°é½Š
   NIC/core/memory åŒ node
   â†’ é¿å…è·¨ NUMA å­˜å–
</code></pre>
<h3 id="å„ªåŒ–å„ªå…ˆç´š"><a class="header" href="#å„ªåŒ–å„ªå…ˆç´š">å„ªåŒ–å„ªå…ˆç´š</a></h3>
<pre><code>é«˜å„ªå…ˆç´šï¼ˆå¿…åšï¼‰
â”œâ”€â”€ CPU isolation é…ç½®
â”œâ”€â”€ IRQ ç¶å®š
â”œâ”€â”€ Hugepages
â”œâ”€â”€ DPDK kernel bypass
â””â”€â”€ NUMA å°é½Š

ä¸­å„ªå…ˆç´šï¼ˆé‡è¦ï¼‰
â”œâ”€â”€ Lock-free è³‡æ–™çµæ§‹
â”œâ”€â”€ Cache line å°é½Š
â”œâ”€â”€ é¿å…å‹•æ…‹è¨˜æ†¶é«”åˆ†é…
â””â”€â”€ Prefetch

ä½å„ªå…ˆç´šï¼ˆåŠ åˆ†ï¼‰
â”œâ”€â”€ Branch hints
â”œâ”€â”€ ç·¨è­¯å™¨å„ªåŒ– flags
â””â”€â”€ å¾®èª¿ DPDK åƒæ•¸
</code></pre>
<hr />
<h2 id="-åƒè€ƒè³‡æº"><a class="header" href="#-åƒè€ƒè³‡æº">ğŸ“š åƒè€ƒè³‡æº</a></h2>
<h3 id="å®˜æ–¹æ–‡ä»¶"><a class="header" href="#å®˜æ–¹æ–‡ä»¶">å®˜æ–¹æ–‡ä»¶</a></h3>
<ul>
<li><a href="https://doc.dpdk.org/">DPDK Documentation</a></li>
<li><a href="https://www.intel.com/content/www/us/en/products/docs/network-io/ethernet/700-series-controllers.html">Intel X710 Datasheet</a></li>
<li><a href="https://wiki.linuxfoundation.org/realtime/start">Linux Kernel Real-Time</a></li>
</ul>
<h3 id="é€²éšé–±è®€"><a class="header" href="#é€²éšé–±è®€">é€²éšé–±è®€</a></h3>
<ul>
<li><a href="https://doc.dpdk.org/guides/linux_gsg/nic_perf_intel_platform.html">DPDK Performance Tuning</a></li>
<li><a href="https://rigtorp.se/low-latency-guide/">Linux Low Latency Tuning</a></li>
<li><a href="https://preshing.com/20120612/an-introduction-to-lock-free-programming/">Lock-free Programming</a></li>
</ul>
<hr />
<h2 id="-æˆæ¬Šèˆ‡è²¢ç»"><a class="header" href="#-æˆæ¬Šèˆ‡è²¢ç»">ğŸ“„ æˆæ¬Šèˆ‡è²¢ç»</a></h2>
<p>æœ¬æ–‡ä»¶æä¾›åƒè€ƒä½¿ç”¨ï¼Œå¯¦éš›éƒ¨ç½²è«‹æ ¹æ“šå…·é«”ç¡¬é«”èˆ‡éœ€æ±‚èª¿æ•´ã€‚</p>
<hr />
<p><strong>è¨˜ä½</strong>ï¼šé«˜é »ç³»çµ±å„ªåŒ–ä¸æ˜¯è¿½æ±‚ã€Œå¿«ã€ï¼Œè€Œæ˜¯è¿½æ±‚ã€Œç©©å®šçš„å¿«ã€ã€‚</p>
<blockquote>
<p><strong>"It's not about being fast, it's about being consistently fast."</strong></p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../hft/02-system/os-tuning-practice.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../hft/02-system/low_latency_trading_system_design.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../hft/02-system/os-tuning-practice.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../hft/02-system/low_latency_trading_system_design.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace.js"></script>
        <script src="../../mode-rust.js"></script>
        <script src="../../editor.js"></script>
        <script src="../../theme-dawn.js"></script>
        <script src="../../theme-tomorrow_night.js"></script>

        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>



    </div>
    </body>
</html>
