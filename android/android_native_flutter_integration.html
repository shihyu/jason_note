<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Android Native (C/C++/Rust) 與 Flutter 整合完整指南 - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="android-native-ccrust-與-flutter-整合完整指南"><a class="header" href="#android-native-ccrust-與-flutter-整合完整指南">Android Native (C/C++/Rust) 與 Flutter 整合完整指南</a></h1>
<h2 id="整合方案比較"><a class="header" href="#整合方案比較">整合方案比較</a></h2>
<div class="table-wrapper"><table><thead><tr><th>方案</th><th>複雜度</th><th>性能</th><th>維護性</th><th>適用場景</th></tr></thead><tbody>
<tr><td><strong>FFI 直接調用</strong></td><td>🟡 中</td><td>🟢 最高</td><td>🟢 好</td><td>純 Dart ↔ Native</td></tr>
<tr><td><strong>Platform Channel + JNI</strong></td><td>🔴 高</td><td>🟡 中</td><td>🔴 複雜</td><td>需要 Android 特定功能</td></tr>
<tr><td><strong>Method Channel + NDK</strong></td><td>🔴 高</td><td>🟢 高</td><td>🔴 複雜</td><td>複雜 Android 整合</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="方案-1-ffi-直接調用-推薦"><a class="header" href="#方案-1-ffi-直接調用-推薦">方案 1: FFI 直接調用 (推薦)</a></h2>
<h3 id="概述"><a class="header" href="#概述">概述</a></h3>
<p>Dart FFI 直接調用編譯後的 native 動態庫，跳過 JNI 層，性能最佳。</p>
<h3 id="架構流程"><a class="header" href="#架構流程">架構流程</a></h3>
<pre><code>Flutter (Dart) → FFI → Native Library (.so) → Rust/C/C++ Code
</code></pre>
<h3 id="完整實現"><a class="header" href="#完整實現">完整實現</a></h3>
<h4 id="step-1-rust-庫-nativesrclibrs"><a class="header" href="#step-1-rust-庫-nativesrclibrs">Step 1: Rust 庫 (native/src/lib.rs)</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::ffi::{CStr, CString};
use std::os::raw::c_char;

#[no_mangle]
pub extern "C" fn hello_from_rust(name: *const c_char) -&gt; *mut c_char {
    let c_str = unsafe { CStr::from_ptr(name) };
    let name_str = c_str.to_str().unwrap_or("Unknown");
    let response = format!("Hello {}, from Rust!", name_str);
    CString::new(response).unwrap().into_raw()
}

#[no_mangle]
pub extern "C" fn add_numbers(a: i32, b: i32) -&gt; i32 {
    a + b
}

#[no_mangle]
pub extern "C" fn free_rust_string(s: *mut c_char) {
    if !s.is_null() {
        unsafe { CString::from_raw(s) };
    }
}

// Android 日誌支援
#[cfg(target_os = "android")]
use android_logger::{Config, FilterBuilder};

#[cfg(target_os = "android")]
#[no_mangle]
pub extern "C" fn init_android_logger() {
    android_logger::init_once(
        Config::default()
            .with_min_level(log::Level::Debug)
            .with_tag("RustFFI")
            .with_filter(FilterBuilder::new().parse("debug").build())
    );
    log::info!("Rust FFI logger initialized for Android");
}
<span class="boring">}</span></code></pre></pre>
<h4 id="step-2-cargotoml"><a class="header" href="#step-2-cargotoml">Step 2: Cargo.toml</a></h4>
<pre><code class="language-toml">[package]
name = "flutter_native"
version = "0.1.0"
edition = "2021"

[lib]
name = "flutter_native"
crate-type = ["cdylib"]

[dependencies]
# Android 特定
[target.'cfg(target_os = "android")'.dependencies]
android_logger = "0.13"
log = "0.4"

# 編譯優化
[profile.release]
lto = true
opt-level = 3
strip = true
</code></pre>
<h4 id="step-3-編譯腳本-scriptsbuild_androidsh"><a class="header" href="#step-3-編譯腳本-scriptsbuild_androidsh">Step 3: 編譯腳本 (scripts/build_android.sh)</a></h4>
<pre><code class="language-bash">#!/bin/bash

# 設置 Android NDK 路徑
export ANDROID_NDK_HOME="/path/to/android-ndk"
export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

# 添加 Android 目標
rustup target add aarch64-linux-android
rustup target add armv7-linux-androideabi
rustup target add x86_64-linux-android
rustup target add i686-linux-android

# 設置 linker
export CC_aarch64_linux_android=aarch64-linux-android21-clang
export CC_armv7_linux_androideabi=armv7a-linux-androideabi21-clang
export CC_x86_64_linux_android=x86_64-linux-android21-clang
export CC_i686_linux_android=i686-linux-android21-clang

# 編譯各個架構
echo "Building for Android architectures..."

cargo build --target aarch64-linux-android --release
cargo build --target armv7-linux-androideabi --release
cargo build --target x86_64-linux-android --release
cargo build --target i686-linux-android --release

# 複製到 Android jniLibs
mkdir -p ../android/app/src/main/jniLibs/arm64-v8a
mkdir -p ../android/app/src/main/jniLibs/armeabi-v7a
mkdir -p ../android/app/src/main/jniLibs/x86_64
mkdir -p ../android/app/src/main/jniLibs/x86

cp target/aarch64-linux-android/release/libflutter_native.so ../android/app/src/main/jniLibs/arm64-v8a/
cp target/armv7-linux-androideabi/release/libflutter_native.so ../android/app/src/main/jniLibs/armeabi-v7a/
cp target/x86_64-linux-android/release/libflutter_native.so ../android/app/src/main/jniLibs/x86_64/
cp target/i686-linux-android/release/libflutter_native.so ../android/app/src/main/jniLibs/x86/

echo "Android libraries copied to jniLibs"
</code></pre>
<h4 id="step-4-flutter-ffi-綁定-libnative_bridgedart"><a class="header" href="#step-4-flutter-ffi-綁定-libnative_bridgedart">Step 4: Flutter FFI 綁定 (lib/native_bridge.dart)</a></h4>
<pre><code class="language-dart">import 'dart:ffi';
import 'dart:io';
import 'package:ffi/ffi.dart';

// 函數簽名定義
typedef HelloFromRustNative = Pointer&lt;Utf8&gt; Function(Pointer&lt;Utf8&gt;);
typedef HelloFromRust = Pointer&lt;Utf8&gt; Function(Pointer&lt;Utf8&gt;);

typedef AddNumbersNative = Int32 Function(Int32, Int32);
typedef AddNumbers = int Function(int, int);

typedef FreeRustStringNative = Void Function(Pointer&lt;Utf8&gt;);
typedef FreeRustString = void Function(Pointer&lt;Utf8&gt;);

typedef InitAndroidLoggerNative = Void Function();
typedef InitAndroidLogger = void Function();

class NativeBridge {
  static DynamicLibrary? _lib;
  static late HelloFromRust _helloFromRust;
  static late AddNumbers _addNumbers;
  static late FreeRustString _freeRustString;
  static late InitAndroidLogger _initAndroidLogger;

  static void initialize() {
    // 加載 native 庫
    if (Platform.isAndroid) {
      _lib = DynamicLibrary.open('libflutter_native.so');
    } else if (Platform.isIOS) {
      _lib = DynamicLibrary.process();
    } else {
      throw UnsupportedError('Platform not supported');
    }

    // 綁定函數
    _helloFromRust = _lib!.lookupFunction&lt;HelloFromRustNative, HelloFromRust&gt;('hello_from_rust');
    _addNumbers = _lib!.lookupFunction&lt;AddNumbersNative, AddNumbers&gt;('add_numbers');
    _freeRustString = _lib!.lookupFunction&lt;FreeRustStringNative, FreeRustString&gt;('free_rust_string');
    
    // Android 特定初始化
    if (Platform.isAndroid) {
      _initAndroidLogger = _lib!.lookupFunction&lt;InitAndroidLoggerNative, InitAndroidLogger&gt;('init_android_logger');
      _initAndroidLogger();
    }
  }

  static String helloFromRust(String name) {
    final namePtr = name.toNativeUtf8();
    final resultPtr = _helloFromRust(namePtr);
    
    final result = resultPtr.toDartString();
    
    // 釋放記憶體
    malloc.free(namePtr);
    _freeRustString(resultPtr);
    
    return result;
  }

  static int addNumbers(int a, int b) {
    return _addNumbers(a, b);
  }
}
</code></pre>
<h4 id="step-5-flutter-使用範例"><a class="header" href="#step-5-flutter-使用範例">Step 5: Flutter 使用範例</a></h4>
<pre><code class="language-dart">import 'package:flutter/material.dart';
import 'native_bridge.dart';

void main() {
  NativeBridge.initialize();
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Native FFI Demo',
      home: NativeDemo(),
    );
  }
}

class NativeDemo extends StatefulWidget {
  @override
  _NativeDemoState createState() =&gt; _NativeDemoState();
}

class _NativeDemoState extends State&lt;NativeDemo&gt; {
  String _result = 'No result';
  final _nameController = TextEditingController();
  final _num1Controller = TextEditingController();
  final _num2Controller = TextEditingController();

  void _callRustHello() {
    final name = _nameController.text.isEmpty ? 'World' : _nameController.text;
    final result = NativeBridge.helloFromRust(name);
    setState(() =&gt; _result = result);
  }

  void _callRustAdd() {
    final num1 = int.tryParse(_num1Controller.text) ?? 0;
    final num2 = int.tryParse(_num2Controller.text) ?? 0;
    final result = NativeBridge.addNumbers(num1, num2);
    setState(() =&gt; _result = 'Result: $result');
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Native FFI Demo')),
      body: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            TextField(
              controller: _nameController,
              decoration: InputDecoration(labelText: 'Name'),
            ),
            ElevatedButton(
              onPressed: _callRustHello,
              child: Text('Call Rust Hello'),
            ),
            SizedBox(height: 20),
            Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: _num1Controller,
                    decoration: InputDecoration(labelText: 'Number 1'),
                    keyboardType: TextInputType.number,
                  ),
                ),
                SizedBox(width: 10),
                Expanded(
                  child: TextField(
                    controller: _num2Controller,
                    decoration: InputDecoration(labelText: 'Number 2'),
                    keyboardType: TextInputType.number,
                  ),
                ),
              ],
            ),
            ElevatedButton(
              onPressed: _callRustAdd,
              child: Text('Add Numbers'),
            ),
            SizedBox(height: 20),
            Text('Result: $_result', style: Theme.of(context).textTheme.titleLarge),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<hr />
<h2 id="方案-2-platform-channel--jni"><a class="header" href="#方案-2-platform-channel--jni">方案 2: Platform Channel + JNI</a></h2>
<h3 id="概述-1"><a class="header" href="#概述-1">概述</a></h3>
<p>透過 Platform Channel 呼叫 Android Kotlin/Java 代碼，再透過 JNI 調用 native 庫。</p>
<h3 id="架構流程-1"><a class="header" href="#架構流程-1">架構流程</a></h3>
<pre><code>Flutter (Dart) → Platform Channel → Android (Kotlin/Java) → JNI → Native (.so) → Rust/C/C++
</code></pre>
<h3 id="實現步驟"><a class="header" href="#實現步驟">實現步驟</a></h3>
<h4 id="step-1-android-native-實現-androidappsrcmaincppnativecpp"><a class="header" href="#step-1-android-native-實現-androidappsrcmaincppnativecpp">Step 1: Android Native 實現 (android/app/src/main/cpp/native.cpp)</a></h4>
<pre><code class="language-cpp">#include &lt;jni.h&gt;
#include &lt;string&gt;
#include &lt;android/log.h&gt;

#define LOG_TAG "NativeLib"
#define LOGI(...) __android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)

// 如果要調用 Rust，需要聲明 extern C
extern "C" {
    char* hello_from_rust(const char* name);
    int add_numbers(int a, int b);
    void free_rust_string(char* s);
}

extern "C" JNIEXPORT jstring JNICALL
Java_com_example_myapp_NativeLib_helloFromNative(JNIEnv *env, jclass clazz, jstring name) {
    const char *nativeName = env-&gt;GetStringUTFChars(name, nullptr);
    
    // 方式1: 直接 C++ 實現
    std::string result = "Hello " + std::string(nativeName) + " from C++!";
    
    // 方式2: 調用 Rust 函數
    // char* rustResult = hello_from_rust(nativeName);
    // std::string result(rustResult);
    // free_rust_string(rustResult);
    
    env-&gt;ReleaseStringUTFChars(name, nativeName);
    return env-&gt;NewStringUTF(result.c_str());
}

extern "C" JNIEXPORT jint JNICALL
Java_com_example_myapp_NativeLib_addNumbers(JNIEnv *env, jclass clazz, jint a, jint b) {
    LOGI("Adding numbers: %d + %d", a, b);
    
    // 方式1: 直接 C++ 實現
    return a + b;
    
    // 方式2: 調用 Rust 函數
    // return add_numbers(a, b);
}
</code></pre>
<h4 id="step-2-cmake-配置-androidappsrcmaincppcmakeliststxt"><a class="header" href="#step-2-cmake-配置-androidappsrcmaincppcmakeliststxt">Step 2: CMake 配置 (android/app/src/main/cpp/CMakeLists.txt)</a></h4>
<pre><code class="language-cmake">cmake_minimum_required(VERSION 3.18.1)

project("native")

# 添加 C++ 標準
set(CMAKE_CXX_STANDARD 17)

# 查找依賴
find_library(log-lib log)

# 如果要鏈接 Rust 庫
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/../jniLibs/${ANDROID_ABI}/libflutter_native.so")
    add_library(rust_lib SHARED IMPORTED)
    set_target_properties(rust_lib PROPERTIES
        IMPORTED_LOCATION "${CMAKE_CURRENT_SOURCE_DIR}/../jniLibs/${ANDROID_ABI}/libflutter_native.so"
    )
endif()

# 創建 native 庫
add_library(native SHARED native.cpp)

# 鏈接庫
target_link_libraries(native ${log-lib})

# 如果有 Rust 庫，也要鏈接
if(TARGET rust_lib)
    target_link_libraries(native rust_lib)
endif()
</code></pre>
<h4 id="step-3-android-kotlin-包裝-androidappsrcmainkotlinnativelibkt"><a class="header" href="#step-3-android-kotlin-包裝-androidappsrcmainkotlinnativelibkt">Step 3: Android Kotlin 包裝 (android/app/src/main/kotlin/NativeLib.kt)</a></h4>
<pre><code class="language-kotlin">package com.example.myapp

class NativeLib {
    companion object {
        // 載入 native 庫
        init {
            System.loadLibrary("native")
        }
        
        // JNI 方法聲明
        @JvmStatic
        external fun helloFromNative(name: String): String
        
        @JvmStatic
        external fun addNumbers(a: Int, b: Int): Int
    }
}
</code></pre>
<h4 id="step-4-mainactivity-platform-channel-androidappsrcmainkotlinmainactivitykt"><a class="header" href="#step-4-mainactivity-platform-channel-androidappsrcmainkotlinmainactivitykt">Step 4: MainActivity Platform Channel (android/app/src/main/kotlin/MainActivity.kt)</a></h4>
<pre><code class="language-kotlin">package com.example.myapp

import io.flutter.embedding.android.FlutterActivity
import io.flutter.embedding.engine.FlutterEngine
import io.flutter.plugin.common.MethodChannel

class MainActivity: FlutterActivity() {
    private val CHANNEL = "com.example.myapp/native"

    override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
        super.configureFlutterEngine(flutterEngine)
        
        MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL)
            .setMethodCallHandler { call, result -&gt;
                when (call.method) {
                    "helloFromNative" -&gt; {
                        val name = call.argument&lt;String&gt;("name") ?: "World"
                        try {
                            val nativeResult = NativeLib.helloFromNative(name)
                            result.success(nativeResult)
                        } catch (e: Exception) {
                            result.error("NATIVE_ERROR", "Native call failed", e.message)
                        }
                    }
                    "addNumbers" -&gt; {
                        val a = call.argument&lt;Int&gt;("a") ?: 0
                        val b = call.argument&lt;Int&gt;("b") ?: 0
                        try {
                            val nativeResult = NativeLib.addNumbers(a, b)
                            result.success(nativeResult)
                        } catch (e: Exception) {
                            result.error("NATIVE_ERROR", "Native call failed", e.message)
                        }
                    }
                    else -&gt; result.notImplemented()
                }
            }
    }
}
</code></pre>
<h4 id="step-5-flutter-platform-channel-調用-libplatform_channel_bridgedart"><a class="header" href="#step-5-flutter-platform-channel-調用-libplatform_channel_bridgedart">Step 5: Flutter Platform Channel 調用 (lib/platform_channel_bridge.dart)</a></h4>
<pre><code class="language-dart">import 'package:flutter/services.dart';

class PlatformChannelBridge {
  static const MethodChannel _channel = MethodChannel('com.example.myapp/native');

  static Future&lt;String&gt; helloFromNative(String name) async {
    try {
      final String result = await _channel.invokeMethod('helloFromNative', {
        'name': name,
      });
      return result;
    } on PlatformException catch (e) {
      throw Exception('Failed to call native: ${e.message}');
    }
  }

  static Future&lt;int&gt; addNumbers(int a, int b) async {
    try {
      final int result = await _channel.invokeMethod('addNumbers', {
        'a': a,
        'b': b,
      });
      return result;
    } on PlatformException catch (e) {
      throw Exception('Failed to add numbers: ${e.message}');
    }
  }
}
</code></pre>
<h4 id="step-6-使用範例"><a class="header" href="#step-6-使用範例">Step 6: 使用範例</a></h4>
<pre><code class="language-dart">// 使用 Platform Channel 方式
class PlatformChannelDemo extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Column(
          children: [
            ElevatedButton(
              onPressed: () async {
                final result = await PlatformChannelBridge.helloFromNative('Flutter');
                print(result);
              },
              child: Text('Call Native via Platform Channel'),
            ),
            ElevatedButton(
              onPressed: () async {
                final result = await PlatformChannelBridge.addNumbers(5, 3);
                print('Result: $result');
              },
              child: Text('Add Numbers via Platform Channel'),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<hr />
<h2 id="建構配置"><a class="header" href="#建構配置">建構配置</a></h2>
<h3 id="android-buildgradle-配置"><a class="header" href="#android-buildgradle-配置">Android build.gradle 配置</a></h3>
<pre><code class="language-gradle">// android/app/build.gradle
android {
    compileSdkVersion 34
    ndkVersion "25.1.8937393"
    
    defaultConfig {
        ndk {
            abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86_64', 'x86'
        }
    }
    
    externalNativeBuild {
        cmake {
            path "src/main/cpp/CMakeLists.txt"
            version "3.18.1"
        }
    }
    
    sourceSets {
        main {
            jniLibs.srcDirs = ['src/main/jniLibs']
        }
    }
}
</code></pre>
<h3 id="pubspecyaml-配置"><a class="header" href="#pubspecyaml-配置">pubspec.yaml 配置</a></h3>
<pre><code class="language-yaml"># pubspec.yaml
dependencies:
  flutter:
    sdk: flutter
  ffi: ^2.0.1

# FFI 方式需要
assets:
  - assets/

# Plugin 配置 (如果要發布為 plugin)
flutter:
  plugin:
    platforms:
      android:
        package: com.example.native_plugin
        pluginClass: NativePlugin
</code></pre>
<hr />
<h2 id="除錯和測試"><a class="header" href="#除錯和測試">除錯和測試</a></h2>
<h3 id="android-日誌查看"><a class="header" href="#android-日誌查看">Android 日誌查看</a></h3>
<pre><code class="language-bash"># 查看所有日誌
adb logcat

# 只查看特定 tag
adb logcat -s "RustFFI"
adb logcat -s "NativeLib"

# 查看 Flutter 日誌
adb logcat -s "flutter"
</code></pre>
<h3 id="常見問題和解決方案"><a class="header" href="#常見問題和解決方案">常見問題和解決方案</a></h3>
<h4 id="1-庫找不到"><a class="header" href="#1-庫找不到">1. 庫找不到</a></h4>
<pre><code>java.lang.UnsatisfiedLinkError: dlopen failed: library "libflutter_native.so" not found
</code></pre>
<p><strong>解決方案：</strong></p>
<ul>
<li>檢查 <code>.so</code> 檔案是否正確放在 <code>jniLibs</code> 對應架構資料夾</li>
<li>確認檔案名稱正確（必須以 <code>lib</code> 開頭）</li>
<li>檢查 build.gradle 中的 <code>abiFilters</code> 設定</li>
</ul>
<h4 id="2-符號找不到"><a class="header" href="#2-符號找不到">2. 符號找不到</a></h4>
<pre><code>java.lang.UnsatisfiedLinkError: No implementation found for native method
</code></pre>
<p><strong>解決方案：</strong></p>
<ul>
<li>檢查 C/C++ 函數名稱是否與 JNI 規範一致</li>
<li>確認 <code>extern "C"</code> 聲明正確</li>
<li>使用 <code>nm</code> 或 <code>objdump</code> 檢查符號是否存在</li>
</ul>
<h4 id="3-記憶體洩漏"><a class="header" href="#3-記憶體洩漏">3. 記憶體洩漏</a></h4>
<p><strong>最佳實踐：</strong></p>
<pre><code class="language-dart">// 正確的記憶體管理
String callNative(String input) {
  final inputPtr = input.toNativeUtf8();
  try {
    final resultPtr = _nativeFunction(inputPtr);
    final result = resultPtr.toDartString();
    _freeString(resultPtr); // 重要！釋放 native 記憶體
    return result;
  } finally {
    malloc.free(inputPtr); // 重要！釋放 Dart 分配的記憶體
  }
}
</code></pre>
<hr />
<h2 id="效能比較"><a class="header" href="#效能比較">效能比較</a></h2>
<div class="table-wrapper"><table><thead><tr><th>方案</th><th>調用延遲</th><th>記憶體使用</th><th>複雜度</th><th>維護性</th></tr></thead><tbody>
<tr><td><strong>FFI 直接</strong></td><td>~1μs</td><td>低</td><td>中</td><td>好</td></tr>
<tr><td><strong>Platform Channel + JNI</strong></td><td>~100μs</td><td>中</td><td>高</td><td>複雜</td></tr>
</tbody></table>
</div>
<h2 id="總結建議"><a class="header" href="#總結建議">總結建議</a></h2>
<h3 id="-推薦ffi-直接調用"><a class="header" href="#-推薦ffi-直接調用">🥇 推薦：FFI 直接調用</a></h3>
<ul>
<li><strong>優點</strong>：性能最佳、相對簡單、跨平台一致</li>
<li><strong>缺點</strong>：需要管理記憶體、不能使用 Android 特定 API</li>
<li><strong>適用</strong>：純計算邏輯、跨平台庫</li>
</ul>
<h3 id="-備選platform-channel--jni"><a class="header" href="#-備選platform-channel--jni">🥈 備選：Platform Channel + JNI</a></h3>
<ul>
<li><strong>優點</strong>：可使用完整 Android API、錯誤處理更好</li>
<li><strong>缺點</strong>：性能較差、複雜度高、維護困難</li>
<li><strong>適用</strong>：需要 Android 特定功能、複雜的系統整合</li>
</ul>
<h3 id="最佳實踐"><a class="header" href="#最佳實踐">最佳實踐</a></h3>
<ol>
<li><strong>優先考慮 FFI</strong>：除非必須使用 Android 特定功能</li>
<li><strong>記憶體管理</strong>：務必正確釋放 native 分配的記憶體</li>
<li><strong>錯誤處理</strong>：在所有 native 調用周圍添加異常處理</li>
<li><strong>測試</strong>：在所有目標架構上進行充分測試</li>
<li><strong>日誌</strong>：添加詳細的日誌以便除錯</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../android/buttplug_porting_guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../android/ffi_vs_flutter_rust_bridge.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../android/buttplug_porting_guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../android/ffi_vs_flutter_rust_bridge.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
