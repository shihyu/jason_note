<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Android Native (C/C++/Rust) èˆ‡ Flutter æ•´åˆå®Œæ•´æŒ‡å— - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="android-native-ccrust-èˆ‡-flutter-æ•´åˆå®Œæ•´æŒ‡å—"><a class="header" href="#android-native-ccrust-èˆ‡-flutter-æ•´åˆå®Œæ•´æŒ‡å—">Android Native (C/C++/Rust) èˆ‡ Flutter æ•´åˆå®Œæ•´æŒ‡å—</a></h1>
<h2 id="æ•´åˆæ–¹æ¡ˆæ¯”è¼ƒ"><a class="header" href="#æ•´åˆæ–¹æ¡ˆæ¯”è¼ƒ">æ•´åˆæ–¹æ¡ˆæ¯”è¼ƒ</a></h2>
<div class="table-wrapper"><table><thead><tr><th>æ–¹æ¡ˆ</th><th>è¤‡é›œåº¦</th><th>æ€§èƒ½</th><th>ç¶­è­·æ€§</th><th>é©ç”¨å ´æ™¯</th></tr></thead><tbody>
<tr><td><strong>FFI ç›´æ¥èª¿ç”¨</strong></td><td>ğŸŸ¡ ä¸­</td><td>ğŸŸ¢ æœ€é«˜</td><td>ğŸŸ¢ å¥½</td><td>ç´” Dart â†” Native</td></tr>
<tr><td><strong>Platform Channel + JNI</strong></td><td>ğŸ”´ é«˜</td><td>ğŸŸ¡ ä¸­</td><td>ğŸ”´ è¤‡é›œ</td><td>éœ€è¦ Android ç‰¹å®šåŠŸèƒ½</td></tr>
<tr><td><strong>Method Channel + NDK</strong></td><td>ğŸ”´ é«˜</td><td>ğŸŸ¢ é«˜</td><td>ğŸ”´ è¤‡é›œ</td><td>è¤‡é›œ Android æ•´åˆ</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="æ–¹æ¡ˆ-1-ffi-ç›´æ¥èª¿ç”¨-æ¨è–¦"><a class="header" href="#æ–¹æ¡ˆ-1-ffi-ç›´æ¥èª¿ç”¨-æ¨è–¦">æ–¹æ¡ˆ 1: FFI ç›´æ¥èª¿ç”¨ (æ¨è–¦)</a></h2>
<h3 id="æ¦‚è¿°"><a class="header" href="#æ¦‚è¿°">æ¦‚è¿°</a></h3>
<p>Dart FFI ç›´æ¥èª¿ç”¨ç·¨è­¯å¾Œçš„ native å‹•æ…‹åº«ï¼Œè·³é JNI å±¤ï¼Œæ€§èƒ½æœ€ä½³ã€‚</p>
<h3 id="æ¶æ§‹æµç¨‹"><a class="header" href="#æ¶æ§‹æµç¨‹">æ¶æ§‹æµç¨‹</a></h3>
<pre><code>Flutter (Dart) â†’ FFI â†’ Native Library (.so) â†’ Rust/C/C++ Code
</code></pre>
<h3 id="å®Œæ•´å¯¦ç¾"><a class="header" href="#å®Œæ•´å¯¦ç¾">å®Œæ•´å¯¦ç¾</a></h3>
<h4 id="step-1-rust-åº«-nativesrclibrs"><a class="header" href="#step-1-rust-åº«-nativesrclibrs">Step 1: Rust åº« (native/src/lib.rs)</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::ffi::{CStr, CString};
use std::os::raw::c_char;

#[no_mangle]
pub extern "C" fn hello_from_rust(name: *const c_char) -&gt; *mut c_char {
    let c_str = unsafe { CStr::from_ptr(name) };
    let name_str = c_str.to_str().unwrap_or("Unknown");
    let response = format!("Hello {}, from Rust!", name_str);
    CString::new(response).unwrap().into_raw()
}

#[no_mangle]
pub extern "C" fn add_numbers(a: i32, b: i32) -&gt; i32 {
    a + b
}

#[no_mangle]
pub extern "C" fn free_rust_string(s: *mut c_char) {
    if !s.is_null() {
        unsafe { CString::from_raw(s) };
    }
}

// Android æ—¥èªŒæ”¯æ´
#[cfg(target_os = "android")]
use android_logger::{Config, FilterBuilder};

#[cfg(target_os = "android")]
#[no_mangle]
pub extern "C" fn init_android_logger() {
    android_logger::init_once(
        Config::default()
            .with_min_level(log::Level::Debug)
            .with_tag("RustFFI")
            .with_filter(FilterBuilder::new().parse("debug").build())
    );
    log::info!("Rust FFI logger initialized for Android");
}
<span class="boring">}</span></code></pre></pre>
<h4 id="step-2-cargotoml"><a class="header" href="#step-2-cargotoml">Step 2: Cargo.toml</a></h4>
<pre><code class="language-toml">[package]
name = "flutter_native"
version = "0.1.0"
edition = "2021"

[lib]
name = "flutter_native"
crate-type = ["cdylib"]

[dependencies]
# Android ç‰¹å®š
[target.'cfg(target_os = "android")'.dependencies]
android_logger = "0.13"
log = "0.4"

# ç·¨è­¯å„ªåŒ–
[profile.release]
lto = true
opt-level = 3
strip = true
</code></pre>
<h4 id="step-3-ç·¨è­¯è…³æœ¬-scriptsbuild_androidsh"><a class="header" href="#step-3-ç·¨è­¯è…³æœ¬-scriptsbuild_androidsh">Step 3: ç·¨è­¯è…³æœ¬ (scripts/build_android.sh)</a></h4>
<pre><code class="language-bash">#!/bin/bash

# è¨­ç½® Android NDK è·¯å¾‘
export ANDROID_NDK_HOME="/path/to/android-ndk"
export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

# æ·»åŠ  Android ç›®æ¨™
rustup target add aarch64-linux-android
rustup target add armv7-linux-androideabi
rustup target add x86_64-linux-android
rustup target add i686-linux-android

# è¨­ç½® linker
export CC_aarch64_linux_android=aarch64-linux-android21-clang
export CC_armv7_linux_androideabi=armv7a-linux-androideabi21-clang
export CC_x86_64_linux_android=x86_64-linux-android21-clang
export CC_i686_linux_android=i686-linux-android21-clang

# ç·¨è­¯å„å€‹æ¶æ§‹
echo "Building for Android architectures..."

cargo build --target aarch64-linux-android --release
cargo build --target armv7-linux-androideabi --release
cargo build --target x86_64-linux-android --release
cargo build --target i686-linux-android --release

# è¤‡è£½åˆ° Android jniLibs
mkdir -p ../android/app/src/main/jniLibs/arm64-v8a
mkdir -p ../android/app/src/main/jniLibs/armeabi-v7a
mkdir -p ../android/app/src/main/jniLibs/x86_64
mkdir -p ../android/app/src/main/jniLibs/x86

cp target/aarch64-linux-android/release/libflutter_native.so ../android/app/src/main/jniLibs/arm64-v8a/
cp target/armv7-linux-androideabi/release/libflutter_native.so ../android/app/src/main/jniLibs/armeabi-v7a/
cp target/x86_64-linux-android/release/libflutter_native.so ../android/app/src/main/jniLibs/x86_64/
cp target/i686-linux-android/release/libflutter_native.so ../android/app/src/main/jniLibs/x86/

echo "Android libraries copied to jniLibs"
</code></pre>
<h4 id="step-4-flutter-ffi-ç¶å®š-libnative_bridgedart"><a class="header" href="#step-4-flutter-ffi-ç¶å®š-libnative_bridgedart">Step 4: Flutter FFI ç¶å®š (lib/native_bridge.dart)</a></h4>
<pre><code class="language-dart">import 'dart:ffi';
import 'dart:io';
import 'package:ffi/ffi.dart';

// å‡½æ•¸ç°½åå®šç¾©
typedef HelloFromRustNative = Pointer&lt;Utf8&gt; Function(Pointer&lt;Utf8&gt;);
typedef HelloFromRust = Pointer&lt;Utf8&gt; Function(Pointer&lt;Utf8&gt;);

typedef AddNumbersNative = Int32 Function(Int32, Int32);
typedef AddNumbers = int Function(int, int);

typedef FreeRustStringNative = Void Function(Pointer&lt;Utf8&gt;);
typedef FreeRustString = void Function(Pointer&lt;Utf8&gt;);

typedef InitAndroidLoggerNative = Void Function();
typedef InitAndroidLogger = void Function();

class NativeBridge {
  static DynamicLibrary? _lib;
  static late HelloFromRust _helloFromRust;
  static late AddNumbers _addNumbers;
  static late FreeRustString _freeRustString;
  static late InitAndroidLogger _initAndroidLogger;

  static void initialize() {
    // åŠ è¼‰ native åº«
    if (Platform.isAndroid) {
      _lib = DynamicLibrary.open('libflutter_native.so');
    } else if (Platform.isIOS) {
      _lib = DynamicLibrary.process();
    } else {
      throw UnsupportedError('Platform not supported');
    }

    // ç¶å®šå‡½æ•¸
    _helloFromRust = _lib!.lookupFunction&lt;HelloFromRustNative, HelloFromRust&gt;('hello_from_rust');
    _addNumbers = _lib!.lookupFunction&lt;AddNumbersNative, AddNumbers&gt;('add_numbers');
    _freeRustString = _lib!.lookupFunction&lt;FreeRustStringNative, FreeRustString&gt;('free_rust_string');
    
    // Android ç‰¹å®šåˆå§‹åŒ–
    if (Platform.isAndroid) {
      _initAndroidLogger = _lib!.lookupFunction&lt;InitAndroidLoggerNative, InitAndroidLogger&gt;('init_android_logger');
      _initAndroidLogger();
    }
  }

  static String helloFromRust(String name) {
    final namePtr = name.toNativeUtf8();
    final resultPtr = _helloFromRust(namePtr);
    
    final result = resultPtr.toDartString();
    
    // é‡‹æ”¾è¨˜æ†¶é«”
    malloc.free(namePtr);
    _freeRustString(resultPtr);
    
    return result;
  }

  static int addNumbers(int a, int b) {
    return _addNumbers(a, b);
  }
}
</code></pre>
<h4 id="step-5-flutter-ä½¿ç”¨ç¯„ä¾‹"><a class="header" href="#step-5-flutter-ä½¿ç”¨ç¯„ä¾‹">Step 5: Flutter ä½¿ç”¨ç¯„ä¾‹</a></h4>
<pre><code class="language-dart">import 'package:flutter/material.dart';
import 'native_bridge.dart';

void main() {
  NativeBridge.initialize();
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Native FFI Demo',
      home: NativeDemo(),
    );
  }
}

class NativeDemo extends StatefulWidget {
  @override
  _NativeDemoState createState() =&gt; _NativeDemoState();
}

class _NativeDemoState extends State&lt;NativeDemo&gt; {
  String _result = 'No result';
  final _nameController = TextEditingController();
  final _num1Controller = TextEditingController();
  final _num2Controller = TextEditingController();

  void _callRustHello() {
    final name = _nameController.text.isEmpty ? 'World' : _nameController.text;
    final result = NativeBridge.helloFromRust(name);
    setState(() =&gt; _result = result);
  }

  void _callRustAdd() {
    final num1 = int.tryParse(_num1Controller.text) ?? 0;
    final num2 = int.tryParse(_num2Controller.text) ?? 0;
    final result = NativeBridge.addNumbers(num1, num2);
    setState(() =&gt; _result = 'Result: $result');
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Native FFI Demo')),
      body: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            TextField(
              controller: _nameController,
              decoration: InputDecoration(labelText: 'Name'),
            ),
            ElevatedButton(
              onPressed: _callRustHello,
              child: Text('Call Rust Hello'),
            ),
            SizedBox(height: 20),
            Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: _num1Controller,
                    decoration: InputDecoration(labelText: 'Number 1'),
                    keyboardType: TextInputType.number,
                  ),
                ),
                SizedBox(width: 10),
                Expanded(
                  child: TextField(
                    controller: _num2Controller,
                    decoration: InputDecoration(labelText: 'Number 2'),
                    keyboardType: TextInputType.number,
                  ),
                ),
              ],
            ),
            ElevatedButton(
              onPressed: _callRustAdd,
              child: Text('Add Numbers'),
            ),
            SizedBox(height: 20),
            Text('Result: $_result', style: Theme.of(context).textTheme.titleLarge),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<hr />
<h2 id="æ–¹æ¡ˆ-2-platform-channel--jni"><a class="header" href="#æ–¹æ¡ˆ-2-platform-channel--jni">æ–¹æ¡ˆ 2: Platform Channel + JNI</a></h2>
<h3 id="æ¦‚è¿°-1"><a class="header" href="#æ¦‚è¿°-1">æ¦‚è¿°</a></h3>
<p>é€é Platform Channel å‘¼å« Android Kotlin/Java ä»£ç¢¼ï¼Œå†é€é JNI èª¿ç”¨ native åº«ã€‚</p>
<h3 id="æ¶æ§‹æµç¨‹-1"><a class="header" href="#æ¶æ§‹æµç¨‹-1">æ¶æ§‹æµç¨‹</a></h3>
<pre><code>Flutter (Dart) â†’ Platform Channel â†’ Android (Kotlin/Java) â†’ JNI â†’ Native (.so) â†’ Rust/C/C++
</code></pre>
<h3 id="å¯¦ç¾æ­¥é©Ÿ"><a class="header" href="#å¯¦ç¾æ­¥é©Ÿ">å¯¦ç¾æ­¥é©Ÿ</a></h3>
<h4 id="step-1-android-native-å¯¦ç¾-androidappsrcmaincppnativecpp"><a class="header" href="#step-1-android-native-å¯¦ç¾-androidappsrcmaincppnativecpp">Step 1: Android Native å¯¦ç¾ (android/app/src/main/cpp/native.cpp)</a></h4>
<pre><code class="language-cpp">#include &lt;jni.h&gt;
#include &lt;string&gt;
#include &lt;android/log.h&gt;

#define LOG_TAG "NativeLib"
#define LOGI(...) __android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)

// å¦‚æœè¦èª¿ç”¨ Rustï¼Œéœ€è¦è²æ˜ extern C
extern "C" {
    char* hello_from_rust(const char* name);
    int add_numbers(int a, int b);
    void free_rust_string(char* s);
}

extern "C" JNIEXPORT jstring JNICALL
Java_com_example_myapp_NativeLib_helloFromNative(JNIEnv *env, jclass clazz, jstring name) {
    const char *nativeName = env-&gt;GetStringUTFChars(name, nullptr);
    
    // æ–¹å¼1: ç›´æ¥ C++ å¯¦ç¾
    std::string result = "Hello " + std::string(nativeName) + " from C++!";
    
    // æ–¹å¼2: èª¿ç”¨ Rust å‡½æ•¸
    // char* rustResult = hello_from_rust(nativeName);
    // std::string result(rustResult);
    // free_rust_string(rustResult);
    
    env-&gt;ReleaseStringUTFChars(name, nativeName);
    return env-&gt;NewStringUTF(result.c_str());
}

extern "C" JNIEXPORT jint JNICALL
Java_com_example_myapp_NativeLib_addNumbers(JNIEnv *env, jclass clazz, jint a, jint b) {
    LOGI("Adding numbers: %d + %d", a, b);
    
    // æ–¹å¼1: ç›´æ¥ C++ å¯¦ç¾
    return a + b;
    
    // æ–¹å¼2: èª¿ç”¨ Rust å‡½æ•¸
    // return add_numbers(a, b);
}
</code></pre>
<h4 id="step-2-cmake-é…ç½®-androidappsrcmaincppcmakeliststxt"><a class="header" href="#step-2-cmake-é…ç½®-androidappsrcmaincppcmakeliststxt">Step 2: CMake é…ç½® (android/app/src/main/cpp/CMakeLists.txt)</a></h4>
<pre><code class="language-cmake">cmake_minimum_required(VERSION 3.18.1)

project("native")

# æ·»åŠ  C++ æ¨™æº–
set(CMAKE_CXX_STANDARD 17)

# æŸ¥æ‰¾ä¾è³´
find_library(log-lib log)

# å¦‚æœè¦éˆæ¥ Rust åº«
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/../jniLibs/${ANDROID_ABI}/libflutter_native.so")
    add_library(rust_lib SHARED IMPORTED)
    set_target_properties(rust_lib PROPERTIES
        IMPORTED_LOCATION "${CMAKE_CURRENT_SOURCE_DIR}/../jniLibs/${ANDROID_ABI}/libflutter_native.so"
    )
endif()

# å‰µå»º native åº«
add_library(native SHARED native.cpp)

# éˆæ¥åº«
target_link_libraries(native ${log-lib})

# å¦‚æœæœ‰ Rust åº«ï¼Œä¹Ÿè¦éˆæ¥
if(TARGET rust_lib)
    target_link_libraries(native rust_lib)
endif()
</code></pre>
<h4 id="step-3-android-kotlin-åŒ…è£-androidappsrcmainkotlinnativelibkt"><a class="header" href="#step-3-android-kotlin-åŒ…è£-androidappsrcmainkotlinnativelibkt">Step 3: Android Kotlin åŒ…è£ (android/app/src/main/kotlin/NativeLib.kt)</a></h4>
<pre><code class="language-kotlin">package com.example.myapp

class NativeLib {
    companion object {
        // è¼‰å…¥ native åº«
        init {
            System.loadLibrary("native")
        }
        
        // JNI æ–¹æ³•è²æ˜
        @JvmStatic
        external fun helloFromNative(name: String): String
        
        @JvmStatic
        external fun addNumbers(a: Int, b: Int): Int
    }
}
</code></pre>
<h4 id="step-4-mainactivity-platform-channel-androidappsrcmainkotlinmainactivitykt"><a class="header" href="#step-4-mainactivity-platform-channel-androidappsrcmainkotlinmainactivitykt">Step 4: MainActivity Platform Channel (android/app/src/main/kotlin/MainActivity.kt)</a></h4>
<pre><code class="language-kotlin">package com.example.myapp

import io.flutter.embedding.android.FlutterActivity
import io.flutter.embedding.engine.FlutterEngine
import io.flutter.plugin.common.MethodChannel

class MainActivity: FlutterActivity() {
    private val CHANNEL = "com.example.myapp/native"

    override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
        super.configureFlutterEngine(flutterEngine)
        
        MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL)
            .setMethodCallHandler { call, result -&gt;
                when (call.method) {
                    "helloFromNative" -&gt; {
                        val name = call.argument&lt;String&gt;("name") ?: "World"
                        try {
                            val nativeResult = NativeLib.helloFromNative(name)
                            result.success(nativeResult)
                        } catch (e: Exception) {
                            result.error("NATIVE_ERROR", "Native call failed", e.message)
                        }
                    }
                    "addNumbers" -&gt; {
                        val a = call.argument&lt;Int&gt;("a") ?: 0
                        val b = call.argument&lt;Int&gt;("b") ?: 0
                        try {
                            val nativeResult = NativeLib.addNumbers(a, b)
                            result.success(nativeResult)
                        } catch (e: Exception) {
                            result.error("NATIVE_ERROR", "Native call failed", e.message)
                        }
                    }
                    else -&gt; result.notImplemented()
                }
            }
    }
}
</code></pre>
<h4 id="step-5-flutter-platform-channel-èª¿ç”¨-libplatform_channel_bridgedart"><a class="header" href="#step-5-flutter-platform-channel-èª¿ç”¨-libplatform_channel_bridgedart">Step 5: Flutter Platform Channel èª¿ç”¨ (lib/platform_channel_bridge.dart)</a></h4>
<pre><code class="language-dart">import 'package:flutter/services.dart';

class PlatformChannelBridge {
  static const MethodChannel _channel = MethodChannel('com.example.myapp/native');

  static Future&lt;String&gt; helloFromNative(String name) async {
    try {
      final String result = await _channel.invokeMethod('helloFromNative', {
        'name': name,
      });
      return result;
    } on PlatformException catch (e) {
      throw Exception('Failed to call native: ${e.message}');
    }
  }

  static Future&lt;int&gt; addNumbers(int a, int b) async {
    try {
      final int result = await _channel.invokeMethod('addNumbers', {
        'a': a,
        'b': b,
      });
      return result;
    } on PlatformException catch (e) {
      throw Exception('Failed to add numbers: ${e.message}');
    }
  }
}
</code></pre>
<h4 id="step-6-ä½¿ç”¨ç¯„ä¾‹"><a class="header" href="#step-6-ä½¿ç”¨ç¯„ä¾‹">Step 6: ä½¿ç”¨ç¯„ä¾‹</a></h4>
<pre><code class="language-dart">// ä½¿ç”¨ Platform Channel æ–¹å¼
class PlatformChannelDemo extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Column(
          children: [
            ElevatedButton(
              onPressed: () async {
                final result = await PlatformChannelBridge.helloFromNative('Flutter');
                print(result);
              },
              child: Text('Call Native via Platform Channel'),
            ),
            ElevatedButton(
              onPressed: () async {
                final result = await PlatformChannelBridge.addNumbers(5, 3);
                print('Result: $result');
              },
              child: Text('Add Numbers via Platform Channel'),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<hr />
<h2 id="å»ºæ§‹é…ç½®"><a class="header" href="#å»ºæ§‹é…ç½®">å»ºæ§‹é…ç½®</a></h2>
<h3 id="android-buildgradle-é…ç½®"><a class="header" href="#android-buildgradle-é…ç½®">Android build.gradle é…ç½®</a></h3>
<pre><code class="language-gradle">// android/app/build.gradle
android {
    compileSdkVersion 34
    ndkVersion "25.1.8937393"
    
    defaultConfig {
        ndk {
            abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86_64', 'x86'
        }
    }
    
    externalNativeBuild {
        cmake {
            path "src/main/cpp/CMakeLists.txt"
            version "3.18.1"
        }
    }
    
    sourceSets {
        main {
            jniLibs.srcDirs = ['src/main/jniLibs']
        }
    }
}
</code></pre>
<h3 id="pubspecyaml-é…ç½®"><a class="header" href="#pubspecyaml-é…ç½®">pubspec.yaml é…ç½®</a></h3>
<pre><code class="language-yaml"># pubspec.yaml
dependencies:
  flutter:
    sdk: flutter
  ffi: ^2.0.1

# FFI æ–¹å¼éœ€è¦
assets:
  - assets/

# Plugin é…ç½® (å¦‚æœè¦ç™¼å¸ƒç‚º plugin)
flutter:
  plugin:
    platforms:
      android:
        package: com.example.native_plugin
        pluginClass: NativePlugin
</code></pre>
<hr />
<h2 id="é™¤éŒ¯å’Œæ¸¬è©¦"><a class="header" href="#é™¤éŒ¯å’Œæ¸¬è©¦">é™¤éŒ¯å’Œæ¸¬è©¦</a></h2>
<h3 id="android-æ—¥èªŒæŸ¥çœ‹"><a class="header" href="#android-æ—¥èªŒæŸ¥çœ‹">Android æ—¥èªŒæŸ¥çœ‹</a></h3>
<pre><code class="language-bash"># æŸ¥çœ‹æ‰€æœ‰æ—¥èªŒ
adb logcat

# åªæŸ¥çœ‹ç‰¹å®š tag
adb logcat -s "RustFFI"
adb logcat -s "NativeLib"

# æŸ¥çœ‹ Flutter æ—¥èªŒ
adb logcat -s "flutter"
</code></pre>
<h3 id="å¸¸è¦‹å•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆ"><a class="header" href="#å¸¸è¦‹å•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆ">å¸¸è¦‹å•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆ</a></h3>
<h4 id="1-åº«æ‰¾ä¸åˆ°"><a class="header" href="#1-åº«æ‰¾ä¸åˆ°">1. åº«æ‰¾ä¸åˆ°</a></h4>
<pre><code>java.lang.UnsatisfiedLinkError: dlopen failed: library "libflutter_native.so" not found
</code></pre>
<p><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong></p>
<ul>
<li>æª¢æŸ¥ <code>.so</code> æª”æ¡ˆæ˜¯å¦æ­£ç¢ºæ”¾åœ¨ <code>jniLibs</code> å°æ‡‰æ¶æ§‹è³‡æ–™å¤¾</li>
<li>ç¢ºèªæª”æ¡ˆåç¨±æ­£ç¢ºï¼ˆå¿…é ˆä»¥ <code>lib</code> é–‹é ­ï¼‰</li>
<li>æª¢æŸ¥ build.gradle ä¸­çš„ <code>abiFilters</code> è¨­å®š</li>
</ul>
<h4 id="2-ç¬¦è™Ÿæ‰¾ä¸åˆ°"><a class="header" href="#2-ç¬¦è™Ÿæ‰¾ä¸åˆ°">2. ç¬¦è™Ÿæ‰¾ä¸åˆ°</a></h4>
<pre><code>java.lang.UnsatisfiedLinkError: No implementation found for native method
</code></pre>
<p><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong></p>
<ul>
<li>æª¢æŸ¥ C/C++ å‡½æ•¸åç¨±æ˜¯å¦èˆ‡ JNI è¦ç¯„ä¸€è‡´</li>
<li>ç¢ºèª <code>extern "C"</code> è²æ˜æ­£ç¢º</li>
<li>ä½¿ç”¨ <code>nm</code> æˆ– <code>objdump</code> æª¢æŸ¥ç¬¦è™Ÿæ˜¯å¦å­˜åœ¨</li>
</ul>
<h4 id="3-è¨˜æ†¶é«”æ´©æ¼"><a class="header" href="#3-è¨˜æ†¶é«”æ´©æ¼">3. è¨˜æ†¶é«”æ´©æ¼</a></h4>
<p><strong>æœ€ä½³å¯¦è¸ï¼š</strong></p>
<pre><code class="language-dart">// æ­£ç¢ºçš„è¨˜æ†¶é«”ç®¡ç†
String callNative(String input) {
  final inputPtr = input.toNativeUtf8();
  try {
    final resultPtr = _nativeFunction(inputPtr);
    final result = resultPtr.toDartString();
    _freeString(resultPtr); // é‡è¦ï¼é‡‹æ”¾ native è¨˜æ†¶é«”
    return result;
  } finally {
    malloc.free(inputPtr); // é‡è¦ï¼é‡‹æ”¾ Dart åˆ†é…çš„è¨˜æ†¶é«”
  }
}
</code></pre>
<hr />
<h2 id="æ•ˆèƒ½æ¯”è¼ƒ"><a class="header" href="#æ•ˆèƒ½æ¯”è¼ƒ">æ•ˆèƒ½æ¯”è¼ƒ</a></h2>
<div class="table-wrapper"><table><thead><tr><th>æ–¹æ¡ˆ</th><th>èª¿ç”¨å»¶é²</th><th>è¨˜æ†¶é«”ä½¿ç”¨</th><th>è¤‡é›œåº¦</th><th>ç¶­è­·æ€§</th></tr></thead><tbody>
<tr><td><strong>FFI ç›´æ¥</strong></td><td>~1Î¼s</td><td>ä½</td><td>ä¸­</td><td>å¥½</td></tr>
<tr><td><strong>Platform Channel + JNI</strong></td><td>~100Î¼s</td><td>ä¸­</td><td>é«˜</td><td>è¤‡é›œ</td></tr>
</tbody></table>
</div>
<h2 id="ç¸½çµå»ºè­°"><a class="header" href="#ç¸½çµå»ºè­°">ç¸½çµå»ºè­°</a></h2>
<h3 id="-æ¨è–¦ffi-ç›´æ¥èª¿ç”¨"><a class="header" href="#-æ¨è–¦ffi-ç›´æ¥èª¿ç”¨">ğŸ¥‡ æ¨è–¦ï¼šFFI ç›´æ¥èª¿ç”¨</a></h3>
<ul>
<li><strong>å„ªé»</strong>ï¼šæ€§èƒ½æœ€ä½³ã€ç›¸å°ç°¡å–®ã€è·¨å¹³è‡ºä¸€è‡´</li>
<li><strong>ç¼ºé»</strong>ï¼šéœ€è¦ç®¡ç†è¨˜æ†¶é«”ã€ä¸èƒ½ä½¿ç”¨ Android ç‰¹å®š API</li>
<li><strong>é©ç”¨</strong>ï¼šç´”è¨ˆç®—é‚è¼¯ã€è·¨å¹³è‡ºåº«</li>
</ul>
<h3 id="-å‚™é¸platform-channel--jni"><a class="header" href="#-å‚™é¸platform-channel--jni">ğŸ¥ˆ å‚™é¸ï¼šPlatform Channel + JNI</a></h3>
<ul>
<li><strong>å„ªé»</strong>ï¼šå¯ä½¿ç”¨å®Œæ•´ Android APIã€éŒ¯èª¤è™•ç†æ›´å¥½</li>
<li><strong>ç¼ºé»</strong>ï¼šæ€§èƒ½è¼ƒå·®ã€è¤‡é›œåº¦é«˜ã€ç¶­è­·å›°é›£</li>
<li><strong>é©ç”¨</strong>ï¼šéœ€è¦ Android ç‰¹å®šåŠŸèƒ½ã€è¤‡é›œçš„ç³»çµ±æ•´åˆ</li>
</ul>
<h3 id="æœ€ä½³å¯¦è¸"><a class="header" href="#æœ€ä½³å¯¦è¸">æœ€ä½³å¯¦è¸</a></h3>
<ol>
<li><strong>å„ªå…ˆè€ƒæ…® FFI</strong>ï¼šé™¤éå¿…é ˆä½¿ç”¨ Android ç‰¹å®šåŠŸèƒ½</li>
<li><strong>è¨˜æ†¶é«”ç®¡ç†</strong>ï¼šå‹™å¿…æ­£ç¢ºé‡‹æ”¾ native åˆ†é…çš„è¨˜æ†¶é«”</li>
<li><strong>éŒ¯èª¤è™•ç†</strong>ï¼šåœ¨æ‰€æœ‰ native èª¿ç”¨å‘¨åœæ·»åŠ ç•°å¸¸è™•ç†</li>
<li><strong>æ¸¬è©¦</strong>ï¼šåœ¨æ‰€æœ‰ç›®æ¨™æ¶æ§‹ä¸Šé€²è¡Œå……åˆ†æ¸¬è©¦</li>
<li><strong>æ—¥èªŒ</strong>ï¼šæ·»åŠ è©³ç´°çš„æ—¥èªŒä»¥ä¾¿é™¤éŒ¯</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../android/buttplug_porting_guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../android/ffi_vs_flutter_rust_bridge.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../android/buttplug_porting_guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../android/ffi_vs_flutter_rust_bridge.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
