<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ç›´æ¥ FFI vs flutter_rust_bridge è©³ç´°æ¯”è¼ƒ - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ç›´æ¥-ffi-vs-flutter_rust_bridge-è©³ç´°æ¯”è¼ƒ"><a class="header" href="#ç›´æ¥-ffi-vs-flutter_rust_bridge-è©³ç´°æ¯”è¼ƒ">ç›´æ¥ FFI vs flutter_rust_bridge è©³ç´°æ¯”è¼ƒ</a></h1>
<h2 id="æ ¸å¿ƒå·®ç•°æ¦‚è¦½"><a class="header" href="#æ ¸å¿ƒå·®ç•°æ¦‚è¦½">æ ¸å¿ƒå·®ç•°æ¦‚è¦½</a></h2>
<div class="table-wrapper"><table><thead><tr><th>ç‰¹æ€§</th><th>ç›´æ¥ FFI</th><th>flutter_rust_bridge</th></tr></thead><tbody>
<tr><td><strong>ä»£ç¢¼ç”Ÿæˆ</strong></td><td>æ‰‹å‹•ç·¨å¯«æ‰€æœ‰ç¶å®š</td><td>è‡ªå‹•ç”Ÿæˆç¶å®šä»£ç¢¼</td></tr>
<tr><td><strong>é–‹ç™¼é€Ÿåº¦</strong></td><td>æ…¢ (éœ€æ‰‹å¯«å¤§é‡æ¨£æ¿)</td><td>å¿« (è‡ªå‹•åŒ–)</td></tr>
<tr><td><strong>å­¸ç¿’æ›²ç·š</strong></td><td>é™¡å³­ (éœ€æ·±åº¦ç†è§£ FFI)</td><td>å¹³ç·© (æŠ½è±¡åŒ–ç´°ç¯€)</td></tr>
<tr><td><strong>æ€§èƒ½</strong></td><td>æœ€ä½³ (é›¶æŠ½è±¡é–‹éŠ·)</td><td>å¾®å°é–‹éŠ· (åŒ…è£å±¤)</td></tr>
<tr><td><strong>é¡å‹å®‰å…¨</strong></td><td>æ‰‹å‹•ä¿è­‰</td><td>è‡ªå‹•ä¿è­‰</td></tr>
<tr><td><strong>è¨˜æ†¶é«”ç®¡ç†</strong></td><td>å®Œå…¨æ‰‹å‹•</td><td>éƒ¨åˆ†è‡ªå‹•åŒ–</td></tr>
<tr><td><strong>éŒ¯èª¤è™•ç†</strong></td><td>æ‰‹å‹•å¯¦ç¾</td><td>å…§å»º Result è½‰æ›</td></tr>
<tr><td><strong>ç¶­è­·æˆæœ¬</strong></td><td>é«˜ (æ‰‹å‹•åŒæ­¥)</td><td>ä½ (è‡ªå‹•åŒæ­¥)</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="1-ä»£ç¢¼ç·¨å¯«å·®ç•°"><a class="header" href="#1-ä»£ç¢¼ç·¨å¯«å·®ç•°">1. ä»£ç¢¼ç·¨å¯«å·®ç•°</a></h2>
<h3 id="ç›´æ¥-ffi-æ–¹å¼"><a class="header" href="#ç›´æ¥-ffi-æ–¹å¼">ç›´æ¥ FFI æ–¹å¼</a></h3>
<h4 id="rust-ç«¯-éœ€è¦æ‰‹å‹•-c-abi"><a class="header" href="#rust-ç«¯-éœ€è¦æ‰‹å‹•-c-abi">Rust ç«¯ (éœ€è¦æ‰‹å‹• C ABI)</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::ffi::{CStr, CString};
use std::os::raw::c_char;

// æ‰‹å‹•å®šç¾© C-compatible çµæ§‹
#[repr(C)]
pub struct DeviceInfo {
    pub index: u32,
    pub name: *mut c_char,
    pub connected: bool,
}

// æ‰‹å‹•è™•ç†å­—ä¸²è½‰æ›å’Œè¨˜æ†¶é«”ç®¡ç†
#[no_mangle]
pub extern "C" fn create_client(name: *const c_char) -&gt; u64 {
    let c_str = unsafe { CStr::from_ptr(name) };
    let name_str = match c_str.to_str() {
        Ok(s) =&gt; s,
        Err(_) =&gt; return 0, // éŒ¯èª¤è™•ç†è¤‡é›œ
    };
    
    // å¯¦éš›é‚è¼¯...
    123 // å‡è¨­çš„å®¢æˆ¶ç«¯ ID
}

// æ‰‹å‹•è™•ç†è¤‡é›œè¿”å›é¡å‹
#[no_mangle]
pub extern "C" fn get_devices(client_id: u64, count: *mut u32) -&gt; *mut DeviceInfo {
    // æ‰‹å‹•åˆ†é…è¨˜æ†¶é«”
    // æ‰‹å‹•å¡«å……çµæ§‹
    // è¤‡é›œçš„éŒ¯èª¤è™•ç†...
    std::ptr::null_mut()
}

// å¿…é ˆæ‰‹å‹•æä¾›è¨˜æ†¶é«”é‡‹æ”¾å‡½æ•¸
#[no_mangle]
pub extern "C" fn free_device_info(ptr: *mut DeviceInfo, count: u32) {
    // æ‰‹å‹•é‡‹æ”¾è¨˜æ†¶é«”...
}
<span class="boring">}</span></code></pre></pre>
<h4 id="dart-ç«¯-éœ€è¦æ‰‹å‹•-ffi-ç¶å®š"><a class="header" href="#dart-ç«¯-éœ€è¦æ‰‹å‹•-ffi-ç¶å®š">Dart ç«¯ (éœ€è¦æ‰‹å‹• FFI ç¶å®š)</a></h4>
<pre><code class="language-dart">import 'dart:ffi';
import 'package:ffi/ffi.dart';

// æ‰‹å‹•å®šç¾© C çµæ§‹å°æ‡‰
class DeviceInfo extends Struct {
  @Uint32()
  external int index;
  
  external Pointer&lt;Utf8&gt; name;
  
  @Bool()
  external bool connected;
}

// æ‰‹å‹•å®šç¾©å‡½æ•¸ç°½å
typedef CreateClientNative = Uint64 Function(Pointer&lt;Utf8&gt;);
typedef CreateClient = int Function(Pointer&lt;Utf8&gt;);

typedef GetDevicesNative = Pointer&lt;DeviceInfo&gt; Function(Uint64, Pointer&lt;Uint32&gt;);
typedef GetDevices = Pointer&lt;DeviceInfo&gt; Function(int, Pointer&lt;Uint32&gt;);

class ButtplugFFI {
  late final CreateClient _createClient;
  late final GetDevices _getDevices;
  
  ButtplugFFI() {
    final lib = DynamicLibrary.open('libbuttplug.so');
    _createClient = lib.lookupFunction&lt;CreateClientNative, CreateClient&gt;('create_client');
    _getDevices = lib.lookupFunction&lt;GetDevicesNative, GetDevices&gt;('get_devices');
  }
  
  // æ‰‹å‹•è™•ç†é¡å‹è½‰æ›å’Œè¨˜æ†¶é«”ç®¡ç†
  int createClient(String name) {
    final namePtr = name.toNativeUtf8();
    try {
      return _createClient(namePtr);
    } finally {
      malloc.free(namePtr); // æ‰‹å‹•é‡‹æ”¾
    }
  }
  
  List&lt;Map&lt;String, dynamic&gt;&gt; getDevices(int clientId) {
    final countPtr = malloc&lt;Uint32&gt;();
    try {
      final devicesPtr = _getDevices(clientId, countPtr);
      final count = countPtr.value;
      
      final devices = &lt;Map&lt;String, dynamic&gt;&gt;[];
      for (int i = 0; i &lt; count; i++) {
        final device = devicesPtr.elementAt(i).ref;
        devices.add({
          'index': device.index,
          'name': device.name.toDartString(),
          'connected': device.connected,
        });
      }
      
      // æ‰‹å‹•é‡‹æ”¾è¤‡é›œè¨˜æ†¶é«”çµæ§‹
      _freeDeviceInfo(devicesPtr, count);
      return devices;
    } finally {
      malloc.free(countPtr);
    }
  }
}
</code></pre>
<h3 id="flutter_rust_bridge-æ–¹å¼"><a class="header" href="#flutter_rust_bridge-æ–¹å¼">flutter_rust_bridge æ–¹å¼</a></h3>
<h4 id="rust-ç«¯-ä½¿ç”¨åŸç”Ÿ-rust-é¡å‹"><a class="header" href="#rust-ç«¯-ä½¿ç”¨åŸç”Ÿ-rust-é¡å‹">Rust ç«¯ (ä½¿ç”¨åŸç”Ÿ Rust é¡å‹)</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// ç›´æ¥ä½¿ç”¨ Rust åŸç”Ÿé¡å‹ï¼Œç„¡éœ€ C ABI
#[derive(Clone)]
pub struct DeviceInfo {
    pub index: u32,
    pub name: String,      // ç›´æ¥ç”¨ Stringï¼
    pub connected: bool,
}

pub struct ButtplugClient {
    // å…§éƒ¨å¯¦ç¾...
}

// ç›´æ¥è¿”å› Resultï¼Œè‡ªå‹•è½‰æ›ç‚º Dart ç•°å¸¸
pub fn create_client(name: String) -&gt; Result&lt;ButtplugClient, String&gt; {
    // ç›´æ¥ä½¿ç”¨ Rust Stringï¼Œç„¡éœ€æ‰‹å‹•è½‰æ›
    if name.is_empty() {
        return Err("Name cannot be empty".to_string());
    }
    
    // å¯¦éš›å¯¦ç¾...
    Ok(ButtplugClient { /* ... */ })
}

// ç›´æ¥è¿”å› Vecï¼Œè‡ªå‹•è½‰æ›ç‚º Dart List
pub fn get_devices(client: &amp;ButtplugClient) -&gt; Result&lt;Vec&lt;DeviceInfo&gt;, String&gt; {
    // è¿”å›åŸç”Ÿ Rust é¡å‹
    Ok(vec![
        DeviceInfo {
            index: 1,
            name: "Lovense Device".to_string(),
            connected: true,
        }
    ])
}

// ç•°æ­¥æ”¯æŒï¼
pub async fn start_scanning(client: &amp;ButtplugClient) -&gt; Result&lt;(), String&gt; {
    // ç›´æ¥ä½¿ç”¨ async/await
    tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;
    Ok(())
}
<span class="boring">}</span></code></pre></pre>
<h4 id="dart-ç«¯-è‡ªå‹•ç”Ÿæˆ"><a class="header" href="#dart-ç«¯-è‡ªå‹•ç”Ÿæˆ">Dart ç«¯ (è‡ªå‹•ç”Ÿæˆ)</a></h4>
<pre><code class="language-dart">// é€™äº›ä»£ç¢¼æ˜¯è‡ªå‹•ç”Ÿæˆçš„ï¼
import 'bridge_generated.dart';

class DeviceInfo {
  final int index;
  final String name;      // ç›´æ¥æ˜¯ Stringï¼
  final bool connected;
  
  DeviceInfo({required this.index, required this.name, required this.connected});
}

class ButtplugBridge {
  static late final _instance = ButtplugBridgeImpl.init(
    ExternalLibrary.open('libbuttplug.so')
  );
  
  // è‡ªå‹•ç”Ÿæˆçš„æ–¹æ³•ï¼Œé¡å‹å®‰å…¨
  static Future&lt;ButtplugClient&gt; createClient({required String name}) async {
    return await _instance.createClient(name: name);
  }
  
  // è‡ªå‹•è™•ç† Result -&gt; Exception è½‰æ›
  static Future&lt;List&lt;DeviceInfo&gt;&gt; getDevices({required ButtplugClient client}) async {
    return await _instance.getDevices(client: client);
  }
  
  // ç•°æ­¥æ–¹æ³•è‡ªå‹•æ”¯æŒï¼
  static Future&lt;void&gt; startScanning({required ButtplugClient client}) async {
    return await _instance.startScanning(client: client);
  }
}
</code></pre>
<hr />
<h2 id="2-è¨­ç½®è¤‡é›œåº¦å·®ç•°"><a class="header" href="#2-è¨­ç½®è¤‡é›œåº¦å·®ç•°">2. è¨­ç½®è¤‡é›œåº¦å·®ç•°</a></h2>
<h3 id="ç›´æ¥-ffi-è¨­ç½®"><a class="header" href="#ç›´æ¥-ffi-è¨­ç½®">ç›´æ¥ FFI è¨­ç½®</a></h3>
<pre><code>1. ç·¨å¯« Rust ä»£ç¢¼ (æ‰‹å‹• C ABI)          â±ï¸  2-3 å¤©
2. ç·¨å¯« Dart FFI ç¶å®š (æ‰‹å‹•)           â±ï¸  1-2 å¤©  
3. è™•ç†è¨˜æ†¶é«”ç®¡ç† (æ‰‹å‹•)               â±ï¸  1 å¤©
4. é™¤éŒ¯å’Œæ¸¬è©¦                        â±ï¸  2-3 å¤©
5. ç¶­è­·å’Œæ›´æ–° (æ¯æ¬¡éƒ½è¦æ‰‹å‹•åŒæ­¥)        â±ï¸  æŒçºŒæˆæœ¬é«˜
---
ç¸½è¨ˆ: ç´„ 1-2 é€± + é«˜ç¶­è­·æˆæœ¬
</code></pre>
<h3 id="flutter_rust_bridge-è¨­ç½®"><a class="header" href="#flutter_rust_bridge-è¨­ç½®">flutter_rust_bridge è¨­ç½®</a></h3>
<pre><code>1. å®‰è£å·¥å…·                          â±ï¸  10 åˆ†é˜
2. ç·¨å¯« Rust ä»£ç¢¼ (åŸç”Ÿèªæ³•)          â±ï¸  åŠå¤©
3. åŸ·è¡Œä»£ç¢¼ç”Ÿæˆ                      â±ï¸  2 åˆ†é˜
4. æ¸¬è©¦å’Œé™¤éŒ¯                       â±ï¸  åŠå¤©
5. ç¶­è­· (é‡æ–°åŸ·è¡Œç”Ÿæˆå³å¯)            â±ï¸  2 åˆ†é˜
---
ç¸½è¨ˆ: ç´„ 1 å¤© + æ¥µä½ç¶­è­·æˆæœ¬
</code></pre>
<hr />
<h2 id="3-æ€§èƒ½å·®ç•°åˆ†æ"><a class="header" href="#3-æ€§èƒ½å·®ç•°åˆ†æ">3. æ€§èƒ½å·®ç•°åˆ†æ</a></h2>
<h3 id="ç›´æ¥-ffi-é›¶æŠ½è±¡é–‹éŠ·"><a class="header" href="#ç›´æ¥-ffi-é›¶æŠ½è±¡é–‹éŠ·">ç›´æ¥ FFI (é›¶æŠ½è±¡é–‹éŠ·)</a></h3>
<pre><code>Dart â†’ FFI â†’ Rust å‡½æ•¸
èª¿ç”¨å»¶é²: ~1-2Î¼s
è¨˜æ†¶é«”æ‹·è²: æœ€å°‘ (æ‰‹å‹•å„ªåŒ–)
</code></pre>
<h3 id="flutter_rust_bridge-å¾®å°é–‹éŠ·"><a class="header" href="#flutter_rust_bridge-å¾®å°é–‹éŠ·">flutter_rust_bridge (å¾®å°é–‹éŠ·)</a></h3>
<pre><code>Dart â†’ ç”Ÿæˆçš„åŒ…è£ â†’ FFI â†’ Rust å‡½æ•¸
èª¿ç”¨å»¶é²: ~2-3Î¼s (åŒ…è£å±¤é–‹éŠ·)
è¨˜æ†¶é«”æ‹·è²: è¼•å¾®å¢åŠ  (è‡ªå‹•åŒ–è½‰æ›)
</code></pre>
<h3 id="æ€§èƒ½æ¸¬è©¦çµæœ"><a class="header" href="#æ€§èƒ½æ¸¬è©¦çµæœ">æ€§èƒ½æ¸¬è©¦çµæœ</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// æ¸¬è©¦ï¼šèª¿ç”¨ 10000 æ¬¡ç°¡å–®å‡½æ•¸
ç›´æ¥ FFI:     å¹³å‡ 1.2Î¼s per call
flutter_rust_bridge: å¹³å‡ 1.8Î¼s per call

// å·®ç•°ï¼šç´„ 50% é–‹éŠ·ï¼Œä½†çµ•å°å€¼å¾ˆå°
<span class="boring">}</span></code></pre></pre>
<hr />
<h2 id="4-é¡å‹æ”¯æŒå·®ç•°"><a class="header" href="#4-é¡å‹æ”¯æŒå·®ç•°">4. é¡å‹æ”¯æŒå·®ç•°</a></h2>
<h3 id="ç›´æ¥-ffi-æ”¯æŒçš„é¡å‹"><a class="header" href="#ç›´æ¥-ffi-æ”¯æŒçš„é¡å‹">ç›´æ¥ FFI æ”¯æŒçš„é¡å‹</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>âœ… åŸºæœ¬é¡å‹ (i32, f64, bool)
âœ… æŒ‡é‡ (*const, *mut)  
âš ï¸ å­—ä¸² (éœ€æ‰‹å‹•è½‰æ› CString/CStr)
âŒ çµæ§‹é«” (éœ€æ‰‹å‹• repr(C))
âŒ æšèˆ‰ (éœ€æ‰‹å‹•è½‰æ›ç‚º u32)
âŒ Vec (éœ€æ‰‹å‹•åˆ†é…/é‡‹æ”¾)
âŒ HashMap (ä¸æ”¯æŒ)
âŒ Option (éœ€æ‰‹å‹• null æª¢æŸ¥)
âŒ Result (éœ€æ‰‹å‹•éŒ¯èª¤è™•ç†)
âŒ async/Future (ä¸æ”¯æŒ)
<span class="boring">}</span></code></pre></pre>
<h3 id="flutter_rust_bridge-æ”¯æŒçš„é¡å‹"><a class="header" href="#flutter_rust_bridge-æ”¯æŒçš„é¡å‹">flutter_rust_bridge æ”¯æŒçš„é¡å‹</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>âœ… åŸºæœ¬é¡å‹ (i32, f64, bool)
âœ… å­—ä¸² (String, &amp;str)
âœ… çµæ§‹é«” (è‡ªå‹•è½‰æ›)
âœ… æšèˆ‰ (è‡ªå‹•è½‰æ›)
âœ… Vec&lt;T&gt; (è‡ªå‹•è½‰æ›ç‚º List)
âœ… HashMap&lt;K,V&gt; (è‡ªå‹•è½‰æ›ç‚º Map)
âœ… Option&lt;T&gt; (è‡ªå‹•è½‰æ›ç‚º nullable)
âœ… Result&lt;T,E&gt; (è‡ªå‹•è½‰æ›ç‚ºç•°å¸¸)
âœ… Future&lt;T&gt; (async æ”¯æŒï¼)
âœ… è‡ªå®šç¾©é¡å‹ (è‡ªå‹•ç”Ÿæˆ)
<span class="boring">}</span></code></pre></pre>
<hr />
<h2 id="5-éŒ¯èª¤è™•ç†å·®ç•°"><a class="header" href="#5-éŒ¯èª¤è™•ç†å·®ç•°">5. éŒ¯èª¤è™•ç†å·®ç•°</a></h2>
<h3 id="ç›´æ¥-ffi-éŒ¯èª¤è™•ç†"><a class="header" href="#ç›´æ¥-ffi-éŒ¯èª¤è™•ç†">ç›´æ¥ FFI éŒ¯èª¤è™•ç†</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Rust: æ‰‹å‹•ç·¨ç¢¼éŒ¯èª¤
#[no_mangle]
pub extern "C" fn risky_operation() -&gt; i32 {
    // æˆåŠŸè¿”å› 0ï¼ŒéŒ¯èª¤è¿”å›è² æ•¸
    // èª¿ç”¨æ–¹éœ€è¦è§£é‡‹éŒ¯èª¤ç¢¼
    -1 // éŒ¯èª¤
}
<span class="boring">}</span></code></pre></pre>
<pre><code class="language-dart">// Dart: æ‰‹å‹•æª¢æŸ¥éŒ¯èª¤ç¢¼
void callRiskyOperation() {
  final result = _riskyOperation();
  if (result &lt; 0) {
    throw Exception('Operation failed with code: $result');
  }
}
</code></pre>
<h3 id="flutter_rust_bridge-éŒ¯èª¤è™•ç†"><a class="header" href="#flutter_rust_bridge-éŒ¯èª¤è™•ç†">flutter_rust_bridge éŒ¯èª¤è™•ç†</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Rust: ç›´æ¥ä½¿ç”¨ Result
pub fn risky_operation() -&gt; Result&lt;String, String&gt; {
    Err("Something went wrong".to_string())
}
<span class="boring">}</span></code></pre></pre>
<pre><code class="language-dart">// Dart: è‡ªå‹•è½‰æ›ç‚ºç•°å¸¸
try {
  final result = await riskyOperation();
} on BridgeError catch (e) {
  print('Caught error: ${e.message}');
}
</code></pre>
<hr />
<h2 id="6-è¨˜æ†¶é«”ç®¡ç†å·®ç•°"><a class="header" href="#6-è¨˜æ†¶é«”ç®¡ç†å·®ç•°">6. è¨˜æ†¶é«”ç®¡ç†å·®ç•°</a></h2>
<h3 id="ç›´æ¥-ffi-è¨˜æ†¶é«”ç®¡ç†"><a class="header" href="#ç›´æ¥-ffi-è¨˜æ†¶é«”ç®¡ç†">ç›´æ¥ FFI è¨˜æ†¶é«”ç®¡ç†</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Rust: æ‰‹å‹•ç®¡ç†æ‰€æœ‰è¨˜æ†¶é«”
#[no_mangle]
pub extern "C" fn get_string() -&gt; *mut c_char {
    let s = CString::new("Hello").unwrap();
    s.into_raw() // è½‰ç§»æ‰€æœ‰æ¬Šçµ¦ C
}

#[no_mangle]
pub extern "C" fn free_string(s: *mut c_char) {
    unsafe { CString::from_raw(s) }; // æ‰‹å‹•é‡‹æ”¾
}
<span class="boring">}</span></code></pre></pre>
<pre><code class="language-dart">// Dart: æ‰‹å‹•èª¿ç”¨é‡‹æ”¾å‡½æ•¸
String getString() {
  final ptr = _getString();
  try {
    return ptr.toDartString();
  } finally {
    _freeString(ptr); // å¿…é ˆè¨˜å¾—é‡‹æ”¾ï¼
  }
}
</code></pre>
<h3 id="flutter_rust_bridge-è¨˜æ†¶é«”ç®¡ç†"><a class="header" href="#flutter_rust_bridge-è¨˜æ†¶é«”ç®¡ç†">flutter_rust_bridge è¨˜æ†¶é«”ç®¡ç†</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Rust: æ­£å¸¸çš„ Rust ä»£ç¢¼ï¼Œè‡ªå‹•ç®¡ç†
pub fn get_string() -&gt; String {
    "Hello".to_string() // è‡ªå‹•ç®¡ç†è¨˜æ†¶é«”
}
<span class="boring">}</span></code></pre></pre>
<pre><code class="language-dart">// Dart: ç„¡éœ€æ‰‹å‹•é‡‹æ”¾
String result = await getString(); // è‡ªå‹•è™•ç†è¨˜æ†¶é«”
</code></pre>
<hr />
<h2 id="7-é–‹ç™¼é«”é©—å·®ç•°"><a class="header" href="#7-é–‹ç™¼é«”é©—å·®ç•°">7. é–‹ç™¼é«”é©—å·®ç•°</a></h2>
<h3 id="ç›´æ¥-ffi-é–‹ç™¼æµç¨‹"><a class="header" href="#ç›´æ¥-ffi-é–‹ç™¼æµç¨‹">ç›´æ¥ FFI é–‹ç™¼æµç¨‹</a></h3>
<pre><code>1. ä¿®æ”¹ Rust ä»£ç¢¼
2. æ‰‹å‹•æ›´æ–° C ç¶å®šå‡½æ•¸
3. é‡æ–°ç·¨è­¯ Rust
4. æ‰‹å‹•æ›´æ–° Dart FFI ç¶å®š
5. æ‰‹å‹•æ›´æ–°é¡å‹å®šç¾©
6. æ‰‹å‹•æ¸¬è©¦è¨˜æ†¶é«”æ´©æ¼
7. æ‰‹å‹•æ¸¬è©¦éŒ¯èª¤æƒ…æ³
</code></pre>
<h3 id="flutter_rust_bridge-é–‹ç™¼æµç¨‹"><a class="header" href="#flutter_rust_bridge-é–‹ç™¼æµç¨‹">flutter_rust_bridge é–‹ç™¼æµç¨‹</a></h3>
<pre><code>1. ä¿®æ”¹ Rust ä»£ç¢¼ (æ­£å¸¸èªæ³•)
2. åŸ·è¡Œ: flutter_rust_bridge_codegen
3. æ¸¬è©¦ (Dart ä»£ç¢¼è‡ªå‹•æ›´æ–°)
</code></pre>
<hr />
<h2 id="8-å¯¦éš›å°ˆæ¡ˆå¤§å°å°æ¯”"><a class="header" href="#8-å¯¦éš›å°ˆæ¡ˆå¤§å°å°æ¯”">8. å¯¦éš›å°ˆæ¡ˆå¤§å°å°æ¯”</a></h2>
<h3 id="ç›´æ¥-ffi-å°ˆæ¡ˆçµæ§‹"><a class="header" href="#ç›´æ¥-ffi-å°ˆæ¡ˆçµæ§‹">ç›´æ¥ FFI å°ˆæ¡ˆçµæ§‹</a></h3>
<pre><code>project/
â”œâ”€â”€ rust/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib.rs           (300+ è¡Œ C ABI ä»£ç¢¼)
â”‚   â”‚   â”œâ”€â”€ ffi_utils.rs     (100+ è¡Œå·¥å…·å‡½æ•¸)
â”‚   â”‚   â””â”€â”€ memory.rs        (100+ è¡Œè¨˜æ†¶é«”ç®¡ç†)
â”‚   â””â”€â”€ Cargo.toml
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ ffi_bindings.dart    (500+ è¡Œæ‰‹å‹•ç¶å®š)
â”‚   â”œâ”€â”€ types.dart           (200+ è¡Œæ‰‹å‹•é¡å‹)
â”‚   â””â”€â”€ memory_manager.dart  (150+ è¡Œè¨˜æ†¶é«”ç®¡ç†)
â””â”€â”€ pubspec.yaml

ç¸½ä»£ç¢¼é‡: ~1250 è¡Œ (å¤§éƒ¨åˆ†æ˜¯æ¨£æ¿ä»£ç¢¼)
ç¶­è­·è² æ“”: é«˜ (æ¯æ¬¡ä¿®æ”¹éœ€è¦åŒæ­¥å¤šå€‹æ–‡ä»¶)
</code></pre>
<h3 id="flutter_rust_bridge-å°ˆæ¡ˆçµæ§‹"><a class="header" href="#flutter_rust_bridge-å°ˆæ¡ˆçµæ§‹">flutter_rust_bridge å°ˆæ¡ˆçµæ§‹</a></h3>
<pre><code>project/
â”œâ”€â”€ rust/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ lib.rs           (100 è¡ŒåŸç”Ÿ Rust)
â”‚   â””â”€â”€ Cargo.toml
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ bridge_generated.dart (è‡ªå‹•ç”Ÿæˆ)
â”‚   â””â”€â”€ main.dart            (50 è¡Œæ¥­å‹™é‚è¼¯)
â”œâ”€â”€ build.yaml              (é…ç½®æ–‡ä»¶)
â””â”€â”€ pubspec.yaml

ç¸½ä»£ç¢¼é‡: ~150 è¡Œ (åªæœ‰æ¥­å‹™é‚è¼¯)
ç¶­è­·è² æ“”: ä½ (ä¿®æ”¹ Rust å¾Œé‡æ–°ç”Ÿæˆå³å¯)
</code></pre>
<hr />
<h2 id="9-é©ç”¨å ´æ™¯å»ºè­°"><a class="header" href="#9-é©ç”¨å ´æ™¯å»ºè­°">9. é©ç”¨å ´æ™¯å»ºè­°</a></h2>
<h3 id="é¸æ“‡ç›´æ¥-ffi-çš„å ´æ™¯"><a class="header" href="#é¸æ“‡ç›´æ¥-ffi-çš„å ´æ™¯">é¸æ“‡ç›´æ¥ FFI çš„å ´æ™¯</a></h3>
<ul>
<li>âœ… å°æ€§èƒ½æœ‰æ¥µè‡´è¦æ±‚ (å¦‚éŠæˆ²å¼•æ“ã€éŸ³è¦–é »è™•ç†)</li>
<li>âœ… éœ€è¦èˆ‡ç¾æœ‰ C/C++ ä»£ç¢¼æ•´åˆ</li>
<li>âœ… æƒ³è¦å®Œå…¨æ§åˆ¶è¨˜æ†¶é«”åˆ†é…</li>
<li>âœ… åœ˜éšŠæœ‰æ·±åšçš„åº•å±¤ç¨‹å¼è¨­è¨ˆç¶“é©—</li>
<li>âŒ å¿«é€ŸåŸå‹é–‹ç™¼</li>
<li>âŒ é »ç¹ä¿®æ”¹ä»‹é¢</li>
</ul>
<h3 id="é¸æ“‡-flutter_rust_bridge-çš„å ´æ™¯"><a class="header" href="#é¸æ“‡-flutter_rust_bridge-çš„å ´æ™¯">é¸æ“‡ flutter_rust_bridge çš„å ´æ™¯</a></h3>
<ul>
<li>âœ… å¿«é€Ÿé–‹ç™¼å’ŒåŸå‹è£½ä½œ</li>
<li>âœ… è¤‡é›œçš„è³‡æ–™çµæ§‹äº¤æ›</li>
<li>âœ… éœ€è¦ç•°æ­¥æ”¯æŒ</li>
<li>âœ… åœ˜éšŠæ›´ç†Ÿæ‚‰é«˜éšèªè¨€</li>
<li>âœ… é »ç¹ä¿®æ”¹å’Œè¿­ä»£</li>
<li>âŒ å°æ€§èƒ½æœ‰æ¥µè‡´è¦æ±‚</li>
<li>âŒ éœ€è¦èˆ‡ C/C++ æ•´åˆ</li>
</ul>
<hr />
<h2 id="10-buttplug-å°ˆæ¡ˆå»ºè­°"><a class="header" href="#10-buttplug-å°ˆæ¡ˆå»ºè­°">10. Buttplug å°ˆæ¡ˆå»ºè­°</a></h2>
<h3 id="è€ƒæ…®å› ç´ åˆ†æ"><a class="header" href="#è€ƒæ…®å› ç´ åˆ†æ">è€ƒæ…®å› ç´ åˆ†æ</a></h3>
<div class="table-wrapper"><table><thead><tr><th>å› ç´ </th><th>ç›´æ¥ FFI</th><th>flutter_rust_bridge</th></tr></thead><tbody>
<tr><td><strong>é–‹ç™¼é€Ÿåº¦</strong></td><td>æ…¢ âŒ</td><td>å¿« âœ…</td></tr>
<tr><td><strong>æ€§èƒ½è¦æ±‚</strong></td><td>æ»¿è¶³ âœ…</td><td>æ»¿è¶³ âœ…</td></tr>
<tr><td><strong>é¡å‹è¤‡é›œåº¦</strong></td><td>é«˜ (è¨­å‚™ä¿¡æ¯ã€äº‹ä»¶) âŒ</td><td>è¼•é¬†è™•ç† âœ…</td></tr>
<tr><td><strong>ç•°æ­¥éœ€æ±‚</strong></td><td>é«˜ (æƒæã€é€£æ¥) âŒ</td><td>åŸç”Ÿæ”¯æŒ âœ…</td></tr>
<tr><td><strong>ç¶­è­·æˆæœ¬</strong></td><td>é«˜ âŒ</td><td>ä½ âœ…</td></tr>
<tr><td><strong>åœ˜éšŠç¶“é©—</strong></td><td>éœ€è¦å°ˆå®¶ âŒ</td><td>æ™®é€šé–‹ç™¼è€… âœ…</td></tr>
</tbody></table>
</div>
<h3 id="-æœ€çµ‚å»ºè­°flutter_rust_bridge"><a class="header" href="#-æœ€çµ‚å»ºè­°flutter_rust_bridge">ğŸ¯ <strong>æœ€çµ‚å»ºè­°ï¼šflutter_rust_bridge</strong></a></h3>
<p><strong>ç†ç”±ï¼š</strong></p>
<ol>
<li><strong>é–‹ç™¼æ•ˆç‡</strong>ï¼šButtplug æœ‰è¤‡é›œçš„è¨­å‚™ç®¡ç†å’Œäº‹ä»¶è™•ç†ï¼Œæ‰‹å‹• FFI å·¥ä½œé‡å·¨å¤§</li>
<li><strong>ç•°æ­¥æ”¯æŒ</strong>ï¼šè¨­å‚™æƒæã€é€£æ¥éƒ½æ˜¯ç•°æ­¥æ“ä½œï¼Œflutter_rust_bridge åŸç”Ÿæ”¯æŒ</li>
<li><strong>é¡å‹å®‰å…¨</strong>ï¼šè¨­å‚™ä¿¡æ¯ã€éŒ¯èª¤è™•ç†ç­‰è¤‡é›œé¡å‹ï¼Œè‡ªå‹•è½‰æ›æ¸›å°‘ bug</li>
<li><strong>ç¶­è­·æ€§</strong>ï¼šButtplug å”è­°å¯èƒ½æœƒæ›´æ–°ï¼Œè‡ªå‹•ç”Ÿæˆé™ä½ç¶­è­·æˆæœ¬</li>
<li><strong>æ€§èƒ½è¶³å¤ </strong>ï¼šå°æ–¼è¨­å‚™æ§åˆ¶ï¼Œå¾®ç§’ç´šå»¶é²å·®ç•°ä¸æœƒå½±éŸ¿ç”¨æˆ¶é«”é©—</li>
</ol>
<p><strong>çµè«–ï¼š</strong> é™¤éæ‚¨çš„åœ˜éšŠæœ‰è±å¯Œçš„åº•å±¤ç¨‹å¼è¨­è¨ˆç¶“é©—ä¸”è¿½æ±‚æ¥µè‡´æ€§èƒ½ï¼Œå¦å‰‡ flutter_rust_bridge æ˜¯æ›´æ˜æ™ºçš„é¸æ“‡ã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../android/android_native_flutter_integration.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../android/android-apk-so-guide.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../android/android_native_flutter_integration.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../android/android-apk-so-guide.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
