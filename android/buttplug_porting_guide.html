<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Buttplug Rust åˆ° Flutter çš„ Porting æ–¹æ¡ˆæŒ‡å— - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="buttplug-rust-åˆ°-flutter-çš„-porting-æ–¹æ¡ˆæŒ‡å—"><a class="header" href="#buttplug-rust-åˆ°-flutter-çš„-porting-æ–¹æ¡ˆæŒ‡å—">Buttplug Rust åˆ° Flutter çš„ Porting æ–¹æ¡ˆæŒ‡å—</a></h1>
<h2 id="æ–¹æ¡ˆæ¦‚è¦½"><a class="header" href="#æ–¹æ¡ˆæ¦‚è¦½">æ–¹æ¡ˆæ¦‚è¦½</a></h2>
<div class="table-wrapper"><table><thead><tr><th>æ–¹æ¡ˆ</th><th>è¤‡é›œåº¦</th><th>æ€§èƒ½</th><th>ç¶­è­·æ€§</th><th>æª”æ¡ˆå¤§å°</th><th>æ¨è–¦æŒ‡æ•¸</th></tr></thead><tbody>
<tr><td><strong>1. ä½¿ç”¨ç¾æœ‰ Dart å¥—ä»¶</strong></td><td>ğŸŸ¢ ä½</td><td>ğŸŸ¡ ä¸­</td><td>ğŸŸ¢ é«˜</td><td>ğŸŸ¢ å°</td><td>â­â­â­â­â­</td></tr>
<tr><td><strong>2. FFI ç›´æ¥èª¿ç”¨</strong></td><td>ğŸ”´ é«˜</td><td>ğŸŸ¢ é«˜</td><td>ğŸ”´ ä½</td><td>ğŸ”´ å¤§</td><td>â­â­</td></tr>
<tr><td><strong>3. ä½¿ç”¨ flutter_rust_bridge</strong></td><td>ğŸŸ¡ ä¸­</td><td>ğŸŸ¢ é«˜</td><td>ğŸŸ¡ ä¸­</td><td>ğŸ”´ å¤§</td><td>â­â­â­</td></tr>
<tr><td><strong>4. WebAssembly æ–¹æ¡ˆ</strong></td><td>ğŸŸ¡ ä¸­</td><td>ğŸŸ¡ ä¸­</td><td>ğŸŸ¡ ä¸­</td><td>ğŸŸ¡ ä¸­</td><td>â­â­â­</td></tr>
<tr><td><strong>5. Platform Channel</strong></td><td>ğŸ”´ é«˜</td><td>ğŸŸ¢ é«˜</td><td>ğŸ”´ ä½</td><td>ğŸ”´ å¤§</td><td>â­â­</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="æ–¹æ¡ˆ-1-ä½¿ç”¨ç¾æœ‰-dart-å¥—ä»¶-æ¨è–¦"><a class="header" href="#æ–¹æ¡ˆ-1-ä½¿ç”¨ç¾æœ‰-dart-å¥—ä»¶-æ¨è–¦">æ–¹æ¡ˆ 1: ä½¿ç”¨ç¾æœ‰ Dart å¥—ä»¶ (æ¨è–¦)</a></h2>
<h3 id="æ¦‚è¿°"><a class="header" href="#æ¦‚è¿°">æ¦‚è¿°</a></h3>
<p>ä½¿ç”¨å®˜æ–¹ <code>buttplug</code> Dart å¥—ä»¶ï¼Œé€™æ˜¯ç´” Dart å¯¦ç¾çš„å®¢æˆ¶ç«¯ã€‚</p>
<h3 id="å„ªé»"><a class="header" href="#å„ªé»">å„ªé»</a></h3>
<ul>
<li>âœ… é›¶é…ç½®ï¼Œé–‹ç®±å³ç”¨</li>
<li>âœ… å®˜æ–¹ç¶­è­·ï¼Œç©©å®šå¯é </li>
<li>âœ… ä¸éœ€è¦ç·¨è­¯ Rust</li>
<li>âœ… è·¨å¹³å°ä¸€è‡´æ€§</li>
<li>âœ… æª”æ¡ˆå¤§å°æœ€å°</li>
</ul>
<h3 id="ç¼ºé»"><a class="header" href="#ç¼ºé»">ç¼ºé»</a></h3>
<ul>
<li>âŒ éœ€è¦å¤–éƒ¨ Intiface Central</li>
<li>âŒ åŠŸèƒ½å¯èƒ½ä¸å¦‚å®Œæ•´ç‰ˆ</li>
</ul>
<h3 id="å¯¦ç¾æ–¹å¼"><a class="header" href="#å¯¦ç¾æ–¹å¼">å¯¦ç¾æ–¹å¼</a></h3>
<pre><code class="language-yaml"># pubspec.yaml
dependencies:
  buttplug: ^0.0.7
</code></pre>
<pre><code class="language-dart">import 'package:buttplug/buttplug.dart';

final client = ButtplugClient('My App');
final connector = ButtplugWebsocketConnector(Uri.parse('ws://localhost:12345'));
await client.connect(connector);
</code></pre>
<hr />
<h2 id="æ–¹æ¡ˆ-2-ffi-ç›´æ¥èª¿ç”¨"><a class="header" href="#æ–¹æ¡ˆ-2-ffi-ç›´æ¥èª¿ç”¨">æ–¹æ¡ˆ 2: FFI ç›´æ¥èª¿ç”¨</a></h2>
<h3 id="æ¦‚è¿°-1"><a class="header" href="#æ¦‚è¿°-1">æ¦‚è¿°</a></h3>
<p>ç›´æ¥ä½¿ç”¨ Dart FFI èª¿ç”¨ç·¨è­¯å¾Œçš„ Rust å‹•æ…‹åº«ã€‚</p>
<h3 id="å¯¦ç¾æ­¥é©Ÿ"><a class="header" href="#å¯¦ç¾æ­¥é©Ÿ">å¯¦ç¾æ­¥é©Ÿ</a></h3>
<h4 id="step-1-æº–å‚™-rust-åº«"><a class="header" href="#step-1-æº–å‚™-rust-åº«">Step 1: æº–å‚™ Rust åº«</a></h4>
<pre><code class="language-toml"># Cargo.toml
[lib]
name = "buttplug_ffi"
crate-type = ["cdylib"]

[dependencies]
buttplug = "8.5"
tokio = { version = "1.0", features = ["rt-multi-thread"] }
serde_json = "1.0"
</code></pre>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// src/lib.rs
use buttplug::{client::ButtplugClient, core::connector::ButtplugInProcessClientConnector};
use std::ffi::{CStr, CString};
use std::os::raw::c_char;

#[repr(C)]
pub struct ButtplugClientHandle {
    client: Box&lt;ButtplugClient&gt;,
    runtime: tokio::runtime::Runtime,
}

#[no_mangle]
pub extern "C" fn buttplug_create_client(name: *const c_char) -&gt; *mut ButtplugClientHandle {
    let c_str = unsafe { CStr::from_ptr(name) };
    let name_str = c_str.to_str().unwrap();
    
    let rt = tokio::runtime::Runtime::new().unwrap();
    let client = rt.block_on(async {
        ButtplugClient::new(name_str)
    });
    
    Box::into_raw(Box::new(ButtplugClientHandle {
        client: Box::new(client),
        runtime: rt,
    }))
}

#[no_mangle]
pub extern "C" fn buttplug_connect_in_process(handle: *mut ButtplugClientHandle) -&gt; i32 {
    if handle.is_null() { return -1; }
    
    let handle = unsafe { &amp;mut *handle };
    
    match handle.runtime.block_on(async {
        let connector = ButtplugInProcessClientConnector::default();
        handle.client.connect(connector).await
    }) {
        Ok(_) =&gt; 0,
        Err(_) =&gt; -1,
    }
}

#[no_mangle]
pub extern "C" fn buttplug_start_scanning(handle: *mut ButtplugClientHandle) -&gt; i32 {
    if handle.is_null() { return -1; }
    
    let handle = unsafe { &amp;mut *handle };
    
    match handle.runtime.block_on(async {
        handle.client.start_scanning().await
    }) {
        Ok(_) =&gt; 0,
        Err(_) =&gt; -1,
    }
}

#[no_mangle]
pub extern "C" fn buttplug_get_devices_json(handle: *mut ButtplugClientHandle) -&gt; *mut c_char {
    if handle.is_null() { return std::ptr::null_mut(); }
    
    let handle = unsafe { &amp;mut *handle };
    let devices = handle.client.devices();
    
    let devices_info: Vec&lt;_&gt; = devices.iter().map(|device| {
        serde_json::json!({
            "name": device.name(),
            "index": device.index(),
            "messages": device.allowed_messages().keys().collect::&lt;Vec&lt;_&gt;&gt;()
        })
    }).collect();
    
    let json_str = serde_json::to_string(&amp;devices_info).unwrap();
    CString::new(json_str).unwrap().into_raw()
}

#[no_mangle]
pub extern "C" fn buttplug_vibrate_device(
    handle: *mut ButtplugClientHandle,
    device_index: u32,
    intensity: f64
) -&gt; i32 {
    if handle.is_null() { return -1; }
    
    let handle = unsafe { &amp;mut *handle };
    
    let devices = handle.client.devices();
    if let Some(device) = devices.iter().find(|d| d.index() == device_index) {
        match handle.runtime.block_on(async {
            device.vibrate(&amp;buttplug::client::ScalarValueCommand::ScalarValue(intensity)).await
        }) {
            Ok(_) =&gt; 0,
            Err(_) =&gt; -1,
        }
    } else {
        -1
    }
}

#[no_mangle]
pub extern "C" fn buttplug_free_client(handle: *mut ButtplugClientHandle) {
    if !handle.is_null() {
        unsafe { Box::from_raw(handle) };
    }
}

#[no_mangle]
pub extern "C" fn buttplug_free_string(s: *mut c_char) {
    unsafe {
        if !s.is_null() {
            CString::from_raw(s);
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<h4 id="step-2-ç·¨è­¯å¤šå¹³å°åº«"><a class="header" href="#step-2-ç·¨è­¯å¤šå¹³å°åº«">Step 2: ç·¨è­¯å¤šå¹³å°åº«</a></h4>
<pre><code class="language-bash"># Android
rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android i686-linux-android

# iOS  
rustup target add aarch64-apple-ios x86_64-apple-ios aarch64-apple-ios-sim

# ç·¨è­¯ Android
export CC_aarch64_linux_android=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
cargo build --target aarch64-linux-android --release

# ç·¨è­¯ iOS
cargo build --target aarch64-apple-ios --release
</code></pre>
<h4 id="step-3-flutter-ffi-ç¶å®š"><a class="header" href="#step-3-flutter-ffi-ç¶å®š">Step 3: Flutter FFI ç¶å®š</a></h4>
<pre><code class="language-dart">// lib/buttplug_ffi.dart
import 'dart:ffi';
import 'dart:io';
import 'dart:convert';
import 'package:ffi/ffi.dart';

// C çµæ§‹é«”å’Œå‡½æ•¸å®šç¾©
typedef ButtplugClientHandle = Pointer&lt;Void&gt;;

typedef CreateClientC = ButtplugClientHandle Function(Pointer&lt;Utf8&gt;);
typedef CreateClient = ButtplugClientHandle Function(Pointer&lt;Utf8&gt;);

typedef ConnectInProcessC = Int32 Function(ButtplugClientHandle);
typedef ConnectInProcess = int Function(ButtplugClientHandle);

typedef StartScanningC = Int32 Function(ButtplugClientHandle);
typedef StartScanning = int Function(ButtplugClientHandle);

typedef GetDevicesJsonC = Pointer&lt;Utf8&gt; Function(ButtplugClientHandle);
typedef GetDevicesJson = Pointer&lt;Utf8&gt; Function(ButtplugClientHandle);

typedef VibrateDeviceC = Int32 Function(ButtplugClientHandle, Uint32, Double);
typedef VibrateDevice = int Function(ButtplugClientHandle, int, double);

typedef FreeClientC = Void Function(ButtplugClientHandle);
typedef FreeClient = void Function(ButtplugClientHandle);

typedef FreeStringC = Void Function(Pointer&lt;Utf8&gt;);
typedef FreeString = void Function(Pointer&lt;Utf8&gt;);

class ButtplugFFI {
  late DynamicLibrary _lib;
  late CreateClient _createClient;
  late ConnectInProcess _connectInProcess;
  late StartScanning _startScanning;
  late GetDevicesJson _getDevicesJson;
  late VibrateDevice _vibrateDevice;
  late FreeClient _freeClient;
  late FreeString _freeString;
  
  ButtplugClientHandle? _handle;

  ButtplugFFI() {
    // åŠ è¼‰å‹•æ…‹åº«
    if (Platform.isAndroid) {
      _lib = DynamicLibrary.open('libbuttplug_ffi.so');
    } else if (Platform.isIOS) {
      _lib = DynamicLibrary.process();
    } else {
      throw UnsupportedError('Unsupported platform');
    }
    
    // ç¶å®šå‡½æ•¸
    _createClient = _lib.lookupFunction&lt;CreateClientC, CreateClient&gt;('buttplug_create_client');
    _connectInProcess = _lib.lookupFunction&lt;ConnectInProcessC, ConnectInProcess&gt;('buttplug_connect_in_process');
    _startScanning = _lib.lookupFunction&lt;StartScanningC, StartScanning&gt;('buttplug_start_scanning');
    _getDevicesJson = _lib.lookupFunction&lt;GetDevicesJsonC, GetDevicesJson&gt;('buttplug_get_devices_json');
    _vibrateDevice = _lib.lookupFunction&lt;VibrateDeviceC, VibrateDevice&gt;('buttplug_vibrate_device');
    _freeClient = _lib.lookupFunction&lt;FreeClientC, FreeClient&gt;('buttplug_free_client');
    _freeString = _lib.lookupFunction&lt;FreeStringC, FreeString&gt;('buttplug_free_string');
  }

  Future&lt;bool&gt; createClient(String name) async {
    final namePtr = name.toNativeUtf8();
    _handle = _createClient(namePtr);
    malloc.free(namePtr);
    return _handle != nullptr;
  }

  Future&lt;bool&gt; connectInProcess() async {
    if (_handle == null) return false;
    return _connectInProcess(_handle!) == 0;
  }

  Future&lt;bool&gt; startScanning() async {
    if (_handle == null) return false;
    return _startScanning(_handle!) == 0;
  }

  Future&lt;List&lt;Map&lt;String, dynamic&gt;&gt;&gt; getDevices() async {
    if (_handle == null) return [];
    
    final jsonPtr = _getDevicesJson(_handle!);
    if (jsonPtr == nullptr) return [];
    
    final jsonStr = jsonPtr.toDartString();
    _freeString(jsonPtr);
    
    final List&lt;dynamic&gt; devices = jsonDecode(jsonStr);
    return devices.cast&lt;Map&lt;String, dynamic&gt;&gt;();
  }

  Future&lt;bool&gt; vibrateDevice(int deviceIndex, double intensity) async {
    if (_handle == null) return false;
    return _vibrateDevice(_handle!, deviceIndex, intensity) == 0;
  }

  void dispose() {
    if (_handle != null) {
      _freeClient(_handle!);
      _handle = null;
    }
  }
}

// é«˜ç´šå°è£
class ButtplugClient {
  final ButtplugFFI _ffi = ButtplugFFI();
  final String name;
  
  ButtplugClient(this.name);

  Future&lt;void&gt; connect() async {
    await _ffi.createClient(name);
    await _ffi.connectInProcess();
  }

  Future&lt;void&gt; startScanning() async {
    await _ffi.startScanning();
  }

  Future&lt;List&lt;ButtplugDevice&gt;&gt; getDevices() async {
    final deviceData = await _ffi.getDevices();
    return deviceData.map((data) =&gt; ButtplugDevice.fromJson(data)).toList();
  }

  void dispose() {
    _ffi.dispose();
  }
}

class ButtplugDevice {
  final String name;
  final int index;
  final List&lt;String&gt; supportedMessages;

  ButtplugDevice({
    required this.name,
    required this.index,
    required this.supportedMessages,
  });

  factory ButtplugDevice.fromJson(Map&lt;String, dynamic&gt; json) {
    return ButtplugDevice(
      name: json['name'],
      index: json['index'],
      supportedMessages: List&lt;String&gt;.from(json['messages']),
    );
  }

  Future&lt;void&gt; vibrate(double intensity) async {
    if (supportedMessages.contains('ScalarCmd')) {
      // é€éå…¨åŸŸ FFI å¯¦ä¾‹èª¿ç”¨
      // é€™è£¡éœ€è¦é‡æ§‹ä»¥æ”¯æ´è¨­å‚™ç´šæ“ä½œ
    }
  }
}
</code></pre>
<h4 id="step-4-flutter-ä½¿ç”¨ç¯„ä¾‹"><a class="header" href="#step-4-flutter-ä½¿ç”¨ç¯„ä¾‹">Step 4: Flutter ä½¿ç”¨ç¯„ä¾‹</a></h4>
<pre><code class="language-dart">// lib/main.dart
import 'package:flutter/material.dart';
import 'buttplug_ffi.dart';

class ButtplugFFIDemo extends StatefulWidget {
  @override
  _ButtplugFFIDemoState createState() =&gt; _ButtplugFFIDemoState();
}

class _ButtplugFFIDemoState extends State&lt;ButtplugFFIDemo&gt; {
  late ButtplugClient _client;
  List&lt;ButtplugDevice&gt; _devices = [];
  bool _isConnected = false;
  String _status = 'Disconnected';

  @override
  void initState() {
    super.initState();
    _client = ButtplugClient('Flutter FFI Demo');
  }

  Future&lt;void&gt; _connect() async {
    try {
      await _client.connect();
      setState(() {
        _isConnected = true;
        _status = 'Connected';
      });
    } catch (e) {
      setState(() =&gt; _status = 'Connection failed: $e');
    }
  }

  Future&lt;void&gt; _startScanning() async {
    if (!_isConnected) return;
    
    try {
      await _client.startScanning();
      
      // å®šæœŸæ›´æ–°è¨­å‚™åˆ—è¡¨
      Timer.periodic(Duration(seconds: 1), (timer) async {
        final devices = await _client.getDevices();
        setState(() =&gt; _devices = devices);
        
        if (_devices.isNotEmpty) {
          timer.cancel();
          setState(() =&gt; _status = 'Found ${_devices.length} devices');
        }
      });
    } catch (e) {
      setState(() =&gt; _status = 'Scanning failed: $e');
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Buttplug FFI Demo')),
      body: Column(
        children: [
          Card(
            child: Padding(
              padding: EdgeInsets.all(16),
              child: Column(
                children: [
                  Text('Status: $_status'),
                  SizedBox(height: 16),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                    children: [
                      ElevatedButton(
                        onPressed: _isConnected ? null : _connect,
                        child: Text('Connect'),
                      ),
                      ElevatedButton(
                        onPressed: _isConnected ? _startScanning : null,
                        child: Text('Scan'),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
          Expanded(
            child: ListView.builder(
              itemCount: _devices.length,
              itemBuilder: (context, index) {
                final device = _devices[index];
                return ListTile(
                  title: Text(device.name),
                  subtitle: Text('Messages: ${device.supportedMessages.join(', ')}'),
                  trailing: device.supportedMessages.contains('ScalarCmd')
                    ? Slider(
                        value: 0.0,
                        onChanged: (value) async {
                          await device.vibrate(value);
                        },
                      )
                    : null,
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _client.dispose();
    super.dispose();
  }
}
</code></pre>
<hr />
<h2 id="æ–¹æ¡ˆ-3-flutter_rust_bridge-æ¨è–¦ç”¨æ–¼è¤‡é›œæ•´åˆ"><a class="header" href="#æ–¹æ¡ˆ-3-flutter_rust_bridge-æ¨è–¦ç”¨æ–¼è¤‡é›œæ•´åˆ">æ–¹æ¡ˆ 3: flutter_rust_bridge (æ¨è–¦ç”¨æ–¼è¤‡é›œæ•´åˆ)</a></h2>
<h3 id="æ¦‚è¿°-2"><a class="header" href="#æ¦‚è¿°-2">æ¦‚è¿°</a></h3>
<p>ä½¿ç”¨ <code>flutter_rust_bridge</code> è‡ªå‹•ç”Ÿæˆ Dart-Rust ç¶å®šã€‚</p>
<h3 id="å¯¦ç¾æ­¥é©Ÿ-1"><a class="header" href="#å¯¦ç¾æ­¥é©Ÿ-1">å¯¦ç¾æ­¥é©Ÿ</a></h3>
<h4 id="step-1-æ·»åŠ ä¾è³´"><a class="header" href="#step-1-æ·»åŠ ä¾è³´">Step 1: æ·»åŠ ä¾è³´</a></h4>
<pre><code class="language-yaml"># pubspec.yaml
dependencies:
  flutter_rust_bridge: ^1.82.1

dev_dependencies:
  flutter_rust_bridge_codegen: ^1.82.1
  ffigen: ^9.0.1
</code></pre>
<h4 id="step-2-rust-api-å®šç¾©"><a class="header" href="#step-2-rust-api-å®šç¾©">Step 2: Rust API å®šç¾©</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// native/src/api.rs
use buttplug::client::{ButtplugClient, ButtplugClientEvent};
use buttplug::core::connector::ButtplugInProcessClientConnector;
use std::sync::Arc;
use tokio::sync::Mutex;

pub struct ButtplugClientWrapper {
    client: Arc&lt;Mutex&lt;ButtplugClient&gt;&gt;,
    runtime: tokio::runtime::Runtime,
}

impl ButtplugClientWrapper {
    pub fn new(name: String) -&gt; Self {
        let rt = tokio::runtime::Runtime::new().unwrap();
        let client = rt.block_on(async { ButtplugClient::new(&amp;name) });
        
        Self {
            client: Arc::new(Mutex::new(client)),
            runtime: rt,
        }
    }

    pub fn connect_in_process(&amp;self) -&gt; Result&lt;(), String&gt; {
        self.runtime.block_on(async {
            let connector = ButtplugInProcessClientConnector::default();
            self.client.lock().await.connect(connector).await
                .map_err(|e| e.to_string())
        })
    }

    pub fn start_scanning(&amp;self) -&gt; Result&lt;(), String&gt; {
        self.runtime.block_on(async {
            self.client.lock().await.start_scanning().await
                .map_err(|e| e.to_string())
        })
    }

    pub fn get_device_info(&amp;self) -&gt; Vec&lt;DeviceInfo&gt; {
        self.runtime.block_on(async {
            let client = self.client.lock().await;
            client.devices()
                .iter()
                .map(|device| DeviceInfo {
                    name: device.name().to_string(),
                    index: device.index(),
                    supported_messages: device.allowed_messages().keys()
                        .map(|k| k.to_string()).collect(),
                })
                .collect()
        })
    }

    pub fn vibrate_device(&amp;self, device_index: u32, intensity: f64) -&gt; Result&lt;(), String&gt; {
        self.runtime.block_on(async {
            let client = self.client.lock().await;
            if let Some(device) = client.devices().iter().find(|d| d.index() == device_index) {
                use buttplug::client::ScalarValueCommand;
                device.vibrate(&amp;ScalarValueCommand::ScalarValue(intensity)).await
                    .map_err(|e| e.to_string())
            } else {
                Err("Device not found".to_string())
            }
        })
    }
}

#[derive(Clone)]
pub struct DeviceInfo {
    pub name: String,
    pub index: u32,
    pub supported_messages: Vec&lt;String&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h4 id="step-3-ç”Ÿæˆç¶å®š"><a class="header" href="#step-3-ç”Ÿæˆç¶å®š">Step 3: ç”Ÿæˆç¶å®š</a></h4>
<pre><code class="language-bash"># ç”Ÿæˆ Dart ç¶å®š
flutter packages get
flutter_rust_bridge_codegen \
    --rust-input native/src/api.rs \
    --dart-output lib/bridge_generated.dart
</code></pre>
<h4 id="step-4-flutter-ä½¿ç”¨"><a class="header" href="#step-4-flutter-ä½¿ç”¨">Step 4: Flutter ä½¿ç”¨</a></h4>
<pre><code class="language-dart">// lib/buttplug_bridge.dart
import 'bridge_generated.dart';
import 'bridge_definitions.dart';

class ButtplugBridge {
  static const _base = 'buttplug_bridge';
  late final ButtplugBridgeImpl _impl;
  ButtplugClientWrapper? _client;

  ButtplugBridge._() {
    _impl = ButtplugBridgeImpl.init(ExternalLibrary.open(_getLibraryPath()));
  }

  static ButtplugBridge? _instance;
  static ButtplugBridge get instance {
    _instance ??= ButtplugBridge._();
    return _instance!;
  }

  String _getLibraryPath() {
    if (Platform.isAndroid) {
      return 'lib$_base.so';
    } else if (Platform.isIOS) {
      return '$_base.framework/$_base';
    } else {
      throw UnsupportedError('Unsupported platform');
    }
  }

  Future&lt;void&gt; createClient(String name) async {
    _client = await _impl.buttplugClientWrapperNew(name: name);
  }

  Future&lt;void&gt; connectInProcess() async {
    if (_client == null) throw Exception('Client not created');
    await _impl.buttplugClientWrapperConnectInProcess(that: _client!);
  }

  Future&lt;void&gt; startScanning() async {
    if (_client == null) throw Exception('Client not created');
    await _impl.buttplugClientWrapperStartScanning(that: _client!);
  }

  Future&lt;List&lt;DeviceInfo&gt;&gt; getDevices() async {
    if (_client == null) throw Exception('Client not created');
    return await _impl.buttplugClientWrapperGetDeviceInfo(that: _client!);
  }

  Future&lt;void&gt; vibrateDevice(int deviceIndex, double intensity) async {
    if (_client == null) throw Exception('Client not created');
    await _impl.buttplugClientWrapperVibrateDevice(
      that: _client!,
      deviceIndex: deviceIndex,
      intensity: intensity,
    );
  }
}
</code></pre>
<hr />
<h2 id="æ–¹æ¡ˆ-4-webassembly-web-ç‰¹åŒ–"><a class="header" href="#æ–¹æ¡ˆ-4-webassembly-web-ç‰¹åŒ–">æ–¹æ¡ˆ 4: WebAssembly (Web ç‰¹åŒ–)</a></h2>
<h3 id="æ¦‚è¿°-3"><a class="header" href="#æ¦‚è¿°-3">æ¦‚è¿°</a></h3>
<p>å°‡ Rust ç·¨è­¯ç‚º WebAssemblyï¼Œåœ¨ Flutter Web ä¸­ä½¿ç”¨ã€‚</p>
<h3 id="å¯¦ç¾æ­¥é©Ÿ-2"><a class="header" href="#å¯¦ç¾æ­¥é©Ÿ-2">å¯¦ç¾æ­¥é©Ÿ</a></h3>
<h4 id="step-1-æº–å‚™-wasm-åº«"><a class="header" href="#step-1-æº–å‚™-wasm-åº«">Step 1: æº–å‚™ WASM åº«</a></h4>
<pre><code class="language-toml"># Cargo.toml
[lib]
crate-type = ["cdylib"]

[dependencies]
buttplug = "8.5"
wasm-bindgen = "0.2"
js-sys = "0.3"
wee_alloc = "0.4"

[dependencies.web-sys]
version = "0.3"
features = [
  "console",
  "Navigator",
  "Bluetooth",
  "BluetoothDevice",
]
</code></pre>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// src/lib.rs
use wasm_bindgen::prelude::*;
use buttplug::client::{ButtplugClient, ButtplugClientEvent};

#[wasm_bindgen]
extern "C" {
    #[wasm_bindgen(js_namespace = console)]
    fn log(s: &amp;str);
}

macro_rules! console_log {
    ($($t:tt)*) =&gt; (log(&amp;format_args!($($t)*).to_string()))
}

#[wasm_bindgen]
pub struct ButtplugWASM {
    client: Option&lt;ButtplugClient&gt;,
}

#[wasm_bindgen]
impl ButtplugWASM {
    #[wasm_bindgen(constructor)]
    pub fn new() -&gt; Self {
        console_log!("Creating new ButtplugWASM instance");
        Self { client: None }
    }

    #[wasm_bindgen]
    pub async fn create_client(&amp;mut self, name: &amp;str) -&gt; Result&lt;(), JsValue&gt; {
        self.client = Some(ButtplugClient::new(name));
        Ok(())
    }

    #[wasm_bindgen]
    pub async fn connect_websocket(&amp;mut self, address: &amp;str) -&gt; Result&lt;(), JsValue&gt; {
        if let Some(client) = &amp;self.client {
            let connector = buttplug::client::ButtplugWebsocketClientConnector::new_insecure_connector(address);
            client.connect(connector).await.map_err(|e| JsValue::from_str(&amp;e.to_string()))?;
        }
        Ok(())
    }

    #[wasm_bindgen]
    pub async fn start_scanning(&amp;self) -&gt; Result&lt;(), JsValue&gt; {
        if let Some(client) = &amp;self.client {
            client.start_scanning().await.map_err(|e| JsValue::from_str(&amp;e.to_string()))?;
        }
        Ok(())
    }

    #[wasm_bindgen]
    pub fn get_devices(&amp;self) -&gt; String {
        if let Some(client) = &amp;self.client {
            let devices: Vec&lt;_&gt; = client.devices().iter().map(|device| {
                serde_json::json!({
                    "name": device.name(),
                    "index": device.index(),
                })
            }).collect();
            serde_json::to_string(&amp;devices).unwrap()
        } else {
            "[]".to_string()
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<h4 id="step-2-ç·¨è­¯-wasm"><a class="header" href="#step-2-ç·¨è­¯-wasm">Step 2: ç·¨è­¯ WASM</a></h4>
<pre><code class="language-bash"># å®‰è£ wasm-pack
curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

# ç·¨è­¯ç‚º WASM
wasm-pack build --target web --out-dir ../web/pkg
</code></pre>
<h4 id="step-3-flutter-web-æ•´åˆ"><a class="header" href="#step-3-flutter-web-æ•´åˆ">Step 3: Flutter Web æ•´åˆ</a></h4>
<pre><code class="language-dart">// lib/buttplug_wasm.dart
@JS()
library buttplug_wasm;

import 'package:js/js.dart';
import 'dart:html' as html;

@JS('ButtplugWASM')
class ButtplugWASMJS {
  external ButtplugWASMJS();
  external Future&lt;void&gt; create_client(String name);
  external Future&lt;void&gt; connect_websocket(String address);
  external Future&lt;void&gt; start_scanning();
  external String get_devices();
}

class ButtplugWASM {
  late ButtplugWASMJS _wasm;
  
  Future&lt;void&gt; initialize() async {
    // è¼‰å…¥ WASM æ¨¡çµ„
    final script = html.ScriptElement()
      ..src = 'pkg/buttplug_wasm.js'
      ..type = 'module';
    html.document.head!.append(script);
    
    await Future.delayed(Duration(milliseconds: 500)); // ç­‰å¾…è¼‰å…¥
    _wasm = ButtplugWASMJS();
  }

  Future&lt;void&gt; createClient(String name) async {
    await _wasm.create_client(name);
  }

  Future&lt;void&gt; connectWebsocket(String address) async {
    await _wasm.connect_websocket(address);
  }

  Future&lt;void&gt; startScanning() async {
    await _wasm.start_scanning();
  }

  List&lt;Map&lt;String, dynamic&gt;&gt; getDevices() {
    final jsonStr = _wasm.get_devices();
    return List&lt;Map&lt;String, dynamic&gt;&gt;.from(jsonDecode(jsonStr));
  }
}
</code></pre>
<hr />
<h2 id="æ–¹æ¡ˆ-5-platform-channel"><a class="header" href="#æ–¹æ¡ˆ-5-platform-channel">æ–¹æ¡ˆ 5: Platform Channel</a></h2>
<h3 id="æ¦‚è¿°-4"><a class="header" href="#æ¦‚è¿°-4">æ¦‚è¿°</a></h3>
<p>é€é Platform Channel èˆ‡åŸç”Ÿ Android/iOS ä»£ç¢¼é€šè¨Šã€‚</p>
<h3 id="android-å¯¦ç¾"><a class="header" href="#android-å¯¦ç¾">Android å¯¦ç¾</a></h3>
<pre><code class="language-kotlin">// android/app/src/main/kotlin/MainActivity.kt
class MainActivity: FlutterActivity() {
    private val CHANNEL = "buttplug_channel"

    override fun configureFlutterEngine(@NonNull flutterEngine: FlutterEngine) {
        super.configureFlutterEngine(flutterEngine)
        
        MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL).setMethodCallHandler { call, result -&gt;
            when (call.method) {
                "createClient" -&gt; {
                    val name = call.argument&lt;String&gt;("name")
                    // èª¿ç”¨ JNI æ¥å£åˆ° Rust
                    result.success(true)
                }
                "connectInProcess" -&gt; {
                    // JNI èª¿ç”¨
                    result.success(true)
                }
                else -&gt; result.notImplemented()
            }
        }
    }

    // JNI è²æ˜
    external fun nativeCreateClient(name: String): Long
    external fun nativeConnectInProcess(handle: Long): Boolean
    
    companion object {
        init {
            System.loadLibrary("buttplug_jni")
        }
    }
}
</code></pre>
<h3 id="flutter-platform-channel-ä½¿ç”¨"><a class="header" href="#flutter-platform-channel-ä½¿ç”¨">Flutter Platform Channel ä½¿ç”¨</a></h3>
<pre><code class="language-dart">// lib/buttplug_platform.dart
import 'package:flutter/services.dart';

class ButtplugPlatform {
  static const MethodChannel _channel = MethodChannel('buttplug_channel');

  static Future&lt;bool&gt; createClient(String name) async {
    try {
      final result = await _channel.invokeMethod('createClient', {'name': name});
      return result as bool;
    } on PlatformException catch (e) {
      print("Failed to create client: '${e.message}'");
      return false;
    }
  }

  static Future&lt;bool&gt; connectInProcess() async {
    try {
      final result = await _channel.invokeMethod('connectInProcess');
      return result as bool;
    } on PlatformException catch (e) {
      print("Failed to connect: '${e.message}'");
      return false;
    }
  }

  static Future&lt;bool&gt; startScanning() async {
    try {
      final result = await _channel.invokeMethod('startScanning');
      return result as bool;
    } on PlatformException catch (e) {
      print("Failed to start scanning: '${e.message}'");
      return false;
    }
  }

  static Future&lt;List&lt;Map&lt;String, dynamic&gt;&gt;&gt; getDevices() async {
    try {
      final result = await _channel.invokeMethod('getDevices');
      return List&lt;Map&lt;String, dynamic&gt;&gt;.from(result);
    } on PlatformException catch (e) {
      print("Failed to get devices: '${e.message}'");
      return [];
    }
  }
}
</code></pre>
<hr />
<h2 id="å»ºæ§‹é…ç½®æŒ‡å—"><a class="header" href="#å»ºæ§‹é…ç½®æŒ‡å—">å»ºæ§‹é…ç½®æŒ‡å—</a></h2>
<h3 id="android-é…ç½®"><a class="header" href="#android-é…ç½®">Android é…ç½®</a></h3>
<h4 id="ndk-è¨­å®š"><a class="header" href="#ndk-è¨­å®š">NDK è¨­å®š</a></h4>
<pre><code class="language-gradle">// android/app/build.gradle
android {
    compileSdkVersion 34
    ndkVersion "25.1.8937393"
    
    defaultConfig {
        ndk {
            abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86_64'
        }
    }
    
    externalNativeBuild {
        cmake {
            path "../native/CMakeLists.txt"
        }
    }
}
</code></pre>
<h4 id="cmake-é…ç½®"><a class="header" href="#cmake-é…ç½®">CMake é…ç½®</a></h4>
<pre><code class="language-cmake"># native/CMakeLists.txt
cmake_minimum_required(VERSION 3.10)
project(buttplug_ffi)

set(CMAKE_CXX_STANDARD 17)

# æ·»åŠ  Rust åº«
add_library(buttplug_rust SHARED IMPORTED)
set_target_properties(buttplug_rust PROPERTIES
    IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/target/${ANDROID_ABI}/release/libbuttplug_ffi.so
)

# å‰µå»ºåŒ…è£åº«
add_library(buttplug_ffi SHARED
    src/android_wrapper.cpp
)

target_link_libraries(buttplug_ffi buttplug_rust)
</code></pre>
<h3 id="ios-é…ç½®"><a class="header" href="#ios-é…ç½®">iOS é…ç½®</a></h3>
<h4 id="xcode-å°ˆæ¡ˆè¨­å®š"><a class="header" href="#xcode-å°ˆæ¡ˆè¨­å®š">Xcode å°ˆæ¡ˆè¨­å®š</a></h4>
<pre><code class="language-ruby"># ios/Podfile
platform :ios, '11.0'

target 'Runner' do
  use_frameworks!
  use_modular_headers!

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  
  # æ·»åŠ  Rust éœæ…‹åº«
  pod 'buttplug_ffi', :path =&gt; '../native/ios'
end
</code></pre>
<h4 id="framework-é…ç½®"><a class="header" href="#framework-é…ç½®">Framework é…ç½®</a></h4>
<pre><code class="language-ruby"># native/ios/buttplug_ffi.podspec
Pod::Spec.new do |spec|
  spec.name          = 'buttplug_ffi'
  spec.version       = '0.1.0'
  spec.summary       = 'Buttplug FFI for iOS'
  
  spec.source_files = 'Classes/**/*'
  spec.public_header_files = 'Classes/**/*.h'
  
  spec.ios.deployment_target = '11.0'
  
  # éœæ…‹åº«é€£çµ
  spec.vendored_libraries = 'lib/libbuttplug_ffi.a'
  spec.libraries = 'buttplug_ffi'
end
</code></pre>
<hr />
<h2 id="æ•ˆèƒ½èˆ‡å¤§å°æ¯”è¼ƒ"><a class="header" href="#æ•ˆèƒ½èˆ‡å¤§å°æ¯”è¼ƒ">æ•ˆèƒ½èˆ‡å¤§å°æ¯”è¼ƒ</a></h2>
<h3 id="æª”æ¡ˆå¤§å°å½±éŸ¿"><a class="header" href="#æª”æ¡ˆå¤§å°å½±éŸ¿">æª”æ¡ˆå¤§å°å½±éŸ¿</a></h3>
<div class="table-wrapper"><table><thead><tr><th>æ–¹æ¡ˆ</th><th>Android APK å¢åŠ </th><th>iOS IPA å¢åŠ </th><th>ç¸½é«”å¤§å°</th></tr></thead><tbody>
<tr><td><strong>Dart å¥—ä»¶</strong></td><td>+2MB</td><td>+2MB</td><td>~32MB</td></tr>
<tr><td><strong>FFI ç›´æ¥</strong></td><td>+45MB</td><td>+60MB</td><td>~120MB</td></tr>
<tr><td><strong>flutter_rust_bridge</strong></td><td>+40MB</td><td>+55MB</td><td>~110MB</td></tr>
<tr><td><strong>WASM (Web only)</strong></td><td>N/A</td><td>N/A</td><td>~15MB</td></tr>
<tr><td><strong>Platform Channel</strong></td><td>+45MB</td><td>+60MB</td><td>~120MB</td></tr>
</tbody></table>
</div>
<h3 id="æ•ˆèƒ½æ¯”è¼ƒ"><a class="header" href="#æ•ˆèƒ½æ¯”è¼ƒ">æ•ˆèƒ½æ¯”è¼ƒ</a></h3>
<div class="table-wrapper"><table><thead><tr><th>æ–¹æ¡ˆ</th><th>å•Ÿå‹•æ™‚é–“</th><th>è¨˜æ†¶é«”ä½¿ç”¨</th><th>CPU ä½¿ç”¨</th><th>ç¶²è·¯å»¶é²</th></tr></thead><tbody>
<tr><td><strong>Dart å¥—ä»¶</strong></td><td>å¿«</td><td>ä½</td><td>ä½</td><td>æœ‰ (WebSocket)</td></tr>
<tr><td><strong>FFI ç›´æ¥</strong></td><td>æ…¢</td><td>ä¸­</td><td>ä¸­</td><td>ç„¡</td></tr>
<tr><td><strong>flutter_rust_bridge</strong></td><td>æ…¢</td><td>ä¸­</td><td>ä¸­</td><td>ç„¡</td></tr>
<tr><td><strong>WASM</strong></td><td>ä¸­</td><td>ä¸­</td><td>ä¸­</td><td>æœ‰</td></tr>
<tr><td><strong>Platform Channel</strong></td><td>æ…¢</td><td>é«˜</td><td>ä¸­</td><td>ç„¡</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="é–‹ç™¼è¤‡é›œåº¦åˆ†æ"><a class="header" href="#é–‹ç™¼è¤‡é›œåº¦åˆ†æ">é–‹ç™¼è¤‡é›œåº¦åˆ†æ</a></h2>
<h3 id="å­¸ç¿’æ›²ç·š"><a class="header" href="#å­¸ç¿’æ›²ç·š">å­¸ç¿’æ›²ç·š</a></h3>
<pre class="mermaid">graph TB
    A[Dart å¥—ä»¶] --&gt; B[Easy]
    C[flutter_rust_bridge] --&gt; D[Medium]
    E[WASM] --&gt; F[Medium]
    G[FFI ç›´æ¥] --&gt; H[Hard]
    I[Platform Channel] --&gt; J[Hard]
</pre>
<h3 id="ç¶­è­·æˆæœ¬"><a class="header" href="#ç¶­è­·æˆæœ¬">ç¶­è­·æˆæœ¬</a></h3>
<div class="table-wrapper"><table><thead><tr><th>æ–¹æ¡ˆ</th><th>åˆå§‹é–‹ç™¼</th><th>ç‰ˆæœ¬æ›´æ–°</th><th>Bug ä¿®å¾©</th><th>å¹³å°ç§»æ¤</th></tr></thead><tbody>
<tr><td><strong>Dart å¥—ä»¶</strong></td><td>1å¤©</td><td>ç°¡å–®</td><td>ç°¡å–®</td><td>è‡ªå‹•</td></tr>
<tr><td><strong>flutter_rust_bridge</strong></td><td>1é€±</td><td>ä¸­ç­‰</td><td>ä¸­ç­‰</td><td>æ‰‹å‹•</td></tr>
<tr><td><strong>WASM</strong></td><td>3å¤©</td><td>ä¸­ç­‰</td><td>å›°é›£</td><td>Web Only</td></tr>
<tr><td><strong>FFI ç›´æ¥</strong></td><td>2é€±</td><td>å›°é›£</td><td>å›°é›£</td><td>æ‰‹å‹•</td></tr>
<tr><td><strong>Platform Channel</strong></td><td>3é€±</td><td>å›°é›£</td><td>å›°é›£</td><td>æ‰‹å‹•</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="æ¨è–¦æ±ºç­–æ¨¹"><a class="header" href="#æ¨è–¦æ±ºç­–æ¨¹">æ¨è–¦æ±ºç­–æ¨¹</a></h2>
<pre class="mermaid">flowchart TD
    A[éœ€è¦ Buttplug Rust æ•´åˆ] --&gt; B{æ˜¯å¦å¯æ¥å—å¤–éƒ¨ä¾è³´?}
    B --&gt;|æ˜¯| C[ä½¿ç”¨ Dart buttplug å¥—ä»¶ â­â­â­â­â­]
    B --&gt;|å¦| D{ä¸»è¦å¹³å°?}
    D --&gt;|Web| E[ä½¿ç”¨ WASM â­â­â­]
    D --&gt;|Mobile| F{é–‹ç™¼è³‡æºå……è¶³?}
    F --&gt;|æ˜¯| G[ä½¿ç”¨ flutter_rust_bridge â­â­â­]
    F --&gt;|å¦| H[é‡æ–°è€ƒæ…®å¤–éƒ¨ä¾è³´]
    D --&gt;|è·¨å¹³å°| I{éœ€è¦æœ€é«˜æ€§èƒ½?}
    I --&gt;|æ˜¯| J[FFI ç›´æ¥èª¿ç”¨ â­â­]
    I --&gt;|å¦| K[flutter_rust_bridge â­â­â­]
</pre>
<hr />
<h2 id="æœ€ä½³å¯¦è¸å»ºè­°"><a class="header" href="#æœ€ä½³å¯¦è¸å»ºè­°">æœ€ä½³å¯¦è¸å»ºè­°</a></h2>
<h3 id="1-å„ªå…ˆé¸æ“‡ç°¡å–®æ–¹æ¡ˆ"><a class="header" href="#1-å„ªå…ˆé¸æ“‡ç°¡å–®æ–¹æ¡ˆ">1. å„ªå…ˆé¸æ“‡ç°¡å–®æ–¹æ¡ˆ</a></h3>
<ul>
<li>âœ… é™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå„ªå…ˆä½¿ç”¨ Dart buttplug å¥—ä»¶</li>
<li>âœ… å¤–éƒ¨ä¾è³´é€šå¸¸æ¯”å…§åµŒè¤‡é›œåº¦æ›´å¯æ¥å—</li>
<li>âœ… å®˜æ–¹ç¶­è­·çš„è§£æ±ºæ–¹æ¡ˆæ›´å¯é </li>
</ul>
<h3 id="2-å¦‚æœå¿…é ˆæ•´åˆ-rust"><a class="header" href="#2-å¦‚æœå¿…é ˆæ•´åˆ-rust">2. å¦‚æœå¿…é ˆæ•´åˆ Rust</a></h3>
<pre><code class="language-dart">// ä½¿ç”¨æŠ½è±¡ä»‹é¢éš”é›¢è¤‡é›œæ€§
abstract class ButtplugInterface {
  Future&lt;void&gt; connect();
  Future&lt;void&gt; startScanning();
  Future&lt;List&lt;Device&gt;&gt; getDevices();
}

// å¯¦ç¾å¯ä»¥æ˜¯ FFIã€Bridge æˆ–å…¶ä»–æ–¹æ¡ˆ
class ButtplugFFIImpl implements ButtplugInterface {
  // FFI å¯¦ç¾
}

class ButtplugBridgeImpl implements ButtplugInterface {
  // flutter_rust_bridge å¯¦ç¾
}
</code></pre>
<h3 id="3-éŒ¯èª¤è™•ç†å’Œæ—¥èªŒ"><a class="header" href="#3-éŒ¯èª¤è™•ç†å’Œæ—¥èªŒ">3. éŒ¯èª¤è™•ç†å’Œæ—¥èªŒ</a></h3>
<pre><code class="language-dart">class ButtplugErrorHandler {
  static void handleFFIError(dynamic error) {
    if (error is String &amp;&amp; error.contains('Bluetooth')) {
      // è™•ç†è—ç‰™ç›¸é—œéŒ¯èª¤
      showBluetoothErrorDialog();
    } else if (error.toString().contains('Permission')) {
      // è™•ç†æ¬Šé™éŒ¯èª¤
      requestPermissions();
    }
    
    // è¨˜éŒ„éŒ¯èª¤ä»¥ä¾›é™¤éŒ¯
    FirebaseCrashlytics.instance.recordError(error, null);
  }
}
</code></pre>
<h3 id="4-æ•ˆèƒ½å„ªåŒ–"><a class="header" href="#4-æ•ˆèƒ½å„ªåŒ–">4. æ•ˆèƒ½å„ªåŒ–</a></h3>
<pre><code class="language-dart">// ä½¿ç”¨ Isolate é¿å…é˜»å¡ UI
class ButtplugIsolate {
  static Future&lt;T&gt; runInIsolate&lt;T&gt;(Future&lt;T&gt; Function() operation) async {
    return await Isolate.run(operation);
  }
}

// å¯¦éš›ä½¿ç”¨
final devices = await ButtplugIsolate.runInIsolate(() async {
  return await buttplugClient.getDevices();
});
</code></pre>
<h3 id="5-è¨˜æ†¶é«”ç®¡ç†"><a class="header" href="#5-è¨˜æ†¶é«”ç®¡ç†">5. è¨˜æ†¶é«”ç®¡ç†</a></h3>
<pre><code class="language-dart">class ButtplugLifecycleManager with WidgetsBindingObserver {
  ButtplugClient? _client;
  
  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    switch (state) {
      case AppLifecycleState.paused:
        _client?.disconnect();
        break;
      case AppLifecycleState.resumed:
        _reconnectIfNeeded();
        break;
      default:
        break;
    }
  }
  
  void dispose() {
    _client?.dispose();
    WidgetsBinding.instance.removeObserver(this);
  }
}
</code></pre>
<hr />
<h2 id="ç¸½çµ"><a class="header" href="#ç¸½çµ">ç¸½çµ</a></h2>
<h3 id="æ¨è–¦æ–¹æ¡ˆæ’åº"><a class="header" href="#æ¨è–¦æ–¹æ¡ˆæ’åº">æ¨è–¦æ–¹æ¡ˆæ’åº</a></h3>
<ol>
<li>
<p><strong>ğŸ¥‡ Dart buttplug å¥—ä»¶ + Intiface Central</strong></p>
<ul>
<li>æœ€ç°¡å–®ã€æœ€ç©©å®šçš„æ–¹æ¡ˆ</li>
<li>å®˜æ–¹ç¶­è­·ï¼Œæ›´æ–°åŠæ™‚</li>
<li>é©åˆ 95% çš„ä½¿ç”¨æ¡ˆä¾‹</li>
</ul>
</li>
<li>
<p><strong>ğŸ¥ˆ flutter_rust_bridge</strong></p>
<ul>
<li>é©åˆéœ€è¦å®Œå…¨æ§åˆ¶çš„é€²éšç”¨æˆ¶</li>
<li>è‡ªå‹•åŒ–ç¨‹åº¦é«˜ï¼Œæ¸›å°‘æ‰‹å‹• FFI å·¥ä½œ</li>
<li>éœ€è¦ä¸€å®šçš„ Rust çŸ¥è­˜</li>
</ul>
</li>
<li>
<p><strong>ğŸ¥‰ WebAssembly (Web é™å®š)</strong></p>
<ul>
<li>Web å¹³å°çš„æœ€ä½³é¸æ“‡</li>
<li>æ•ˆèƒ½å’Œæª”æ¡ˆå¤§å°å¹³è¡¡</li>
<li>åªé©ç”¨æ–¼ Flutter Web</li>
</ul>
</li>
<li>
<p><strong>FFI ç›´æ¥èª¿ç”¨</strong></p>
<ul>
<li>æœ€å¤§éˆæ´»æ€§ï¼Œä½†è¤‡é›œåº¦æ¥µé«˜</li>
<li>åªæœ‰åœ¨å…¶ä»–æ–¹æ¡ˆç„¡æ³•æ»¿è¶³éœ€æ±‚æ™‚è€ƒæ…®</li>
<li>éœ€è¦æ·±åšçš„ç³»çµ±ç¨‹å¼è¨­è¨ˆçŸ¥è­˜</li>
</ul>
</li>
<li>
<p><strong>Platform Channel</strong></p>
<ul>
<li>å‚³çµ±æ–¹æ¡ˆï¼Œä½†é–‹ç™¼æˆæœ¬æœ€é«˜</li>
<li>éœ€è¦ç¶­è­·å¤šå¥—åŸç”Ÿç¨‹å¼ç¢¼</li>
<li>ä¸æ¨è–¦ç”¨æ–¼æ–°å°ˆæ¡ˆ</li>
</ul>
</li>
</ol>
<h3 id="æœ€çµ‚å»ºè­°"><a class="header" href="#æœ€çµ‚å»ºè­°">æœ€çµ‚å»ºè­°</a></h3>
<p>å°æ–¼å¤§å¤šæ•¸é–‹ç™¼è€…ï¼Œ<strong>å¼·çƒˆå»ºè­°ä½¿ç”¨ Dart buttplug å¥—ä»¶</strong>ã€‚é€™å€‹æ–¹æ¡ˆï¼š</p>
<ul>
<li>é–‹ç™¼é€Ÿåº¦æœ€å¿«</li>
<li>ç¶­è­·æˆæœ¬æœ€ä½</li>
<li>ç©©å®šæ€§æœ€é«˜</li>
<li>æª”æ¡ˆå¤§å°æœ€å°</li>
</ul>
<p>åªæœ‰åœ¨ç¢ºå¯¦éœ€è¦å®Œå…¨é›¢ç·šé‹è¡Œä¸”ç„¡æ³•æ¥å—å¤–éƒ¨ä¾è³´çš„æƒ…æ³ä¸‹ï¼Œæ‰è€ƒæ…®è¤‡é›œçš„æ•´åˆæ–¹æ¡ˆã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../android/buttplug_flutter_complete_guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../android/android_native_flutter_integration.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../android/buttplug_flutter_complete_guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../android/android_native_flutter_integration.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
