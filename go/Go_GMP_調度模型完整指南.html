<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Go çš„ GMP èª¿åº¦æ¨¡å‹å®Œæ•´æŒ‡å— - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="go-çš„-gmp-èª¿åº¦æ¨¡å‹å®Œæ•´æŒ‡å—"><a class="header" href="#go-çš„-gmp-èª¿åº¦æ¨¡å‹å®Œæ•´æŒ‡å—">Go çš„ GMP èª¿åº¦æ¨¡å‹å®Œæ•´æŒ‡å—</a></h1>
<h2 id="ä¸€åŸºæœ¬æ¦‚å¿µç”¨é¤å»³é¡æ¯”"><a class="header" href="#ä¸€åŸºæœ¬æ¦‚å¿µç”¨é¤å»³é¡æ¯”">ä¸€ã€åŸºæœ¬æ¦‚å¿µï¼ˆç”¨é¤å»³é¡æ¯”ï¼‰</a></h2>
<p>æƒ³åƒ Go ç¨‹åºæ˜¯ä¸€å®¶é«˜æ•ˆç‡çš„é¤å»³ï¼š</p>
<div class="table-wrapper"><table><thead><tr><th>è§’è‰²</th><th>æ˜¯ä»€éº¼</th><th>é¤å»³é¡æ¯”</th><th>ç‰¹é»</th></tr></thead><tbody>
<tr><td><strong>G</strong> (Goroutine)</td><td>ä½ å¯«çš„ä»»å‹™</td><td>ğŸ“‹ å®¢äººçš„è¨‚å–®</td><td>è¶…ç´šå¤šã€è¶…ç´šè¼•ï¼ˆ2KBï¼‰</td></tr>
<tr><td><strong>M</strong> (Machine)</td><td>OS ç·šç¨‹</td><td>ğŸ‘¨â€ğŸ³ å»šå¸«</td><td>çœŸæ­£å¹¹æ´»çš„äººï¼ˆ8MBï¼‰</td></tr>
<tr><td><strong>P</strong> (Processor)</td><td>é‚è¼¯è™•ç†å™¨</td><td>ğŸ³ å»šæˆ¿å·¥ä½œæª¯</td><td>æ•¸é‡ = CPU æ ¸å¿ƒæ•¸</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="äºŒåŸºæœ¬æ•¸é‡é—œä¿‚"><a class="header" href="#äºŒåŸºæœ¬æ•¸é‡é—œä¿‚">äºŒã€åŸºæœ¬æ•¸é‡é—œä¿‚</a></h2>
<h3 id="åœ¨-16-æ ¸å¿ƒ-cpu-ä¸Š"><a class="header" href="#åœ¨-16-æ ¸å¿ƒ-cpu-ä¸Š">åœ¨ 16 æ ¸å¿ƒ CPU ä¸Šï¼š</a></h3>
<pre><code class="language-go">package main

import (
    "fmt"
    "runtime"
)

func main() {
    fmt.Println("CPU æ ¸å¿ƒæ•¸:", runtime.NumCPU())           // 16
    fmt.Println("P çš„æ•¸é‡:", runtime.GOMAXPROCS(0))        // 16ï¼ˆé è¨­ï¼‰
    fmt.Println("ç•¶å‰ G æ•¸é‡:", runtime.NumGoroutine())    // 1ï¼ˆmain goroutineï¼‰
    
    // å‰µå»º 1000 å€‹ goroutine
    for i := 0; i &lt; 1000; i++ {
        go func(id int) {
            // åšä¸€äº›å·¥ä½œ
            sum := 0
            for j := 0; j &lt; 1000000; j++ {
                sum += j
            }
        }(i)
    }
    
    fmt.Println("å‰µå»ºå¾Œ G æ•¸é‡:", runtime.NumGoroutine())  // ç´„ 1000
}
</code></pre>
<p><strong>ç™½è©±è§£é‡‹ï¼š</strong></p>
<ul>
<li>æœ‰ 16 å€‹å·¥ä½œæª¯ï¼ˆPï¼‰</li>
<li>ä¾†äº† 1000 ä»½è¨‚å–®ï¼ˆGï¼‰</li>
<li>æ¯å€‹å·¥ä½œæª¯åˆ†é…ç´„ 62 ä»½è¨‚å–®</li>
<li>å»šå¸«ï¼ˆMï¼‰æœƒæ ¹æ“šéœ€è¦è‡ªå‹•å‡ºç¾ï¼ˆé€šå¸¸ â‰ˆ P çš„æ•¸é‡ï¼‰</li>
</ul>
<hr />
<h2 id="ä¸‰å®Œæ•´å·¥ä½œæµç¨‹"><a class="header" href="#ä¸‰å®Œæ•´å·¥ä½œæµç¨‹">ä¸‰ã€å®Œæ•´å·¥ä½œæµç¨‹</a></h2>
<h3 id="ç¯„ä¾‹-1åŸºæœ¬èª¿åº¦"><a class="header" href="#ç¯„ä¾‹-1åŸºæœ¬èª¿åº¦">ç¯„ä¾‹ 1ï¼šåŸºæœ¬èª¿åº¦</a></h3>
<pre><code class="language-go">package main

import (
    "fmt"
    "runtime"
    "sync"
    "time"
)

func main() {
    // è¨­ç½®ä½¿ç”¨ 4 å€‹æ ¸å¿ƒï¼ˆæ–¹ä¾¿è§€å¯Ÿï¼‰
    runtime.GOMAXPROCS(4)
    
    var wg sync.WaitGroup
    
    // å‰µå»º 12 å€‹ goroutine
    for i := 0; i &lt; 12; i++ {
        wg.Add(1)
        go worker(i, &amp;wg)
    }
    
    wg.Wait()
    fmt.Println("æ‰€æœ‰ä»»å‹™å®Œæˆ")
}

func worker(id int, wg *sync.WaitGroup) {
    defer wg.Done()
    
    fmt.Printf("G%d é–‹å§‹åŸ·è¡Œ\n", id)
    
    // CPU å¯†é›†å‹å·¥ä½œ
    sum := 0
    for i := 0; i &lt; 100000000; i++ {
        sum += i
    }
    
    fmt.Printf("G%d å®Œæˆ\n", id)
}
</code></pre>
<p><strong>åŸ·è¡Œéç¨‹ï¼ˆç™½è©±ï¼‰ï¼š</strong></p>
<pre><code>1. å•Ÿå‹•æ™‚ï¼š
   - å‰µå»º 4 å€‹ Pï¼ˆP0, P1, P2, P3ï¼‰
   - å‰µå»º 12 å€‹ Gï¼ˆG0~G11ï¼‰

2. åˆå§‹åˆ†é…ï¼š
   P0 éšŠåˆ—: [G0, G4, G8]
   P1 éšŠåˆ—: [G1, G5, G9]
   P2 éšŠåˆ—: [G2, G6, G10]
   P3 éšŠåˆ—: [G3, G7, G11]

3. é–‹å§‹åŸ·è¡Œï¼š
   M0 + P0 â†’ åŸ·è¡Œ G0
   M1 + P1 â†’ åŸ·è¡Œ G1
   M2 + P2 â†’ åŸ·è¡Œ G2
   M3 + P3 â†’ åŸ·è¡Œ G3
   
   ï¼ˆ4 å€‹å»šå¸«åŒæ™‚åœ¨ 4 å€‹å·¥ä½œæª¯åšèœï¼‰

4. G0 å®Œæˆå¾Œï¼š
   M0 + P0 â†’ ç«‹åˆ»å–å‡º G4 ç¹¼çºŒåŸ·è¡Œ
   
   ï¼ˆå»šå¸«åšå®Œä¸€ä»½è¨‚å–®ï¼Œç«‹åˆ»æ‹¿ä¸‹ä¸€ä»½ï¼‰

5. å…¨éƒ¨å®Œæˆï¼š
   12 å€‹ G éƒ½åŸ·è¡Œå®Œç•¢
</code></pre>
<hr />
<h2 id="å››é˜»å¡å ´æ™¯é‡é»"><a class="header" href="#å››é˜»å¡å ´æ™¯é‡é»">å››ã€é˜»å¡å ´æ™¯ï¼ˆé‡é»ï¼ï¼‰</a></h2>
<h3 id="ç¯„ä¾‹-2é‡åˆ°é˜»å¡æ“ä½œ"><a class="header" href="#ç¯„ä¾‹-2é‡åˆ°é˜»å¡æ“ä½œ">ç¯„ä¾‹ 2ï¼šé‡åˆ°é˜»å¡æ“ä½œ</a></h3>
<pre><code class="language-go">package main

import (
    "fmt"
    "runtime"
    "sync"
    "time"
)

func main() {
    runtime.GOMAXPROCS(4)
    
    var wg sync.WaitGroup
    
    // å‰µå»º 20 å€‹æœƒé˜»å¡çš„ goroutine
    for i := 0; i &lt; 20; i++ {
        wg.Add(1)
        go blockingWorker(i, &amp;wg)
    }
    
    wg.Wait()
}

func blockingWorker(id int, wg *sync.WaitGroup) {
    defer wg.Done()
    
    fmt.Printf("G%d é–‹å§‹\n", id)
    
    // æ¨¡æ“¬ I/O é˜»å¡ï¼ˆç¶²çµ¡è«‹æ±‚ã€æ–‡ä»¶è®€å–ç­‰ï¼‰
    time.Sleep(1 * time.Second)
    
    fmt.Printf("G%d å®Œæˆ\n", id)
}
</code></pre>
<p><strong>é˜»å¡æ™‚çš„è™•ç†ï¼ˆç™½è©±ï¼‰ï¼š</strong></p>
<pre><code>1. G0 åœ¨ M0 ä¸ŠåŸ·è¡Œï¼Œé‡åˆ° time.Sleep
   
2. Go runtime çš„è™•ç†ï¼š
   â‘  G0 é€²å…¥ä¼‘çœ ç‹€æ…‹
   â‘¡ P0 å’Œ M0 è§£ç¶
   â‘¢ P0 ç«‹åˆ»æ‰¾åˆ°æˆ–å‰µå»ºæ–°çš„ Mï¼ˆæ¯”å¦‚ M4ï¼‰
   â‘£ P0 + M4 ç¹¼çºŒåŸ·è¡ŒéšŠåˆ—ä¸­çš„ä¸‹ä¸€å€‹ G
   
   ï¼ˆé€™å€‹å»šå¸«è¦ç­‰é£Ÿæï¼Œå·¥ä½œæª¯ä¸èƒ½é–’è‘—ï¼Œæ›å€‹å»šå¸«ç¹¼çºŒåšï¼‰

3. 1 ç§’å¾Œ G0 é†’ä¾†ï¼š
   â‘  G0 é‡æ–°é€²å…¥æŸå€‹ P çš„éšŠåˆ—
   â‘¡ ç­‰å¾… M ä¾†åŸ·è¡Œ
   
   ï¼ˆé£Ÿæåˆ°äº†ï¼Œè¨‚å–®é‡æ–°æ’éšŠï¼‰
</code></pre>
<hr />
<h2 id="äº”work-stealingæ¶å·¥ä½œæ©Ÿåˆ¶"><a class="header" href="#äº”work-stealingæ¶å·¥ä½œæ©Ÿåˆ¶">äº”ã€Work Stealingï¼ˆæ¶å·¥ä½œæ©Ÿåˆ¶ï¼‰</a></h2>
<h3 id="ç¯„ä¾‹-3è² è¼‰ä¸å‡è¡¡"><a class="header" href="#ç¯„ä¾‹-3è² è¼‰ä¸å‡è¡¡">ç¯„ä¾‹ 3ï¼šè² è¼‰ä¸å‡è¡¡</a></h3>
<pre><code class="language-go">package main

import (
    "fmt"
    "runtime"
    "sync"
    "time"
)

func main() {
    runtime.GOMAXPROCS(4)
    
    var wg sync.WaitGroup
    
    // P0 åˆ†é…åˆ°é‡ä»»å‹™
    for i := 0; i &lt; 5; i++ {
        wg.Add(1)
        go func(id int) {
            defer wg.Done()
            fmt.Printf("é‡ä»»å‹™ G%d é–‹å§‹\n", id)
            time.Sleep(2 * time.Second) // æ¨¡æ“¬é‡ä»»å‹™
            fmt.Printf("é‡ä»»å‹™ G%d å®Œæˆ\n", id)
        }(i)
    }
    
    // P1-P3 åˆ†é…åˆ°è¼•ä»»å‹™
    for i := 100; i &lt; 103; i++ {
        wg.Add(1)
        go func(id int) {
            defer wg.Done()
            fmt.Printf("è¼•ä»»å‹™ G%d é–‹å§‹\n", id)
            time.Sleep(100 * time.Millisecond) // å¿«é€Ÿå®Œæˆ
            fmt.Printf("è¼•ä»»å‹™ G%d å®Œæˆ\n", id)
        }(i)
    }
    
    wg.Wait()
}
</code></pre>
<p><strong>Work Stealing æµç¨‹ï¼ˆç™½è©±ï¼‰ï¼š</strong></p>
<pre><code>1. åˆå§‹ç‹€æ…‹ï¼š
   P0: [G0, G1, G2, G3, G4]  â† 5 å€‹é‡ä»»å‹™
   P1: [G100]                â† 1 å€‹è¼•ä»»å‹™
   P2: [G101]
   P3: [G102]

2. åŸ·è¡Œéç¨‹ï¼š
   - P1 çš„ M1 å¾ˆå¿«å®Œæˆ G100
   - P1 çš„éšŠåˆ—ç©ºäº†ï¼

3. Work Stealing è§¸ç™¼ï¼š
   - M1 ç™¼ç¾ P1 æ²’å·¥ä½œäº†
   - M1 å·å·å»çœ‹ P0 çš„éšŠåˆ—
   - M1 å¾ P0 éšŠåˆ—å°¾éƒ¨å·èµ°ä¸€åŠï¼š[G3, G4]
   
   ï¼ˆç©ºé–’çš„å»šå¸«å»å¹«å¿™åˆ¥çš„å·¥ä½œæª¯ï¼‰

4. çµæœï¼š
   P0: [G0, G1, G2]
   P1: [G3, G4]  â† å·ä¾†çš„
   
   è² è¼‰æ›´å‡è¡¡äº†ï¼
</code></pre>
<hr />
<h2 id="å…­ç³»çµ±èª¿ç”¨å ´æ™¯"><a class="header" href="#å…­ç³»çµ±èª¿ç”¨å ´æ™¯">å…­ã€ç³»çµ±èª¿ç”¨å ´æ™¯</a></h2>
<h3 id="ç¯„ä¾‹-4ç³»çµ±èª¿ç”¨é˜»å¡"><a class="header" href="#ç¯„ä¾‹-4ç³»çµ±èª¿ç”¨é˜»å¡">ç¯„ä¾‹ 4ï¼šç³»çµ±èª¿ç”¨é˜»å¡</a></h3>
<pre><code class="language-go">package main

import (
    "fmt"
    "os"
    "runtime"
    "sync"
)

func main() {
    runtime.GOMAXPROCS(4)
    
    var wg sync.WaitGroup
    
    for i := 0; i &lt; 10; i++ {
        wg.Add(1)
        go syscallWorker(i, &amp;wg)
    }
    
    wg.Wait()
}

func syscallWorker(id int, wg *sync.WaitGroup) {
    defer wg.Done()
    
    fmt.Printf("G%d æº–å‚™ç³»çµ±èª¿ç”¨\n", id)
    
    // ç³»çµ±èª¿ç”¨ï¼ˆæœƒé˜»å¡ Mï¼‰
    file, _ := os.Create(fmt.Sprintf("/tmp/test_%d.txt", id))
    file.WriteString("Hello")
    file.Close()
    
    fmt.Printf("G%d ç³»çµ±èª¿ç”¨å®Œæˆ\n", id)
}
</code></pre>
<p><strong>ç³»çµ±èª¿ç”¨æ™‚çš„è™•ç†ï¼ˆç™½è©±ï¼‰ï¼š</strong></p>
<pre><code>1. G0 åœ¨ M0 ä¸ŠåŸ·è¡Œç³»çµ±èª¿ç”¨ï¼ˆå¯«æ–‡ä»¶ï¼‰
   
2. å•é¡Œï¼šç³»çµ±èª¿ç”¨æœƒé˜»å¡ M0ï¼ˆOS å±¤é¢çš„é˜»å¡ï¼‰
   
3. Go runtime çš„è™•ç†ï¼š
   â‘  M0 å’Œ G0 ä¸€èµ·è¢«é˜»å¡ï¼ˆé™·å…¥å…§æ ¸æ…‹ï¼‰
   â‘¡ P0 æª¢æ¸¬åˆ° M0 è¢«é˜»å¡
   â‘¢ P0 è§£ç¶ M0ï¼Œå»æ‰¾æ–°çš„ Mï¼ˆæ¯”å¦‚ M5ï¼‰
   â‘£ P0 + M5 ç¹¼çºŒåŸ·è¡Œå…¶ä»– G
   
   ï¼ˆå»šå¸«å¡åœ¨æŸå€‹æ­¥é©Ÿï¼Œå·¥ä½œæª¯æ›å€‹å»šå¸«ç¹¼çºŒï¼‰

4. ç³»çµ±èª¿ç”¨å®Œæˆå¾Œï¼š
   â‘  M0 å’Œ G0 æ¢å¾©
   â‘¡ M0 å˜—è©¦é‡æ–°ç²å– P
   â‘¢ å¦‚æœæ²’æœ‰ç©ºé–’ Pï¼ŒM0 å’Œ G0 é€²å…¥ä¼‘çœ 
   â‘£ G0 æœƒè¢«æ”¾å…¥å…¨å±€éšŠåˆ—ï¼Œç­‰å¾…èª¿åº¦
   
   ï¼ˆåŸä¾†çš„å»šå¸«å›ä¾†äº†ï¼Œå¦‚æœæ²’æœ‰ç©ºå·¥ä½œæª¯ï¼Œå°±å¾…å‘½ï¼‰
</code></pre>
<hr />
<h2 id="ä¸ƒå®Œæ•´ç‹€æ…‹åœ–"><a class="header" href="#ä¸ƒå®Œæ•´ç‹€æ…‹åœ–">ä¸ƒã€å®Œæ•´ç‹€æ…‹åœ–</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Go Scheduler                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  å…¨å±€éšŠåˆ— (Global Queue)                                  â”‚
â”‚  [G50, G51, G52, ...]  â† æ²’æœ‰ P çš„ G åœ¨é€™è£¡ç­‰å¾…           â”‚
â”‚                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  P0 [æœ¬åœ°éšŠåˆ—]          M0 â”€â”€â”€â”€â”€â†’ æ­£åœ¨åŸ·è¡Œ G0              â”‚
â”‚  [G1, G2, G3]                                             â”‚
â”‚                                                           â”‚
â”‚  P1 [æœ¬åœ°éšŠåˆ—]          M1 â”€â”€â”€â”€â”€â†’ æ­£åœ¨åŸ·è¡Œ G10             â”‚
â”‚  [G11, G12, G13]                                          â”‚
â”‚                                                           â”‚
â”‚  P2 [æœ¬åœ°éšŠåˆ—]          M2 â”€â”€â”€â”€â”€â†’ æ­£åœ¨åŸ·è¡Œ G20             â”‚
â”‚  [G21, G22]                                               â”‚
â”‚                                                           â”‚
â”‚  P3 [æœ¬åœ°éšŠåˆ—]          M3 â”€â”€â”€â”€â”€â†’ æ­£åœ¨åŸ·è¡Œ G30             â”‚
â”‚  [ç©º]  â† æœƒå»å·å…¶ä»– P çš„å·¥ä½œ                               â”‚
â”‚                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  é–’ç½® M æ± : [M4, M5, M6, ...]                             â”‚
â”‚  (å¾…å‘½çš„ç·šç¨‹ï¼Œéœ€è¦æ™‚å¯ä»¥å¿«é€Ÿå–šé†’)                           â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr />
<h2 id="å…«é—œéµæ•¸æ“šå°æ¯”"><a class="header" href="#å…«é—œéµæ•¸æ“šå°æ¯”">å…«ã€é—œéµæ•¸æ“šå°æ¯”</a></h2>
<div class="table-wrapper"><table><thead><tr><th>é …ç›®</th><th>G</th><th>M</th><th>P</th></tr></thead><tbody>
<tr><td><strong>æ•¸é‡</strong></td><td>æˆåƒä¸Šè¬å€‹</td><td>é€šå¸¸ â‰ˆ P çš„æ•¸é‡<br>æœ€å¤š 10000</td><td>= CPU æ ¸å¿ƒæ•¸</td></tr>
<tr><td><strong>è¨˜æ†¶é«”</strong></td><td>2KB èµ·å§‹</td><td>8MB</td><td>å¾ˆå°</td></tr>
<tr><td><strong>å‰µå»ºæˆæœ¬</strong></td><td>æ¥µä½ï¼ˆç´ç§’ï¼‰</td><td>è¼ƒé«˜ï¼ˆæ¯«ç§’ï¼‰</td><td>å•Ÿå‹•æ™‚å‰µå»º</td></tr>
<tr><td><strong>èª°å‰µå»º</strong></td><td>ç¨‹åºå“¡ (<code>go</code>)</td><td>Go runtime</td><td>Go runtime</td></tr>
<tr><td><strong>èª°èª¿åº¦</strong></td><td>Go scheduler</td><td>OS scheduler</td><td>-</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="ä¹gmp-è©³ç´°è§£é‡‹"><a class="header" href="#ä¹gmp-è©³ç´°è§£é‡‹">ä¹ã€Gã€Mã€P è©³ç´°è§£é‡‹</a></h2>
<h3 id="ggoroutine--è¨‚å–®"><a class="header" href="#ggoroutine--è¨‚å–®">Gï¼ˆGoroutineï¼‰- è¨‚å–®</a></h3>
<p><strong>å®šç¾©ï¼š</strong></p>
<ul>
<li>ä½ ç”¨ <code>go</code> é—œéµå­—å‰µå»ºçš„æ¯å€‹ä»»å‹™</li>
<li>Go ç¨‹åºçš„æœ€å°åŸ·è¡Œå–®ä½</li>
</ul>
<p><strong>ç‰¹æ€§ï¼š</strong></p>
<ul>
<li>éå¸¸è¼•é‡ï¼šåˆå§‹å †ç–Šåªæœ‰ <strong>2KB</strong>ï¼ˆå¯å‹•æ…‹å¢é•·åˆ° 1GBï¼‰</li>
<li>å¯ä»¥æœ‰æ•¸åè¬å€‹åŒæ™‚å­˜åœ¨</li>
<li>åŒ…å«ï¼šå‡½æ•¸ä»£ç¢¼ã€å †ç–Šã€ç¨‹åºè¨ˆæ•¸å™¨ã€ç‹€æ…‹ç­‰</li>
</ul>
<p><strong>ç”Ÿå‘½é€±æœŸï¼š</strong></p>
<pre><code>å‰µå»º â†’ ç­‰å¾…é‹è¡Œ â†’ æ­£åœ¨é‹è¡Œ â†’ é˜»å¡ â†’ ç­‰å¾…é‹è¡Œ â†’ å®Œæˆ
</code></pre>
<p><strong>ç¨‹å¼ç¢¼ç¯„ä¾‹ï¼š</strong></p>
<pre><code class="language-go">// æ¯å€‹ go é—œéµå­—éƒ½å‰µå»ºä¸€å€‹ G
go func() {
    fmt.Println("é€™æ˜¯ G1")
}()

go func() {
    fmt.Println("é€™æ˜¯ G2")
}()

// ç¾åœ¨æœ‰ 3 å€‹ Gï¼šmain goroutine + G1 + G2
</code></pre>
<hr />
<h3 id="mmachineos-thread--å»šå¸«"><a class="header" href="#mmachineos-thread--å»šå¸«">Mï¼ˆMachine/OS Threadï¼‰- å»šå¸«</a></h3>
<p><strong>å®šç¾©ï¼š</strong></p>
<ul>
<li>çœŸæ­£çš„ä½œæ¥­ç³»çµ±ç·šç¨‹ï¼ˆpthreadã€Windows threadï¼‰</li>
<li>æ˜¯å¯¦éš›åŸ·è¡Œä»£ç¢¼çš„è¼‰é«”</li>
</ul>
<p><strong>ç‰¹æ€§ï¼š</strong></p>
<ul>
<li>æ¯”è¼ƒé‡é‡ï¼šæ¯å€‹ç·šç¨‹ç´„ <strong>8MB</strong> å †ç–Š</li>
<li>æ•¸é‡æœ‰é™ï¼šGo é è¨­æœ€å¤š <strong>10000</strong> å€‹ M</li>
<li>ç”± Go runtime å‹•æ…‹å‰µå»ºå’ŒéŠ·æ¯€</li>
</ul>
<p><strong>å·¥ä½œæµç¨‹ï¼š</strong></p>
<pre><code>1. M ç¶å®šä¸€å€‹ P
2. å¾ P çš„æœ¬åœ°éšŠåˆ—å–å‡º G
3. åŸ·è¡Œ G çš„ä»£ç¢¼
4. G å®Œæˆå¾Œï¼Œç¹¼çºŒå–ä¸‹ä¸€å€‹ G
</code></pre>
<p><strong>ç‰¹æ®Šæƒ…æ³ï¼š</strong></p>
<ul>
<li>ç•¶ G ç™¼èµ·ç³»çµ±èª¿ç”¨æ™‚ï¼ŒM æœƒå’Œ G ä¸€èµ·é˜»å¡</li>
<li>P æœƒè§£ç¶é€™å€‹ Mï¼Œå»æ‰¾æ–°çš„ M ç¹¼çºŒå·¥ä½œ</li>
<li>é˜»å¡çµæŸå¾Œï¼ŒM å˜—è©¦é‡æ–°ç²å– P</li>
</ul>
<hr />
<h3 id="pprocessor--å·¥ä½œæª¯"><a class="header" href="#pprocessor--å·¥ä½œæª¯">Pï¼ˆProcessorï¼‰- å·¥ä½œæª¯</a></h3>
<p><strong>å®šç¾©ï¼š</strong></p>
<ul>
<li>é‚è¼¯è™•ç†å™¨ï¼Œæ˜¯ G å’Œ M ä¹‹é–“çš„æ©‹æ¨‘</li>
<li>æŒæœ‰ G çš„æœ¬åœ°é‹è¡ŒéšŠåˆ—</li>
</ul>
<p><strong>ç‰¹æ€§ï¼š</strong></p>
<ul>
<li>æ•¸é‡ = <code>GOMAXPROCS</code> = CPU æ ¸å¿ƒæ•¸ï¼ˆé è¨­ï¼‰</li>
<li>æ¯å€‹ P æœ‰è‡ªå·±çš„æœ¬åœ°éšŠåˆ—ï¼ˆæœ€å¤š 256 å€‹ Gï¼‰</li>
<li>P å¿…é ˆç¶å®š M æ‰èƒ½åŸ·è¡Œ G</li>
</ul>
<p><strong>æ ¸å¿ƒä½œç”¨ï¼š</strong></p>
<ol>
<li>ç¶­è­·æœ¬åœ° G éšŠåˆ—</li>
<li>ç®¡ç†è¨˜æ†¶é«”åˆ†é…ï¼ˆmcacheï¼‰</li>
<li>èª¿åº¦ G çš„åŸ·è¡Œ</li>
</ol>
<p><strong>èª¿æ•´ P çš„æ•¸é‡ï¼š</strong></p>
<pre><code class="language-go">runtime.GOMAXPROCS(8)  // è¨­ç½®ç‚º 8 å€‹ P
</code></pre>
<hr />
<h2 id="åå¯¦ç”¨èª¿è©¦æŠ€å·§"><a class="header" href="#åå¯¦ç”¨èª¿è©¦æŠ€å·§">åã€å¯¦ç”¨èª¿è©¦æŠ€å·§</a></h2>
<pre><code class="language-go">package main

import (
    "fmt"
    "runtime"
    "time"
)

func main() {
    // æŸ¥çœ‹èª¿åº¦ä¿¡æ¯
    fmt.Println("=== åˆå§‹ç‹€æ…‹ ===")
    printStats()
    
    // å‰µå»ºå¤§é‡ goroutine
    for i := 0; i &lt; 100; i++ {
        go func() {
            time.Sleep(10 * time.Second)
        }()
    }
    
    time.Sleep(1 * time.Second)
    
    fmt.Println("\n=== å‰µå»º 100 å€‹ G å¾Œ ===")
    printStats()
}

func printStats() {
    fmt.Printf("CPU æ ¸å¿ƒæ•¸: %d\n", runtime.NumCPU())
    fmt.Printf("GOMAXPROCS: %d\n", runtime.GOMAXPROCS(0))
    fmt.Printf("ç•¶å‰ Goroutine æ•¸: %d\n", runtime.NumGoroutine())
    
    var m runtime.MemStats
    runtime.ReadMemStats(&amp;m)
    fmt.Printf("Goroutine å †ç–Šè¨˜æ†¶é«”: %d KB\n", m.StackInuse/1024)
}
</code></pre>
<p><strong>é€²éšèª¿è©¦ï¼š</strong></p>
<pre><code class="language-bash"># ä½¿ç”¨ GODEBUG æŸ¥çœ‹èª¿åº¦å™¨ä¿¡æ¯
GODEBUG=schedtrace=1000 go run main.go

# è¼¸å‡ºè§£é‡‹ï¼š
# SCHED 1000ms: gomaxprocs=8 idleprocs=0 threads=10 ...
# gomaxprocs: P çš„æ•¸é‡
# idleprocs: ç©ºé–’çš„ P æ•¸é‡
# threads: M çš„æ•¸é‡
</code></pre>
<hr />
<h2 id="åä¸€å¸¸è¦‹å•é¡Œ-faq"><a class="header" href="#åä¸€å¸¸è¦‹å•é¡Œ-faq">åä¸€ã€å¸¸è¦‹å•é¡Œ FAQ</a></h2>
<h3 id="q1-ç‚ºä»€éº¼éœ€è¦-pç›´æ¥-g-å’Œ-m-ä¸è¡Œå—"><a class="header" href="#q1-ç‚ºä»€éº¼éœ€è¦-pç›´æ¥-g-å’Œ-m-ä¸è¡Œå—">Q1: ç‚ºä»€éº¼éœ€è¦ Pï¼Ÿç›´æ¥ G å’Œ M ä¸è¡Œå—ï¼Ÿ</a></h3>
<p><strong>ç­”ï¼š</strong> P çš„å­˜åœ¨æ˜¯ç‚ºäº†æ›´å¥½çš„èª¿åº¦æ•ˆç‡ï¼š</p>
<ul>
<li>P ç¶­è­·æœ¬åœ°éšŠåˆ—ï¼Œæ¸›å°‘å…¨å±€éšŠåˆ—çš„é–ç«¶çˆ­</li>
<li>P å¯¦ç¾ work stealingï¼Œè‡ªå‹•è² è¼‰å‡è¡¡</li>
<li>P ç®¡ç†è¨˜æ†¶é«”åˆ†é…ï¼Œæ¸›å°‘è¨˜æ†¶é«”ç«¶çˆ­</li>
</ul>
<h3 id="q2-m-çš„æ•¸é‡æœƒç„¡é™å¢é•·å—"><a class="header" href="#q2-m-çš„æ•¸é‡æœƒç„¡é™å¢é•·å—">Q2: M çš„æ•¸é‡æœƒç„¡é™å¢é•·å—ï¼Ÿ</a></h3>
<p><strong>ç­”ï¼š</strong> ä¸æœƒ</p>
<ul>
<li>Go é™åˆ¶æœ€å¤š 10000 å€‹ Mï¼ˆå¯èª¿æ•´ï¼‰</li>
<li>é–’ç½®çš„ M æœƒè¢«æ”¾å…¥æ± ä¸­è¤‡ç”¨</li>
<li>é•·æ™‚é–“ä¸ç”¨çš„ M æœƒè¢«éŠ·æ¯€</li>
</ul>
<h3 id="q3-ä»€éº¼æ™‚å€™æœƒå‰µå»ºæ–°çš„-m"><a class="header" href="#q3-ä»€éº¼æ™‚å€™æœƒå‰µå»ºæ–°çš„-m">Q3: ä»€éº¼æ™‚å€™æœƒå‰µå»ºæ–°çš„ Mï¼Ÿ</a></h3>
<p><strong>ç­”ï¼š</strong></p>
<ol>
<li>æ‰€æœ‰ M éƒ½åœ¨åŸ·è¡Œ Gï¼Œä¸”æœ‰ G åœ¨ç­‰å¾…</li>
<li>M è¢«ç³»çµ±èª¿ç”¨é˜»å¡ï¼ŒP éœ€è¦æ–°çš„ M</li>
<li>æ‰‹å‹•èª¿ç”¨ <code>runtime.LockOSThread()</code></li>
</ol>
<h3 id="q4-goroutine-çš„å †ç–Šå¦‚ä½•å¢é•·"><a class="header" href="#q4-goroutine-çš„å †ç–Šå¦‚ä½•å¢é•·">Q4: Goroutine çš„å †ç–Šå¦‚ä½•å¢é•·ï¼Ÿ</a></h3>
<p><strong>ç­”ï¼š</strong></p>
<ul>
<li>åˆå§‹ 2KB</li>
<li>å‹•æ…‹å¢é•·ï¼š2KB â†’ 4KB â†’ 8KB â†’ ...</li>
<li>æœ€å¤§å¯é” 1GB</li>
<li>ä½¿ç”¨åˆ†æ®µå †ç–Šï¼ˆsegmented stacksï¼‰æˆ–é€£çºŒå †ç–Šï¼ˆcontiguous stacksï¼‰</li>
</ul>
<h3 id="q5-å¦‚ä½•é¿å…-goroutine-æ´©æ¼"><a class="header" href="#q5-å¦‚ä½•é¿å…-goroutine-æ´©æ¼">Q5: å¦‚ä½•é¿å… Goroutine æ´©æ¼ï¼Ÿ</a></h3>
<p><strong>ç­”ï¼š</strong></p>
<pre><code class="language-go">// âŒ éŒ¯èª¤ï¼šgoroutine æ°¸é é˜»å¡
func bad() {
    ch := make(chan int)
    go func() {
        ch &lt;- 1  // æ²’æœ‰æ¥æ”¶è€…ï¼Œæ°¸é é˜»å¡
    }()
}

// âœ… æ­£ç¢ºï¼šä½¿ç”¨ context æˆ– buffered channel
func good(ctx context.Context) {
    ch := make(chan int, 1)  // buffered
    go func() {
        select {
        case ch &lt;- 1:
        case &lt;-ctx.Done():
            return
        }
    }()
}
</code></pre>
<hr />
<h2 id="åäºŒæ€§èƒ½å„ªåŒ–å»ºè­°"><a class="header" href="#åäºŒæ€§èƒ½å„ªåŒ–å»ºè­°">åäºŒã€æ€§èƒ½å„ªåŒ–å»ºè­°</a></h2>
<h3 id="1-åˆç†è¨­ç½®-gomaxprocs"><a class="header" href="#1-åˆç†è¨­ç½®-gomaxprocs">1. åˆç†è¨­ç½® GOMAXPROCS</a></h3>
<pre><code class="language-go">// å°æ–¼ CPU å¯†é›†å‹ä»»å‹™
runtime.GOMAXPROCS(runtime.NumCPU())  // ä½¿ç”¨æ‰€æœ‰æ ¸å¿ƒ

// å°æ–¼ I/O å¯†é›†å‹ä»»å‹™
runtime.GOMAXPROCS(runtime.NumCPU() * 2)  // å¯ä»¥è¶…é…

// å®¹å™¨ç’°å¢ƒæ³¨æ„
// Docker é™åˆ¶äº† CPUï¼Œä½† runtime.NumCPU() å¯èƒ½è¿”å›å®¿ä¸»æ©Ÿæ ¸å¿ƒæ•¸
// å»ºè­°æ‰‹å‹•è¨­ç½®
</code></pre>
<h3 id="2-é¿å…å¤§é‡çŸ­ç”Ÿå‘½é€±æœŸ-goroutine"><a class="header" href="#2-é¿å…å¤§é‡çŸ­ç”Ÿå‘½é€±æœŸ-goroutine">2. é¿å…å¤§é‡çŸ­ç”Ÿå‘½é€±æœŸ Goroutine</a></h3>
<pre><code class="language-go">// âŒ ä¸å¥½ï¼šå‰µå»ºéå¤š goroutine
for i := 0; i &lt; 1000000; i++ {
    go process(i)
}

// âœ… æ›´å¥½ï¼šä½¿ç”¨ worker pool
func workerPool(jobs &lt;-chan int, workers int) {
    var wg sync.WaitGroup
    for w := 0; w &lt; workers; w++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            for job := range jobs {
                process(job)
            }
        }()
    }
    wg.Wait()
}
</code></pre>
<h3 id="3-æ³¨æ„-goroutine-çš„é€šä¿¡æˆæœ¬"><a class="header" href="#3-æ³¨æ„-goroutine-çš„é€šä¿¡æˆæœ¬">3. æ³¨æ„ Goroutine çš„é€šä¿¡æˆæœ¬</a></h3>
<pre><code class="language-go">// å¦‚æœ goroutine ä¹‹é–“é »ç¹é€šä¿¡
// å¯èƒ½ä¸å¦‚å–®ç·šç¨‹è™•ç†å¿«

// ç¶“é©—æ³•å‰‡ï¼š
// - CPU å¯†é›†å‹ï¼šgoroutine æ•¸é‡ â‰ˆ CPU æ ¸å¿ƒæ•¸
// - I/O å¯†é›†å‹ï¼šå¯ä»¥å‰µå»ºå¤§é‡ goroutine
</code></pre>
<hr />
<h2 id="åä¸‰èˆ‡å…¶ä»–èªè¨€å°æ¯”"><a class="header" href="#åä¸‰èˆ‡å…¶ä»–èªè¨€å°æ¯”">åä¸‰ã€èˆ‡å…¶ä»–èªè¨€å°æ¯”</a></h2>
<div class="table-wrapper"><table><thead><tr><th>ç‰¹æ€§</th><th>Go Goroutine</th><th>Python async/await</th><th>Java Thread</th></tr></thead><tbody>
<tr><td>ä¸¦ç™¼æ¨¡å‹</td><td>CSP (Communicating Sequential Processes)</td><td>å”ç¨‹ (Coroutine)</td><td>ç·šç¨‹ (Thread)</td></tr>
<tr><td>èª¿åº¦</td><td>Go runtime (M:N)</td><td>äº‹ä»¶å¾ªç’° (Event Loop)</td><td>OS èª¿åº¦</td></tr>
<tr><td>å †ç–Šå¤§å°</td><td>2KB èµ·å§‹</td><td>~1KB</td><td>1MB+</td></tr>
<tr><td>å‰µå»ºæˆæœ¬</td><td>æ¥µä½</td><td>ä½</td><td>é«˜</td></tr>
<tr><td>ä¸¦è¡Œ</td><td>âœ… çœŸä¸¦è¡Œ</td><td>âŒ å–®ç·šç¨‹ä¸¦ç™¼</td><td>âœ… çœŸä¸¦è¡Œ</td></tr>
<tr><td>èªæ³•</td><td><code>go func()</code></td><td><code>async/await</code></td><td><code>new Thread()</code></td></tr>
<tr><td>é€šä¿¡æ–¹å¼</td><td>Channel</td><td>Queue/asyncio</td><td>å…±äº«è¨˜æ†¶é«”</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="åå››ç¸½çµå£è¨£"><a class="header" href="#åå››ç¸½çµå£è¨£">åå››ã€ç¸½çµå£è¨£</a></h2>
<pre><code>G æ˜¯ä»»å‹™è¼•å¦‚ç¾½ï¼Œæˆåƒä¸Šè¬ä¸æ˜¯å¤¢
M æ˜¯ç·šç¨‹çœŸå¹¹æ´»ï¼Œæ•¸é‡æœ‰é™è¦çæƒœ
P æ˜¯æª¯å­åˆ†æ ¸å¿ƒï¼Œå·¥ä½œéšŠåˆ—è—å…¶ä¸­

G æ’éšŠç­‰ M åšï¼ŒM ç¶å®š P æ‰èƒ½æ´»
é‡åˆ°é˜»å¡ä¸è¦æ…Œï¼Œæ›å€‹ M ç¹¼çºŒå¹¹
éšŠåˆ—ç©ºäº†å»å·å·¥ï¼Œè² è¼‰å‡è¡¡è‡ªå‹•æˆ

è¨˜ä½ä¸‰é»ä¸æœƒéŒ¯ï¼š
1. P æ•¸é‡ç­‰æ–¼æ ¸å¿ƒæ•¸
2. M æœƒæ ¹æ“šéœ€è¦å¢æ¸›
3. G æƒ³åŸ·è¡Œå¿…é ˆé€šé P
</code></pre>
<hr />
<h2 id="åäº”å­¸ç¿’è³‡æº"><a class="header" href="#åäº”å­¸ç¿’è³‡æº">åäº”ã€å­¸ç¿’è³‡æº</a></h2>
<h3 id="å®˜æ–¹æ–‡æª”"><a class="header" href="#å®˜æ–¹æ–‡æª”">å®˜æ–¹æ–‡æª”</a></h3>
<ul>
<li><a href="https://go.dev/blog/concurrency-is-not-parallelism">Go ä¸¦ç™¼æ¨¡å‹</a></li>
<li><a href="https://go.dev/doc/effective_go#concurrency">Effective Go - Concurrency</a></li>
</ul>
<h3 id="æ·±å…¥é–±è®€"><a class="header" href="#æ·±å…¥é–±è®€">æ·±å…¥é–±è®€</a></h3>
<ul>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/proc.go">Go scheduler æºç¢¼</a></li>
<li><a href="https://docs.google.com/document/d/1TTj4T2JO42uD5ID9e89oa0sLKhJYD0Y_kqxDv3I3XMw">Scalable Go Scheduler Design</a></li>
</ul>
<h3 id="å¯¦ç”¨å·¥å…·"><a class="header" href="#å¯¦ç”¨å·¥å…·">å¯¦ç”¨å·¥å…·</a></h3>
<pre><code class="language-bash"># æŸ¥çœ‹ goroutine å †ç–Š
curl http://localhost:6060/debug/pprof/goroutine?debug=1

# æ€§èƒ½åˆ†æ
go tool pprof http://localhost:6060/debug/pprof/profile
</code></pre>
<hr />
<h2 id="é™„éŒ„å®Œæ•´ç¤ºä¾‹ç¨‹åº"><a class="header" href="#é™„éŒ„å®Œæ•´ç¤ºä¾‹ç¨‹åº">é™„éŒ„ï¼šå®Œæ•´ç¤ºä¾‹ç¨‹åº</a></h2>
<pre><code class="language-go">package main

import (
    "fmt"
    "runtime"
    "sync"
    "time"
)

func main() {
    fmt.Println("=== Go GMP èª¿åº¦æ¨¡å‹ç¤ºä¾‹ ===\n")
    
    // è¨­ç½®ä½¿ç”¨ 4 å€‹æ ¸å¿ƒ
    runtime.GOMAXPROCS(4)
    fmt.Printf("ä½¿ç”¨ %d å€‹ CPU æ ¸å¿ƒ\n\n", runtime.GOMAXPROCS(0))
    
    // ç¤ºä¾‹ 1: åŸºæœ¬ä¸¦ç™¼
    fmt.Println("--- ç¤ºä¾‹ 1: åŸºæœ¬ä¸¦ç™¼ ---")
    basicConcurrency()
    
    // ç¤ºä¾‹ 2: I/O é˜»å¡
    fmt.Println("\n--- ç¤ºä¾‹ 2: I/O é˜»å¡è™•ç† ---")
    ioBlocking()
    
    // ç¤ºä¾‹ 3: Work Stealing
    fmt.Println("\n--- ç¤ºä¾‹ 3: Work Stealing ---")
    workStealing()
    
    // é¡¯ç¤ºæœ€çµ‚çµ±è¨ˆ
    fmt.Println("\n--- æœ€çµ‚çµ±è¨ˆ ---")
    printStats()
}

func basicConcurrency() {
    var wg sync.WaitGroup
    
    for i := 0; i &lt; 8; i++ {
        wg.Add(1)
        go func(id int) {
            defer wg.Done()
            fmt.Printf("G%d é–‹å§‹\n", id)
            compute()
            fmt.Printf("G%d å®Œæˆ\n", id)
        }(i)
    }
    
    wg.Wait()
}

func ioBlocking() {
    var wg sync.WaitGroup
    
    for i := 0; i &lt; 10; i++ {
        wg.Add(1)
        go func(id int) {
            defer wg.Done()
            fmt.Printf("G%d é–‹å§‹ I/O\n", id)
            time.Sleep(100 * time.Millisecond)
            fmt.Printf("G%d I/O å®Œæˆ\n", id)
        }(i)
    }
    
    wg.Wait()
}

func workStealing() {
    var wg sync.WaitGroup
    
    // å‰µå»ºä¸å‡è¡¡çš„ä»»å‹™
    for i := 0; i &lt; 4; i++ {
        wg.Add(1)
        go func(id int) {
            defer wg.Done()
            if id == 0 {
                // P0 åˆ†é…åˆ°é‡ä»»å‹™
                time.Sleep(500 * time.Millisecond)
            } else {
                // å…¶ä»– P å¿«é€Ÿå®Œæˆ
                time.Sleep(50 * time.Millisecond)
            }
            fmt.Printf("G%d å®Œæˆ\n", id)
        }(i)
    }
    
    wg.Wait()
}

func compute() {
    sum := 0
    for i := 0; i &lt; 10000000; i++ {
        sum += i
    }
}

func printStats() {
    fmt.Printf("CPU æ ¸å¿ƒæ•¸: %d\n", runtime.NumCPU())
    fmt.Printf("GOMAXPROCS: %d\n", runtime.GOMAXPROCS(0))
    fmt.Printf("ç•¶å‰ Goroutine æ•¸: %d\n", runtime.NumGoroutine())
    
    var m runtime.MemStats
    runtime.ReadMemStats(&amp;m)
    fmt.Printf("å †ç–Šè¨˜æ†¶é«”: %d KB\n", m.StackInuse/1024)
    fmt.Printf("å †è¨˜æ†¶é«”: %d MB\n", m.Alloc/1024/1024)
}
</code></pre>
<hr />
<p><strong>æ–‡ä»¶å‰µå»ºæ—¥æœŸï¼š</strong> 2024-12-08<br />
<strong>ä½œè€…ï¼š</strong> Claude<br />
<strong>ç‰ˆæœ¬ï¼š</strong> 1.0</p>
<p>å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿äº¤æµï¼</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../go/02_ä¸¦ç™¼ç·¨ç¨‹èˆ‡GMPæ¨¡å‹.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../go/golang-goroutine.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../go/02_ä¸¦ç™¼ç·¨ç¨‹èˆ‡GMPæ¨¡å‹.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../go/golang-goroutine.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
