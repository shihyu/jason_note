# Go ä¸¦è¡Œç¯„ä¾‹ Makefile - é‡æ§‹ç‰ˆ

.PHONY: all test clean build fmt lint help run-all list demo install-tools check-env race-test

# ç›®éŒ„è¨­å®š
EXAMPLES_DIR = .
BUILD_DIR = build

# é¡è‰²å®šç¾©
BLUE = \033[0;34m
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

# é»˜èªç›®æ¨™
all: fmt test

# é‹è¡Œæ‰€æœ‰æ¸¬è©¦
test:
	@echo -e "$(BLUE)ğŸ§ª é‹è¡Œä¸¦è¡Œç¯„ä¾‹æ¸¬è©¦...$(NC)"
	@./test_concurrency_examples.sh

# æ ¼å¼åŒ–æ‰€æœ‰ä»£ç¢¼
fmt:
	@echo -e "$(BLUE)ğŸ¨ æ ¼å¼åŒ–ä»£ç¢¼...$(NC)"
	@find $(EXAMPLES_DIR) -name "*.go" -exec go fmt {} \;
	@echo -e "$(GREEN)âœ… ä»£ç¢¼æ ¼å¼åŒ–å®Œæˆ$(NC)"

# ä»£ç¢¼æª¢æŸ¥
lint:
	@echo -e "$(BLUE)ğŸ” ä»£ç¢¼æª¢æŸ¥...$(NC)"
	@if command -v golint >/dev/null 2>&1; then \
		find $(EXAMPLES_DIR) -name "*.go" -exec golint {} \; ; \
	else \
		echo -e "$(YELLOW)âš ï¸  golint æœªå®‰è£ï¼Œè·³é lint æª¢æŸ¥$(NC)"; \
		echo "é‹è¡Œ 'make install-tools' å®‰è£é–‹ç™¼å·¥å…·"; \
	fi

# ç·¨è­¯æ‰€æœ‰ç¯„ä¾‹
build:
	@echo -e "$(BLUE)ğŸ”¨ ç·¨è­¯æ‰€æœ‰ç¯„ä¾‹...$(NC)"
	@mkdir -p $(BUILD_DIR)
	@success=0; total=0; \
	for file in $$(find $(EXAMPLES_DIR) -name "*.go" -type f | sort); do \
		total=$$((total + 1)); \
		filename=$$(basename $$file .go); \
		output="$(BUILD_DIR)/$$filename"; \
		echo "ç·¨è­¯ $$file -> $$output"; \
		if go build -o "$$output" "$$file"; then \
			success=$$((success + 1)); \
		else \
			echo -e "$(RED)âŒ ç·¨è­¯å¤±æ•—: $$file$(NC)"; \
		fi; \
	done; \
	echo -e "$(GREEN)âœ… ç·¨è­¯å®Œæˆ: $$success/$$total æˆåŠŸ$(NC)"; \
	echo "è¼¸å‡ºç›®éŒ„: $(BUILD_DIR)/"

# æ¸…ç†ç·¨è­¯æ–‡ä»¶
clean:
	@echo -e "$(BLUE)ğŸ§¹ æ¸…ç†ç·¨è­¯æ–‡ä»¶...$(NC)"
	@rm -rf $(BUILD_DIR)/
	@echo -e "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(NC)"

# åˆ—å‡ºæ‰€æœ‰ç¯„ä¾‹
list:
	@echo -e "$(BLUE)ğŸ“‹ å¯ç”¨çš„ä¸¦è¡Œç¯„ä¾‹:$(NC)"
	@echo "================================================"
	@echo "ç·¨è™Ÿ | æª”æ¡ˆåç¨±                          | æè¿°"
	@echo "----|-----------------------------------|------------------"
	@echo " 01  | 01_goroutine_basics.go            | Goroutine åŸºç¤"
	@echo " 02  | 02_channel_communication.go      | Channel é€šè¨Š"
	@echo " 03  | 03_select_multiplexing.go        | Select å¤šè·¯å¾©ç”¨"
	@echo " 04  | 04_mutex_synchronization.go      | Mutex äº’æ–¥é–"
	@echo " 05  | 05_rwmutex_optimization.go       | RWMutex è®€å¯«é–"
	@echo " 06  | 06_waitgroup_synchronization.go  | WaitGroup åŒæ­¥"
	@echo " 07  | 07_atomic_operations.go          | åŸå­æ“ä½œ"
	@echo " 08  | 08_context_control.go            | Context æ§åˆ¶"
	@echo " 09  | 09_producer_consumer_pattern.go  | ç”Ÿç”¢è€…-æ¶ˆè²»è€…"
	@echo " 10  | 10_pipeline_pattern.go           | Pipeline ç®¡é“"
	@echo " 11  | 11_worker_pool_advanced.go       | é«˜ç´š Worker Pool"
	@echo "================================================"
	@echo "é‹è¡Œç¯„ä¾‹: make run-<ç·¨è™Ÿ> (ä¾‹å¦‚: make run-01)"
	@echo "ä½¿ç”¨æ–¹æ³•: è«‹å¾ concurrency_examples/ ç›®éŒ„åŸ·è¡Œ"

# é‹è¡Œç‰¹å®šç¯„ä¾‹
run-01:
	@echo -e "$(BLUE)ğŸš€ é‹è¡Œ Goroutine åŸºç¤ç¯„ä¾‹...$(NC)"
	@go run 01_goroutine_basics.go

run-02:
	@echo -e "$(BLUE)ğŸ“¡ é‹è¡Œ Channel é€šè¨Šç¯„ä¾‹...$(NC)"
	@go run 02_channel_communication.go

run-03:
	@echo -e "$(BLUE)ğŸ¯ é‹è¡Œ Select å¤šè·¯å¾©ç”¨ç¯„ä¾‹...$(NC)"
	@timeout 15s go run 03_select_multiplexing.go

run-04:
	@echo -e "$(BLUE)ğŸ”’ é‹è¡Œ Mutex åŒæ­¥ç¯„ä¾‹...$(NC)"
	@go run 04_mutex_synchronization.go

run-05:
	@echo -e "$(BLUE)ğŸ“– é‹è¡Œ RWMutex ç¯„ä¾‹...$(NC)"
	@go run 05_rwmutex_optimization.go

run-06:
	@echo -e "$(BLUE)ğŸ¯ é‹è¡Œ WaitGroup ç¯„ä¾‹...$(NC)"
	@go run 06_waitgroup_synchronization.go

run-07:
	@echo -e "$(BLUE)âš›ï¸ é‹è¡ŒåŸå­æ“ä½œç¯„ä¾‹...$(NC)"
	@go run 07_atomic_operations.go

run-08:
	@echo -e "$(BLUE)ğŸ¯ é‹è¡Œ Context ç¯„ä¾‹...$(NC)"
	@go run 08_context_control.go

run-09:
	@echo -e "$(BLUE)ğŸ­ é‹è¡Œç”Ÿç”¢è€…-æ¶ˆè²»è€…ç¯„ä¾‹...$(NC)"
	@go run 09_producer_consumer_pattern.go

run-10:
	@echo -e "$(BLUE)ğŸ”„ é‹è¡Œ Pipeline ç¯„ä¾‹...$(NC)"
	@go run 10_pipeline_pattern.go

run-11:
	@echo -e "$(BLUE)âš¡ é‹è¡Œé«˜ç´š Worker Pool ç¯„ä¾‹...$(NC)"
	@go run 11_worker_pool_advanced.go

# ä¾åºé‹è¡Œæ‰€æœ‰ç¯„ä¾‹
run-all:
	@echo -e "$(BLUE)ğŸš€ ä¾åºé‹è¡Œæ‰€æœ‰ç¯„ä¾‹...$(NC)"
	@for i in 01 02 03 04 05 06 07 08 09 10 11; do \
		echo -e "\n$(YELLOW)======== é‹è¡Œç¯„ä¾‹ $$i ========$(NC)"; \
		$(MAKE) run-$$i || echo -e "$(RED)ç¯„ä¾‹ $$i é‹è¡Œå¤±æ•—$(NC)"; \
		echo -e "$(GREEN)ç¯„ä¾‹ $$i å®Œæˆ$(NC)"; \
		sleep 2; \
	done
	@echo -e "\n$(GREEN)ğŸ‰ æ‰€æœ‰ç¯„ä¾‹é‹è¡Œå®Œæˆï¼$(NC)"

# æ¼”ç¤ºæ¨¡å¼ (æ¯å€‹ç¯„ä¾‹é‹è¡Œæ›´çŸ­æ™‚é–“)
demo:
	@echo -e "$(BLUE)ğŸ¬ æ¼”ç¤ºæ¨¡å¼ - å¿«é€Ÿå±•ç¤ºæ‰€æœ‰ç¯„ä¾‹...$(NC)"
	@for file in $$(find $(EXAMPLES_DIR) -name "*.go" -type f | sort); do \
		echo -e "\n$(YELLOW)======== æ¼”ç¤º: $$(basename $$file) ========$(NC)"; \
		timeout 5s go run "$$file" || echo -e "$(YELLOW)æ¼”ç¤ºå®Œæˆ$(NC)"; \
		sleep 1; \
	done
	@echo -e "\n$(GREEN)ğŸ‰ æ¼”ç¤ºå®Œæˆï¼$(NC)"

# ç«¶çˆ­æ¢ä»¶æª¢æ¸¬
race-test:
	@echo -e "$(BLUE)ğŸƒ é‹è¡Œç«¶çˆ­æ¢ä»¶æª¢æ¸¬...$(NC)"
	@success=0; total=0; \
	for file in $$(find $(EXAMPLES_DIR) -name "*.go" -type f | sort); do \
		total=$$((total + 1)); \
		echo "æª¢æ¸¬ $$file"; \
		if timeout 10s go run -race "$$file" >/dev/null 2>&1; then \
			success=$$((success + 1)); \
		else \
			echo -e "$(YELLOW)âš ï¸  $$file æª¢æ¸¬ç•°å¸¸æˆ–è¶…æ™‚$(NC)"; \
		fi; \
	done; \
	echo -e "$(GREEN)âœ… ç«¶çˆ­æª¢æ¸¬å®Œæˆ: $$success/$$total é€šé$(NC)"

# åŸºæº–æ¸¬è©¦
benchmark:
	@echo -e "$(BLUE)ğŸ“Š é‹è¡ŒåŸºæº–æ¸¬è©¦...$(NC)"
	@if find $(EXAMPLES_DIR) -name "*_test.go" -type f | grep -q .; then \
		cd $(EXAMPLES_DIR) && go test -bench=. -benchmem; \
	else \
		echo -e "$(YELLOW)æ²’æœ‰æ‰¾åˆ°åŸºæº–æ¸¬è©¦æ–‡ä»¶$(NC)"; \
	fi

# API æ–‡æª”ç”Ÿæˆ
docs:
	@echo -e "$(BLUE)ğŸ“š ç”Ÿæˆ API æ–‡æª”...$(NC)"
	@if command -v godoc >/dev/null 2>&1; then \
		echo "å•Ÿå‹•æ–‡æª”æœå‹™å™¨: http://localhost:6060"; \
		godoc -http=:6060; \
	else \
		echo -e "$(YELLOW)godoc æœªå®‰è£$(NC)"; \
		echo "å®‰è£å‘½ä»¤: go install golang.org/x/tools/cmd/godoc@latest"; \
	fi

# å®‰è£é–‹ç™¼å·¥å…·
install-tools:
	@echo -e "$(BLUE)ğŸ”§ å®‰è£é–‹ç™¼å·¥å…·...$(NC)"
	go install golang.org/x/lint/golint@latest
	go install golang.org/x/tools/cmd/goimports@latest
	go install golang.org/x/tools/cmd/godoc@latest
	@echo -e "$(GREEN)âœ… é–‹ç™¼å·¥å…·å®‰è£å®Œæˆ$(NC)"

# æª¢æŸ¥ç’°å¢ƒ
check-env:
	@echo -e "$(BLUE)ğŸ” æª¢æŸ¥ Go ç’°å¢ƒ...$(NC)"
	@echo "Go ç‰ˆæœ¬: $$(go version)"
	@echo "GOROOT: $$(go env GOROOT)"
	@echo "GOPATH: $$(go env GOPATH)"
	@echo "GOOS: $$(go env GOOS)"
	@echo "GOARCH: $$(go env GOARCH)"
	@echo "CPU æ ¸å¿ƒæ•¸: $$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo "æœªçŸ¥")"
	@echo "å¯ç”¨è¨˜æ†¶é«”: $$(free -h 2>/dev/null | grep Mem | awk '{print $$2}' || echo "æœªçŸ¥")"
	@echo "ç¯„ä¾‹ç›®éŒ„: $$(ls -la $(EXAMPLES_DIR) | wc -l) å€‹æ–‡ä»¶"

# ç¨‹å¼ç¢¼çµ±è¨ˆ
stats:
	@echo -e "$(BLUE)ğŸ“ˆ ç¨‹å¼ç¢¼çµ±è¨ˆ...$(NC)"
	@echo "ç¸½æ–‡ä»¶æ•¸: $$(find $(EXAMPLES_DIR) -name "*.go" | wc -l)"
	@echo "ç¸½è¡Œæ•¸: $$(find $(EXAMPLES_DIR) -name "*.go" -exec cat {} \; | wc -l)"
	@echo "ç¸½å­—ç¬¦æ•¸: $$(find $(EXAMPLES_DIR) -name "*.go" -exec cat {} \; | wc -c)"
	@echo ""
	@echo "å„ç¯„ä¾‹è¡Œæ•¸çµ±è¨ˆ:"
	@find $(EXAMPLES_DIR) -name "*.go" -exec wc -l {} \; | sort -nr

# å¹«åŠ©ä¿¡æ¯
help:
	@echo -e "$(BLUE)Go ä¸¦è¡Œç¯„ä¾‹ Makefile å¹«åŠ©$(NC)"
	@echo ""
	@echo -e "$(YELLOW)ä¸»è¦ç›®æ¨™:$(NC)"
	@echo "  all          - æ ¼å¼åŒ–ä¸¦æ¸¬è©¦ (é»˜èª)"
	@echo "  test         - é‹è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  build        - ç·¨è­¯æ‰€æœ‰ç¯„ä¾‹"
	@echo "  clean        - æ¸…ç†ç·¨è­¯æ–‡ä»¶"
	@echo ""
	@echo -e "$(YELLOW)ä»£ç¢¼å“è³ª:$(NC)"
	@echo "  fmt          - æ ¼å¼åŒ–ä»£ç¢¼"
	@echo "  lint         - ä»£ç¢¼æª¢æŸ¥"
	@echo "  race-test    - ç«¶çˆ­æ¢ä»¶æª¢æ¸¬"
	@echo ""
	@echo -e "$(YELLOW)é‹è¡Œç¯„ä¾‹:$(NC)"
	@echo "  list         - åˆ—å‡ºæ‰€æœ‰ç¯„ä¾‹"
	@echo "  run-<ç·¨è™Ÿ>   - é‹è¡Œç‰¹å®šç¯„ä¾‹ (ä¾‹å¦‚: run-01)"
	@echo "  run-all      - ä¾åºé‹è¡Œæ‰€æœ‰ç¯„ä¾‹"
	@echo "  demo         - å¿«é€Ÿæ¼”ç¤ºæ¨¡å¼"
	@echo ""
	@echo -e "$(YELLOW)å·¥å…·èˆ‡ç’°å¢ƒ:$(NC)"
	@echo "  install-tools- å®‰è£developmentå·¥å…·"
	@echo "  check-env    - æª¢æŸ¥ Go ç’°å¢ƒ"
	@echo "  stats        - ç¨‹å¼ç¢¼çµ±è¨ˆ"
	@echo "  docs         - ç”Ÿæˆ API æ–‡æª”"
	@echo "  help         - é¡¯ç¤ºæ­¤å¹«åŠ©ä¿¡æ¯"
	@echo ""
	@echo -e "$(YELLOW)ç¯„ä¾‹:$(NC)"
	@echo "  make test                    # é‹è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  make run-01                  # é‹è¡Œ Goroutine åŸºç¤ç¯„ä¾‹"
	@echo "  make demo                    # å¿«é€Ÿæ¼”ç¤ºæ‰€æœ‰ç¯„ä¾‹"
	@echo "  make build                   # ç·¨è­¯æ‰€æœ‰ç¯„ä¾‹"