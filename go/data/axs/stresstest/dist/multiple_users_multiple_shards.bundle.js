(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{invokeSubmitBalanceChangeEvents:()=>w,options:()=>v,runConsumeBalanceChangeResults:()=>R,setup:()=>M});const n=require("k6/net/grpc");var o=e.n(n);function s(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);try{return decodeURIComponent(escape(t))}catch(e){return t}}function r(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}const a=require("k6/metrics"),c=require("k6/x/kafka"),_=new a.Counter("axs_total_consumed_count"),d=new a.Trend("axs_e2e_throughput_msg_per_sec"),l=new a.Trend("axs_total_duration_sec"),i=new a.Trend("axs_e2e_latency_mill_sec"),u=new a.Trend("axs_inqueue_latency_ms"),p=new a.Trend("axs_message_delay_count"),f=new a.Trend("axs_batch_message_count"),g=new a.Trend("axs_processor_throughput_msg_per_sec"),m=new a.Trend("axs_total_process_time_cost_ms"),S=new a.Trend("axs_decode_time_cost_micro_sec"),h=new a.Trend("axs_apply_time_cost_micro_sec"),y=new a.Trend("axs_async_cost_micro_sec"),I={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let T;const b=new Uint8Array(16),A=[];for(let e=0;e<256;++e)A.push((e+256).toString(16).slice(1));function O(e,t,n){const o=(e=e||{}).random??e.rng?.()??function(){if(!T){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");T=crypto.getRandomValues.bind(crypto)}return T(b)}();if(o.length<16)throw new Error("Random bytes length must be >= 16");if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){if((n=n||0)<0||n+16>t.length)throw new RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[n+e]=o[e];return t}return function(e,t=0){return(A[e[t+0]]+A[e[t+1]]+A[e[t+2]]+A[e[t+3]]+"-"+A[e[t+4]]+A[e[t+5]]+"-"+A[e[t+6]]+A[e[t+7]]+"-"+A[e[t+8]]+A[e[t+9]]+"-"+A[e[t+10]]+A[e[t+11]]+A[e[t+12]]+A[e[t+13]]+A[e[t+14]]+A[e[t+15]]).toLowerCase()}(o)}const C=function(e,t,n){return!I.randomUUID||t||e?O(e,t,n):I.randomUUID()};function E(e,t){let n=function(e,t){const n=Math.pow(10,8),o=Math.random()*(t-e)+e;return Math.floor(o*n)/n}(e,t),o=n<0?-n:0,s=["USDC","BTC","ETH","SOL","USDT","BNB"],r=s[Math.floor(Math.random()*s.length)];return a=r,c=r,_=n.toString(),d=o.toString(),{changeId:Math.floor(999999*Math.random()+1).toString(),currencyCode:a,currencySymbol:c,availableDelta:_,frozenDelta:d,fallbackCurrencyCode:undefined,fallbackCurrencySymbol:undefined,fallbackAvailableDelta:undefined,fallbackFrozenDelta:undefined};var a,c,_,d}const K=require("k6"),v={scenarios:{producer_scenario:{executor:"constant-vus",exec:"invokeSubmitBalanceChangeEvents",vus:10,duration:"10s"},consumer_scenario:{executor:"per-vu-iterations",exec:"runConsumeBalanceChangeResults",vus:1,iterations:1}}},U=new(o().Client);function M(){const e={KAFKA_BROKERS:__ENV.KAFKA_BROKERS||"localhost:9092",GRPC_ENDPOINT:__ENV.GRPC_ENDPOINT||"localhost:1234",KAFKA_TOPIC:__ENV.KAFKA_TOPIC||"balance_change_stress_test_stats",KAFKA_CONSUME_OFFSET:parseInt(__ENV.KAFKA_CONSUME_OFFSET||"0",10),TOTAL_MESSAGES:parseInt(__ENV.TOTAL_MESSAGES||"8000",10)};console.log(`Using Kafka Brokers: ${e.KAFKA_BROKERS}`),console.log(`Using gRPC Endpoint: ${e.GRPC_ENDPOINT}`),console.log(`Using Kafka Topic: ${e.KAFKA_TOPIC}`),console.log(`Using Kafka Consume Offset: ${e.KAFKA_CONSUME_OFFSET}`),console.log(`Using Total Messages to Consume: ${e.TOTAL_MESSAGES}`);const t=new c.Connection({address:e.KAFKA_BROKERS}).listTopics();return console.log(`Available topics: ${t.join(", ")}`),{config:e}}function w({config:e}){U.connect(e.GRPC_ENDPOINT,{plaintext:!0});const t=function(e,t){let n=r(1,e),o=r(1,t),s=[];for(let e=0;e<o;e++)s.push(E(-1e4,1e4));return a=n.toString(),c=n.toString(),_=s,{eventId:C(),eventType:"DepositCreated",eventTypeId:"2",accountId:a,userId:c,sourceService:"wallet-svc",sourceSvcId:"2",relatedOrderId:Math.floor(999999*Math.random()+1).toString(),idempotencyKey:C(),createdMsec:Date.now().toString(),changes:_};var a,c,_}(1e3,6);let n=U.invoke("/apipb.AccountBalanceService/BatchSubmitBalanceChanges",{requests:[t]});(0,K.check)(n,{"status is OK":e=>e&&e.status===o().StatusOK}),U.close()}function R({config:e}){!function({config:e}){const t=new c.Reader({brokers:e.KAFKA_BROKERS.split(","),topic:e.KAFKA_TOPIC,offset:e.KAFKA_CONSUME_OFFSET});let n=0,o=0,r=0,a=0,I=-1;for(;;){const c=t.consume({limit:1,timeout:"5s"});if(!(c&&c.length>0)){console.log(`[VU ${__VU}] No message received.`);break}{const t=c[0],d=(Date.now(),s(t.value));try{const s=JSON.parse(d),c=s.event_created_msec,l=s.published_msec;(0===o||parseInt(c)<o)&&(o=parseInt(c)),(0===a||parseInt(s.start_process_msec)<a)&&(a=parseInt(s.start_process_msec)),parseInt(l)>r&&(r=parseInt(l)),s.delay_count&&p.add(s.delay_count);const T=parseInt(l)-parseInt(c);if(i.add(T),m.add(parseInt(s.process_cost)),S.add(parseInt(s.decode_cost)),h.add(parseInt(s.apply_cost)),y.add(parseInt(s.async_cost)),u.add(parseInt(s.start_process_msec)-parseInt(s.event_created_msec)),f.add(parseInt(s.total_messages)),n+=parseInt(s.total_messages),_.add(parseInt(s.total_messages)),g.add(parseInt(s.total_messages)/(parseInt(s.process_cost)/1e6)),I=t.offset,n>=e.TOTAL_MESSAGES){console.log(`[VU ${__VU}] Reached 100 messages, stopping consumption.`);break}}catch(e){console.error(`[VU ${__VU}] Failed to parse message: ${e}`)}}}if(n>0&&r>o){const e=(r-o)/1e3,t=n/e;l.add(e),d.add(t),console.log(`[VU ${__VU}] Total Messages Consumed: ${n}, Throughput: ${t.toFixed(2)} msg/sec, Last Offset: ${I}`)}}({config:e})}U.load(["../../pb/apipb"],"./api.proto");var F=exports;for(var k in t)F[k]=t[k];t.__esModule&&Object.defineProperty(F,"__esModule",{value:!0})})();