(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{invokeSubmitBalanceChangeEvents:()=>w,options:()=>K,runConsumeBalanceChangeResults:()=>M,setup:()=>U});const n=require("k6/net/grpc");var o=e.n(n);function s(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);try{return decodeURIComponent(escape(t))}catch(e){return t}}const r=require("k6/metrics"),a=require("k6/x/kafka"),c=new r.Counter("axs_total_consumed_count"),_=new r.Trend("axs_e2e_throughput_msg_per_sec"),d=new r.Trend("axs_total_duration_sec"),l=new r.Trend("axs_e2e_latency_mill_sec"),i=new r.Trend("axs_inqueue_latency_ms"),u=new r.Trend("axs_message_delay_count"),p=new r.Trend("axs_batch_message_count"),g=new r.Trend("axs_processor_throughput_msg_per_sec"),f=new r.Trend("axs_total_process_time_cost_ms"),m=new r.Trend("axs_decode_time_cost_micro_sec"),S=new r.Trend("axs_apply_time_cost_micro_sec"),h=new r.Trend("axs_async_cost_micro_sec"),y={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let I;const T=new Uint8Array(16),b=[];for(let e=0;e<256;++e)b.push((e+256).toString(16).slice(1));function A(e,t,n){const o=(e=e||{}).random??e.rng?.()??function(){if(!I){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");I=crypto.getRandomValues.bind(crypto)}return I(T)}();if(o.length<16)throw new Error("Random bytes length must be >= 16");if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){if((n=n||0)<0||n+16>t.length)throw new RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[n+e]=o[e];return t}return function(e,t=0){return(b[e[t+0]]+b[e[t+1]]+b[e[t+2]]+b[e[t+3]]+"-"+b[e[t+4]]+b[e[t+5]]+"-"+b[e[t+6]]+b[e[t+7]]+"-"+b[e[t+8]]+b[e[t+9]]+"-"+b[e[t+10]]+b[e[t+11]]+b[e[t+12]]+b[e[t+13]]+b[e[t+14]]+b[e[t+15]]).toLowerCase()}(o)}const O=function(e,t,n){return!y.randomUUID||t||e?A(e,t,n):y.randomUUID()};function C(e,t){let n=function(e,t){const n=Math.pow(10,8),o=Math.random()*(t-e)+e;return Math.floor(o*n)/n}(e,t),o=n<0?-n:0,s=["USDC","BTC","ETH","SOL","USDT","BNB"],r=s[Math.floor(Math.random()*s.length)];return a=r,c=r,_=n.toString(),d=o.toString(),{changeId:Math.floor(999999*Math.random()+1).toString(),currencyCode:a,currencySymbol:c,availableDelta:_,frozenDelta:d,fallbackCurrencyCode:undefined,fallbackCurrencySymbol:undefined,fallbackAvailableDelta:undefined,fallbackFrozenDelta:undefined};var a,c,_,d}const E=require("k6"),K={scenarios:{producer_scenario:{executor:"constant-vus",exec:"invokeSubmitBalanceChangeEvents",vus:10,duration:"10s"},consumer_scenario:{executor:"per-vu-iterations",exec:"runConsumeBalanceChangeResults",vus:1,iterations:1}}},v=new(o().Client);function U(){const e={KAFKA_BROKERS:__ENV.KAFKA_BROKERS||"localhost:9092",GRPC_ENDPOINT:__ENV.GRPC_ENDPOINT||"localhost:1234",KAFKA_TOPIC:__ENV.KAFKA_TOPIC||"balance_change_stress_test_stats",KAFKA_CONSUME_OFFSET:parseInt(__ENV.KAFKA_CONSUME_OFFSET||"0",10),TOTAL_MESSAGES:parseInt(__ENV.TOTAL_MESSAGES||"8000",10)};console.log(`Using Kafka Brokers: ${e.KAFKA_BROKERS}`),console.log(`Using gRPC Endpoint: ${e.GRPC_ENDPOINT}`),console.log(`Using Kafka Topic: ${e.KAFKA_TOPIC}`),console.log(`Using Kafka Consume Offset: ${e.KAFKA_CONSUME_OFFSET}`),console.log(`Using Total Messages to Consume: ${e.TOTAL_MESSAGES}`);const t=new a.Connection({address:e.KAFKA_BROKERS}).listTopics();return console.log(`Available topics: ${t.join(", ")}`),{config:e}}function w({config:e}){v.connect(e.GRPC_ENDPOINT,{plaintext:!0});const t=(n="1",s="1",r=[C(-1e4,1e4),C(-1e4,1e4),C(-1e4,1e4)],{eventId:O(),eventType:"DepositCreated",eventTypeId:"2",accountId:n,userId:s,sourceService:"wallet-svc",sourceSvcId:"2",relatedOrderId:Math.floor(999999*Math.random()+1).toString(),idempotencyKey:O(),createdMsec:Date.now().toString(),changes:r});var n,s,r;let a=v.invoke("/apipb.AccountBalanceService/BatchSubmitBalanceChanges",{requests:[t]});(0,E.check)(a,{"status is OK":e=>e&&e.status===o().StatusOK}),v.close()}function M({config:e}){!function({config:e}){const t=new a.Reader({brokers:e.KAFKA_BROKERS.split(","),topic:e.KAFKA_TOPIC,offset:e.KAFKA_CONSUME_OFFSET});let n=0,o=0,r=0,y=0,I=-1;for(;;){const a=t.consume({limit:1,timeout:"5s"});if(!(a&&a.length>0)){console.log(`[VU ${__VU}] No message received.`);break}{const t=a[0],_=(Date.now(),s(t.value));try{const s=JSON.parse(_),a=s.event_created_msec,d=s.published_msec;(0===o||parseInt(a)<o)&&(o=parseInt(a)),(0===y||parseInt(s.start_process_msec)<y)&&(y=parseInt(s.start_process_msec)),parseInt(d)>r&&(r=parseInt(d)),s.delay_count&&u.add(s.delay_count);const T=parseInt(d)-parseInt(a);if(l.add(T),f.add(parseInt(s.process_cost)),m.add(parseInt(s.decode_cost)),S.add(parseInt(s.apply_cost)),h.add(parseInt(s.async_cost)),i.add(parseInt(s.start_process_msec)-parseInt(s.event_created_msec)),p.add(parseInt(s.total_messages)),n+=parseInt(s.total_messages),c.add(parseInt(s.total_messages)),g.add(parseInt(s.total_messages)/(parseInt(s.process_cost)/1e6)),I=t.offset,n>=e.TOTAL_MESSAGES){console.log(`[VU ${__VU}] Reached 100 messages, stopping consumption.`);break}}catch(e){console.error(`[VU ${__VU}] Failed to parse message: ${e}`)}}}if(n>0&&r>o){const e=(r-o)/1e3,t=n/e;d.add(e),_.add(t),console.log(`[VU ${__VU}] Total Messages Consumed: ${n}, Throughput: ${t.toFixed(2)} msg/sec, Last Offset: ${I}`)}}({config:e})}v.load(["../../pb/apipb"],"./api.proto");var R=exports;for(var F in t)R[F]=t[F];t.__esModule&&Object.defineProperty(R,"__esModule",{value:!0})})();