<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Program Trace Guide - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="程式執行流程追蹤與視覺化指南"><a class="header" href="#程式執行流程追蹤與視覺化指南">程式執行流程追蹤與視覺化指南</a></h1>
<blockquote>
<p><strong>專案狀態</strong>: ✅ 95% 完成（最後更新：2024-09-29）
<strong>版本</strong>: 1.1.0
<strong>環境</strong>: Linux/Ubuntu 測試通過</p>
</blockquote>
<h2 id="-快速開始"><a class="header" href="#-快速開始">🎯 快速開始</a></h2>
<pre><code class="language-bash"># 快速測試所有功能
make quick-start  # 需要 sudo 權限

# 或分步執行
make build        # 編譯程式
make trace-all    # 執行所有追蹤
make graphs       # 產生視覺化圖表
</code></pre>
<h2 id="-最新改進-2024-09-29"><a class="header" href="#-最新改進-2024-09-29">📊 最新改進 (2024-09-29)</a></h2>
<h3 id="-已修正問題"><a class="header" href="#-已修正問題">✅ 已修正問題</a></h3>
<ul>
<li><strong>Makefile 顏色顯示</strong>：所有 <code>echo</code> 改為 <code>printf</code> 支援 ANSI 顏色碼</li>
<li><strong>GDB logging 衝突</strong>：修正 <code>test.log</code> 與 <code>gdb_trace.log</code> 檔名衝突</li>
<li><strong>Heredoc 語法錯誤</strong>：改用檔案複製方式建立測試程式</li>
<li><strong>重複目標警告</strong>：調整 Makefile 依賴關係</li>
</ul>
<h3 id="-測試結果"><a class="header" href="#-測試結果">✅ 測試結果</a></h3>
<ul>
<li><strong>GDB 追蹤</strong>：成功追蹤 48 個函數呼叫</li>
<li><strong>uftrace 追蹤</strong>：產生完整時間統計報告</li>
<li><strong>視覺化輸出</strong>：5 種格式（SVG, PNG, JSON, Chrome Trace, FlameGraph）</li>
<li><strong>Makefile targets</strong>：9/10 通過測試</li>
</ul>
<h2 id="目錄"><a class="header" href="#目錄">目錄</a></h2>
<ul>
<li><a href="#%E6%A6%82%E8%BF%B0">概述</a></li>
<li><a href="#%E6%B8%AC%E8%A9%A6%E7%A8%8B%E5%BC%8F%E6%BA%96%E5%82%99">測試程式準備</a></li>
<li><a href="#%E6%96%B9%E6%B3%95%E4%B8%80gdb-%E8%BF%BD%E8%B9%A4">方法一：GDB 追蹤</a></li>
<li><a href="#%E6%96%B9%E6%B3%95%E4%BA%8Cuftrace-%E8%BF%BD%E8%B9%A4">方法二：uftrace 追蹤</a></li>
<li><a href="#rust-%E6%94%AF%E6%8F%B4">Rust 支援</a></li>
<li><a href="#%E6%AF%94%E8%BC%83%E8%88%87%E9%81%B8%E6%93%87">比較與選擇</a></li>
<li><a href="#%E5%B8%B8%E8%A6%8B%E5%95%8F%E9%A1%8C">常見問題</a></li>
</ul>
<h2 id="概述"><a class="header" href="#概述">概述</a></h2>
<p>本指南介紹如何追蹤程式執行流程，記錄每個函數的檔案、函數名、行號，並轉換成視覺化流程圖。支援 C/C++ 和 Rust。</p>
<h3 id="需求工具"><a class="header" href="#需求工具">需求工具</a></h3>
<ul>
<li>GDB (GNU Debugger)</li>
<li>uftrace</li>
<li>Python 3 + Graphviz</li>
<li>gcc/g++ 或 rustc</li>
</ul>
<h3 id="安裝依賴"><a class="header" href="#安裝依賴">安裝依賴</a></h3>
<pre><code class="language-bash"># Ubuntu/Debian
sudo apt update
sudo apt install gdb uftrace python3-pip graphviz
pip3 install graphviz

# Arch Linux
sudo pacman -S gdb graphviz python-pip
yay -S uftrace
pip3 install graphviz

# macOS
brew install gdb graphviz
# uftrace 需要從源碼編譯
git clone https://github.com/namhyung/uftrace
cd uftrace &amp;&amp; make &amp;&amp; sudo make install
</code></pre>
<h2 id="測試程式準備"><a class="header" href="#測試程式準備">測試程式準備</a></h2>
<h3 id="c-測試程式"><a class="header" href="#c-測試程式">C++ 測試程式</a></h3>
<pre><code class="language-cpp">// test_program.cpp
#include &lt;iostream&gt;
#include &lt;cmath&gt;

class Calculator {
public:
    int add(int a, int b) {
        return a + b;
    }
    
    int multiply(int a, int b) {
        return a * b;
    }
};

int fibonacci(int n) {
    if (n &lt;= 1) return n;
    return fibonacci(n-1) + fibonacci(n-2);
}

void process_data() {
    Calculator calc;
    int result = calc.add(5, 3);
    std::cout &lt;&lt; "Add result: " &lt;&lt; result &lt;&lt; std::endl;
    
    result = calc.multiply(4, 7);
    std::cout &lt;&lt; "Multiply result: " &lt;&lt; result &lt;&lt; std::endl;
}

int main() {
    std::cout &lt;&lt; "Program started" &lt;&lt; std::endl;
    
    process_data();
    
    int fib = fibonacci(5);
    std::cout &lt;&lt; "Fibonacci(5) = " &lt;&lt; fib &lt;&lt; std::endl;
    
    return 0;
}
</code></pre>
<h3 id="rust-測試程式"><a class="header" href="#rust-測試程式">Rust 測試程式</a></h3>
<pre><pre class="playground"><code class="language-rust">// test_program.rs
use std::fmt::Debug;

struct Calculator;

impl Calculator {
    fn add(&amp;self, a: i32, b: i32) -&gt; i32 {
        a + b
    }
    
    fn multiply(&amp;self, a: i32, b: i32) -&gt; i32 {
        a * b
    }
}

fn fibonacci(n: i32) -&gt; i32 {
    if n &lt;= 1 {
        return n;
    }
    fibonacci(n - 1) + fibonacci(n - 2)
}

fn process_data() {
    let calc = Calculator;
    let result = calc.add(5, 3);
    println!("Add result: {}", result);
    
    let result = calc.multiply(4, 7);
    println!("Multiply result: {}", result);
}

fn main() {
    println!("Program started");
    
    process_data();
    
    let fib = fibonacci(5);
    println!("Fibonacci(5) = {}", fib);
}</code></pre></pre>
<h2 id="方法一gdb-追蹤"><a class="header" href="#方法一gdb-追蹤">方法一：GDB 追蹤</a></h2>
<h3 id="11-gdb-自動追蹤腳本"><a class="header" href="#11-gdb-自動追蹤腳本">1.1 GDB 自動追蹤腳本</a></h3>
<pre><code class="language-bash">#!/bin/bash
# gdb_trace.sh

# 檢查參數
if [ $# -eq 0 ]; then
    echo "Usage: $0 &lt;program_name&gt;"
    exit 1
fi

PROGRAM=$1

# 建立 GDB 命令檔
cat &gt; trace_commands.gdb &lt;&lt; 'EOF'
set pagination off
set logging file gdb_trace.log
set logging overwrite on
set logging on
set print thread-events off

# 使用 Python 來追蹤所有函數
python
import gdb
import re

class TraceFunctions(gdb.Command):
    def __init__(self):
        super(TraceFunctions, self).__init__("trace-all", gdb.COMMAND_USER)
        self.call_depth = 0
        self.trace_data = []
        
    def invoke(self, arg, from_tty):
        # 對所有函數設定中斷點
        gdb.execute("rbreak .*")
        
        # 設定中斷點的行為
        for bp in gdb.breakpoints():
            bp.silent = True
            bp.commands = "py trace_hit()\ncontinue"

def trace_hit():
    frame = gdb.newest_frame()
    sal = frame.find_sal()
    
    func_name = frame.name() or "??"
    if sal and sal.symtab:
        filename = sal.symtab.filename.split('/')[-1]
        line = sal.line
    else:
        filename = "??"
        line = 0
    
    # 打印追蹤訊息
    print(f"TRACE|{func_name}|{filename}|{line}")
    
    # 也可以打印呼叫堆疊深度
    depth = 0
    f = frame
    while f:
        depth += 1
        f = f.older()
    print(f"DEPTH|{depth}")

# 註冊命令
TraceFunctions()

# 執行追蹤
trace-all
run
end

quit
EOF

# 執行 GDB
echo "Starting GDB trace for $PROGRAM..."
gdb -batch -x trace_commands.gdb ./$PROGRAM 2&gt;/dev/null

echo "GDB trace completed. Check gdb_trace.log"
</code></pre>
<h3 id="12-gdb-輸出轉換為圖表"><a class="header" href="#12-gdb-輸出轉換為圖表">1.2 GDB 輸出轉換為圖表</a></h3>
<pre><code class="language-python">#!/usr/bin/env python3
# gdb_to_graph.py

import re
import sys
from graphviz import Digraph

def parse_gdb_trace(filename='gdb_trace.log'):
    """解析 GDB 追蹤檔案"""
    traces = []
    
    with open(filename, 'r') as f:
        for line in f:
            if line.startswith('TRACE|'):
                parts = line.strip().split('|')
                if len(parts) &gt;= 4:
                    func = parts[1]
                    file = parts[2]
                    line_no = parts[3]
                    traces.append({
                        'func': func,
                        'file': file,
                        'line': line_no
                    })
    
    return traces

def create_flow_graph(traces, output='gdb_flow'):
    """建立流程圖"""
    dot = Digraph(comment='GDB Program Flow')
    dot.attr(rankdir='TB')
    dot.attr('node', shape='box', style='rounded,filled', fillcolor='lightblue')
    
    # 建立節點
    for i, trace in enumerate(traces):
        node_id = str(i)
        label = f"{trace['func']}\\n{trace['file']}:{trace['line']}"
        
        # 特殊顏色標記
        if trace['func'] == 'main':
            dot.node(node_id, label, fillcolor='lightgreen')
        elif 'Calculator' in trace['func']:
            dot.node(node_id, label, fillcolor='lightyellow')
        elif 'fibonacci' in trace['func']:
            dot.node(node_id, label, fillcolor='lightcoral')
        else:
            dot.node(node_id, label)
        
        # 建立邊
        if i &gt; 0:
            dot.edge(str(i-1), node_id)
    
    # 輸出
    dot.render(output, format='svg', cleanup=True)
    dot.render(output, format='png', cleanup=True)
    print(f"Generated {output}.svg and {output}.png")
    
    # 產生統計資訊
    print(f"\nTrace Statistics:")
    print(f"Total function calls: {len(traces)}")
    func_count = {}
    for trace in traces:
        func = trace['func']
        func_count[func] = func_count.get(func, 0) + 1
    
    print("\nFunction call frequency:")
    for func, count in sorted(func_count.items(), key=lambda x: x[1], reverse=True):
        print(f"  {func}: {count} times")

if __name__ == "__main__":
    traces = parse_gdb_trace()
    if traces:
        create_flow_graph(traces)
    else:
        print("No traces found in gdb_trace.log")
</code></pre>
<h2 id="方法二uftrace-追蹤"><a class="header" href="#方法二uftrace-追蹤">方法二：uftrace 追蹤</a></h2>
<h3 id="21-uftrace-追蹤腳本"><a class="header" href="#21-uftrace-追蹤腳本">2.1 uftrace 追蹤腳本</a></h3>
<pre><code class="language-bash">#!/bin/bash
# uftrace_trace.sh

# 檢查參數
if [ $# -eq 0 ]; then
    echo "Usage: $0 &lt;program_name&gt;"
    exit 1
fi

PROGRAM=$1
PROGRAM_BASE="${PROGRAM%.*}"

# 檢查 uftrace 是否安裝
if ! command -v uftrace &amp;&gt; /dev/null; then
    echo "uftrace is not installed. Please install it first."
    exit 1
fi

# 對於 C/C++ 程式，需要重新編譯
if [[ $PROGRAM == *.cpp ]] || [[ $PROGRAM == *.c ]]; then
    echo "Recompiling with instrumentation..."
    if [[ $PROGRAM == *.cpp ]]; then
        g++ -pg -g -O0 $PROGRAM -o ${PROGRAM_BASE}_traced
    else
        gcc -pg -g -O0 $PROGRAM -o ${PROGRAM_BASE}_traced
    fi
    EXEC_PROGRAM="${PROGRAM_BASE}_traced"
else
    EXEC_PROGRAM=$PROGRAM
fi

# 執行 uftrace 追蹤
echo "=== Running uftrace ==="
uftrace record -d uftrace_data ./$EXEC_PROGRAM

# 產生各種輸出格式
echo -e "\n=== Text Report ==="
uftrace report -d uftrace_data | head -20

echo -e "\n=== Call Graph ==="
uftrace graph -d uftrace_data | head -30

echo -e "\n=== Detailed Trace ==="
uftrace replay -d uftrace_data --no-pager &gt; uftrace_trace.txt

# 輸出為 Chrome Tracing 格式
uftrace dump -d uftrace_data --chrome &gt; trace.json 2&gt;/dev/null
echo "Chrome trace saved to trace.json (view at chrome://tracing)"

# 輸出為 FlameGraph 格式
uftrace dump -d uftrace_data --flame-graph &gt; flame.txt 2&gt;/dev/null
echo "FlameGraph data saved to flame.txt"

# 產生時間統計
echo -e "\n=== Time Statistics ==="
uftrace report -d uftrace_data -s total,self,call | head -20
</code></pre>
<h3 id="22-uftrace-輸出轉換為圖表"><a class="header" href="#22-uftrace-輸出轉換為圖表">2.2 uftrace 輸出轉換為圖表</a></h3>
<pre><code class="language-python">#!/usr/bin/env python3
# uftrace_to_graph.py

import re
import json
from graphviz import Digraph

def parse_uftrace_replay(filename='uftrace_trace.txt'):
    """解析 uftrace replay 輸出"""
    traces = []
    call_stack = []
    time_pattern = r'\[([\d.]+)\s*us\]'
    
    with open(filename, 'r') as f:
        for line in f:
            # 解析時間戳記
            time_match = re.search(time_pattern, line)
            timestamp = time_match.group(1) if time_match else None
            
            # 解析函數進入
            enter_match = re.search(r'\|\s*([\w:]+)\(\)', line)
            if enter_match and '{' in line:
                func = enter_match.group(1)
                indent = line.count(' ') - len(line.lstrip())
                
                traces.append({
                    'type': 'enter',
                    'func': func,
                    'depth': len(call_stack),
                    'time': timestamp
                })
                call_stack.append(func)
            
            # 解析函數退出
            elif '}' in line:
                if call_stack:
                    func = call_stack.pop()
                    # 提取執行時間
                    time_match = re.search(r'([\d.]+)\s*us', line)
                    exec_time = time_match.group(1) if time_match else None
                    
                    traces.append({
                        'type': 'exit',
                        'func': func,
                        'depth': len(call_stack),
                        'exec_time': exec_time
                    })
    
    return traces

def create_uftrace_graph(traces, output='uftrace_flow'):
    """建立 uftrace 流程圖"""
    dot = Digraph(comment='uftrace Program Flow')
    dot.attr(rankdir='TB')
    dot.attr('graph', splines='ortho')
    
    # 記錄函數呼叫關係
    edges = set()
    call_stack = []
    node_counter = {}
    exec_times = {}
    
    for trace in traces:
        func = trace['func']
        
        if trace['type'] == 'enter':
            # 為每個函數呼叫建立唯一節點
            if func not in node_counter:
                node_counter[func] = 0
            node_counter[func] += 1
            
            node_id = f"{func}_{node_counter[func]}"
            
            # 設定節點樣式
            if func == 'main':
                color = 'lightgreen'
            elif 'fibonacci' in func:
                color = 'lightcoral'
            elif 'Calculator' in func or 'add' in func or 'multiply' in func:
                color = 'lightyellow'
            else:
                color = 'lightblue'
            
            # 節點標籤
            label = func
            if trace.get('time'):
                label += f"\\n@{trace['time']}us"
            
            dot.node(node_id, label, shape='box', 
                    style='rounded,filled', fillcolor=color)
            
            # 建立邊
            if call_stack:
                parent = call_stack[-1]
                edge = (parent, node_id)
                if edge not in edges:
                    dot.edge(parent, node_id)
                    edges.add(edge)
            
            call_stack.append(node_id)
            exec_times[node_id] = None
            
        elif trace['type'] == 'exit' and call_stack:
            node_id = call_stack.pop()
            if trace.get('exec_time'):
                exec_times[node_id] = trace['exec_time']
    
    # 輸出圖表
    dot.render(output, format='svg', cleanup=True)
    dot.render(output, format='png', cleanup=True)
    print(f"Generated {output}.svg and {output}.png")
    
    return exec_times

def create_summary_graph(filename='uftrace_trace.txt', output='uftrace_summary'):
    """建立函數呼叫統計圖"""
    dot = Digraph(comment='Function Call Summary')
    dot.attr(rankdir='LR')
    
    # 統計函數呼叫次數和時間
    call_count = {}
    call_relations = {}
    exec_times = {}
    
    with open(filename, 'r') as f:
        current_caller = None
        for line in f:
            match = re.search(r'\|\s*([\w:]+)\(\)', line)
            if match:
                func = match.group(1)
                call_count[func] = call_count.get(func, 0) + 1
                
                # 提取執行時間
                time_match = re.search(r'([\d.]+)\s*us', line)
                if time_match and '}' in line:
                    time = float(time_match.group(1))
                    if func not in exec_times:
                        exec_times[func] = []
                    exec_times[func].append(time)
                
                if current_caller and current_caller != func:
                    key = (current_caller, func)
                    call_relations[key] = call_relations.get(key, 0) + 1
                
                if '{' in line:
                    current_caller = func
    
    # 建立節點（顯示呼叫次數和平均時間）
    for func, count in call_count.items():
        label = f"{func}\\n(called {count}x)"
        if func in exec_times and exec_times[func]:
            avg_time = sum(exec_times[func]) / len(exec_times[func])
            label += f"\\navg: {avg_time:.2f}us"
        
        dot.node(func, label, shape='box', style='filled', 
                fillcolor='lightblue')
    
    # 建立邊（顯示呼叫關係）
    for (caller, callee), count in call_relations.items():
        label = f"{count}x" if count &gt; 1 else ""
        dot.edge(caller, callee, label=label)
    
    dot.render(output, format='svg', cleanup=True)
    print(f"Generated {output}.svg")

if __name__ == "__main__":
    # 解析並產生流程圖
    traces = parse_uftrace_replay()
    if traces:
        exec_times = create_uftrace_graph(traces)
        create_summary_graph()
        
        # 打印執行時間統計
        print("\nExecution Time Statistics:")
        func_times = {}
        for trace in traces:
            if trace['type'] == 'exit' and trace.get('exec_time'):
                func = trace['func']
                if func not in func_times:
                    func_times[func] = []
                func_times[func].append(float(trace['exec_time']))
        
        for func, times in sorted(func_times.items()):
            avg = sum(times) / len(times)
            total = sum(times)
            print(f"  {func}: avg={avg:.2f}us, total={total:.2f}us, calls={len(times)}")
    else:
        print("No traces found in uftrace_trace.txt")
</code></pre>
<h2 id="rust-支援"><a class="header" href="#rust-支援">Rust 支援</a></h2>
<h3 id="rust-與-gdb"><a class="header" href="#rust-與-gdb">Rust 與 GDB</a></h3>
<p>Rust 完全支援 GDB 除錯：</p>
<pre><code class="language-bash"># 編譯 Rust 程式（包含除錯符號）
rustc -g test_program.rs -o test_program

# 或使用 cargo
cargo build

# 使用 GDB 追蹤（同樣的腳本）
./gdb_trace.sh test_program
</code></pre>
<p><strong>注意事項：</strong></p>
<ul>
<li>Rust 函數名會被 mangle，看起來像 <code>_ZN4test11process_data17h...</code></li>
<li>可以使用 <code>rust-gdb</code> 獲得更好的支援</li>
<li>在 GDB 中使用 <code>set print demangle on</code> 顯示可讀名稱</li>
</ul>
<h3 id="rust-與-uftrace"><a class="header" href="#rust-與-uftrace">Rust 與 uftrace</a></h3>
<p>Rust 對 uftrace 的支援較為有限：</p>
<pre><code class="language-bash"># 方法 1：使用 -C instrument-coverage
rustc -C instrument-coverage -g test_program.rs -o test_program

# 方法 2：使用 -Z instrument-mcount (需要 nightly)
rustc +nightly -Z instrument-mcount -g test_program.rs -o test_program

# 方法 3：使用 cargo-flamegraph (推薦)
cargo install flamegraph
cargo flamegraph
</code></pre>
<h3 id="rust-專用工具"><a class="header" href="#rust-專用工具">Rust 專用工具</a></h3>
<h4 id="1-cargo-profiling"><a class="header" href="#1-cargo-profiling">1. cargo-profiling</a></h4>
<pre><code class="language-bash">cargo install cargo-profiling
cargo profiling callgrind
cargo profiling cachegrind
</code></pre>
<h4 id="2-tokio-console-for-async"><a class="header" href="#2-tokio-console-for-async">2. tokio-console (for async)</a></h4>
<pre><code class="language-toml"># Cargo.toml
[dependencies]
tokio = { version = "1", features = ["full", "tracing"] }
console-subscriber = "0.1"
</code></pre>
<pre><pre class="playground"><code class="language-rust">#[tokio::main]
async fn main() {
    console_subscriber::init();
    // your async code
}</code></pre></pre>
<h4 id="3-tracing-crate"><a class="header" href="#3-tracing-crate">3. tracing crate</a></h4>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use tracing::{info, instrument};

#[instrument]
fn process_data() {
    info!("Processing data");
    // ...
}
<span class="boring">}</span></code></pre></pre>
<h2 id="完整執行腳本"><a class="header" href="#完整執行腳本">完整執行腳本</a></h2>
<pre><code class="language-bash">#!/bin/bash
# run_all_traces.sh

echo "========================================="
echo "Program Flow Tracing Tool"
echo "========================================="

# 檢查參數
if [ $# -eq 0 ]; then
    echo "Usage: $0 &lt;source_file&gt;"
    echo "Example: $0 test_program.cpp"
    echo "         $0 test_program.rs"
    exit 1
fi

SOURCE_FILE=$1
FILE_EXT="${SOURCE_FILE##*.}"
BASE_NAME="${SOURCE_FILE%.*}"

# 編譯程式
echo "Compiling $SOURCE_FILE..."
case $FILE_EXT in
    cpp|cc|cxx)
        g++ -g -O0 -pg $SOURCE_FILE -o $BASE_NAME
        ;;
    c)
        gcc -g -O0 -pg $SOURCE_FILE -o $BASE_NAME
        ;;
    rs)
        rustc -g $SOURCE_FILE -o $BASE_NAME
        ;;
    *)
        echo "Unsupported file type: $FILE_EXT"
        exit 1
        ;;
esac

# 方法 1: GDB
echo -e "\n[1] Running GDB trace..."
./gdb_trace.sh $BASE_NAME
python3 gdb_to_graph.py

# 方法 2: uftrace (C/C++ only)
if [[ $FILE_EXT != "rs" ]]; then
    echo -e "\n[2] Running uftrace..."
    ./uftrace_trace.sh $SOURCE_FILE
    python3 uftrace_to_graph.py
else
    echo -e "\n[2] uftrace not fully supported for Rust"
fi

# 產生火焰圖 (if available)
if [ -f flame.txt ]; then
    echo -e "\n[3] Generating FlameGraph..."
    if [ ! -d FlameGraph ]; then
        git clone https://github.com/brendangregg/FlameGraph 2&gt;/dev/null
    fi
    cat flame.txt | ./FlameGraph/flamegraph.pl &gt; flamegraph.svg
    echo "FlameGraph saved to flamegraph.svg"
fi

echo -e "\n========================================="
echo "Completed! Generated files:"
ls -la *.svg *.png *.json 2&gt;/dev/null | grep -E "\.(svg|png|json)$"
echo "========================================="
</code></pre>
<h2 id="比較與選擇"><a class="header" href="#比較與選擇">比較與選擇</a></h2>
<div class="table-wrapper"><table><thead><tr><th>特性</th><th>GDB</th><th>uftrace</th></tr></thead><tbody>
<tr><td><strong>語言支援</strong></td><td>C/C++/Rust/Go 等</td><td>主要 C/C++</td></tr>
<tr><td><strong>效能開銷</strong></td><td>高（中斷點）</td><td>低（instrumentation）</td></tr>
<tr><td><strong>執行時間</strong></td><td>有</td><td>有（精確）</td></tr>
<tr><td><strong>編譯需求</strong></td><td>-g（除錯符號）</td><td>-pg 或 -finstrument-functions</td></tr>
<tr><td><strong>即時追蹤</strong></td><td>是</td><td>是</td></tr>
<tr><td><strong>輸出格式</strong></td><td>自訂</td><td>多種（Chrome、Flame、文字）</td></tr>
<tr><td><strong>學習曲線</strong></td><td>陡峭</td><td>平緩</td></tr>
<tr><td><strong>適用場景</strong></td><td>除錯、深入分析</td><td>效能分析、流程追蹤</td></tr>
</tbody></table>
</div>
<h3 id="建議選擇"><a class="header" href="#建議選擇">建議選擇</a></h3>
<ul>
<li><strong>簡單流程追蹤</strong>：uftrace</li>
<li><strong>詳細除錯分析</strong>：GDB</li>
<li><strong>效能分析</strong>：uftrace + FlameGraph</li>
<li><strong>Rust 專案</strong>：GDB 或 cargo-flamegraph</li>
<li><strong>生產環境</strong>：uftrace（開銷較小）</li>
</ul>
<h2 id="常見問題與解決方案"><a class="header" href="#常見問題與解決方案">常見問題與解決方案</a></h2>
<h3 id="-已解決問題-2024-09-29"><a class="header" href="#-已解決問題-2024-09-29">✅ 已解決問題 (2024-09-29)</a></h3>
<h4 id="q1-makefile-顏色碼不顯示顯示-033032m"><a class="header" href="#q1-makefile-顏色碼不顯示顯示-033032m">Q1: Makefile 顏色碼不顯示（顯示 <code>\033[0;32m</code>）</a></h4>
<p><strong>解決方案</strong>：將所有 <code>echo</code> 改為 <code>printf</code></p>
<pre><code class="language-makefile"># 錯誤寫法
@echo "$(GREEN)完成$(NC)"

# 正確寫法
@printf "$(GREEN)完成$(NC)\n"
</code></pre>
<h4 id="q2-gdb-logging-檔名衝突"><a class="header" href="#q2-gdb-logging-檔名衝突">Q2: GDB logging 檔名衝突</a></h4>
<p><strong>解決方案</strong>：在設定新的 log 檔案前先關閉 logging</p>
<pre><code class="language-gdb">set logging enabled off
set logging file gdb_trace.log
set logging overwrite on
set logging enabled on
</code></pre>
<h4 id="q3-makefile-heredoc-語法錯誤"><a class="header" href="#q3-makefile-heredoc-語法錯誤">Q3: Makefile heredoc 語法錯誤</a></h4>
<p><strong>解決方案</strong>：改用檔案複製或 echo 逐行寫入</p>
<pre><code class="language-makefile"># 改為直接複製已存在的檔案
@cp test_program.cpp $(CPP_SOURCE)
</code></pre>
<h3 id="-常見技術問題"><a class="header" href="#-常見技術問題">📋 常見技術問題</a></h3>
<h4 id="q1-gdb-追蹤太慢怎麼辦"><a class="header" href="#q1-gdb-追蹤太慢怎麼辦">Q1: GDB 追蹤太慢怎麼辦？</a></h4>
<p>可以只追蹤特定函數：</p>
<pre><code class="language-gdb">rbreak ^process_.*  # 只追蹤 process_ 開頭的函數
break main
break fibonacci
</code></pre>
<h4 id="q2-uftrace-沒有輸出"><a class="header" href="#q2-uftrace-沒有輸出">Q2: uftrace 沒有輸出？</a></h4>
<p>檢查編譯選項：</p>
<pre><code class="language-bash"># 確保使用了 -pg 或 -finstrument-functions
nm your_program | grep mcount  # 應該要看到 mcount
</code></pre>
<h4 id="q3-rust-函數名太長"><a class="header" href="#q3-rust-函數名太長">Q3: Rust 函數名太長？</a></h4>
<p>使用 rustfilt 工具：</p>
<pre><code class="language-bash">cargo install rustfilt
cat trace.log | rustfilt
</code></pre>
<h4 id="q4-如何過濾系統函數"><a class="header" href="#q4-如何過濾系統函數">Q4: 如何過濾系統函數？</a></h4>
<p>GDB:</p>
<pre><code class="language-gdb">rbreak ^[^_].*  # 排除 _ 開頭的函數
</code></pre>
<p>uftrace:</p>
<pre><code class="language-bash">uftrace record -F main -F process_data ./program  # 只追蹤特定函數
uftrace record -N printf -N malloc ./program      # 排除特定函數
</code></pre>
<h4 id="q5-圖表太複雜怎麼簡化"><a class="header" href="#q5-圖表太複雜怎麼簡化">Q5: 圖表太複雜怎麼簡化？</a></h4>
<p>修改 Python 腳本，加入過濾：</p>
<pre><code class="language-python"># 只顯示執行超過 N 次的函數
MIN_CALLS = 2
filtered = [t for t in traces if call_count[t['func']] &gt;= MIN_CALLS]
</code></pre>
<h2 id="進階技巧"><a class="header" href="#進階技巧">進階技巧</a></h2>
<h3 id="結合-perf-使用"><a class="header" href="#結合-perf-使用">結合 perf 使用</a></h3>
<pre><code class="language-bash"># 記錄
perf record -g ./program

# 產生火焰圖
perf script | ./FlameGraph/stackcollapse-perf.pl | ./FlameGraph/flamegraph.pl &gt; perf.svg
</code></pre>
<h3 id="自動化-cicd-整合"><a class="header" href="#自動化-cicd-整合">自動化 CI/CD 整合</a></h3>
<pre><code class="language-yaml"># .github/workflows/trace.yml
name: Trace Analysis
on: [push]
jobs:
  trace:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb graphviz
          pip install graphviz
      - name: Build and trace
        run: |
          make build
          ./run_all_traces.sh main.cpp
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: trace-graphs
          path: "*.svg"
</code></pre>
<h3 id="即時監控"><a class="header" href="#即時監控">即時監控</a></h3>
<pre><code class="language-bash"># 使用 watch 即時更新
watch -n 1 'uftrace report -d uftrace_data | head -20'

# 使用 tail 追蹤日誌
tail -f gdb_trace.log | grep "TRACE"
</code></pre>
<h2 id="參考資源"><a class="header" href="#參考資源">參考資源</a></h2>
<ul>
<li><a href="https://www.gnu.org/software/gdb/documentation/">GDB Documentation</a></li>
<li><a href="https://github.com/namhyung/uftrace">uftrace GitHub</a></li>
<li><a href="https://github.com/brendangregg/FlameGraph">Flamegraph</a></li>
<li><a href="https://nnethercote.github.io/perf-book/">Rust Profiling Book</a></li>
<li><a href="chrome://tracing">Chrome Tracing</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../gdb/gdb-auto-continue-guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../vim/vim.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../gdb/gdb-auto-continue-guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../vim/vim.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
