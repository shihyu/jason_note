<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>GDB EX 完整指南 - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="gdb-自動化除錯完整指南"><a class="header" href="#gdb-自動化除錯完整指南">GDB 自動化除錯完整指南</a></h1>
<h2 id="第一部分gdb-命令行參數指南"><a class="header" href="#第一部分gdb-命令行參數指南">第一部分：GDB 命令行參數指南</a></h2>
<h3 id="快速參考"><a class="header" href="#快速參考">快速參考</a></h3>
<h4 id="基本用法"><a class="header" href="#基本用法">基本用法</a></h4>
<pre><code class="language-bash">gdb [選項] [程式檔案] [核心檔案或進程ID]
</code></pre>
<h2 id="四種執行腳本的方法"><a class="header" href="#四種執行腳本的方法">四種執行腳本的方法</a></h2>
<h3 id="方法-1使用--x-參數"><a class="header" href="#方法-1使用--x-參數">方法 1：使用 <code>-x</code> 參數</a></h3>
<pre><code class="language-bash">gdb -x script.gdb ./program
</code></pre>
<p><strong>範例：</strong></p>
<pre><code class="language-bash"># 創建腳本檔案 debug.gdb
echo "break main
run
continue" &gt; debug.gdb

# 執行
gdb -x debug.gdb ./myapp
</code></pre>
<h3 id="方法-2使用---command-參數"><a class="header" href="#方法-2使用---command-參數">方法 2：使用 <code>--command</code> 參數</a></h3>
<pre><code class="language-bash">gdb --command=script.gdb ./program
</code></pre>
<p><strong>範例：</strong></p>
<pre><code class="language-bash"># 與方法 1 相同效果
gdb --command=debug.gdb ./myapp
</code></pre>
<h3 id="方法-3使用--ex-執行命令"><a class="header" href="#方法-3使用--ex-執行命令">方法 3：使用 <code>-ex</code> 執行命令</a></h3>
<pre><code class="language-bash">gdb ./program -ex "source script.gdb"
</code></pre>
<p><strong>範例：</strong></p>
<pre><code class="language-bash"># 執行多個命令
gdb ./myapp \
  -ex "break main" \
  -ex "break func1" \
  -ex "run arg1 arg2" \
  -ex "continue"

# 載入腳本並執行
gdb ./myapp -ex "source debug.gdb" -ex "run"
</code></pre>
<h3 id="方法-4批次模式--batch"><a class="header" href="#方法-4批次模式--batch">方法 4：批次模式 <code>-batch</code></a></h3>
<pre><code class="language-bash">gdb -batch -x script.gdb ./program
</code></pre>
<p><strong>範例：</strong></p>
<pre><code class="language-bash"># 創建自動化測試腳本 test.gdb
cat &gt; test.gdb &lt;&lt; 'EOF'
break main
run
print variable1
backtrace
quit
EOF

# 批次執行（執行完自動退出）
gdb -batch -x test.gdb ./myapp &gt; test_output.txt
</code></pre>
<h2 id="方法對比"><a class="header" href="#方法對比">方法對比</a></h2>
<div class="table-wrapper"><table><thead><tr><th>特性</th><th><code>-x</code> / <code>--command</code></th><th><code>-ex</code></th><th><code>-batch</code></th></tr></thead><tbody>
<tr><td><strong>互動模式</strong></td><td>✓</td><td>✓</td><td>✗</td></tr>
<tr><td><strong>執行後停留</strong></td><td>✓</td><td>✓</td><td>✗</td></tr>
<tr><td><strong>多命令支援</strong></td><td>腳本內</td><td>多個 -ex</td><td>腳本內</td></tr>
<tr><td><strong>自動化</strong></td><td>✗</td><td>✗</td><td>✓</td></tr>
<tr><td><strong>顯示提示符</strong></td><td>✓</td><td>✓</td><td>✗</td></tr>
</tbody></table>
</div>
<h2 id="實用範例"><a class="header" href="#實用範例">實用範例</a></h2>
<h3 id="1-rust-程式除錯"><a class="header" href="#1-rust-程式除錯">1. Rust 程式除錯</a></h3>
<pre><code class="language-bash"># 創建 Rust 除錯腳本
cat &gt; rust_debug.gdb &lt;&lt; 'EOF'
set print pretty on
set print array on
break panic_impl
break rust_panic
run
EOF

# 執行
gdb -x rust_debug.gdb ./target/debug/myapp
</code></pre>
<h3 id="2-自動化測試"><a class="header" href="#2-自動化測試">2. 自動化測試</a></h3>
<pre><code class="language-bash"># 批次測試，輸出到檔案
gdb -batch -x test_suite.gdb ./app 2&gt;&amp;1 | tee test_results.log

# CI/CD 中使用
gdb -batch -ex "run" -ex "bt" -ex "quit" ./app core.dump
</code></pre>
<h3 id="3-快速除錯會話"><a class="header" href="#3-快速除錯會話">3. 快速除錯會話</a></h3>
<pre><code class="language-bash"># 設定斷點並執行
gdb ./app -ex "b main" -ex "r" -ex "n" -ex "p argc"

# 附加到執行中的進程
gdb -p 1234 -ex "bt" -ex "info threads"
</code></pre>
<h3 id="4-載入多個設定"><a class="header" href="#4-載入多個設定">4. 載入多個設定</a></h3>
<pre><code class="language-bash"># 載入符號和設定
gdb ./app \
  -ex "set sysroot /path/to/sysroot" \
  -ex "set solib-search-path /path/to/libs" \
  -ex "source ~/.gdbinit.local" \
  -ex "run"
</code></pre>
<h2 id="其他實用參數"><a class="header" href="#其他實用參數">其他實用參數</a></h2>
<div class="table-wrapper"><table><thead><tr><th>參數</th><th>說明</th><th>範例</th></tr></thead><tbody>
<tr><td><code>-q</code> / <code>--quiet</code></td><td>安靜模式（不顯示版權信息）</td><td><code>gdb -q ./app</code></td></tr>
<tr><td><code>-p PID</code></td><td>附加到進程</td><td><code>gdb -p 1234</code></td></tr>
<tr><td><code>-c core</code></td><td>載入核心轉儲</td><td><code>gdb ./app -c core.dump</code></td></tr>
<tr><td><code>-d dir</code></td><td>新增原始碼目錄</td><td><code>gdb -d /src/path ./app</code></td></tr>
<tr><td><code>--args</code></td><td>傳遞參數給程式</td><td><code>gdb --args ./app arg1 arg2</code></td></tr>
<tr><td><code>-tui</code></td><td>啟用文字介面</td><td><code>gdb -tui ./app</code></td></tr>
</tbody></table>
</div>
<h2 id="建議使用場景"><a class="header" href="#建議使用場景">建議使用場景</a></h2>
<ul>
<li><strong>互動除錯</strong>：使用方法 1 (<code>-x</code>) 或方法 3 (<code>-ex</code>)</li>
<li><strong>自動化測試</strong>：使用方法 4 (<code>-batch</code>)</li>
<li><strong>快速命令</strong>：使用方法 3 (<code>-ex</code>)</li>
<li><strong>複雜腳本</strong>：使用方法 1 (<code>-x</code>) 配合腳本檔案</li>
</ul>
<hr />
<h2 id="第二部分gdb--ex-自動化實戰"><a class="header" href="#第二部分gdb--ex-自動化實戰">第二部分：GDB -ex 自動化實戰</a></h2>
<h3 id="核心概念"><a class="header" href="#核心概念">核心概念</a></h3>
<p><code>gdb -ex</code> 的核心優勢是<strong>自動化</strong>和<strong>腳本化</strong>！最實用的技巧包括：</p>
<h3 id="-最常用的組合"><a class="header" href="#-最常用的組合">🚀 最常用的組合</a></h3>
<pre><code class="language-bash"># 1. 快速崩潰分析（最實用！）
gdb -batch -ex "run" -ex "bt" -ex "quit" ./program

# 2. 一行命令除錯
gdb -ex "b main" -ex "r" -ex "n" -ex "n" -ex "p result" ./demo

# 3. 自動生成報告
gdb -batch -ex "info functions" -ex "info variables" ./program &gt; symbols.txt

# 4. CI/CD 整合測試
gdb -batch -ex "run &lt; test.txt" -ex "quit" ./program || exit 1
</code></pre>
<h3 id="-進階技巧"><a class="header" href="#-進階技巧">💡 進階技巧</a></h3>
<pre><code class="language-bash"># 監控執行中的程式
gdb -batch -ex "attach $(pidof server)" -ex "bt" -ex "detach"

# 批量分析 core dumps
for core in *.core; do
    gdb -batch -ex "bt" ./program $core
done

# 效能分析
gdb -ex "b calculate" -ex "commands" -ex "silent" -ex "set \$count++" -ex "c" -ex "end" -ex "r" -ex "p \$count" ./demo
</code></pre>
<p>最大的好處是可以將 GDB 整合到各種自動化工作流程中，不需要人工互動！</p>
<hr />
<h2 id="-完整範例專案"><a class="header" href="#-完整範例專案">📁 完整範例專案</a></h2>
<h3 id="1-測試程式-test_programc"><a class="header" href="#1-測試程式-test_programc">1. 測試程式 (test_program.c)</a></h3>
<pre><code class="language-c">// test_program.c - 包含各種測試場景的範例程式
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;signal.h&gt;

// 全域變數用於測試
int global_counter = 0;
char global_buffer[256];

// 函式1: 可能造成 segfault
void dangerous_function(char *input) {
    char buffer[10];
    strcpy(buffer, input);  // 潛在的 buffer overflow
    printf("Buffer: %s\n", buffer);
}

// 函式2: 遞迴函式
int factorial(int n) {
    global_counter++;
    if (n &lt;= 1) return 1;
    return n * factorial(n - 1);
}

// 函式3: 記憶體洩漏
void memory_leak() {
    for (int i = 0; i &lt; 10; i++) {
        char *leak = malloc(1024);
        sprintf(leak, "Leak #%d", i);
        // 故意不 free
    }
}

// 函式4: 無限迴圈
void infinite_loop() {
    int i = 0;
    while (1) {
        i++;
        if (i % 1000000 == 0) {
            printf("Still running... %d\n", i);
        }
    }
}

// 函式5: 正常計算
int calculate(int a, int b, char op) {
    switch(op) {
        case '+': return a + b;
        case '-': return a - b;
        case '*': return a * b;
        case '/': return b != 0 ? a / b : 0;
        default: return 0;
    }
}

int main(int argc, char *argv[]) {
    printf("Test Program Started (PID: %d)\n", getpid());
    
    if (argc &lt; 2) {
        printf("Usage: %s &lt;test_number&gt;\n", argv[0]);
        printf("Tests:\n");
        printf("  1 - Normal execution\n");
        printf("  2 - Segmentation fault\n");
        printf("  3 - Memory leak\n");
        printf("  4 - Infinite loop\n");
        printf("  5 - Factorial calculation\n");
        return 1;
    }
    
    int test = atoi(argv[1]);
    
    switch(test) {
        case 1:
            printf("Normal execution test\n");
            printf("5 + 3 = %d\n", calculate(5, 3, '+'));
            printf("5 * 3 = %d\n", calculate(5, 3, '*'));
            break;
            
        case 2:
            printf("Triggering segfault...\n");
            dangerous_function("This string is way too long for the buffer!");
            break;
            
        case 3:
            printf("Creating memory leaks...\n");
            memory_leak();
            printf("Memory leaked successfully\n");
            break;
            
        case 4:
            printf("Starting infinite loop...\n");
            infinite_loop();
            break;
            
        case 5:
            printf("Calculating factorial...\n");
            int result = factorial(10);
            printf("10! = %d\n", result);
            printf("Function called %d times\n", global_counter);
            break;
            
        default:
            printf("Invalid test number\n");
            return 1;
    }
    
    printf("Test completed\n");
    return 0;
}
</code></pre>
<h3 id="2-自動化除錯腳本-auto_debugsh"><a class="header" href="#2-自動化除錯腳本-auto_debugsh">2. 自動化除錯腳本 (auto_debug.sh)</a></h3>
<pre><code class="language-bash">#!/bin/bash
# auto_debug.sh - 完整的 GDB 自動化除錯腳本

# 顏色定義
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 設定變數
PROGRAM="test_program"
SOURCE="test_program.c"
DEBUG_LOG="debug_report_$(date +%Y%m%d_%H%M%S).log"

# 編譯函式
compile_program() {
    echo -e "${BLUE}[*] 編譯程式...${NC}"
    gcc -g -O0 -o $PROGRAM $SOURCE
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[✓] 編譯成功${NC}"
    else
        echo -e "${RED}[✗] 編譯失敗${NC}"
        exit 1
    fi
}

# 測試1: 快速崩潰分析
test_crash_analysis() {
    echo -e "\n${YELLOW}=== 測試1: 快速崩潰分析 ===${NC}"
    
    echo "執行會崩潰的程式..."
    gdb -batch \
        -ex "run 2" \
        -ex "bt" \
        -ex "info registers" \
        -ex "info frame" \
        -ex "quit" \
        ./$PROGRAM 2&gt;&amp;1 | tee crash_analysis.log
    
    if grep -q "Segmentation fault" crash_analysis.log; then
        echo -e "${RED}[!] 偵測到 Segmentation fault${NC}"
        echo "詳細資訊已儲存至 crash_analysis.log"
    fi
}

# 測試2: 函式呼叫計數
test_function_calls() {
    echo -e "\n${YELLOW}=== 測試2: 函式呼叫計數 ===${NC}"
    
    result=$(gdb -batch \
        -ex "break factorial" \
        -ex "commands" \
        -ex "silent" \
        -ex "set \$count = \$count + 1" \
        -ex "continue" \
        -ex "end" \
        -ex "set \$count = 0" \
        -ex "run 5" \
        -ex "printf \"factorial 被呼叫了 %d 次\\n\", \$count" \
        -ex "quit" \
        ./$PROGRAM 2&gt;&amp;1)
    
    echo "$result" | grep "factorial"
}

# 測試3: 記憶體分析
test_memory_analysis() {
    echo -e "\n${YELLOW}=== 測試3: 記憶體分析 ===${NC}"
    
    gdb -batch \
        -ex "break malloc" \
        -ex "commands" \
        -ex "silent" \
        -ex "printf \"malloc called: size=%d\\n\", \$rdi" \
        -ex "backtrace 1" \
        -ex "continue" \
        -ex "end" \
        -ex "run 3" \
        -ex "quit" \
        ./$PROGRAM 2&gt;&amp;1 | grep -E "malloc|memory_leak"
}

# 測試4: 自動化變數監控
test_variable_watch() {
    echo -e "\n${YELLOW}=== 測試4: 變數監控 ===${NC}"
    
    gdb -batch \
        -ex "break main" \
        -ex "run 1" \
        -ex "watch global_counter" \
        -ex "continue" \
        -ex "info watchpoints" \
        -ex "quit" \
        ./$PROGRAM 2&gt;&amp;1 | head -20
}

# 測試5: 產生符號表報告
test_symbol_report() {
    echo -e "\n${YELLOW}=== 測試5: 符號表分析 ===${NC}"
    
    {
        echo "=== 函式列表 ==="
        gdb -batch -ex "info functions" ./$PROGRAM 2&gt;/dev/null | grep -E "^0x"
        
        echo -e "\n=== 全域變數 ==="
        gdb -batch -ex "info variables" ./$PROGRAM 2&gt;/dev/null | grep -E "^0x.*global"
        
        echo -e "\n=== 程式區段 ==="
        gdb -batch -ex "maintenance info sections" ./$PROGRAM 2&gt;/dev/null | grep -E "\.text|\.data|\.bss" | head -5
    } | tee symbols_report.txt
    
    echo -e "${GREEN}[✓] 符號報告已儲存至 symbols_report.txt${NC}"
}

# 測試6: CI/CD 整合測試
test_ci_integration() {
    echo -e "\n${YELLOW}=== 測試6: CI/CD 整合測試 ===${NC}"
    
    # 建立測試輸入
    echo "1" &gt; test_input.txt
    
    # 執行測試並檢查返回值
    echo "執行正常測試..."
    gdb -batch -ex "run 1" -ex "quit" ./$PROGRAM &gt; /dev/null 2&gt;&amp;1
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[✓] 測試通過${NC}"
    else
        echo -e "${RED}[✗] 測試失敗${NC}"
    fi
    
    # 測試崩潰偵測
    echo "執行崩潰測試..."
    gdb -batch -ex "run 2" -ex "quit" ./$PROGRAM &gt; /dev/null 2&gt;&amp;1
    if [ $? -ne 0 ]; then
        echo -e "${YELLOW}[!] 偵測到預期的崩潰${NC}"
    fi
}

# 測試7: 效能分析
test_performance() {
    echo -e "\n${YELLOW}=== 測試7: 效能分析 ===${NC}"
    
    # 計算執行時間
    gdb -batch \
        -ex "break main" \
        -ex "commands" \
        -ex "silent" \
        -ex "set \$start = clock()" \
        -ex "continue" \
        -ex "end" \
        -ex "break exit" \
        -ex "commands" \
        -ex "silent" \
        -ex "set \$end = clock()" \
        -ex "printf \"執行時間: %f 秒\\n\", (\$end - \$start) / 1000000.0" \
        -ex "continue" \
        -ex "end" \
        -ex "run 5" \
        -ex "quit" \
        ./$PROGRAM 2&gt;&amp;1 | grep "執行時間"
}

# 測試8: 批次 Core Dump 分析
test_core_dump() {
    echo -e "\n${YELLOW}=== 測試8: Core Dump 分析 ===${NC}"
    
    # 啟用 core dump
    ulimit -c unlimited
    
    # 觸發崩潰產生 core dump
    ./$PROGRAM 2 2&gt;/dev/null
    
    # 分析 core dump (如果存在)
    if [ -f core ]; then
        echo "分析 core dump..."
        gdb -batch \
            -ex "bt full" \
            -ex "info registers" \
            -ex "info locals" \
            -ex "quit" \
            ./$PROGRAM core | head -30
        rm -f core
    else
        echo "沒有產生 core dump (可能需要調整系統設定)"
    fi
}

# 測試9: 附加到執行中的程序
test_attach_process() {
    echo -e "\n${YELLOW}=== 測試9: 附加到執行中的程序 ===${NC}"
    
    # 啟動一個背景程序
    ./$PROGRAM 4 &gt; /dev/null 2&gt;&amp;1 &amp;
    PID=$!
    
    sleep 1
    
    if kill -0 $PID 2&gt;/dev/null; then
        echo "附加到 PID $PID..."
        sudo gdb -batch \
            -ex "attach $PID" \
            -ex "bt" \
            -ex "info threads" \
            -ex "detach" \
            -ex "quit" 2&gt;&amp;1 | grep -E "Attaching|Thread|infinite_loop"
        
        # 終止程序
        kill $PID 2&gt;/dev/null
    else
        echo "程序已結束"
    fi
}

# 測試10: 產生完整除錯報告
generate_full_report() {
    echo -e "\n${YELLOW}=== 產生完整除錯報告 ===${NC}"
    
    {
        echo "====================================="
        echo "     完整除錯報告"
        echo "     $(date)"
        echo "====================================="
        echo
        
        echo "[程式資訊]"
        file ./$PROGRAM
        echo
        
        echo "[符號表摘要]"
        gdb -batch -ex "info functions" ./$PROGRAM 2&gt;/dev/null | wc -l | xargs echo "函式數量:"
        gdb -batch -ex "info variables" ./$PROGRAM 2&gt;/dev/null | wc -l | xargs echo "變數數量:"
        echo
        
        echo "[反組譯 main 函式 (前10行)]"
        gdb -batch -ex "disassemble main" ./$PROGRAM 2&gt;/dev/null | head -10
        echo
        
        echo "[正常執行輸出]"
        gdb -batch -ex "run 1" -ex "quit" ./$PROGRAM 2&gt;&amp;1 | tail -5
        echo
        
        echo "[記憶體映射]"
        gdb -batch \
            -ex "break main" \
            -ex "run 1" \
            -ex "info proc mappings" \
            -ex "quit" \
            ./$PROGRAM 2&gt;&amp;1 | grep -E "Start|program|stack|heap" | head -10
        
    } | tee $DEBUG_LOG
    
    echo -e "\n${GREEN}[✓] 完整報告已儲存至 $DEBUG_LOG${NC}"
}

# 主選單
show_menu() {
    echo -e "\n${BLUE}╔════════════════════════════════════╗"
    echo -e "║    GDB -ex 自動化除錯示範選單      ║"
    echo -e "╚════════════════════════════════════╝${NC}"
    echo
    echo "1) 執行所有測試"
    echo "2) 快速崩潰分析"
    echo "3) 函式呼叫計數"
    echo "4) 記憶體分析"
    echo "5) 變數監控"
    echo "6) 符號表分析"
    echo "7) CI/CD 整合測試"
    echo "8) 效能分析"
    echo "9) Core Dump 分析"
    echo "10) 附加到執行中程序"
    echo "11) 產生完整報告"
    echo "0) 退出"
    echo
}

# 主程式
main() {
    # 編譯程式
    compile_program
    
    if [ "$1" == "--all" ]; then
        # 執行所有測試
        test_crash_analysis
        test_function_calls
        test_memory_analysis
        test_variable_watch
        test_symbol_report
        test_ci_integration
        test_performance
        test_core_dump
        test_attach_process
        generate_full_report
    else
        # 互動式選單
        while true; do
            show_menu
            read -p "請選擇 (0-11): " choice
            
            case $choice in
                1) 
                    test_crash_analysis
                    test_function_calls
                    test_memory_analysis
                    test_variable_watch
                    test_symbol_report
                    test_ci_integration
                    test_performance
                    test_core_dump
                    test_attach_process
                    generate_full_report
                    ;;
                2) test_crash_analysis ;;
                3) test_function_calls ;;
                4) test_memory_analysis ;;
                5) test_variable_watch ;;
                6) test_symbol_report ;;
                7) test_ci_integration ;;
                8) test_performance ;;
                9) test_core_dump ;;
                10) test_attach_process ;;
                11) generate_full_report ;;
                0) 
                    echo -e "${GREEN}再見！${NC}"
                    exit 0
                    ;;
                *)
                    echo -e "${RED}無效選擇${NC}"
                    ;;
            esac
            
            read -p "按 Enter 繼續..."
        done
    fi
}

# 清理函式
cleanup() {
    echo -e "\n${YELLOW}[*] 清理檔案...${NC}"
    rm -f core test_input.txt
}

# 設定信號處理
trap cleanup EXIT

# 執行主程式
main "$@"
</code></pre>
<h3 id="3-進階-python-整合腳本-gdb_automationpy"><a class="header" href="#3-進階-python-整合腳本-gdb_automationpy">3. 進階 Python 整合腳本 (gdb_automation.py)</a></h3>
<pre><code class="language-python">#!/usr/bin/env python3
# gdb_automation.py - GDB 自動化 Python 腳本

import subprocess
import os
import sys
import json
import time
from datetime import datetime

class GDBAutomation:
    def __init__(self, program):
        self.program = program
        self.results = {}
        
    def run_gdb_command(self, commands, test_args=""):
        """執行 GDB 命令並返回輸出"""
        cmd = ["gdb", "-batch"]
        for command in commands:
            cmd.extend(["-ex", command])
        cmd.append(self.program)
        
        if test_args:
            # 修改 run 命令以包含參數
            for i, c in enumerate(cmd):
                if c.startswith("run"):
                    cmd[i] = f"run {test_args}"
        
        try:
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
            return result.stdout
        except subprocess.TimeoutExpired:
            return "Timeout: 程式執行超時"
        except Exception as e:
            return f"Error: {str(e)}"
    
    def analyze_crash(self):
        """分析程式崩潰"""
        print("🔍 分析崩潰...")
        commands = [
            "run 2",
            "bt full",
            "info registers",
            "info frame",
            "quit"
        ]
        output = self.run_gdb_command(commands)
        
        # 解析輸出
        if "Segmentation fault" in output:
            crash_info = {
                "status": "crashed",
                "type": "Segmentation fault",
                "backtrace": self._extract_backtrace(output)
            }
        else:
            crash_info = {"status": "no crash"}
        
        self.results["crash_analysis"] = crash_info
        return crash_info
    
    def count_function_calls(self, function_name):
        """計算函式呼叫次數"""
        print(f"📊 計算 {function_name} 呼叫次數...")
        commands = [
            f"break {function_name}",
            "commands",
            "silent",
            "set $count = $count + 1",
            "continue",
            "end",
            "set $count = 0",
            "run 5",
            'printf "Count: %d\\n", $count',
            "quit"
        ]
        output = self.run_gdb_command(commands)
        
        # 提取計數
        import re
        match = re.search(r"Count: (\d+)", output)
        count = int(match.group(1)) if match else 0
        
        self.results[f"{function_name}_calls"] = count
        return count
    
    def profile_memory(self):
        """記憶體分析"""
        print("💾 分析記憶體使用...")
        commands = [
            "break malloc",
            "commands",
            "silent",
            'printf "malloc: %d bytes\\n", $rdi',
            "continue",
            "end",
            "run 3",
            "quit"
        ]
        output = self.run_gdb_command(commands)
        
        # 統計 malloc 呼叫
        mallocs = re.findall(r"malloc: (\d+) bytes", output)
        total_allocated = sum(int(m) for m in mallocs)
        
        self.results["memory_profile"] = {
            "malloc_calls": len(mallocs),
            "total_allocated": total_allocated
        }
        return self.results["memory_profile"]
    
    def generate_report(self):
        """產生 JSON 格式報告"""
        print("📝 產生報告...")
        
        report = {
            "timestamp": datetime.now().isoformat(),
            "program": self.program,
            "results": self.results
        }
        
        # 儲存為 JSON
        with open("gdb_report.json", "w") as f:
            json.dump(report, f, indent=2)
        
        # 產生 Markdown 報告
        self._generate_markdown_report()
        
        return report
    
    def _extract_backtrace(self, output):
        """從輸出中提取 backtrace"""
        lines = output.split('\n')
        backtrace = []
        for line in lines:
            if line.startswith('#'):
                backtrace.append(line.strip())
        return backtrace
    
    def _generate_markdown_report(self):
        """產生 Markdown 格式報告"""
        with open("gdb_report.md", "w") as f:
            f.write("# GDB 自動化分析報告\n\n")
            f.write(f"**時間**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
            f.write(f"**程式**: `{self.program}`\n\n")
            
            if "crash_analysis" in self.results:
                f.write("## 崩潰分析\n\n")
                crash = self.results["crash_analysis"]
                if crash["status"] == "crashed":
                    f.write(f"- **狀態**: ⚠️ {crash['type']}\n")
                    f.write("- **Backtrace**:\n```\n")
                    for bt in crash.get("backtrace", []):
                        f.write(f"{bt}\n")
                    f.write("```\n\n")
                else:
                    f.write("- **狀態**: ✅ 無崩潰\n\n")
            
            if "factorial_calls" in self.results:
                f.write("## 函式呼叫統計\n\n")
                f.write(f"- `factorial()` 被呼叫 **{self.results['factorial_calls']}** 次\n\n")
            
            if "memory_profile" in self.results:
                f.write("## 記憶體分析\n\n")
                mem = self.results["memory_profile"]
                f.write(f"- malloc 呼叫次數: **{mem['malloc_calls']}**\n")
                f.write(f"- 總配置記憶體: **{mem['total_allocated']} bytes**\n\n")

def main():
    # 編譯測試程式
    print("🔨 編譯程式...")
    os.system("gcc -g -O0 -o test_program test_program.c")
    
    # 建立自動化物件
    gdb = GDBAutomation("test_program")
    
    # 執行各項測試
    gdb.analyze_crash()
    gdb.count_function_calls("factorial")
    gdb.profile_memory()
    
    # 產生報告
    report = gdb.generate_report()
    
    print("\n✅ 分析完成！")
    print(f"📊 結果摘要:")
    print(json.dumps(report["results"], indent=2))
    print(f"\n📁 報告已儲存至:")
    print("  - gdb_report.json")
    print("  - gdb_report.md")

if __name__ == "__main__":
    main()
</code></pre>
<h3 id="4-makefile-整合"><a class="header" href="#4-makefile-整合">4. Makefile 整合</a></h3>
<pre><code class="language-makefile"># Makefile - 整合 GDB 自動化到建構流程

CC = gcc
CFLAGS = -g -O0 -Wall
PROGRAM = test_program
SOURCE = test_program.c

.PHONY: all clean test debug analyze

all: $(PROGRAM)

$(PROGRAM): $(SOURCE)
	$(CC) $(CFLAGS) -o $@ $&lt;

# 執行所有測試
test: $(PROGRAM)
	@echo "Running automated tests..."
	@gdb -batch -ex "run 1" -ex "quit" ./$(PROGRAM) &gt; /dev/null &amp;&amp; echo "✓ Test 1: Normal execution"
	@gdb -batch -ex "run 5" -ex "quit" ./$(PROGRAM) &gt; /dev/null &amp;&amp; echo "✓ Test 5: Factorial"
	@echo "All tests passed!"

# 除錯模式
debug: $(PROGRAM)
	gdb -ex "break main" -ex "run 1" ./$(PROGRAM)

# 快速崩潰分析
crash: $(PROGRAM)
	@echo "Analyzing crash..."
	@gdb -batch -ex "run 2" -ex "bt" -ex "quit" ./$(PROGRAM) | grep -A5 "Segmentation"

# 符號分析
symbols: $(PROGRAM)
	@echo "Extracting symbols..."
	@gdb -batch -ex "info functions" ./$(PROGRAM) &gt; symbols.txt
	@echo "Symbols saved to symbols.txt"

# 效能分析
profile: $(PROGRAM)
	@echo "Profiling function calls..."
	@gdb -batch \
		-ex "break factorial" \
		-ex "commands" \
		-ex "silent" \
		-ex "set \$$count++" \
		-ex "continue" \
		-ex "end" \
		-ex "set \$$count = 0" \
		-ex "run 5" \
		-ex 'printf "factorial called %d times\n", \$$count' \
		-ex "quit" \
		./$(PROGRAM)

# 記憶體檢查
memcheck: $(PROGRAM)
	@echo "Checking memory..."
	@gdb -batch \
		-ex "break malloc" \
		-ex "commands" \
		-ex "silent" \
		-ex 'printf "malloc: %d bytes\n", \$$rdi' \
		-ex "continue" \
		-ex "end" \
		-ex "run 3" \
		-ex "quit" \
		./$(PROGRAM) | grep malloc | wc -l | xargs echo "Total malloc calls:"

# 完整分析
analyze: $(PROGRAM)
	@bash auto_debug.sh --all

# Python 分析
pyanalyze: $(PROGRAM)
	@python3 gdb_automation.py

# CI/CD 整合
ci-test: $(PROGRAM)
	@echo "Running CI tests..."
	@for test in 1 5; do \
		if gdb -batch -ex "run $$test" -ex "quit" ./$(PROGRAM) &gt; /dev/null 2&gt;&amp;1; then \
			echo "✓ Test $$test passed"; \
		else \
			echo "✗ Test $$test failed"; \
			exit 1; \
		fi \
	done
	@echo "CI tests completed successfully!"

# 清理
clean:
	rm -f $(PROGRAM) *.log *.txt *.json *.md core

# 說明
help:
	@echo "Available targets:"
	@echo "  make all      - Build the program"
	@echo "  make test     - Run automated tests"
	@echo "  make debug    - Start interactive debugging"
	@echo "  make crash    - Analyze crash"
	@echo "  make symbols  - Extract symbols"
	@echo "  make profile  - Profile function calls"
	@echo "  make memcheck - Check memory usage"
	@echo "  make analyze  - Run full analysis"
	@echo "  make pyanalyze- Run Python analysis"
	@echo "  make ci-test  - Run CI/CD tests"
	@echo "  make clean    - Clean build files"
</code></pre>
<h3 id="5-docker-整合-dockerfile"><a class="header" href="#5-docker-整合-dockerfile">5. Docker 整合 (Dockerfile)</a></h3>
<pre><code class="language-dockerfile"># Dockerfile - 容器化 GDB 自動化環境

FROM ubuntu:22.04

# 安裝必要套件
RUN apt-get update &amp;&amp; apt-get install -y \
    build-essential \
    gdb \
    python3 \
    python3-pip \
    make \
    vim \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# 設定工作目錄
WORKDIR /app

# 複製檔案
COPY test_program.c .
COPY auto_debug.sh .
COPY gdb_automation.py .
COPY Makefile .

# 設定執行權限
RUN chmod +x auto_debug.sh

# 編譯程式
RUN make all

# 預設命令
CMD ["bash", "auto_debug.sh"]
</code></pre>
<h3 id="6-github-actions-cicd-githubworkflowsgdb-testyml"><a class="header" href="#6-github-actions-cicd-githubworkflowsgdb-testyml">6. GitHub Actions CI/CD (.github/workflows/gdb-test.yml)</a></h3>
<pre><code class="language-yaml">name: GDB Automated Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gdb build-essential
    
    - name: Compile program
      run: make all
    
    - name: Run automated tests
      run: |
        # 正常執行測試
        gdb -batch -ex "run 1" -ex "quit" ./test_program
        
        # 函式呼叫測試
        gdb -batch -ex "run 5" -ex "quit" ./test_program
    
    - name: Check for crashes
      run: |
        # 這個應該會失敗（預期行為）
        if gdb -batch -ex "run 2" -ex "quit" ./test_program 2&gt;&amp;1 | grep -q "Segmentation"; then
          echo "Expected crash detected"
        else
          echo "Unexpected: no crash detected"
          exit 1
        fi
    
    - name: Generate analysis report
      run: |
        make analyze
        
    - name: Upload reports
      uses: actions/upload-artifact@v2
      with:
        name: gdb-reports
        path: |
          *.log
          *.txt
          *.json
          *.md
</code></pre>
<h2 id="使用說明"><a class="header" href="#使用說明">使用說明</a></h2>
<h3 id="快速開始"><a class="header" href="#快速開始">快速開始</a></h3>
<ol>
<li>
<p><strong>儲存所有檔案到同一目錄</strong></p>
</li>
<li>
<p><strong>執行互動式選單</strong>：</p>
</li>
</ol>
<pre><code class="language-bash">chmod +x auto_debug.sh
./auto_debug.sh
</code></pre>
<ol start="3">
<li><strong>執行所有測試</strong>：</li>
</ol>
<pre><code class="language-bash">./auto_debug.sh --all
</code></pre>
<ol start="4">
<li><strong>使用 Makefile</strong>：</li>
</ol>
<pre><code class="language-bash">make all        # 編譯
make test       # 測試
make analyze    # 完整分析
make clean      # 清理
</code></pre>
<ol start="5">
<li><strong>使用 Python 腳本</strong>：</li>
</ol>
<pre><code class="language-bash">python3 gdb_automation.py
</code></pre>
<ol start="6">
<li><strong>Docker 執行</strong>：</li>
</ol>
<pre><code class="language-bash">docker build -t gdb-auto .
docker run -it gdb-auto
</code></pre>
<h2 id="輸出範例"><a class="header" href="#輸出範例">輸出範例</a></h2>
<p>執行後會產生多個報告檔案：</p>
<ul>
<li><code>debug_report_YYYYMMDD_HHMMSS.log</code> - 完整除錯報告</li>
<li><code>crash_analysis.log</code> - 崩潰分析</li>
<li><code>symbols_report.txt</code> - 符號表報告</li>
<li><code>gdb_report.json</code> - JSON 格式報告</li>
<li><code>gdb_report.md</code> - Markdown 格式報告</li>
</ul>
<h2 id="最佳實踐"><a class="header" href="#最佳實踐">最佳實踐</a></h2>
<ol>
<li><strong>使用 <code>-batch</code> 提高效率</strong></li>
<li><strong>善用 <code>-ex</code> 串接命令</strong></li>
<li><strong>結合 Shell 腳本自動化</strong></li>
<li><strong>整合到 CI/CD 流程</strong></li>
<li><strong>產生結構化報告便於分析</strong></li>
</ol>
<p>這個完整範例展示了 <code>gdb -ex</code> 在實際專案中的強大應用！</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../gdb/gdb-function-trace-to-flowchart-guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../gdb/GDB_DEBUG_GUIDE.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../gdb/gdb-function-trace-to-flowchart-guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../gdb/GDB_DEBUG_GUIDE.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
