<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ClickHouse 部署指南 - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="clickhouse-docker-完整部署指南"><a class="header" href="#clickhouse-docker-完整部署指南">ClickHouse Docker 完整部署指南</a></h1>
<h2 id="-目錄"><a class="header" href="#-目錄">📋 目錄</a></h2>
<ul>
<li><a href="#%E7%B3%BB%E7%B5%B1%E9%9C%80%E6%B1%82">系統需求</a></li>
<li><a href="#%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%9D">快速安裝</a></li>
<li><a href="#%E7%94%9F%E7%94%A2%E7%92%B0%E5%A2%83%E9%85%8D%E7%BD%AE">生產環境配置</a></li>
<li><a href="#%E8%87%AA%E5%8B%95%E5%82%99%E4%BB%BD%E8%A8%AD%E7%BD%AE">自動備份設置</a></li>
<li><a href="#%E6%B8%AC%E8%A9%A6%E7%AF%84%E4%BE%8B">測試範例</a></li>
<li><a href="#%E7%9B%A3%E6%8E%A7%E8%88%87%E7%B6%AD%E8%AD%B7">監控與維護</a></li>
<li><a href="#%E5%B8%B8%E8%A6%8B%E5%95%8F%E9%A1%8C">常見問題</a></li>
</ul>
<h2 id="系統需求"><a class="header" href="#系統需求">系統需求</a></h2>
<h3 id="最低配置"><a class="header" href="#最低配置">最低配置</a></h3>
<ul>
<li>CPU: 4 核心</li>
<li>RAM: 8 GB</li>
<li>Storage: 100 GB SSD</li>
<li>OS: Linux (Ubuntu 20.04+ / CentOS 7+)</li>
<li>Docker: 20.10+</li>
<li>Docker Compose: 2.0+</li>
</ul>
<h3 id="建議配置"><a class="header" href="#建議配置">建議配置</a></h3>
<ul>
<li>CPU: 8+ 核心</li>
<li>RAM: 32+ GB</li>
<li>Storage: NVMe SSD (越快越好)</li>
<li>Network: 1 Gbps+</li>
</ul>
<h2 id="快速安裝"><a class="header" href="#快速安裝">快速安裝</a></h2>
<h3 id="1-安裝-docker-ubuntu-為例"><a class="header" href="#1-安裝-docker-ubuntu-為例">1. 安裝 Docker (Ubuntu 為例)</a></h3>
<pre><code class="language-bash"># 更新系統
sudo apt-get update
sudo apt-get upgrade -y

# 安裝 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安裝 Docker Compose (注意：需要指定版本，不要用 latest)
sudo curl -L "https://github.com/docker/compose/releases/download/v2.30.3/docker-compose-Linux-x86_64" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 將當前用戶加入 docker 群組
sudo usermod -aG docker $USER
newgrp docker

# 驗證安裝
docker --version
docker-compose --version
</code></pre>
<h3 id="2-建立專案目錄結構"><a class="header" href="#2-建立專案目錄結構">2. 建立專案目錄結構</a></h3>
<pre><code class="language-bash"># 建立目錄
mkdir -p ~/clickhouse-docker/{config,data,logs,backup,scripts}
cd ~/clickhouse-docker

# 建立必要的目錄權限
sudo mkdir -p /data/clickhouse
sudo chown -R $USER:$USER /data/clickhouse
</code></pre>
<h2 id="生產環境配置"><a class="header" href="#生產環境配置">生產環境配置</a></h2>
<h3 id="3-創建優化的-docker-composeyml"><a class="header" href="#3-創建優化的-docker-composeyml">3. 創建優化的 docker-compose.yml</a></h3>
<pre><code class="language-yaml"># ~/clickhouse-docker/docker-compose.yml
# 注意：version 屬性在新版 Docker Compose 中已棄用，可以省略

services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.8-alpine
    container_name: clickhouse-server
    hostname: clickhouse-server
    
    # 網路配置（生產環境可考慮 host 模式，測試環境建議用橋接）
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native client
      - "9009:9009"  # Interserver HTTP
    
    # 環境變數
    environment:
      # 初始資料庫設置
      CLICKHOUSE_DB: market_data
      CLICKHOUSE_USER: trader
      CLICKHOUSE_PASSWORD: SecurePass123!
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
      # 效能相關
      CLICKHOUSE_MAX_MEMORY_USAGE: 10000000000  # 10GB
      CLICKHOUSE_MAX_MEMORY_USAGE_FOR_USER: 10000000000
      
    # 資源限制
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 16G
        reservations:
          cpus: '2'
          memory: 8G
    
    # 掛載設定
    volumes:
      # 資料目錄 - 使用本地 SSD
      - type: bind
        source: /data/clickhouse
        target: /var/lib/clickhouse
      # 日誌目錄
      - type: bind
        source: ./logs
        target: /var/log/clickhouse-server
      # 自定義配置
      - type: bind
        source: ./config
        target: /etc/clickhouse-server/config.d
        read_only: true
      # 備份目錄
      - type: bind
        source: ./backup
        target: /backups
    
    # 系統限制優化
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
      memlock:
        soft: -1
        hard: -1
      nproc:
        soft: 131072
        hard: 131072
    
    # 健康檢查
    healthcheck:
      test: ["CMD", "clickhouse-client", "--host", "localhost", "--query", "SELECT 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    
    # 自動重啟
    restart: unless-stopped
    
    # 日誌設置
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
</code></pre>
<h3 id="4-創建自定義配置文件"><a class="header" href="#4-創建自定義配置文件">4. 創建自定義配置文件</a></h3>
<h4 id="儲存優化配置"><a class="header" href="#儲存優化配置">儲存優化配置</a></h4>
<pre><code class="language-xml">&lt;!-- ~/clickhouse-docker/config/storage.xml --&gt;
&lt;?xml version="1.0"?&gt;
&lt;clickhouse&gt;
    &lt;storage_configuration&gt;
        &lt;disks&gt;
            &lt;default&gt;
                &lt;path&gt;/var/lib/clickhouse/&lt;/path&gt;
            &lt;/default&gt;
            &lt;fast_ssd&gt;
                &lt;path&gt;/var/lib/clickhouse/fast/&lt;/path&gt;
            &lt;/fast_ssd&gt;
        &lt;/disks&gt;
        &lt;policies&gt;
            &lt;tiered&gt;
                &lt;volumes&gt;
                    &lt;hot&gt;
                        &lt;disk&gt;fast_ssd&lt;/disk&gt;
                        &lt;max_data_part_size_bytes&gt;10737418240&lt;/max_data_part_size_bytes&gt;
                    &lt;/hot&gt;
                    &lt;cold&gt;
                        &lt;disk&gt;default&lt;/disk&gt;
                    &lt;/cold&gt;
                &lt;/volumes&gt;
                &lt;move_factor&gt;0.2&lt;/move_factor&gt;
            &lt;/tiered&gt;
        &lt;/policies&gt;
    &lt;/storage_configuration&gt;
    
    &lt;!-- 壓縮設置 --&gt;
    &lt;compression&gt;
        &lt;case&gt;
            &lt;method&gt;lz4hc&lt;/method&gt;
            &lt;level&gt;12&lt;/level&gt;
        &lt;/case&gt;
    &lt;/compression&gt;
&lt;/clickhouse&gt;
</code></pre>
<h4 id="效能優化配置選用預設配置通常已足夠"><a class="header" href="#效能優化配置選用預設配置通常已足夠">效能優化配置（選用，預設配置通常已足夠）</a></h4>
<pre><code class="language-xml">&lt;!-- ~/clickhouse-docker/config/performance.xml --&gt;
&lt;!-- 警告：自定義配置容易出錯，建議先使用預設配置測試 --&gt;
&lt;?xml version="1.0"?&gt;
&lt;clickhouse&gt;
    &lt;!-- 網路優化 --&gt;
    &lt;max_concurrent_queries&gt;100&lt;/max_concurrent_queries&gt;
    &lt;max_connections&gt;4096&lt;/max_connections&gt;

    &lt;!-- 背景任務優化 --&gt;
    &lt;background_pool_size&gt;16&lt;/background_pool_size&gt;
    &lt;background_schedule_pool_size&gt;16&lt;/background_schedule_pool_size&gt;

    &lt;!-- MergeTree 優化 --&gt;
    &lt;merge_tree&gt;
        &lt;max_suspicious_broken_parts&gt;5&lt;/max_suspicious_broken_parts&gt;
        &lt;max_parts_in_total&gt;100000&lt;/max_parts_in_total&gt;
    &lt;/merge_tree&gt;

    &lt;!-- User profiles 設定（user-level 設定必須放在 profiles 區塊） --&gt;
    &lt;profiles&gt;
        &lt;default&gt;
            &lt;max_threads&gt;8&lt;/max_threads&gt;
            &lt;max_memory_usage&gt;10000000000&lt;/max_memory_usage&gt;
            &lt;max_memory_usage_for_user&gt;10000000000&lt;/max_memory_usage_for_user&gt;
            &lt;max_bytes_before_external_group_by&gt;5000000000&lt;/max_bytes_before_external_group_by&gt;
        &lt;/default&gt;
    &lt;/profiles&gt;
&lt;/clickhouse&gt;
</code></pre>
<h2 id="自動備份設置"><a class="header" href="#自動備份設置">自動備份設置</a></h2>
<h3 id="5-備份腳本"><a class="header" href="#5-備份腳本">5. 備份腳本</a></h3>
<h4 id="主備份腳本"><a class="header" href="#主備份腳本">主備份腳本</a></h4>
<pre><code class="language-bash">#!/bin/bash
# ~/clickhouse-docker/scripts/backup.sh

# 設定變數
BACKUP_DIR="/home/$USER/clickhouse-docker/backup"
CONTAINER_NAME="clickhouse-server"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7
LOG_FILE="$BACKUP_DIR/backup.log"

# 顏色輸出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 日誌函數
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# 錯誤處理
error_exit() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"
    exit 1
}

# 檢查容器是否運行
check_container() {
    if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        error_exit "Container ${CONTAINER_NAME} is not running!"
    fi
}

# 執行備份
perform_backup() {
    log "Starting backup..."
    
    # 方法 1: 使用 ClickHouse 原生備份（推薦）
    log "Creating ClickHouse native backup..."
    
    # 創建所有表的備份
    docker exec $CONTAINER_NAME clickhouse-client --query "
        SELECT concat('BACKUP TABLE ', database, '.', name, ' TO Disk(''backups'', ''', '${DATE}/', database, '_', name, ''');')
        FROM system.tables 
        WHERE database NOT IN ('system', 'information_schema', 'INFORMATION_SCHEMA')
    " | while read backup_cmd; do
        if [ ! -z "$backup_cmd" ]; then
            docker exec $CONTAINER_NAME clickhouse-client --query "$backup_cmd" || log "Warning: Failed to backup a table"
        fi
    done
    
    # 方法 2: 物理備份（完整備份）
    log "Creating physical backup..."
    docker exec $CONTAINER_NAME bash -c "
        tar czf /backups/physical_backup_${DATE}.tar.gz \
        --exclude='/var/lib/clickhouse/preprocessed_configs' \
        --exclude='/var/lib/clickhouse/tmp' \
        /var/lib/clickhouse/data \
        /var/lib/clickhouse/metadata
    " || error_exit "Physical backup failed"
    
    # 備份配置文件
    log "Backing up configuration..."
    tar czf "$BACKUP_DIR/config_backup_${DATE}.tar.gz" \
        -C ~/clickhouse-docker config/ docker-compose.yml \
        || error_exit "Config backup failed"
    
    log "Backup completed successfully!"
}

# 清理舊備份
cleanup_old_backups() {
    log "Cleaning up old backups (older than $RETENTION_DAYS days)..."
    
    # 清理本地備份
    find "$BACKUP_DIR" -name "*.tar.gz" -type f -mtime +$RETENTION_DAYS -delete
    
    # 清理容器內備份
    docker exec $CONTAINER_NAME bash -c "
        find /backups -name '*.tar.gz' -type f -mtime +$RETENTION_DAYS -delete
    "
    
    log "Cleanup completed"
}

# 顯示備份資訊
show_backup_info() {
    echo -e "${GREEN}=== Backup Information ===${NC}"
    echo "Backup Location: $BACKUP_DIR"
    echo "Latest Backups:"
    ls -lah "$BACKUP_DIR" | grep -E "*.tar.gz" | tail -5
    
    # 顯示備份大小統計
    total_size=$(du -sh "$BACKUP_DIR" 2&gt;/dev/null | cut -f1)
    echo -e "\nTotal backup size: ${YELLOW}$total_size${NC}"
}

# 主程序
main() {
    echo -e "${GREEN}=== ClickHouse Backup Script ===${NC}"
    
    # 創建備份目錄
    mkdir -p "$BACKUP_DIR"
    
    # 執行備份流程
    check_container
    perform_backup
    cleanup_old_backups
    show_backup_info
    
    echo -e "${GREEN}✅ Backup process completed!${NC}"
}

# 執行主程序
main
</code></pre>
<h4 id="還原腳本"><a class="header" href="#還原腳本">還原腳本</a></h4>
<pre><code class="language-bash">#!/bin/bash
# ~/clickhouse-docker/scripts/restore.sh

# 設定變數
BACKUP_DIR="/home/$USER/clickhouse-docker/backup"
CONTAINER_NAME="clickhouse-server"

# 顏色輸出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 列出可用備份
list_backups() {
    echo -e "${GREEN}=== Available Backups ===${NC}"
    ls -la "$BACKUP_DIR" | grep -E "physical_backup.*tar.gz" | nl
}

# 還原備份
restore_backup() {
    list_backups
    
    echo -e "${YELLOW}Enter the number of backup to restore:${NC}"
    read backup_num
    
    backup_file=$(ls "$BACKUP_DIR" | grep -E "physical_backup.*tar.gz" | sed -n "${backup_num}p")
    
    if [ -z "$backup_file" ]; then
        echo -e "${RED}Invalid selection!${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}⚠️  WARNING: This will stop ClickHouse and restore data!${NC}"
    echo "Restore from: $backup_file"
    echo "Continue? (yes/no)"
    read confirm
    
    if [ "$confirm" != "yes" ]; then
        echo "Restore cancelled"
        exit 0
    fi
    
    # 停止容器
    echo "Stopping ClickHouse..."
    docker-compose -f ~/clickhouse-docker/docker-compose.yml down
    
    # 備份當前數據（安全起見）
    echo "Backing up current data..."
    sudo mv /data/clickhouse /data/clickhouse.old.$(date +%Y%m%d_%H%M%S)
    sudo mkdir -p /data/clickhouse
    
    # 解壓備份
    echo "Restoring backup..."
    sudo tar xzf "$BACKUP_DIR/$backup_file" -C / --strip-components=2
    
    # 修正權限
    sudo chown -R 101:101 /data/clickhouse
    
    # 重啟容器
    echo "Starting ClickHouse..."
    docker-compose -f ~/clickhouse-docker/docker-compose.yml up -d
    
    # 等待服務啟動
    sleep 10
    
    # 檢查服務狀態
    docker exec $CONTAINER_NAME clickhouse-client --query "SELECT 'Restore completed successfully!'"
    
    echo -e "${GREEN}✅ Restore completed!${NC}"
}

# 主程序
restore_backup
</code></pre>
<h3 id="6-設置-crontab-自動備份"><a class="header" href="#6-設置-crontab-自動備份">6. 設置 Crontab 自動備份</a></h3>
<pre><code class="language-bash"># 使腳本可執行
chmod +x ~/clickhouse-docker/scripts/*.sh

# 設置每日自動備份 (每天凌晨 2 點)
crontab -e

# 添加以下行
0 2 * * * /home/$USER/clickhouse-docker/scripts/backup.sh &gt;&gt; /home/$USER/clickhouse-docker/backup/cron.log 2&gt;&amp;1
</code></pre>
<h2 id="測試範例"><a class="header" href="#測試範例">測試範例</a></h2>
<h3 id="7-使用-makefile-管理推薦"><a class="header" href="#7-使用-makefile-管理推薦">7. 使用 Makefile 管理（推薦）</a></h3>
<p>創建 Makefile 簡化操作：</p>
<pre><code class="language-makefile"># 快速開始
make quick-start   # 一鍵安裝並啟動

# 日常操作
make up           # 啟動服務
make down         # 停止服務
make status       # 查看狀態
make shell        # 進入 CLI
make backup       # 執行備份
make restore      # 還原備份
make reset        # 完全重置
</code></pre>
<p>手動操作：</p>
<pre><code class="language-bash">cd ~/clickhouse-docker
docker-compose up -d

# 檢查狀態
docker-compose ps
docker logs clickhouse-server --tail 50
</code></pre>
<h3 id="8-創建測試表並導入數據"><a class="header" href="#8-創建測試表並導入數據">8. 創建測試表並導入數據</a></h3>
<h4 id="創建基本表結構"><a class="header" href="#創建基本表結構">創建基本表結構</a></h4>
<pre><code class="language-sql"># 連接到 ClickHouse
docker exec -it clickhouse-server clickhouse-client --user trader --password SecurePass123!

-- 創建資料庫
CREATE DATABASE IF NOT EXISTS market_data;
USE market_data;

-- 創建 tick 數據表（簡化版，避免複雜編碼問題）
CREATE TABLE market_ticks (
    ts DateTime64(3),
    symbol String,
    close Decimal32(2),
    volume UInt32,
    bid_price Decimal32(2),
    bid_volume UInt32,
    ask_price Decimal32(2),
    ask_volume UInt32,
    tick_type UInt8
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(ts)
ORDER BY (symbol, ts);

-- 查看表結構
DESCRIBE TABLE market_ticks;
</code></pre>
<h4 id="導入測試數據"><a class="header" href="#導入測試數據">導入測試數據</a></h4>
<pre><code class="language-bash"># 創建測試 CSV 文件
cat &gt; ~/clickhouse-docker/test_data.csv &lt;&lt; 'EOF'
ts,symbol,close,volume,bid_price,bid_volume,ask_price,ask_volume,tick_type
2025-09-25 17:25:00.044,AAPL,1325.0,7,1320.0,160,1325.0,22,1
2025-09-25 17:25:02.207,AAPL,1325.0,1,1320.0,160,1325.0,22,1
2025-09-25 17:25:03.125,AAPL,1325.0,1,1320.0,161,1325.0,21,1
2025-09-25 17:25:47.863,AAPL,1325.0,1,1320.0,162,1325.0,21,1
2025-09-25 17:26:14.894,TSLA,1325.0,1,1320.0,181,1325.0,18,1
2025-09-25 17:26:51.365,TSLA,1325.0,1,1320.0,181,1325.0,27,1
2025-09-25 17:29:59.655,TSLA,1325.0,3,1320.0,177,1325.0,31,1
2025-09-25 17:30:06.262,NVDA,1325.0,1,1320.0,180,1325.0,28,1
2025-09-25 17:30:14.542,NVDA,1325.0,3,1320.0,183,1325.0,27,1
2025-09-25 17:30:52.600,NVDA,1320.0,2,1320.0,185,1325.0,22,2
EOF

# 導入數據
docker exec -i clickhouse-server clickhouse-client \
    --user trader --password SecurePass123! \
    --query "INSERT INTO market_data.market_ticks FORMAT CSVWithNames" \
    &lt; ~/clickhouse-docker/test_data.csv
</code></pre>
<h3 id="9-測試查詢"><a class="header" href="#9-測試查詢">9. 測試查詢</a></h3>
<h4 id="基本查詢測試"><a class="header" href="#基本查詢測試">基本查詢測試</a></h4>
<pre><code class="language-sql">-- 連接到資料庫
docker exec -it clickhouse-server clickhouse-client \
    --user trader --password SecurePass123! \
    --database market_data

-- 查詢記錄數
SELECT count(*) FROM market_ticks;

-- 查看最新數據
SELECT * FROM market_ticks ORDER BY ts DESC LIMIT 5;

-- 按 symbol 聚合
SELECT 
    symbol,
    count(*) as tick_count,
    avg(close) as avg_price,
    max(volume) as max_volume
FROM market_ticks
GROUP BY symbol;

-- 時間範圍查詢
SELECT *
FROM market_ticks
WHERE ts &gt;= '2025-09-25 17:25:00'
  AND ts &lt;= '2025-09-25 17:30:00'
ORDER BY ts;

-- 查看壓縮效果
SELECT 
    formatReadableSize(sum(data_compressed_bytes)) as compressed,
    formatReadableSize(sum(data_uncompressed_bytes)) as uncompressed,
    round(sum(data_uncompressed_bytes) / sum(data_compressed_bytes), 2) as ratio
FROM system.parts
WHERE database = 'market_data' AND table = 'market_ticks';
</code></pre>
<h4 id="效能測試"><a class="header" href="#效能測試">效能測試</a></h4>
<pre><code class="language-sql">-- 插入大量測試數據（使用 rand() 函數避免類型問題）
INSERT INTO market_ticks
SELECT
    now() - toIntervalSecond(toUInt32(rand() % 86400)) as ts,
    arrayElement(['AAPL', 'GOOGL', 'MSFT', 'TSLA', 'NVDA'], (rand() % 5) + 1) as symbol,
    1000 + (rand() % 100) as close,
    toUInt32((rand() % 1000) + 1) as volume,
    1000 + (rand() % 100) - 50 as bid_price,
    toUInt32((rand() % 500) + 1) as bid_volume,
    1000 + (rand() % 100) as ask_price,
    toUInt32((rand() % 500) + 1) as ask_volume,
    toUInt8((rand() % 3) + 1) as tick_type
FROM numbers(1000000);

-- 測試查詢效能
SELECT 
    symbol,
    toStartOfMinute(ts) as minute,
    avg(close) as avg_price,
    sum(volume) as total_volume
FROM market_ticks
WHERE ts &gt;= now() - INTERVAL 1 DAY
GROUP BY symbol, minute
ORDER BY minute DESC, symbol
LIMIT 100
FORMAT Null;

-- 顯示查詢統計
SHOW PROCESSLIST;
</code></pre>
<h2 id="監控與維護"><a class="header" href="#監控與維護">監控與維護</a></h2>
<h3 id="10-監控腳本"><a class="header" href="#10-監控腳本">10. 監控腳本</a></h3>
<pre><code class="language-bash">#!/bin/bash
# ~/clickhouse-docker/scripts/monitor.sh

echo "=== ClickHouse Monitoring Dashboard ==="
echo "======================================="

# 系統資源使用
echo -e "\n📊 Resource Usage:"
docker stats clickhouse-server --no-stream

# 資料庫大小
echo -e "\n💾 Database Size:"
docker exec clickhouse-server clickhouse-client --user trader --password SecurePass123! --query "
SELECT 
    database,
    formatReadableSize(sum(bytes_on_disk)) as size,
    formatReadableQuantity(sum(rows)) as rows,
    count() as tables
FROM system.parts
WHERE active
GROUP BY database
FORMAT Pretty"

# 查詢效能
echo -e "\n⚡ Recent Queries:"
docker exec clickhouse-server clickhouse-client --user trader --password SecurePass123! --query "
SELECT 
    substring(query, 1, 50) as query_preview,
    formatReadableSize(memory_usage) as memory,
    query_duration_ms,
    read_rows,
    written_rows
FROM system.query_log
WHERE type = 'QueryFinish'
ORDER BY event_time DESC
LIMIT 5
FORMAT Pretty"

# 系統健康狀態
echo -e "\n✅ Health Check:"
docker exec clickhouse-server clickhouse-client --query "SELECT 'ClickHouse is running OK!'"
</code></pre>
<h3 id="11-日常維護命令"><a class="header" href="#11-日常維護命令">11. 日常維護命令</a></h3>
<pre><code class="language-bash"># 優化表（整理碎片）
docker exec clickhouse-server clickhouse-client --user trader --password SecurePass123! \
    --query "OPTIMIZE TABLE market_data.market_ticks FINAL"

# 清理舊分區
docker exec clickhouse-server clickhouse-client --user trader --password SecurePass123! \
    --query "ALTER TABLE market_data.market_ticks DROP PARTITION '202501'"

# 查看慢查詢
docker exec clickhouse-server clickhouse-client --user trader --password SecurePass123! \
    --query "
    SELECT 
        query,
        query_duration_ms,
        memory_usage
    FROM system.query_log
    WHERE query_duration_ms &gt; 1000
    ORDER BY query_duration_ms DESC
    LIMIT 10"

# 重啟服務
docker-compose restart

# 升級 ClickHouse
docker-compose pull
docker-compose up -d
</code></pre>
<h2 id="常見問題"><a class="header" href="#常見問題">常見問題</a></h2>
<h3 id="q1-記憶體不足錯誤"><a class="header" href="#q1-記憶體不足錯誤">Q1: 記憶體不足錯誤</a></h3>
<pre><code class="language-bash"># 調整記憶體限制
docker exec clickhouse-server clickhouse-client --query "
SET max_memory_usage = 5000000000;
SET max_memory_usage_for_user = 5000000000;"
</code></pre>
<h3 id="q2-磁碟空間不足"><a class="header" href="#q2-磁碟空間不足">Q2: 磁碟空間不足</a></h3>
<pre><code class="language-bash"># 檢查空間使用
df -h /data/clickhouse

# 清理舊數據
docker exec clickhouse-server clickhouse-client --query "
ALTER TABLE market_data.market_ticks 
DROP PARTITION WHERE toYYYYMM(ts) &lt; toYYYYMM(now() - INTERVAL 6 MONTH)"
</code></pre>
<h3 id="q3-連接被拒絕"><a class="header" href="#q3-連接被拒絕">Q3: 連接被拒絕</a></h3>
<pre><code class="language-bash"># 檢查容器狀態
docker ps | grep clickhouse

# 查看日誌
docker logs clickhouse-server --tail 100

# 重啟容器
docker-compose restart
</code></pre>
<h3 id="q4-查詢太慢"><a class="header" href="#q4-查詢太慢">Q4: 查詢太慢</a></h3>
<pre><code class="language-sql">-- 分析查詢計畫
EXPLAIN SELECT * FROM market_ticks WHERE symbol = 'AAPL';

-- 創建索引
ALTER TABLE market_ticks ADD INDEX idx_symbol (symbol) TYPE minmax GRANULARITY 4;
</code></pre>
<h2 id="優化表設計適用於大量-tick-數據"><a class="header" href="#優化表設計適用於大量-tick-數據">優化表設計（適用於大量 Tick 數據）</a></h2>
<h3 id="創建優化的表結構"><a class="header" href="#創建優化的表結構">創建優化的表結構</a></h3>
<pre><code class="language-sql">-- 主要 tick 數據表（優化版）
CREATE TABLE tick_data_optimized (
    timestamp DateTime64(3) CODEC(DoubleDelta),
    symbol LowCardinality(String),
    exchange LowCardinality(String),
    price Decimal64(4),
    volume UInt64 CODEC(T64),
    side Enum8('buy' = 1, 'sell' = 2),
    bid_price Decimal64(4),
    ask_price Decimal64(4),
    bid_volume UInt32 CODEC(T64),
    ask_volume UInt32 CODEC(T64)
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (symbol, timestamp)
PRIMARY KEY (symbol, timestamp)
TTL toDateTime(timestamp) + INTERVAL 90 DAY
SETTINGS index_granularity = 8192;

-- 添加索引
ALTER TABLE tick_data_optimized
    ADD INDEX idx_price price TYPE minmax GRANULARITY 4,
    ADD INDEX idx_symbol symbol TYPE bloom_filter(0.01) GRANULARITY 1;
</code></pre>
<h3 id="創建物化視圖預聚合"><a class="header" href="#創建物化視圖預聚合">創建物化視圖（預聚合）</a></h3>
<pre><code class="language-sql">-- 1分鐘K線物化視圖
CREATE MATERIALIZED VIEW tick_1min_mv
ENGINE = AggregatingMergeTree()
PARTITION BY toYYYYMM(minute)
ORDER BY (symbol, minute)
AS SELECT
    symbol,
    toStartOfMinute(timestamp) as minute,
    argMinState(price, timestamp) as open,
    maxState(price) as high,
    minState(price) as low,
    argMaxState(price, timestamp) as close,
    sumState(toUInt64(volume)) as volume,
    countState() as tick_count
FROM tick_data_optimized
GROUP BY symbol, minute;
</code></pre>
<h2 id="效能調優建議"><a class="header" href="#效能調優建議">效能調優建議</a></h2>
<ol>
<li><strong>使用 SSD/NVMe</strong> - I/O 是最大瓶頸</li>
<li><strong>適當分區</strong> - 按月分區對 tick 數據最合適</li>
<li><strong>批量插入</strong> - 單筆插入效能差，建議批量 10000+ 筆</li>
<li><strong>定期 OPTIMIZE</strong> - 每週執行一次 OPTIMIZE TABLE</li>
<li><strong>監控記憶體</strong> - ClickHouse 是記憶體密集型資料庫</li>
<li><strong>使用物化視圖</strong> - 預聚合常用查詢，大幅提升效能</li>
<li><strong>選擇正確的編碼</strong> - DoubleDelta 用於時間戳，T64 用於整數</li>
<li><strong>使用 LowCardinality</strong> - 對重複值多的字串欄位</li>
</ol>
<h2 id="安全建議"><a class="header" href="#安全建議">安全建議</a></h2>
<ol>
<li><strong>修改預設密碼</strong> - 立即修改 docker-compose.yml 中的密碼</li>
<li><strong>限制網路存取</strong> - 使用防火牆限制 8123/9000 端口</li>
<li><strong>定期備份</strong> - 確保自動備份正常運行</li>
<li><strong>監控日誌</strong> - 定期檢查異常存取</li>
<li><strong>更新版本</strong> - 關注安全更新</li>
</ol>
<h2 id="重要注意事項"><a class="header" href="#重要注意事項">重要注意事項</a></h2>
<h3 id="實測發現的問題與解決方案"><a class="header" href="#實測發現的問題與解決方案">實測發現的問題與解決方案</a></h3>
<ol>
<li>
<p><strong>Docker Compose 安裝</strong></p>
<ul>
<li>使用具體版本號而非 <code>latest</code>，避免下載失敗</li>
<li>Ubuntu 24.04 可能沒有 docker-compose-plugin 套件</li>
</ul>
</li>
<li>
<p><strong>配置檔問題</strong></p>
<ul>
<li>user-level 設定（如 max_threads）必須放在 <code>&lt;profiles&gt;</code> 區塊中</li>
<li>複雜的壓縮編碼（如 Gorilla + LZ4）可能導致錯誤</li>
<li>建議先使用預設配置，確認運行正常後再優化</li>
</ul>
</li>
<li>
<p><strong>隨機函數使用</strong></p>
<ul>
<li>使用 <code>rand()</code> 而非 <code>randUniform()</code> 或 <code>randNormal()</code></li>
<li>注意類型轉換（使用 toUInt32、toUInt8 等）</li>
</ul>
</li>
<li>
<p><strong>網路模式</strong></p>
<ul>
<li>測試環境建議使用橋接模式配置端口</li>
<li>生產環境可考慮 host 模式以獲得更好效能</li>
</ul>
</li>
<li>
<p><strong>備份配置</strong></p>
<ul>
<li>原生備份需要額外配置 <code>backups.allowed_disk</code> 參數</li>
<li>物理備份可以正常運作</li>
<li>還原功能建議使用 ClickHouse 原生 BACKUP/RESTORE 命令</li>
</ul>
</li>
<li>
<p><strong>優化表設計注意事項</strong></p>
<ul>
<li>Gorilla 編碼不適用於 Decimal 類型</li>
<li>TTL 使用 DateTime64 需要轉換為 DateTime</li>
<li>物化視圖使用 State 函數聚合，查詢時用 Merge 函數</li>
<li>bloom_filter 索引對字串查詢效能提升顯著</li>
</ul>
</li>
</ol>
<h2 id="支援資源"><a class="header" href="#支援資源">支援資源</a></h2>
<ul>
<li><a href="https://clickhouse.com/docs">官方文檔</a></li>
<li><a href="https://hub.docker.com/r/clickhouse/clickhouse-server">Docker Hub</a></li>
<li><a href="https://github.com/ClickHouse/ClickHouse/issues">GitHub Issues</a></li>
<li><a href="https://clickhouse.com/community">社群論壇</a></li>
</ul>
<h2 id="實測驗證項目"><a class="header" href="#實測驗證項目">實測驗證項目</a></h2>
<p>經過完整測試驗證的功能：</p>
<ul>
<li>✅ Docker Compose 部署</li>
<li>✅ Makefile 自動化管理</li>
<li>✅ 基本表建立與查詢</li>
<li>✅ 優化表結構（tick_data_optimized）</li>
<li>✅ 物化視圖（1分鐘、5分鐘K線）</li>
<li>✅ 索引優化（bloom_filter、minmax）</li>
<li>✅ 備份功能</li>
<li>⚠️ 還原功能（需要改進）</li>
</ul>
<hr />
<p><strong>最後更新</strong>: 2025-09-27
<strong>版本</strong>: ClickHouse 24.8
<strong>作者</strong>: DevOps Team
<strong>實測驗證</strong>: 2025-09-27 成功部署於 Ubuntu 環境，包含優化表設計</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../database/mysql_ubuntu_guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../mq/kafka.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../database/mysql_ubuntu_guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../mq/kafka.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
