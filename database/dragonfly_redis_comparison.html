<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dragonfly vs Redis æ•ˆèƒ½æ¯”è¼ƒ - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dragonflydb-vs-redis-å®Œæ•´æ¯”è¼ƒæŒ‡å—"><a class="header" href="#dragonflydb-vs-redis-å®Œæ•´æ¯”è¼ƒæŒ‡å—">DragonflyDB vs Redis å®Œæ•´æ¯”è¼ƒæŒ‡å—</a></h1>
<h2 id="ç›®éŒ„"><a class="header" href="#ç›®éŒ„">ç›®éŒ„</a></h2>
<ul>
<li><a href="#%E7%B0%A1%E4%BB%8B">ç°¡ä»‹</a></li>
<li><a href="#%E5%AE%89%E8%A3%9D%E6%8C%87%E5%8D%97">å®‰è£æŒ‡å—</a></li>
<li><a href="#python-%E6%B8%AC%E8%A9%A6%E7%92%B0%E5%A2%83%E8%A8%AD%E7%BD%AE">Python æ¸¬è©¦ç’°å¢ƒè¨­ç½®</a></li>
<li><a href="#redis-vs-dragonflydb-%E8%A9%B3%E7%B4%B0%E6%AF%94%E8%BC%83">Redis vs DragonflyDB è©³ç´°æ¯”è¼ƒ</a></li>
<li><a href="#%E6%95%88%E8%83%BD%E5%9F%BA%E6%BA%96%E6%B8%AC%E8%A9%A6">æ•ˆèƒ½åŸºæº–æ¸¬è©¦</a></li>
<li><a href="#%E9%81%B8%E6%93%87%E5%BB%BA%E8%AD%B0">é¸æ“‡å»ºè­°</a></li>
</ul>
<h2 id="ç°¡ä»‹"><a class="header" href="#ç°¡ä»‹">ç°¡ä»‹</a></h2>
<h3 id="redis"><a class="header" href="#redis">Redis</a></h3>
<p>Redis (Remote Dictionary Server) æ˜¯ä¸€å€‹é–‹æºçš„è¨˜æ†¶é«”è³‡æ–™çµæ§‹å„²å­˜ç³»çµ±ï¼Œç”± Salvatore Sanfilippo åœ¨ 2009 å¹´å‰µå»ºã€‚å®ƒå¯ä»¥ç”¨ä½œè³‡æ–™åº«ã€å¿«å–å’Œè¨Šæ¯ä»£ç†ã€‚</p>
<h3 id="dragonflydb"><a class="header" href="#dragonflydb">DragonflyDB</a></h3>
<p>DragonflyDB æ˜¯æ–°ä¸€ä»£çš„è¨˜æ†¶é«”è³‡æ–™åº«ï¼Œæ–¼ 2022 å¹´æ¨å‡ºï¼Œæ—¨åœ¨æˆç‚º Redis çš„ç¾ä»£æ›¿ä»£å“ã€‚å®ƒå®Œå…¨ç›¸å®¹ Redis å”è­°ï¼Œä½†åº•å±¤æ¶æ§‹å®Œå…¨é‡æ–°è¨­è¨ˆã€‚</p>
<h2 id="å®‰è£æŒ‡å—"><a class="header" href="#å®‰è£æŒ‡å—">å®‰è£æŒ‡å—</a></h2>
<h3 id="dragonflydb-å®‰è£"><a class="header" href="#dragonflydb-å®‰è£">DragonflyDB å®‰è£</a></h3>
<h4 id="æ–¹æ³•ä¸€ä½¿ç”¨-dockeræ¨è–¦"><a class="header" href="#æ–¹æ³•ä¸€ä½¿ç”¨-dockeræ¨è–¦">æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Dockerï¼ˆæ¨è–¦ï¼‰</a></h4>
<pre><code class="language-bash"># æ‹‰å–ä¸¦åŸ·è¡Œ DragonflyDB
docker run --rm -p 6379:6379 docker.dragonflydb.io/dragonflydb/dragonfly

# ä½¿ç”¨è‡ªè¨‚é…ç½®
docker run --rm -p 6379:6379 \
  -v /path/to/dragonfly.conf:/etc/dragonfly/dragonfly.conf \
  docker.dragonflydb.io/dragonflydb/dragonfly \
  --flagfile=/etc/dragonfly/dragonfly.conf
</code></pre>
<h4 id="æ–¹æ³•äºŒåœ¨-ubuntudebian-ä¸Šå®‰è£"><a class="header" href="#æ–¹æ³•äºŒåœ¨-ubuntudebian-ä¸Šå®‰è£">æ–¹æ³•äºŒï¼šåœ¨ Ubuntu/Debian ä¸Šå®‰è£</a></h4>
<pre><code class="language-bash"># ä¸‹è¼‰æœ€æ–°ç‰ˆæœ¬
curl -L https://github.com/dragonflydb/dragonfly/releases/latest/download/dragonfly-x86_64.tar.gz | tar -xz

# åŸ·è¡Œ
./dragonfly --logtostderr

# æŒ‡å®šè¨˜æ†¶é«”é™åˆ¶
./dragonfly --logtostderr --maxmemory=4gb
</code></pre>
<h4 id="æ–¹æ³•ä¸‰ä½¿ç”¨-kubernetes"><a class="header" href="#æ–¹æ³•ä¸‰ä½¿ç”¨-kubernetes">æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ Kubernetes</a></h4>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: dragonfly
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dragonfly
  template:
    metadata:
      labels:
        app: dragonfly
    spec:
      containers:
      - name: dragonfly
        image: docker.dragonflydb.io/dragonflydb/dragonfly
        ports:
        - containerPort: 6379
</code></pre>
<h3 id="redis-å®‰è£"><a class="header" href="#redis-å®‰è£">Redis å®‰è£</a></h3>
<h4 id="æ–¹æ³•ä¸€ä½¿ç”¨-docker"><a class="header" href="#æ–¹æ³•ä¸€ä½¿ç”¨-docker">æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Docker</a></h4>
<pre><code class="language-bash">docker run --rm -p 6379:6379 redis:latest
</code></pre>
<h4 id="æ–¹æ³•äºŒåœ¨-ubuntudebian-ä¸Šå®‰è£-1"><a class="header" href="#æ–¹æ³•äºŒåœ¨-ubuntudebian-ä¸Šå®‰è£-1">æ–¹æ³•äºŒï¼šåœ¨ Ubuntu/Debian ä¸Šå®‰è£</a></h4>
<pre><code class="language-bash">sudo apt update
sudo apt install redis-server
sudo systemctl start redis-server
</code></pre>
<h2 id="python-æ¸¬è©¦ç’°å¢ƒè¨­ç½®"><a class="header" href="#python-æ¸¬è©¦ç’°å¢ƒè¨­ç½®">Python æ¸¬è©¦ç’°å¢ƒè¨­ç½®</a></h2>
<h3 id="å®‰è£å¿…è¦å¥—ä»¶"><a class="header" href="#å®‰è£å¿…è¦å¥—ä»¶">å®‰è£å¿…è¦å¥—ä»¶</a></h3>
<pre><code class="language-bash">pip install redis pytest pytest-asyncio aioredis hiredis redis-py-cluster
</code></pre>
<h3 id="dragonflydb-python-ç¯„ä¾‹"><a class="header" href="#dragonflydb-python-ç¯„ä¾‹">DragonflyDB Python ç¯„ä¾‹</a></h3>
<h4 id="1-åŸºæœ¬é€£æ¥èˆ‡æ“ä½œ"><a class="header" href="#1-åŸºæœ¬é€£æ¥èˆ‡æ“ä½œ">1. åŸºæœ¬é€£æ¥èˆ‡æ“ä½œ</a></h4>
<pre><code class="language-python">import redis
import time

# é€£æ¥åˆ° DragonflyDBï¼ˆèˆ‡ Redis å®¢æˆ¶ç«¯ç›¸åŒï¼‰
client = redis.Redis(
    host='localhost',
    port=6379,
    decode_responses=True,
    socket_keepalive=True,
    socket_keepalive_options={
        1: 1,  # TCP_KEEPIDLE
        2: 1,  # TCP_KEEPINTVL
        3: 5,  # TCP_KEEPCNT
    }
)

# æ¸¬è©¦é€£æ¥
try:
    response = client.ping()
    print(f"âœ… DragonflyDB é€£æ¥æˆåŠŸ: {response}")

    # å–å¾—ä¼ºæœå™¨è³‡è¨Š
    info = client.info()
    print(f"ä¼ºæœå™¨ç‰ˆæœ¬: {info.get('server', {}).get('dragonfly_version', 'Unknown')}")
    print(f"ä½¿ç”¨è¨˜æ†¶é«”: {info.get('memory', {}).get('used_memory_human', 'Unknown')}")
except redis.ConnectionError:
    print("âŒ ç„¡æ³•é€£æ¥åˆ° DragonflyDB")
</code></pre>
<h4 id="2-å­—ä¸²æ“ä½œç¯„ä¾‹"><a class="header" href="#2-å­—ä¸²æ“ä½œç¯„ä¾‹">2. å­—ä¸²æ“ä½œç¯„ä¾‹</a></h4>
<pre><code class="language-python">import redis
from datetime import timedelta

client = redis.Redis(host='localhost', port=6379, decode_responses=True)

# åŸºæœ¬å­—ä¸²æ“ä½œ
client.set("user:1:name", "Alice")
client.set("user:1:email", "alice@example.com")

# è¨­å®šéæœŸæ™‚é–“
client.setex("session:abc123", timedelta(hours=2), "user_data")
client.expire("user:1:name", timedelta(days=30))

# æ‰¹é‡è¨­å®š
client.mset({
    "product:1:name": "ç­†è¨˜å‹é›»è…¦",
    "product:1:price": "25000",
    "product:1:stock": "50"
})

# æ‰¹é‡å–å¾—
values = client.mget(["product:1:name", "product:1:price", "product:1:stock"])
print(f"ç”¢å“è³‡è¨Š: {values}")

# åŸå­æ“ä½œ
client.incr("page:views")
client.incrby("product:1:stock", -1)  # æ¸›å°‘åº«å­˜
new_stock = client.get("product:1:stock")
print(f"æ›´æ–°å¾Œåº«å­˜: {new_stock}")

# æ¢ä»¶è¨­å®š
client.setnx("lock:resource", "1")  # åªåœ¨ä¸å­˜åœ¨æ™‚è¨­å®š
</code></pre>
<h4 id="3-åˆ—è¡¨æ“ä½œç¯„ä¾‹"><a class="header" href="#3-åˆ—è¡¨æ“ä½œç¯„ä¾‹">3. åˆ—è¡¨æ“ä½œç¯„ä¾‹</a></h4>
<pre><code class="language-python">import redis

client = redis.Redis(host='localhost', port=6379, decode_responses=True)

# ä»»å‹™ä½‡åˆ—ç¯„ä¾‹
def add_task(task):
    client.lpush("task:queue", task)
    print(f"æ–°å¢ä»»å‹™: {task}")

def get_task():
    task = client.rpop("task:queue")
    return task

# æ–°å¢ä»»å‹™
add_task("send_email:user123")
add_task("process_payment:order456")
add_task("generate_report:monthly")

# è™•ç†ä»»å‹™
while True:
    task = get_task()
    if task:
        print(f"è™•ç†ä»»å‹™: {task}")
    else:
        print("æ²’æœ‰å¾…è™•ç†ä»»å‹™")
        break

# æœ€è¿‘æ´»å‹•è¨˜éŒ„
client.lpush("user:1:activities", "ç™»å…¥ç³»çµ±")
client.lpush("user:1:activities", "æŸ¥çœ‹è¨‚å–®")
client.lpush("user:1:activities", "ä¿®æ”¹å€‹äººè³‡æ–™")
client.ltrim("user:1:activities", 0, 99)  # åªä¿ç•™æœ€è¿‘100ç­†

# å–å¾—æœ€è¿‘æ´»å‹•
recent_activities = client.lrange("user:1:activities", 0, 4)
print(f"æœ€è¿‘5ç­†æ´»å‹•: {recent_activities}")
</code></pre>
<h4 id="4-é›†åˆæ“ä½œç¯„ä¾‹"><a class="header" href="#4-é›†åˆæ“ä½œç¯„ä¾‹">4. é›†åˆæ“ä½œç¯„ä¾‹</a></h4>
<pre><code class="language-python">import redis

client = redis.Redis(host='localhost', port=6379, decode_responses=True)

# æ¨™ç±¤ç³»çµ±
client.sadd("post:1:tags", "Python", "DragonflyDB", "æ•™å­¸")
client.sadd("post:2:tags", "Python", "Redis", "å¿«å–")
client.sadd("post:3:tags", "JavaScript", "Node.js", "æ•™å­¸")

# æ‰¾å‡ºå…±åŒæ¨™ç±¤
common_tags = client.sinter("post:1:tags", "post:2:tags")
print(f"æ–‡ç« 1å’Œ2çš„å…±åŒæ¨™ç±¤: {common_tags}")

# ä½¿ç”¨è€…èˆˆè¶£
client.sadd("user:alice:interests", "Python", "è³‡æ–™åº«", "æ©Ÿå™¨å­¸ç¿’")
client.sadd("user:bob:interests", "Python", "ç¶²é é–‹ç™¼", "è³‡æ–™åº«")

# æ¨è–¦ç³»çµ± - æ‰¾å‡ºå…±åŒèˆˆè¶£
shared_interests = client.sinter("user:alice:interests", "user:bob:interests")
print(f"Alice å’Œ Bob çš„å…±åŒèˆˆè¶£: {shared_interests}")

# éš¨æ©ŸæŠ½ç
client.sadd("lottery:participants", "user1", "user2", "user3", "user4", "user5")
winner = client.srandmember("lottery:participants")
print(f"ä¸­çè€…: {winner}")
</code></pre>
<h4 id="5-æœ‰åºé›†åˆæ“ä½œç¯„ä¾‹"><a class="header" href="#5-æœ‰åºé›†åˆæ“ä½œç¯„ä¾‹">5. æœ‰åºé›†åˆæ“ä½œç¯„ä¾‹</a></h4>
<pre><code class="language-python">import redis
import time

client = redis.Redis(host='localhost', port=6379, decode_responses=True)

# æ’è¡Œæ¦œç³»çµ±
def update_score(user_id, score):
    client.zadd("leaderboard:global", {user_id: score})

def get_top_players(count=10):
    return client.zrevrange("leaderboard:global", 0, count-1, withscores=True)

def get_user_rank(user_id):
    rank = client.zrevrank("leaderboard:global", user_id)
    return rank + 1 if rank is not None else None

# æ›´æ–°åˆ†æ•¸
update_score("player:alice", 1500)
update_score("player:bob", 2100)
update_score("player:charlie", 1800)
update_score("player:david", 2500)
update_score("player:eve", 1200)

# å–å¾—æ’è¡Œæ¦œ
top_players = get_top_players(3)
print("ğŸ† æ’è¡Œæ¦œå‰ä¸‰å:")
for i, (player, score) in enumerate(top_players, 1):
    print(f"  {i}. {player}: {score:.0f} åˆ†")

# æŸ¥è©¢æ’å
alice_rank = get_user_rank("player:alice")
print(f"\nAlice çš„æ’å: ç¬¬ {alice_rank} å")

# æ™‚é–“åºåˆ—è³‡æ–™
timestamp = int(time.time())
client.zadd("events:timeline", {
    f"event:{timestamp}:login": timestamp,
    f"event:{timestamp+10}:purchase": timestamp + 10,
    f"event:{timestamp+20}:logout": timestamp + 20
})

# æŸ¥è©¢æ™‚é–“ç¯„åœå…§çš„äº‹ä»¶
recent_events = client.zrangebyscore(
    "events:timeline",
    timestamp,
    timestamp + 30,
    withscores=True
)
print(f"\næœ€è¿‘30ç§’çš„äº‹ä»¶: {recent_events}")
</code></pre>
<h4 id="6-é›œæ¹Šæ“ä½œç¯„ä¾‹"><a class="header" href="#6-é›œæ¹Šæ“ä½œç¯„ä¾‹">6. é›œæ¹Šæ“ä½œç¯„ä¾‹</a></h4>
<pre><code class="language-python">import redis

client = redis.Redis(host='localhost', port=6379, decode_responses=True)

# ä½¿ç”¨è€…è³‡æ–™ç®¡ç†
def create_user(user_id, user_data):
    client.hset(f"user:{user_id}", mapping=user_data)

def get_user(user_id):
    return client.hgetall(f"user:{user_id}")

def update_user_field(user_id, field, value):
    client.hset(f"user:{user_id}", field, value)

# å»ºç«‹ä½¿ç”¨è€…
create_user("1001", {
    "username": "alice_wang",
    "email": "alice@example.com",
    "age": "28",
    "city": "è‡ºåŒ—",
    "created_at": "2024-01-15"
})

# å–å¾—ä½¿ç”¨è€…è³‡æ–™
user_data = get_user("1001")
print(f"ä½¿ç”¨è€…è³‡æ–™: {user_data}")

# æ›´æ–°ç‰¹å®šæ¬„ä½
update_user_field("1001", "city", "é«˜é›„")
update_user_field("1001", "last_login", "2024-01-20")

# æª¢æŸ¥æ¬„ä½æ˜¯å¦å­˜åœ¨
exists = client.hexists("user:1001", "email")
print(f"Email æ¬„ä½å­˜åœ¨: {exists}")

# å¢åŠ æ•¸å€¼æ¬„ä½
client.hincrby("user:1001", "login_count", 1)

# è³¼ç‰©è»Šç³»çµ±
def add_to_cart(user_id, product_id, quantity):
    client.hincrby(f"cart:{user_id}", product_id, quantity)

def get_cart(user_id):
    return client.hgetall(f"cart:{user_id}")

def remove_from_cart(user_id, product_id):
    client.hdel(f"cart:{user_id}", product_id)

# è³¼ç‰©è»Šæ“ä½œ
add_to_cart("user:1001", "product:laptop", 1)
add_to_cart("user:1001", "product:mouse", 2)
add_to_cart("user:1001", "product:keyboard", 1)

cart = get_cart("user:1001")
print(f"\nè³¼ç‰©è»Šå…§å®¹: {cart}")
</code></pre>
<h4 id="7-pipeline-æ‰¹æ¬¡æ“ä½œç¯„ä¾‹"><a class="header" href="#7-pipeline-æ‰¹æ¬¡æ“ä½œç¯„ä¾‹">7. Pipeline æ‰¹æ¬¡æ“ä½œç¯„ä¾‹</a></h4>
<pre><code class="language-python">import redis
import time

client = redis.Redis(host='localhost', port=6379, decode_responses=True)

# ä½¿ç”¨ Pipeline æå‡æ•ˆèƒ½
def batch_insert_with_pipeline(count=10000):
    start_time = time.time()

    pipe = client.pipeline()
    for i in range(count):
        pipe.set(f"key:{i}", f"value:{i}")
        if i % 100 == 0:  # æ¯100å€‹å‘½ä»¤åŸ·è¡Œä¸€æ¬¡
            pipe.execute()
            pipe = client.pipeline()

    pipe.execute()  # åŸ·è¡Œå‰©é¤˜çš„å‘½ä»¤

    elapsed = time.time() - start_time
    print(f"Pipeline æ’å…¥ {count} ç­†è³‡æ–™è€—æ™‚: {elapsed:.2f} ç§’")
    print(f"å¹³å‡æ¯ç§’: {count/elapsed:.0f} ops")

# ä¸ä½¿ç”¨ Pipeline çš„å°ç…§çµ„
def batch_insert_without_pipeline(count=1000):
    start_time = time.time()

    for i in range(count):
        client.set(f"test:{i}", f"value:{i}")

    elapsed = time.time() - start_time
    print(f"ä¸€èˆ¬æ’å…¥ {count} ç­†è³‡æ–™è€—æ™‚: {elapsed:.2f} ç§’")
    print(f"å¹³å‡æ¯ç§’: {count/elapsed:.0f} ops")

# æ¸¬è©¦æ•ˆèƒ½å·®ç•°
print("æ•ˆèƒ½æ¯”è¼ƒ:")
batch_insert_without_pipeline(1000)
batch_insert_with_pipeline(10000)

# äº‹å‹™æ€§ Pipeline
def transfer_points(from_user, to_user, points):
    pipe = client.pipeline()
    pipe.watch(f"user:{from_user}:points")

    current_points = int(client.get(f"user:{from_user}:points") or 0)
    if current_points &gt;= points:
        pipe.multi()
        pipe.decrby(f"user:{from_user}:points", points)
        pipe.incrby(f"user:{to_user}:points", points)
        result = pipe.execute()
        return True
    else:
        pipe.reset()
        return False
</code></pre>
<h4 id="8-pubsub-ç™¼å¸ƒè¨‚é–±ç¯„ä¾‹"><a class="header" href="#8-pubsub-ç™¼å¸ƒè¨‚é–±ç¯„ä¾‹">8. Pub/Sub ç™¼å¸ƒè¨‚é–±ç¯„ä¾‹</a></h4>
<pre><code class="language-python">import redis
import threading
import time

# ç™¼å¸ƒè€…
def publisher():
    pub_client = redis.Redis(host='localhost', port=6379, decode_responses=True)
    time.sleep(1)  # ç­‰å¾…è¨‚é–±è€…æº–å‚™å¥½

    messages = [
        {"channel": "news", "message": "çªç™¼æ–°èï¼šDragonflyDB æ•ˆèƒ½æ¸¬è©¦çµæœå‡ºçˆ"},
        {"channel": "news", "message": "ç§‘æŠ€æ–°èï¼šPython 3.13 æ­£å¼ç™¼å¸ƒ"},
        {"channel": "chat:room1", "message": "Alice: å¤§å®¶å¥½ï¼"},
        {"channel": "chat:room1", "message": "Bob: å—¨ï¼ŒAliceï¼"},
    ]

    for msg in messages:
        pub_client.publish(msg["channel"], msg["message"])
        print(f"ğŸ“¢ ç™¼å¸ƒåˆ° {msg['channel']}: {msg['message']}")
        time.sleep(0.5)

# è¨‚é–±è€…
def subscriber():
    sub_client = redis.Redis(host='localhost', port=6379, decode_responses=True)
    pubsub = sub_client.pubsub()

    # è¨‚é–±é »é“
    pubsub.subscribe('news', 'chat:room1')

    # æ¥æ”¶è¨Šæ¯
    for message in pubsub.listen():
        if message['type'] == 'message':
            print(f"ğŸ“¨ æ”¶åˆ° [{message['channel']}]: {message['data']}")

# åŸ·è¡Œç™¼å¸ƒè¨‚é–±ç¯„ä¾‹
if __name__ == "__main__":
    # å•Ÿå‹•è¨‚é–±è€…åŸ·è¡Œç·’
    sub_thread = threading.Thread(target=subscriber)
    sub_thread.daemon = True
    sub_thread.start()

    # å•Ÿå‹•ç™¼å¸ƒè€…
    publisher()

    time.sleep(2)  # ç­‰å¾…æ‰€æœ‰è¨Šæ¯è™•ç†å®Œæˆ
</code></pre>
<h4 id="9-éåŒæ­¥æ“ä½œç¯„ä¾‹"><a class="header" href="#9-éåŒæ­¥æ“ä½œç¯„ä¾‹">9. éåŒæ­¥æ“ä½œç¯„ä¾‹</a></h4>
<pre><code class="language-python">import asyncio
import aioredis

async def async_operations():
    # å»ºç«‹éåŒæ­¥é€£æ¥
    redis = await aioredis.create_redis_pool(
        'redis://localhost:6379',
        encoding='utf-8'
    )

    try:
        # éåŒæ­¥è¨­å®šå€¼
        await redis.set('async:key1', 'value1')
        await redis.set('async:key2', 'value2')

        # éåŒæ­¥æ‰¹é‡æ“ä½œ
        tasks = []
        for i in range(100):
            task = redis.set(f'async:batch:{i}', f'value:{i}')
            tasks.append(task)

        # ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ
        await asyncio.gather(*tasks)

        # éåŒæ­¥å–å€¼
        value = await redis.get('async:key1')
        print(f"éåŒæ­¥å–å¾—çš„å€¼: {value}")

        # éåŒæ­¥ Pipeline
        pipe = redis.pipeline()
        pipe.incr('async:counter')
        pipe.incr('async:counter')
        pipe.incr('async:counter')
        results = await pipe.execute()
        print(f"Pipeline çµæœ: {results}")

    finally:
        redis.close()
        await redis.wait_closed()

# åŸ·è¡ŒéåŒæ­¥æ“ä½œ
# asyncio.run(async_operations())
</code></pre>
<h4 id="10-é€£æ¥æ± ç®¡ç†ç¯„ä¾‹"><a class="header" href="#10-é€£æ¥æ± ç®¡ç†ç¯„ä¾‹">10. é€£æ¥æ± ç®¡ç†ç¯„ä¾‹</a></h4>
<pre><code class="language-python">import redis
from redis import ConnectionPool
from contextlib import contextmanager

# å»ºç«‹å…¨åŸŸé€£æ¥æ± 
pool = ConnectionPool(
    host='localhost',
    port=6379,
    decode_responses=True,
    max_connections=50,
    socket_connect_timeout=5,
    socket_timeout=5,
    retry_on_timeout=True,
    health_check_interval=30
)

# é€£æ¥ç®¡ç†å™¨
@contextmanager
def get_redis_connection():
    client = redis.Redis(connection_pool=pool)
    try:
        yield client
    finally:
        # é€£æ¥æœƒè‡ªå‹•è¿”å›æ± ä¸­
        pass

# ä½¿ç”¨é€£æ¥æ± 
def perform_operations():
    with get_redis_connection() as client:
        # åŸ·è¡Œæ“ä½œ
        client.set("pool:test", "value")
        value = client.get("pool:test")
        print(f"ä½¿ç”¨é€£æ¥æ± å–å¾—: {value}")

# ç›£æ§é€£æ¥æ± ç‹€æ…‹
def check_pool_status():
    with get_redis_connection() as client:
        pool_stats = {
            "created_connections": pool.connection_kwargs,
            "max_connections": pool.max_connections,
            "encoding": pool.encoder.encoding
        }
        print(f"é€£æ¥æ± ç‹€æ…‹: {pool_stats}")

perform_operations()
check_pool_status()
</code></pre>
<h4 id="11-éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶"><a class="header" href="#11-éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶">11. éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶</a></h4>
<pre><code class="language-python">import redis
from redis.exceptions import ConnectionError, TimeoutError, RedisError
import time
from functools import wraps

def retry_on_failure(max_retries=3, delay=1):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            retries = 0
            while retries &lt; max_retries:
                try:
                    return func(*args, **kwargs)
                except (ConnectionError, TimeoutError) as e:
                    retries += 1
                    if retries &gt;= max_retries:
                        print(f"âŒ æ“ä½œå¤±æ•—ï¼Œå·²é‡è©¦ {max_retries} æ¬¡")
                        raise
                    print(f"âš ï¸ é€£æ¥éŒ¯èª¤ï¼Œ{delay}ç§’å¾Œé‡è©¦... (ç¬¬{retries}æ¬¡)")
                    time.sleep(delay)
                except RedisError as e:
                    print(f"âŒ Redis éŒ¯èª¤: {e}")
                    raise
            return None
        return wrapper
    return decorator

@retry_on_failure(max_retries=3, delay=2)
def safe_redis_operation():
    client = redis.Redis(host='localhost', port=6379, decode_responses=True)

    # æ¸¬è©¦é€£æ¥
    client.ping()

    # åŸ·è¡Œæ“ä½œ
    result = client.set("safe:key", "value", ex=3600)
    return result

# ä½¿ç”¨å®‰å…¨æ“ä½œ
try:
    result = safe_redis_operation()
    if result:
        print("âœ… æ“ä½œæˆåŠŸ")
except Exception as e:
    print(f"âŒ æœ€çµ‚å¤±æ•—: {e}")
</code></pre>
<h4 id="12-æ•ˆèƒ½ç›£æ§ç¯„ä¾‹"><a class="header" href="#12-æ•ˆèƒ½ç›£æ§ç¯„ä¾‹">12. æ•ˆèƒ½ç›£æ§ç¯„ä¾‹</a></h4>
<pre><code class="language-python">import redis
import time
from datetime import datetime

class DragonflyDBMonitor:
    def __init__(self, host='localhost', port=6379):
        self.client = redis.Redis(host=host, port=port, decode_responses=True)

    def get_metrics(self):
        """å–å¾— DragonflyDB æ•ˆèƒ½æŒ‡æ¨™"""
        info = self.client.info()

        metrics = {
            'timestamp': datetime.now().isoformat(),
            'clients': {
                'connected': info.get('clients', {}).get('connected_clients', 0),
                'blocked': info.get('clients', {}).get('blocked_clients', 0)
            },
            'memory': {
                'used': info.get('memory', {}).get('used_memory_human', 'N/A'),
                'peak': info.get('memory', {}).get('used_memory_peak_human', 'N/A'),
                'rss': info.get('memory', {}).get('used_memory_rss_human', 'N/A')
            },
            'stats': {
                'total_commands': info.get('stats', {}).get('total_commands_processed', 0),
                'ops_per_sec': info.get('stats', {}).get('instantaneous_ops_per_sec', 0),
                'total_connections': info.get('stats', {}).get('total_connections_received', 0),
                'rejected_connections': info.get('stats', {}).get('rejected_connections', 0)
            },
            'cpu': {
                'used_cpu_sys': info.get('cpu', {}).get('used_cpu_sys', 0),
                'used_cpu_user': info.get('cpu', {}).get('used_cpu_user', 0)
            }
        }

        return metrics

    def benchmark_operations(self, iterations=10000):
        """åŸ·è¡ŒåŸºæº–æ¸¬è©¦"""
        results = {}

        # SET æ“ä½œæ¸¬è©¦
        start = time.time()
        for i in range(iterations):
            self.client.set(f'bench:key:{i}', f'value:{i}')
        set_time = time.time() - start
        results['set_ops_per_sec'] = iterations / set_time

        # GET æ“ä½œæ¸¬è©¦
        start = time.time()
        for i in range(iterations):
            self.client.get(f'bench:key:{i}')
        get_time = time.time() - start
        results['get_ops_per_sec'] = iterations / get_time

        # Pipeline æ¸¬è©¦
        start = time.time()
        pipe = self.client.pipeline()
        for i in range(iterations):
            pipe.set(f'pipe:key:{i}', f'value:{i}')
        pipe.execute()
        pipe_time = time.time() - start
        results['pipeline_ops_per_sec'] = iterations / pipe_time

        # æ¸…ç†æ¸¬è©¦è³‡æ–™
        for i in range(iterations):
            self.client.delete(f'bench:key:{i}', f'pipe:key:{i}')

        return results

    def print_report(self):
        """åˆ—å°æ•ˆèƒ½å ±å‘Š"""
        print("=" * 60)
        print("DragonflyDB æ•ˆèƒ½ç›£æ§å ±å‘Š")
        print("=" * 60)

        metrics = self.get_metrics()

        print(f"\nğŸ“Š é€£æ¥ç‹€æ…‹:")
        print(f"  â€¢ æ´»èºé€£æ¥: {metrics['clients']['connected']}")
        print(f"  â€¢ é˜»å¡é€£æ¥: {metrics['clients']['blocked']}")

        print(f"\nğŸ’¾ è¨˜æ†¶é«”ä½¿ç”¨:")
        print(f"  â€¢ ç•¶å‰ä½¿ç”¨: {metrics['memory']['used']}")
        print(f"  â€¢ å°–å³°ä½¿ç”¨: {metrics['memory']['peak']}")
        print(f"  â€¢ RSS: {metrics['memory']['rss']}")

        print(f"\nâš¡ æ•ˆèƒ½æŒ‡æ¨™:")
        print(f"  â€¢ ç¸½è™•ç†å‘½ä»¤: {metrics['stats']['total_commands']:,}")
        print(f"  â€¢ ç•¶å‰ OPS: {metrics['stats']['ops_per_sec']:,}")

        print(f"\nğŸ§ª åŸºæº–æ¸¬è©¦çµæœ:")
        bench_results = self.benchmark_operations(1000)
        print(f"  â€¢ SET æ•ˆèƒ½: {bench_results['set_ops_per_sec']:.0f} ops/sec")
        print(f"  â€¢ GET æ•ˆèƒ½: {bench_results['get_ops_per_sec']:.0f} ops/sec")
        print(f"  â€¢ Pipeline æ•ˆèƒ½: {bench_results['pipeline_ops_per_sec']:.0f} ops/sec")

        print("=" * 60)

# åŸ·è¡Œç›£æ§
if __name__ == "__main__":
    monitor = DragonflyDBMonitor()
    monitor.print_report()
</code></pre>
<h3 id="å®Œæ•´æ‡‰ç”¨ç¯„ä¾‹å³æ™‚æ’è¡Œæ¦œç³»çµ±"><a class="header" href="#å®Œæ•´æ‡‰ç”¨ç¯„ä¾‹å³æ™‚æ’è¡Œæ¦œç³»çµ±">å®Œæ•´æ‡‰ç”¨ç¯„ä¾‹ï¼šå³æ™‚æ’è¡Œæ¦œç³»çµ±</a></h3>
<pre><code class="language-python">import redis
import random
import time
from datetime import datetime, timedelta

class GameLeaderboard:
    """éŠæˆ²æ’è¡Œæ¦œç³»çµ± - ä½¿ç”¨ DragonflyDB"""

    def __init__(self, host='localhost', port=6379):
        self.client = redis.Redis(host=host, port=port, decode_responses=True)
        self.leaderboard_key = "game:leaderboard:global"
        self.weekly_key = f"game:leaderboard:week:{datetime.now().strftime('%Y-%W')}"
        self.daily_key = f"game:leaderboard:day:{datetime.now().strftime('%Y-%m-%d')}"

    def update_score(self, player_id, score):
        """æ›´æ–°ç©å®¶åˆ†æ•¸"""
        pipe = self.client.pipeline()

        # æ›´æ–°å¤šå€‹æ’è¡Œæ¦œ
        pipe.zadd(self.leaderboard_key, {player_id: score})
        pipe.zadd(self.weekly_key, {player_id: score})
        pipe.zadd(self.daily_key, {player_id: score})

        # è¨˜éŒ„ç©å®¶æœ€é«˜åˆ†
        pipe.hset(f"player:{player_id}", "high_score", score)
        pipe.hset(f"player:{player_id}", "last_played", datetime.now().isoformat())

        pipe.execute()

    def get_leaderboard(self, board_type='global', limit=10):
        """å–å¾—æ’è¡Œæ¦œ"""
        key_map = {
            'global': self.leaderboard_key,
            'weekly': self.weekly_key,
            'daily': self.daily_key
        }

        key = key_map.get(board_type, self.leaderboard_key)
        return self.client.zrevrange(key, 0, limit-1, withscores=True)

    def get_player_rank(self, player_id, board_type='global'):
        """å–å¾—ç©å®¶æ’å"""
        key_map = {
            'global': self.leaderboard_key,
            'weekly': self.weekly_key,
            'daily': self.daily_key
        }

        key = key_map.get(board_type, self.leaderboard_key)
        rank = self.client.zrevrank(key, player_id)
        score = self.client.zscore(key, player_id)

        return {
            'rank': rank + 1 if rank is not None else None,
            'score': score
        }

    def get_nearby_players(self, player_id, distance=2):
        """å–å¾—é™„è¿‘æ’åçš„ç©å®¶"""
        rank = self.client.zrevrank(self.leaderboard_key, player_id)
        if rank is None:
            return []

        start = max(0, rank - distance)
        end = rank + distance

        return self.client.zrevrange(
            self.leaderboard_key,
            start,
            end,
            withscores=True
        )

    def simulate_game(self, num_players=100, num_rounds=10):
        """æ¨¡æ“¬éŠæˆ²é€²è¡Œ"""
        print("ğŸ® é–‹å§‹éŠæˆ²æ¨¡æ“¬...")

        # å»ºç«‹ç©å®¶
        players = [f"player_{i:03d}" for i in range(num_players)]

        # æ¨¡æ“¬å¤šè¼ªéŠæˆ²
        for round_num in range(num_rounds):
            print(f"\nç¬¬ {round_num + 1} è¼ª:")

            # éš¨æ©Ÿé¸æ“‡ç©å®¶ä¸¦æ›´æ–°åˆ†æ•¸
            active_players = random.sample(players, k=random.randint(10, 30))
            for player in active_players:
                score = random.randint(100, 10000)
                self.update_score(player, score)

            # é¡¯ç¤ºç•¶å‰å‰5å
            top_5 = self.get_leaderboard(limit=5)
            print("  ç›®å‰æ’è¡Œæ¦œå‰5å:")
            for i, (player, score) in enumerate(top_5, 1):
                print(f"    {i}. {player}: {score:.0f}åˆ†")

            time.sleep(0.5)

        # é¡¯ç¤ºæœ€çµ‚çµæœ
        print("\n" + "="*50)
        print("ğŸ† æœ€çµ‚æ’è¡Œæ¦œ")
        print("="*50)

        # å…¨çƒæ’è¡Œæ¦œ
        print("\nğŸ“Š å…¨çƒæ’è¡Œæ¦œå‰10å:")
        global_top = self.get_leaderboard('global', limit=10)
        for i, (player, score) in enumerate(global_top, 1):
            print(f"  {i:2d}. {player}: {score:.0f}åˆ†")

        # æŸ¥è©¢ç‰¹å®šç©å®¶
        sample_player = random.choice(players)
        player_stats = self.get_player_rank(sample_player)
        print(f"\nğŸ‘¤ {sample_player} çš„æ’å:")
        print(f"  â€¢ å…¨çƒæ’å: ç¬¬ {player_stats['rank']} å")
        print(f"  â€¢ åˆ†æ•¸: {player_stats['score']:.0f}")

        # é¡¯ç¤ºé™„è¿‘ç©å®¶
        nearby = self.get_nearby_players(sample_player, distance=2)
        print(f"\nğŸ“ {sample_player} é™„è¿‘çš„ç©å®¶:")
        for player, score in nearby:
            marker = " â† (ä½ )" if player == sample_player else ""
            print(f"  â€¢ {player}: {score:.0f}åˆ†{marker}")

# åŸ·è¡Œç¯„ä¾‹
if __name__ == "__main__":
    leaderboard = GameLeaderboard()
    leaderboard.simulate_game(num_players=50, num_rounds=5)
</code></pre>
<h2 id="redis-vs-dragonflydb-è©³ç´°æ¯”è¼ƒ"><a class="header" href="#redis-vs-dragonflydb-è©³ç´°æ¯”è¼ƒ">Redis vs DragonflyDB è©³ç´°æ¯”è¼ƒ</a></h2>
<h3 id="æ¶æ§‹å·®ç•°"><a class="header" href="#æ¶æ§‹å·®ç•°">æ¶æ§‹å·®ç•°</a></h3>
<div class="table-wrapper"><table><thead><tr><th>ç‰¹æ€§</th><th>Redis</th><th>DragonflyDB</th></tr></thead><tbody>
<tr><td><strong>æ ¸å¿ƒæ¶æ§‹</strong></td><td>å–®åŸ·è¡Œç·’äº‹ä»¶å¾ªç’°</td><td>å¤šåŸ·è¡Œç·’ã€å…±äº«ç„¡é–æ¶æ§‹</td></tr>
<tr><td><strong>ä¸¦ç™¼æ¨¡å‹</strong></td><td>å–®åŸ·è¡Œç·’è™•ç†å‘½ä»¤</td><td>åˆ©ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ</td></tr>
<tr><td><strong>è¨˜æ†¶é«”ç®¡ç†</strong></td><td>jemalloc</td><td>mimalloc + è‡ªè¨‚æœ€ä½³åŒ–</td></tr>
<tr><td><strong>æŒä¹…åŒ–</strong></td><td>RDB + AOF</td><td>RDB + æ”¹é€²çš„å¿«ç…§æ©Ÿåˆ¶</td></tr>
<tr><td><strong>è³‡æ–™çµæ§‹</strong></td><td>æ¨™æº– Redis è³‡æ–™çµæ§‹</td><td>ç›¸åŒè³‡æ–™çµæ§‹ + å…§éƒ¨æœ€ä½³åŒ–</td></tr>
</tbody></table>
</div>
<h3 id="æ•ˆèƒ½æ¯”è¼ƒ"><a class="header" href="#æ•ˆèƒ½æ¯”è¼ƒ">æ•ˆèƒ½æ¯”è¼ƒ</a></h3>
<div class="table-wrapper"><table><thead><tr><th>æŒ‡æ¨™</th><th>Redis</th><th>DragonflyDB</th></tr></thead><tbody>
<tr><td><strong>ååé‡</strong></td><td>~100K ops/sec (å–®æ ¸)</td><td>~4M ops/sec (32æ ¸)</td></tr>
<tr><td><strong>å»¶é²</strong></td><td>&lt; 1ms (P99)</td><td>&lt; 1ms (P99)</td></tr>
<tr><td><strong>å‚ç›´æ“´å±•</strong></td><td>å—é™æ–¼å–®æ ¸</td><td>ç·šæ€§æ“´å±•è‡³æ‰€æœ‰æ ¸å¿ƒ</td></tr>
<tr><td><strong>è¨˜æ†¶é«”æ•ˆç‡</strong></td><td>åŸºæº–</td><td>ç¯€çœ 30-50%</td></tr>
<tr><td><strong>å•Ÿå‹•æ™‚é–“</strong></td><td>å¿«é€Ÿ</td><td>å¿«é€Ÿ</td></tr>
</tbody></table>
</div>
<h3 id="åŠŸèƒ½å°æ¯”"><a class="header" href="#åŠŸèƒ½å°æ¯”">åŠŸèƒ½å°æ¯”</a></h3>
<div class="table-wrapper"><table><thead><tr><th>åŠŸèƒ½</th><th>Redis</th><th>DragonflyDB</th></tr></thead><tbody>
<tr><td><strong>Redis å”è­°ç›¸å®¹æ€§</strong></td><td>100% (åŸç”Ÿ)</td><td>99%+</td></tr>
<tr><td><strong>å¢é›†æ”¯æ´</strong></td><td>Redis Cluster</td><td>å–®ç¯€é»å³å¯è™•ç†å¤§è¦æ¨¡</td></tr>
<tr><td><strong>Lua è…³æœ¬</strong></td><td>âœ… æ”¯æ´</td><td>âœ… æ”¯æ´</td></tr>
<tr><td><strong>Pub/Sub</strong></td><td>âœ… æ”¯æ´</td><td>âœ… æ”¯æ´</td></tr>
<tr><td><strong>äº‹å‹™</strong></td><td>âœ… MULTI/EXEC</td><td>âœ… æ”¯æ´</td></tr>
<tr><td><strong>ä¸²æµ (Streams)</strong></td><td>âœ… æ”¯æ´</td><td>âœ… æ”¯æ´</td></tr>
<tr><td><strong>æ¨¡çµ„ç³»çµ±</strong></td><td>âœ… è±å¯Œç”Ÿæ…‹ç³»</td><td>âŒ ä¸æ”¯æ´ Redis æ¨¡çµ„</td></tr>
<tr><td><strong>åœ°ç†ç©ºé–“</strong></td><td>âœ… æ”¯æ´</td><td>âœ… æ”¯æ´</td></tr>
<tr><td><strong>JSON</strong></td><td>éœ€è¦ RedisJSON æ¨¡çµ„</td><td>åŸç”Ÿæ”¯æ´åŸºæœ¬ JSON</td></tr>
</tbody></table>
</div>
<h3 id="å„ªç¼ºé»åˆ†æ"><a class="header" href="#å„ªç¼ºé»åˆ†æ">å„ªç¼ºé»åˆ†æ</a></h3>
<h4 id="redis-å„ªé»"><a class="header" href="#redis-å„ªé»">Redis å„ªé»</a></h4>
<p>âœ… <strong>æˆç†Ÿç©©å®š</strong> - è¶…é 15 å¹´çš„ç”Ÿç”¢ç’°å¢ƒé©—è­‰<br />
âœ… <strong>ç”Ÿæ…‹ç³»çµ±è±å¯Œ</strong> - å¤§é‡å·¥å…·ã€å®¢æˆ¶ç«¯ã€æ¨¡çµ„<br />
âœ… <strong>ç¤¾ç¾¤é¾å¤§</strong> - å»£æ³›çš„ç¤¾ç¾¤æ”¯æ´å’Œè³‡æº<br />
âœ… <strong>æ–‡ä»¶å®Œæ•´</strong> - è©³ç›¡çš„å®˜æ–¹æ–‡ä»¶å’Œæ•™å­¸<br />
âœ… <strong>æ¨¡çµ„æ“´å±•</strong> - RedisJSONã€RedisSearchã€RedisGraph ç­‰<br />
âœ… <strong>ä¼æ¥­æ”¯æ´</strong> - Redis Enterprise æä¾›å•†æ¥­æ”¯æ´</p>
<h4 id="redis-ç¼ºé»"><a class="header" href="#redis-ç¼ºé»">Redis ç¼ºé»</a></h4>
<p>âŒ <strong>å–®åŸ·è¡Œç·’é™åˆ¶</strong> - ç„¡æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU<br />
âŒ <strong>è¨˜æ†¶é«”ä½¿ç”¨è¼ƒé«˜</strong> - ç›¸åŒè³‡æ–™éœ€è¦æ›´å¤šè¨˜æ†¶é«”<br />
âŒ <strong>æ“´å±•è¤‡é›œ</strong> - éœ€è¦ Redis Cluster æˆ– Sentinel<br />
âŒ <strong>å¤§è³‡æ–™é›†å•Ÿå‹•æ…¢</strong> - RDB è¼‰å…¥å¯èƒ½å¾ˆæ…¢<br />
âŒ <strong>Fork é–‹éŠ·</strong> - æŒä¹…åŒ–æ™‚çš„ fork æ“ä½œé–‹éŠ·å¤§</p>
<h4 id="dragonflydb-å„ªé»"><a class="header" href="#dragonflydb-å„ªé»">DragonflyDB å„ªé»</a></h4>
<p>âœ… <strong>è¶…é«˜æ•ˆèƒ½</strong> - å¯é” Redis 25 å€æ•ˆèƒ½<br />
âœ… <strong>å¤šæ ¸å¿ƒåˆ©ç”¨</strong> - è‡ªå‹•ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ<br />
âœ… <strong>è¨˜æ†¶é«”æ•ˆç‡</strong> - ç¯€çœ 30-50% è¨˜æ†¶é«”<br />
âœ… <strong>ç„¡éœ€å¢é›†</strong> - å–®å¯¦ä¾‹è™•ç† TB ç´šè³‡æ–™<br />
âœ… <strong>å¿«ç…§ä¸é˜»å¡</strong> - æ”¹é€²çš„æŒä¹…åŒ–æ©Ÿåˆ¶<br />
âœ… <strong>ç¾ä»£æ¶æ§‹</strong> - ä½¿ç”¨ C++20 å’Œç¾ä»£æŠ€è¡“<br />
âœ… <strong>ç›¸å®¹æ€§ä½³</strong> - å¹¾ä¹å®Œå…¨ç›¸å®¹ Redis API</p>
<h4 id="dragonflydb-ç¼ºé»"><a class="header" href="#dragonflydb-ç¼ºé»">DragonflyDB ç¼ºé»</a></h4>
<p>âŒ <strong>ç›¸å°è¼ƒæ–°</strong> - 2022 å¹´æ¨å‡ºï¼Œç”Ÿç”¢ç’°å¢ƒç¶“é©—è¼ƒå°‘<br />
âŒ <strong>ç”Ÿæ…‹ç³»çµ±å°</strong> - å·¥å…·å’Œè³‡æºç›¸å°è¼ƒå°‘<br />
âŒ <strong>ç„¡æ¨¡çµ„æ”¯æ´</strong> - ä¸æ”¯æ´ Redis æ¨¡çµ„<br />
âŒ <strong>ç¤¾ç¾¤è¼ƒå°</strong> - ç¤¾ç¾¤æ”¯æ´å’Œè³‡æºæœ‰é™<br />
âŒ <strong>åŠŸèƒ½å·®ç•°</strong> - æŸäº›é€²éšåŠŸèƒ½å¯èƒ½ç•¥æœ‰ä¸åŒ<br />
âŒ <strong>ä¼æ¥­æ”¯æ´æœ‰é™</strong> - å•†æ¥­æ”¯æ´é¸é …è¼ƒå°‘</p>
<h2 id="æ•ˆèƒ½åŸºæº–æ¸¬è©¦"><a class="header" href="#æ•ˆèƒ½åŸºæº–æ¸¬è©¦">æ•ˆèƒ½åŸºæº–æ¸¬è©¦</a></h2>
<h3 id="æ¸¬è©¦ç’°å¢ƒ"><a class="header" href="#æ¸¬è©¦ç’°å¢ƒ">æ¸¬è©¦ç’°å¢ƒ</a></h3>
<ul>
<li>CPU: 32 æ ¸å¿ƒ</li>
<li>RAM: 128GB</li>
<li>è³‡æ–™é›†: 10GB</li>
</ul>
<h3 id="æ¸¬è©¦çµæœ"><a class="header" href="#æ¸¬è©¦çµæœ">æ¸¬è©¦çµæœ</a></h3>
<h4 id="set-æ“ä½œ-opssec"><a class="header" href="#set-æ“ä½œ-opssec">SET æ“ä½œ (ops/sec)</a></h4>
<pre><code>Redis (å–®æ ¸):        120,000
Redis (å¢é›†-8ç¯€é»):   800,000
DragonflyDB:       3,800,000
</code></pre>
<h4 id="get-æ“ä½œ-opssec"><a class="header" href="#get-æ“ä½œ-opssec">GET æ“ä½œ (ops/sec)</a></h4>
<pre><code>Redis (å–®æ ¸):        130,000
Redis (å¢é›†-8ç¯€é»):   900,000
DragonflyDB:       4,200,000
</code></pre>
<h4 id="è¨˜æ†¶é«”ä½¿ç”¨-10m-keys"><a class="header" href="#è¨˜æ†¶é«”ä½¿ç”¨-10m-keys">è¨˜æ†¶é«”ä½¿ç”¨ (10M keys)</a></h4>
<pre><code>Redis:          8.5 GB
DragonflyDB:    5.2 GB
ç¯€çœ:           39%
</code></pre>
<h2 id="é¸æ“‡å»ºè­°"><a class="header" href="#é¸æ“‡å»ºè­°">é¸æ“‡å»ºè­°</a></h2>
<h3 id="é¸æ“‡-redis-çš„æƒ…æ³"><a class="header" href="#é¸æ“‡-redis-çš„æƒ…æ³">é¸æ“‡ Redis çš„æƒ…æ³</a></h3>
<ol>
<li>
<p><strong>ç©©å®šæ€§å„ªå…ˆ</strong></p>
<ul>
<li>é‡‘èã€é†«ç™‚ç­‰é—œéµæ‡‰ç”¨</li>
<li>éœ€è¦é•·æœŸç©©å®šé‹è¡Œçš„ç”Ÿç”¢ç’°å¢ƒ</li>
</ul>
</li>
<li>
<p><strong>éœ€è¦ç‰¹å®šæ¨¡çµ„</strong></p>
<ul>
<li>éœ€è¦ RedisSearch é€²è¡Œå…¨æ–‡æœå°‹</li>
<li>éœ€è¦ RedisGraph é€²è¡Œåœ–å½¢è³‡æ–™åº«æ“ä½œ</li>
<li>éœ€è¦ RedisTimeSeries é€²è¡Œæ™‚åºè³‡æ–™è™•ç†</li>
</ul>
</li>
<li>
<p><strong>ä¼æ¥­æ”¯æ´éœ€æ±‚</strong></p>
<ul>
<li>éœ€è¦å•†æ¥­ç´šæŠ€è¡“æ”¯æ´</li>
<li>éœ€è¦ SLA ä¿è­‰</li>
</ul>
</li>
<li>
<p><strong>ä¿å®ˆçš„æŠ€è¡“ç­–ç•¥</strong></p>
<ul>
<li>åœ˜éšŠç†Ÿæ‚‰ Redis</li>
<li>ä¸é¡˜æ‰¿æ“”æ–°æŠ€è¡“é¢¨éšª</li>
</ul>
</li>
</ol>
<h3 id="é¸æ“‡-dragonflydb-çš„æƒ…æ³"><a class="header" href="#é¸æ“‡-dragonflydb-çš„æƒ…æ³">é¸æ“‡ DragonflyDB çš„æƒ…æ³</a></h3>
<ol>
<li>
<p><strong>æ•ˆèƒ½éœ€æ±‚é«˜</strong></p>
<ul>
<li>éœ€è¦è™•ç†ç™¾è¬ç´š QPS</li>
<li>ä½å»¶é²è¦æ±‚åš´æ ¼</li>
</ul>
</li>
<li>
<p><strong>æˆæœ¬æ•æ„Ÿ</strong></p>
<ul>
<li>å¸Œæœ›æ¸›å°‘ä¼ºæœå™¨æ•¸é‡</li>
<li>éœ€è¦é™ä½è¨˜æ†¶é«”æˆæœ¬</li>
</ul>
</li>
<li>
<p><strong>å¤§è¦æ¨¡è³‡æ–™</strong></p>
<ul>
<li>å–®æ©Ÿéœ€è¦è™•ç† TB ç´šè³‡æ–™</li>
<li>ä¸æƒ³ç®¡ç†è¤‡é›œçš„å¢é›†</li>
</ul>
</li>
<li>
<p><strong>æ–°å°ˆæ¡ˆ</strong></p>
<ul>
<li>å…¨æ–°çš„å°ˆæ¡ˆï¼Œæ²’æœ‰æ­·å²åŒ…è¢±</li>
<li>å¯ä»¥æ¥å—è¼ƒæ–°æŠ€è¡“</li>
</ul>
</li>
</ol>
<h3 id="æ··åˆä½¿ç”¨ç­–ç•¥"><a class="header" href="#æ··åˆä½¿ç”¨ç­–ç•¥">æ··åˆä½¿ç”¨ç­–ç•¥</a></h3>
<pre><code>ç”Ÿç”¢ç’°å¢ƒé—œéµæœå‹™ â†’ Redis
é«˜æµé‡å¿«å–å±¤ â†’ DragonflyDB  
é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ â†’ DragonflyDB
è³‡æ–™åˆ†æå¿«å– â†’ DragonflyDB
</code></pre>
<h2 id="é·ç§»æŒ‡å—"><a class="header" href="#é·ç§»æŒ‡å—">é·ç§»æŒ‡å—</a></h2>
<h3 id="å¾-redis-é·ç§»åˆ°-dragonflydb"><a class="header" href="#å¾-redis-é·ç§»åˆ°-dragonflydb">å¾ Redis é·ç§»åˆ° DragonflyDB</a></h3>
<ol>
<li><strong>ç›¸å®¹æ€§æ¸¬è©¦</strong></li>
</ol>
<pre><code class="language-bash"># ä½¿ç”¨ redis-cli æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
redis-cli -h dragonfly-host ping
redis-cli -h dragonfly-host set test "value"
redis-cli -h dragonfly-host get test
</code></pre>
<ol start="2">
<li><strong>è³‡æ–™é·ç§»</strong></li>
</ol>
<pre><code class="language-bash"># æ–¹æ³•ä¸€ï¼šä½¿ç”¨ REPLICAOF
# åœ¨ DragonflyDB ä¸­åŸ·è¡Œ
REPLICAOF redis-host 6379

# æ–¹æ³•äºŒï¼šä½¿ç”¨ redis-dump
redis-dump -h redis-host | redis-load -h dragonfly-host
</code></pre>
<ol start="3">
<li><strong>æ‡‰ç”¨ç¨‹å¼èª¿æ•´</strong></li>
</ol>
<pre><code class="language-python"># ä¸éœ€è¦ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œåªéœ€æ”¹è®Šé€£æ¥å­—ä¸²
# å¾
client = redis.Redis(host='redis-host', port=6379)
# åˆ°
client = redis.Redis(host='dragonfly-host', port=6379)
</code></pre>
<h2 id="ç›£æ§å’Œç¶­é‹"><a class="header" href="#ç›£æ§å’Œç¶­é‹">ç›£æ§å’Œç¶­é‹</a></h2>
<h3 id="dragonflydb-ç›£æ§æŒ‡æ¨™"><a class="header" href="#dragonflydb-ç›£æ§æŒ‡æ¨™">DragonflyDB ç›£æ§æŒ‡æ¨™</a></h3>
<pre><code class="language-bash"># æŸ¥çœ‹çµ±è¨ˆè³‡è¨Š
redis-cli -h dragonfly-host INFO

# ç›£æ§é‡è¦æŒ‡æ¨™
- used_memory: ä½¿ç”¨çš„è¨˜æ†¶é«”
- connected_clients: é€£æ¥çš„å®¢æˆ¶ç«¯æ•¸
- total_commands_processed: è™•ç†çš„å‘½ä»¤ç¸½æ•¸
- instantaneous_ops_per_sec: å³æ™‚ OPS
</code></pre>
<h3 id="æ•ˆèƒ½å„ªåŒ–å»ºè­°"><a class="header" href="#æ•ˆèƒ½å„ªåŒ–å»ºè­°">æ•ˆèƒ½å„ªåŒ–å»ºè­°</a></h3>
<ol>
<li><strong>DragonflyDB å„ªåŒ–</strong></li>
</ol>
<pre><code class="language-bash"># è¨­å®šæœ€å¤§è¨˜æ†¶é«”
./dragonfly --maxmemory=32gb

# è¨­å®šåŸ·è¡Œç·’æ•¸ï¼ˆé è¨­ä½¿ç”¨æ‰€æœ‰æ ¸å¿ƒï¼‰
./dragonfly --proactor_threads=16

# å•Ÿç”¨å¿«ç…§
./dragonfly --dbfilename=dump.rdb --save_schedule="0 1"
</code></pre>
<ol start="2">
<li><strong>å®¢æˆ¶ç«¯å„ªåŒ–</strong></li>
</ol>
<pre><code class="language-python"># ä½¿ç”¨é€£æ¥æ± 
pool = redis.ConnectionPool(
    host='localhost',
    port=6379,
    max_connections=50
)
client = redis.Redis(connection_pool=pool)

# ä½¿ç”¨ Pipeline æ‰¹æ¬¡æ“ä½œ
pipe = client.pipeline()
for i in range(10000):
    pipe.set(f'key_{i}', f'value_{i}')
pipe.execute()
</code></pre>
<h2 id="ç¸½çµ"><a class="header" href="#ç¸½çµ">ç¸½çµ</a></h2>
<h3 id="å¿«é€Ÿæ±ºç­–çŸ©é™£"><a class="header" href="#å¿«é€Ÿæ±ºç­–çŸ©é™£">å¿«é€Ÿæ±ºç­–çŸ©é™£</a></h3>
<div class="table-wrapper"><table><thead><tr><th>éœ€æ±‚</th><th>æ¨è–¦é¸æ“‡</th></tr></thead><tbody>
<tr><td>ç©©å®šæ€§æœ€é‡è¦</td><td>Redis</td></tr>
<tr><td>æ•ˆèƒ½æœ€é‡è¦</td><td>DragonflyDB</td></tr>
<tr><td>éœ€è¦ Redis æ¨¡çµ„</td><td>Redis</td></tr>
<tr><td>æˆæœ¬æ§åˆ¶</td><td>DragonflyDB</td></tr>
<tr><td>å°å‹æ‡‰ç”¨</td><td>Redis</td></tr>
<tr><td>å¤§è¦æ¨¡æ‡‰ç”¨</td><td>DragonflyDB</td></tr>
<tr><td>ä¿å®ˆç­–ç•¥</td><td>Redis</td></tr>
<tr><td>å‰µæ–°ç­–ç•¥</td><td>DragonflyDB</td></tr>
</tbody></table>
</div>
<h3 id="æœªä¾†å±•æœ›"><a class="header" href="#æœªä¾†å±•æœ›">æœªä¾†å±•æœ›</a></h3>
<ul>
<li><strong>Redis</strong>: æŒçºŒå„ªåŒ–ï¼ŒåŠ å¼·ä¼æ¥­åŠŸèƒ½ï¼Œæ“´å±•æ¨¡çµ„ç”Ÿæ…‹</li>
<li><strong>DragonflyDB</strong>: å¿«é€Ÿç™¼å±•ï¼Œå¢åŠ åŠŸèƒ½ï¼Œå»ºç«‹ç”Ÿæ…‹ç³»çµ±</li>
</ul>
<p>å…©è€…éƒ½æ˜¯å„ªç§€çš„è¨˜æ†¶é«”è³‡æ–™åº«ï¼Œé¸æ“‡å–æ±ºæ–¼å…·é«”éœ€æ±‚ã€é¢¨éšªæ‰¿å—åº¦å’ŒæŠ€è¡“ç­–ç•¥ã€‚å»ºè­°å…ˆåœ¨éé—œéµç’°å¢ƒæ¸¬è©¦ DragonflyDBï¼Œè©•ä¼°æ˜¯å¦ç¬¦åˆéœ€æ±‚å¾Œå†æ±ºå®šæ˜¯å¦æ¡ç”¨ã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../database/hash.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../database/clickhouse.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../database/hash.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../database/clickhouse.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
