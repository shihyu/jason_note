<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Node.js I/O 並發範例 - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="nodejs-io-並發範例"><a class="header" href="#nodejs-io-並發範例">Node.js I/O 並發範例</a></h1>
<blockquote>
<p>三種常見的 Node.js 並發模式：異步並發、Worker Threads、文件 I/O</p>
</blockquote>
<hr />
<h2 id="目錄"><a class="header" href="#目錄">目錄</a></h2>
<ol>
<li><a href="#1-%E5%9F%BA%E7%A4%8E%E7%95%B0%E6%AD%A5-io-%E4%B8%A6%E7%99%BC%E5%96%AE%E7%B7%9A%E7%A8%8B">基礎異步 I/O 並發（單線程）</a></li>
<li><a href="#2-worker-threads-%E5%A4%9A%E7%B7%9A%E7%A8%8B%E7%89%88%E6%9C%AC">Worker Threads 多線程版本</a></li>
<li><a href="#3-%E6%96%87%E4%BB%B6-io-%E4%B8%A6%E7%99%BC%E8%AE%80%E5%8F%96">文件 I/O 並發讀取</a></li>
<li><a href="#%E5%96%AE%E7%B7%9A%E7%A8%8B-vs-%E5%A4%9A%E7%B7%9A%E7%A8%8B%E5%B0%8D%E6%AF%94">單線程 vs 多線程對比</a></li>
<li><a href="#%E4%BD%A0%E7%9A%84%E4%BB%A3%E7%A2%BC%E5%88%86%E6%9E%90">你的代碼分析</a></li>
</ol>
<hr />
<h2 id="1-基礎異步-io-並發單線程"><a class="header" href="#1-基礎異步-io-並發單線程">1. 基礎異步 I/O 並發（單線程）</a></h2>
<p><strong>檔案：<code>simple-io-concurrent.js</code></strong></p>
<pre><code class="language-javascript">// simple-io-concurrent.js
const fs = require('fs').promises;

async function task(id, delay) {
  const start = Date.now();
  console.log(`[${id}] 開始 | PID: ${process.pid} | 主線程`);

  // 模擬異步 I/O
  await new Promise(r =&gt; setTimeout(r, delay));

  const elapsed = Date.now() - start;
  console.log(`[${id}] 完成 | 耗時: ${elapsed}ms`);
  return { id, elapsed };
}

async function main() {
  console.log(`主進程 PID: ${process.pid}\n`);

  const start = Date.now();

  // 並發執行 5 個任務
  const results = await Promise.all([
    task('任務A', 1000),
    task('任務B', 500),
    task('任務C', 800),
    task('任務D', 300),
    task('任務E', 1200)
  ]);

  const total = Date.now() - start;
  console.log(`\n全部完成 | 總耗時: ${total}ms`);
  console.log('結果:', results);
}

main();
</code></pre>
<p><strong>執行：</strong></p>
<pre><code class="language-bash">node simple-io-concurrent.js
</code></pre>
<p><strong>輸出示例：</strong></p>
<pre><code>主進程 PID: 12345

[任務A] 開始 | PID: 12345 | 主線程
[任務B] 開始 | PID: 12345 | 主線程
[任務C] 開始 | PID: 12345 | 主線程
[任務D] 開始 | PID: 12345 | 主線程
[任務E] 開始 | PID: 12345 | 主線程
[任務D] 完成 | 耗時: 302ms
[任務B] 完成 | 耗時: 503ms
[任務C] 完成 | 耗時: 802ms
[任務A] 完成 | 耗時: 1001ms
[任務E] 完成 | 耗時: 1202ms

全部完成 | 總耗時: 1205ms
結果: [
  { id: '任務A', elapsed: 1001 },
  { id: '任務B', elapsed: 503 },
  { id: '任務C', elapsed: 802 },
  { id: '任務D', elapsed: 302 },
  { id: '任務E', elapsed: 1202 }
]
</code></pre>
<p><strong>特點：</strong></p>
<ul>
<li>單線程，所有任務共享同一個 PID</li>
<li>使用 <code>Promise.all</code> 實現並發</li>
<li>適合 I/O 密集型任務</li>
<li>總耗時約等於最慢任務（1200ms），而非累加（4000ms）</li>
</ul>
<hr />
<h2 id="2-worker-threads-多線程版本"><a class="header" href="#2-worker-threads-多線程版本">2. Worker Threads 多線程版本</a></h2>
<p><strong>檔案：<code>worker-threads-example.js</code></strong></p>
<pre><code class="language-javascript">// worker-threads-example.js
const { Worker, isMainThread, parentPort, threadId, workerData } = require('worker_threads');

if (isMainThread) {
  // === 主線程 ===
  console.log(`主進程 PID: ${process.pid} | TID: ${threadId}\n`);

  const start = Date.now();
  const workers = [];

  // 創建 5 個 worker
  for (let i = 1; i &lt;= 5; i++) {
    const worker = new Worker(__filename, {
      workerData: { taskId: i, delay: Math.random() * 1000 + 500 }
    });

    workers.push(new Promise((resolve, reject) =&gt; {
      worker.on('message', msg =&gt; {
        console.log(`Task ${msg.taskId} 完成 | 耗時: ${msg.elapsed}ms`);
        resolve(msg);
      });
      worker.on('error', reject);
      worker.on('exit', code =&gt; {
        if (code !== 0) reject(new Error(`Worker stopped with exit code ${code}`));
      });
    }));
  }

  // 等待所有 worker 完成
  Promise.all(workers).then(results =&gt; {
    const total = Date.now() - start;
    console.log(`\n全部完成 | 總耗時: ${total}ms`);
    console.log(`處理: ${results.length} 個任務`);
  });

} else {
  // === Worker 線程 ===
  const { taskId, delay } = workerData;
  const start = Date.now();

  console.log(`[Task ${taskId}] 開始 | PID: ${process.pid} | Worker TID: ${threadId}`);

  // 模擬工作
  setTimeout(() =&gt; {
    const elapsed = Date.now() - start;
    parentPort.postMessage({ taskId: `Task ${taskId}`, elapsed });
  }, delay);
}
</code></pre>
<p><strong>執行：</strong></p>
<pre><code class="language-bash">node worker-threads-example.js
</code></pre>
<p><strong>輸出示例：</strong></p>
<pre><code>主進程 PID: 12345 | TID: 0

[Task 1] 開始 | PID: 12345 | Worker TID: 1
[Task 2] 開始 | PID: 12345 | Worker TID: 2
[Task 3] 開始 | PID: 12345 | Worker TID: 3
[Task 4] 開始 | PID: 12345 | Worker TID: 4
[Task 5] 開始 | PID: 12345 | Worker TID: 5
Task 2 完成 | 耗時: 523ms
Task 4 完成 | 耗時: 678ms
Task 1 完成 | 耗時: 891ms
Task 5 完成 | 耗時: 1034ms
Task 3 完成 | 耗時: 1256ms

全部完成 | 總耗時: 1258ms
處理: 5 個任務
</code></pre>
<p><strong>特點：</strong></p>
<ul>
<li>多線程，每個 Worker 有獨立的 TID</li>
<li>相同 PID（同一進程）</li>
<li>適合 CPU 密集型任務</li>
<li>更高的內存開銷</li>
</ul>
<hr />
<h2 id="3-文件-io-並發讀取"><a class="header" href="#3-文件-io-並發讀取">3. 文件 I/O 並發讀取</a></h2>
<p><strong>檔案：<code>file-io-concurrent.js</code></strong></p>
<pre><code class="language-javascript">// file-io-concurrent.js
const fs = require('fs').promises;
const path = require('path');

async function readFile(filename, id) {
  console.log(`[${id}] 開始讀取 ${filename} | PID: ${process.pid}`);

  try {
    const content = await fs.readFile(filename, 'utf-8');
    console.log(`[${id}] ${filename} | 大小: ${content.length} bytes`);
    return { filename, size: content.length };
  } catch (e) {
    console.log(`[${id}] ${filename} | 錯誤: ${e.message}`);
    return { filename, error: e.message };
  }
}

async function main() {
  console.log(`PID: ${process.pid}\n`);

  // 準備測試文件（創建幾個測試文件）
  const testDir = path.join(__dirname, 'tmp');
  await fs.mkdir(testDir, { recursive: true });

  const testFiles = ['test1.txt', 'test2.txt', 'test3.txt'].map(f =&gt; path.join(testDir, f));
  for (const f of testFiles) {
    await fs.writeFile(f, `內容 ${path.basename(f)} `.repeat(1000));
  }

  const start = Date.now();

  // 並發讀取
  const results = await Promise.all(
    testFiles.map((f, i) =&gt; readFile(f, i + 1))
  );

  console.log(`\n總耗時: ${Date.now() - start}ms`);
  console.log('結果:', results);

  // 清理
  for (const f of testFiles) {
    await fs.unlink(f);
  }
  await fs.rmdir(testDir);
}

main();
</code></pre>
<p><strong>執行：</strong></p>
<pre><code class="language-bash">node file-io-concurrent.js
</code></pre>
<p><strong>輸出示例：</strong></p>
<pre><code>PID: 12345

[1] 開始讀取 test1.txt | PID: 12345
[2] 開始讀取 test2.txt | PID: 12345
[3] 開始讀取 test3.txt | PID: 12345
[1] test1.txt | 大小: 11000 bytes
[2] test2.txt | 大小: 11000 bytes
[3] test3.txt | 大小: 11000 bytes

總耗時: 8ms
結果: [
  { filename: 'test1.txt', size: 11000 },
  { filename: 'test2.txt', size: 11000 },
  { filename: 'test3.txt', size: 11000 }
]
</code></pre>
<hr />
<h2 id="單線程-vs-多線程對比"><a class="header" href="#單線程-vs-多線程對比">單線程 vs 多線程對比</a></h2>
<div class="table-wrapper"><table><thead><tr><th>特性</th><th>單線程異步</th><th>Worker Threads</th></tr></thead><tbody>
<tr><td><strong>模組</strong></td><td><code>Promise.all</code> + <code>async/await</code></td><td><code>worker_threads</code></td></tr>
<tr><td><strong>PID</strong></td><td>全部相同</td><td>全部相同</td></tr>
<tr><td><strong>TID</strong></td><td>無（只有主線程）</td><td>每個 Worker 不同</td></tr>
<tr><td><strong>CPU 利用</strong></td><td>單核心</td><td>多核心</td></tr>
<tr><td><strong>內存</strong></td><td>低（共享內存）</td><td>高（每個線程獨立）</td></tr>
<tr><td><strong>適用場景</strong></td><td>I/O 密集</td><td>CPU 密集</td></tr>
<tr><td><strong>複雜度</strong></td><td>低</td><td>較高</td></tr>
<tr><td><strong>例子</strong></td><td>網絡請求、文件讀寫</td><td>圖像處理、加密運算</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="你的代碼分析"><a class="header" href="#你的代碼分析">你的代碼分析</a></h2>
<h3 id="你的-batch-query-blocksjs-是什麼模式"><a class="header" href="#你的-batch-query-blocksjs-是什麼模式">你的 <code>batch-query-blocks.js</code> 是什麼模式？</a></h3>
<pre><code class="language-javascript">// 單線程異步並發
await Promise.all(workers.map(w =&gt; w.run()));
</code></pre>
<p><strong>判斷依據：</strong></p>
<pre><code class="language-javascript">// 沒有使用多線程模組
const { Worker } = require('worker_threads');  // 不存在
const cluster = require('cluster');             // 不存在

// 使用異步並發
class Worker {
  async run() {
    const resp = await axios.get(...);  // 異步 I/O
  }
}
</code></pre>
<h3 id="並發原理圖"><a class="header" href="#並發原理圖">並發原理圖</a></h3>
<pre><code>+-------------------------------------+
|     主線程 (PID: 12345)              |
|  +--------------------------------+ |
|  |   事件循環 (Event Loop)         | |
|  |                                 | |
|  |  Worker1 -&gt; axios (異步)        | |
|  |  Worker2 -&gt; axios (異步)        | |
|  |  Worker3 -&gt; axios (異步)        | |
|  |  Worker4 -&gt; axios (異步)        | |
|  |     ...                         | |
|  |  Worker8 -&gt; axios (異步)        | |
|  |                                 | |
|  |  (所有在同一個線程執行)         | |
|  +--------------------------------+ |
+-------------------------------------+
</code></pre>
<h3 id="為什麼能並發"><a class="header" href="#為什麼能並發">為什麼能並發？</a></h3>
<pre><code class="language-javascript">// 這是 I/O 密集型任務（網絡請求）
async query(address) {
  const resp = await axios.get(...);  // &lt;- 異步等待
  // CPU 在等待網絡回應時，可以處理其他請求
}

// Promise.all 讓 8 個 Worker "同時"發起請求
await Promise.all(workers.map(w =&gt; w.run()));
// 雖然是單線程，但 I/O 等待期間不阻塞
</code></pre>
<h3 id="結論"><a class="header" href="#結論">結論</a></h3>
<p>你的代碼是 <strong>單線程異步並發</strong>，非常適合 I/O 密集型任務（API 請求）！</p>
<p><strong>優點：</strong></p>
<ul>
<li>設計正確：瓶頸是網絡延遲，不是 CPU</li>
<li>資源效率高：單線程異步已經能充分利用並發</li>
<li>複雜度低：不需要多線程的額外開銷</li>
</ul>
<p><strong>如果改成多線程：</strong></p>
<ul>
<li>沒必要：網絡請求不受益於多核心</li>
<li>增加複雜度：線程間通信、錯誤處理</li>
<li>更高內存：每個線程獨立內存空間</li>
</ul>
<hr />
<h2 id="快速測試"><a class="header" href="#快速測試">快速測試</a></h2>
<pre><code class="language-bash"># 進入範例目錄
cd nodejs-io-concurrent-examples

# 查看可用指令
make

# 執行測試
make build
make test

# 執行所有範例
make run

# 執行單一範例
make run-simple
make run-worker
make run-file

# 清理
make clean
</code></pre>
<hr />
<h2 id="參考資源"><a class="header" href="#參考資源">參考資源</a></h2>
<ul>
<li><a href="https://nodejs.org/api/worker_threads.html">Node.js 官方文檔 - Worker Threads</a></li>
<li><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/">Node.js 官方文檔 - Event Loop</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">Promise.all() - MDN</a></li>
</ul>
<hr />
<p><strong>最後更新：</strong> 2025-11-16</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nodejs/comparison.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../nodejs/web-languages-comparison.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nodejs/comparison.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../nodejs/web-languages-comparison.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
