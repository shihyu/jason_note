<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Coroutine - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="async-def--await-重點整理"><a class="header" href="#async-def--await-重點整理">async def &amp; await 重點整理</a></h2>
<h2 id="sync-def--await-使用情境"><a class="header" href="#sync-def--await-使用情境"><code>sync def</code> &amp; <code>await</code> 使用情境</a></h2>
<p>我直接利用下面這個例子來展示什麼情況下可以使用 <code>async</code> 和 <code>await</code>。</p>
<pre><code class="language-python">import time

def dosomething(i):
    print(f"第 {i} 次開始")
    time.sleep(2)
    print(f"第 {i} 次結束")

if __name__ == "__main__":
    start = time.time()
    for i in range(5):
        dosomething(i+1)
    print(f"time: {time.time() - start} (s)")
</code></pre>
<p>執行後應該會像這樣。</p>
<pre><code>第 1 次開始
第 1 次結束
第 2 次開始
第 2 次結束
第 3 次開始
第 3 次結束
第 4 次開始
第 4 次結束
第 5 次開始
第 5 次結束
time: 10.048049688339233 (s)
</code></pre>
<p>這非常直覺，因為每次呼叫 <code>dosomething()</code> 時都會等待2秒，等完才會執行下一輪，所以最後執行總時間是10秒相當合理。</p>
<p><img src="images/pFXvFe9.png" alt="img" /></p>
<p>但仔細想想，如果那2秒是做網路請求或檔案讀寫(IO)，這2秒是不需要CPU的，但CPU就只能發呆2秒，痴痴地等待回傳結果，其他什麼事都不能做，豈不是太浪費了嗎!? (學過作業系統的人就知道，絕對不能讓CPU發呆XD)</p>
<p>因此 Python 就有了 <code>asyncio</code> 這個工具，來徹底的利用(X) 榨乾(O) CPU的效能。</p>
<p>我把剛才的例子改成 <code>asyncio</code> 的版本。</p>
<p>我把剛才的例子改成 <code>asyncio</code> 的版本。</p>
<pre><code class="language-python">import time
import asyncio

async def dosomething(i):
    print(f"第 {i} 次開始")
    await asyncio.sleep(2)
    print(f"第 {i} 次結束")

if __name__ == "__main__":
    start = time.time()
    tasks = [dosomething(i+1) for i in range(5)]
    asyncio.run(asyncio.wait(tasks))
    print(f"time: {time.time() - start} (s)")
</code></pre>
<p>執行結果會變成這樣，只需要2秒就結束了!</p>
<pre><code>第 2 次開始
第 1 次開始
第 3 次開始
第 4 次開始
第 5 次開始
第 2 次結束
第 3 次結束
第 5 次結束
第 1 次結束
第 4 次結束
time: 2.011152982711792 (s)
</code></pre>
<p>為什麼會這樣呢? 其實 <code>await</code> 就是告訴 CPU 說後面這個函數很慢，不需要等它執行完畢。因此此時 CPU 就可以先跳去執行其他的事情，只需要在這個函數結束時再回來處理就好。這就是為什麼速度會快很多。</p>
<p><img src="images/Xqkma61.png" alt="img" /></p>
<p>瞭解 <code>async def</code> &amp; <code>await</code> 使用情境之後，就來說明一些細節吧!</p>
<h2 id="coroutine"><a class="header" href="#coroutine">coroutine</a></h2>
<p>首先，<code>async def</code> &amp; <code>await</code> 是 Python 3.5+ 之後才出現的 <a href="https://zh.wikipedia.org/zh-tw/%E8%AA%9E%E6%B3%95%E7%B3%96">語法糖</a>，目的是讓 coroutine 之間的調度更加清楚。</p>
<p>那就要先了解什麼是 <strong>coroutine</strong>。</p>
<p>根據 Python 官方對 coroutine 定義：</p>
<blockquote>
<p>Coroutines are a more generalized form of subroutines. Subroutines are entered at one point and exited at another point. Coroutines can be entered, exited, and resumed at many different points. They can be implemented with the async def statement.</p>
</blockquote>
<p>簡單講 coroutine 可以在任意的時間點開始、暫停和離開，並且透過 <code>async def</code> 宣告此函數為一個 coroutine。</p>
<p>所以 <code>await</code> 的作用就是告訴 CPU 說可以暫停後面的工作，先去執行其他程式。另外 <code>await</code> 只能在 coroutine 中宣告，這就是為什麼 <code>await</code> 必須寫在 <code>async def</code> 裡面。</p>
<p>另一個要注意的點，<code>await</code> 後只能接 <code>awaitables</code> 物件，<code>awaitables</code> 物件就包括 coroutine, Task, Future 和有實作 <code>__await__()</code> 的物件。所以並不是所有函數都可以使用 <code>await</code> 加速。</p>
<h2 id="coroutine-使用範例"><a class="header" href="#coroutine-使用範例">coroutine 使用範例</a></h2>
<p>最後來講 coroutine 的使用範例吧!</p>
<pre><code class="language-python">import asyncio

async def main():
    await asyncio.sleep(1)
    print('hello')

main()
</code></pre>
<p>執行後應該會出錯：</p>
<pre><code>RuntimeWarning: coroutine 'main' was never awaited
  main()
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
</code></pre>
<p>這是因為現在 <code>main()</code> 已經宣告成一個 coroutine 了，所以不能夠直接呼叫，而是要改成用 <code>asyncio.run()</code> 呼叫，所以將程式碼改成下面這樣就可以成功印出 hello 了。</p>
<pre><code class="language-python">import asyncio

async def main():
    await asyncio.sleep(1)
    print('hello')

asyncio.run(main())
</code></pre>
<p>好，<code>async def</code> &amp; <code>await</code> 就大致介紹到這邊，關於 <code>asyncio</code> 有滿多東西可以玩的，有需要歡迎看這篇 <a href="https://myapollo.com.tw/zh-tw/begin-to-asyncio/">Python asyncio 從不會到上路</a>。</p>
<h2 id="fastapi-async-def--await"><a class="header" href="#fastapi-async-def--await">FastAPI <code>async def</code> &amp; <code>await</code></a></h2>
<p>最後回來看 <a href="https://fastapi.tiangolo.com/async/">FastAPI 文件</a> 中怎麼說明 <code>async def</code> &amp; <code>await</code> 的。</p>
<p>他說如果你需要在 path operation function 中呼叫一些很慢的函數 (如: 讀取資料庫、網路請求...) 時，就可以使用 <code>async def</code> 和 <code>await</code> 來加速，就像下面的例子。</p>
<pre><code class="language-python=">@app.get('/')
async def read_results():
    results = await do_something()  # do_something() is slow
    return results
</code></pre>
<p>但如果不需要呼叫這些函數，就直接使用一般 <code>def</code> 即可。</p>
<p>現在就能明白為何 FastAPI 要使用 <code>async def</code> 和 <code>await</code> 了吧!</p>
<hr />
<pre><code class="language-python">import asyncio
import multiprocessing as mp

async def crawl_data():
    while True:
        print('Crawling data...')
        await asyncio.sleep(1)

def start_crawler():
    asyncio.run(crawl_data())

if __name__ == '__main__':
    p = mp.Process(target=start_crawler)
    p.start()
    p.join()
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../python/pandas.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../python/finmind.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../python/pandas.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../python/finmind.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
