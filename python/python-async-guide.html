<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Python Async 編程完整指南 - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="python-異步編程完整指南"><a class="header" href="#python-異步編程完整指南">Python 異步編程完整指南</a></h1>
<h2 id="目錄"><a class="header" href="#目錄">目錄</a></h2>
<ul>
<li><a href="#%E6%9E%B6%E6%A7%8B%E5%B1%A4%E6%AC%A1%E9%97%9C%E4%BF%82">架構層次關係</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E7%B5%84%E4%BB%B6%E8%A9%B3%E8%A7%A3">核心組件詳解</a></li>
<li><a href="#%E5%AF%A6%E6%88%B0%E7%AF%84%E4%BE%8B">實戰範例</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E5%84%AA%E5%8C%96%E5%BB%BA%E8%AD%B0">性能優化建議</a></li>
<li><a href="#%E5%B8%B8%E8%A6%8B%E5%95%8F%E9%A1%8C%E8%88%87%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88">常見問題與解決方案</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AF%A6%E8%B8%90%E7%B8%BD%E7%B5%90">最佳實踐總結</a></li>
</ul>
<h2 id="架構層次關係"><a class="header" href="#架構層次關係">架構層次關係</a></h2>
<pre><code>┌─────────────────────────────────────────────────────────┐
│                     應用程式碼                            │
├─────────────────────────────────────────────────────────┤
│ async/await (語法層)                                     │
├─────────────────────────────────────────────────────────┤
│ asyncio (事件循環層)                                     │
├─────────────────────────────────────────────────────────┤
│ aiohttp (HTTP 客戶端層)                                  │
├─────────────────────────────────────────────────────────┤
│ connector (連線管理層)                                   │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 id="組件關係圖"><a class="header" href="#組件關係圖">組件關係圖</a></h3>
<pre><code>async/await (語法) → asyncio (事件循環) → aiohttp (HTTP客戶端) → connector (連線管理)
     ↓                    ↓                    ↓                     ↓
   異步語法            事件循環框架          異步HTTP庫            連線池配置
</code></pre>
<h3 id="各組件職責"><a class="header" href="#各組件職責">各組件職責</a></h3>
<div class="table-wrapper"><table><thead><tr><th>組件</th><th>職責</th><th>必需性</th></tr></thead><tbody>
<tr><td><strong>async/await</strong></td><td>定義異步函數語法</td><td>必需</td></tr>
<tr><td><strong>asyncio</strong></td><td>事件循環管理</td><td>必需</td></tr>
<tr><td><strong>aiohttp</strong></td><td>HTTP 客戶端實現</td><td>可選*</td></tr>
<tr><td><strong>connector</strong></td><td>連線池配置</td><td>可選</td></tr>
</tbody></table>
</div>
<p>*可選意思是你也可以用其他異步 HTTP 庫如 <code>httpx</code></p>
<h2 id="核心組件詳解"><a class="header" href="#核心組件詳解">核心組件詳解</a></h2>
<h3 id="1-asyncawait---異步語法基礎"><a class="header" href="#1-asyncawait---異步語法基礎">1. async/await - 異步語法基礎</a></h3>
<h4 id="基本語法"><a class="header" href="#基本語法">基本語法</a></h4>
<pre><code class="language-python"># 異步函數定義
async def async_function():
    """異步函數定義"""
    result = await some_async_operation()
    return result

# 錯誤示範
def normal_function():
    # SyntaxError: 'await' outside async function
    result = await some_async_operation()  # ❌ 錯誤
</code></pre>
<h4 id="語法要點"><a class="header" href="#語法要點">語法要點</a></h4>
<pre><code class="language-python"># 這只是語法，告訴 Python 這是異步函數
async def my_function():
    await some_async_operation()
</code></pre>
<h3 id="2-asyncio---事件循環引擎"><a class="header" href="#2-asyncio---事件循環引擎">2. asyncio - 事件循環引擎</a></h3>
<h4 id="基本使用"><a class="header" href="#基本使用">基本使用</a></h4>
<pre><code class="language-python">import asyncio

# asyncio 提供事件循環，管理所有異步任務
async def main():
    # 在這裡運行異步任務
    await asyncio.sleep(1)
    return "完成"

# 啟動事件循環
asyncio.run(main())
</code></pre>
<h4 id="三種運行方式"><a class="header" href="#三種運行方式">三種運行方式</a></h4>
<pre><code class="language-python"># 方式 1: asyncio.run() (Python 3.7+) - 推薦
result = asyncio.run(main())

# 方式 2: 手動管理事件循環
loop = asyncio.get_event_loop()
try:
    result = loop.run_until_complete(main())
finally:
    loop.close()

# 方式 3: 在 Jupyter 中
await main()  # Jupyter 已有事件循環
</code></pre>
<h3 id="3-aiohttp---異步-http-客戶端"><a class="header" href="#3-aiohttp---異步-http-客戶端">3. aiohttp - 異步 HTTP 客戶端</a></h3>
<h4 id="基本使用-1"><a class="header" href="#基本使用-1">基本使用</a></h4>
<pre><code class="language-python">import aiohttp

# aiohttp 是基於 asyncio 的 HTTP 庫
async def fetch_data():
    async with aiohttp.ClientSession() as session:
        async with session.get('http://example.com') as response:
            return await response.text()
</code></pre>
<h4 id="多請求並行"><a class="header" href="#多請求並行">多請求並行</a></h4>
<pre><code class="language-python">async def fetch_multiple(urls):
    async with aiohttp.ClientSession() as session:
        tasks = []
        for url in urls:
            task = session.get(url)
            tasks.append(task)
        
        responses = await asyncio.gather(*tasks)
        results = []
        for response in responses:
            results.append(await response.json())
        return results
</code></pre>
<h3 id="4-tcpconnector---連線池管理"><a class="header" href="#4-tcpconnector---連線池管理">4. TCPConnector - 連線池管理</a></h3>
<h4 id="基本配置"><a class="header" href="#基本配置">基本配置</a></h4>
<pre><code class="language-python">import aiohttp

# connector 是 aiohttp 的連線池配置
connector = aiohttp.TCPConnector(
    limit=100,           # 連線池參數
    limit_per_host=20
)

async with aiohttp.ClientSession(connector=connector) as session:
    # session 使用這個 connector 的設定
    pass
</code></pre>
<h4 id="詳細配置選項"><a class="header" href="#詳細配置選項">詳細配置選項</a></h4>
<pre><code class="language-python">connector = aiohttp.TCPConnector(
    # 連線池大小
    limit=100,                    # 總連線數限制
    limit_per_host=30,           # 每個 host 連線數
    
    # 連線保持
    keepalive_timeout=60,        # Keep-alive 超時
    force_close=False,           # 是否強制關閉連線
    
    # DNS 相關
    ttl_dns_cache=300,          # DNS 快取時間
    
    # SSL/TLS
    ssl=True,                   # 啟用 SSL
    verify_ssl=True,            # 驗證 SSL 證書
    
    # 性能優化
    enable_cleanup_closed=True,  # 清理關閉的連線
)
</code></pre>
<h2 id="完整組合使用範例"><a class="header" href="#完整組合使用範例">完整組合使用範例</a></h2>
<pre><code class="language-python">import asyncio
import aiohttp

async def fetch_multiple_urls(urls):
    # 1. connector: 配置連線池
    connector = aiohttp.TCPConnector(
        limit=200,
        limit_per_host=50,
        keepalive_timeout=60
    )
    
    # 2. aiohttp: 提供異步 HTTP 功能
    async with aiohttp.ClientSession(connector=connector) as session:
        
        # 3. async/await: 異步語法
        async def fetch_one(url):
            async with session.get(url) as response:
                return await response.text()
        
        # 4. asyncio.gather: 並行執行多個任務
        tasks = [fetch_one(url) for url in urls]
        results = await asyncio.gather(*tasks)
        
    return results

# 5. asyncio.run: 啟動事件循環
if __name__ == "__main__":
    urls = ["http://example.com"] * 100
    results = asyncio.run(fetch_multiple_urls(urls))
</code></pre>
<h2 id="對比不同組合"><a class="header" href="#對比不同組合">對比不同組合</a></h2>
<pre><code class="language-python"># 組合1: 只有 async，沒有 aiohttp
async def basic_async():
    await asyncio.sleep(1)  # 只能做基本異步操作

# 組合2: aiohttp 但沒有自定義 connector  
async def default_aiohttp():
    async with aiohttp.ClientSession() as session:  # 使用默認 connector
        return await session.get(url)

# 組合3: 完整組合
async def optimized_aiohttp():
    connector = aiohttp.TCPConnector(limit_per_host=50)  # 自定義 connector
    async with aiohttp.ClientSession(connector=connector) as session:
        return await session.get(url)
</code></pre>
<h2 id="為什麼需要-connector"><a class="header" href="#為什麼需要-connector">為什麼需要 Connector？</a></h2>
<pre><code class="language-python"># 沒有 connector 配置
async with aiohttp.ClientSession() as session:
    # 默認：每個 host 只有 30 條連線
    tasks = [session.get(url) for url in urls_1000]  # 可能很慢

# 有 connector 優化
connector = aiohttp.TCPConnector(limit_per_host=100)
async with aiohttp.ClientSession(connector=connector) as session:
    # 現在：每個 host 可以 100 條並行連線
    tasks = [session.get(url) for url in urls_1000]  # 快很多！
</code></pre>
<h2 id="實戰範例"><a class="header" href="#實戰範例">實戰範例</a></h2>
<h3 id="範例-1-基礎爬蟲"><a class="header" href="#範例-1-基礎爬蟲">範例 1: 基礎爬蟲</a></h3>
<pre><code class="language-python">import asyncio
import aiohttp
import time

async def fetch_url(session, url):
    """抓取單個 URL"""
    try:
        async with session.get(url, timeout=10) as response:
            return {
                'url': url,
                'status': response.status,
                'content': await response.text()
            }
    except Exception as e:
        return {
            'url': url,
            'error': str(e)
        }

async def crawl_websites(urls):
    """並行爬取多個網站"""
    # 配置連線池
    connector = aiohttp.TCPConnector(
        limit=50,
        limit_per_host=10
    )
    
    async with aiohttp.ClientSession(connector=connector) as session:
        tasks = [fetch_url(session, url) for url in urls]
        results = await asyncio.gather(*tasks)
        
    return results

# 使用範例
if __name__ == "__main__":
    urls = [
        'https://httpbin.org/delay/1',
        'https://httpbin.org/delay/2',
        'https://httpbin.org/delay/3',
    ]
    
    start = time.time()
    results = asyncio.run(crawl_websites(urls))
    print(f"完成時間: {time.time() - start:.2f} 秒")
</code></pre>
<h3 id="範例-2-api-客戶端封裝"><a class="header" href="#範例-2-api-客戶端封裝">範例 2: API 客戶端封裝</a></h3>
<pre><code class="language-python">class AsyncAPIClient:
    """異步 API 客戶端"""
    
    def __init__(self, base_url, max_connections=100):
        self.base_url = base_url
        self.connector = aiohttp.TCPConnector(
            limit=max_connections,
            limit_per_host=30,
            keepalive_timeout=60
        )
        self.session = None
    
    async def __aenter__(self):
        """進入上下文管理器"""
        self.session = aiohttp.ClientSession(
            connector=self.connector,
            headers={'User-Agent': 'AsyncClient/1.0'}
        )
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """離開上下文管理器"""
        await self.session.close()
    
    async def get(self, endpoint, **kwargs):
        """GET 請求"""
        url = f"{self.base_url}{endpoint}"
        async with self.session.get(url, **kwargs) as response:
            return await response.json()
    
    async def post(self, endpoint, data=None, **kwargs):
        """POST 請求"""
        url = f"{self.base_url}{endpoint}"
        async with self.session.post(url, json=data, **kwargs) as response:
            return await response.json()

# 使用範例
async def main():
    async with AsyncAPIClient('https://api.github.com') as client:
        # 並行請求
        user, repos = await asyncio.gather(
            client.get('/users/python'),
            client.get('/users/python/repos')
        )
        print(f"User: {user['name']}")
        print(f"Repos: {len(repos)}")

asyncio.run(main())
</code></pre>
<h3 id="範例-3-速率限制與重試"><a class="header" href="#範例-3-速率限制與重試">範例 3: 速率限制與重試</a></h3>
<pre><code class="language-python">import asyncio
import aiohttp
from asyncio import Semaphore
from typing import List, Dict, Any

class RateLimitedClient:
    """帶速率限制的客戶端"""
    
    def __init__(self, rate_limit: int = 10, retry_count: int = 3):
        self.semaphore = Semaphore(rate_limit)
        self.retry_count = retry_count
        self.connector = aiohttp.TCPConnector(limit=rate_limit * 2)
    
    async def fetch_with_retry(self, session, url):
        """帶重試機制的請求"""
        for attempt in range(self.retry_count):
            try:
                async with self.semaphore:  # 速率限制
                    async with session.get(url) as response:
                        if response.status == 200:
                            return await response.json()
                        elif response.status == 429:  # Too Many Requests
                            wait_time = int(response.headers.get('Retry-After', 2 ** attempt))
                            await asyncio.sleep(wait_time)
                        else:
                            response.raise_for_status()
            except aiohttp.ClientError as e:
                if attempt == self.retry_count - 1:
                    raise
                await asyncio.sleep(2 ** attempt)  # 指數退避
    
    async def fetch_all(self, urls: List[str]) -&gt; List[Dict[Any, Any]]:
        """批量請求"""
        async with aiohttp.ClientSession(connector=self.connector) as session:
            tasks = [self.fetch_with_retry(session, url) for url in urls]
            return await asyncio.gather(*tasks, return_exceptions=True)

# 使用範例
async def main():
    client = RateLimitedClient(rate_limit=5)
    urls = [f'https://httpbin.org/delay/{i}' for i in range(10)]
    results = await client.fetch_all(urls)
    print(f"成功請求: {sum(1 for r in results if not isinstance(r, Exception))}")

asyncio.run(main())
</code></pre>
<h2 id="性能優化建議"><a class="header" href="#性能優化建議">性能優化建議</a></h2>
<h3 id="1-連線池優化"><a class="header" href="#1-連線池優化">1. 連線池優化</a></h3>
<pre><code class="language-python"># 針對不同場景的優化配置

# 高並發場景
high_concurrency_connector = aiohttp.TCPConnector(
    limit=1000,
    limit_per_host=100,
    ttl_dns_cache=300,
    enable_cleanup_closed=True
)

# 長連線場景
persistent_connector = aiohttp.TCPConnector(
    limit=50,
    keepalive_timeout=300,
    force_close=False
)

# 受限 API 場景
rate_limited_connector = aiohttp.TCPConnector(
    limit=10,
    limit_per_host=2,
    keepalive_timeout=30
)
</code></pre>
<h3 id="2-記憶體優化"><a class="header" href="#2-記憶體優化">2. 記憶體優化</a></h3>
<pre><code class="language-python">async def stream_large_file(url):
    """串流處理大文件"""
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            # 不要使用 await response.read()
            async for chunk in response.content.iter_chunked(1024):
                process_chunk(chunk)  # 逐塊處理
</code></pre>
<h3 id="3-超時設置"><a class="header" href="#3-超時設置">3. 超時設置</a></h3>
<pre><code class="language-python"># 全局超時
timeout = aiohttp.ClientTimeout(
    total=300,      # 總超時
    connect=10,     # 連線超時
    sock_read=60    # 讀取超時
)

async with aiohttp.ClientSession(timeout=timeout) as session:
    # 所有請求都使用這個超時設置
    pass
</code></pre>
<h2 id="常見問題與解決方案"><a class="header" href="#常見問題與解決方案">常見問題與解決方案</a></h2>
<h3 id="問題-1-event-loop-is-closed"><a class="header" href="#問題-1-event-loop-is-closed">問題 1: "Event loop is closed"</a></h3>
<pre><code class="language-python"># 問題代碼
loop = asyncio.get_event_loop()
loop.run_until_complete(main())
loop.close()
loop.run_until_complete(another_task())  # ❌ 錯誤

# 解決方案
asyncio.run(main())         # 自動管理循環
asyncio.run(another_task())  # 每次創建新循環
</code></pre>
<h3 id="問題-2-session-is-closed"><a class="header" href="#問題-2-session-is-closed">問題 2: "Session is closed"</a></h3>
<pre><code class="language-python"># 問題代碼
session = aiohttp.ClientSession()
await session.get(url)
await session.close()
await session.get(another_url)  # ❌ 錯誤

# 解決方案
async with aiohttp.ClientSession() as session:
    await session.get(url)
    await session.get(another_url)  # ✅ 正確
</code></pre>
<h3 id="問題-3-並發數過高導致錯誤"><a class="header" href="#問題-3-並發數過高導致錯誤">問題 3: 並發數過高導致錯誤</a></h3>
<pre><code class="language-python"># 使用 Semaphore 限制並發
async def limited_fetch(semaphore, session, url):
    async with semaphore:
        return await session.get(url)

async def main():
    semaphore = asyncio.Semaphore(10)  # 最多 10 個並發
    async with aiohttp.ClientSession() as session:
        tasks = [limited_fetch(semaphore, session, url) for url in urls]
        await asyncio.gather(*tasks)
</code></pre>
<h2 id="最佳實踐總結"><a class="header" href="#最佳實踐總結">最佳實踐總結</a></h2>
<ol>
<li><strong>永遠使用上下文管理器</strong> 管理 Session 和 Connector</li>
<li><strong>設置合理的超時時間</strong> 避免無限等待</li>
<li><strong>使用 Semaphore</strong> 控制並發數量</li>
<li><strong>實現重試機制</strong> 處理暫時性錯誤</li>
<li><strong>監控連線池狀態</strong> 進行性能調優</li>
<li><strong>處理異常</strong> 確保程式穩定性</li>
<li><strong>使用串流處理</strong> 處理大文件</li>
<li><strong>合理配置 DNS 快取</strong> 減少 DNS 查詢</li>
</ol>
<h2 id="關鍵概念總結"><a class="header" href="#關鍵概念總結">關鍵概念總結</a></h2>
<p><strong>記住：它們是一個完整異步 HTTP 解決方案的不同層次，而不是競爭關係！</strong></p>
<ul>
<li><strong>async/await</strong>: 提供異步語法支持</li>
<li><strong>asyncio</strong>: 管理事件循環和任務調度</li>
<li><strong>aiohttp</strong>: 實現異步 HTTP 客戶端功能</li>
<li><strong>connector</strong>: 優化連線池和網路性能</li>
</ul>
<h2 id="相關資源"><a class="header" href="#相關資源">相關資源</a></h2>
<ul>
<li><a href="https://docs.python.org/3/library/asyncio.html">asyncio 官方文檔</a></li>
<li><a href="https://docs.aiohttp.org/">aiohttp 官方文檔</a></li>
<li><a href="https://realpython.com/async-io-python/">Python 異步編程指南</a></li>
<li><a href="https://docs.aiohttp.org/en/stable/client_advanced.html">aiohttp 性能優化</a></li>
<li><a href="https://www.python.org/dev/peps/pep-0492/">Python Async/Await 教程</a></li>
</ul>
<hr />
<p><em>最後更新：2025</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../python/complete-async-benchmark.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../python/python-concurrency-guide.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../python/complete-async-benchmark.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../python/python-concurrency-guide.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
