<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>å¤šåŸ·è¡Œç·’é–æ©Ÿåˆ¶å®Œå…¨æŒ‡å— - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-å¤šåŸ·è¡Œç·’é–æ©Ÿåˆ¶å®Œå…¨æŒ‡å—"><a class="header" href="#-å¤šåŸ·è¡Œç·’é–æ©Ÿåˆ¶å®Œå…¨æŒ‡å—">ğŸ” å¤šåŸ·è¡Œç·’é–æ©Ÿåˆ¶å®Œå…¨æŒ‡å—</a></h1>
<blockquote>
<p>ç”¨ç™½è©±å’Œç¤ºæ„åœ–ç†è§£æ‰€æœ‰å¸¸è¦‹çš„é–æ©Ÿåˆ¶</p>
</blockquote>
<hr />
<h2 id="-ç›®éŒ„"><a class="header" href="#-ç›®éŒ„">ğŸ“š ç›®éŒ„</a></h2>
<ol>
<li><a href="#1-%E7%84%A1%E9%8E%96%E6%A9%9F%E5%88%B6-lock-free">ç„¡é–æ©Ÿåˆ¶ (Lock-Free)</a></li>
<li><a href="#2-%E4%BA%92%E6%96%A5%E9%8E%96-mutex">äº’æ–¥é– (Mutex)</a></li>
<li><a href="#3-%E8%87%AA%E6%97%8B%E9%8E%96-spinlock">è‡ªæ—‹é– (Spinlock)</a></li>
<li><a href="#4-%E8%AE%80%E5%AF%AB%E9%8E%96-read-write-lock">è®€å¯«é– (Read-Write Lock)</a></li>
<li><a href="#5-%E9%81%9E%E8%BF%B4%E9%8E%96-recursive-lock">éè¿´é– (Recursive Lock)</a></li>
<li><a href="#6-%E6%A2%9D%E4%BB%B6%E8%AE%8A%E6%95%B8-condition-variable">æ¢ä»¶è®Šæ•¸ (Condition Variable)</a></li>
<li><a href="#7-%E4%BF%A1%E8%99%9F%E9%87%8F-semaphore">ä¿¡è™Ÿé‡ (Semaphore)</a></li>
<li><a href="#8-%E6%9F%B5%E6%AC%84-barrier">æŸµæ¬„ (Barrier)</a></li>
<li><a href="#9-%E9%A0%86%E5%BA%8F%E9%8E%96-seqlock">é †åºé– (Seqlock)</a></li>
<li><a href="#10-%E6%95%88%E8%83%BD%E6%AF%94%E8%BC%83%E7%B8%BD%E8%A1%A8">æ•ˆèƒ½æ¯”è¼ƒç¸½è¡¨</a></li>
</ol>
<hr />
<h2 id="1-ç„¡é–æ©Ÿåˆ¶-lock-free"><a class="header" href="#1-ç„¡é–æ©Ÿåˆ¶-lock-free">1. ç„¡é–æ©Ÿåˆ¶ (Lock-Free)</a></h2>
<h3 id="-æ ¸å¿ƒæ¦‚å¿µ"><a class="header" href="#-æ ¸å¿ƒæ¦‚å¿µ">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</a></h3>
<p>æƒ³åƒä¸€å€‹ã€Œæ—‹è½‰å£½å¸å°ã€ï¼š</p>
<ul>
<li><strong>ç”Ÿç”¢è€…</strong> = å»šå¸«æ”¾å£½å¸</li>
<li><strong>æ¶ˆè²»è€…</strong> = å®¢äººæ‹¿å£½å¸</li>
<li><strong>ä¸éœ€è¦æœå‹™ç”Ÿå”èª¿</strong>ï¼ˆä¸éœ€è¦é–ï¼‰</li>
</ul>
<h3 id="-ç¤ºæ„åœ–"><a class="header" href="#-ç¤ºæ„åœ–">ğŸ“Š ç¤ºæ„åœ–</a></h3>
<pre><code>ç’°ç‹€ç·©è¡å€ï¼ˆSPSC Queueï¼‰
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ A â”‚ B â”‚ C â”‚   â”‚   â”‚   â”‚   â”‚   â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
  â†‘       â†‘
  è®€      å¯«

ç”Ÿç”¢è€…ï¼ˆå»šå¸«ï¼‰         æ¶ˆè²»è€…ï¼ˆå®¢äººï¼‰
åªæ”¹å¯«å…¥ä½ç½®   â†â†’     åªæ”¹è®€å–ä½ç½®
äº’ä¸å¹²æ“¾ï¼
</code></pre>
<h3 id="-ç¨‹å¼ç¢¼ç¯„ä¾‹"><a class="header" href="#-ç¨‹å¼ç¢¼ç¯„ä¾‹">ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹</a></h3>
<pre><code class="language-cpp">template&lt;typename T&gt;
class LockFreeQueue {
    std::vector&lt;T&gt; buffer_;
    std::atomic&lt;size_t&gt; next_write_index_{0};  // åŸå­è®Šæ•¸
    std::atomic&lt;size_t&gt; next_read_index_{0};
    
public:
    void push(T data) {
        size_t write_pos = next_write_index_.load(std::memory_order_relaxed);
        buffer_[write_pos] = data;
        next_write_index_.store(write_pos + 1, std::memory_order_release);
    }
    
    bool pop(T&amp; data) {
        size_t read_pos = next_read_index_.load(std::memory_order_relaxed);
        size_t write_pos = next_write_index_.load(std::memory_order_acquire);
        
        if (read_pos == write_pos) return false;  // ä½‡åˆ—ç©º
        
        data = buffer_[read_pos];
        next_read_index_.store(read_pos + 1, std::memory_order_release);
        return true;
    }
};
</code></pre>
<h3 id="-å„ªé»"><a class="header" href="#-å„ªé»">âœ… å„ªé»</a></h3>
<ul>
<li><strong>è¶…å¿«é€Ÿ</strong>ï¼šæ²’æœ‰ Context Switch</li>
<li><strong>ç„¡æ­»é–</strong>ï¼šæ²’æœ‰é–å°±ä¸æœƒå¡ä½</li>
<li><strong>ä½å»¶é²</strong>ï¼šé©åˆå³æ™‚ç³»çµ±</li>
</ul>
<h3 id="-ç¼ºé»"><a class="header" href="#-ç¼ºé»">âŒ ç¼ºé»</a></h3>
<ul>
<li><strong>é™åˆ¶å¤š</strong>ï¼šé€šå¸¸åªæ”¯æ´ SPSCï¼ˆå–®ç”Ÿç”¢è€…å–®æ¶ˆè²»è€…ï¼‰</li>
<li><strong>è¤‡é›œåº¦é«˜</strong>ï¼šéœ€è¦ç†è§£è¨˜æ†¶é«”é †åºï¼ˆMemory Orderï¼‰</li>
<li><strong>é™¤éŒ¯å›°é›£</strong>ï¼šéŒ¯èª¤ä¸æ˜“é‡ç¾</li>
</ul>
<h3 id="-ä½¿ç”¨å ´æ™¯"><a class="header" href="#-ä½¿ç”¨å ´æ™¯">ğŸ¯ ä½¿ç”¨å ´æ™¯</a></h3>
<ul>
<li>éŸ³è¨Šè™•ç†ç®¡ç·š</li>
<li>é«˜é »äº¤æ˜“ç³»çµ±</li>
<li>ç¶²è·¯å°åŒ…è™•ç†</li>
</ul>
<hr />
<h2 id="2-äº’æ–¥é–-mutex"><a class="header" href="#2-äº’æ–¥é–-mutex">2. äº’æ–¥é– (Mutex)</a></h2>
<h3 id="-æ ¸å¿ƒæ¦‚å¿µ-1"><a class="header" href="#-æ ¸å¿ƒæ¦‚å¿µ-1">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</a></h3>
<p>æƒ³åƒä¸€å€‹ã€Œå…¬å…±å»æ‰€ã€ï¼š</p>
<ul>
<li><strong>åªæœ‰ä¸€æŠŠé‘°åŒ™</strong>ï¼ˆé–ï¼‰</li>
<li><strong>èª°æ‹¿åˆ°é‘°åŒ™èª°é€²å»</strong></li>
<li><strong>å…¶ä»–äººåœ¨å¤–é¢æ’éšŠç­‰</strong></li>
</ul>
<h3 id="-ç¤ºæ„åœ–-1"><a class="header" href="#-ç¤ºæ„åœ–-1">ğŸ“Š ç¤ºæ„åœ–</a></h3>
<pre><code>æ™‚é–“è»¸ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â†’

åŸ·è¡Œç·’ A:  [å–å¾—é–]â”€â”€â”€åŸ·è¡Œä¸­â”€â”€â”€[é‡‹æ”¾é–]
åŸ·è¡Œç·’ B:            [ç­‰å¾…......]  [å–å¾—é–]â”€â”€â”€åŸ·è¡Œä¸­â”€â”€â”€
åŸ·è¡Œç·’ C:                          [ç­‰å¾…..................]

ç‹€æ…‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…±äº«è³‡æº    â”‚
â”‚ (counter)   â”‚  â† åªæœ‰æ‹¿åˆ°é–çš„åŸ·è¡Œç·’èƒ½å­˜å–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘
      ğŸ”’ Mutex
</code></pre>
<h3 id="-ç¨‹å¼ç¢¼ç¯„ä¾‹-1"><a class="header" href="#-ç¨‹å¼ç¢¼ç¯„ä¾‹-1">ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹</a></h3>
<pre><code class="language-cpp">#include &lt;mutex&gt;

class BankAccount {
    int balance_ = 0;
    std::mutex mutex_;  // ä¿è­· balance_
    
public:
    void deposit(int amount) {
        std::lock_guard&lt;std::mutex&gt; lock(mutex_);  // è‡ªå‹•åŠ é–
        balance_ += amount;
        // é›¢é–‹ä½œç”¨åŸŸè‡ªå‹•è§£é–
    }
    
    void withdraw(int amount) {
        std::lock_guard&lt;std::mutex&gt; lock(mutex_);
        if (balance_ &gt;= amount) {
            balance_ -= amount;
        }
    }
    
    int get_balance() {
        std::lock_guard&lt;std::mutex&gt; lock(mutex_);
        return balance_;
    }
};
</code></pre>
<h3 id="-é‹ä½œæµç¨‹"><a class="header" href="#-é‹ä½œæµç¨‹">ğŸ”„ é‹ä½œæµç¨‹</a></h3>
<pre><code>åŸ·è¡Œç·’ A æƒ³è¦ä¿®æ”¹ balance_ï¼š

1. åŸ·è¡Œåˆ° lock_guard
   â†“
2. å˜—è©¦å–å¾— mutex_
   â”œâ”€ æˆåŠŸ â†’ ç¹¼çºŒåŸ·è¡Œ
   â””â”€ å¤±æ•— â†’ é€²å…¥ç¡çœ ï¼Œç­‰ä½œæ¥­ç³»çµ±å–šé†’
   
3. åŸ·è¡Œ balance_ += amount
   
4. é›¢é–‹ {} ä½œç”¨åŸŸ
   â†“
5. è‡ªå‹•é‡‹æ”¾ mutex_
   â†“
6. ä½œæ¥­ç³»çµ±å–šé†’ç­‰å¾…ä¸­çš„åŸ·è¡Œç·’
</code></pre>
<h3 id="-å„ªé»-1"><a class="header" href="#-å„ªé»-1">âœ… å„ªé»</a></h3>
<ul>
<li><strong>ç°¡å–®æ˜“ç”¨</strong>ï¼šæœ€åŸºæœ¬çš„åŒæ­¥æ©Ÿåˆ¶</li>
<li><strong>ä¿è­‰äº’æ–¥</strong>ï¼šçµ•å°ä¸æœƒæœ‰å…©å€‹åŸ·è¡Œç·’åŒæ™‚åŸ·è¡Œ</li>
<li><strong>è‡ªå‹•ç®¡ç†</strong>ï¼šæ­é… RAIIï¼ˆlock_guardï¼‰ä¸æœƒå¿˜è¨˜è§£é–</li>
</ul>
<h3 id="-ç¼ºé»-1"><a class="header" href="#-ç¼ºé»-1">âŒ ç¼ºé»</a></h3>
<ul>
<li><strong>Context Switch é–‹éŠ·</strong>ï¼šç­‰å¾…æ™‚æœƒç¡çœ </li>
<li><strong>å¯èƒ½æ­»é–</strong>ï¼šäº’ç›¸ç­‰å¾…å°æ–¹çš„é–</li>
<li><strong>ä¸å…¬å¹³</strong>ï¼šç„¡æ³•ä¿è­‰å…ˆç­‰å¾…çš„å…ˆå–å¾—</li>
</ul>
<h3 id="-ä½¿ç”¨å ´æ™¯-1"><a class="header" href="#-ä½¿ç”¨å ´æ™¯-1">ğŸ¯ ä½¿ç”¨å ´æ™¯</a></h3>
<ul>
<li>éŠ€è¡Œè½‰å¸³ç³»çµ±</li>
<li>è³‡æ–™åº«é€£ç·šæ± </li>
<li>ä»»ä½•éœ€è¦ä¿è­·å…±äº«è³‡æºçš„æƒ…å¢ƒ</li>
</ul>
<hr />
<h2 id="3-è‡ªæ—‹é–-spinlock"><a class="header" href="#3-è‡ªæ—‹é–-spinlock">3. è‡ªæ—‹é– (Spinlock)</a></h2>
<h3 id="-æ ¸å¿ƒæ¦‚å¿µ-2"><a class="header" href="#-æ ¸å¿ƒæ¦‚å¿µ-2">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</a></h3>
<p>æƒ³åƒã€Œæ’éšŠè²·æ¼”å”±æœƒç¥¨ã€ï¼š</p>
<ul>
<li><strong>ä¸é›¢é–‹éšŠä¼</strong>ï¼ˆä¸ç¡çœ ï¼‰</li>
<li><strong>ä¸€ç›´ç›¯è‘—å”®ç¥¨å£</strong>ï¼ˆä¸€ç›´æª¢æŸ¥ï¼‰</li>
<li><strong>ç¥¨ä¸€é–‹è³£é¦¬ä¸Šè¡</strong>ï¼ˆç«‹å³å–å¾—ï¼‰</li>
</ul>
<h3 id="-ç¤ºæ„åœ–-2"><a class="header" href="#-ç¤ºæ„åœ–-2">ğŸ“Š ç¤ºæ„åœ–</a></h3>
<pre><code>Mutexï¼ˆç¡çœ ç­‰å¾…ï¼‰ï¼š
åŸ·è¡Œç·’ B: [å˜—è©¦é–]â†’ ğŸ˜´ ç¡è¦º... â†’ è¢«å–šé†’ â†’ [å–å¾—é–]
                    ï¼ˆContext Switchï¼‰

Spinlockï¼ˆå¿™ç¢Œç­‰å¾…ï¼‰ï¼š
åŸ·è¡Œç·’ B: [å˜—è©¦é–]â†’ ğŸ”„ğŸ”„ğŸ”„ ä¸€ç›´æª¢æŸ¥... â†’ [å–å¾—é–]
                    ï¼ˆæ¶ˆè€— CPU ä½†ç„¡ Context Switchï¼‰

CPU ä½¿ç”¨ç‡ï¼š
Mutex:     â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–“â–“â–“â–“ (ç¡çœ æ™‚ä¸ä½”ç”¨)
Spinlock:  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ (ä¸€ç›´ä½”ç”¨ CPU)
</code></pre>
<h3 id="-ç¨‹å¼ç¢¼ç¯„ä¾‹-2"><a class="header" href="#-ç¨‹å¼ç¢¼ç¯„ä¾‹-2">ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹</a></h3>
<pre><code class="language-cpp">#include &lt;atomic&gt;

class Spinlock {
    std::atomic_flag flag_ = ATOMIC_FLAG_INIT;
    
public:
    void lock() {
        // ä¸€ç›´å˜—è©¦ç›´åˆ°æˆåŠŸ
        while (flag_.test_and_set(std::memory_order_acquire)) {
            // ç©ºè½‰ç­‰å¾…ï¼ˆå¯åŠ å…¥ CPU pause æŒ‡ä»¤å„ªåŒ–ï¼‰
            #ifdef __x86_64__
                __builtin_ia32_pause();  // x86 çš„ PAUSE æŒ‡ä»¤
            #endif
        }
    }
    
    void unlock() {
        flag_.clear(std::memory_order_release);
    }
};

// ä½¿ç”¨ç¯„ä¾‹
class Counter {
    int value_ = 0;
    Spinlock lock_;
    
public:
    void increment() {
        lock_.lock();
        ++value_;
        lock_.unlock();
    }
};
</code></pre>
<h3 id="-é‹ä½œå°æ¯”"><a class="header" href="#-é‹ä½œå°æ¯”">ğŸ”„ é‹ä½œå°æ¯”</a></h3>
<pre><code>é—œéµæ™‚åˆ»åœ–ï¼š

Mutexï¼ˆç­‰å¾… 100 å¾®ç§’ï¼‰ï¼š
[åŸ·è¡Œ] â†’ [ç¡çœ  100Î¼s] â†’ [å–šé†’] â†’ [åŸ·è¡Œ]
         â†‘              â†‘
    Context Switch   Context Switch
    (~1-10 å¾®ç§’)     (~1-10 å¾®ç§’)

ç¸½æˆæœ¬ï¼š100 + 1 + 1 = 102 å¾®ç§’

Spinlockï¼ˆç­‰å¾… 5 å¾®ç§’ï¼‰ï¼š
[åŸ·è¡Œ] â†’ [ç©ºè½‰ 5Î¼s] â†’ [åŸ·è¡Œ]
         â†‘
    æ²’æœ‰ Context Switchï¼

ç¸½æˆæœ¬ï¼š5 å¾®ç§’ï¼ˆä½† CPU ä¸€ç›´å¿™ç¢Œï¼‰
</code></pre>
<h3 id="-å„ªé»-2"><a class="header" href="#-å„ªé»-2">âœ… å„ªé»</a></h3>
<ul>
<li><strong>ä½å»¶é²</strong>ï¼šç„¡ Context Switch</li>
<li><strong>é©åˆçŸ­è‡¨ç•Œå€</strong>ï¼šé–å®šæ™‚é–“ &lt; 1 å¾®ç§’æ™‚å¾ˆå¿«</li>
<li><strong>ç°¡å–®å¯¦ä½œ</strong>ï¼šåªéœ€è¦åŸå­æ“ä½œ</li>
</ul>
<h3 id="-ç¼ºé»-2"><a class="header" href="#-ç¼ºé»-2">âŒ ç¼ºé»</a></h3>
<ul>
<li><strong>æµªè²» CPU</strong>ï¼šç­‰å¾…æ™‚ä¸€ç›´æ¶ˆè€— CPU</li>
<li><strong>å¯èƒ½æ´»é–</strong>ï¼šå„ªå…ˆæ¬Šåè½‰å•é¡Œ</li>
<li><strong>ä¸é©åˆé•·æ™‚é–“é–å®š</strong>ï¼šæœƒè®“å…¶ä»–åŸ·è¡Œç·’é¤“æ­»</li>
</ul>
<h3 id="-ä½¿ç”¨å ´æ™¯-2"><a class="header" href="#-ä½¿ç”¨å ´æ™¯-2">ğŸ¯ ä½¿ç”¨å ´æ™¯</a></h3>
<ul>
<li>ä½œæ¥­ç³»çµ±æ ¸å¿ƒï¼ˆKernelï¼‰</li>
<li>ä¸­æ–·è™•ç†ç¨‹åº</li>
<li>éå¸¸çŸ­çš„è‡¨ç•Œå€ï¼ˆ&lt; 100 å¥ˆç§’ï¼‰</li>
</ul>
<hr />
<h2 id="4-è®€å¯«é–-read-write-lock"><a class="header" href="#4-è®€å¯«é–-read-write-lock">4. è®€å¯«é– (Read-Write Lock)</a></h2>
<h3 id="-æ ¸å¿ƒæ¦‚å¿µ-3"><a class="header" href="#-æ ¸å¿ƒæ¦‚å¿µ-3">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</a></h3>
<p>æƒ³åƒä¸€å€‹ã€Œåœ–æ›¸é¤¨ã€ï¼š</p>
<ul>
<li><strong>è®€è€…</strong>ï¼šå¾ˆå¤šäººå¯ä»¥åŒæ™‚çœ‹æ›¸ï¼ˆå…±äº«ï¼‰</li>
<li><strong>ä½œè€…</strong>ï¼šåªèƒ½ä¸€å€‹äººå¯«æ›¸ï¼Œå¯«çš„æ™‚å€™ä¸èƒ½è®€ï¼ˆç¨ä½”ï¼‰</li>
</ul>
<h3 id="-ç¤ºæ„åœ–-3"><a class="header" href="#-ç¤ºæ„åœ–-3">ğŸ“Š ç¤ºæ„åœ–</a></h3>
<pre><code>æ™‚é–“è»¸ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â†’

è®€è€… A:  [è®€å–â”€â”€â”€â”€â”€â”€â”€â”€]
è®€è€… B:    [è®€å–â”€â”€â”€â”€â”€â”€]     â† å¯ä»¥åŒæ™‚è®€
è®€è€… C:      [è®€å–â”€â”€â”€â”€]

å¯«è€… X:               [ç­‰å¾…] [å¯«å…¥] â† ç­‰æ‰€æœ‰è®€è€…çµæŸ
è®€è€… D:                      [ç­‰å¾…] [è®€å–] â† ç­‰å¯«è€…çµæŸ

ç‹€æ…‹è¡¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è®€æ¨¡å¼    â”‚   è®€æ¨¡å¼    â”‚   å¯«æ¨¡å¼    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤šäººå¯è®€    â”‚ â† åˆ‡æ› â†’    â”‚ åªæœ‰ä¸€äºº    â”‚
â”‚ ç„¡äººå¯å¯«    â”‚             â”‚ ç„¡äººå¯è®€å¯«  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="-ç¨‹å¼ç¢¼ç¯„ä¾‹-3"><a class="header" href="#-ç¨‹å¼ç¢¼ç¯„ä¾‹-3">ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹</a></h3>
<pre><code class="language-cpp">#include &lt;shared_mutex&gt;

class ThreadSafeCache {
    std::map&lt;std::string, std::string&gt; cache_;
    mutable std::shared_mutex mutex_;  // C++17
    
public:
    // è®€å–ï¼ˆå…±äº«é–ï¼‰
    std::string get(const std::string&amp; key) const {
        std::shared_lock&lt;std::shared_mutex&gt; lock(mutex_);  // å…±äº«é–
        auto it = cache_.find(key);
        return it != cache_.end() ? it-&gt;second : "";
    }
    
    // å¯«å…¥ï¼ˆç¨ä½”é–ï¼‰
    void set(const std::string&amp; key, const std::string&amp; value) {
        std::unique_lock&lt;std::shared_mutex&gt; lock(mutex_);  // ç¨ä½”é–
        cache_[key] = value;
    }
    
    // æª¢æŸ¥å­˜åœ¨ï¼ˆå…±äº«é–ï¼‰
    bool contains(const std::string&amp; key) const {
        std::shared_lock&lt;std::shared_mutex&gt; lock(mutex_);
        return cache_.find(key) != cache_.end();
    }
};
</code></pre>
<h3 id="-åŸ·è¡Œæµç¨‹"><a class="header" href="#-åŸ·è¡Œæµç¨‹">ğŸ”„ åŸ·è¡Œæµç¨‹</a></h3>
<pre><code>å ´æ™¯ï¼š5 å€‹è®€è€…ï¼Œ1 å€‹å¯«è€…

æ­¥é©Ÿ 1: è®€è€… A, B, C åŒæ™‚è®€å–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…±äº«è³‡æº    â”‚
â”‚ (Data)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘   â†‘   â†‘
  A   B   C    â† å…±äº«é–ï¼Œå¯ä»¥åŒæ™‚è®€

æ­¥é©Ÿ 2: å¯«è€… X å˜—è©¦å¯«å…¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…±äº«è³‡æº    â”‚
â”‚ (Data)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘   â†‘   â†‘
  A   B   C    â† é‚„åœ¨è®€
      â° X     â† ç­‰å¾…ä¸­ï¼ˆç„¡æ³•å–å¾—ç¨ä½”é–ï¼‰

æ­¥é©Ÿ 3: æ‰€æœ‰è®€è€…çµæŸï¼Œå¯«è€…é–‹å§‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…±äº«è³‡æº    â”‚
â”‚ (Data)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘
      X        â† ç¨ä½”é–ï¼Œåªæœ‰å®ƒèƒ½å­˜å–

æ­¥é©Ÿ 4: å¯«è€…çµæŸï¼Œæ–°è®€è€…é€²å…¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…±äº«è³‡æº    â”‚
â”‚ (Data)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘   â†‘
  D   E        â† æ–°çš„è®€è€…å¯ä»¥åŒæ™‚è®€
</code></pre>
<h3 id="-å„ªé»-3"><a class="header" href="#-å„ªé»-3">âœ… å„ªé»</a></h3>
<ul>
<li><strong>è®€å–æ•ˆèƒ½é«˜</strong>ï¼šå¤šå€‹è®€è€…ä¸äº’æ–¥</li>
<li><strong>é©åˆè®€å¤šå¯«å°‘</strong>ï¼šå¦‚å¿«å–ç³»çµ±</li>
<li><strong>å…¬å¹³æ€§å¯èª¿</strong>ï¼šå¯å„ªå…ˆè®€è€…æˆ–å¯«è€…</li>
</ul>
<h3 id="-ç¼ºé»-3"><a class="header" href="#-ç¼ºé»-3">âŒ ç¼ºé»</a></h3>
<ul>
<li><strong>å¯«è€…å¯èƒ½é¤“æ­»</strong>ï¼šè®€è€…ä¸æ–·é€²å…¥</li>
<li><strong>å¯¦ä½œè¤‡é›œ</strong>ï¼šéœ€è¦å…©ç¨®é–ç‹€æ…‹</li>
<li><strong>é¡å¤–é–‹éŠ·</strong>ï¼šæ¯”æ™®é€š Mutex æ…¢</li>
</ul>
<h3 id="-ä½¿ç”¨å ´æ™¯-3"><a class="header" href="#-ä½¿ç”¨å ´æ™¯-3">ğŸ¯ ä½¿ç”¨å ´æ™¯</a></h3>
<ul>
<li>å¿«å–ç³»çµ±ï¼ˆRedis, Memcachedï¼‰</li>
<li>çµ„æ…‹æª”è®€å–</li>
<li>è³‡æ–™åº«ç´¢å¼•</li>
</ul>
<hr />
<h2 id="5-éè¿´é–-recursive-lock"><a class="header" href="#5-éè¿´é–-recursive-lock">5. éè¿´é– (Recursive Lock)</a></h2>
<h3 id="-æ ¸å¿ƒæ¦‚å¿µ-4"><a class="header" href="#-æ ¸å¿ƒæ¦‚å¿µ-4">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</a></h3>
<p>æƒ³åƒã€Œä¿„ç¾…æ–¯å¨ƒå¨ƒã€ï¼š</p>
<ul>
<li><strong>åŒä¸€å€‹äººå¯ä»¥å¤šæ¬¡é–‹é–€</strong>ï¼ˆåŒä¸€åŸ·è¡Œç·’å¯å¤šæ¬¡åŠ é–ï¼‰</li>
<li><strong>ä½†è¦è¨˜å¾—é–‹å¹¾æ¬¡å°±è¦é—œå¹¾æ¬¡</strong></li>
</ul>
<h3 id="-ç¤ºæ„åœ–-4"><a class="header" href="#-ç¤ºæ„åœ–-4">ğŸ“Š ç¤ºæ„åœ–</a></h3>
<pre><code>æ™®é€š Mutexï¼ˆæœƒæ­»é–ï¼‰ï¼š
void funcA() {
    mutex.lock();         // âœ… ç¬¬ä¸€æ¬¡åŠ é–æˆåŠŸ
    // ...
    funcB();              // å‘¼å« funcB
}

void funcB() {
    mutex.lock();         // âŒ æ­»é–ï¼åŒä¸€åŸ·è¡Œç·’å˜—è©¦å†æ¬¡åŠ é–
    // ...
    mutex.unlock();
}

éè¿´é–ï¼ˆå¯ä»¥é‡å…¥ï¼‰ï¼š
void funcA() {
    recursive_mutex.lock();  // âœ… è¨ˆæ•¸ = 1
    // ...
    funcB();
}

void funcB() {
    recursive_mutex.lock();  // âœ… è¨ˆæ•¸ = 2ï¼ˆåŒä¸€åŸ·è¡Œç·’ï¼‰
    // ...
    recursive_mutex.unlock(); // è¨ˆæ•¸ = 1
}
// funcA çµæŸæ™‚ unlock()     // è¨ˆæ•¸ = 0ï¼ˆçœŸæ­£é‡‹æ”¾ï¼‰

é–è¨ˆæ•¸å™¨ï¼š
åŸ·è¡Œä½ç½®         | lock() æ¬¡æ•¸ | unlock() æ¬¡æ•¸ | è¨ˆæ•¸å™¨
----------------|------------|--------------|-------
é€²å…¥ funcA       |     1      |      0       |   1
é€²å…¥ funcB       |     2      |      0       |   2
é›¢é–‹ funcB       |     2      |      1       |   1
é›¢é–‹ funcA       |     2      |      2       |   0  â† é‡‹æ”¾
</code></pre>
<h3 id="-ç¨‹å¼ç¢¼ç¯„ä¾‹-4"><a class="header" href="#-ç¨‹å¼ç¢¼ç¯„ä¾‹-4">ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹</a></h3>
<pre><code class="language-cpp">#include &lt;mutex&gt;

class FileSystem {
    std::recursive_mutex mutex_;
    std::string root_path_;
    
public:
    void createDirectory(const std::string&amp; path) {
        std::lock_guard&lt;std::recursive_mutex&gt; lock(mutex_);
        
        // å»ºç«‹çˆ¶ç›®éŒ„ï¼ˆéè¿´å‘¼å«ï¼‰
        auto parent = getParentPath(path);
        if (!parent.empty()) {
            ensureDirectoryExists(parent);  // æœƒå†æ¬¡åŠ é–ï¼
        }
        
        // å»ºç«‹ç›®éŒ„
        mkdir(path.c_str(), 0755);
    }
    
    void ensureDirectoryExists(const std::string&amp; path) {
        std::lock_guard&lt;std::recursive_mutex&gt; lock(mutex_);  // é‡å…¥é–
        
        if (!exists(path)) {
            createDirectory(path);  // åˆå‘¼å«å›å»äº†ï¼
        }
    }
};
</code></pre>
<h3 id="-å‘¼å«å †ç–Šç¯„ä¾‹"><a class="header" href="#-å‘¼å«å †ç–Šç¯„ä¾‹">ğŸ”„ å‘¼å«å †ç–Šç¯„ä¾‹</a></h3>
<pre><code>å‘¼å«éç¨‹ï¼š
createDirectory("/a/b/c/d")
  â”œâ”€ lock()  [è¨ˆæ•¸=1]
  â”œâ”€ ensureDirectoryExists("/a/b/c")
  â”‚    â”œâ”€ lock()  [è¨ˆæ•¸=2]  â† åŒä¸€åŸ·è¡Œç·’ï¼Œå…è¨±ï¼
  â”‚    â”œâ”€ createDirectory("/a/b/c")
  â”‚    â”‚    â”œâ”€ lock()  [è¨ˆæ•¸=3]
  â”‚    â”‚    â”œâ”€ ensureDirectoryExists("/a/b")
  â”‚    â”‚    â”‚    â””â”€ lock()  [è¨ˆæ•¸=4]
  â”‚    â”‚    â”‚    â””â”€ unlock() [è¨ˆæ•¸=3]
  â”‚    â”‚    â””â”€ unlock() [è¨ˆæ•¸=2]
  â”‚    â””â”€ unlock() [è¨ˆæ•¸=1]
  â””â”€ unlock() [è¨ˆæ•¸=0]  â† çœŸæ­£é‡‹æ”¾
</code></pre>
<h3 id="-å„ªé»-4"><a class="header" href="#-å„ªé»-4">âœ… å„ªé»</a></h3>
<ul>
<li><strong>å…è¨±é‡å…¥</strong>ï¼šéè¿´å‡½å¼ä¸æœƒæ­»é–</li>
<li><strong>ç°¡åŒ–è¨­è¨ˆ</strong>ï¼šä¸éœ€è¿½è¹¤æ˜¯å¦å·²åŠ é–</li>
<li><strong>ç›¸å®¹ OOP</strong>ï¼šç‰©ä»¶æ–¹æ³•äº’ç›¸å‘¼å«æ–¹ä¾¿</li>
</ul>
<h3 id="-ç¼ºé»-4"><a class="header" href="#-ç¼ºé»-4">âŒ ç¼ºé»</a></h3>
<ul>
<li><strong>æ•ˆèƒ½è¼ƒå·®</strong>ï¼šéœ€è¦è¨˜éŒ„æ“æœ‰è€…å’Œè¨ˆæ•¸</li>
<li><strong>å®¹æ˜“èª¤ç”¨</strong>ï¼šéš±è—è¨­è¨ˆå•é¡Œ</li>
<li><strong>è¨˜æ†¶é«”é–‹éŠ·</strong>ï¼šéœ€è¦é¡å¤–å„²å­˜è³‡è¨Š</li>
</ul>
<h3 id="-ä½¿ç”¨å ´æ™¯-4"><a class="header" href="#-ä½¿ç”¨å ´æ™¯-4">ğŸ¯ ä½¿ç”¨å ´æ™¯</a></h3>
<ul>
<li>æ¨¹ç‹€çµæ§‹éæ­·</li>
<li>éè¿´æ¼”ç®—æ³•</li>
<li>è¤‡é›œç‰©ä»¶æ–¹æ³•å‘¼å«</li>
</ul>
<hr />
<h2 id="6-æ¢ä»¶è®Šæ•¸-condition-variable"><a class="header" href="#6-æ¢ä»¶è®Šæ•¸-condition-variable">6. æ¢ä»¶è®Šæ•¸ (Condition Variable)</a></h2>
<h3 id="-æ ¸å¿ƒæ¦‚å¿µ-5"><a class="header" href="#-æ ¸å¿ƒæ¦‚å¿µ-5">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</a></h3>
<p>æƒ³åƒã€Œé¤å»³å«è™Ÿç³»çµ±ã€ï¼š</p>
<ul>
<li><strong>å®¢äººæ‹¿è™Ÿç¢¼ç‰Œç­‰å¾…</strong>ï¼ˆwaitï¼‰</li>
<li><strong>å»šå¸«åšå¥½é¤é»é€šçŸ¥</strong>ï¼ˆnotifyï¼‰</li>
<li><strong>è¢«å«åˆ°è™Ÿç¢¼çš„å»å–é¤</strong>ï¼ˆè¢«å–šé†’ï¼‰</li>
</ul>
<h3 id="-ç¤ºæ„åœ–-5"><a class="header" href="#-ç¤ºæ„åœ–-5">ğŸ“Š ç¤ºæ„åœ–</a></h3>
<pre><code>ç”Ÿç”¢è€…-æ¶ˆè²»è€…æ¨¡å‹ï¼š

ç”Ÿç”¢è€…åŸ·è¡Œç·’ï¼š                æ¶ˆè²»è€…åŸ·è¡Œç·’ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”Ÿç”¢è³‡æ–™     â”‚              â”‚ ç­‰å¾…è³‡æ–™     â”‚
â”‚   â†“         â”‚              â”‚   â†“         â”‚
â”‚ lock()      â”‚              â”‚ lock()      â”‚
â”‚   â†“         â”‚              â”‚   â†“         â”‚
â”‚ queue.push()â”‚              â”‚ while(empty)â”‚
â”‚   â†“         â”‚              â”‚   cv.wait() â”‚ â† é‡‹æ”¾é–ä¸¦ç¡çœ 
â”‚ cv.notify() â”‚ â”€â”€â”€â”€é€šçŸ¥â”€â”€â”€â†’ â”‚ (è¢«å–šé†’)    â”‚ â† é‡æ–°å–å¾—é–
â”‚   â†“         â”‚              â”‚   â†“         â”‚
â”‚ unlock()    â”‚              â”‚ queue.pop() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â†“         â”‚
                             â”‚ unlock()    â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ™‚é–“åºåˆ—ï¼š
æ¶ˆè²»è€…: [lock]â†’[æª¢æŸ¥ç©º]â†’[wait ç¡çœ ......]â†’[è¢«å–šé†’]â†’[pop]â†’[unlock]
ç”Ÿç”¢è€…:                  [lock]â†’[push]â†’[notify]â†’[unlock]
                                        â†‘
                                    å–šé†’è¨Šè™Ÿ
</code></pre>
<h3 id="-ç¨‹å¼ç¢¼ç¯„ä¾‹-5"><a class="header" href="#-ç¨‹å¼ç¢¼ç¯„ä¾‹-5">ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹</a></h3>
<pre><code class="language-cpp">#include &lt;condition_variable&gt;
#include &lt;mutex&gt;
#include &lt;queue&gt;

template&lt;typename T&gt;
class BlockingQueue {
    std::queue&lt;T&gt; queue_;
    std::mutex mutex_;
    std::condition_variable cv_;
    
public:
    // ç”Ÿç”¢è€…ï¼šæ”¾å…¥è³‡æ–™
    void push(T value) {
        std::unique_lock&lt;std::mutex&gt; lock(mutex_);
        queue_.push(value);
        cv_.notify_one();  // é€šçŸ¥ä¸€å€‹ç­‰å¾…çš„æ¶ˆè²»è€…
    }
    
    // æ¶ˆè²»è€…ï¼šå–å‡ºè³‡æ–™ï¼ˆæœƒé˜»å¡ï¼‰
    T pop() {
        std::unique_lock&lt;std::mutex&gt; lock(mutex_);
        
        // ç­‰å¾…ç›´åˆ°ä½‡åˆ—ä¸ç‚ºç©º
        cv_.wait(lock, [this] { return !queue_.empty(); });
        
        T value = queue_.front();
        queue_.pop();
        return value;
    }
    
    // å˜—è©¦å–å‡ºï¼ˆä¸é˜»å¡ï¼‰
    bool try_pop(T&amp; value, std::chrono::milliseconds timeout) {
        std::unique_lock&lt;std::mutex&gt; lock(mutex_);
        
        if (cv_.wait_for(lock, timeout, [this] { return !queue_.empty(); })) {
            value = queue_.front();
            queue_.pop();
            return true;
        }
        return false;  // é€¾æ™‚
    }
};
</code></pre>
<h3 id="-è©³ç´°åŸ·è¡Œæµç¨‹"><a class="header" href="#-è©³ç´°åŸ·è¡Œæµç¨‹">ğŸ”„ è©³ç´°åŸ·è¡Œæµç¨‹</a></h3>
<pre><code>åˆå§‹ç‹€æ…‹ï¼šä½‡åˆ—ç©º

æ­¥é©Ÿ 1: æ¶ˆè²»è€… A å˜—è©¦ pop()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mutex_   â”‚ â† A å–å¾—
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ queue_   â”‚
â”‚ (ç©º)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ¶ˆè²»è€… A: "ä½‡åˆ—æ˜¯ç©ºçš„ï¼Œæˆ‘è¦ç­‰å¾…"
         cv_.wait() â†’ é‡‹æ”¾ mutex_ â†’ é€²å…¥ç¡çœ 

æ­¥é©Ÿ 2: ç”Ÿç”¢è€… B åŸ·è¡Œ push("è³‡æ–™")
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mutex_   â”‚ â† B å–å¾—ï¼ˆå› ç‚º A é‡‹æ”¾äº†ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ queue_   â”‚
â”‚ [è³‡æ–™]   â”‚ â† B æ”¾å…¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç”Ÿç”¢è€… B: "é€šçŸ¥ç­‰å¾…çš„äºº"
         cv_.notify_one() â†’ å–šé†’ A
         é‡‹æ”¾ mutex_

æ­¥é©Ÿ 3: æ¶ˆè²»è€… A è¢«å–šé†’
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mutex_   â”‚ â† A é‡æ–°å–å¾—
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ queue_   â”‚
â”‚ [è³‡æ–™]   â”‚ â† A å–å‡º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ¶ˆè²»è€… A: "æ‹¿åˆ°è³‡æ–™äº†ï¼"
         è¿”å› "è³‡æ–™"
         é‡‹æ”¾ mutex_
</code></pre>
<h3 id="-å¸¸è¦‹é™·é˜±è™›å‡å–šé†’"><a class="header" href="#-å¸¸è¦‹é™·é˜±è™›å‡å–šé†’">âš ï¸ å¸¸è¦‹é™·é˜±ï¼šè™›å‡å–šé†’</a></h3>
<pre><code class="language-cpp">// âŒ éŒ¯èª¤å¯«æ³•ï¼ˆå¯èƒ½è™›å‡å–šé†’ï¼‰
cv_.wait(lock);
T value = queue_.front();  // å¯èƒ½ queue_ é‚„æ˜¯ç©ºçš„ï¼

// âœ… æ­£ç¢ºå¯«æ³•ï¼ˆç”¨ predicateï¼‰
cv_.wait(lock, [this] { return !queue_.empty(); });
T value = queue_.front();  // ä¿è­‰æœ‰è³‡æ–™

// ç­‰åƒ¹æ–¼ï¼š
while (queue_.empty()) {
    cv_.wait(lock);  // è¢«å–šé†’å¾Œé‡æ–°æª¢æŸ¥
}
</code></pre>
<h3 id="-å„ªé»-5"><a class="header" href="#-å„ªé»-5">âœ… å„ªé»</a></h3>
<ul>
<li><strong>é«˜æ•ˆç­‰å¾…</strong>ï¼šä¸éœ€è¦å¿™ç¢Œè¼ªè©¢</li>
<li><strong>è‡ªå‹•ç®¡ç†</strong>ï¼šé…åˆ RAII ä¸æœƒå¿˜è¨˜è§£é–</li>
<li><strong>æ”¯æ´é€¾æ™‚</strong>ï¼šwait_for, wait_until</li>
</ul>
<h3 id="-ç¼ºé»-5"><a class="header" href="#-ç¼ºé»-5">âŒ ç¼ºé»</a></h3>
<ul>
<li><strong>éœ€æ­é… Mutex</strong>ï¼šä¸èƒ½å–®ç¨ä½¿ç”¨</li>
<li><strong>è™›å‡å–šé†’</strong>ï¼šéœ€è¦ç”¨ while è¿´åœˆ</li>
<li><strong>æ•ˆèƒ½é–‹éŠ·</strong>ï¼šç³»çµ±å‘¼å«</li>
</ul>
<h3 id="-ä½¿ç”¨å ´æ™¯-5"><a class="header" href="#-ä½¿ç”¨å ´æ™¯-5">ğŸ¯ ä½¿ç”¨å ´æ™¯</a></h3>
<ul>
<li>ç”Ÿç”¢è€…-æ¶ˆè²»è€…ä½‡åˆ—</li>
<li>åŸ·è¡Œç·’æ± </li>
<li>äº‹ä»¶é€šçŸ¥ç³»çµ±</li>
</ul>
<hr />
<h2 id="7-ä¿¡è™Ÿé‡-semaphore"><a class="header" href="#7-ä¿¡è™Ÿé‡-semaphore">7. ä¿¡è™Ÿé‡ (Semaphore)</a></h2>
<h3 id="-æ ¸å¿ƒæ¦‚å¿µ-6"><a class="header" href="#-æ ¸å¿ƒæ¦‚å¿µ-6">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</a></h3>
<p>æƒ³åƒã€Œåœè»Šå ´ã€ï¼š</p>
<ul>
<li><strong>æœ‰ N å€‹åœè»Šä½</strong>ï¼ˆè³‡æºæ•¸é‡ï¼‰</li>
<li><strong>è»Šé€²ä¾† â†’ å¯ç”¨è»Šä½ -1</strong>ï¼ˆacquireï¼‰</li>
<li><strong>è»Šå‡ºå» â†’ å¯ç”¨è»Šä½ +1</strong>ï¼ˆreleaseï¼‰</li>
<li><strong>è»Šä½æ»¿äº†å°±åœ¨å¤–é¢ç­‰</strong></li>
</ul>
<h3 id="-ç¤ºæ„åœ–-6"><a class="header" href="#-ç¤ºæ„åœ–-6">ğŸ“Š ç¤ºæ„åœ–</a></h3>
<pre><code>äºŒå…ƒä¿¡è™Ÿé‡ï¼ˆBinary Semaphoreï¼‰= Mutex
â”Œâ”€â”€â”€â”€â”€â”
â”‚  1  â”‚ â† åˆå§‹å€¼
â””â”€â”€â”€â”€â”€â”˜

åŸ·è¡Œç·’ A:  acquire() â†’ 0 â†’ [åŸ·è¡Œ] â†’ release() â†’ 1
åŸ·è¡Œç·’ B:              â†‘ ç­‰å¾…ï¼ˆå€¼=0ï¼‰              â†‘ è¢«å–šé†’

è¨ˆæ•¸ä¿¡è™Ÿé‡ï¼ˆCounting Semaphoreï¼‰ï¼šè³‡æºæ± 
â”Œâ”€â”€â”€â”€â”€â”
â”‚  3  â”‚ â† æœ‰ 3 å€‹è³‡æº
â””â”€â”€â”€â”€â”€â”˜

åŸ·è¡Œç·’ A: acquire() â†’ 2
åŸ·è¡Œç·’ B: acquire() â†’ 1
åŸ·è¡Œç·’ C: acquire() â†’ 0
åŸ·è¡Œç·’ D: acquire() â†’ [é˜»å¡ï¼Œç­‰å¾…æœ‰äºº release()]

è¦–è¦ºåŒ–ï¼š
åœè»Šå ´ï¼ˆå®¹é‡ 3ï¼‰ï¼š
[ğŸš—] [ğŸš—] [ğŸš—]  â† æ»¿äº†ï¼ŒåŸ·è¡Œç·’ D åœ¨å¤–é¢ç­‰
 A    B    C

åŸ·è¡Œç·’ A é›¢é–‹ï¼š
[  ] [ğŸš—] [ğŸš—]  â† æœ‰ç©ºä½äº†ï¼åŸ·è¡Œç·’ D é€²ä¾†
     B    C
[ğŸš—]
 D
</code></pre>
<h3 id="-ç¨‹å¼ç¢¼ç¯„ä¾‹-6"><a class="header" href="#-ç¨‹å¼ç¢¼ç¯„ä¾‹-6">ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹</a></h3>
<pre><code class="language-cpp">#include &lt;semaphore&gt;  // C++20

// è³‡æ–™åº«é€£ç·šæ± ï¼ˆæœ€å¤š 5 å€‹é€£ç·šï¼‰
class ConnectionPool {
    std::counting_semaphore&lt;5&gt; semaphore_{5};  // åˆå§‹å€¼ 5
    std::vector&lt;Connection*&gt; connections_;
    std::mutex mutex_;
    
public:
    ConnectionPool() {
        // åˆå§‹åŒ– 5 å€‹é€£ç·š
        for (int i = 0; i &lt; 5; ++i) {
            connections_.push_back(new Connection());
        }
    }
    
    // å–å¾—é€£ç·šï¼ˆæœƒé˜»å¡ç›´åˆ°æœ‰å¯ç”¨é€£ç·šï¼‰
    Connection* acquire() {
        semaphore_.acquire();  // å¯ç”¨æ•¸ -1ï¼ˆå¯èƒ½é˜»å¡ï¼‰
        
        std::lock_guard&lt;std::mutex&gt; lock(mutex_);
        Connection* conn = connections_.back();
        connections_.pop_back();
        return conn;
    }
    
    // æ­¸é‚„é€£ç·š
    void release(Connection* conn) {
        std::lock_guard&lt;std::mutex&gt; lock(mutex_);
        connections_.push_back(conn);
        
        semaphore_.release();  // å¯ç”¨æ•¸ +1ï¼ˆå–šé†’ç­‰å¾…è€…ï¼‰
    }
    
    // å˜—è©¦å–å¾—ï¼ˆä¸é˜»å¡ï¼‰
    Connection* try_acquire() {
        if (semaphore_.try_acquire()) {  // æˆåŠŸè¿”å› true
            std::lock_guard&lt;std::mutex&gt; lock(mutex_);
            Connection* conn = connections_.back();
            connections_.pop_back();
            return conn;
        }
        return nullptr;  // ç„¡å¯ç”¨é€£ç·š
    }
};

// ä½¿ç”¨ç¯„ä¾‹
void worker_thread(ConnectionPool&amp; pool) {
    Connection* conn = pool.acquire();  // ç­‰å¾…å¯ç”¨é€£ç·š
    
    // ä½¿ç”¨é€£ç·šåŸ·è¡ŒæŸ¥è©¢
    conn-&gt;execute("SELECT * FROM users");
    
    pool.release(conn);  // æ­¸é‚„é€£ç·š
}
</code></pre>
<h3 id="-åŸ·è¡Œæ™‚åº"><a class="header" href="#-åŸ·è¡Œæ™‚åº">ğŸ”„ åŸ·è¡Œæ™‚åº</a></h3>
<pre><code>å ´æ™¯ï¼š5 å€‹é€£ç·šçš„è³‡æ–™åº«æ± 

æ™‚åˆ» 0: ä¿¡è™Ÿé‡å€¼ = 5
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ 1 â”‚ 2 â”‚ 3 â”‚ 4 â”‚ 5 â”‚ æ‰€æœ‰é€£ç·šéƒ½å¯ç”¨
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜

æ™‚åˆ» 1: åŸ·è¡Œç·’ A, B, C, D, E éƒ½ acquire()
ä¿¡è™Ÿé‡å€¼ = 0
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ A â”‚ B â”‚ C â”‚ D â”‚ E â”‚ é€£ç·šå…¨éƒ¨è¢«ä½”ç”¨
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜

æ™‚åˆ» 2: åŸ·è¡Œç·’ F, G å˜—è©¦ acquire()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç­‰å¾…ä½‡åˆ—â”‚
â”‚   F     â”‚ â† é˜»å¡ä¸­
â”‚   G     â”‚ â† é˜»å¡ä¸­
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ™‚åˆ» 3: åŸ·è¡Œç·’ A release()
ä¿¡è™Ÿé‡å€¼ = 1 â†’ å–šé†’ F
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ F â”‚ B â”‚ C â”‚ D â”‚ E â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
ç­‰å¾…ä½‡åˆ—ï¼š[G]

æ™‚åˆ» 4: åŸ·è¡Œç·’ B release()
ä¿¡è™Ÿé‡å€¼ = 1 â†’ å–šé†’ G
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ F â”‚ G â”‚ C â”‚ D â”‚ E â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
</code></pre>
<h3 id="-semaphore-vs-mutex-å°æ¯”"><a class="header" href="#-semaphore-vs-mutex-å°æ¯”">ğŸ†š Semaphore vs Mutex å°æ¯”</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç‰¹æ€§      â”‚   Mutex      â”‚  Semaphore  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆå§‹å€¼      â”‚ 1 (unlocked) â”‚ N (å¯è¨­å®š)  â”‚
â”‚ èª°èƒ½é‡‹æ”¾    â”‚ åªæœ‰æ“æœ‰è€…   â”‚ ä»»ä½•åŸ·è¡Œç·’  â”‚
â”‚ ç”¨é€”        â”‚ äº’æ–¥å­˜å–     â”‚ è³‡æºè¨ˆæ•¸    â”‚
â”‚ å¯é‡å…¥      â”‚ éœ€ recursive â”‚ ä¸æ”¯æ´      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="-å„ªé»-6"><a class="header" href="#-å„ªé»-6">âœ… å„ªé»</a></h3>
<ul>
<li><strong>é™åˆ¶ä¸¦è¡Œæ•¸</strong>ï¼šæ§åˆ¶è³‡æºä½¿ç”¨</li>
<li><strong>ç°¡å–®ç›´è§€</strong>ï¼šæ¦‚å¿µå®¹æ˜“ç†è§£</li>
<li><strong>å½ˆæ€§é«˜</strong>ï¼šæ”¯æ´å¤šç¨®èªç¾©ï¼ˆäºŒå…ƒã€è¨ˆæ•¸ï¼‰</li>
</ul>
<h3 id="-ç¼ºé»-6"><a class="header" href="#-ç¼ºé»-6">âŒ ç¼ºé»</a></h3>
<ul>
<li><strong>å®¹æ˜“èª¤ç”¨</strong>ï¼šrelease ä¸ç•¶æœƒç ´å£è¨ˆæ•¸</li>
<li><strong>ç„¡æ“æœ‰æ¬Šæ¦‚å¿µ</strong>ï¼šä»»ä½•äººéƒ½èƒ½ release</li>
<li><strong>é™¤éŒ¯å›°é›£</strong>ï¼šä¿¡è™Ÿé‡æ´©æ¼é›£ä»¥è¿½è¹¤</li>
</ul>
<h3 id="-ä½¿ç”¨å ´æ™¯-6"><a class="header" href="#-ä½¿ç”¨å ´æ™¯-6">ğŸ¯ ä½¿ç”¨å ´æ™¯</a></h3>
<ul>
<li>é€£ç·šæ± ã€åŸ·è¡Œç·’æ± </li>
<li>é™æµå™¨ï¼ˆRate Limiterï¼‰</li>
<li>è³‡æºæ± ç®¡ç†</li>
</ul>
<hr />
<h2 id="8-æŸµæ¬„-barrier"><a class="header" href="#8-æŸµæ¬„-barrier">8. æŸµæ¬„ (Barrier)</a></h2>
<h3 id="-æ ¸å¿ƒæ¦‚å¿µ-7"><a class="header" href="#-æ ¸å¿ƒæ¦‚å¿µ-7">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</a></h3>
<p>æƒ³åƒã€Œåœ˜é«”æ—…éŠé›†åˆé»ã€ï¼š</p>
<ul>
<li><strong>æ‰€æœ‰äººéƒ½åˆ°äº†æ‰èƒ½ç¹¼çºŒ</strong></li>
<li><strong>æ—©åˆ°çš„äººç­‰æ™šåˆ°çš„</strong></li>
<li><strong>æœ€å¾Œä¸€äººåˆ°é” â†’ æ‰€æœ‰äººä¸€èµ·å‡ºç™¼</strong></li>
</ul>
<h3 id="-ç¤ºæ„åœ–-7"><a class="header" href="#-ç¤ºæ„åœ–-7">ğŸ“Š ç¤ºæ„åœ–</a></h3>
<pre><code>5 å€‹åŸ·è¡Œç·’ä½¿ç”¨ Barrier(5)ï¼š

åŸ·è¡Œç·’ 1:  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â†’ [ç­‰å¾…....]
åŸ·è¡Œç·’ 2:  â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â†’ [ç­‰å¾…....]
åŸ·è¡Œç·’ 3:  â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [ç­‰å¾…....]
åŸ·è¡Œç·’ 4:  â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [ç­‰å¾…....]
åŸ·è¡Œç·’ 5:  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â†’ [æœ€å¾Œåˆ°é”ï¼Œé‡‹æ”¾æ‰€æœ‰äººï¼]
                         â†“
åŸ·è¡Œç·’ 1:                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [ç¹¼çºŒåŸ·è¡Œ]
åŸ·è¡Œç·’ 2:                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [ç¹¼çºŒåŸ·è¡Œ]
åŸ·è¡Œç·’ 3:                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [ç¹¼çºŒåŸ·è¡Œ]
åŸ·è¡Œç·’ 4:                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [ç¹¼çºŒåŸ·è¡Œ]
åŸ·è¡Œç·’ 5:                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [ç¹¼çºŒåŸ·è¡Œ]

é›†åˆé»ç¤ºæ„ï¼š
åˆ°é”è¨ˆæ•¸å™¨ï¼š0/5 â†’ 1/5 â†’ 2/5 â†’ 3/5 â†’ 4/5 â†’ 5/5 âœ“
            â†‘     â†‘     â†‘     â†‘     â†‘     â†‘
           T4    T2    T3    T1    T5   (å…¨å“¡åˆ°é½Šï¼)
</code></pre>
<h3 id="-ç¨‹å¼ç¢¼ç¯„ä¾‹-7"><a class="header" href="#-ç¨‹å¼ç¢¼ç¯„ä¾‹-7">ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹</a></h3>
<pre><code class="language-cpp">#include &lt;barrier&gt;  // C++20

// å¤šéšæ®µå¹³è¡Œè¨ˆç®—
class ParallelProcessor {
    std::barrier&lt;&gt; sync_point_;  // åŒæ­¥é»
    std::vector&lt;std::thread&gt; workers_;
    
public:
    ParallelProcessor(int num_threads) 
        : sync_point_(num_threads) {  // åˆå§‹åŒ–æŸµæ¬„
        
        for (int i = 0; i &lt; num_threads; ++i) {
            workers_.emplace_back([this, i] {
                worker_task(i);
            });
        }
    }
    
    void worker_task(int id) {
        // éšæ®µ 1ï¼šè®€å–è³‡æ–™
        auto data = read_data(id);
        sync_point_.arrive_and_wait();  // ç­‰æ‰€æœ‰äººè®€å®Œ
        
        // éšæ®µ 2ï¼šè™•ç†è³‡æ–™
        auto result = process_data(data);
        sync_point_.arrive_and_wait();  // ç­‰æ‰€æœ‰äººè™•ç†å®Œ
        
        // éšæ®µ 3ï¼šå¯«å…¥çµæœ
        write_result(id, result);
        sync_point_.arrive_and_wait();  // ç­‰æ‰€æœ‰äººå¯«å®Œ
    }
};

// ä½¿ç”¨å›èª¿çš„ç‰ˆæœ¬ï¼ˆC++20ï¼‰
void parallel_map_reduce() {
    const int N = 4;
    std::vector&lt;int&gt; results(N);
    
    // Barrier å®Œæˆæ™‚åŸ·è¡Œçš„å›èª¿
    auto on_completion = [&amp;]() noexcept {
        int sum = 0;
        for (int r : results) sum += r;
        std::cout &lt;&lt; "ç¸½å’Œ: " &lt;&lt; sum &lt;&lt; std::endl;
    };
    
    std::barrier sync_point(N, on_completion);
    
    std::vector&lt;std::thread&gt; threads;
    for (int i = 0; i &lt; N; ++i) {
        threads.emplace_back([&amp;, i] {
            results[i] = compute(i);
            sync_point.arrive_and_wait();  // æœ€å¾Œä¸€äººè§¸ç™¼å›èª¿
        });
    }
    
    for (auto&amp; t : threads) t.join();
}
</code></pre>
<h3 id="-åŸ·è¡Œæ™‚åºç¯„ä¾‹"><a class="header" href="#-åŸ·è¡Œæ™‚åºç¯„ä¾‹">ğŸ”„ åŸ·è¡Œæ™‚åºç¯„ä¾‹</a></h3>
<pre><code>å ´æ™¯ï¼š4 å€‹åŸ·è¡Œç·’è¨ˆç®—çŸ©é™£

éšæ®µ 1ï¼šæ¯å€‹åŸ·è¡Œç·’è¨ˆç®—è‡ªå·±çš„åˆ—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thread 0: [è¨ˆç®—åˆ— 0] â†’ å®Œæˆ â—   â”‚
â”‚ Thread 1: [è¨ˆç®—åˆ— 1] â†’ å®Œæˆ â—   â”‚
â”‚ Thread 2: [è¨ˆç®—åˆ— 2........] â†’  â”‚ â† é‚„åœ¨ç®—
â”‚ Thread 3: [è¨ˆç®—åˆ— 3] â†’ å®Œæˆ â—   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
åˆ°é”è¨ˆæ•¸ï¼š3/4ï¼ˆç­‰å¾… Thread 2ï¼‰

Thread 2 å®Œæˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thread 0: [ç­‰å¾…]                â”‚
â”‚ Thread 1: [ç­‰å¾…]                â”‚
â”‚ Thread 2: [è¨ˆç®—åˆ— 2] â†’ å®Œæˆ â— â†’ â”‚ å…¨å“¡åˆ°é½Šï¼
â”‚ Thread 3: [ç­‰å¾…]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
åˆ°é”è¨ˆæ•¸ï¼š4/4 âœ“ â†’ æ‰€æœ‰äººç¹¼çºŒ

éšæ®µ 2ï¼šåŒæ­¥å¾Œé–‹å§‹ä¸‹ä¸€éšæ®µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thread 0: â†’ [æ­£è¦åŒ–åˆ— 0]        â”‚
â”‚ Thread 1: â†’ [æ­£è¦åŒ–åˆ— 1]        â”‚
â”‚ Thread 2: â†’ [æ­£è¦åŒ–åˆ— 2]        â”‚
â”‚ Thread 3: â†’ [æ­£è¦åŒ–åˆ— 3]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="-barrier-vs-condition-variable"><a class="header" href="#-barrier-vs-condition-variable">ğŸ†š Barrier vs Condition Variable</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ¯”è¼ƒé …   â”‚    Barrier      â”‚ Condition Var    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å–šé†’æ–¹å¼   â”‚ æœ€å¾Œä¸€äººåˆ°é”    â”‚ æ˜ç¢º notify      â”‚
â”‚ ç­‰å¾…èªç¾©   â”‚ å…¨å“¡åˆ°é½Š        â”‚ æ¢ä»¶æ»¿è¶³         â”‚
â”‚ é‡è¤‡ä½¿ç”¨   â”‚ è‡ªå‹•é‡ç½®        â”‚ éœ€æ‰‹å‹•ç®¡ç†       â”‚
â”‚ é©ç”¨å ´æ™¯   â”‚ å¤šéšæ®µåŒæ­¥      â”‚ ç”Ÿç”¢è€…-æ¶ˆè²»è€…    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="-å„ªé»-7"><a class="header" href="#-å„ªé»-7">âœ… å„ªé»</a></h3>
<ul>
<li><strong>ç°¡åŒ–å¤šéšæ®µåŒæ­¥</strong>ï¼šä¸éœ€è¤‡é›œçš„è¨ˆæ•¸é‚è¼¯</li>
<li><strong>è‡ªå‹•é‡ç½®</strong>ï¼šå¯é‡è¤‡ä½¿ç”¨</li>
<li><strong>æ”¯æ´å›èª¿</strong>ï¼šå®Œæˆæ™‚è‡ªå‹•åŸ·è¡Œ</li>
</ul>
<h3 id="-ç¼ºé»-7"><a class="header" href="#-ç¼ºé»-7">âŒ ç¼ºé»</a></h3>
<ul>
<li><strong>å›ºå®šåƒèˆ‡è€…æ•¸é‡</strong>ï¼šç„¡æ³•å‹•æ…‹èª¿æ•´</li>
<li><strong>å…¨å“¡é˜»å¡</strong>ï¼šä¸€å€‹æ…¢æ‹–ç´¯å…¨éƒ¨</li>
<li><strong>éœ€ C++20</strong>ï¼šèˆŠç·¨è­¯å™¨ä¸æ”¯æ´</li>
</ul>
<h3 id="-ä½¿ç”¨å ´æ™¯-7"><a class="header" href="#-ä½¿ç”¨å ´æ™¯-7">ğŸ¯ ä½¿ç”¨å ´æ™¯</a></h3>
<ul>
<li>å¹³è¡Œæ¼”ç®—æ³•ï¼ˆMapReduceï¼‰</li>
<li>GPU è¨ˆç®—åŒæ­¥</li>
<li>éŠæˆ²å¼•æ“å¹€åŒæ­¥</li>
</ul>
<hr />
<h2 id="9-é †åºé–-seqlock"><a class="header" href="#9-é †åºé–-seqlock">9. é †åºé– (Seqlock)</a></h2>
<h3 id="-æ ¸å¿ƒæ¦‚å¿µ-8"><a class="header" href="#-æ ¸å¿ƒæ¦‚å¿µ-8">ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</a></h3>
<p>æƒ³åƒã€Œåšç‰©é¤¨å±•å“ã€ï¼š</p>
<ul>
<li><strong>åƒè§€è€…</strong>ï¼šéš¨æ™‚å¯ä»¥çœ‹ï¼ˆè®€è€…ï¼‰</li>
<li><strong>ç®¡ç†å“¡</strong>ï¼šå¶çˆ¾æ›å±•å“ï¼ˆå¯«è€…ï¼‰</li>
<li><strong>åƒè§€è€…è¦å‰‡</strong>ï¼šå¦‚æœçœ‹åˆ°ç®¡ç†å“¡åœ¨æ›ï¼Œé‡æ–°çœ‹ä¸€æ¬¡</li>
</ul>
<h3 id="-ç¤ºæ„åœ–-8"><a class="header" href="#-ç¤ºæ„åœ–-8">ğŸ“Š ç¤ºæ„åœ–</a></h3>
<pre><code>è³‡æ–™çµæ§‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sequence: 0 (å¶æ•¸)  â”‚ â† ç‰ˆæœ¬è™Ÿ
â”‚ data: {x:10, y:20}  â”‚ â† å¯¦éš›è³‡æ–™
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯«å…¥éç¨‹ï¼š
æ­¥é©Ÿ 1: å¯«è€…é–‹å§‹
sequence = 1 (å¥‡æ•¸)  â† "æ­£åœ¨ä¿®æ”¹ä¸­"
å¯«è€…: å¯«å…¥ x = 15
å¯«è€…: å¯«å…¥ y = 25
sequence = 2 (å¶æ•¸)  â† "ä¿®æ”¹å®Œæˆ"

è®€å–éç¨‹ï¼ˆæ¨‚è§€è®€å–ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®€è€…é–‹å§‹:                            â”‚
â”‚   seq1 = sequence.load()  // è¨˜éŒ„ç‰ˆæœ¬â”‚
â”‚   â†“                                  â”‚
â”‚   è®€å– data                          â”‚
â”‚   â†“                                  â”‚
â”‚   seq2 = sequence.load()  // å†æ¬¡æª¢æŸ¥â”‚
â”‚   â†“                                  â”‚
â”‚   if (seq1 == seq2 &amp;&amp; seq1 % 2 == 0) â”‚
â”‚     â†’ è³‡æ–™ä¸€è‡´ï¼Œä½¿ç”¨å®ƒ               â”‚
â”‚   else                               â”‚
â”‚     â†’ é‡è©¦ï¼                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ™‚åºåœ–ï¼š
è®€è€… A:  [seq=0] â†’ è®€å– â†’ [seq=0] âœ“ æˆåŠŸ
å¯«è€…:                  [seq=1] å¯«å…¥ä¸­ [seq=2]
è®€è€… B:          [seq=0] â†’ è®€å– â†’ [seq=2] âœ— é‡è©¦
                         [seq=2] â†’ è®€å– â†’ [seq=2] âœ“ æˆåŠŸ
</code></pre>
<h3 id="-ç¨‹å¼ç¢¼ç¯„ä¾‹-8"><a class="header" href="#-ç¨‹å¼ç¢¼ç¯„ä¾‹-8">ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹</a></h3>
<pre><code class="language-cpp">#include &lt;atomic&gt;

template&lt;typename T&gt;
class Seqlock {
    std::atomic&lt;unsigned&gt; sequence_{0};
    T data_;
    
public:
    // å¯«å…¥ï¼ˆç¨ä½”ï¼‰
    void write(const T&amp; new_data) {
        // æ­¥é©Ÿ 1ï¼šå¢åŠ ç‰ˆæœ¬è™Ÿï¼ˆè®Šå¥‡æ•¸ï¼‰
        unsigned seq = sequence_.load(std::memory_order_relaxed);
        sequence_.store(seq + 1, std::memory_order_release);
        
        // æ­¥é©Ÿ 2ï¼šå¯«å…¥è³‡æ–™
        data_ = new_data;
        
        // æ­¥é©Ÿ 3ï¼šå†æ¬¡å¢åŠ ç‰ˆæœ¬è™Ÿï¼ˆè®Šå¶æ•¸ï¼‰
        sequence_.store(seq + 2, std::memory_order_release);
    }
    
    // è®€å–ï¼ˆæ¨‚è§€ï¼‰
    T read() const {
        T result;
        unsigned seq1, seq2;
        
        do {
            // è¨˜éŒ„ç‰ˆæœ¬è™Ÿ
            seq1 = sequence_.load(std::memory_order_acquire);
            
            // å¦‚æœæ˜¯å¥‡æ•¸ï¼Œè¡¨ç¤ºæ­£åœ¨å¯«å…¥ï¼Œç­‰ä¸€ä¸‹
            while (seq1 &amp; 1) {
                seq1 = sequence_.load(std::memory_order_acquire);
            }
            
            // è®€å–è³‡æ–™
            result = data_;
            
            // æª¢æŸ¥ç‰ˆæœ¬è™Ÿæ˜¯å¦æ”¹è®Š
            seq2 = sequence_.load(std::memory_order_acquire);
            
        } while (seq1 != seq2);  // ä¸ä¸€è‡´å°±é‡è©¦
        
        return result;
    }
};

// å¯¦éš›æ‡‰ç”¨ï¼šåº§æ¨™è¿½è¹¤
struct Position {
    double x, y, z;
    uint64_t timestamp;
};

Seqlock&lt;Position&gt; player_position;

// éŠæˆ²åŸ·è¡Œç·’ï¼ˆå¯«è€…ï¼‰
void update_position(double x, double y, double z) {
    Position pos{x, y, z, get_timestamp()};
    player_position.write(pos);
}

// æ¸²æŸ“åŸ·è¡Œç·’ï¼ˆè®€è€…ï¼‰
void render_player() {
    Position pos = player_position.read();
    draw_at(pos.x, pos.y, pos.z);
}
</code></pre>
<h3 id="-ç«¶çˆ­æ¢ä»¶è™•ç†"><a class="header" href="#-ç«¶çˆ­æ¢ä»¶è™•ç†">ğŸ”„ ç«¶çˆ­æ¢ä»¶è™•ç†</a></h3>
<pre><code>å ´æ™¯ï¼šè®€è€…åœ¨å¯«è€…ä¿®æ”¹æœŸé–“è®€å–

åˆå§‹ç‹€æ…‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sequence = 100     â”‚
â”‚ x = 10, y = 20     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ™‚åˆ» T1ï¼šè®€è€…é–‹å§‹è®€å–
è®€è€…: seq1 = 100 (å¶æ•¸ï¼ŒOK)
è®€è€…: è®€å– x = 10

æ™‚åˆ» T2ï¼šå¯«è€…é–‹å§‹å¯«å…¥ï¼ˆåœ¨è®€è€…è®€å®Œä¹‹å‰ï¼‰
å¯«è€…: sequence = 101 (å¥‡æ•¸)  â† æ¨™è¨˜"æ­£åœ¨å¯«"
å¯«è€…: x = 15
å¯«è€…: y = 25
å¯«è€…: sequence = 102 (å¶æ•¸)

æ™‚åˆ» T3ï¼šè®€è€…è®€å®Œæª¢æŸ¥
è®€è€…: è®€å– y = 25  â† å¯èƒ½æ˜¯æ–°å€¼ï¼
è®€è€…: seq2 = 102
è®€è€…: seq1(100) != seq2(102) â†’ è³‡æ–™ä¸ä¸€è‡´ï¼
è®€è€…: é‡è©¦...

æ™‚åˆ» T4ï¼šè®€è€…é‡è©¦
è®€è€…: seq1 = 102
è®€è€…: è®€å– x = 15, y = 25
è®€è€…: seq2 = 102
è®€è€…: seq1 == seq2 â†’ æˆåŠŸï¼âœ“
</code></pre>
<h3 id="-seqlock-vs-rwlock"><a class="header" href="#-seqlock-vs-rwlock">ğŸ†š Seqlock vs RWLock</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç‰¹æ€§      â”‚   Seqlock    â”‚   RWLock    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è®€å–æˆæœ¬    â”‚ ç„¡é–ï¼ˆå¿«ï¼‰   â”‚ éœ€åŠ é–ï¼ˆæ…¢ï¼‰â”‚
â”‚ å¯«å…¥æˆæœ¬    â”‚ ç„¡é–         â”‚ ç¨ä½”é–      â”‚
â”‚ è®€å¤±æ•—è™•ç†  â”‚ é‡è©¦         â”‚ é˜»å¡ç­‰å¾…    â”‚
â”‚ è³‡æ–™ä¸€è‡´æ€§  â”‚ æœ€çµ‚ä¸€è‡´     â”‚ å¼·ä¸€è‡´      â”‚
â”‚ é©ç”¨å ´æ™¯    â”‚ è®€å¤šå¯«å°‘     â”‚ è®€å¤šå¯«ä¸­    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="-å„ªé»-8"><a class="header" href="#-å„ªé»-8">âœ… å„ªé»</a></h3>
<ul>
<li><strong>è®€å–è¶…å¿«</strong>ï¼šå®Œå…¨ç„¡é–</li>
<li><strong>å¯«è€…ä¸é˜»å¡è®€è€…</strong>ï¼šè®€è€…è‡ªå·±é‡è©¦</li>
<li><strong>ç„¡æ­»é–</strong>ï¼šæ²’æœ‰é–å°±ä¸æœƒå¡</li>
</ul>
<h3 id="-ç¼ºé»-8"><a class="header" href="#-ç¼ºé»-8">âŒ ç¼ºé»</a></h3>
<ul>
<li><strong>è®€è€…å¯èƒ½é¤“æ­»</strong>ï¼šé »ç¹å¯«å…¥æ™‚ä¸€ç›´é‡è©¦</li>
<li><strong>è³‡æ–™å¤§å°é™åˆ¶</strong>ï¼šè¤‡è£½æˆæœ¬é«˜</li>
<li><strong>å¯«è€…éœ€äº’æ–¥</strong>ï¼šå¤šå¯«è€…éœ€é¡å¤–æ©Ÿåˆ¶</li>
</ul>
<h3 id="-ä½¿ç”¨å ´æ™¯-8"><a class="header" href="#-ä½¿ç”¨å ´æ™¯-8">ğŸ¯ ä½¿ç”¨å ´æ™¯</a></h3>
<ul>
<li>å³æ™‚ç³»çµ±ï¼ˆè‚¡ç¥¨åƒ¹æ ¼ï¼‰</li>
<li>éŠæˆ²å¼•æ“ï¼ˆä½ç½®æ›´æ–°ï¼‰</li>
<li>ç³»çµ±ç›£æ§ï¼ˆçµ±è¨ˆè³‡æ–™ï¼‰</li>
</ul>
<hr />
<h2 id="10-æ•ˆèƒ½æ¯”è¼ƒç¸½è¡¨"><a class="header" href="#10-æ•ˆèƒ½æ¯”è¼ƒç¸½è¡¨">10. æ•ˆèƒ½æ¯”è¼ƒç¸½è¡¨</a></h2>
<h3 id="-å»¶é²å°æ¯”"><a class="header" href="#-å»¶é²å°æ¯”">ğŸ“Š å»¶é²å°æ¯”</a></h3>
<pre><code>æ“ä½œå»¶é²ï¼ˆå–®ä½ï¼šå¥ˆç§’ï¼Œä»¥ç¾ä»£ x86-64 ç‚ºæº–ï¼‰ï¼š

Lock-Free (CAS):      ~10-50 ns
Spinlock:             ~50-100 ns
Mutex (ç„¡ç«¶çˆ­):       ~50-100 ns
Mutex (æœ‰ç«¶çˆ­):       ~1,000-10,000 ns  â† Context Switch
RWLock (è®€):          ~100-200 ns
RWLock (å¯«):          ~1,000-10,000 ns
Semaphore:            ~1,000-5,000 ns
Condition Variable:   ~1,000-10,000 ns

åœ–ç¤ºï¼š
Lock-Free  â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  (æ¥µå¿«)
Spinlock   â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  (å¿«)
Mutex(ç„¡)  â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  (å¿«)
Mutex(æœ‰)  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  (æ…¢)
Semaphore  â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  (ä¸­æ…¢)
</code></pre>
<h3 id="-ä½¿ç”¨å ´æ™¯é¸æ“‡è¡¨"><a class="header" href="#-ä½¿ç”¨å ´æ™¯é¸æ“‡è¡¨">ğŸ¯ ä½¿ç”¨å ´æ™¯é¸æ“‡è¡¨</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å ´æ™¯           â”‚          æ¨è–¦é–æ©Ÿåˆ¶              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SPSC ä½‡åˆ—          â”‚ Lock-Free Queue                 â”‚
â”‚ å…±äº«è¨ˆæ•¸å™¨         â”‚ Atomic / Spinlock               â”‚
â”‚ éŠ€è¡Œè½‰å¸³           â”‚ Mutex                           â”‚
â”‚ å¿«å–ç³»çµ±           â”‚ RWLock / Seqlock                â”‚
â”‚ éè¿´å‡½å¼ä¿è­·       â”‚ Recursive Mutex                 â”‚
â”‚ ç”Ÿç”¢è€…-æ¶ˆè²»è€…      â”‚ Condition Variable              â”‚
â”‚ é€£ç·šæ±              â”‚ Semaphore                       â”‚
â”‚ å¹³è¡Œæ¼”ç®—æ³•åŒæ­¥     â”‚ Barrier                         â”‚
â”‚ å³æ™‚è‚¡åƒ¹æ›´æ–°       â”‚ Seqlock                         â”‚
â”‚ æ ¸å¿ƒ Interrupt     â”‚ Spinlock                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="-æ±ºç­–æ¨¹"><a class="header" href="#-æ±ºç­–æ¨¹">ğŸ” æ±ºç­–æ¨¹</a></h3>
<pre><code>é–‹å§‹
  â”‚
  â”œâ”€ æ˜¯å¦éœ€è¦å…±äº«è³‡æ–™ï¼Ÿ
  â”‚   â”œâ”€ å¦ â†’ ç„¡éœ€é–ï¼ˆThread-Local Storageï¼‰
  â”‚   â””â”€ æ˜¯ â†“
  â”‚
  â”œâ”€ æ˜¯å¦ç‚º SPSC æ¨¡å¼ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ Lock-Free Queue
  â”‚   â””â”€ å¦ â†“
  â”‚
  â”œâ”€ è‡¨ç•Œå€æ˜¯å¦æ¥µçŸ­ï¼ˆ&lt; 100nsï¼‰ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ Spinlock / Atomic
  â”‚   â””â”€ å¦ â†“
  â”‚
  â”œâ”€ æ˜¯å¦è®€å¤šå¯«å°‘ï¼ˆè®€å¯«æ¯” &gt; 10:1ï¼‰ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ RWLock / Seqlock
  â”‚   â””â”€ å¦ â†“
  â”‚
  â”œâ”€ æ˜¯å¦éœ€è¦é™åˆ¶è³‡æºæ•¸é‡ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ Semaphore
  â”‚   â””â”€ å¦ â†“
  â”‚
  â”œâ”€ æ˜¯å¦éœ€è¦æ¢ä»¶ç­‰å¾…ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ Condition Variable
  â”‚   â””â”€ å¦ â†“
  â”‚
  â”œâ”€ æ˜¯å¦æœ‰éè¿´å‘¼å«ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ Recursive Mutex
  â”‚   â””â”€ å¦ â†“
  â”‚
  â””â”€ é è¨­é¸æ“‡ â†’ Mutex
</code></pre>
<h3 id="-å„ªåŒ–å»ºè­°"><a class="header" href="#-å„ªåŒ–å»ºè­°">âš¡ å„ªåŒ–å»ºè­°</a></h3>
<pre><code>1. æ¸›å°‘é–ç²’åº¦
   âŒ æ•´å€‹ç‰©ä»¶ä¸€å€‹å¤§é–
   âœ… ä¸åŒæ¬„ä½ç”¨ä¸åŒé–

2. é¿å…é–é †åºæ­»é–
   âŒ åŸ·è¡Œç·’ A: lock(L1) â†’ lock(L2)
      åŸ·è¡Œç·’ B: lock(L2) â†’ lock(L1)
   âœ… çµ±ä¸€é–é †åºï¼šéƒ½å…ˆ L1 å† L2

3. ä½¿ç”¨ RAII ç®¡ç†é–
   âŒ mutex.lock();
      do_something();
      mutex.unlock();  // å¯èƒ½å¿˜è¨˜
   âœ… std::lock_guard&lt;std::mutex&gt; lock(mutex);

4. è€ƒæ…®ç„¡é–æ›¿ä»£
   âŒ mutex + counter++
   âœ… std::atomic&lt;int&gt; counter;
      counter.fetch_add(1);

5. æ‰¹æ¬¡æ“ä½œæ¸›å°‘é–æ¬¡æ•¸
   âŒ for (item : items) {
        lock();
        process(item);
        unlock();
      }
   âœ… lock();
      for (item : items) {
        process(item);
      }
      unlock();
</code></pre>
<hr />
<h2 id="-ç¸½çµ"><a class="header" href="#-ç¸½çµ">ğŸ“ ç¸½çµ</a></h2>
<h3 id="å¿«é€Ÿè¨˜æ†¶å£è¨£"><a class="header" href="#å¿«é€Ÿè¨˜æ†¶å£è¨£">å¿«é€Ÿè¨˜æ†¶å£è¨£</a></h3>
<pre><code>ğŸš€ é€Ÿåº¦è¦æ±‚é«˜ï¼Ÿ        â†’ Lock-Free / Spinlock
ğŸ” ç°¡å–®äº’æ–¥å°±å¥½ï¼Ÿ      â†’ Mutex
ğŸ“– è®€å¤šå¯«å°‘ï¼Ÿ          â†’ RWLock / Seqlock
ğŸ” æœƒéè¿´å‘¼å«ï¼Ÿ        â†’ Recursive Mutex
â° éœ€è¦æ¢ä»¶ç­‰å¾…ï¼Ÿ      â†’ Condition Variable
ğŸ« é™åˆ¶è³‡æºæ•¸é‡ï¼Ÿ      â†’ Semaphore
ğŸš§ å¤šéšæ®µåŒæ­¥ï¼Ÿ        â†’ Barrier
</code></pre>
<h3 id="å¸¸è¦‹éŒ¯èª¤"><a class="header" href="#å¸¸è¦‹éŒ¯èª¤">å¸¸è¦‹éŒ¯èª¤</a></h3>
<pre><code>âŒ å¿˜è¨˜è§£é–               â†’ ä½¿ç”¨ RAII (lock_guard)
âŒ æ­»é–                   â†’ çµ±ä¸€é–é †åº
âŒ è™›å‡å–šé†’               â†’ Condition Variable ç”¨ while
âŒ éåº¦ä½¿ç”¨ Spinlock      â†’ é•·è‡¨ç•Œå€ç”¨ Mutex
âŒ å¿½ç•¥è¨˜æ†¶é«”é †åº         â†’ Atomic æ­£ç¢ºä½¿ç”¨ memory_order
</code></pre>
<hr />
<h2 id="-å»¶ä¼¸é–±è®€"><a class="header" href="#-å»¶ä¼¸é–±è®€">ğŸ“š å»¶ä¼¸é–±è®€</a></h2>
<ul>
<li><a href="https://www.manning.com/books/c-plus-plus-concurrency-in-action-second-edition">C++ Concurrency in Action (2nd Edition)</a></li>
<li><a href="https://www.elsevier.com/books/the-art-of-multiprocessor-programming/herlihy/978-0-12-415950-1">The Art of Multiprocessor Programming</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/locking/index.html">Linux Kernel Locking</a></li>
</ul>
<hr />
<p><strong>æ–‡ä»¶ç‰ˆæœ¬</strong>: 1.0<br />
<strong>æœ€å¾Œæ›´æ–°</strong>: 2026-01-09<br />
<strong>æˆæ¬Š</strong>: CC BY-NC-SA 4.0</p>
<hr />
<h2 id="é™„éŒ„å¯¦ç”¨ç¨‹å¼ç¢¼ç‰‡æ®µ"><a class="header" href="#é™„éŒ„å¯¦ç”¨ç¨‹å¼ç¢¼ç‰‡æ®µ">é™„éŒ„ï¼šå¯¦ç”¨ç¨‹å¼ç¢¼ç‰‡æ®µ</a></h2>
<h3 id="a1-ç°¡æ˜“æ•ˆèƒ½æ¸¬è©¦æ¡†æ¶"><a class="header" href="#a1-ç°¡æ˜“æ•ˆèƒ½æ¸¬è©¦æ¡†æ¶">A1. ç°¡æ˜“æ•ˆèƒ½æ¸¬è©¦æ¡†æ¶</a></h3>
<pre><code class="language-cpp">#include &lt;chrono&gt;
#include &lt;iostream&gt;

template&lt;typename Func&gt;
double benchmark(Func f, int iterations = 1000000) {
    auto start = std::chrono::high_resolution_clock::now();
    
    for (int i = 0; i &lt; iterations; ++i) {
        f();
    }
    
    auto end = std::chrono::high_resolution_clock::now();
    auto duration = std::chrono::duration_cast&lt;std::chrono::nanoseconds&gt;(end - start);
    
    return duration.count() / (double)iterations;
}

// ä½¿ç”¨ç¯„ä¾‹
int main() {
    std::mutex mutex;
    int counter = 0;
    
    double avg_ns = benchmark([&amp;] {
        std::lock_guard&lt;std::mutex&gt; lock(mutex);
        ++counter;
    });
    
    std::cout &lt;&lt; "å¹³å‡æ¯æ¬¡æ“ä½œ: " &lt;&lt; avg_ns &lt;&lt; " ns\n";
}
</code></pre>
<h3 id="a2-æ­»é–æª¢æ¸¬å™¨"><a class="header" href="#a2-æ­»é–æª¢æ¸¬å™¨">A2. æ­»é–æª¢æ¸¬å™¨</a></h3>
<pre><code class="language-cpp">#include &lt;map&gt;
#include &lt;thread&gt;
#include &lt;mutex&gt;

class DeadlockDetector {
    std::map&lt;std::thread::id, std::vector&lt;void*&gt;&gt; held_locks_;
    std::mutex detector_mutex_;
    
public:
    void acquire(void* lock) {
        std::lock_guard&lt;std::mutex&gt; guard(detector_mutex_);
        auto tid = std::this_thread::get_id();
        held_locks_[tid].push_back(lock);
        check_for_cycles(tid);
    }
    
    void release(void* lock) {
        std::lock_guard&lt;std::mutex&gt; guard(detector_mutex_);
        auto tid = std::this_thread::get_id();
        auto&amp; locks = held_locks_[tid];
        locks.erase(std::remove(locks.begin(), locks.end(), lock), locks.end());
    }
    
private:
    void check_for_cycles(std::thread::id tid) {
        // ç°¡åŒ–ç‰ˆï¼šæª¢æŸ¥æ˜¯å¦æœ‰åŸ·è¡Œç·’æŒæœ‰å¤šå€‹é–
        if (held_locks_[tid].size() &gt; 1) {
            std::cerr &lt;&lt; "è­¦å‘Šï¼šåŸ·è¡Œç·’æŒæœ‰å¤šå€‹é–ï¼Œå¯èƒ½æ­»é–ï¼\n";
        }
    }
};
</code></pre>
<hr />
<p>å¸Œæœ›é€™ä»½æŒ‡å—èƒ½å¹«åŠ©ä½ ç†è§£å„ç¨®é–æ©Ÿåˆ¶ï¼ğŸ“</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../c++/locks_guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../c++/é«˜æ€§èƒ½ç¨‹å¼è¨­è¨ˆå¯¦æˆ°.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../c++/locks_guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../c++/é«˜æ€§èƒ½ç¨‹å¼è¨­è¨ˆå¯¦æˆ°.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
