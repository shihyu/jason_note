#include <cstdio>
#include <cstdint>
#include <cstring>  // for std::memcpy
// #include <bit>   // for std::bit_cast (C++20)

int main()
{
    printf("=== ç¤ºç¯„ï¼šé•ååš´æ ¼åˆ¥åè¦å‰‡çš„éŒ¯èª¤åšæ³• ===\n");
    {
        double x = 100;
        const auto orig_x = x;

        // âŒ éŒ¯èª¤åšæ³•ï¼šä½¿ç”¨ C-style cast é€²è¡Œé¡å‹é›™é—œï¼ˆType Punningï¼‰
        // âš ï¸ é•ååš´æ ¼åˆ¥åè¦å‰‡ï¼ˆStrict Aliasing Ruleï¼‰
        // å•é¡Œï¼šä¸åŒé¡å‹çš„æŒ‡æ¨™ä¸æ‡‰æŒ‡å‘åŒä¸€è¨˜æ†¶é«”ï¼ˆæœƒå°è‡´æœªå®šç¾©è¡Œç‚ºï¼‰
        // å¾Œæœï¼šç·¨è­¯å™¨åŸºæ–¼åˆ¥åè¦å‰‡é€²è¡Œå„ªåŒ–ï¼Œå¯èƒ½å°‡ x å¿«å–åœ¨æš«å­˜å™¨ä¸­ï¼Œ
        //       å°è‡´ *x_as_ui çš„ä¿®æ”¹ä¸å¯è¦‹ï¼ˆx ä»é¡¯ç¤ºç‚º 100.00ï¼‰
        auto x_as_ui = (uint64_t*) (&x);
        *x_as_ui |= 0x8000000000000000;  // è©¦åœ–ä¿®æ”¹ double çš„ç¬¦è™Ÿä½

        printf("orig_x:%0.2f x:%0.2f &x:%p &x_as_ui:%p\n", orig_x, x, &x, x_as_ui);
        printf("âš ï¸  çµæœå¯èƒ½ç•°å¸¸ï¼ˆæœªå®šç¾©è¡Œç‚ºï¼‰\n\n");
    }

    printf("=== æ­£ç¢ºåšæ³• 1ï¼šä½¿ç”¨ std::memcpyï¼ˆC++11 æ¨è–¦ï¼‰===\n");
    {
        double x = 100.0;
        uint64_t x_bits;

        // âœ… æ­£ç¢ºï¼šä½¿ç”¨ memcpy é€²è¡Œä½å…ƒè¤‡è£½
        // âš¡ æ•ˆèƒ½ï¼šç·¨è­¯å™¨æœƒå°‡ memcpy å„ªåŒ–ç‚ºç›´æ¥çš„æš«å­˜å™¨æ“ä½œï¼ˆç„¡å‡½å¼å‘¼å«é–‹éŠ·ï¼‰
        // åŸç†ï¼šmemcpy åœ¨èªç¾©ä¸Šæ˜¯ã€Œè¤‡è£½ã€è€Œéã€Œåˆ¥åã€ï¼Œä¸é•ååš´æ ¼åˆ¥åè¦å‰‡
        std::memcpy(&x_bits, &x, sizeof(x));
        x_bits |= 0x8000000000000000;  // ä¿®æ”¹ç¬¦è™Ÿä½ï¼ˆè¨­ç‚ºè² æ•¸ï¼‰
        std::memcpy(&x, &x_bits, sizeof(x));

        printf("x after memcpy: %0.2f (ç¬¦è™Ÿä½å·²ä¿®æ”¹)\n\n", x);
    }

    printf("=== æ­£ç¢ºåšæ³• 2ï¼šä½¿ç”¨ unionï¼ˆC++11 å‰å¸¸ç”¨ï¼‰===\n");
    {
        double x = 100.0;

        // âœ… æ­£ç¢ºï¼šä½¿ç”¨ union é€²è¡Œé¡å‹é›™é—œ
        // âš ï¸  æ³¨æ„ï¼šC++11 å‰é€™æ˜¯å¸¸è¦‹åšæ³•ï¼Œä½†åœ¨ C++11 å¾Œè®€å–éæ´»èºæˆå“¡æ˜¯ UB
        //          å¯¦å‹™ä¸Šç·¨è­¯å™¨ä»æ™®éæ”¯æ´ï¼ˆGCC/Clang/MSVCï¼‰
        union {
            double d;
            uint64_t u;
        } converter;

        converter.d = x;
        converter.u |= 0x8000000000000000;  // ä¿®æ”¹ç¬¦è™Ÿä½
        x = converter.d;

        printf("x after union: %0.2f (ç¬¦è™Ÿä½å·²ä¿®æ”¹)\n\n", x);
    }

    printf("=== æ­£ç¢ºåšæ³• 3ï¼šä½¿ç”¨ std::bit_castï¼ˆC++20 æœ€ä½³ï¼‰===\n");
    {
        double x = 100.0;

        // âœ… æ­£ç¢ºï¼šä½¿ç”¨ std::bit_castï¼ˆC++20ï¼‰
        // âš¡ æ•ˆèƒ½ï¼šç·¨è­¯æœŸä¿è­‰ï¼Œé›¶åŸ·è¡ŒæœŸé–‹éŠ·
        // ğŸ¯ æœ€ä½³å¯¦è¸ï¼šC++20 å¾Œæ‡‰å„ªå…ˆä½¿ç”¨ bit_cast
        //
        // ç”±æ–¼æ­¤å°ˆæ¡ˆå¯èƒ½ä½¿ç”¨è¼ƒèˆŠçš„ C++ æ¨™æº–ï¼Œæ­¤è™•è¨»è§£å±•ç¤ºç”¨æ³•ï¼š
        // auto x_bits = std::bit_cast<uint64_t>(x);
        // x_bits |= 0x8000000000000000;
        // x = std::bit_cast<double>(x_bits);

        printf("std::bit_cast éœ€è¦ C++20ï¼ˆè¨»è§£ä¸­å±•ç¤ºç”¨æ³•ï¼‰\n\n");
    }

    printf("=== ç¸½çµï¼šåš´æ ¼åˆ¥åè¦å‰‡ (Strict Aliasing Rule) ===\n");
    printf("ğŸ“‹ è¦å‰‡ï¼šä¸åŒé¡å‹çš„æŒ‡æ¨™ä¸æ‡‰æŒ‡å‘åŒä¸€è¨˜æ†¶é«”\n");
    printf("âš¡ åŸå› ï¼šå…è¨±ç·¨è­¯å™¨å‡è¨­ä¸åŒé¡å‹çš„æŒ‡æ¨™ä¸æœƒäº’ç›¸å¹²æ“¾ï¼Œé€²è¡Œæ¿€é€²å„ªåŒ–\n");
    printf("âœ… æ¨è–¦é †åºï¼šbit_cast (C++20) > memcpy (C++11) > union (å‚³çµ±)\n");
}
