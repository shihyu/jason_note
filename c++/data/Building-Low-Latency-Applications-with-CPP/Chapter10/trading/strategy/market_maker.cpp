#include "market_maker.h"

#include "trade_engine.h"

namespace Trading
{
// MarketMaker å»ºæ§‹å­
//
// ç­–ç•¥åˆå§‹åŒ–æµç¨‹ï¼š
// 1. å„²å­˜æ ¸å¿ƒå…ƒä»¶åƒè€ƒï¼ˆFeatureEngine, OrderManager, é…ç½®ï¼‰
// 2. è¦†å¯« TradeEngine çš„ Lambda å›èª¿ï¼ˆç­–ç•¥ä¸»å‹•æ¬Šæ¨¡å¼ï¼‰
//
// è¨­è¨ˆæ¨¡å¼ï¼š
// - ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰ï¼šå°‡æ¼”ç®—æ³•å°è£æˆç¨ç«‹é¡åˆ¥
// - ä¾è³´æ³¨å…¥ï¼ˆDependency Injectionï¼‰ï¼šTradeEngine æä¾›åŸºç¤è¨­æ–½
// - Lambda å›èª¿ï¼ˆCallbackï¼‰ï¼šé¿å…è™›å‡½å¼ï¼Œå…§è¯å±•é–‹
//
// âš¡ æ•ˆèƒ½è€ƒé‡ï¼š
// - Lambda æ•ç² thisï¼šç·¨è­¯å™¨å…§è¯å±•é–‹ï¼Œé›¶è™›å‡½å¼é–‹éŠ·
// - ç­–ç•¥ä¸»å‹•æ¬Šï¼šç”±ç­–ç•¥æ±ºå®šå¦‚ä½•å›æ‡‰äº‹ä»¶ï¼ŒTradeEngine åƒ…åˆ†ç™¼
//
// åšå¸‚å•†ç­–ç•¥ç‰¹æ€§ï¼š
// - é›™é‚Šå ±åƒ¹ï¼šåœ¨è²·è³£å…©å´åŒæ™‚æ›å–®
// - è³ºå–åƒ¹å·®ï¼šè²·å…¥åƒ¹ < è³£å‡ºåƒ¹ï¼ˆBid-Ask Spreadï¼‰
// - é¢¨éšªä¸­æ€§ï¼šå¿«é€Ÿå¹³å€‰ï¼Œé¿å…æŒå€‰é¢¨éšª
//
// @param logger: æ—¥èªŒè¨˜éŒ„å™¨
// @param trade_engine: äº¤æ˜“å¼•æ“ï¼ˆæä¾›äº‹ä»¶åˆ†ç™¼ï¼‰
// @param feature_engine: ç‰¹å¾µå¼•æ“ï¼ˆå¸‚å ´åƒ¹æ ¼ã€æ¿€é€²æˆäº¤æ¯”ç‡ï¼‰
// @param order_manager: è¨‚å–®ç®¡ç†å™¨ï¼ˆè¨‚å–®ç‹€æ…‹æ©Ÿï¼‰
// @param ticker_cfg: äº¤æ˜“æ¨™çš„é…ç½®è¡¨ï¼ˆç­–ç•¥åƒæ•¸ï¼‰
MarketMaker::MarketMaker(Common::Logger* logger, TradeEngine* trade_engine,
                         const FeatureEngine* feature_engine,
                         OrderManager* order_manager, const TradeEngineCfgHashMap& ticker_cfg)
    : feature_engine_(feature_engine), order_manager_(order_manager),
      logger_(logger),
      ticker_cfg_(ticker_cfg)
{
    // è¦†å¯« TradeEngine çš„è¨‚å–®ç°¿æ›´æ–°å›èª¿
    // âš¡ Lambda æ•ç² thisï¼šæˆå“¡å‡½å¼æŒ‡æ¨™åŒ…è£
    //
    // ğŸ“Œ è¨­è¨ˆç†å¿µï¼šåšå¸‚å•†çš„æ ¸å¿ƒå›èª¿ï¼ˆæœ€é‡è¦çš„äº‹ä»¶è™•ç†ï¼‰
    // ç•¶è¨‚å–®ç°¿è®Šå‹•æ™‚ï¼ˆADD/MODIFY/CANCELï¼‰ï¼Œç«‹å³é‡æ–°è¨ˆç®—å ±åƒ¹
    //
    // ğŸ“Š åšå¸‚å•†æ ¸å¿ƒé‚è¼¯ï¼š
    // 1. å¾ FeatureEngine å–å¾—å¸‚å ´å…¬å…åƒ¹æ ¼ï¼ˆMarket Priceï¼‰
    // 2. è¨ˆç®—è²·è³£å ±åƒ¹ï¼š
    //    - Bid Price = Market Price - Spread/2
    //    - Ask Price = Market Price + Spread/2
    // 3. é€é OrderManager ç™¼é€é›™é‚Šé™åƒ¹å–®ï¼ˆLimit Orderï¼‰
    //
    // ğŸ“Š ç¯„ä¾‹ï¼š
    // - Market Price = 100.0, Spread = 0.1
    // - Bid = 99.95, Ask = 100.05
    // - å¦‚æœæˆäº¤è²·å…¥ 99.95ã€è³£å‡º 100.05ï¼Œè³ºå– 0.1 åƒ¹å·®
    //
    // âš¡ æ•ˆèƒ½è€ƒé‡ï¼šè¨‚å–®ç°¿æ¯æ¬¡è®Šå‹•éƒ½æœƒè§¸ç™¼ï¼Œæ˜¯æœ€é«˜é »çš„å›èª¿
    // âš ï¸ é¢¨éšªï¼šé »ç¹æ”¹å–®ï¼ˆOrder Amendï¼‰å¯èƒ½ç”¢ç”Ÿäº¤æ˜“æ‰€è²»ç”¨æˆ–è¢«é™æµ
    trade_engine->algoOnOrderBookUpdate_ = [this](auto ticker_id, auto price,
    auto side, auto book) {
        onOrderBookUpdate(ticker_id, price, side, book);
    };

    // è¦†å¯« TradeEngine çš„æˆäº¤äº‹ä»¶å›èª¿
    //
    // ğŸ“Œ è¨­è¨ˆç†å¿µï¼šåšå¸‚å•†é€šå¸¸ä¸é—œæ³¨æˆäº¤äº‹ä»¶ï¼ˆåªé—œæ³¨è¨‚å–®ç°¿åƒ¹ä½ï¼‰
    // åŸå› ï¼š
    // 1. åšå¸‚å•†æ¡ç”¨è¢«å‹•å ±åƒ¹ï¼ˆPassive Orderï¼‰ç­–ç•¥
    // 2. è¨‚å–®ç°¿è®Šå‹•å·²è¶³ä»¥è§¸ç™¼é‡æ–°å®šåƒ¹é‚è¼¯
    // 3. éåº¦é—œæ³¨æˆäº¤äº‹ä»¶æœƒå¢åŠ ä¸å¿…è¦çš„è¨ˆç®—è² æ“”
    //
    // ğŸ”® æœªä¾†æ“´å±•å¯èƒ½æ€§ï¼š
    // - æª¢æ¸¬å¤§é¡æˆäº¤ï¼ˆMarket Impactï¼‰â†’ èª¿æ•´ Spread æ“´å¤§é¢¨éšªç·©è¡
    // - çµ±è¨ˆæ¿€é€²äº¤æ˜“è€…è¡Œç‚º â†’ é æ¸¬çŸ­æœŸåƒ¹æ ¼æ–¹å‘
    // - ç›£æ§æˆäº¤é‡è®ŠåŒ– â†’ å‹•æ…‹èª¿æ•´å ±åƒ¹é »ç‡
    //
    // âš ï¸ æ³¨æ„ï¼šç›®å‰æ­¤å›èª¿åƒ…ç”¨æ–¼æ—¥èªŒè¨˜éŒ„ï¼Œä¸åŸ·è¡Œäº¤æ˜“é‚è¼¯
    trade_engine->algoOnTradeUpdate_ = [this](auto market_update, auto book) {
        onTradeUpdate(market_update, book);
    };

    // è¦†å¯« TradeEngine çš„è¨‚å–®å›æ‡‰å›èª¿
    //
    // ğŸ“Œ åŠŸèƒ½ï¼šè™•ç†è‡ªå·±ç™¼é€çš„è¨‚å–®ç‹€æ…‹è®ŠåŒ–é€šçŸ¥
    // è¨‚å–®ç”Ÿå‘½é€±æœŸäº‹ä»¶ï¼š
    // 1. ACCEPTEDï¼šè¨‚å–®è¢«äº¤æ˜“æ‰€æ¥å—ï¼ˆé€²å…¥æ’éšŠï¼Œç­‰å¾…æˆäº¤ï¼‰
    // 2. FILLEDï¼šè¨‚å–®å®Œå…¨æˆäº¤ï¼ˆæ›´æ–°å€‰ä½ã€è¨ˆç®— PnLã€ç«‹å³åå‘å ±åƒ¹ï¼‰
    // 3. PARTIALLY_FILLEDï¼šè¨‚å–®éƒ¨åˆ†æˆäº¤ï¼ˆå¯èƒ½éœ€è¦èª¿æ•´å‰©é¤˜è¨‚å–®ï¼‰
    // 4. CANCELLEDï¼šè¨‚å–®è¢«å–æ¶ˆï¼ˆé‡‹æ”¾è¨‚å–®è³‡æºï¼Œé‡æ–°è©•ä¼°æ˜¯å¦å ±åƒ¹ï¼‰
    // 5. REJECTEDï¼šè¨‚å–®è¢«æ‹’çµ•ï¼ˆé¢¨æ§å¤±æ•—ã€åƒ¹æ ¼åé›¢ç­‰ï¼‰
    //
    // ğŸ“Š åšå¸‚å•†ç‰¹åˆ¥æ³¨æ„ï¼š
    // - FILLED äº‹ä»¶æœ€é‡è¦ï¼šéœ€è¦ç«‹å³å¹³å€‰ä»¥ä¿æŒé¢¨éšªä¸­æ€§
    // - å¦‚æœ Bid å´æˆäº¤ï¼ˆè²·å…¥ï¼‰ï¼Œç«‹å³åœ¨ Ask å´æ›å–®è³£å‡º
    // - å¦‚æœ Ask å´æˆäº¤ï¼ˆè³£å‡ºï¼‰ï¼Œç«‹å³åœ¨ Bid å´æ›å–®è²·å…¥
    // - å¿«é€Ÿå¹³å€‰ï¼ˆInventory Managementï¼‰æ˜¯åšå¸‚å•†çš„æ ¸å¿ƒé¢¨æ§
    //
    // âš¡ æ•ˆèƒ½è€ƒé‡ï¼šå§”è¨—çµ¦ OrderManager è™•ç†ï¼Œé¿å…ç­–ç•¥å±¤é‡è¤‡é‚è¼¯
    // âš ï¸ é¢¨éšªï¼šå¦‚æœç„¡æ³•åŠæ™‚å¹³å€‰ï¼ŒæŒå€‰é¢¨éšªæœƒç´¯ç©ï¼ˆInventory Riskï¼‰
    trade_engine->algoOnOrderUpdate_ = [this](auto client_response) {
        onOrderUpdate(client_response);
    };
}
}
