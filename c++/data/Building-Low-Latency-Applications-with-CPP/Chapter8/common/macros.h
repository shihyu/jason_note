#pragma once

#include <cstring>
#include <iostream>

// ============================================================================
// ç·¨è­¯å™¨å„ªåŒ–å·¨é›† (Compiler Optimization Macros)
// ============================================================================

// åˆ†æ”¯é æ¸¬æç¤º (Branch Prediction Hints)
// âš¡ å‘Šè¨´ç·¨è­¯å™¨è©²åˆ†æ”¯ç™¼ç”Ÿçš„æ©Ÿç‡ï¼Œä»¥å„ªåŒ– CPU æŒ‡ä»¤ç®¡ç·š (Pipeline)
//
// LIKELY(x): x ç‚ºçœŸçš„æ©Ÿç‡å¾ˆé«˜ (å»ºè­° > 95%)
//   - ç·¨è­¯å™¨å°‡æ­¤åˆ†æ”¯ä»£ç¢¼ç·Šæ¥åœ¨åˆ¤æ–·æŒ‡ä»¤å¾Œ (Fall-through path)
//   - CPU åˆ†æ”¯é æ¸¬å™¨æœƒå„ªå…ˆå‡è¨­æ¢ä»¶ç‚ºçœŸ
//   - æ¸›å°‘æŒ‡ä»¤å¿«å–æœªå‘½ä¸­ (Instruction Cache Miss)
//
// UNLIKELY(x): x ç‚ºçœŸçš„æ©Ÿç‡å¾ˆä½ (å»ºè­° < 5%)
//   - ç·¨è­¯å™¨å°‡æ­¤åˆ†æ”¯ä»£ç¢¼æ”¾åˆ°è¼ƒé çš„ä½ç½® (Out-of-line)
//   - CPU åˆ†æ”¯é æ¸¬å™¨æœƒå„ªå…ˆå‡è¨­æ¢ä»¶ç‚ºå‡
//   - æé«˜ç†±è·¯å¾‘ (Hot Path) çš„æŒ‡ä»¤å¯†åº¦
//
// ğŸ”¬ å·¥ä½œåŸç†ï¼š
// 1. ç·¨è­¯å™¨å„ªåŒ–ï¼š
//    - èª¿æ•´åŸºæœ¬å¡Š (Basic Block) çš„æ’åˆ—é †åº
//    - å°‡å†·è·¯å¾‘ (Cold Path) ç§»åˆ°å‡½å¼å°¾éƒ¨
//    - æ¸›å°‘ç†±è·¯å¾‘ä¸­çš„è·³è½‰æŒ‡ä»¤
//
// 2. CPU åˆ†æ”¯é æ¸¬ï¼š
//    - éœæ…‹é æ¸¬ï¼šå„ªå…ˆåŸ·è¡Œé †åºè·¯å¾‘ (ä¸è·³è½‰)
//    - å‹•æ…‹é æ¸¬ï¼šæ ¹æ“šæ­·å²èª¿æ•´ (Branch Target Buffer)
//    - é æ¸¬å¤±æ•—æ‡²ç½°ï¼š10-20 å€‹æ™‚é˜é€±æœŸ (Pipeline Flush)
//
// âš ï¸ ä½¿ç”¨åŸå‰‡ï¼š
// 1. åƒ…ç”¨æ–¼é«˜åº¦ç¢ºå®šçš„åˆ†æ”¯ (éå¸¸åæ–œçš„æ©Ÿç‡åˆ†å¸ƒ)
//    âœ… æ­£ç¢ºä½¿ç”¨ï¼š
//    ```cpp
//    if (UNLIKELY(ptr == nullptr)) {          // 99.99% æƒ…æ³ä¸‹ä¸ç‚º null
//        handle_error();
//    }
//
//    if (UNLIKELY(error_code != 0)) {         // éŒ¯èª¤æ¥µå°‘ç™¼ç”Ÿ
//        log_error(error_code);
//    }
//
//    if (LIKELY(order_valid)) {               // çµ•å¤§å¤šæ•¸è¨‚å–®æ˜¯æœ‰æ•ˆçš„
//        process_order();
//    }
//    ```
//
//    âŒ éŒ¯èª¤ä½¿ç”¨ï¼š
//    ```cpp
//    if (LIKELY(price > 100)) {               // æ©Ÿç‡æœªçŸ¥ï¼Œä¸æ‡‰ä½¿ç”¨
//        // ...
//    }
//
//    if (UNLIKELY(count % 2 == 0)) {          // 50/50 æ©Ÿç‡ï¼ŒéŒ¯èª¤æç¤º
//        // ...
//    }
//
//    for (int i = 0; i < n; i++) {
//        if (LIKELY(data[i] > 0)) {           // è³‡æ–™ç›¸é—œï¼Œæ©Ÿç‡æœªçŸ¥
//            // ...
//        }
//    }
//    ```
//
// 2. éåº¦ä½¿ç”¨æœƒé™ä½æ•ˆèƒ½
//    - ç¾ä»£ CPU å·²æœ‰å„ªç§€çš„å‹•æ…‹åˆ†æ”¯é æ¸¬ (æº–ç¢ºç‡ > 95%)
//    - éŒ¯èª¤çš„éœæ…‹æç¤ºæœƒå¹²æ“¾å‹•æ…‹é æ¸¬
//    - åªåœ¨ç†±è·¯å¾‘ (Hot Path) çš„é—œéµåˆ†æ”¯ä½¿ç”¨
//
// 3. éŒ¯èª¤çš„æç¤ºæ¯”æ²’æœ‰æç¤ºæ›´ç³Ÿç³•
//    - æœƒå°è‡´ CPU ç®¡ç·šæ¸…ç©º (Pipeline Flush)
//    - å»¶é²å¯èƒ½å¢åŠ  10-20 å€‹æ™‚é˜é€±æœŸ
//    - ç¯„ä¾‹ï¼š
//      ```cpp
//      if (UNLIKELY(frequently_true_condition)) {  // éŒ¯èª¤ï¼
//          // å¯¦éš›ä¸Šé »ç¹åŸ·è¡Œçš„ä»£ç¢¼
//      }
//      // çµæœï¼šæ¯æ¬¡éƒ½é æ¸¬å¤±æ•—ï¼Œæ•ˆèƒ½ä¸‹é™
//      ```
//
// ğŸ“Š æ•ˆèƒ½åˆ†æå·¥å…· (æ¨è–¦ä½¿ç”¨å‰å…ˆæ¸¬é‡)ï¼š
// 1. perf åˆ†æåˆ†æ”¯é æ¸¬å¤±èª¤ç‡ï¼š
//    ```bash
//    # è¨˜éŒ„åˆ†æ”¯çµ±è¨ˆ
//    perf record -e branches,branch-misses ./your_app
//
//    # æŸ¥çœ‹å ±å‘Š
//    perf report
//
//    # æŸ¥çœ‹åˆ†æ”¯é æ¸¬å¤±èª¤ç‡
//    perf stat -e branches,branch-misses ./your_app
//    # è¼¸å‡ºç¯„ä¾‹ï¼š
//    #   1,234,567,890  branches
//    #      12,345,678  branch-misses  # 1.0% miss rate (å¾ˆå¥½)
//    ```
//
// 2. ä½¿ç”¨ perf annotate æŸ¥çœ‹å…·é«”åˆ†æ”¯ï¼š
//    ```bash
//    perf annotate -s your_function
//    ```
//    - é¡¯ç¤ºæ¯å€‹åˆ†æ”¯çš„é æ¸¬å¤±èª¤æ¬¡æ•¸
//    - æ‰¾å‡ºçœŸæ­£éœ€è¦å„ªåŒ–çš„ç†±é»
//
// 3. ç·¨è­¯å™¨ç”Ÿæˆçš„å½™ç·¨æª¢æŸ¥ï¼š
//    ```bash
//    g++ -S -O3 your_code.cpp
//    # æª¢æŸ¥ .s æª”æ¡ˆä¸­çš„è·³è½‰æŒ‡ä»¤æ’åˆ—
//    ```
//
// ğŸ“š ç¯„ä¾‹æ¯”è¼ƒï¼š
// ```cpp
// // ç„¡æç¤ºï¼ˆç·¨è­¯å™¨èˆ‡ CPU è‡ªè¡Œé æ¸¬ï¼‰
// if (error_code != 0) {
//     handle_error();
// }
//
// // æœ‰æç¤ºï¼ˆæ˜ç¢ºå‘ŠçŸ¥é€™æ˜¯ç½•è¦‹è·¯å¾‘ï¼‰
// if (UNLIKELY(error_code != 0)) {
//     handle_error();  // ä»£ç¢¼æœƒè¢«ç§»åˆ°å‡½å¼å°¾éƒ¨
// }
// ```
//
// ğŸ”§ æœ€ä½³å¯¦è¸ï¼š
// 1. å…ˆç”¨ perf æ¸¬é‡ï¼Œè­‰å¯¦åˆ†æ”¯é æ¸¬å¤±èª¤æ˜¯ç“¶é ¸
// 2. åªåœ¨ç†±è·¯å¾‘ (Hot Path) ä¸­ä½¿ç”¨
// 3. åˆ†æ”¯æ©Ÿç‡æ‡‰æ¥µåº¦åæ–œ (> 95% æˆ– < 5%)
// 4. å„ªå…ˆè€ƒæ…®å…¶ä»–å„ªåŒ– (æ¼”ç®—æ³•ã€è³‡æ–™çµæ§‹)
// 5. åŠ å…¥è¨»è§£èªªæ˜ç‚ºä½•ä½¿ç”¨ LIKELY/UNLIKELY
//
// ğŸ“Š æ•ˆèƒ½æ•¸æ“šåƒè€ƒï¼š
// - åˆ†æ”¯é æ¸¬æˆåŠŸï¼š0-1 å€‹æ™‚é˜é€±æœŸé–‹éŠ·
// - åˆ†æ”¯é æ¸¬å¤±æ•—ï¼š10-20 å€‹æ™‚é˜é€±æœŸæ‡²ç½°
// - ç¾ä»£ CPU å‹•æ…‹é æ¸¬æº–ç¢ºç‡ï¼š95-99%
// - éœæ…‹æç¤ºæ”¶ç›Šï¼šé€šå¸¸ < 5% (è‹¥å·²æœ‰é«˜æº–ç¢ºç‡)
// - éŒ¯èª¤æç¤ºæ‡²ç½°ï¼šå¯èƒ½é™ä½æ•ˆèƒ½ 10-30%
//
// âš ï¸ é‡è¦æé†’ï¼š
// - ä¸è¦çŒœæ¸¬åˆ†æ”¯æ©Ÿç‡ï¼Œæ‡‰ä½¿ç”¨ perf æ¸¬é‡
// - ä¸è¦åœ¨æ‰€æœ‰ if èªå¥éƒ½åŠ ä¸Š LIKELY/UNLIKELY
// - å„ªå…ˆå„ªåŒ–æ¼”ç®—æ³•ï¼Œåˆ†æ”¯é æ¸¬æ˜¯æœ€å¾Œæ‰‹æ®µ
// - ç¨‹å¼ç¢¼å¯è®€æ€§ > å¾®å¹…æ•ˆèƒ½æå‡
#define LIKELY(x) __builtin_expect(!!(x), 1)
#define UNLIKELY(x) __builtin_expect(!!(x), 0)

// æ–·è¨€æª¢æŸ¥ (Assertion Check)
// åƒ…åœ¨æ¢ä»¶å¤±æ•—æ™‚åŸ·è¡ŒéŒ¯èª¤è™•ç† (UNLIKELY)
inline auto ASSERT(bool cond, const std::string& msg) noexcept
{
    if (UNLIKELY(!cond)) {
        std::cerr << "ASSERT : " << msg << std::endl;

        exit(EXIT_FAILURE);
    }
}

// è‡´å‘½éŒ¯èª¤è™•ç† (Fatal Error Handling)
inline auto FATAL(const std::string& msg) noexcept
{
    std::cerr << "FATAL : " << msg << std::endl;

    exit(EXIT_FAILURE);
}
