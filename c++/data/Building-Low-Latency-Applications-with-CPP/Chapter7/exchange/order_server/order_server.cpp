#include "order_server.h"

namespace Exchange
{
// ============================================================================
// OrderServer å»ºæ§‹å­
// ============================================================================
//
// ğŸ“Œ åŠŸèƒ½ï¼šåˆå§‹åŒ–è¨‚å–®é–˜é“ä¼ºæœå™¨ï¼Œå»ºç«‹ TCP é€£ç·šèˆ‡è¨‚å–®åºåˆ—åŒ–æ©Ÿåˆ¶
//
// åˆå§‹åŒ–æµç¨‹ï¼š
// 1. å„²å­˜ç¶²è·¯ä»‹é¢èˆ‡é€£æ¥åŸ è³‡è¨Šï¼ˆiface_, port_ï¼‰
// 2. å„²å­˜å›æ‡‰ä½‡åˆ—æŒ‡æ¨™ï¼ˆoutgoing_responses_ï¼‰
// 3. å»ºç«‹æ—¥èªŒè¨˜éŒ„å™¨ï¼ˆ"exchange_order_server.log"ï¼‰
// 4. å»ºç«‹ TCP ä¼ºæœå™¨ï¼ˆtcp_server_ï¼‰
// 5. å»ºç«‹ FIFO åºåˆ—åŒ–å™¨ï¼ˆfifo_sequencer_ï¼‰
// 6. åˆå§‹åŒ–å®¢æˆ¶ç«¯è¿½è¹¤é™£åˆ—ï¼ˆåºåˆ—è™Ÿã€TCP Socketï¼‰
// 7. è¨»å†Š TCP å›èª¿å‡½å¼ï¼ˆrecvCallback, recvFinishedCallbackï¼‰
//
// âš¡ æ•ˆèƒ½è¨­è¨ˆï¼š
// - Lock-Free Queueï¼šé›¶é–å®šé€šè¨Šï¼ˆFIFO Sequencer â†’ MatchingEngineï¼‰
// - TCP ä¼ºæœå™¨ï¼šé«˜æ•ˆèƒ½éé˜»å¡ I/O
// - åºåˆ—è™Ÿè¿½è¹¤ï¼šæ¯å€‹å®¢æˆ¶ç«¯ç¨ç«‹è¨ˆæ•¸ï¼ˆé¿å…é‡è¤‡èˆ‡éºæ¼ï¼‰
//
// ğŸ”— æ¶æ§‹è¨­è¨ˆï¼š
// - tcp_server_ï¼šæ¥æ”¶å®¢æˆ¶ç«¯ TCP é€£ç·šèˆ‡è¨‚å–®è«‹æ±‚
// - fifo_sequencer_ï¼šç¢ºä¿è¨‚å–®æŒ‰åºåˆ—è™Ÿé †åºé€å…¥ MatchingEngine
// - outgoing_responses_ï¼šç™¼é€æ’®åˆå›æ‡‰çµ¦å®¢æˆ¶ç«¯ï¼ˆLock-Free Queueï¼‰
//
// ğŸ“Š è³‡æ–™æµå‘ï¼š
// Client â†’ [TCP] â†’ OrderServer â†’ [fifo_sequencer_] â†’ MatchingEngine
// MatchingEngine â†’ [outgoing_responses_] â†’ OrderServer â†’ [TCP] â†’ Client
//
// ğŸ” åºåˆ—è™Ÿç®¡ç†ï¼š
// - cid_next_outgoing_seq_num_ï¼šä¸‹ä¸€å€‹è¦ç™¼é€çµ¦å®¢æˆ¶ç«¯çš„åºåˆ—è™Ÿ
// - cid_next_exp_seq_num_ï¼šä¸‹ä¸€å€‹é æœŸå¾å®¢æˆ¶ç«¯æ¥æ”¶çš„åºåˆ—è™Ÿ
// - cid_tcp_socket_ï¼šå®¢æˆ¶ç«¯ ID èˆ‡ TCP Socket çš„å°æ‡‰è¡¨
//
// âš ï¸ æ³¨æ„äº‹é …ï¼š
// - client_requests Queue æŒ‡æ¨™å¿…é ˆåœ¨ç”Ÿå‘½é€±æœŸå…§æœ‰æ•ˆ
// - TCP å›èª¿å‡½å¼åœ¨ç¶²è·¯åŸ·è¡Œç·’ä¸­åŸ·è¡Œï¼ˆéœ€è€ƒæ…®åŸ·è¡Œç·’å®‰å…¨ï¼‰
// - æ‰€æœ‰é™£åˆ—åˆå§‹åŒ–ç‚º 1ï¼ˆåºåˆ—è™Ÿå¾ 1 é–‹å§‹ï¼‰
//
// @param client_requests: å®¢æˆ¶ç«¯è¨‚å–®è«‹æ±‚ä½‡åˆ—ï¼ˆè¼¸å‡ºåˆ° MatchingEngineï¼‰
// @param client_responses: æ’®åˆå›æ‡‰ä½‡åˆ—ï¼ˆè¼¸å…¥ï¼Œä¾†è‡ª MatchingEngineï¼‰
// @param iface: ç¶²è·¯ä»‹é¢åç¨±ï¼ˆä¾‹å¦‚ï¼š"eth0", "lo"ï¼‰
// @param port: TCP ç›£è½é€£æ¥åŸ ï¼ˆä¾‹å¦‚ï¼š12345ï¼‰
OrderServer::OrderServer(ClientRequestLFQueue* client_requests,
                         ClientResponseLFQueue* client_responses, const std::string& iface, int port)
    : iface_(iface), port_(port), outgoing_responses_(client_responses),
      logger_("exchange_order_server.log"),
      tcp_server_(logger_), fifo_sequencer_(client_requests, &logger_)
{
    // åˆå§‹åŒ–å®¢æˆ¶ç«¯è¿½è¹¤é™£åˆ—ï¼ˆæ‰€æœ‰å®¢æˆ¶ç«¯å¾åºåˆ—è™Ÿ 1 é–‹å§‹ï¼‰
    cid_next_outgoing_seq_num_.fill(1);  // ç™¼é€åºåˆ—è™Ÿåˆå§‹åŒ–ç‚º 1
    cid_next_exp_seq_num_.fill(1);        // é æœŸæ¥æ”¶åºåˆ—è™Ÿåˆå§‹åŒ–ç‚º 1
    cid_tcp_socket_.fill(nullptr);        // TCP Socket åˆå§‹åŒ–ç‚ºç©º

    // è¨»å†Š TCP æ¥æ”¶å›èª¿ï¼šè™•ç†å®¢æˆ¶ç«¯è¨‚å–®è«‹æ±‚
    // âš¡ Lambda æ•ç²ï¼š[this] æ•ç²ç•¶å‰ OrderServer ç‰©ä»¶æŒ‡æ¨™
    tcp_server_.recv_callback_ = [this](auto socket, auto rx_time) {
        recvCallback(socket, rx_time);
    };

    // è¨»å†Š TCP æ¥æ”¶å®Œæˆå›èª¿ï¼šè™•ç†å¾…ç™¼é€çš„å›æ‡‰
    // ğŸ“Š æ™‚æ©Ÿï¼šæ¯æ¬¡ epoll_wait è™•ç†å®Œæ‰€æœ‰æ¥æ”¶äº‹ä»¶å¾Œå‘¼å«
    tcp_server_.recv_finished_callback_ = [this]() {
        recvFinishedCallback();
    };
}

// ============================================================================
// OrderServer è§£æ§‹å­
// ============================================================================
//
// ğŸ“Œ åŠŸèƒ½ï¼šå„ªé›…é—œé–‰è¨‚å–®é–˜é“ä¼ºæœå™¨ï¼Œé‡‹æ”¾æ‰€æœ‰è³‡æº
//
// æ¸…ç†æµç¨‹ï¼ˆé †åºå¾ˆé‡è¦ï¼‰ï¼š
// 1. å‘¼å« stop()ï¼ˆè¨­ç½® run_ = falseï¼Œåœæ­¢äº‹ä»¶è¿´åœˆï¼‰
// 2. ç­‰å¾… 1 ç§’ï¼ˆç¢ºä¿äº‹ä»¶è¿´åœˆå®Œå…¨é€€å‡ºï¼‰
//
// âš¡ ç‚ºä»€éº¼è¦ç­‰å¾… 1 ç§’ï¼Ÿ
// - äº‹ä»¶è¿´åœˆåŸ·è¡Œç·’ï¼ˆrun() è¿´åœˆï¼‰éœ€è¦æ™‚é–“æª¢æŸ¥ run_ ä¸¦é€€å‡º
// - TCP é€£ç·šå¯èƒ½é‚„åœ¨è™•ç†æœ€å¾Œä¸€æ‰¹è¨‚å–®
// - 1 ç§’æ˜¯ä¿å®ˆä¼°è¨ˆï¼ˆå¯¦éš›ç´„ 10-100 msï¼‰
//
// ğŸ”— é—œé–‰é †åºä¾è³´ï¼š
// 1. run_ = false â†’ äº‹ä»¶è¿´åœˆåœæ­¢è™•ç†æ–°è«‹æ±‚
// 2. sleep_for(1s) â†’ ç­‰å¾…ç•¶å‰è™•ç†ä¸­çš„è¨‚å–®èˆ‡å›æ‡‰å®Œæˆ
// 3. TCP ä¼ºæœå™¨è‡ªå‹•é—œé–‰æ‰€æœ‰é€£ç·šï¼ˆtcp_server_ è§£æ§‹å­ï¼‰
// 4. FIFO Sequencer é‡‹æ”¾è³‡æºï¼ˆfifo_sequencer_ è§£æ§‹å­ï¼‰
//
// âš ï¸ è³‡æºé‡‹æ”¾è€ƒé‡ï¼š
// - TCP Socket æœƒåœ¨ tcp_server_ è§£æ§‹æ™‚è‡ªå‹•é—œé–‰
// - Queue æœ¬èº«ä¸ç”± OrderServer ç®¡ç†ï¼ˆåªæ˜¯æŒ‡æ¨™ï¼‰
// - Logger æœƒè‡ªå‹•åˆ·æ–°ç·©è¡å€ä¸¦é—œé–‰æª”æ¡ˆ
//
// ğŸ“Š å¯¦éš›é—œé–‰æ™‚é–“ï¼š
// - stop() è¨­å®šæ——æ¨™ï¼š< 1 ns
// - ç­‰å¾…åŸ·è¡Œç·’é€€å‡ºï¼š~10-100 msï¼ˆè¦–æœ€å¾Œè™•ç†çš„è¨‚å–®ï¼‰
// - TCP é—œé–‰ï¼š~1-10 msï¼ˆè¦–é€£ç·šæ•¸é‡ï¼‰
// - ç¸½è¨ˆï¼šç´„ 10-100 msï¼ˆä¸å«å¼·åˆ¶ sleep çš„ 1 ç§’ï¼‰
OrderServer::~OrderServer()
{
    // 1. åœæ­¢äº‹ä»¶è¿´åœˆ
    stop();

    // 2. ç­‰å¾…åŸ·è¡Œç·’å®Œå…¨é€€å‡ºï¼ˆé¿å… use-after-freeï¼‰
    using namespace std::literals::chrono_literals;
    std::this_thread::sleep_for(1s);

    // 3. å…¶ä»–è³‡æºç”±æˆå“¡è®Šæ•¸çš„è§£æ§‹å­è‡ªå‹•é‡‹æ”¾
    // - tcp_server_ æœƒé—œé–‰æ‰€æœ‰ TCP é€£ç·š
    // - fifo_sequencer_ æœƒé‡‹æ”¾å…§éƒ¨è³‡æº
    // - logger_ æœƒåˆ·æ–°ç·©è¡å€ä¸¦é—œé–‰æª”æ¡ˆ
}

// ============================================================================
// start() - å•Ÿå‹•è¨‚å–®é–˜é“ä¼ºæœå™¨
// ============================================================================
//
// ğŸ“Œ åŠŸèƒ½ï¼šå•Ÿå‹• TCP ç›£è½ï¼Œå»ºç«‹å°ˆå±¬åŸ·è¡Œç·’åŸ·è¡Œäº‹ä»¶è¿´åœˆ
//
// åŸ·è¡Œæµç¨‹ï¼š
// 1. è¨­ç½® run_ = trueï¼ˆå•Ÿç”¨äº‹ä»¶è¿´åœˆï¼‰
// 2. å•Ÿå‹• TCP ä¼ºæœå™¨ç›£è½ï¼ˆbind + listenï¼‰
// 3. å»ºç«‹å°ˆå±¬åŸ·è¡Œç·’ï¼ŒåŸ·è¡Œ run() æ–¹æ³•
// 4. è¨­ç½®åŸ·è¡Œç·’åç¨±ç‚º "Exchange/OrderServer"
// 5. é©—è­‰åŸ·è¡Œç·’å»ºç«‹æˆåŠŸï¼ˆASSERTï¼‰
//
// âš¡ æ•ˆèƒ½è¨­è¨ˆï¼š
// - CPU affinity = -1ï¼šä¸ç¶å®š CPUï¼ˆç”± OS èª¿åº¦ï¼‰
// - TCP éé˜»å¡ I/Oï¼šä½¿ç”¨ epollï¼ˆLinuxï¼‰é«˜æ•ˆè™•ç†å¤šé€£ç·š
// - å°ˆå±¬åŸ·è¡Œç·’ï¼šé¿å…èˆ‡ MatchingEngine ç«¶çˆ­ CPU
//
// ğŸ”— åŸ·è¡Œç·’è¨­è¨ˆï¼š
// - createAndStartThread()ï¼šå°è£ pthread_create + CPU affinity è¨­å®š
// - run() æ–¹æ³•ï¼šç„¡é™è¿´åœˆè™•ç† TCP æ¥æ”¶èˆ‡å›æ‡‰ç™¼é€
// - run_ = false æ™‚è·³å‡ºè¿´åœˆ
//
// ğŸ“Š TCP ç›£è½è¨­å®šï¼š
// - iface_ï¼šç¶²è·¯ä»‹é¢ï¼ˆä¾‹å¦‚ï¼š"eth0" æˆ– "lo"ï¼‰
// - port_ï¼šç›£è½é€£æ¥åŸ ï¼ˆä¾‹å¦‚ï¼š12345ï¼‰
// - Backlogï¼šé è¨­å€¼ï¼ˆé€šå¸¸ 128ï¼‰
//
// âš ï¸ æ³¨æ„äº‹é …ï¼š
// - å¿…é ˆåœ¨å»ºæ§‹å®Œæˆå¾Œæ‰èƒ½å‘¼å«ï¼ˆå»ºæ§‹ä¸­å‘¼å«å¯èƒ½é€ æˆæœªå®šç¾©è¡Œç‚ºï¼‰
// - TCP listen å¤±æ•—æœƒæ‹‹å‡ºä¾‹å¤–ï¼ˆéœ€ç¢ºä¿ port æœªè¢«å ç”¨ï¼‰
// - ASSERT å¤±æ•—æœƒçµ‚æ­¢ç¨‹å¼ï¼ˆç”Ÿç”¢ç’°å¢ƒæ‡‰è€ƒæ…®éŒ¯èª¤è™•ç†ï¼‰
//
// ğŸ“Š ä½¿ç”¨å ´æ™¯ï¼š
// - OrderServer ä¸»ç¨‹å¼åˆå§‹åŒ–æµç¨‹ä¸­å‘¼å«
// - å–®æ¬¡å‘¼å«ï¼Œä¼ºæœå™¨ç”Ÿå‘½é€±æœŸå…§æŒçºŒåŸ·è¡Œ
auto OrderServer::start() -> void
{
    // 1. å•Ÿç”¨äº‹ä»¶è¿´åœˆæ——æ¨™
    run_ = true;

    // 2. å•Ÿå‹• TCP ä¼ºæœå™¨ç›£è½ï¼ˆbind + listenï¼‰
    // iface_ï¼šç¶²è·¯ä»‹é¢åç¨±ï¼ˆä¾‹å¦‚ï¼š"eth0", "lo"ï¼‰
    // port_ï¼šç›£è½é€£æ¥åŸ ï¼ˆä¾‹å¦‚ï¼š12345ï¼‰
    tcp_server_.listen(iface_, port_);

    // 3. å»ºç«‹å°ˆå±¬åŸ·è¡Œç·’åŸ·è¡Œ run() äº‹ä»¶è¿´åœˆ
    // -1ï¼šä¸ç¶å®šç‰¹å®š CPUï¼ˆç”± OS èª¿åº¦ï¼‰
    // "Exchange/OrderServer"ï¼šåŸ·è¡Œç·’åç¨±ï¼ˆä¾¿æ–¼é™¤éŒ¯ï¼‰
    ASSERT(Common::createAndStartThread(-1, "Exchange/OrderServer", [this]() {
        run();
    }) != nullptr, "Failed to start OrderServer thread.");
}

// ============================================================================
// stop() - åœæ­¢è¨‚å–®é–˜é“ä¼ºæœå™¨
// ============================================================================
//
// ğŸ“Œ åŠŸèƒ½ï¼šè¨­ç½®åœæ­¢æ——æ¨™ï¼Œé€šçŸ¥äº‹ä»¶è¿´åœˆé€€å‡º
//
// åŸ·è¡Œæµç¨‹ï¼š
// 1. è¨­ç½® run_ = false
// 2. run() è¿´åœˆåœ¨ä¸‹ä¸€æ¬¡æª¢æŸ¥æ™‚æœƒè·³å‡º
// 3. åŸ·è¡Œç·’è‡ªç„¶çµ‚æ­¢
//
// âš¡ æ•ˆèƒ½ç‰¹æ€§ï¼š
// - éåŒæ­¥åœæ­¢ï¼šä¸é˜»å¡ç•¶å‰åŸ·è¡Œç·’
// - å„ªé›…é—œé–‰ï¼šç­‰å¾…ç•¶å‰è™•ç†ä¸­çš„è¨‚å–®èˆ‡å›æ‡‰å®Œæˆ
// - ç„¡é–æ“ä½œï¼šrun_ æ˜¯ std::atomic<bool>
//
// âš ï¸ æ³¨æ„äº‹é …ï¼š
// - stop() åªæ˜¯è¨­ç½®æ——æ¨™ï¼Œä¸ä¿è­‰ç«‹åˆ»åœæ­¢
// - è§£æ§‹å­æœƒ sleep_for(1s) ç¢ºä¿åŸ·è¡Œç·’é€€å‡º
// - å¤šæ¬¡å‘¼å« stop() ç„¡å®³ï¼ˆå†ªç­‰æ“ä½œï¼‰
// - TCP é€£ç·šä¸æœƒç«‹åˆ»é—œé–‰ï¼ˆç”± run() è¿´åœˆé€€å‡ºå¾Œæ‰é—œé–‰ï¼‰
//
// ğŸ“Š å¯¦éš›åœæ­¢æ™‚é–“ï¼š
// - run_ è¨­å®šï¼š< 1 nsï¼ˆåŸå­æ“ä½œï¼‰
// - åŸ·è¡Œç·’é€€å‡ºï¼š~10-100 msï¼ˆè¦–ç•¶å‰è™•ç†çš„è¨‚å–®ï¼‰
// - TCP é—œé–‰ï¼š~1-10 msï¼ˆåœ¨è§£æ§‹å­ä¸­å®Œæˆï¼‰
auto OrderServer::stop() -> void
{
    // è¨­ç½®åœæ­¢æ——æ¨™ï¼ˆrun() è¿´åœˆæœƒæª¢æŸ¥æ­¤æ——æ¨™ä¸¦é€€å‡ºï¼‰
    run_ = false;
}
}
