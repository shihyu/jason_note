<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>HFT FPGA 模擬實作指南 - Jason Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="fpga-高頻交易模擬測試範例"><a class="header" href="#fpga-高頻交易模擬測試範例">FPGA 高頻交易模擬測試範例</a></h1>
<blockquote>
<p><strong>實測驗證</strong>: 本範例已在 Ubuntu 系統上使用 Verilator 5.040 實際測試通過
<strong>測試目錄</strong>: <code>/home/shihyu/github/jason_note/src/embedded_systems/src/hft_fpga_simulation</code>
<strong>最後更新</strong>: 2025-09-28</p>
</blockquote>
<h2 id="1-簡單的訂單匹配引擎-verilog"><a class="header" href="#1-簡單的訂單匹配引擎-verilog">1. 簡單的訂單匹配引擎 (Verilog)</a></h2>
<h3 id="order_matcherv---基本訂單匹配邏輯"><a class="header" href="#order_matcherv---基本訂單匹配邏輯">order_matcher.v - 基本訂單匹配邏輯</a></h3>
<pre><code class="language-verilog">// 簡化的訂單匹配引擎
module order_matcher #(
    parameter PRICE_WIDTH = 32,
    parameter QTY_WIDTH = 16,
    parameter ID_WIDTH = 16
)(
    input wire clk,
    input wire rst,
    
    // 新訂單輸入
    input wire order_valid,
    input wire order_is_buy,  // 1=買單, 0=賣單
    input wire [PRICE_WIDTH-1:0] order_price,
    input wire [QTY_WIDTH-1:0] order_qty,
    input wire [ID_WIDTH-1:0] order_id,
    
    // 匹配輸出
    output reg match_valid,
    output reg [ID_WIDTH-1:0] match_buy_id,
    output reg [ID_WIDTH-1:0] match_sell_id,
    output reg [PRICE_WIDTH-1:0] match_price,
    output reg [QTY_WIDTH-1:0] match_qty,
    
    // 性能計數器
    output reg [31:0] total_orders,
    output reg [31:0] total_matches,
    output reg [31:0] cycle_counter
);

    // 簡化的訂單簿（實際應該用 CAM 或更複雜的結構）
    reg [PRICE_WIDTH-1:0] best_bid_price;
    reg [QTY_WIDTH-1:0] best_bid_qty;
    reg [ID_WIDTH-1:0] best_bid_id;
    reg bid_valid;
    
    reg [PRICE_WIDTH-1:0] best_ask_price;
    reg [QTY_WIDTH-1:0] best_ask_qty;
    reg [ID_WIDTH-1:0] best_ask_id;
    reg ask_valid;
    
    // 延遲計數（模擬處理延遲）
    reg [7:0] processing_cycles;
    
    always @(posedge clk) begin
        if (rst) begin
            match_valid &lt;= 0;
            bid_valid &lt;= 0;
            ask_valid &lt;= 0;
            total_orders &lt;= 0;
            total_matches &lt;= 0;
            cycle_counter &lt;= 0;
            processing_cycles &lt;= 0;
        end else begin
            cycle_counter &lt;= cycle_counter + 1;
            match_valid &lt;= 0;
            
            if (order_valid) begin
                total_orders &lt;= total_orders + 1;
                processing_cycles &lt;= processing_cycles + 1;
                
                if (order_is_buy) begin
                    // 買單邏輯
                    if (ask_valid &amp;&amp; order_price &gt;= best_ask_price) begin
                        // 匹配成功
                        match_valid &lt;= 1;
                        match_buy_id &lt;= order_id;
                        match_sell_id &lt;= best_ask_id;
                        match_price &lt;= best_ask_price;
                        match_qty &lt;= (order_qty &lt; best_ask_qty) ? order_qty : best_ask_qty;
                        total_matches &lt;= total_matches + 1;
                        
                        // 更新訂單簿
                        if (order_qty &gt;= best_ask_qty) begin
                            ask_valid &lt;= 0;
                        end else begin
                            best_ask_qty &lt;= best_ask_qty - order_qty;
                        end
                    end else begin
                        // 加入訂單簿
                        if (!bid_valid || order_price &gt; best_bid_price) begin
                            best_bid_price &lt;= order_price;
                            best_bid_qty &lt;= order_qty;
                            best_bid_id &lt;= order_id;
                            bid_valid &lt;= 1;
                        end
                    end
                end else begin
                    // 賣單邏輯
                    if (bid_valid &amp;&amp; order_price &lt;= best_bid_price) begin
                        // 匹配成功
                        match_valid &lt;= 1;
                        match_buy_id &lt;= best_bid_id;
                        match_sell_id &lt;= order_id;
                        match_price &lt;= best_bid_price;
                        match_qty &lt;= (order_qty &lt; best_bid_qty) ? order_qty : best_bid_qty;
                        total_matches &lt;= total_matches + 1;
                        
                        // 更新訂單簿
                        if (order_qty &gt;= best_bid_qty) begin
                            bid_valid &lt;= 0;
                        end else begin
                            best_bid_qty &lt;= best_bid_qty - order_qty;
                        end
                    end else begin
                        // 加入訂單簿
                        if (!ask_valid || order_price &lt; best_ask_price) begin
                            best_ask_price &lt;= order_price;
                            best_ask_qty &lt;= order_qty;
                            best_ask_id &lt;= order_id;
                            ask_valid &lt;= 1;
                        end
                    end
                end
            end
        end
    end

endmodule
</code></pre>
<h3 id="market_data_decoderv---市場數據解碼器"><a class="header" href="#market_data_decoderv---市場數據解碼器">market_data_decoder.v - 市場數據解碼器</a></h3>
<pre><code class="language-verilog">// 簡化的市場數據解碼器（模擬 ITCH 協議）
module market_data_decoder (
    input wire clk,
    input wire rst,
    
    // 輸入數據流
    input wire [7:0] data_in,
    input wire data_valid,
    
    // 解碼輸出
    output reg msg_valid,
    output reg [7:0] msg_type,
    output reg [31:0] timestamp,
    output reg [31:0] price,
    output reg [15:0] quantity,
    output reg [15:0] order_id,
    
    // 性能指標
    output reg [31:0] messages_decoded,
    output reg [31:0] decode_cycles
);

    // 狀態機
    localparam IDLE = 0, HEADER = 1, PAYLOAD = 2;
    reg [1:0] state;
    reg [7:0] byte_counter;
    reg [255:0] buffer;  // 訊息緩衝區
    
    always @(posedge clk) begin
        if (rst) begin
            state &lt;= IDLE;
            msg_valid &lt;= 0;
            messages_decoded &lt;= 0;
            decode_cycles &lt;= 0;
        end else begin
            decode_cycles &lt;= decode_cycles + 1;
            msg_valid &lt;= 0;
            
            case (state)
                IDLE: begin
                    if (data_valid) begin
                        buffer[7:0] &lt;= data_in;
                        byte_counter &lt;= 1;
                        state &lt;= HEADER;
                    end
                end
                
                HEADER: begin
                    if (data_valid) begin
                        buffer[byte_counter*8 +: 8] &lt;= data_in;
                        byte_counter &lt;= byte_counter + 1;
                        
                        if (byte_counter &gt;= 4) begin  // 假設固定長度標頭
                            msg_type &lt;= buffer[7:0];
                            timestamp &lt;= buffer[39:8];
                            state &lt;= PAYLOAD;
                        end
                    end
                end
                
                PAYLOAD: begin
                    if (data_valid) begin
                        buffer[byte_counter*8 +: 8] &lt;= data_in;
                        byte_counter &lt;= byte_counter + 1;
                        
                        if (byte_counter &gt;= 16) begin  // 假設固定長度訊息
                            price &lt;= buffer[71:40];
                            quantity &lt;= buffer[87:72];
                            order_id &lt;= buffer[103:88];
                            msg_valid &lt;= 1;
                            messages_decoded &lt;= messages_decoded + 1;
                            state &lt;= IDLE;
                        end
                    end
                end
            endcase
        end
    end

endmodule
</code></pre>
<h2 id="2-c-測試平台"><a class="header" href="#2-c-測試平台">2. C++ 測試平台</a></h2>
<h3 id="tb_hft_systemcpp---高頻交易系統測試"><a class="header" href="#tb_hft_systemcpp---高頻交易系統測試">tb_hft_system.cpp - 高頻交易系統測試</a></h3>
<pre><code class="language-cpp">#include &lt;verilated.h&gt;
#include &lt;verilated_vcd_c.h&gt;
#include "Vorder_matcher.h"
#include &lt;iostream&gt;
#include &lt;fstream&gt;
#include &lt;vector&gt;
#include &lt;chrono&gt;
#include &lt;random&gt;

class HFTSimulator {
private:
    Vorder_matcher* dut;
    VerilatedVcdC* tfp;
    vluint64_t sim_time;
    
    // 性能統計
    struct Stats {
        uint64_t total_orders = 0;
        uint64_t total_matches = 0;
        uint64_t total_cycles = 0;
        double avg_latency = 0;
        std::vector&lt;uint32_t&gt; latency_histogram;
    } stats;
    
    // 測試數據
    struct Order {
        bool is_buy;
        uint32_t price;
        uint16_t quantity;
        uint16_t id;
        uint64_t timestamp;
    };
    
    std::vector&lt;Order&gt; test_orders;
    std::mt19937 rng;
    
public:
    HFTSimulator() : sim_time(0), rng(std::chrono::steady_clock::now().time_since_epoch().count()) {
        dut = new Vorder_matcher;
        
        // 設置波形追蹤
        Verilated::traceEverOn(true);
        tfp = new VerilatedVcdC;
        dut-&gt;trace(tfp, 99);
        tfp-&gt;open("hft_simulation.vcd");
        
        // 初始化
        dut-&gt;clk = 0;
        dut-&gt;rst = 1;
        dut-&gt;order_valid = 0;
    }
    
    ~HFTSimulator() {
        tfp-&gt;close();
        delete tfp;
        delete dut;
    }
    
    // 生成測試訂單
    void generateTestOrders(size_t count) {
        std::uniform_int_distribution&lt;&gt; price_dist(9900, 10100);  // 價格範圍
        std::uniform_int_distribution&lt;&gt; qty_dist(100, 1000);       // 數量範圍
        std::bernoulli_distribution buy_dist(0.5);                 // 買賣機率
        
        for (size_t i = 0; i &lt; count; i++) {
            Order order;
            order.is_buy = buy_dist(rng);
            order.price = price_dist(rng);
            order.quantity = qty_dist(rng);
            order.id = i;
            order.timestamp = sim_time;
            test_orders.push_back(order);
        }
        
        std::cout &lt;&lt; "Generated " &lt;&lt; count &lt;&lt; " test orders" &lt;&lt; std::endl;
    }
    
    // 載入歷史市場數據
    void loadMarketData(const std::string&amp; filename) {
        std::ifstream file(filename);
        if (!file.is_open()) {
            std::cerr &lt;&lt; "Cannot open market data file: " &lt;&lt; filename &lt;&lt; std::endl;
            return;
        }
        
        std::string line;
        while (std::getline(file, line)) {
            // 解析市場數據格式（CSV）
            // timestamp,side,price,quantity
            // 實作省略
        }
    }
    
    // 運行單一時鐘週期
    void tick() {
        dut-&gt;clk = 0;
        dut-&gt;eval();
        tfp-&gt;dump(sim_time++);
        
        dut-&gt;clk = 1;
        dut-&gt;eval();
        tfp-&gt;dump(sim_time++);
    }
    
    // 送出訂單
    void sendOrder(const Order&amp; order) {
        dut-&gt;order_valid = 1;
        dut-&gt;order_is_buy = order.is_buy;
        dut-&gt;order_price = order.price;
        dut-&gt;order_qty = order.quantity;
        dut-&gt;order_id = order.id;
        
        tick();
        
        dut-&gt;order_valid = 0;
        
        // 等待處理
        for (int i = 0; i &lt; 5; i++) {
            tick();
            if (dut-&gt;match_valid) {
                stats.total_matches++;
                uint32_t latency = sim_time - order.timestamp;
                if (latency &lt; stats.latency_histogram.size()) {
                    stats.latency_histogram[latency]++;
                }
                break;
            }
        }
    }
    
    // 運行模擬
    void runSimulation() {
        std::cout &lt;&lt; "\n=== Starting HFT Simulation ===" &lt;&lt; std::endl;
        
        // Reset
        dut-&gt;rst = 1;
        for (int i = 0; i &lt; 10; i++) tick();
        dut-&gt;rst = 0;
        
        // 記錄開始時間
        auto start_time = std::chrono::high_resolution_clock::now();
        
        // 送出所有測試訂單
        for (const auto&amp; order : test_orders) {
            sendOrder(order);
            
            // 模擬訂單間隔（微秒級）
            for (int i = 0; i &lt; 10; i++) tick();
        }
        
        // 記錄結束時間
        auto end_time = std::chrono::high_resolution_clock::now();
        auto duration = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(end_time - start_time);
        
        // 收集統計資料
        stats.total_orders = dut-&gt;total_orders;
        stats.total_matches = dut-&gt;total_matches;
        stats.total_cycles = dut-&gt;cycle_counter;
        
        // 輸出結果
        printResults(duration.count());
    }
    
    // 輸出結果
    void printResults(long long sim_duration_ms) {
        std::cout &lt;&lt; "\n=== Simulation Results ===" &lt;&lt; std::endl;
        std::cout &lt;&lt; "Simulation duration: " &lt;&lt; sim_duration_ms &lt;&lt; " ms" &lt;&lt; std::endl;
        std::cout &lt;&lt; "Total orders processed: " &lt;&lt; stats.total_orders &lt;&lt; std::endl;
        std::cout &lt;&lt; "Total matches: " &lt;&lt; stats.total_matches &lt;&lt; std::endl;
        std::cout &lt;&lt; "Match rate: " &lt;&lt; (100.0 * stats.total_matches / stats.total_orders) &lt;&lt; "%" &lt;&lt; std::endl;
        std::cout &lt;&lt; "Total cycles: " &lt;&lt; stats.total_cycles &lt;&lt; std::endl;
        
        // 假設 FPGA 運行在 200 MHz
        double fpga_freq = 200e6;  // Hz
        double fpga_time = stats.total_cycles / fpga_freq;
        std::cout &lt;&lt; "\nEstimated FPGA execution time: " &lt;&lt; (fpga_time * 1e6) &lt;&lt; " μs" &lt;&lt; std::endl;
        std::cout &lt;&lt; "Estimated throughput: " &lt;&lt; (stats.total_orders / fpga_time / 1e6) &lt;&lt; " M orders/sec" &lt;&lt; std::endl;
        
        // 延遲分析
        if (stats.total_matches &gt; 0) {
            double avg_match_cycles = (double)stats.total_cycles / stats.total_matches;
            double avg_latency_ns = avg_match_cycles * (1e9 / fpga_freq);
            std::cout &lt;&lt; "Average match latency: " &lt;&lt; avg_latency_ns &lt;&lt; " ns" &lt;&lt; std::endl;
        }
    }
};

int main(int argc, char** argv) {
    Verilated::commandArgs(argc, argv);
    
    HFTSimulator sim;
    
    // 生成測試數據
    sim.generateTestOrders(10000);
    
    // 運行模擬
    sim.runSimulation();
    
    return 0;
}
</code></pre>
<h2 id="3-進階測試-makefile"><a class="header" href="#3-進階測試-makefile">3. 進階測試 Makefile</a></h2>
<h3 id="makefile"><a class="header" href="#makefile">Makefile</a></h3>
<pre><code class="language-makefile"># HFT FPGA Simulation Makefile

VERILATOR = verilator
VERILATOR_ROOT ?= $(HOME)/.mybin/verilator/share/verilator

# 編譯選項
CXX = g++
CXXFLAGS = -Wall -O3 -std=c++17 -I$(VERILATOR_ROOT)/include -I./obj_dir
LDFLAGS = -lpthread

# Verilator 選項（優化性能）
VFLAGS = --cc --trace --exe --build
VFLAGS += -O3 --x-assign fast --x-initial fast
VFLAGS += --threads 4  # 多執行緒加速

# 檔案
VERILOG_SOURCES = order_matcher.v market_data_decoder.v
CPP_SOURCES = tb_hft_system.cpp

# 目標
all: sim

# 編譯
compile:
	$(VERILATOR) $(VFLAGS) \
		--top-module order_matcher \
		$(VERILOG_SOURCES) \
		$(CPP_SOURCES) \
		-o hft_sim

# 運行模擬
sim: compile
	@echo "=== Running HFT Simulation ==="
	time ./obj_dir/hft_sim
	@echo "=== Simulation Complete ==="

# 性能分析
perf: compile
	perf record -g ./obj_dir/hft_sim
	perf report

# 延遲分析
latency:
	$(VERILATOR) $(VFLAGS) --prof-cfunc \
		--top-module order_matcher \
		$(VERILOG_SOURCES) \
		$(CPP_SOURCES) \
		-o hft_sim_prof
	./obj_dir/hft_sim_prof
	verilator_profcfunc profiling.dat &gt; latency_report.txt
	@echo "Latency report saved to latency_report.txt"

# 波形分析
wave: sim
	gtkwave hft_simulation.vcd &amp;

# 批量測試
benchmark:
	@echo "=== Running Benchmark Suite ==="
	@for size in 1000 10000 100000; do \
		echo "Testing with $$size orders..."; \
		./obj_dir/hft_sim --orders $$size; \
	done

clean:
	rm -rf obj_dir *.vcd *.dat *.txt

.PHONY: all compile sim perf latency wave benchmark clean
</code></pre>
<h2 id="4-性能測試腳本"><a class="header" href="#4-性能測試腳本">4. 性能測試腳本</a></h2>
<h3 id="benchmark_hftsh"><a class="header" href="#benchmark_hftsh">benchmark_hft.sh</a></h3>
<pre><code class="language-bash">#!/bin/bash

echo "======================================"
echo "    HFT FPGA Simulation Benchmark"
echo "======================================"

# 編譯
echo "Building simulation..."
make clean
make compile

# 不同場景測試
echo -e "\n--- Test 1: Normal Trading ---"
./obj_dir/hft_sim --orders 10000 --volatility low

echo -e "\n--- Test 2: High Volatility ---"
./obj_dir/hft_sim --orders 10000 --volatility high

echo -e "\n--- Test 3: Flash Crash Scenario ---"
./obj_dir/hft_sim --orders 10000 --scenario flash_crash

echo -e "\n--- Test 4: Maximum Throughput ---"
./obj_dir/hft_sim --orders 100000 --no-delay

# 延遲分析
echo -e "\n--- Latency Analysis ---"
make latency
cat latency_report.txt | grep "Average"

# 生成報告
echo -e "\n--- Generating Report ---"
cat &gt; performance_report.md &lt;&lt; EOF
# HFT FPGA Simulation Performance Report

## Test Configuration
- Date: $(date)
- Verilator Version: $(verilator --version)
- CPU: $(lscpu | grep "Model name" | cut -d: -f2)

## Results Summary
$(tail -n 20 latency_report.txt)

## Recommendations
- Consider using FST format instead of VCD for large simulations
- Enable multi-threading for better performance
- Use coverage analysis to ensure all paths are tested
EOF

echo "Report saved to performance_report.md"
</code></pre>
<h2 id="5-實際應用建議"><a class="header" href="#5-實際應用建議">5. 實際應用建議</a></h2>
<h3 id="適合模擬的場景"><a class="header" href="#適合模擬的場景">適合模擬的場景</a></h3>
<ol>
<li><strong>演算法驗證</strong> - 確認交易邏輯正確性</li>
<li><strong>回測系統</strong> - 使用歷史數據測試策略</li>
<li><strong>風險分析</strong> - 評估極端市場條件</li>
<li><strong>協議開發</strong> - 測試自定義協議實現</li>
</ol>
<h3 id="不適合的場景"><a class="header" href="#不適合的場景">不適合的場景</a></h3>
<ol>
<li><strong>實時交易</strong> - 模擬速度太慢</li>
<li><strong>精確延遲測量</strong> - 軟體模擬無法準確反映硬體延遲</li>
<li><strong>網路測試</strong> - 需要專門的網路模擬器</li>
</ol>
<h3 id="性能優化技巧"><a class="header" href="#性能優化技巧">性能優化技巧</a></h3>
<pre><code class="language-cpp">// 1. 使用 FST 格式替代 VCD（更快更小）
#include &lt;verilated_fst_c.h&gt;
VerilatedFstC* tfp = new VerilatedFstC;

// 2. 條件性追蹤
if (enable_trace &amp;&amp; critical_event) {
    tfp-&gt;dump(sim_time);
}

// 3. 批量處理
for (int i = 0; i &lt; 1000; i++) {
    // 處理多個訂單後再更新波形
}
tfp-&gt;dump(sim_time);
</code></pre>
<h2 id="6-與實際-fpga-的差異"><a class="header" href="#6-與實際-fpga-的差異">6. 與實際 FPGA 的差異</a></h2>
<div class="table-wrapper"><table><thead><tr><th>特性</th><th>Verilator 模擬</th><th>實際 FPGA</th></tr></thead><tbody>
<tr><td>處理延遲</td><td>微秒-毫秒級</td><td>奈秒級</td></tr>
<tr><td>吞吐量</td><td>千筆/秒</td><td>百萬筆/秒</td></tr>
<tr><td>時序準確性</td><td>週期準確</td><td>時序準確</td></tr>
<tr><td>並行處理</td><td>模擬並行</td><td>真實並行</td></tr>
<tr><td>功耗模擬</td><td>不支援</td><td>實際功耗</td></tr>
</tbody></table>
</div>
<h2 id="7-實測結果與驗證"><a class="header" href="#7-實測結果與驗證">7. 實測結果與驗證</a></h2>
<h3 id="71-測試環境"><a class="header" href="#71-測試環境">7.1 測試環境</a></h3>
<ul>
<li><strong>測試平台</strong>: Ubuntu Linux</li>
<li><strong>Verilator 版本</strong>: 5.040</li>
<li><strong>測試時間</strong>: 2025-09-28</li>
</ul>
<h3 id="72-實際執行結果"><a class="header" href="#72-實際執行結果">7.2 實際執行結果</a></h3>
<pre><code class="language-bash">$ cd /home/shihyu/github/jason_note/src/embedded_systems/src/hft_fpga_simulation
$ export PATH=$HOME/.mybin/verilator/bin:$PATH
$ make run

=== Compiling HFT Order Matcher ===
=== Running HFT Simulation ===

=== Simple HFT Order Matching Test ===
Resetting system...
Reset complete

Test 1: Basic matching
Match! Buy ID: 2 Sell ID: 1 Price: 100 Qty: 5

Test 2: Price mismatch
[No match as expected]

Test 3: Batch orders
[40 matches total from 104 orders]

=== Simulation Statistics ===
Orders sent: 104
Matches received: 40
Match rate: 38.4615%
Total orders (DUT): 104
Total matches (DUT): 40
Cycles executed: 182

Estimated FPGA Performance:
@ 200MHz clock frequency
Execution time: 0.91 μs
Throughput: 114.286 M orders/sec
Avg match latency: 22.75 ns

Simulation completed successfully!
</code></pre>
<h3 id="73-快速開始指令"><a class="header" href="#73-快速開始指令">7.3 快速開始指令</a></h3>
<pre><code class="language-bash"># 1. 進入測試目錄
cd /home/shihyu/github/jason_note/src/embedded_systems/src/hft_fpga_simulation

# 2. 設定環境變數
export PATH=$HOME/.mybin/verilator/bin:$PATH
export VERILATOR_ROOT=$HOME/.mybin/verilator/share/verilator

# 3. 編譯並執行
make

# 4. 查看波形
make wave

# 5. 清理檔案
make clean
</code></pre>
<h3 id="74-簡化的-makefile-實際使用版本"><a class="header" href="#74-簡化的-makefile-實際使用版本">7.4 簡化的 Makefile (實際使用版本)</a></h3>
<pre><code class="language-makefile"># 簡潔的 HFT FPGA 模擬 Makefile

# Verilator 命令
VERILATOR = verilator

# 編譯器
CXX = g++
CXXFLAGS = -O2 -std=c++11

# 頂層模組
TOP = order_matcher

# 源檔案
VERILOG_SOURCES = order_matcher.v
CPP_SOURCES = tb_hft_simple.cpp

# 預設目標
all: run

# 編譯
verilate:
	@echo "=== Compiling HFT Order Matcher ==="
	$(VERILATOR) --cc --trace --exe --build \
		$(VERILOG_SOURCES) \
		$(CPP_SOURCES) \
		--top-module $(TOP) \
		-o hft_sim

# 運行
run: verilate
	@echo "=== Running HFT Simulation ==="
	./obj_dir/hft_sim
	@echo "=== Simulation Complete ==="

# 查看波形
wave: run
	@echo "=== Opening waveform ==="
	gtkwave hft_sim.vcd &amp;

# 清理
clean:
	rm -rf obj_dir *.vcd

# 幫助
help:
	@echo "HFT FPGA Simulation Makefile"
	@echo "Commands:"
	@echo "  make        - Compile and run"
	@echo "  make wave   - Run and view waveform"
	@echo "  make clean  - Clean all generated files"
	@echo "  make help   - Show this help"

.PHONY: all verilate run wave clean help
</code></pre>
<h2 id="總結"><a class="header" href="#總結">總結</a></h2>
<p>Verilator 適合用於 HFT 系統的功能驗證和演算法開發，但不能替代實際 FPGA 的性能測試。本範例展示了如何使用簡化的 Makefile 和測試平台快速驗證 FPGA 設計。建議將其作為開發流程的一部分，在部署到實際 FPGA 前進行充分的模擬測試。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../embedded_systems/verilator_complete_guide.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../android/android.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../embedded_systems/verilator_complete_guide.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../android/android.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
