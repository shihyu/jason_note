<!DOCTYPE HTML>
<html lang="zh" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>libbpf æ¶æ§‹è§£æèˆ‡ xgotop å¯¦ä½œèªªæ˜ - Jason&#x27;s Notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Jason&#x27;s Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shihyu/jason_note" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="libbpf-æ¶æ§‹è§£æèˆ‡-xgotop-å¯¦ä½œèªªæ˜"><a class="header" href="#libbpf-æ¶æ§‹è§£æèˆ‡-xgotop-å¯¦ä½œèªªæ˜">libbpf æ¶æ§‹è§£æèˆ‡ xgotop å¯¦ä½œèªªæ˜</a></h1>
<h2 id="ç›®éŒ„"><a class="header" href="#ç›®éŒ„">ç›®éŒ„</a></h2>
<ul>
<li><a href="#1-libbpf-%E6%98%AF%E4%BB%80%E9%BA%BC">1. libbpf æ˜¯ä»€éº¼</a></li>
<li><a href="#2-%E6%95%B4%E9%AB%94%E6%9E%B6%E6%A7%8B">2. æ•´é«”æ¶æ§‹</a></li>
<li><a href="#3-libbpf-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD">3. libbpf æ ¸å¿ƒåŠŸèƒ½</a></li>
<li><a href="#4-xgotop-%E4%B8%AD%E7%9A%84%E5%AF%A6%E9%9A%9B%E6%87%89%E7%94%A8">4. xgotop ä¸­çš„å¯¦éš›æ‡‰ç”¨</a></li>
<li><a href="#5-bcc-vs-libbpf-%E6%AF%94%E8%BC%83">5. BCC vs libbpf æ¯”è¼ƒ</a></li>
<li><a href="#6-vmlinuxh-%E7%9A%84%E8%A7%92%E8%89%B2">6. vmlinux.h çš„è§’è‰²</a></li>
<li><a href="#7-co-re-%E6%A9%9F%E5%88%B6%E8%A9%B3%E8%A7%A3">7. CO-RE æ©Ÿåˆ¶è©³è§£</a></li>
</ul>
<hr />
<h2 id="1-libbpf-æ˜¯ä»€éº¼"><a class="header" href="#1-libbpf-æ˜¯ä»€éº¼">1. libbpf æ˜¯ä»€éº¼</a></h2>
<p><strong>libbpf</strong> æ˜¯ä¸€å€‹ <strong>userspace library</strong>ï¼Œè² è²¬åœ¨ç”¨æˆ¶ç©ºé–“ï¼ˆuserspaceï¼‰å’Œ Linux kernel ä¹‹é–“æ©‹æ¥ eBPF ç¨‹å¼ã€‚</p>
<h3 id="æ ¸å¿ƒå®šä½"><a class="header" href="#æ ¸å¿ƒå®šä½">æ ¸å¿ƒå®šä½</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Your Application                â”‚
â”‚         (xgotop Go ç¨‹å¼)                 â”‚
â”‚  - æ¥­å‹™é‚è¼¯                              â”‚
â”‚  - è³‡æ–™è™•ç†                              â”‚
â”‚  - UI/API                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ ä½¿ç”¨ libbpf API
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         libbpf Library                  â”‚  â† é€™è£¡ï¼
â”‚  (xgotop ä½¿ç”¨ cilium/ebpf - Go ç‰ˆæœ¬)     â”‚
â”‚                                         â”‚
â”‚  åŠŸèƒ½ï¼š                                  â”‚
â”‚  1. è¼‰å…¥ eBPF ç¨‹å¼åˆ° kernel              â”‚
â”‚  2. Attach probe åˆ°å‡½æ•¸                  â”‚
â”‚  3. ç®¡ç† eBPF maps (kernel-user é€šè¨Š)    â”‚
â”‚  4. è®€å– ringbuffer/perf buffer         â”‚
â”‚  5. BTF é‡å®šä½ (CO-RE)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ syscall: bpf()
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Linux Kernel                    â”‚
â”‚                                         â”‚
â”‚  - eBPF è™›æ“¬æ©ŸåŸ·è¡Œç¨‹å¼                   â”‚
â”‚  - eBPF maps å„²å­˜                        â”‚
â”‚  - Ringbuffer                           â”‚
â”‚  - Verifier (å®‰å…¨æ€§é©—è­‰)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr />
<h2 id="2-æ•´é«”æ¶æ§‹"><a class="header" href="#2-æ•´é«”æ¶æ§‹">2. æ•´é«”æ¶æ§‹</a></h2>
<h3 id="21-é–‹ç™¼æµç¨‹"><a class="header" href="#21-é–‹ç™¼æµç¨‹">2.1 é–‹ç™¼æµç¨‹</a></h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é–‹ç™¼æ™‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚
â”‚  1. ç”Ÿæˆ vmlinux.h                  â”‚
â”‚     bpftool btf dump file          â”‚
â”‚     /sys/kernel/btf/vmlinux        â”‚
â”‚            â†“                       â”‚
â”‚  2. ç·¨å¯« eBPF C ç¨‹å¼                â”‚
â”‚     #include "vmlinux.h"           â”‚
â”‚     xgotop.bpf.c                   â”‚
â”‚            â†“                       â”‚
â”‚  3. ç·¨è­¯æˆ .bpf.o                   â”‚
â”‚     clang -target bpf              â”‚
â”‚     å« BTF å‹åˆ¥è³‡è¨Š                 â”‚
â”‚            â†“                       â”‚
â”‚  4. ç”¢ç”Ÿ Go binding                 â”‚
â”‚     bpf2go (cilium/ebpf)           â”‚
â”‚     ç”Ÿæˆ ebpfObjects çµæ§‹           â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ éƒ¨ç½²
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é‹è¡Œæ™‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚
â”‚  1. libbpf è¼‰å…¥ .bpf.o              â”‚
â”‚     loadEbpfObjects()              â”‚
â”‚            â†“                       â”‚
â”‚  2. BTF é‡å®šä½ (CO-RE)              â”‚
â”‚     è®€å– /sys/kernel/btf/vmlinux   â”‚
â”‚     èª¿æ•´ offset                     â”‚
â”‚            â†“                       â”‚
â”‚  3. Kernel verifier é©—è­‰            â”‚
â”‚     å®‰å…¨æ€§æª¢æŸ¥                      â”‚
â”‚            â†“                       â”‚
â”‚  4. JIT ç·¨è­¯ä¸¦åŸ·è¡Œ                  â”‚
â”‚     eBPF bytecode â†’ native code    â”‚
â”‚            â†“                       â”‚
â”‚  5. Attach probe                   â”‚
â”‚     ex.Uprobe(symbol, prog)        â”‚
â”‚            â†“                       â”‚
â”‚  6. äº‹ä»¶æµå‹•                        â”‚
â”‚     Kernel â†’ Ringbuffer â†’ libbpf  â”‚
â”‚            â†’ Application           â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="22-è³‡æ–™æµå‹•"><a class="header" href="#22-è³‡æ–™æµå‹•">2.2 è³‡æ–™æµå‹•</a></h3>
<pre><code>Go Runtime (ç›®æ¨™ç¨‹å¼)
     â”‚
     â”‚ goroutine äº‹ä»¶ç™¼ç”Ÿ
     â”‚ (create/exit/alloc)
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ eBPF Uprobe Hook         â”‚
â”‚ runtime.casgstatus()     â”‚  â† xgotop.bpf.c
â”‚ runtime.newproc1()       â”‚
â”‚ runtime.makeslice()      â”‚
â”‚ ...                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ æ”¶é›†è³‡æ–™
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ eBPF Program             â”‚
â”‚ - è®€å– g struct          â”‚
â”‚ - è¨˜éŒ„ goid, timestamp   â”‚
â”‚ - æª¢æŸ¥ sampling rate     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ å¯«å…¥
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ eBPF Ringbuffer          â”‚  â† Kernel space
â”‚ (ç’°å½¢ç·©è¡å€)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ libbpf è®€å–
         â”‚ ringbuf.NewReader()
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ xgotop Userspace         â”‚
â”‚ - Event readers (goroutines)
â”‚ - Event processors       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â†’ Storage (Protobuf/JSONL)
         â”‚
         â””â”€â†’ WebSocket â†’ Web UI
</code></pre>
<hr />
<h2 id="3-libbpf-æ ¸å¿ƒåŠŸèƒ½"><a class="header" href="#3-libbpf-æ ¸å¿ƒåŠŸèƒ½">3. libbpf æ ¸å¿ƒåŠŸèƒ½</a></h2>
<h3 id="31-å…­å¤§åŠŸèƒ½æ¨¡çµ„"><a class="header" href="#31-å…­å¤§åŠŸèƒ½æ¨¡çµ„">3.1 å…­å¤§åŠŸèƒ½æ¨¡çµ„</a></h3>
<div class="table-wrapper"><table><thead><tr><th>åŠŸèƒ½</th><th>èªªæ˜</th><th>API ç¯„ä¾‹</th><th>xgotop ä½¿ç”¨ä½ç½®</th></tr></thead><tbody>
<tr><td><strong>Load</strong></td><td>è¼‰å…¥ <code>.bpf.o</code> åˆ° kernel</td><td><code>loadEbpfObjects()</code></td><td>main.go:168</td></tr>
<tr><td><strong>Verify</strong></td><td>å”åŠ© kernel verifier</td><td>è‡ªå‹•åŸ·è¡Œ</td><td>-</td></tr>
<tr><td><strong>Relocate</strong></td><td>BTF-based CO-RE é‡å®šä½</td><td>è‡ªå‹•åŸ·è¡Œ</td><td>-</td></tr>
<tr><td><strong>Attach</strong></td><td>é™„åŠ åˆ° hook é»</td><td><code>ex.Uprobe()</code></td><td>main.go:215</td></tr>
<tr><td><strong>Maps</strong></td><td>ç®¡ç† kernel-user é€šè¨Š</td><td><code>map.Update()</code></td><td>main.go:182</td></tr>
<tr><td><strong>Data I/O</strong></td><td>Ringbuffer/Perf buffer</td><td><code>ringbuf.NewReader()</code></td><td>main.go:220</td></tr>
</tbody></table>
</div>
<h3 id="32-åŠŸèƒ½è©³è§£"><a class="header" href="#32-åŠŸèƒ½è©³è§£">3.2 åŠŸèƒ½è©³è§£</a></h3>
<h4 id="321-load---è¼‰å…¥-ebpf-ç‰©ä»¶"><a class="header" href="#321-load---è¼‰å…¥-ebpf-ç‰©ä»¶">3.2.1 Load - è¼‰å…¥ eBPF ç‰©ä»¶</a></h4>
<pre><code class="language-go">// cmd/xgotop/main.go:167-170
objs := ebpfObjects{}
err = loadEbpfObjects(&amp;objs, nil)  // â† libbpf API
must(err, "loading objects")
defer objs.Close()
</code></pre>
<p><strong>èƒŒå¾Œç™¼ç”Ÿçš„äº‹ï¼š</strong></p>
<pre><code>loadEbpfObjects()
    â†“
1. è®€å– xgotop.bpf.o æª”æ¡ˆ
2. è§£æ ELF sections
3. æå– eBPF ç¨‹å¼ç¢¼å’Œ BTF è³‡è¨Š
4. å‘¼å« bpf(BPF_PROG_LOAD, ...)
5. Kernel verifier é©—è­‰ç¨‹å¼å®‰å…¨æ€§
6. åˆå§‹åŒ– eBPF maps
7. å›å‚³ objs çµæ§‹ï¼ˆåŒ…å«æ‰€æœ‰ç¨‹å¼å’Œ mapsï¼‰
</code></pre>
<h4 id="322-attach---é™„åŠ åˆ°ç›®æ¨™å‡½æ•¸"><a class="header" href="#322-attach---é™„åŠ åˆ°ç›®æ¨™å‡½æ•¸">3.2.2 Attach - é™„åŠ åˆ°ç›®æ¨™å‡½æ•¸</a></h4>
<pre><code class="language-go">// cmd/xgotop/main.go:205-218
ex, err := link.OpenExecutable(executablePath)

uprobeOpts := &amp;link.UprobeOptions{}
if *pid != 0 {
    uprobeOpts.PID = *pid  // åªç›£æ§ç‰¹å®š PID
}

probes := map[string]*ebpf.Program{
    "runtime.casgstatus": objs.UprobeCasgstatus,
    "runtime.makeslice":  objs.UprobeMakeslice,
    "runtime.newproc1":   objs.UprobeNewproc1,
    // ...
}

for symbol, probe := range probes {
    uprobe, err := ex.Uprobe(symbol, probe, uprobeOpts)
    //              â†‘ libbpf attach API
    must(err, "attaching uprobe at "+symbol)
    defer uprobe.Close()
}
</code></pre>
<p><strong>Uprobe åŸç†ï¼š</strong></p>
<pre><code>ç›®æ¨™ binary (testserver)
    â†“
1. æ‰¾åˆ° runtime.casgstatus çš„ä½å€
2. åœ¨è©²ä½å€è¨­ç½® breakpoint
3. ç•¶åŸ·è¡Œåˆ°è©²ä½å€æ™‚ï¼š
   â†’ è§¸ç™¼ uprobe
   â†’ åŸ·è¡Œ eBPF ç¨‹å¼
   â†’ è¨˜éŒ„äº‹ä»¶
   â†’ ç¹¼çºŒåŸ·è¡ŒåŸç¨‹å¼
</code></pre>
<h4 id="323-maps---kernel-userspace-é€šè¨Š"><a class="header" href="#323-maps---kernel-userspace-é€šè¨Š">3.2.3 Maps - Kernel-Userspace é€šè¨Š</a></h4>
<pre><code class="language-go">// cmd/xgotop/main.go:179-187
if objs.SamplingRates != nil {
    for eventType, rate := range rates {
        key := uint32(eventType)
        err := objs.SamplingRates.Update(&amp;key, &amp;rate, ebpf.UpdateAny)
        //                             â†‘ userspace â†’ kernel
        if err != nil {
            log.Fatalf("Failed to update sampling rate: %v", err)
        }
    }
}
</code></pre>
<p><strong>Maps é¡å‹ï¼š</strong></p>
<pre><code class="language-c">// xgotop.h ä¸­çš„ map å®šç¾©
struct {
    __uint(type, BPF_MAP_TYPE_ARRAY);
    __uint(max_entries, 16);
    __type(key, u32);
    __type(value, u32);
} sampling_rates SEC(".maps");
</code></pre>
<p><strong>é›™å‘é€šè¨Šï¼š</strong></p>
<pre><code>Userspace                    Kernel
    â”‚                           â”‚
    â”‚  map.Update(key, value)   â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt; â”‚  eBPF ç¨‹å¼è®€å–
    â”‚                           â”‚  map_lookup_elem()
    â”‚                           â”‚
    â”‚  map.Lookup(&amp;key, &amp;val)   â”‚
    â”‚ &lt;â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  eBPF ç¨‹å¼å¯«å…¥
    â”‚                           â”‚  map_update_elem()
</code></pre>
<h4 id="324-ringbuffer---é«˜æ•ˆäº‹ä»¶å‚³è¼¸"><a class="header" href="#324-ringbuffer---é«˜æ•ˆäº‹ä»¶å‚³è¼¸">3.2.4 Ringbuffer - é«˜æ•ˆäº‹ä»¶å‚³è¼¸</a></h4>
<pre><code class="language-go">// cmd/xgotop/main.go:220-222
rd, err := ringbuf.NewReader(objs.Events)
must(err, "creating events ringbuf reader")
defer rd.Close()

// è®€å–äº‹ä»¶
for {
    record, err := rd.Read()
    if err != nil {
        break
    }
    // è™•ç† record.RawSample
}
</code></pre>
<p><strong>Ringbuffer å„ªå‹¢ï¼š</strong></p>
<pre><code>å‚³çµ± Perf Buffer              Ringbuffer (ç¾ä»£)
    â”‚                              â”‚
    â”œâ”€ æ¯å€‹ CPU ä¸€å€‹ buffer        â”œâ”€ å…¨åŸŸå…±äº« buffer
    â”œâ”€ éœ€è¦è¼ªè©¢æ‰€æœ‰ CPU            â”œâ”€ å–®ä¸€è®€å–é»
    â”œâ”€ å¯èƒ½ reorder                â”œâ”€ ä¿è­‰é †åº
    â””â”€ è¼ƒé«˜ overhead               â””â”€ æ›´é«˜æ•ˆ
</code></pre>
<hr />
<h2 id="4-xgotop-ä¸­çš„å¯¦éš›æ‡‰ç”¨"><a class="header" href="#4-xgotop-ä¸­çš„å¯¦éš›æ‡‰ç”¨">4. xgotop ä¸­çš„å¯¦éš›æ‡‰ç”¨</a></h2>
<h3 id="41-å®Œæ•´åˆå§‹åŒ–æµç¨‹"><a class="header" href="#41-å®Œæ•´åˆå§‹åŒ–æµç¨‹">4.1 å®Œæ•´åˆå§‹åŒ–æµç¨‹</a></h3>
<pre><code class="language-go">// cmd/xgotop/main.go ç°¡åŒ–ç‰ˆ

func main() {
    // 1. ç§»é™¤è¨˜æ†¶é«”é–å®šé™åˆ¶
    err := rlimit.RemoveMemlock()
    // å…è¨± eBPF é–å®šè¨˜æ†¶é«”ï¼Œé¿å…è¢« swap

    // 2. è¼‰å…¥ eBPF ç‰©ä»¶
    objs := ebpfObjects{}
    err = loadEbpfObjects(&amp;objs, nil)
    defer objs.Close()

    // 3. è¨­å®š sampling rates (é€é map)
    for eventType, rate := range rates {
        key := uint32(eventType)
        objs.SamplingRates.Update(&amp;key, &amp;rate, ebpf.UpdateAny)
    }

    // 4. Attach uprobes
    ex, err := link.OpenExecutable(executablePath)
    for symbol, probe := range probes {
        uprobe, err := ex.Uprobe(symbol, probe, nil)
        defer uprobe.Close()
    }

    // 5. å»ºç«‹ ringbuffer reader
    rd, err := ringbuf.NewReader(objs.Events)
    defer rd.Close()

    // 6. å•Ÿå‹• event readers (goroutines)
    for i := 0; i &lt; *readWorkers; i++ {
        go readEvents(rd, eventCh)
    }

    // 7. å•Ÿå‹• event processors
    for i := 0; i &lt; *processWorkers; i++ {
        go processEvents(eventCh, eventStore)
    }
}
</code></pre>
<h3 id="42-äº‹ä»¶è™•ç†æµç¨‹"><a class="header" href="#42-äº‹ä»¶è™•ç†æµç¨‹">4.2 äº‹ä»¶è™•ç†æµç¨‹</a></h3>
<pre><code>[Kernel] eBPF Hook è§¸ç™¼
    â†“
[Kernel] å¯«å…¥ Ringbuffer
    â†“
[User] ringbuf.NewReader().Read()  â† libbpf
    â†“
[User] readEvents() goroutine
    â†“ æ”¾å…¥ channel
[User] eventCh := make(chan *ebpfGoRuntimeEventT, 1_000_000)
    â†“
[User] processEvents() goroutine
    â†“
[User] Storage (Protobuf/JSONL)
    â†“
[User] WebSocket â†’ Web UI
</code></pre>
<h3 id="43-ç”Ÿæˆçš„-go-binding"><a class="header" href="#43-ç”Ÿæˆçš„-go-binding">4.3 ç”Ÿæˆçš„ Go Binding</a></h3>
<pre><code class="language-bash"># gen.go
//go:generate go run github.com/cilium/ebpf/cmd/bpf2go \
    -type go_runtime_event_t \
    -target arm64 \
    -output-dir cmd/xgotop \
    ebpf xgotop.bpf.c
</code></pre>
<p><strong>ç”Ÿæˆæª”æ¡ˆï¼š</strong></p>
<pre><code>cmd/xgotop/
â”œâ”€â”€ ebpf_arm64_bpfeb.go     â† Big-endian
â”œâ”€â”€ ebpf_arm64_bpfel.go     â† Little-endian
â””â”€â”€ ebpf_arm64_bpfel.o      â† eBPF bytecode
</code></pre>
<p><strong>è‡ªå‹•ç”Ÿæˆçš„çµæ§‹ï¼š</strong></p>
<pre><code class="language-go">// ebpf_arm64_bpfel.go (è‡ªå‹•ç”Ÿæˆ)

type ebpfObjects struct {
    // Programs
    UprobeCasgstatus *ebpf.Program
    UprobeMakeslice  *ebpf.Program
    UprobeNewproc1   *ebpf.Program
    // ...

    // Maps
    Events         *ebpf.Map  // Ringbuffer
    SamplingRates  *ebpf.Map  // Array map
}

func loadEbpfObjects(obj *ebpfObjects, opts *ebpf.CollectionOptions) error {
    // è‡ªå‹•ç”Ÿæˆçš„è¼‰å…¥é‚è¼¯
}
</code></pre>
<hr />
<h2 id="5-bcc-vs-libbpf-æ¯”è¼ƒ"><a class="header" href="#5-bcc-vs-libbpf-æ¯”è¼ƒ">5. BCC vs libbpf æ¯”è¼ƒ</a></h2>
<h3 id="51-é–‹ç™¼æ–¹æ³•å°æ¯”"><a class="header" href="#51-é–‹ç™¼æ–¹æ³•å°æ¯”">5.1 é–‹ç™¼æ–¹æ³•å°æ¯”</a></h3>
<h4 id="bcc-æ–¹æ³•å‚³çµ±"><a class="header" href="#bcc-æ–¹æ³•å‚³çµ±">BCC æ–¹æ³•ï¼ˆå‚³çµ±ï¼‰</a></h4>
<pre><code class="language-python"># BCC Python ç¯„ä¾‹
from bcc import BPF

bpf_text = """
#include &lt;linux/sched.h&gt;      // â† ä½¿ç”¨ kernel headers
#include &lt;linux/fs.h&gt;

int trace_open(struct pt_regs *ctx) {
    struct task_struct *task =
        (struct task_struct *)bpf_get_current_task();
    bpf_trace_printk("PID: %d\\n", task-&gt;pid);
    return 0;
}
"""

b = BPF(text=bpf_text)  # â† é‹è¡Œæ™‚ç·¨è­¯
b.attach_kprobe(event="do_sys_open", fn_name="trace_open")
</code></pre>
<p><strong>ç‰¹é»ï¼š</strong></p>
<ul>
<li>âŒ ä¸éœ€è¦ vmlinux.h</li>
<li>âœ… ä½¿ç”¨ kernel headers (<code>/usr/include/linux/*</code>)</li>
<li>ğŸ”„ <strong>é‹è¡Œæ™‚ç·¨è­¯</strong>ï¼ˆæ¯æ¬¡åŸ·è¡Œéƒ½ç·¨è­¯ï¼‰</li>
<li>ğŸ“¦ éœ€è¦å®‰è£ LLVM/Clang</li>
<li>ğŸ Python APIï¼ˆæ˜“å­¸ï¼‰</li>
</ul>
<h4 id="libbpf--co-re-æ–¹æ³•ç¾ä»£xgotop-ä½¿ç”¨"><a class="header" href="#libbpf--co-re-æ–¹æ³•ç¾ä»£xgotop-ä½¿ç”¨">libbpf + CO-RE æ–¹æ³•ï¼ˆç¾ä»£ï¼Œxgotop ä½¿ç”¨ï¼‰</a></h4>
<pre><code class="language-c">// xgotop.bpf.c
#include "vmlinux.h"           // â† ä½¿ç”¨ vmlinux.h
#include &lt;bpf/bpf_helpers.h&gt;

SEC("uprobe/runtime.casgstatus")
int uprobe_casgstatus(struct pt_regs *ctx) {
    struct go_runtime_g g;
    bpf_probe_read(&amp;g, sizeof(g), gp);
    return 0;
}
</code></pre>
<pre><code class="language-bash"># é–‹ç™¼æ©Ÿå™¨ï¼šé å…ˆç·¨è­¯
clang -target bpf -c xgotop.bpf.c -o xgotop.bpf.o

# ç›®æ¨™æ©Ÿå™¨ï¼šç›´æ¥åŸ·è¡Œ
./xgotop  # ä¸éœ€è¦ç·¨è­¯å™¨
</code></pre>
<p><strong>ç‰¹é»ï¼š</strong></p>
<ul>
<li>âœ… <strong>éœ€è¦ vmlinux.h</strong></li>
<li>âŒ ä¸ä½¿ç”¨ kernel headers</li>
<li>âš¡ <strong>é å…ˆç·¨è­¯</strong> (Compile Once, Run Everywhere)</li>
<li>ğŸ“¦ åªéœ€è¦ç›®æ¨™æ©Ÿå™¨æ”¯æ´ BTF</li>
<li>ğŸš€ å•Ÿå‹•å¿«é€Ÿã€éƒ¨ç½²è¼•é‡</li>
</ul>
<h3 id="52-å®Œæ•´å°æ¯”è¡¨"><a class="header" href="#52-å®Œæ•´å°æ¯”è¡¨">5.2 å®Œæ•´å°æ¯”è¡¨</a></h3>
<div class="table-wrapper"><table><thead><tr><th>é …ç›®</th><th>BCC</th><th>libbpf + CO-RE</th></tr></thead><tbody>
<tr><td><strong>vmlinux.h</strong></td><td>âŒ ä¸éœ€è¦</td><td>âœ… <strong>éœ€è¦</strong></td></tr>
<tr><td><strong>Kernel Headers</strong></td><td>âœ… éœ€è¦</td><td>âŒ ä¸éœ€è¦</td></tr>
<tr><td><strong>LLVM/Clang</strong></td><td>é‹è¡Œæ™‚éœ€è¦</td><td>ç·¨è­¯æ™‚éœ€è¦</td></tr>
<tr><td><strong>ç·¨è­¯æ™‚æ©Ÿ</strong></td><td>é‹è¡Œæ™‚</td><td>é–‹ç™¼æ™‚</td></tr>
<tr><td><strong>å•Ÿå‹•é€Ÿåº¦</strong></td><td>æ…¢ï¼ˆ5-10ç§’ï¼‰</td><td>å¿«ï¼ˆ&lt;1ç§’ï¼‰</td></tr>
<tr><td><strong>éƒ¨ç½²å¤§å°</strong></td><td>å¤§ï¼ˆéœ€è¦ headersï¼‰</td><td>å°ï¼ˆå–®ä¸€ binaryï¼‰</td></tr>
<tr><td><strong>å­¸ç¿’æ›²ç·š</strong></td><td>ç°¡å–®ï¼ˆPythonï¼‰</td><td>è¼ƒé™¡ï¼ˆC + BTFï¼‰</td></tr>
<tr><td><strong>é©ç”¨å ´æ™¯</strong></td><td>å¿«é€Ÿé–‹ç™¼ã€å¯¦é©—</td><td>ç”Ÿç”¢ç’°å¢ƒ</td></tr>
<tr><td><strong>è·¨ç‰ˆæœ¬ç›¸å®¹</strong></td><td>å·®</td><td>å¥½ï¼ˆCO-REï¼‰</td></tr>
<tr><td><strong>æ•ˆèƒ½ overhead</strong></td><td>è¼ƒé«˜</td><td>è¼ƒä½</td></tr>
</tbody></table>
</div>
<h3 id="53-ç·¨è­¯æµç¨‹å°æ¯”"><a class="header" href="#53-ç·¨è­¯æµç¨‹å°æ¯”">5.3 ç·¨è­¯æµç¨‹å°æ¯”</a></h3>
<p><strong>BCCï¼š</strong></p>
<pre><code>é‹è¡Œæ™‚ï¼ˆç›®æ¨™æ©Ÿå™¨ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Python è…³æœ¬åŸ·è¡Œ           â”‚
â”‚ 2. è®€å– kernel headers       â”‚ â† éœ€è¦å®‰è£
â”‚    /usr/include/linux/*     â”‚
â”‚ 3. LLVM å³æ™‚ç·¨è­¯             â”‚ â† æ¯æ¬¡éƒ½ç·¨è­¯
â”‚ 4. è¼‰å…¥åˆ° kernel             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   å•Ÿå‹•æ™‚é–“ï¼š5-10 ç§’
</code></pre>
<p><strong>libbpf + CO-REï¼š</strong></p>
<pre><code>é–‹ç™¼æ™‚ï¼ˆé–‹ç™¼æ©Ÿå™¨ï¼‰              é‹è¡Œæ™‚ï¼ˆç›®æ¨™æ©Ÿå™¨ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”Ÿæˆ vmlinux.h    â”‚       â”‚ 1. è¼‰å…¥ .bpf.o    â”‚
â”‚ 2. clang ç·¨è­¯        â”‚  â”€â”€&gt;  â”‚ 2. BTF é‡å®šä½     â”‚ â† è‡ªå‹•é©é…
â”‚ 3. ç”¢ç”Ÿ .bpf.o       â”‚       â”‚ 3. åŸ·è¡Œ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               å•Ÿå‹•æ™‚é–“ï¼š&lt;1 ç§’
</code></pre>
<hr />
<h2 id="6-vmlinuxh-çš„è§’è‰²"><a class="header" href="#6-vmlinuxh-çš„è§’è‰²">6. vmlinux.h çš„è§’è‰²</a></h2>
<h3 id="61-ç‚ºä»€éº¼éœ€è¦-vmlinuxh"><a class="header" href="#61-ç‚ºä»€éº¼éœ€è¦-vmlinuxh">6.1 ç‚ºä»€éº¼éœ€è¦ vmlinux.h</a></h3>
<p><strong>å•é¡Œï¼šKernel ç‰ˆæœ¬å·®ç•°</strong></p>
<pre><code class="language-c">// Kernel 5.10
struct task_struct {
    int field_a;      // offset 0
    long field_b;     // offset 4
};

// Kernel 6.14
struct task_struct {
    long new_field;   // offset 0  â† æ–°å¢ï¼
    int field_a;      // offset 8  â† offset æ”¹è®Šï¼
    long field_b;     // offset 12
};
</code></pre>
<p>å¦‚æœå¯«æ­» offsetï¼Œç¨‹å¼æœƒåœ¨ä¸åŒ kernel ç‰ˆæœ¬ä¸Š<strong>è®€åˆ°éŒ¯èª¤è³‡æ–™</strong>ã€‚</p>
<h3 id="62-vmlinuxh-ç”Ÿæˆæµç¨‹"><a class="header" href="#62-vmlinuxh-ç”Ÿæˆæµç¨‹">6.2 vmlinux.h ç”Ÿæˆæµç¨‹</a></h3>
<pre><code class="language-bash"># Makefile
vmlinux:
    bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h
</code></pre>
<p><strong>æµç¨‹åœ–ï¼š</strong></p>
<pre><code>/sys/kernel/btf/vmlinux
    â†“ (äºŒé€²ä½ BTF æ ¼å¼)
    â”‚ åŒ…å« kernel æ‰€æœ‰å‹åˆ¥è³‡è¨Š
    â†“
bpftool btf dump
    â†“ (è½‰æ›æˆ C header)
    â”‚ ç”¢ç”Ÿ 3.8MB çš„ header
    â†“
vmlinux.h
    â†“ (åŒ…å«æ‰€æœ‰çµæ§‹å®šç¾©)
    â”‚ struct task_struct { ... }
    â”‚ struct pt_regs { ... }
    â”‚ ...ï¼ˆæ•¸åƒå€‹çµæ§‹ï¼‰
    â†“
#include "vmlinux.h"  â† xgotop.h
</code></pre>
<h3 id="63-åœ¨-xgotop-çš„ä½¿ç”¨"><a class="header" href="#63-åœ¨-xgotop-çš„ä½¿ç”¨">6.3 åœ¨ xgotop çš„ä½¿ç”¨</a></h3>
<pre><code class="language-c">// xgotop.h:4
#include "vmlinux.h"

// ä½¿ç”¨ vmlinux.h ä¸­çš„å®šç¾©
struct pt_regs {  // â† ä¾†è‡ª vmlinux.h
    unsigned long regs[31];
    unsigned long sp;
    unsigned long pc;
    // ...
};

// xgotop.bpf.c ä¸­ä½¿ç”¨
SEC("uprobe/runtime.casgstatus")
int BPF_KPROBE(uprobe_casgstatus,
               const void *gp,
               const u32 oldval,
               const u32 newval) {
    struct go_runtime_g g;
    // pt_regs é€é ctx å‚³å…¥ï¼Œå‹åˆ¥ä¾†è‡ª vmlinux.h
}
</code></pre>
<hr />
<h2 id="7-co-re-æ©Ÿåˆ¶è©³è§£"><a class="header" href="#7-co-re-æ©Ÿåˆ¶è©³è§£">7. CO-RE æ©Ÿåˆ¶è©³è§£</a></h2>
<h3 id="71-co-re-æ¶æ§‹"><a class="header" href="#71-co-re-æ¶æ§‹">7.1 CO-RE æ¶æ§‹</a></h3>
<p><strong>CO-RE = Compile Once, Run Everywhere</strong></p>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç·¨è­¯æ™‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â”‚
â”‚  vmlinux.h (é–‹ç™¼æ©Ÿå™¨)         â”‚
â”‚  struct task_struct {        â”‚
â”‚      int pid;  // offset 123 â”‚  â† BTF è¨˜éŒ„
â”‚  }                           â”‚
â”‚         â†“                    â”‚
â”‚  clang -target bpf           â”‚
â”‚         â†“                    â”‚
â”‚  xgotop.bpf.o                â”‚
â”‚  + BTF relocations           â”‚  â† è¨˜ä½ "pid" é€™å€‹æ¬„ä½åç¨±
â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ éƒ¨ç½²
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é‹è¡Œæ™‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â”‚
â”‚  /sys/kernel/btf/vmlinux     â”‚
â”‚  (ç›®æ¨™æ©Ÿå™¨å¯¦éš› kernel)        â”‚
â”‚  struct task_struct {        â”‚
â”‚      long new_field;         â”‚
â”‚      int pid;  // offset 456 â”‚  â† ä¸åŒ offsetï¼
â”‚  }                           â”‚
â”‚         â†“                    â”‚
â”‚  libbpf é‡å®šä½å¼•æ“            â”‚
â”‚         â†“                    â”‚
â”‚  æ‰¾åˆ° "pid" æ¬„ä½              â”‚
â”‚  offset 123 â†’ 456            â”‚  â† è‡ªå‹•èª¿æ•´
â”‚         â†“                    â”‚
â”‚  è¼‰å…¥åˆ° kernel                â”‚
â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="72-btf-bpf-type-format"><a class="header" href="#72-btf-bpf-type-format">7.2 BTF (BPF Type Format)</a></h3>
<p><strong>BTF å„²å­˜çš„è³‡è¨Šï¼š</strong></p>
<pre><code class="language-c">// åŸå§‹çµæ§‹
struct task_struct {
    int pid;           // offset 456, size 4
    char comm[16];     // offset 460, size 16
};
</code></pre>
<p><strong>BTF æ ¼å¼ï¼š</strong></p>
<pre><code>BTF Type #123: struct task_struct {
    member: pid
        type: int
        offset: 456 bits
        size: 32 bits
    member: comm
        type: char[16]
        offset: 460 bits
        size: 128 bits
}
</code></pre>
<h3 id="73-libbpf-é‡å®šä½éç¨‹"><a class="header" href="#73-libbpf-é‡å®šä½éç¨‹">7.3 libbpf é‡å®šä½éç¨‹</a></h3>
<pre><code>1. è®€å– .bpf.o çš„ BTF section
   â†’ çŸ¥é“ç¨‹å¼æƒ³å­˜å– task_struct.pid
   â†’ ç·¨è­¯æ™‚ offset = 123

2. è®€å– /sys/kernel/btf/vmlinux
   â†’ æ‰¾åˆ° task_struct å®šç¾©
   â†’ é‹è¡Œæ™‚ offset = 456

3. ä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ offset
   â†’ mov r1, [r0 + 123]  æ”¹æˆ
   â†’ mov r1, [r0 + 456]

4. è¼‰å…¥åˆ° kernel
</code></pre>
<h3 id="74-co-re-helper-å·¨é›†"><a class="header" href="#74-co-re-helper-å·¨é›†">7.4 CO-RE Helper å·¨é›†</a></h3>
<pre><code class="language-c">// xgotop.h:6
#include &lt;bpf/bpf_core_read.h&gt;

// ä½¿ç”¨ CO-RE helper
if (bpf_core_type_exists(struct trace_event_raw_bpf_trace_printk___x)) {
    // æª¢æŸ¥çµæ§‹æ˜¯å¦å­˜åœ¨æ–¼ç•¶å‰ kernel
    // ä¸å­˜åœ¨å‰‡è·³éï¼Œé¿å… crash
}

// è®€å–æ¬„ä½ï¼ˆè‡ªå‹•è™•ç† offsetï¼‰
int pid = BPF_CORE_READ(task, pid);
//        â†‘ å±•é–‹æˆ bpf_probe_read + offset calculation
</code></pre>
<hr />
<h2 id="8-å¯¦æˆ°ç¯„ä¾‹è¿½è¹¤æµç¨‹"><a class="header" href="#8-å¯¦æˆ°ç¯„ä¾‹è¿½è¹¤æµç¨‹">8. å¯¦æˆ°ç¯„ä¾‹ï¼šè¿½è¹¤æµç¨‹</a></h2>
<h3 id="81-å¾-hook-åˆ°é¡¯ç¤ºçš„å®Œæ•´è·¯å¾‘"><a class="header" href="#81-å¾-hook-åˆ°é¡¯ç¤ºçš„å®Œæ•´è·¯å¾‘">8.1 å¾ Hook åˆ°é¡¯ç¤ºçš„å®Œæ•´è·¯å¾‘</a></h3>
<pre><code>[Step 1] Go ç¨‹å¼åŸ·è¡Œ
testserver çš„ runtime.casgstatus() è¢«å‘¼å«

    â†“

[Step 2] Uprobe è§¸ç™¼
xgotop attach çš„ eBPF ç¨‹å¼åŸ·è¡Œ

    â†“

[Step 3] eBPF ç¨‹å¼åŸ·è¡Œ
// xgotop.bpf.c:4-30
SEC("uprobe/runtime.casgstatus")
int BPF_KPROBE(uprobe_casgstatus, ...) {
    struct go_runtime_g g;
    bpf_probe_read(&amp;g, sizeof(g), gp);  // è®€å– goroutine çµæ§‹

    // çµ„è£äº‹ä»¶
    struct go_runtime_event event = {
        .event_type = EVENT_TYPE_CASGSTATUS,
        .timestamp = bpf_ktime_get_ns(),
        .goid = g.goid,
        // ...
    };

    // å¯«å…¥ ringbuffer
    bpf_ringbuf_output(&amp;events, &amp;event, sizeof(event), 0);
}

    â†“

[Step 4] Ringbuffer â†’ Userspace (libbpf)
// main.go:220
rd, err := ringbuf.NewReader(objs.Events)

// å¤šå€‹ reader goroutines
for i := 0; i &lt; *readWorkers; i++ {
    go func() {
        for {
            record, err := rd.Read()  // â† libbpf API
            eventCh &lt;- parseEvent(record.RawSample)
        }
    }()
}

    â†“

[Step 5] Event Processing
// main.go:processEvents
go func() {
    for event := range eventCh {
        // è™•ç†äº‹ä»¶
        processedEvent := transform(event)

        // å„²å­˜åˆ° storage
        eventStore.Write(processedEvent)

        // ç™¼é€åˆ° WebSocket
        apiServer.Broadcast(processedEvent)
    }
}()

    â†“

[Step 6] Storage &amp; Web UI
Protobuf/JSONL å¯«å…¥ç£ç¢Ÿ
WebSocket æ¨é€åˆ°ç€è¦½å™¨
Timeline è¦–è¦ºåŒ–é¡¯ç¤º
</code></pre>
<h3 id="82-æ•ˆèƒ½æŒ‡æ¨™è¿½è¹¤"><a class="header" href="#82-æ•ˆèƒ½æŒ‡æ¨™è¿½è¹¤">8.2 æ•ˆèƒ½æŒ‡æ¨™è¿½è¹¤</a></h3>
<pre><code class="language-go">// main.go:234-238
var probeDurationNsSum atomic.Int64     // LAT: eBPF hook æ™‚é–“
var processingTimeNsSum atomic.Int64    // PRC: è™•ç†æ™‚é–“

var readEventCount atomic.Uint64        // RPS: è®€å–é€Ÿç‡
var procEventCount atomic.Uint64        // PPS: è™•ç†é€Ÿç‡

eventCh := make(chan *ebpfGoRuntimeEventT, 1_000_000)
// â†‘ EWP: len(eventCh) = ç­‰å¾…è™•ç†çš„äº‹ä»¶æ•¸
</code></pre>
<p><strong>è¨ˆç®—å…¬å¼ï¼š</strong></p>
<pre><code>LAT = probeDurationNsSum / probeDurationNsCount
RPS = readEventCount / æ™‚é–“é–“éš”
PPS = procEventCount / æ™‚é–“é–“éš”
EWP = len(eventCh)
PRC = processingTimeNsSum / processingTimeNsCount
</code></pre>
<hr />
<h2 id="9-ç¸½çµ"><a class="header" href="#9-ç¸½çµ">9. ç¸½çµ</a></h2>
<h3 id="91-é—œéµæ¦‚å¿µå›é¡§"><a class="header" href="#91-é—œéµæ¦‚å¿µå›é¡§">9.1 é—œéµæ¦‚å¿µå›é¡§</a></h3>
<pre><code>vmlinux.h
    â†“ æä¾› kernel å‹åˆ¥å®šç¾©
    â†“
eBPF C ç¨‹å¼ (xgotop.bpf.c)
    â†“ clang ç·¨è­¯ + BTF
    â†“
.bpf.o (eBPF bytecode)
    â†“ libbpf è¼‰å…¥
    â†“
Kernel (åŸ·è¡Œ)
    â†“ Ringbuffer
    â†“
libbpf è®€å–
    â†“
Application (xgotop)
</code></pre>
<h3 id="92-libbpf-çš„åƒ¹å€¼"><a class="header" href="#92-libbpf-çš„åƒ¹å€¼">9.2 libbpf çš„åƒ¹å€¼</a></h3>
<div class="table-wrapper"><table><thead><tr><th>æ²’æœ‰ libbpf</th><th>æœ‰ libbpf</th></tr></thead><tbody>
<tr><td>æ‰‹å‹• syscall(__NR_bpf, ...)</td><td><code>loadEbpfObjects()</code></td></tr>
<tr><td>æ‰‹å‹•è§£æ BTF</td><td>è‡ªå‹•é‡å®šä½</td></tr>
<tr><td>æ‰‹å‹•ç®¡ç† maps</td><td><code>map.Update()</code></td></tr>
<tr><td>æ‰‹å‹•è®€å– ringbuffer</td><td><code>ringbuf.NewReader()</code></td></tr>
<tr><td>æ•¸ç™¾è¡Œ boilerplate</td><td>å¹¾è¡Œç¨‹å¼ç¢¼</td></tr>
</tbody></table>
</div>
<h3 id="93-é–‹ç™¼å»ºè­°"><a class="header" href="#93-é–‹ç™¼å»ºè­°">9.3 é–‹ç™¼å»ºè­°</a></h3>
<p><strong>ä½¿ç”¨ BCC ç•¶ï¼š</strong></p>
<ul>
<li>å¿«é€ŸåŸå‹é–‹ç™¼</li>
<li>ä¸€æ¬¡æ€§é™¤éŒ¯ä»»å‹™</li>
<li>å­¸ç¿’ eBPF åŸºç¤</li>
</ul>
<p><strong>ä½¿ç”¨ libbpf + CO-RE ç•¶ï¼š</strong></p>
<ul>
<li>ç”Ÿç”¢ç’°å¢ƒå·¥å…·</li>
<li>éœ€è¦è·¨ kernel ç‰ˆæœ¬åˆ†ç™¼</li>
<li>æ•ˆèƒ½è¦æ±‚é«˜</li>
<li>æœ€å°åŒ–éƒ¨ç½²ä¾è³´</li>
</ul>
<h3 id="94-åƒè€ƒè³‡æº"><a class="header" href="#94-åƒè€ƒè³‡æº">9.4 åƒè€ƒè³‡æº</a></h3>
<ul>
<li><strong>cilium/ebpf</strong>: https://github.com/cilium/ebpf</li>
<li><strong>libbpf å®˜æ–¹æ–‡æª”</strong>: https://github.com/libbpf/libbpf</li>
<li><strong>BPF CO-RE ä»‹ç´¹</strong>: https://nakryiko.com/posts/bpf-portability-and-co-re/</li>
<li><strong>xgotop å°ˆæ¡ˆ</strong>: https://github.com/sazak-io/xgotop</li>
</ul>
<hr />
<p><strong>æ–‡ä»¶ç‰ˆæœ¬</strong>: 1.0
<strong>æœ€å¾Œæ›´æ–°</strong>: 2026-01-01
<strong>é©ç”¨æ–¼</strong>: xgotop (arm64), Linux kernel 5.2+</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../linux_system/understanding-ebpf.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../linux_system/linux-binary-tools-guide.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../linux_system/understanding-ebpf.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../linux_system/linux-binary-tools-guide.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
